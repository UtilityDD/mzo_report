<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withheld NSC Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Inter font from Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #121212;
      color: #e5e5e5;
    }
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7);
      transition: opacity 0.3s ease-in-out;
    }
    .modal-content {
      transform: scale(0.95);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-container.open .modal-overlay {
      opacity: 1;
    }
    .modal-container.open .modal-content {
      transform: scale(1);
    }
    .modal-container {
      display: none;
    }
    .modal-container.open {
      display: flex;
    }
    /* Custom Scrollbar for Modal Body */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #2d3748;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 10px;
        border: 2px solid #2d3748;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #5a6578;
    }
    /* Checkbox styling */
    .checkbox-container {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background-color: #1f2937;
        transition: background-color 0.2s ease-in-out;
    }
    .checkbox-container:hover {
        background-color: #374151;
    }
    .checkbox-container input {
        display: none;
    }
    .checkmark {
        display: inline-block;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #4a5568;
        border-radius: 0.25rem;
        position: relative;
        margin-right: 0.75rem;
        transition: all 0.2s ease-in-out;
        flex-shrink: 0;
    }
    .checkbox-container input:checked + .checkmark {
        background-color: #6366f1;
        border-color: #6366f1;
    }
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 0.4rem;
        top: 0.1rem;
        width: 0.35rem;
        height: 0.7rem;
        border: solid white;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
    }
    .checkbox-container input:checked + .checkmark:after {
        display: block;
    }
    /* Left Panel Styling */
    /* Adjust width for mobile and desktop, and ensure it's fixed/overlay */
    #leftPanel {
      width: 280px; /* Default width for larger screens */
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 999;
    }
    /* On smaller screens, make it full height and fixed */
    @media (max-width: 767px) { /* Tailwind's 'md' breakpoint is 768px */
        #leftPanel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 80%; /* Occupy 80% of screen width on mobile */
            max-width: 280px; /* But don't exceed 280px */
            box-shadow: 0 0 20px rgba(0,0,0,0.5); /* Add shadow for overlay effect */
        }
    }

    #leftPanel.open {
      transform: translateX(0);
    }
    /* Adjust main content margin only on larger screens when panel is open */
    #mainContent.md\:ml-\[280px\] {
      transition: margin-left 0.3s ease-in-out;
    }
    .checkbox-label-text {
        word-wrap: break-word;
        overflow-wrap: break-word;
        flex-grow: 1;
        flex-shrink: 1;
    }
  </style>
</head>
<body class="flex min-h-screen">

  <!-- Loading Overlay for Initial Data Load -->
  <div id="loadingOverlay" class="fixed inset-0 z-[2000] bg-gray-900 bg-opacity-80 flex items-center justify-center transition-opacity duration-300 ease-in-out">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
  </div>

  <!-- Left Panel (Hideable) -->
  <div id="leftPanel" class="fixed top-0 left-0 h-full bg-gray-800 p-6 shadow-2xl overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Reasons</h2>
      <button id="closePanelButton" class="text-gray-400 hover:text-white md:hidden"><i class="fas fa-times"></i></button>
    </div>
    <!-- Select/Unselect All Buttons -->
    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
        <button id="selectAllReasons" class="flex-1 p-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-500 transition-colors">Select All</button>
        <button id="unselectAllReasons" class="flex-1 p-2 bg-gray-700 text-gray-300 font-semibold rounded-lg hover:bg-gray-600 transition-colors">Unselect All</button>
    </div>
    <div id="reasonFilterContainer" class="space-y-2 custom-scrollbar">
      <!-- Checkboxes will be populated here by JS -->
    </div>
  </div>

  <!-- Main Content Wrapper -->
  <div id="mainContent" class="flex-1">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-gray-800 shadow-lg mb-2">
      <div class="container mx-auto p-4 flex justify-between items-center">
        <div class="flex flex-col sm:flex-row items-start sm:items-center w-full">
          <button id="togglePanelButton" class="text-gray-100 text-xl hover:text-indigo-400 mr-4 mb-2 sm:mb-0"><i class="fas fa-bars"></i></button>
          <h1 class="text-xl font-bold text-gray-100 flex flex-col sm:flex-row items-start sm:items-center flex-wrap w-full">
            Withheld NSC
            <span id="update-date" class="ml-0 sm:ml-2 text-sm font-normal text-gray-400 w-full sm:w-auto text-center sm:text-left">(Loading...)</span>
          </h1>
        </div>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="container mx-auto p-4">

      <!-- Filters Panel -->
      <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4">
        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4">
          <!-- Region, Division, CCC Selects -->
          <div class="w-full md:flex-1 md:min-w-[200px]">
            <select id="region" class="w-full p-2 bg-gray-700 text-gray-200 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
              <option value="">All Regions</option>
            </select>
          </div>
          <div class="w-full md:flex-1 md:min-w-[200px]">
            <select id="division" class="w-full p-2 bg-gray-700 text-gray-200 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
              <option value="">All Divisions</option>
            </select>
          </div>
          <div class="w-full md:flex-1 md:min-w-[200px]">
            <select id="support" class="w-full p-2 bg-gray-700 text-gray-200 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
              <option value="">All CCCs</option>
            </select>
          </div>
          <!-- New Checkboxes -->
          <div class="flex flex-wrap items-center gap-4 w-full md:w-auto justify-center md:justify-start">
              <label class="checkbox-container">
                  <input type="checkbox" id="portalCheckbox" checked>
                  <span class="checkmark"></span>
                  <span class="text-gray-200">Portal</span>
              </label>
              <label class="checkbox-container">
                  <input type="checkbox" id="offlineCheckbox" checked>
                  <span class="checkmark"></span>
                  <span class="text-gray-200">Offline</span>
              </label>
          </div>
        </div>
      </div>

      <!-- Dashboard Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div id="card-total" class="stat-card p-4 bg-gray-800 rounded-xl shadow-lg border-l-4 border-indigo-500 cursor-pointer hover:shadow-xl transition-all duration-300 ease-in-out">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-indigo-400"><i class="fas fa-database"></i></div>
            <div>
              <h3 class="text-sm font-medium text-gray-400">Total Records</h3>
              <p id="total-count" class="text-3xl font-bold text-gray-100 mt-1">0</p>
            </div>
          </div>
        </div>
        <div id="card-7" class="stat-card p-4 bg-gray-800 rounded-xl shadow-lg border-l-4 border-teal-400 cursor-pointer hover:shadow-xl transition-all duration-300 ease-in-out">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-teal-400"><i class="fas fa-calendar-week"></i></div>
            <div>
              <h3 class="text-sm font-medium text-gray-400">Last 7 Days</h3>
              <p id="count-7" class="text-3xl font-bold text-gray-100 mt-1">0</p>
            </div>
          </div>
        </div>
        <div id="card-30" class="stat-card p-4 bg-gray-800 rounded-xl shadow-lg border-l-4 border-pink-500 cursor-pointer hover:shadow-xl transition-all duration-300 ease-in-out">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-pink-400"><i class="fas fa-calendar-alt"></i></div>
            <div>
              <h3 class="text-sm font-medium text-gray-400">Last 1 Month</h3>
              <p id="count-30" class="text-3xl font-bold text-gray-100 mt-1">0</p>
            </div>
          </div>
        </div>
        <div id="card-90" class="stat-card p-4 bg-gray-800 rounded-xl shadow-lg border-l-4 border-purple-500 cursor-pointer hover:shadow-xl transition-all duration-300 ease-in-out">
          <div class="flex items-center space-x-3">
            <div class="text-3xl text-purple-400"><i class="fas fa-calendar-check"></i></div>
            <div>
              <h3 class="text-sm font-medium text-gray-400">Last 3 Months</h3>
              <p id="count-90" class="text-3xl font-bold text-gray-100 mt-1">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabbed Panel -->
      <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
        <div class="flex border-b border-gray-700 mb-4 overflow-x-auto">
          <button id="chart-tab" class="py-2 px-4 text-sm font-medium text-indigo-400 border-b-2 border-indigo-500 focus:outline-none transition-colors duration-200 hover:text-indigo-300 whitespace-nowrap">Trend Chart</button>
          <button id="data-tab" class="py-2 px-4 text-sm font-medium text-gray-400 border-b-2 border-transparent focus:outline-none transition-colors duration-200 hover:text-gray-300 whitespace-nowrap">Trend Data</button>
        </div>
        <div id="tab-content">
          <!-- Trend Chart View -->
          <div id="chart-view">
            <div class="h-96 w-full overflow-x-auto">
              <canvas id="timelineChart"></canvas>
            </div>
          </div>
          <!-- Trend Data View (hidden by default) -->
          <div id="data-view" class="hidden">
            <div id="trendDataTable" class="max-h-96 overflow-y-auto custom-scrollbar overflow-x-auto">
              <!-- Dynamically populated table -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Drill-down -->
  <div id="detailsModal" class="modal-container fixed inset-0 z-[2000] items-center justify-center p-4">
    <div class="modal-overlay fixed inset-0 opacity-0"></div>
    <div class="modal-content relative w-full max-w-5xl bg-gray-800 rounded-xl shadow-2xl p-6 text-gray-100">
      
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-4 border-b border-gray-700 mb-4">
        <h3 id="modalTitle" class="text-xl font-bold">Details</h3>
        <div class="flex space-x-2">
          <button id="modalBackButton" class="hidden p-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="modalCloseButton" class="p-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div id="modalBody" class="max-h-[70vh] overflow-y-auto custom-scrollbar relative overflow-x-auto">
        <!-- Loading spinner for modal content -->
        <div id="modalLoader" class="absolute inset-0 bg-gray-800 flex items-center justify-center transition-opacity duration-300 ease-in-out hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500"></div>
        </div>
        <!-- Content will be injected here -->
      </div>
    </div>
  </div>

  <!-- Attention Modal -->
  <div id="attentionModal" class="modal-container fixed inset-0 z-[2001] items-center justify-center p-4">
    <div class="modal-overlay fixed inset-0 opacity-0"></div>
    <div class="modal-content relative w-full max-w-sm bg-gray-800 rounded-xl shadow-2xl p-6 text-gray-100 text-center">
      <h3 class="text-xl font-bold mb-4 flex items-center justify-center">
        <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mr-2"></i> Attention
      </h3>
      <p class="mb-6">No application should be withheld without a valid reason.</p>
      <button id="attentionModalOkButton" class="p-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-500 transition-colors w-full">Ok</button>
    </div>
  </div>

  <!-- Chart.js and custom script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Constants and state variables
    let rawData = [];
    let filteredData = [];
    let chart;
    let currentModalLevel = 0; // 0: closed, 1: division, 2: ccc, 3: application list
    let maxTodayDate = null; // Global variable to store the latest "TODAY" date from data

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const regionSelect = document.getElementById('region');
    const divisionSelect = document.getElementById('division');
    const supportSelect = document.getElementById('support');
    const portalCheckbox = document.getElementById('portalCheckbox');
    const offlineCheckbox = document.getElementById('offlineCheckbox');
    const reasonFilterContainer = document.getElementById('reasonFilterContainer');
    const leftPanel = document.getElementById('leftPanel');
    const togglePanelButton = document.getElementById('togglePanelButton');
    const closePanelButton = document.getElementById('closePanelButton');
    const selectAllReasonsButton = document.getElementById('selectAllReasons');
    const unselectAllReasonsButton = document.getElementById('unselectAllReasons');
    const mainContent = document.getElementById('mainContent');
    const statCards = document.querySelectorAll('.stat-card');
    const totalCountEl = document.getElementById('total-count');
    const count7El = document.getElementById('count-7');
    const count30El = document.getElementById('count-30');
    const count90El = document.getElementById('count-90');
    const detailsModal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalBackButton = document.getElementById('modalBackButton');
    const modalCloseButton = document.getElementById('modalCloseButton');
    const modalLoader = document.getElementById('modalLoader');
    const attentionModal = document.getElementById('attentionModal'); // New modal element
    const attentionModalOkButton = document.getElementById('attentionModalOkButton'); // New button element
    // Tab-specific elements
    const chartTabButton = document.getElementById('chart-tab');
    const dataTabButton = document.getElementById('data-tab');
    const chartView = document.getElementById('chart-view');
    const dataView = document.getElementById('data-view');
    const trendDataTable = document.getElementById('trendDataTable');


    // Chart.js global settings for dark theme
    Chart.defaults.color = '#a0aec0';
    Chart.defaults.borderColor = '#4a5568';
    Chart.defaults.font.family = 'Inter';

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Restore the original fetch call
            const response = await fetch('data/withheld.json');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            rawData = await response.json();
            console.log('Data loaded successfully from withheld.json');

            // Parse dates
            rawData.forEach(obj => {
                if (obj['SCN_WITHELD_DATE']) {
                    obj['SCN_WITHELD_DATE'] = parseDate(obj['SCN_WITHELD_DATE']);
                }
            });
            
            // Set the "Updated on" date from mock data and store it globally
            const allTodayDates = rawData.map(row => parseDate(row['TODAY'])).filter(date => date);
            maxTodayDate = allTodayDates.length ? new Date(Math.max(...allTodayDates.map(d => d.getTime()))) : new Date();
            // Set time to end of day for comparison to include today's data fully
            maxTodayDate.setHours(23, 59, 59, 999);

            if (maxTodayDate) {
                const formatted = maxTodayDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
                document.getElementById('update-date').textContent = `Updated on ${formatted}`;
            } else {
                document.getElementById('update-date').textContent = `Updated date unavailable`;
            }

            // Initialize dashboard
            populateFilters();
            // Populate reason panel *only once* on initial load
            populateReasonPanel();
            updateDependentFilters();
            applyFilters();

            // Hide loading overlay
            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => { 
                loadingOverlay.style.display = 'none'; 
                attentionModal.classList.add('open'); // Show attention modal after loading
            }, 300);

            // Add change listeners for the filters
            portalCheckbox.addEventListener('change', applyFilters);
            offlineCheckbox.addEventListener('change', applyFilters);
            regionSelect.addEventListener('change', () => { updateDependentFilters(); applyFilters(); });
            divisionSelect.addEventListener('change', () => { updateDependentFilters(); applyFilters(); });
            supportSelect.addEventListener('change', () => { updateDependentFilters(); applyFilters(); });
            
            // Event listener for the reason checkboxes (using event delegation)
            reasonFilterContainer.addEventListener('change', applyFilters);
            
            // New listeners for Select/Unselect All
            selectAllReasonsButton.addEventListener('click', () => {
                document.querySelectorAll('#reasonFilterContainer input[name="reason"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
                applyFilters();
            });
            unselectAllReasonsButton.addEventListener('click', () => {
                document.querySelectorAll('#reasonFilterContainer input[name="reason"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                applyFilters();
            });

            statCards.forEach(card => {
                card.addEventListener('click', () => {
                    const range = card.id.split('-')[1];
                    const cardTitle = card.querySelector('h3').textContent;
                    const cardCount = card.querySelector('p').textContent;
                    // Call the function to handle the modal with the new async logic
                    handleModalOpen(range, cardTitle, cardCount);
                });
            });
            
            // Left panel toggle listeners
            togglePanelButton.addEventListener('click', () => {
                leftPanel.classList.toggle('open');
                // Adjust main content margin only on medium and larger screens
                mainContent.classList.toggle('md:ml-[280px]'); 
            });
            closePanelButton.addEventListener('click', () => {
                leftPanel.classList.remove('open');
                mainContent.classList.remove('md:ml-[280px]'); // Reset main content margin on larger screens
            });

            modalBackButton.addEventListener('click', () => {
                handleModalBack();
            });
            modalCloseButton.addEventListener('click', () => closeModal());
            attentionModalOkButton.addEventListener('click', () => attentionModal.classList.remove('open')); // Close attention modal

            // Tab listeners
            chartTabButton.addEventListener('click', () => showTab('chart'));
            dataTabButton.addEventListener('click', () => showTab('data'));

            // Initial tab state
            showTab('chart');
        } catch (error) {
            console.error('Error fetching data:', error);
            // Handle error state, e.g., show an error message
            loadingOverlay.innerHTML = `<div class="p-6 bg-red-800 text-white rounded-lg shadow-xl"><h2 class="text-xl font-bold mb-2">Error</h2><p>${error.message}. Please ensure 'data/withheld.json' is in the correct directory.</p></div>`;
        }
    });

    // Helper Functions
    function parseDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const match = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (match) {
            const [, dd, mm, yyyy] = match;
            return new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
        }
        return null;
    }

    function animateCounter(element, start, end) {
        const duration = 1000;
        const frameDuration = 1000 / 60;
        const totalFrames = Math.round(duration / frameDuration);
        const increment = (end - start) / totalFrames;
        
        let frame = 0;
        let currentCount = start;
        
        const animate = () => {
            frame++;
            currentCount += increment;
            if (frame === totalFrames) {
                element.textContent = end;
            } else {
                element.textContent = Math.floor(currentCount);
                requestAnimationFrame(animate);
            }
        };
        animate();
    }

    function populateSelect(selectElement, items) {
        const firstOption = selectElement.options[0].cloneNode(true);
        selectElement.innerHTML = '';
        selectElement.appendChild(firstOption);
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            selectElement.appendChild(option);
        });
    }

    // Function to populate the reason filter panel *once* on load
    function populateReasonPanel() {
        const reasons = [...new Set(rawData.map(item => item['SCN_WITHELD_REASON'] || 'No Reason'))].sort();
        const noReasonIndex = reasons.indexOf('No Reason');
        if (noReasonIndex > -1) {
            const noReason = reasons.splice(noReasonIndex, 1)[0];
            reasons.unshift(noReason); // Move 'No Reason' to the beginning
        }

        let html = '';
        reasons.forEach(reason => {
            const labelContent = reason === 'No Reason' ? 
                `<span class="text-red-400 font-semibold">${reason}</span> <span class="text-gray-400 text-sm percentage-span" data-reason="${reason}"></span>` :
                `<span class="checkbox-label-text">${reason}</span> <span class="text-gray-400 text-sm percentage-span" data-reason="${reason}"></span>`;

            html += `
                <label class="checkbox-container text-sm w-full">
                    <input type="checkbox" name="reason" value="${reason}" checked>
                    <span class="checkmark"></span>
                    ${labelContent}
                </label>
            `;
        });
        reasonFilterContainer.innerHTML = html;
    }
    
    // New function to update percentages without recreating checkboxes
    function updateReasonPanelPercentages(data) {
        const filteredDataTotal = data.length;
        const reasonSpans = document.querySelectorAll('.percentage-span');
        
        reasonSpans.forEach(span => {
            const reason = span.dataset.reason;
            const reasonCount = data.filter(item => (item['SCN_WITHELD_REASON'] || 'No Reason') === reason).length;
            const percentage = filteredDataTotal > 0 ? ((reasonCount / filteredDataTotal) * 100).toFixed(1) : 0;
            span.textContent = `(${percentage}%)`;
        });
    }


    // Modal Functions
    function showModal(title, level, parentData = {}) {
        modalTitle.textContent = title;
        currentModalLevel = level;
        detailsModal.classList.add('open');
        modalBackButton.classList.toggle('hidden', currentModalLevel === 1);
        
        // Store parent data for back navigation
        modalBody.dataset.parentData = JSON.stringify(parentData);
    }
    
    function closeModal() {
        detailsModal.classList.remove('open');
        currentModalLevel = 0;
    }
    
    // Function to show the modal loader
    function showModalLoader() {
        modalBody.style.opacity = '0.5';
        modalLoader.classList.remove('hidden');
    }

    // Function to hide the modal loader
    function hideModalLoader() {
        modalLoader.classList.add('hidden');
        modalBody.style.opacity = '1';
    }
    
    // Function to handle back button logic
    function handleModalBack() {
        const parentData = JSON.parse(modalBody.dataset.parentData || '{}');
        
        if (currentModalLevel === 3) {
            // Go back to the CCC level
            const { range, cardTitle, divisionName, divisionData } = parentData;
            // The title for this level is now generated dynamically
            const newTitle = `${cardTitle} ${divisionName} (${divisionData.length})`;
            showModal(newTitle, 2, { range, cardTitle, divisionName, divisionData });
            populateModalWithCccData(divisionName, divisionData, cardTitle, range);
        } else if (currentModalLevel === 2) {
            // Go back to the division level
            const { range, cardTitle } = parentData;
            const newTitle = `${cardTitle} (${modalBody.querySelector('tbody').children.length})`;
            showModal(newTitle, 1, { range, cardTitle });
            populateModalWithDivisionData(range, cardTitle);
        }
    }
    
    // New function to handle the modal opening with proper loading animation
    function handleModalOpen(range, cardTitle, cardCount) {
        // Show the modal and loader immediately
        showModal(`${cardTitle} (${cardCount})`, 1, { range, cardTitle });
        showModalLoader();
        
        // Use a small delay to ensure the UI has time to render the loader
        setTimeout(() => {
            populateModalWithDivisionData(range, cardTitle);
        }, 50); // 50ms delay
    }

    function populateModalWithDivisionData(range, cardTitle) {
        // Clear previous content
        modalBody.innerHTML = '';

        // Use the global maxTodayDate for filtering
        const today = maxTodayDate; 
        const data = filteredData.filter(item => {
            const date = item['SCN_WITHELD_DATE'];
            if (!(date instanceof Date) || isNaN(date.getTime())) return false;
            const diff = (today - date) / (1000 * 60 * 60 * 24);
            return range === 'total' ||
                   (range === '7' && diff <= 7) ||
                   (range === '30' && diff <= 30) ||
                   (range === '90' && diff <= 90);
        });

        if (data.length === 0) {
            modalBody.innerHTML = `<div class="p-4 text-center text-gray-500">No data available for this range.</div>`;
            hideModalLoader();
            return;
        }

        const divnMap = data.reduce((acc, item) => {
            const divn = item['DIVN_NAME'] || 'Unknown';
            acc[divn] = (acc[divn] || []).concat(item);
            return acc;
        }, {});
        const total = data.length;
        const sortedDivns = Object.entries(divnMap)
            .map(([divn, items]) => ({ divn, count: items.length, items }))
            .sort((a, b) => b.count - a.count);

        let detailsHTML = `
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Division</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-300 uppercase tracking-wider">Count</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-300 uppercase tracking-wider">%</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
        `;
        sortedDivns.forEach(({ divn, count, items }) => {
            const percent = ((count / total) * 100).toFixed(1);
            detailsHTML += `
                <tr class="hover:bg-gray-700 transition-colors duration-200 cursor-pointer" data-divn="${divn}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-400">${divn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${percent}%</td>
                </tr>
            `;
        });
        detailsHTML += `</tbody></table>`;
        modalBody.innerHTML = detailsHTML;
        
        modalBody.querySelectorAll('tr[data-divn]').forEach(row => {
            row.addEventListener('click', (e) => {
                const divn = e.currentTarget.dataset.divn;
                const divisionData = divnMap[divn];
                // Pass cardTitle and range to the next level
                handleCccModalOpen(divn, divisionData, cardTitle, range);
            });
        });

        hideModalLoader(); // Hide loader after content is ready
    }

    // New function to handle CCC modal with proper loading animation
    function handleCccModalOpen(divisionName, data, cardTitle, range) {
        // Construct the new title with the dynamic format
        const newTitle = `${cardTitle} ${divisionName} (${data.length})`;
        
        // Show the loader and set the modal title
        showModal(newTitle, 2, { range, cardTitle, divisionName, divisionData: data });
        showModalLoader();

        // Use a small delay to ensure the UI has time to render the loader
        setTimeout(() => {
            populateModalWithCccData(divisionName, data, cardTitle, range);
        }, 50); // 50ms delay
    }

    function populateModalWithCccData(divisionName, data, cardTitle, range) {
        modalBody.innerHTML = '';

        const groupedByCCC = data.reduce((acc, item) => {
            const ccc = item['SUPP_OFF'] || 'Unknown CCC';
            acc[ccc] = (acc[ccc] || []).concat(item);
            return acc;
        }, {});

        const total = data.length;
        const sortedCCCs = Object.entries(groupedByCCC)
            .map(([ccc, items]) => ({ ccc, count: items.length, items }))
            .sort((a, b) => b.count - a.count);

        let html = `
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">CCC</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-300 uppercase tracking-wider">Count</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-300 uppercase tracking-wider">%</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
        `;
        sortedCCCs.forEach(({ ccc, count, items }) => {
            const percent = ((count / total) * 100).toFixed(1);
            html += `
                <tr class="hover:bg-gray-700 transition-colors duration-200 cursor-pointer" data-ccc="${ccc}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-400">${ccc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${percent}%</td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        modalBody.innerHTML = html;
        hideModalLoader(); // Hide loader after content is ready
        
        // Add click listener for CCC rows to open application list
        modalBody.querySelectorAll('tr[data-ccc]').forEach(row => {
            row.addEventListener('click', (e) => {
                const ccc = e.currentTarget.dataset.ccc;
                const cccData = groupedByCCC[ccc];
                openApplicationListModal(ccc, cccData, cardTitle, range, divisionName);
            });
        });
    }

    function openApplicationListModal(cccName, data, cardTitle, range, divisionName) {
        // Construct the new title for the final level
        const newTitle = `${cardTitle} ${divisionName} ${cccName} (${data.length})`;
        
        const parentData = JSON.parse(modalBody.dataset.parentData);
        showModal(newTitle, 3, { ...parentData, cccName, cccData: data });
        showModalLoader();

        setTimeout(() => {
            populateModalWithApplicationData(cccName, data);
        }, 50);
    }
    
    function populateModalWithApplicationData(cccName, data) {
        modalBody.innerHTML = '';
        
        if (data.length === 0) {
            modalBody.innerHTML = `<div class="p-4 text-center text-gray-500">No applications found for ${cccName}.</div>`;
            hideModalLoader();
            return;
        }
        
        let html = `
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Appl No.</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Phone No.</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Class</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Phase</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Reason</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
        `;
        
        data.forEach(item => {
            html += `
                <tr class="hover:bg-gray-700 transition-colors duration-200">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['APPL_NO'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['NAME'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['PHONE_NO'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['CONN_CLASS'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['APPLIED_PHASE'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item['SCN_WITHELD_REASON'] || '-'}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        modalBody.innerHTML = html;
        hideModalLoader();
    }

    function populateFilters() {
        const regions = [...new Set(rawData.map(item => item['REGION']).filter(Boolean))].sort();
        populateSelect(regionSelect, regions);
    }

    function updateDependentFilters() {
        const selectedRegion = regionSelect.value;
        const selectedDivision = divisionSelect.value;
        const selectedSupport = supportSelect.value;
        let possibleDivisions = new Set();
        let possibleSupports = new Set();

        rawData.forEach(item => {
            if (!selectedRegion || item['REGION'] === selectedRegion) {
                if (item['DIVN_NAME']) possibleDivisions.add(item['DIVN_NAME']);
                if (!selectedDivision || item['DIVN_NAME'] === selectedDivision) {
                    if (item['SUPP_OFF']) possibleSupports.add(item['SUPP_OFF']);
                }
            }
        });
        populateSelect(divisionSelect, [...possibleDivisions].sort());
        populateSelect(supportSelect, [...possibleSupports].sort());
    }

    function applyFilters() {
        const region = regionSelect.value;
        const division = divisionSelect.value;
        const support = supportSelect.value;
        const portalChecked = portalCheckbox.checked;
        const offlineChecked = offlineCheckbox.checked;

        // Step 1: Filter data based on all filters EXCEPT reasons
        const tempFilteredData = rawData.filter(item => {
            const matchesRegion = !region || item['REGION'] === region;
            const matchesDivision = !division || item['DIVN_NAME'] === division;
            const matchesSupport = !support || item['SUPP_OFF'] === support;
            
            const matchesPortalOffline = (portalChecked && item['IS_PORTAL_APPL'] === 'Y') ||
                                         (offlineChecked && item['IS_PORTAL_APPL'] === 'N') ||
                                         (!portalChecked && !offlineChecked);

            return matchesRegion && matchesDivision && matchesSupport && matchesPortalOffline;
        });
        
        // Step 2: Update the percentages on the reason panel based on this filtered data
        updateReasonPanelPercentages(tempFilteredData);

        // Step 3: Get the reasons that are currently checked by the user
        const checkedReasons = Array.from(document.querySelectorAll('#reasonFilterContainer input[name="reason"]:checked')).map(cb => cb.value);
        const allReasonsUnchecked = checkedReasons.length === 0;

        // Step 4: Final filter, including the user's reason selections
        filteredData = tempFilteredData.filter(item => {
            const itemReason = item['SCN_WITHELD_REASON'] || 'No Reason';
            return allReasonsUnchecked || checkedReasons.includes(itemReason);
        });

        // Step 5: Update the dashboard with the final filtered data
        updateCards();
        updateChart();
        updateDataTable();
    }

    function updateCards() {
        // Use the global maxTodayDate for filtering
        const today = maxTodayDate;
        let count7 = 0;
        let count30 = 0;
        let count90 = 0;

        filteredData.forEach(item => {
            const date = item['SCN_WITHELD_DATE'];
            if (date) {
                const diff = (today - date) / (1000 * 60 * 60 * 24);
                if (diff >= 0 && diff <= 7) count7++;
                if (diff >= 0 && diff <= 30) count30++;
                if (diff >= 0 && diff <= 90) count90++;
            }
        });

        animateCounter(totalCountEl, parseInt(totalCountEl.textContent), filteredData.length);
        animateCounter(count7El, parseInt(count7El.textContent), count7);
        animateCounter(count30El, parseInt(count30El.textContent), count30);
        animateCounter(count90El, parseInt(count90El.textContent), count90);
    }
    
    // New function to handle tab switching
    function showTab(tab) {
        if (tab === 'chart') {
            chartTabButton.classList.add('text-indigo-400', 'border-indigo-500');
            chartTabButton.classList.remove('text-gray-400', 'border-transparent');
            dataTabButton.classList.add('text-gray-400', 'border-transparent');
            dataTabButton.classList.remove('text-indigo-400', 'border-indigo-500');
            chartView.classList.remove('hidden');
            dataView.classList.add('hidden');
            updateChart(); // Redraw chart to prevent rendering issues after being hidden
        } else if (tab === 'data') {
            dataTabButton.classList.add('text-indigo-400', 'border-indigo-500');
            dataTabButton.classList.remove('text-gray-400', 'border-transparent');
            chartTabButton.classList.add('text-gray-400', 'border-transparent');
            chartTabButton.classList.remove('text-indigo-400', 'border-indigo-500');
            dataView.classList.remove('hidden');
            chartView.classList.add('hidden');
            updateDataTable(); // Generate and display the table
        }
    }

    function updateChart() {
        // Filter SCN_WITHELD_DATE to be before or on the maxTodayDate
        const validDates = filteredData
            .map(item => item['SCN_WITHELD_DATE'])
            .filter(date => date && date <= maxTodayDate); // Use the global maxTodayDate
        
        if (validDates.length === 0) {
            if (chart) chart.destroy();
            return;
        }

        const monthCounts = validDates.reduce((acc, date) => {
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        
        const minDate = new Date(Math.min(...validDates.map(d => d.getTime())));
        const maxDateForChart = new Date(Math.max(...validDates.map(d => d.getTime()))); // Use max date from validDates for chart range
        let fullRange = [];
        let current = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
        const end = new Date(maxDateForChart.getFullYear(), maxDateForChart.getMonth(), 1);

        while (current <= end) {
            const key = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
            fullRange.push(key);
            current.setMonth(current.getMonth() + 1);
        }

        const trimmedLabels = fullRange.filter(key => monthCounts[key]);
        const trimmedData = trimmedLabels.map(key => monthCounts[key] || 0);

        if (chart) chart.destroy();

        const ctx = document.getElementById('timelineChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: trimmedLabels,
                datasets: [{
                    label: 'Withheld Count',
                    data: trimmedData,
                    backgroundColor: trimmedLabels.map(label => parseInt(label.split('-')[0]) % 2 === 0 ? 'rgba(99, 102, 241, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                    borderColor: trimmedLabels.map(label => parseInt(label.split('-')[0]) % 2 === 0 ? 'rgba(99, 102, 241, 1)' : 'rgba(239, 68, 68, 1)'),
                    borderWidth: 1,
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            callback: function(value, index) {
                                const [year, month] = this.getLabelForValue(value).split('-');
                                return month === '01' ? year : '';
                            },
                            color: '#a0aec0',
                            autoSkip: false,
                            minRotation: 90,
                            maxRotation: 90,
                        },
                        title: { display: true, text: 'Year', font: { weight: 'bold' } }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Count', font: { weight: 'bold' } },
                        ticks: { precision: 0 }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#374151',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        callbacks: {
                            title: function(context) {
                                const [year, month] = context[0].label.split('-');
                                const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                                return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                            },
                            label: function(context) {
                                return ` Count: ${context.raw}`;
                            }
                        }
                    }
                },
                animation: { duration: 1000, easing: 'easeInOutQuad' }
            }
        });
    }

    // New function to update the data table
    function updateDataTable() {
        // Filter SCN_WITHELD_DATE to be before or on the maxTodayDate
        const validDates = filteredData
            .map(item => item['SCN_WITHELD_DATE'])
            .filter(date => date && date <= maxTodayDate); // Use the global maxTodayDate
        
        if (validDates.length === 0) {
            trendDataTable.innerHTML = `<div class="p-4 text-center text-gray-500">No data available for the selected filters.</div>`;
            return;
        }

        const monthCounts = validDates.reduce((acc, date) => {
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        
        // Sort the months chronologically (ascending)
        const sortedMonths = Object.keys(monthCounts).sort();
        
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Month / Year</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-300 uppercase tracking-wider">Withheld Count</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
        `;
        
        sortedMonths.forEach(key => {
            const [year, month] = key.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, 1);
            const formattedMonth = date.toLocaleString('default', { month: 'long', year: 'numeric' });
            const count = monthCounts[key];
            
            tableHTML += `
                <tr class="hover:bg-gray-700 transition-colors duration-200">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-400">${formattedMonth}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${count}</td>
                </tr>
            `;
        });
        
        tableHTML += `</tbody></table>`;
        trendDataTable.innerHTML = tableHTML;
    }
  </script>
</body>
</html>
