<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accident Report Cards - Malda Zone</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #333;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .title {
      color: white;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 700;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.85);
      font-size: clamp(0.875rem, 2.5vw, 1rem);
      margin: 0;
      font-weight: 400;
    }

    .tabs {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
      padding: 0 8px;
    }

    .tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 80px;
      text-align: center;
      user-select: none;
      touch-action: manipulation;
    }

    .tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-card:active {
      transform: translateY(-4px);
    }

    .stat-number {
      font-size: clamp(2rem, 6vw, 3rem);
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      font-size: clamp(0.75rem, 2.5vw, 0.875rem);
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 1.25rem;
      opacity: 0.7;
    }

    .click-hint {
      font-size: 0.65rem;
      color: #999;
      margin-top: 4px;
      opacity: 0.8;
      font-weight: 500;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 16px;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 24px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9) translateY(60px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
      position: relative;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .modal-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
      margin: 0;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .modal-tab {
      flex: 1;
      padding: 16px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      color: #666;
      transition: all 0.2s ease;
      position: relative;
    }

    .modal-tab.active {
      color: #667eea;
      background: white;
    }

    .modal-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .modal-content {
      padding: 24px;
      max-height: 50vh;
      overflow-y: auto;
    }

    .breakdown-list {
      display: grid;
      gap: 12px;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      transition: all 0.2s ease;
    }

    .breakdown-item:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }

    .breakdown-name {
      font-weight: 600;
      color: #333;
      flex: 1;
      margin-right: 16px;
    }

    .breakdown-count {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.875rem;
      min-width: 40px;
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .loading {
      text-align: center;
      color: white;
      font-size: clamp(1rem, 3vw, 1.25rem);
      margin-top: 60px;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    .loading-animation {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .loading-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 3px solid transparent;
      border-radius: 50%;
      animation: rotate 2s linear infinite;
    }

    .loading-ring:nth-child(1) {
      border-top: 3px solid rgba(255, 255, 255, 0.9);
      animation-duration: 1.5s;
    }

    .loading-ring:nth-child(2) {
      border-right: 3px solid rgba(255, 255, 255, 0.7);
      animation-duration: 2s;
      animation-direction: reverse;
    }

    .loading-ring:nth-child(3) {
      border-bottom: 3px solid rgba(255, 255, 255, 0.5);
      animation-duration: 2.5s;
    }

    .loading-ring:nth-child(4) {
      border-left: 3px solid rgba(255, 255, 255, 0.3);
      animation-duration: 3s;
      animation-direction: reverse;
    }

    .loading-pulse {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-text {
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      position: relative;
    }

    .loading-text::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }

    .loading-progress::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent,
        rgba(255, 255, 255, 0.4),
        rgba(255, 255, 255, 0.8),
        rgba(255, 255, 255, 0.4),
        transparent
      );
      animation: shimmer 2s infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      50% { 
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .debug {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 12px;
      margin-top: 24px;
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .stats-overview {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 20px 16px;
      }

      .tabs {
        gap: 6px;
      }

      .tab {
        padding: 10px 12px;
        font-size: 0.8rem;
        min-width: 70px;
      }

      .modal {
        max-width: 95vw;
        max-height: 95vh;
        margin: 8px;
      }

      .modal-header {
        padding: 20px 16px;
      }

      .modal-content {
        padding: 16px;
        max-height: 60vh;
      }

      .breakdown-item {
        padding: 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .breakdown-name {
        margin-right: 0;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .stats-overview {
        gap: 8px;
      }

      .stat-card {
        padding: 16px 12px;
        border-radius: 16px;
      }

      .tabs {
        gap: 4px;
        margin-bottom: 16px;
      }

      .tab {
        padding: 8px 10px;
        font-size: 0.75rem;
        border-radius: 10px;
      }

      .modal-header {
        padding: 16px 12px;
      }

      .modal-title {
        font-size: 1.25rem;
      }

      .modal-content {
        padding: 12px;
      }
    }

    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      .tab,
      .stat-card,
      .modal,
      .modal-overlay {
        transition: none;
      }
      
      .stat-card:hover {
        transform: none;
      }
      
      .loading-ring,
      .loading-pulse,
      .loading-progress::before {
        animation: none;
      }
      
      .loading-text::after {
        animation: none;
        content: '...';
      }
    }

    /* High contrast support */
    @media (prefers-contrast: high) {
      .stat-card {
        border: 2px solid #333;
      }
      
      .tab {
        border: 2px solid #333;
      }
      
      .modal {
        border: 2px solid #333;
      }
    }
    @media (max-width: 768px) {
  #calendarGrid {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (max-width: 480px) {
  #calendarGrid {
    grid-template-columns: repeat(2, 1fr);
  }
}
#calendarGrid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  margin-top: 16px;
}

@media (max-width: 1024px) {
  #calendarGrid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 768px) {
  #calendarGrid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 480px) {
  #calendarGrid {
    grid-template-columns: repeat(2, 1fr);
  }
}

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">Accident Report Dashboard</h1>
      <p class="subtitle">Malda Zone Safety Analytics</p>
      <p class="date-range" id="dateRange" style="color: rgba(255, 255, 255, 0.85); font-size: clamp(0.75rem, 2vw, 0.875rem); margin: 8px 0 0 0; font-weight: 500;"></p>
    </div>

    <div class="tabs">
      <div class="tab active" data-region="zone">Zone</div>
      <div class="tab" data-region="Malda (D) Region">Malda</div>
      <div class="tab" data-region="Uttar Dinajpur (D) Region">Uttar Dinajpur</div>
      <div class="tab" data-region="Dakshin Dinajpur (D) Region">Dakshin Dinajpur</div>
    </div>
    
    <div class="loading" id="loading">
      <div class="loading-animation">
        <div class="loading-ring"></div>
        <div class="loading-ring"></div>
        <div class="loading-ring"></div>
        <div class="loading-ring"></div>
        <div class="loading-pulse"></div>
      </div>
      <div class="loading-text">Loading Analytics</div>
      <div class="loading-progress"></div>
    </div>
    
    <div class="stats-overview" id="statsOverview" style="display: none;">
      <div class="stat-card" data-type="total">
        <div class="stat-number" id="totalAccidents">0</div>
        <div class="stat-label">Total Accidents</div>
        <div class="trend-indicator"><span>📊</span></div>
        <div class="click-hint">Click for details</div>
      </div>
      <div class="stat-card" data-type="fatal">
        <div class="stat-number" id="fatalAccidents">0</div>
        <div class="stat-label">Fatal Accidents</div>
        <div class="trend-indicator"><span>⚠️</span></div>
        <div class="click-hint">Click for details</div>
      </div>
      <div class="stat-card" data-type="pending">
        <div class="stat-number" id="pendingInquiries">0</div>
        <div class="stat-label">Pending Inquiries</div>
        <div class="trend-indicator"><span>⏱️</span></div>
        <div class="click-hint">Click for details</div>
      </div>
 <div class="stat-card" data-type="recent">
  <div class="stat-number" id="recentAccidents">0</div>
  <div class="stat-label">Last 3 Months</div>
  <div class="trend-indicator"><span>🕒</span></div>
  <div class="click-hint">Click for details</div>
</div>

    </div>
<div id="calendarSummary" style="margin: 32px auto; max-width: 800px;">
  <h2 style="text-align: center; color: white;">Monthly Accident Summary</h2>
<div id="calendarGrid"></div>

</div>

    <div class="debug" id="debug" style="display: none;">
      <strong>Debug Info:</strong><br>
      <div id="debugContent"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Accident Details</div>
        <div class="modal-subtitle" id="modalSubtitle">Breakdown by divisions and units</div>
        <button class="modal-close" id="modalClose">×</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-modal-tab="division">Division-wise</button>
        <button class="modal-tab" data-modal-tab="unit">Unit-wise</button>
      </div>
      <div class="modal-content">
        <div class="breakdown-list" id="breakdownList">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let accidentData = [];
    let processedData = [];
    let currentRegionFilter = 'zone';
    let currentModalTab = 'division';
    let lastModalData = [];

    

    // Valid regions for Malda Zone
    const VALID_REGIONS = [
      'Malda (D) Region',
      'Dakshin Dinajpur (D) Region',
      'Raiganj (D) Region',
      'Uttar Dinajpur (D) Region'
    ];

    // Toggle debug info (double-click on title)
    document.addEventListener('dblclick', (e) => {
      if (e.target.classList.contains('title')) {
        const debug = document.getElementById('debug');
        debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
      }
    });

    // Tab event listeners
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRegionFilter = tab.dataset.region;
        updateStats(currentRegionFilter);
      });
    });

    // Modal event listeners
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modalOverlay')) {
        closeModal();
      }
    });

    // Modal tab switching
    document.querySelectorAll('.modal-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentModalTab = tab.dataset.modalTab;
        updateModalContent();
      });
    });

    // Escape key to close modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Stat card click handlers
    document.addEventListener('click', (e) => {
      const statCard = e.target.closest('.stat-card');
      if (statCard) {
        const cardType = statCard.dataset.type;
        openModal(cardType);
      }
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadData();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('statsOverview').style.display = 'grid';
        updateStats('zone');
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = '<div class="loading-text">Error loading data. Please refresh the page.</div>';
      }
    });

    async function loadData() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRrrGeyElvh8i8QzTl25Ej7_RJZ9FJ0jicG3tAhguLEvky178oKZ8-QADKcBceUQ5CFjn7hd9eECVJ6/pub?output=csv');
      const csvText = await response.text();
      accidentData = parseCSV(csvText);
      processedData = processData(accidentData);
      
      // Calculate and display date range
      updateDateRange();
      
      // Debug info
      console.log('Raw data rows:', accidentData.length);
      console.log('Processed data rows:', processedData.length);
      
      updateDebugInfo();
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length === 0) return [];
      
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length === 0) continue;
        
        const row = {};
        headers.forEach((header, index) => {
          row[header.trim()] = (values[index] || '').trim();
        });
        data.push(row);
      }
      
      return data;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    function processData(rawData) {
      const seenAccidentIds = new Set();
      const processed = [];
      
      for (const row of rawData) {
        const region = row['Name of the Region'];
        const accidentId = row['Accident Id'];
        
        // Skip if no accident ID or duplicate
        if (!accidentId || seenAccidentIds.has(accidentId)) {
          continue;
        }
        
        // Only include valid regions
        if (!VALID_REGIONS.includes(region)) {
          continue;
        }
        
        // Map regions according to requirement
        let mappedRegion = region;
        if (region === 'Uttar Dinajpur (D) Region') {
          mappedRegion = 'Raiganj (D) Region';
        }
        
        // Create processed row
        const processedRow = {
          ...row,
          _mappedRegion: mappedRegion,
          _originalRegion: region
        };
        
        processed.push(processedRow);
        seenAccidentIds.add(accidentId);
      }
      
      return processed;
    }

    function updateStats(regionFilter) {
      let filteredData = processedData;
      
      // Apply region filter
      if (regionFilter !== 'zone') {
        // Map display names to internal names
        let targetRegion = regionFilter;
        if (regionFilter === 'Uttar Dinajpur (D) Region') {
          targetRegion = 'Raiganj (D) Region'; // This is how we stored mapped Uttar Dinajpur
        }
        // For other regions, use as-is
        // Malda (D) Region and Dakshin Dinajpur (D) Region don't need mapping
        
        filteredData = processedData.filter(row => row._mappedRegion === targetRegion);
      }
      
      // Calculate statistics
      const totalAccidents = filteredData.length;
      
      const fatalAccidents = filteredData.filter(row => {
        const fatalityOnEnquery = row['Fatality On Enquery'];
        const natureOfInjury = row['Nature of Injury'];
        
        // Check both columns for fatal accidents
        const isFatalFromEnquery = fatalityOnEnquery && fatalityOnEnquery.toLowerCase() === 'yes';
        const isFatalFromNature = natureOfInjury && natureOfInjury.toLowerCase() === 'fatal';
        
        return isFatalFromEnquery || isFatalFromNature;
      }).length;
      
      const pendingInquiries = filteredData.filter(row => {
        const enquiryOn = row['Inquiry Submitted on'];
        // Count as pending if 'Inquiry Submitted on' is null, empty, or undefined
        return !enquiryOn || enquiryOn.trim() === '';
      }).length;
      
      // Calculate average response time
      const responseTimes = filteredData
        .map(row => {
          const days = row['Pending since last status change(days)'];
          return days ? parseInt(days) : 0;
        })
        .filter(days => days > 0);
      
      const avgResponseTime = responseTimes.length > 0 
        ? Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length)
        : 0;
      
      // Update display
      document.getElementById('totalAccidents').textContent = totalAccidents;
      document.getElementById('fatalAccidents').textContent = fatalAccidents;
      document.getElementById('pendingInquiries').textContent = pendingInquiries;
// Calculate accidents in last 3 months (based on max date)
const parseDate = (str) => {
  const [dd, mm, yyyy] = str.split('/');
  return new Date(`${yyyy}-${mm}-${dd}`);
};

const validDates = filteredData
  .map(row => row['Date of Accident'])
  .filter(d => d && /^\d{2}\/\d{2}\/\d{4}$/.test(d))
  .map(parseDate)
  .filter(date => !isNaN(date));

let recentCount = 0;
if (validDates.length > 0) {
  const maxDate = new Date(Math.max(...validDates));
  const threeMonthsAgo = new Date(maxDate);
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

  recentCount = validDates.filter(date => date >= threeMonthsAgo && date <= maxDate).length;
}

// Update the last stat card
document.getElementById('recentAccidents').textContent = recentCount;

updateMonthlyCalendar(filteredData);

      
      // Update debug info
      updateDebugInfo(regionFilter, filteredData);
    }

    function updateDebugInfo(currentFilter = 'zone', currentData = processedData) {
      const debugContent = document.getElementById('debugContent');


            if (!debugContent) return;

      debugContent.innerHTML = `
        <div><strong>Current Filter:</strong> ${currentFilter}</div>
        <div><strong>Total Filtered Records:</strong> ${currentData.length}</div>
        <div><strong>Sample Record:</strong> <pre>${JSON.stringify(currentData[0] || {}, null, 2)}</pre></div>
      `;
    }

function openModal(cardType) {
  const overlay = document.getElementById('modalOverlay');
  const titleMap = {
    total: 'All Reported Accidents',
    fatal: 'Fatal Accidents',
    pending: 'Pending Inquiries',
    response: 'Response Time Distribution',
    recent: 'Last 3 Months'
  };

  document.getElementById('modalTitle').textContent = titleMap[cardType] || 'Accident Details';

  const parseDate = (str) => {
    const [dd, mm, yyyy] = str.split('/');
    return new Date(`${yyyy}-${mm}-${dd}`);
  };

  let modalData = [];
  const region = currentRegionFilter === 'zone' ? null : currentRegionFilter;
  const regionMap = {
    'Uttar Dinajpur (D) Region': 'Raiganj (D) Region'
  };
  const finalRegion = regionMap[region] || region;

  // Filter data first based on the selected region
  let relevantDataForModal = processedData.filter(row => {
    return finalRegion ? row._mappedRegion === finalRegion : true;
  });

  if (cardType === 'recent') {
    const validDatesForRegion = relevantDataForModal
      .map(row => ({
        ...row,
        _dateObj: parseDate(row['Date of Accident'])
      }))
      .filter(row => !isNaN(row._dateObj));

    let maxDate = new Date(); // Default to current date if no valid dates in region
    if (validDatesForRegion.length > 0) {
      maxDate = new Date(Math.max(...validDatesForRegion.map(r => r._dateObj)));
    }
    const threeMonthsAgo = new Date(maxDate);
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    modalData = validDatesForRegion.filter(row => {
      return row._dateObj >= threeMonthsAgo && row._dateObj <= maxDate;
    });

    if (modalData.length > 0) {
        const modalMinDate = new Date(Math.min(...modalData.map(r => r._dateObj)));
        const modalMaxDate = new Date(Math.max(...modalData.map(r => r._dateObj)));
        const formatDDMMYYYY = (date) =>
          `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        document.getElementById('modalSubtitle').textContent = `Accidents from ${formatDDMMYYYY(modalMinDate)} to ${formatDDMMYYYY(modalMaxDate)}`;
    } else {
        document.getElementById('modalSubtitle').textContent = `No accidents in the last 3 months for this region.`;
    }


  } else {
    // Existing logic for other card types
    modalData = relevantDataForModal.filter(row => {
      if (cardType === 'fatal') {
        const f = row['Fatality On Enquery']?.toLowerCase() === 'yes';
        const n = row['Nature of Injury']?.toLowerCase() === 'fatal';
        return f || n;
      } else if (cardType === 'pending') {
        return !row['Inquiry Submitted on'] || row['Inquiry Submitted on'].trim() === '';
      } else if (cardType === 'response') {
        return row['Pending since last status change(days)'];
      }
      return true; // For 'total' cardType
    });
     document.getElementById('modalSubtitle').textContent = 'Breakdown by divisions and units';
  }

  // ... rest of the openModal function remains the same ...
  // Grouped modal content (this part is correct after modalData is correctly filtered)
  const tabKey = currentModalTab === 'unit'
    ? 'Name of CCC/ Substation/ RE Project'
    : 'Name of Division / RE Project';
  const grouped = {};
  modalData.forEach(row => {
    let rawKey = row[tabKey] || 'Unknown';
    let key = rawKey.trim().replace(/\s+/g, ' '); // normalize whitespace
    key = key.charAt(0).toUpperCase() + key.slice(1); // optional: Title-case first letter
    grouped[key] = (grouped[key] || 0) + 1;
  });

  const breakdownList = document.getElementById('breakdownList');
  breakdownList.innerHTML = '';

  if (Object.keys(grouped).length === 0) {
    breakdownList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📭</div>No data available for selected filter.</div>`;
    return;
  }

  Object.entries(grouped)
    .sort((a, b) => a[0].localeCompare(b[0]))
    .forEach(([name, count]) => {
      const item = document.createElement('div');
      item.className = 'breakdown-item';
      item.innerHTML = `
        <div class="breakdown-name">${name}</div>
        <div class="breakdown-count">${count}</div>
      `;
      breakdownList.appendChild(item);
    });

    overlay.classList.add('active'); // This line was moved to the end as the logic inside needs to run first
}

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

function updateModalContent() {
  const overlay = document.getElementById('modalOverlay');
  if (!overlay.classList.contains('active')) return;

  const modalTitleText = document.getElementById('modalTitle').textContent;

  const cardTypeMap = {
  'All Reported Accidents': 'total',
  'Fatal Accidents': 'fatal',
  'Pending Inquiries': 'pending',
  'Last 3 Months': 'recent'
};

  const type = cardTypeMap[modalTitleText] || 'total';
  openModal(type);
}

function updateDateRange() {
  // Parse DD/MM/YYYY to Date
  const parseDate = (str) => {
    if (!str || !str.includes('/')) return null;
    const [dd, mm, yyyy] = str.split('/');
    if (!dd || !mm || !yyyy) return null;
    const date = new Date(`${yyyy}-${mm}-${dd}`);
    return isNaN(date) ? null : date;
  };

  // Format Date to DD/MM/YYYY
  const formatDDMMYYYY = (date) =>
    `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;

  const validDates = processedData
    .map(row => parseDate(row['Date of Accident']))
    .filter(date => date !== null);

  if (validDates.length === 0) return;

  const minDate = new Date(Math.min(...validDates));
  const maxDate = new Date(Math.max(...validDates));

  // Duration calculation
  let years = maxDate.getFullYear() - minDate.getFullYear();
  let months = maxDate.getMonth() - minDate.getMonth();
  if (months < 0) {
    years -= 1;
    months += 12;
  }

  document.getElementById('dateRange').textContent =
    `Data from ${formatDDMMYYYY(minDate)} to ${formatDDMMYYYY(maxDate)} (${years} Year${years !== 1 ? 's' : ''}, ${months} Month${months !== 1 ? 's' : ''})`;
}

function updateMonthlyCalendar(filteredData) {
  const monthMap = Array.from({ length: 12 }, (_, i) => ({
    name: new Date(0, i).toLocaleString('default', { month: 'short' }),
    count: 0
  }));

  const parseDate = (str) => {
    const [dd, mm, yyyy] = str.split('/');
    const d = new Date(`${yyyy}-${mm}-${dd}`);
    return isNaN(d) ? null : d;
  };

  filteredData.forEach(row => {
    const dateStr = row['Date of Accident'];
    const date = parseDate(dateStr);
    if (date) {
      const monthIndex = date.getMonth();
      monthMap[monthIndex].count++;
    }
  });
const total = monthMap.reduce((sum, m) => sum + m.count, 0);  // ✅ Add this
const topCounts = [...monthMap]
  .sort((a, b) => b.count - a.count)
  .slice(0, 3)
  .map(m => m.count);

const grid = document.getElementById('calendarGrid');
grid.innerHTML = '';

monthMap.forEach((m) => {
  const percent = total > 0 ? ((m.count / total) * 100).toFixed(1) : '0.0';

  // Highlight if this month is in the top 3
  const isTopMonth = topCounts.includes(m.count);
  const bgColor = isTopMonth
    ? 'linear-gradient(135deg, #ff4e50, #f9d423)'  // red-orange gradient
    : 'rgba(255, 255, 255, 0.9)';
  const textColor = isTopMonth ? '#fff' : '#333';

  const box = document.createElement('div');
  box.style = `
    background: ${bgColor};
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    font-weight: 600;
    color: ${textColor};
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  `;
  box.innerHTML = `
    <div style="font-size: 1.1rem; font-weight: 600;">${m.name}</div>
    <div style="font-size: 1.8rem;">${m.count}</div>
    <div style="font-size: 0.75rem; opacity: 0.8;">${percent}% of total</div>
  `;
  grid.appendChild(box);
});


}


  </script>
</body>
</html>
