<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PTR Oil Testing Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    :root {
      /* Define a minimal color palette as CSS variables */
      --primary-color: #4a90e2; /* Softer blue */
      --secondary-color: #6c757d; /* Standard secondary gray */
      --success-color: #5cb85c; /* Standard success green */
      --warning-color: #f0ad4e; /* Standard warning orange */
      --info-color: #5bc0de;   /* Standard info light blue */
      --background-light: #f8f9fa; /* Very light background */
      --text-dark: #343a40;      /* Dark text for body */
      --text-muted: #6c757d;     /* Muted text */
      --border-light: #ced4da;   /* Light border for forms/cards */
      --shadow-light: rgba(0, 0, 0, 0.06); /* Softer shadow */
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
    }
    .container {
      background-color: #ffffff; /* White content area */
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow-light); /* Softer shadow */
      margin-top: 30px;
      margin-bottom: 30px;
    }
    h3 {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 25px;
      text-align: center;
    }
    .card {
      border: 1px solid var(--border-light);
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow-light); /* Softer shadow for cards */
    }
    .card-header {
      border-bottom: 1px solid var(--border-light);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      font-weight: 500;
      font-size: 1.1rem;
      padding: 15px 20px;
    }
    .card-header.bg-primary { background-color: var(--primary-color) !important; }
    .card-header.bg-info { background-color: var(--info-color) !important; }
    .card-header.bg-success { background-color: var(--success-color) !important; }
    .card-header.bg-warning { background-color: var(--warning-color) !important; }


    .form-select, .form-control {
      border-radius: 8px;
      padding: 10px 15px;
      border: 1px solid var(--border-light);
      color: var(--text-dark); /* Ensure text is dark */
    }
    .form-select:focus, .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25); /* Alpha of primary-color */
    }
    .form-label {
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: 5px;
    }

    .btn {
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex; /* Align icon and text */
      align-items: center;
      justify-content: center;
      gap: 8px; /* Space between icon and text */
    }
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    .btn-primary:hover {
      background-color: #3b7ad6; /* Slightly darker primary */
      border-color: #3b7ad6;
    }
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    .btn-success:hover {
      background-color: #4cae4c; /* Slightly darker success */
      border-color: #4cae4c;
    }
    .btn-warning {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: var(--text-dark); /* Darker text for warning button */
    }
    .btn-warning:hover {
      background-color: #e39a2f; /* Slightly darker warning */
      border-color: #e39a2f;
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    .btn-secondary:hover {
      background-color: #5a6268;
      border-color: #545b62;
    }
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: #fff;
    }


    .modal-content {
      border-radius: 12px;
      box-shadow: 0 8px 30px var(--shadow-light);
    }
    .modal-header {
      border-bottom: none;
      padding: 20px;
      position: relative;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .modal-header .btn-close {
      position: absolute;
      right: 15px;
      top: 15px;
      color: #fff; /* White close button for colored headers */
      opacity: 0.8;
      background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
    }
    .modal-header .btn-close.btn-close-white { /* Ensure white close button on dark backgrounds */
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.4rem;
      color: #fff;
      display: flex;
      align-items: center;
    }
    .modal-title .fas {
        margin-right: 10px;
    }
    .modal-body {
      padding: 25px;
      font-size: 0.95rem;
    }
    .modal-footer {
      border-top: none;
      padding: 15px 25px;
    }
    .form-text {
      font-size: 0.875em;
      color: var(--text-muted);
      margin-top: 5px;
    }
    .form-text a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }
    .form-text a:hover {
      text-decoration: underline;
    }
    .spinner-border {
      margin-left: 5px;
    }
    /* Icons in modals */
    .modal-body .fas {
      font-size: 3.5rem; /* Larger icons for status modals */
      margin-bottom: 15px;
    }
    /* Summary text in modals */
    #testRecordSummary, #ptrSummary {
      border: 1px dashed var(--border-light);
      padding: 15px;
      font-size: 0.85rem;
      background-color: var(--background-light);
      color: var(--text-dark);
    }
    #generateObservation:hover {
  transform: rotate(20deg);
  transition: 0.2s ease;
}

  </style>
</head>
<body class="p-4">

<div class="container">
<h3 class="mb-4 d-flex justify-content-between align-items-center">
  PTR Oil Testing Record Form
  <button id="alertButton" class="btn btn-sm btn-danger" title="Show outdated testing records">
    <i class="fas fa-exclamation-triangle"></i>
  </button>
</h3>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <i class="fas fa-file-alt"></i> New Test Record
    </div>
    <div class="card-body">
      <form id="testForm">
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Region</label>
            <select class="form-select" id="region" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Division</label>
            <select class="form-select" id="division" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Substation</label>
            <select class="form-select" id="substation" required></select>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-12">
            <label class="form-label">PTR (Equipment Info)</label>
            <select class="form-select" id="ptrSelect" required></select>
            <div class="form-text">
              Can't find PTR? <a href="#" onclick="showPTRModal()"><i class="fas fa-plus-circle"></i> Add New</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Sample Collection Date</label>
            <input type="date" class="form-control" name="Sample Collection Date" id="sampleCollectionDate" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sample Testing Date</label>
            <input type="date" class="form-control" name="Sample Testing Date" id="sampleTestingDate" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sample Collected By</label>
            <input type="text" class="form-control" name="Sample Collected By">
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Source Reference</label>
            <input type="text" class="form-control" name="Source Referance">
          </div>
          <div class="col-md-4">
            <label class="form-label">Testing Reference</label>
            <input type="text" class="form-control" name="Testing Referance">
          </div>
          <div class="col-md-4">
            <label class="form-label">Oil Sample Position</label>
            <select class="form-select" name="Oil Sample Position" required>
              <option value="">Select</option>
              <option value="Top">Top</option>
              <option value="Bottom">Bottom</option>
              <option value="OLTC">OLTC</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Physical Appearance</label>
            <select class="form-select" name="Physical Appearance" required>
              <option value="">Select</option>
              <option value="Pale Yellow">Pale Yellow</option>
              <option value="Clear">Clear</option>
              <option value="Brown">Brown</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Density (gm/CC)</label>
<input type="number" step="0.01" min="0" class="form-control" name="Density (gm/CC)" placeholder="≤ 0.89">
          </div>
          <div class="col-md-4">
            <label class="form-label">BDV with 2.5mm Gap (kV)</label>
<input type="number" step="0.1" min="0" class="form-control" name="BDV with 2.5mm Gap (kV)" placeholder="≥ 40">
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Acidity (mg of KOH/gm)</label>
<input type="number" step="0.01" min="0" class="form-control" name="Acidity (mg of KOH/gm)" placeholder="≤ 0.05">
          </div>
          <div class="col-md-4">
            <label class="form-label">Specific Resistance at 27 °C (ohm-cm)</label>
<div class="input-group">
  <input
    type="number"
    step="0.5"
    min="0"
    class="form-control"
    name="Specific Resistance at 27 °C (ohm-cm)"
    id="resistance27"
    placeholder="Base value e.g. 5.6">
  <span class="input-group-text">× 10¹²</span>
</div>

          </div>

          <div class="col-md-4">
            <label class="form-label">Specific Resistance at 90 °C (ohm-cm)</label>
            <input type="number" step="1" min="0" class="form-control" name="Specific Resistance at 90 °C (ohm-cm)">
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Dielectric Dissipation Factor (tan δ)</label>
<input type="number" step="0.0001" min="0" class="form-control" name="Dielectric Disssipation Factor (tan δ)" placeholder="≤ 0.015">
          </div>
          <div class="col-md-4">
            <label class="form-label">Moisture Content (PPM)</label>
<input type="number" step="1" min="0" class="form-control" name="Moisture Content (PPM)" placeholder="≤ 20">
          </div>
          <div class="col-md-4">
            <label class="form-label">IFT (mN/m)</label>
<input type="number" step="1" min="0" class="form-control" name="IFT (mN/m)" placeholder="≥ 40">
          </div>
        </div>

        <div class="mb-4">
<label class="form-label d-flex justify-content-between align-items-center">
  Observations
  <i class="fas fa-sync-alt text-primary" id="generateObservation" title="Regenerate Observation" style="cursor: pointer;"></i>
</label>
          <textarea class="form-control" name="Observations" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-paper-plane"></i> Submit Record
        </button>
      </form>
    </div>
  </div>

  <div class="modal fade" id="ptrModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title"><i class="fas fa-plus-square"></i> Add New PTR</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="ptrForm">
          <div class="modal-body row g-3 p-3">
            <div class="col-md-4">
              <label class="form-label">Region</label>
              <select name="Region" id="modalRegion" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Division</label>
              <select name="Division" id="modalDivision" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Substation</label>
              <select name="Substation" id="modalSubstation" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Equipment</label>
              <input name="Equipment" class="form-control" value="PTR" readonly>
            </div>

            <div class="col-md-4">
              <label class="form-label">Capacity (MVA)</label>
              <select name="Capacity (MVA)" class="form-select" required>
                <option value="">Select</option>
                <option value="3">3</option>
                <option value="6.3">6.3</option>
                <option value="10">10</option>
                <option value="20">20</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Make</label>
              <select name="Make" class="form-select" required>
                <option value="">Select</option>
                <option value="Marson's">Marson's</option>
                <option value="RTS Power">RTS Power</option>
                <option value="Toshiba">Toshiba</option>
                <option value="Vijai">Vijai</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Year of Manufacture</label>
              <select name="Year of Manufacture" id="yearDropdown" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Serial No.</label>
              <input type="text" name="Serial No." class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times-circle"></i> Cancel
            </button>
            <button type="submit" class="btn btn-success" id="addPtrBtn">
              <span class="btn-text"><i class="fas fa-save"></i> Add PTR</span>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmTestModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm Test Record Submission</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to submit this test record?</p>
          <div id="testRecordSummary" class="bg-light p-3 rounded small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="confirmTestSubmit">
            <span class="btn-text"><i class="fas fa-check"></i> Yes, Submit</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmPtrModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm PTR Addition</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to add this PTR?</p>
          <div id="ptrSummary" class="bg-light p-3 rounded small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-success" id="confirmPtrSubmit">
            <span class="btn-text"><i class="fas fa-check"></i> Yes, Add PTR</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Success!</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <i class="fas fa-check-circle text-success" style="font-size: 3.5rem;"></i>
          <p class="mt-3 fs-5" id="successMessage">Operation completed successfully!</p>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-primary d-none" id="addAnotherPtrBtn">
            <i class="fas fa-plus-square"></i> Add Another PTR
          </button>
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">
            <i class="fas fa-thumbs-up"></i> OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="duplicatePtrModal" tabindex="-1" aria-labelledby="duplicatePtrModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="duplicatePtrModalLabel"><i class="fas fa-exclamation-triangle"></i> Duplicate PTR Detected!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <i class="fas fa-exclamation-circle text-warning" style="font-size: 3.5rem;"></i>
          <p class="mt-3 fs-5">A PTR with the same details already exists in the list. Duplicate entry not allowed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-bs-dismiss="modal">
            <i class="fas fa-check"></i> OK
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const scriptUrl = 'https://script.google.com/macros/s/AKfycbxhEdt6LWidyEwq0VUoHv55vSXX1DyWbAHqEppFA1X59j43mlgfxS1NVhXNdz5KpVbe/exec';
let mapData = [], ptrData = [];
let pendingTestRecord = null;
let pendingPtrData = null;

// Utility functions for loading states
function setLoadingState(button, isLoading) {
  const btnText = button.querySelector('.btn-text');
  const spinner = button.querySelector('.spinner-border');
  
  if (isLoading) {
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');
    button.disabled = true;
  } else {
    btnText.classList.remove('d-none');
    spinner.classList.add('d-none');
    button.disabled = false;
  }
}

function showSuccessModal(message, showAddAnother = false) {
  document.getElementById('successMessage').textContent = message;

  const addBtn = document.getElementById('addAnotherPtrBtn');
  if (showAddAnother) {
    addBtn.classList.remove('d-none');
  } else {
    addBtn.classList.add('d-none');
  }

  new bootstrap.Modal(document.getElementById('successModal')).show();
}

document.getElementById('addAnotherPtrBtn').addEventListener('click', () => {
  const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
  successModal.hide();

  // Clear and reopen the PTR modal
  document.getElementById("ptrForm").reset();

  // If region/div/substation were already selected, prefill again
  document.getElementById("modalRegion").value = document.getElementById("region").value || '';
  
  // Trigger change events to populate dependent dropdowns in the modal
  const modalRegion = document.getElementById("modalRegion");
  if (modalRegion.value) modalRegion.dispatchEvent(new Event('change'));

  setTimeout(() => {
      const modalDivision = document.getElementById("modalDivision");
      modalDivision.value = document.getElementById("division").value || '';
      if (modalDivision.value) modalDivision.dispatchEvent(new Event('change'));

      setTimeout(() => {
          const modalSubstation = document.getElementById("modalSubstation");
          modalSubstation.value = document.getElementById("substation").value || '';
      }, 150); // Small delay to allow modalSubstation to populate
  }, 150); // Small delay to allow modalDivision to populate

  new bootstrap.Modal(document.getElementById("ptrModal")).show();
});

// Initial load
document.addEventListener("DOMContentLoaded", () => {
  fetchData();
  populateYearDropdown(); // ✅ Add this here
});


function fetchData() {
  fetch(scriptUrl + '?action=getInitialData')
    .then(res => res.json())
    .then(data => {
      mapData = data.map;
      ptrData = data.ptrs;
          testRecords = data.tests || [];  // ✅ Ensure you fetch this
      populateRegionDropdown();
      populatePTRDropdown();
      populateModalRegionDropdown(); // ← Important

    })
    .catch(err => console.error('Error fetching data:', err));
}

function populateRegionDropdown() {
  const regionSelect = document.getElementById("region");
  const divisionSelect = document.getElementById("division");
  const substationSelect = document.getElementById("substation");

  // Populate Region dropdown
  const regionSet = [...new Set(mapData.map(r => r.Region))];
  regionSelect.innerHTML = `<option value="">Select</option>` + regionSet.map(r => `<option>${r}</option>`).join("");

  // === Event Listeners (attach once globally) ===

  regionSelect.addEventListener("change", () => {
    const selectedRegion = regionSelect.value;

    // Populate Division
    const divisions = [...new Set(mapData.filter(e => e.Region === selectedRegion).map(e => e.Division))];
    divisionSelect.innerHTML = `<option value="">Select</option>` + divisions.map(d => `<option>${d}</option>`).join("");

    // Reset downstream
    substationSelect.innerHTML = `<option value="">Select</option>`;

    // Trigger PTR filtering
    populatePTRDropdown();
  });

  divisionSelect.addEventListener("change", () => {
    const selectedRegion = regionSelect.value;
    const selectedDivision = divisionSelect.value;

    // Populate Substation
    const substations = [...new Set(mapData
      .filter(e => e.Region === selectedRegion && e.Division === selectedDivision)
      .map(e => e.Substation))];
    substationSelect.innerHTML = `<option value="">Select</option>` + substations.map(s => `<option>${s}</option>`).join("");

    // Trigger PTR filtering
    populatePTRDropdown();
  });

  substationSelect.addEventListener("change", () => {
    populatePTRDropdown();
  });
}


function populateModalRegionDropdown() {
  const modalRegionSelect = document.getElementById("modalRegion");
  modalRegionSelect.innerHTML = `<option value="">Select</option>` + [...new Set(mapData.map(e => e.Region))]
    .map(r => `<option value="${r}">${r}</option>`).join("");

  modalRegionSelect.onchange = () => {
    const selectedRegion = modalRegionSelect.value;
    const divisions = [...new Set(mapData.filter(e => e.Region === selectedRegion).map(e => e.Division))];
    const modalDivisionSelect = document.getElementById("modalDivision");
    modalDivisionSelect.innerHTML = `<option value="">Select</option>` + divisions.map(d => `<option value="${d}">${d}</option>`).join("");

    document.getElementById("modalSubstation").innerHTML = `<option value="">Select</option>`;

    modalDivisionSelect.onchange = () => {
      const selectedDivision = modalDivisionSelect.value;
      const substations = [...new Set(mapData.filter(e => e.Division === selectedDivision).map(e => e.Substation))];
      const modalSubstationSelect = document.getElementById("modalSubstation");
      modalSubstationSelect.innerHTML = `<option value="">Select</option>` + substations.map(s => `<option value="${s}">${s}</option>`).join("");
    };
  };
}

function populatePTRDropdown() {
  const region = document.getElementById("region").value;
  const division = document.getElementById("division").value;
  const substation = document.getElementById("substation").value;
  const ptrSelect = document.getElementById("ptrSelect");

  let filteredPTRs = ptrData;

  if (region) {
    filteredPTRs = filteredPTRs.filter(p => p.Region === region);
  }
  if (division) {
    filteredPTRs = filteredPTRs.filter(p => p.Division === division);
  }
  if (substation) {
    filteredPTRs = filteredPTRs.filter(p => p.Substation === substation);
  }

  ptrSelect.innerHTML = `<option value="">Select</option>` + filteredPTRs.map(p =>
    `<option value="${p['Serial No.']}">${p['Equipment']} | ${p['Make']} | ${p['Capacity (MVA)']} | ${p['Serial No.']} | ${p['Year of Manufacture']}</option>`
  ).join("");
}



function populateYearDropdown() {
  const yearSelect = document.getElementById("yearDropdown");
  const currentYear = new Date().getFullYear();
  let options = `<option value="">Select</option>`;
  for (let y = currentYear; y >= 1990; y--) {
    options += `<option value="${y}">${y}</option>`;
  }
  yearSelect.innerHTML = options;
}


function showPTRModal() {
  // Reset modal form first to ensure clean state
  document.getElementById("ptrForm").reset();

  // Call population function
  populateModalRegionDropdown();

  // Pre-fill selected values
  const region = document.getElementById("region").value;
  const division = document.getElementById("division").value;
  const substation = document.getElementById("substation").value;

  // Prefill and trigger change events with a slight delay for dropdown propagation
  setTimeout(() => {
    const modalRegion = document.getElementById("modalRegion");
    modalRegion.value = region;
    // Only dispatch event if a region was actually selected to avoid unnecessary calls
    if (region) modalRegion.dispatchEvent(new Event('change'));

    setTimeout(() => {
      const modalDivision = document.getElementById("modalDivision");
      modalDivision.value = division;
      // Only dispatch event if a division was actually selected
      if (division) modalDivision.dispatchEvent(new Event('change'));

      setTimeout(() => {
        const modalSubstation = document.getElementById("modalSubstation");
        modalSubstation.value = substation;
      }, 150); // Small delay to allow modalSubstation to populate
    }, 150); // Small delay to allow modalDivision to populate
  }, 150); // Initial delay to ensure modal is ready

  new bootstrap.Modal(document.getElementById("ptrModal")).show();
}


// Submit test form
document.getElementById("testForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  
  // Get form data
  const formData = new FormData(form);
const record = Object.fromEntries(formData.entries());

// Convert 27°C resistance to actual value in ohm-cm × 10¹²
const sr27 = parseFloat(record['Specific Resistance at 27 °C (ohm-cm)']);
if (!isNaN(sr27)) {
  record['Specific Resistance at 27 °C (ohm-cm)'] = sr27 * 1e12;
}

  // Add selected dropdown values
  record.Region = document.getElementById("region").value;
  record.Division = document.getElementById("division").value;
  record.Substation = document.getElementById("substation").value;

  // Add PTR details - ensure all PTR fields are included
const ptrSerial = document.getElementById("ptrSelect").value.trim();
const ptrDetails = ptrData.find(p => String(p['Serial No.']).trim() === ptrSerial);

  if (ptrDetails) {
    // Explicitly add each PTR field to ensure they're included
    record.Equipment = ptrDetails.Equipment || '';
    record['Capacity (MVA)'] = ptrDetails['Capacity (MVA)'] || '';
    record.Make = ptrDetails.Make || '';
    record['Serial No.'] = ptrDetails['Serial No.'] || '';
    record['Year of Manufacture'] = ptrDetails['Year of Manufacture'] || '';
    
    // Also copy any other PTR fields that might exist
    Object.keys(ptrDetails).forEach(key => {
      if (!record.hasOwnProperty(key)) {
        record[key] = ptrDetails[key];
      }
    });
  }

  console.log('Test Record Data:', record); // Debug log to verify data

  // Store pending record and show confirmation
  function colorize(param, value, goodIf) {
  const number = parseFloat(value);
  if (isNaN(number)) return `<span>${value || 'N/A'}</span>`;

  let isGood = false;
  if (goodIf === "max") isGood = number <= param;
  if (goodIf === "min") isGood = number >= param;

  const color = isGood ? "green" : "red";
  return `<span style="color:${color}; font-weight: 500">${number}</span>`;
}

  pendingTestRecord = record;
  
  // Create summary for confirmation
const summary = `
  <strong>Region:</strong> ${record.Region}<br>
  <strong>Division:</strong> ${record.Division}<br>
  <strong>Substation:</strong> ${record.Substation}<br>
  <strong>Equipment:</strong> ${record.Equipment || 'N/A'}<br>
  <strong>Capacity (MVA):</strong> ${record['Capacity (MVA)'] || 'N/A'}<br>
  <strong>Make:</strong> ${record.Make || 'N/A'}<br>
  <strong>Serial No.:</strong> ${record['Serial No.'] || 'N/A'}<br>
  <strong>Year of Manufacture:</strong> ${record['Year of Manufacture'] || 'N/A'}<br>
  <strong>Sample Collection Date:</strong> ${record['Sample Collection Date'] || 'N/A'}<br>
  <strong>Sample Testing Date:</strong> ${record['Sample Testing Date'] || 'N/A'}<br>
  <strong>Sample Collected By:</strong> ${record['Sample Collected By'] || 'N/A'}<br>
  <strong>Source Referance:</strong> ${record['Source Referance'] || 'N/A'}<br>
  <strong>Testing Referance:</strong> ${record['Testing Referance'] || 'N/A'}<br>
  <strong>Oil Sample Position:</strong> ${record['Oil Sample Position'] || 'N/A'}<br>
  <strong>Physical Appearance:</strong> ${record['Physical Appearance'] || 'N/A'}<br>
  <strong>Density (gm/CC):</strong> ${colorize(0.89, record['Density (gm/CC)'], 'max')}<br>
  <strong>BDV with 2.5mm Gap (kV):</strong> ${colorize(40, record['BDV with 2.5mm Gap (kV)'], 'min')}<br>
  <strong>Acidity (mg of KOH/gm):</strong> ${colorize(0.05, record['Acidity (mg of KOH/gm)'], 'max')}<br>
<strong>Specific Resistance at 27 °C (ohm-cm):</strong> ${
  record['Specific Resistance at 27 °C (ohm-cm)']
    ? (record['Specific Resistance at 27 °C (ohm-cm)'] / 1e12).toFixed(4) + ' × 10¹²'
    : 'N/A'
}<br>
  <strong>Specific Resistance at 90 °C (ohm-cm):</strong> ${colorize(6e12, record['Specific Resistance at 90 °C (ohm-cm)'], 'min')}<br>
  <strong>Dielectric Dissipation Factor (tan δ):</strong> ${colorize(0.015, record['Dielectric Disssipation Factor (tan δ)'], 'max')}<br>
  <strong>Moisture Content (PPM):</strong> ${colorize(20, record['Moisture Content (PPM)'], 'max')}<br>
  <strong>IFT (mN/m):</strong> ${colorize(40, record['IFT (mN/m)'], 'min')}<br>
  <strong>Observations:</strong> ${record['Observations'] || 'N/A'}<br>
`;

  
  document.getElementById('testRecordSummary').innerHTML = summary;
  new bootstrap.Modal(document.getElementById('confirmTestModal')).show();
});

// Confirm test record submission
document.getElementById("confirmTestSubmit").addEventListener("click", function () {
  const button = this;
  setLoadingState(button, true);
  
  // Submit to Google Apps Script
  fetch(scriptUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=submitTestRecord&${new URLSearchParams({data: JSON.stringify(pendingTestRecord)}).toString()}`
  })
  .then(res => res.json())
  .then(result => {
    setLoadingState(button, false);
    bootstrap.Modal.getInstance(document.getElementById('confirmTestModal')).hide();
    
    // Reset form
    document.getElementById("testForm").reset();
    document.getElementById("region").value = "";
    document.getElementById("division").innerHTML = `<option value="">Select</option>`;
    document.getElementById("substation").innerHTML = `<option value="">Select</option>`;
    document.getElementById("ptrSelect").value = "";
    
    showSuccessModal("Test Record Submitted Successfully!");
    pendingTestRecord = null;
  })
  .catch(err => {
    setLoadingState(button, false);
    console.error('Error submitting test record:', err);
    alert("Error submitting record. Please try again.");
  });
});

// Submit PTR modal form - CLIENT-SIDE DUPLICATE CHECK
document.getElementById("ptrForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  // Always force Equipment = PTR
  data.Equipment = "PTR";

  // Define fields for comparison and their expected type for normalization
  const fieldsToCompare = [
    { name: "Region", type: "string" },
    { name: "Division", type: "string" },
    { name: "Substation", type: "string" },
    { name: "Equipment", type: "string" },
    { name: "Capacity (MVA)", type: "numeric" }, // Treated as numeric, string comparison after trim
    { name: "Make", type: "string" },
    { name: "Serial No.", type: "string" },     // Serial number can contain letters/special chars
    { name: "Year of Manufacture", type: "numeric" } // Treated as numeric, string comparison after trim
  ];

  const duplicate = ptrData.find(p => {
    return fieldsToCompare.every(fieldDef => {
      const fieldName = fieldDef.name;
      
      // Get values from existing PTR (p) and new data (data)
      // Convert to string and trim any whitespace from both sides
      let pValue = String(p[fieldName] || '').trim();
      let dataValue = String(data[fieldName] || '').trim();

      // Apply toLowerCase for string fields only, to ensure case-insensitivity
      if (fieldDef.type === "string") {
        pValue = pValue.toLowerCase();
        dataValue = dataValue.toLowerCase();
      }
      // For numeric types, we rely on String().trim() to normalize values
      // (e.g., '3' vs '3.0' might become '3' for both after trimming)

      return pValue === dataValue;
    });
  });

  if (duplicate) {
    // Show duplicate PTR modal
    new bootstrap.Modal(document.getElementById('duplicatePtrModal')).show();
    return;
  }

  // Store pending data and show confirmation
  pendingPtrData = data;

  // Create summary for confirmation
  const summary = `
    <strong>Region:</strong> ${data.Region}<br>
    <strong>Division:</strong> ${data.Division}<br>
    <strong>Substation:</strong> ${data.Substation}<br>
    <strong>Equipment:</strong> ${data.Equipment}<br>
    <strong>Capacity (MVA):</strong> ${data['Capacity (MVA)'] || 'N/A'}<br>
    <strong>Make:</strong> ${data.Make || 'N/A'}<br>
    <strong>Serial No.:</strong> ${data['Serial No.']}<br>
    <strong>Year of Manufacture:</strong> ${data['Year of Manufacture'] || 'N/A'}
  `;

  document.getElementById('ptrSummary').innerHTML = summary;

  bootstrap.Modal.getInstance(document.getElementById('ptrModal')).hide();
  new bootstrap.Modal(document.getElementById('confirmPtrModal')).show();
});


// Confirm PTR submission
document.getElementById("confirmPtrSubmit").addEventListener("click", function () {
  const button = this;
  setLoadingState(button, true);
  
  // Submit PTR to Google Apps Script
  fetch(scriptUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=addPTR&${new URLSearchParams({data: JSON.stringify(pendingPtrData)}).toString()}`
  })
  .then(res => res.json())
  .then(result => {
    setLoadingState(button, false);
    bootstrap.Modal.getInstance(document.getElementById('confirmPtrModal')).hide();
    
    // Handle server response for duplicate
    if (result.status === "error" && result.message === "PTR Already exists in the list!") {
        new bootstrap.Modal(document.getElementById('duplicatePtrModal')).show();
        // Re-open PTR modal if needed for user to correct, or just let them retry
        new bootstrap.Modal(document.getElementById("ptrModal")).show(); 
        pendingPtrData = null; // Clear pending data
        return; 
    }

    // Reset PTR form
    document.getElementById("ptrForm").reset();
    
    // Refresh data to include new PTR
    fetchData(); // This also calls populatePTRDropdown()
    populateYearDropdown(); 
    
    showSuccessModal("PTR Added Successfully!", true);
    pendingPtrData = null;
  })
  .catch(err => {
    setLoadingState(button, false);
    console.error('Error adding PTR:', err);
    alert("Error adding PTR. Please try again.");
  });
});


document.addEventListener("DOMContentLoaded", () => {
  const collectionInput = document.getElementById("sampleCollectionDate");
  const testingInput = document.getElementById("sampleTestingDate");

  collectionInput.addEventListener("change", () => {
    if (collectionInput.value) {
      testingInput.min = collectionInput.value;
      if (testingInput.value && testingInput.value < collectionInput.value) {
        testingInput.value = "";
      }
    }
  });

  testingInput.addEventListener("change", () => {
    if (collectionInput.value && testingInput.value < collectionInput.value) {
      alert("Sample Testing Date must be after Sample Collection Date.");
      testingInput.value = "";
    }
  });
});
document.addEventListener("input", function (e) {
  if (e.target.type === "number" && parseFloat(e.target.value) < 0) {
    e.target.value = "";
  }
});
document.getElementById("generateObservation").addEventListener("click", () => {
  const getVal = (name) => {
    const val = parseFloat(document.querySelector(`[name="${name}"]`)?.value);
    return isNaN(val) ? null : val;
  };

  const fields = [
    "Density (gm/CC)",
    "BDV with 2.5mm Gap (kV)",
    "Acidity (mg of KOH/gm)",
    "Specific Resistance at 27 °C (ohm-cm)",
    "Specific Resistance at 90 °C (ohm-cm)",
    "Dielectric Disssipation Factor (tan δ)",
    "Moisture Content (PPM)",
    "IFT (mN/m)"
  ];

  // Check if any values are filled
  const allEmpty = fields.every(name => !document.querySelector(`[name="${name}"]`)?.value);

  const box = document.querySelector('[name="Observations"]');

  if (allEmpty) {
    box.value = "Please update the data to generate observation.";
    return;
  }

  const observations = [];

  const check = (label, value, threshold, type) => {
    if (value === null) return;

    if (type === "min" && value < threshold) {
      observations.push(`Value of ${label} is below the standard limit.`);
    } else if (type === "max" && value > threshold) {
      observations.push(`Value of ${label} exceeds the standard limit.`);
    }
  };

  // Threshold checks
  check("Density (gm/CC)", getVal("Density (gm/CC)"), 0.89, "max");
  check("BDV with 2.5mm Gap (kV)", getVal("BDV with 2.5mm Gap (kV)"), 40, "min");
  check("Acidity (mg of KOH/gm)", getVal("Acidity (mg of KOH/gm)"), 0.05, "max");

  const sr27 = getVal("Specific Resistance at 27 °C (ohm-cm)");
  if (sr27 !== null && sr27 * 1e12 < 6e12) {
    observations.push("Value of Specific Resistance at 27 °C (ohm-cm) is below the standard limit.");
  }

  check("Specific Resistance at 90 °C (ohm-cm)", getVal("Specific Resistance at 90 °C (ohm-cm)"), 6e12, "min");
  check("Dielectric Disssipation Factor (tan δ)", getVal("Dielectric Disssipation Factor (tan δ)"), 0.015, "max");
  check("Moisture Content (PPM)", getVal("Moisture Content (PPM)"), 20, "max");
  check("IFT (mN/m)", getVal("IFT (mN/m)"), 40, "min");

  // Update the observation field
  box.value = observations.length
    ? observations.join('\n')
    : "All parameters are within standard limits.";
});

document.getElementById("alertButton").addEventListener("click", () => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtpueyQwlq63VP2Tm2_vITV31jKBSceDGJQVJtYeqVVDBSg3QAHzLKrv60i6Z9oODXXzOE-fdfMb8b/pub?gid=906452022&single=true&output=csv";

  fetch(csvUrl)
    .then(res => res.text())
    .then(csv => {
      const lines = csv.split("\n");
      const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ''));
      const threshold = new Date();
      threshold.setMonth(threshold.getMonth() - 3);

      const outdated = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",").map(c => c.trim().replace(/"/g, ''));
        if (cols.length !== headers.length) continue;

        const record = Object.fromEntries(headers.map((h, j) => [h, cols[j]]));

        const dateStr = record["Sample Testing Date"];
        if (!dateStr) continue;

        // Try to parse DD/MM/YYYY format
        let testDate = null;
        if (dateStr.includes("/")) {
          const [dd, mm, yyyy] = dateStr.split("/").map(Number);
          if (yyyy && mm && dd) testDate = new Date(yyyy, mm - 1, dd);
        } else if (dateStr.includes("-")) {
          testDate = new Date(dateStr);
        }

        if (!testDate || isNaN(testDate)) continue;

        if (testDate < threshold) {
          outdated.push({
            Substation: record.Substation,
            Division: record.Division,
            Date: dateStr
          });
        }
      }

      const list = document.getElementById("outdatedList");
      list.innerHTML = "";

      if (outdated.length === 0) {
        list.innerHTML = `<li class="list-group-item text-success">All records are within 3 months.</li>`;
      } else {
        outdated.forEach(entry => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `${entry.Substation} (${entry.Division}) – Tested on ${entry.Date}`;
          list.appendChild(li);
        });
      }

      new bootstrap.Modal(document.getElementById("outdatedModal")).show();
    })
    .catch(err => {
      console.error("CSV fetch failed:", err);
      alert("Failed to fetch outdated records.");
    });
});





</script>
<div class="modal fade" id="outdatedModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Testing schedule execeded</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul id="outdatedList" class="list-group small"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
