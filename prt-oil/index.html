<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PTR Oil Testing Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    :root {
      /* Define a minimal color palette as CSS variables */
      --primary-color: #316ac5; /* Deeper blue, closer to image title bar */
      --secondary-color: #a0a0a0; /* Muted gray for secondary elements/borders */
      --success-color: #5cb85c; /* Standard success green (can be slightly desaturated if needed) */
      --warning-color: #f0ad4e; /* Standard warning orange */
      --info-color: #5bc0de;   /* Standard info light blue */
      --background-light: #ece9d8; /* Light gray-beige for outer background, typical Windows classic */
      --content-bg: #e5e5e5; /* Slightly darker gray for content areas */
      --text-dark: #000000;      /* Black text */
      --text-muted: #6c757d;    /* Muted text - can be made darker if needed */
      --border-light: #808080;   /* Gray border for forms/cards */
      --shadow-light: rgba(0, 0, 0, 0.2); /* Stronger, sharper shadow for embossed look */
      --highlight-border: #ffffff; /* White highlight for beveled effect */
      --inset-shadow: inset 1px 1px 2px rgba(0,0,0,0.4); /* Inset shadow for sunken look */
      --raised-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light); /* Raised effect */
      --tab-active-bg: #ffffff;
    }

    body {
      font-family: 'Tahoma', 'MS Sans Serif', 'Segoe UI', 'Poppins', sans-serif; /* Prioritize system fonts */
      background-color: var(--background-light);
      color: var(--text-dark);
      font-size: 0.9rem; /* Slightly smaller font size */
    }
    .container {
      background-color: var(--content-bg); /* Gray background for the main container */
      padding: 20px; /* Reduced padding */
      border-radius: 0; /* Sharp corners */
      border: 1px solid var(--border-light);
      box-shadow: 0 0 0 1px var(--highlight-border), 2px 2px 5px var(--shadow-light); /* Mimic a raised dialog */
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 900px; /* Adjust max width for a more compact dialog feel */
    }
    h3 {
      font-weight: 700; /* Bolder for titles */
      color: var(--text-dark);
      margin-bottom: 20px; /* Reduced margin */
      text-align: left; /* Align left as in the image's title */
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-light); /* Separator line */
      background-color: var(--primary-color);
      color: #fff;
      padding: 8px 15px;
      margin-left: -20px; /* Extend full width of container, considering padding */
      margin-right: -20px; /* Extend full width of container, considering padding */
      margin-top: -20px; /* Align to top of container */
      border-radius: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2rem;
    }

    /* Card styling to mimic sections of the vintage UI */
    .card {
      border: 1px solid var(--border-light);
      border-radius: 0; /* Sharp corners */
      box-shadow: none; /* No extra shadow on cards */
      background-color: var(--content-bg); /* Card body matches container */
    }
    .card-header {
      border-bottom: 1px solid var(--border-light);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      font-weight: 600;
      font-size: 1rem; /* Slightly smaller header font */
      padding: 8px 15px; /* Reduced padding */
      background-color: #c0c0c0; /* Gray header for card, similar to the image's grouping areas */
      color: var(--text-dark);
      border-bottom: 1px solid var(--border-light);
      border-top: 1px solid var(--highlight-border); /* Top highlight */
      position: relative; /* For the "sunken" effect */
      box-shadow: var(--inset-shadow); /* Sunken effect */
    }
    .card-header.bg-primary {
      background-color: var(--primary-color) !important;
      color: #fff !important;
      box-shadow: none !important; /* Primary header doesn't need inset */
    }
    .card-header.bg-info { background-color: var(--info-color) !important; }
    .card-header.bg-success { background-color: var(--success-color) !important; }
    .card-header.bg-warning { background-color: var(--warning-color) !important; }

    /* Form elements */
    .form-select, .form-control {
      border-radius: 0; /* Sharp corners */
      padding: 6px 10px; /* Reduced padding */
      border: 1px solid var(--border-light);
      color: var(--text-dark);
      background-color: #ffffff; /* White background for inputs */
      box-shadow: var(--inset-shadow); /* Sunken effect for inputs */
    }
    .form-select:focus, .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: var(--inset-shadow), 0 0 0 0.15rem rgba(49, 106, 197, 0.25); /* Focus with primary color outline */
    }
    .form-label {
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: 4px; /* Reduced margin */
    }
    .input-group-text {
      border-radius: 0;
      background-color: #e0e0e0; /* Gray background for add-ons */
      border: 1px solid var(--border-light);
      box-shadow: var(--inset-shadow); /* Sunken effect */
    }

    /* Buttons */
    .btn {
      border-radius: 0; /* Sharp corners */
      padding: 6px 15px; /* Adjusted padding */
      font-weight: 600; /* Bolder text */
      transition: none; /* Disable smooth transitions for vintage feel */
      border: 1px solid var(--border-light);
      background-image: linear-gradient(to bottom, #f0f0f0, #c0c0c0); /* Simple gradient */
      color: var(--text-dark);
      box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light); /* Raised effect */
    }
    .btn:hover {
      background-image: linear-gradient(to bottom, #c0c0c0, #f0f0f0); /* Inverted gradient on hover */
      box-shadow: none; /* No shadow on hover for a "pressed" look */
      transform: translate(1px, 1px); /* Slight movement to simulate pressing */
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: #fff;
      background-image: linear-gradient(to bottom, var(--primary-color), #214f9d); /* Blue gradient */
      box-shadow: 1px 1px 0px rgba(255,255,255,0.3), 2px 2px 0px var(--primary-color); /* Primary specific shadow */
    }
    .btn-primary:hover {
      background-image: linear-gradient(to bottom, #214f9d, var(--primary-color));
      border-color: var(--primary-color);
    }
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
      color: #fff;
      background-image: linear-gradient(to bottom, var(--success-color), #4cae4c);
      box-shadow: 1px 1px 0px rgba(255,255,255,0.3), 2px 2px 0px var(--success-color);
    }
    .btn-success:hover {
      background-color: #4cae4c;
      border-color: #4cae4c;
      background-image: linear-gradient(to bottom, #4cae4c, var(--success-color));
    }
    .btn-warning {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: var(--text-dark); /* Darker text for warning button */
      background-image: linear-gradient(to bottom, var(--warning-color), #e39a2f);
      box-shadow: 1px 1px 0px rgba(255,255,255,0.5), 2px 2px 0px var(--warning-color);
    }
    .btn-warning:hover {
      background-color: #e39a2f;
      border-color: #e39a2f;
      background-image: linear-gradient(to bottom, #e39a2f, var(--warning-color));
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: var(--text-dark);
      background-image: linear-gradient(to bottom, #d0d0d0, #a0a0a0);
      box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light);
    }
    .btn-secondary:hover {
      background-color: #5a6268;
      border-color: #545b62;
      background-image: linear-gradient(to bottom, #a0a0a0, #d0d0d0);
    }
    .btn-outline-primary {
      color: var(--primary-color);
      border-color: var(--primary-color);
      background-image: none; /* No gradient for outline */
      box-shadow: var(--raised-shadow); /* Raised effect */
    }
    .btn-outline-primary:hover {
      background-color: var(--primary-color);
      color: #fff;
      background-image: linear-gradient(to bottom, var(--primary-color), #214f9d);
    }


    /* Modal styles */
    .modal-content {
      border-radius: 0; /* Sharp corners */
      box-shadow: 0 0 0 1px var(--highlight-border), 4px 4px 10px var(--shadow-light); /* Stronger shadow for dialog */
      border: 1px solid var(--border-light);
    }
    .modal-header {
      border-bottom: 1px solid var(--border-light);
      padding: 10px 15px; /* Reduced padding */
      position: relative;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      background-color: var(--primary-color); /* Blue header */
      color: #fff;
      background-image: linear-gradient(to right, var(--primary-color), #214f9d); /* Gradient for modal header */
      cursor: move; /* Indicate draggable */
    }
    .modal-header .btn-close {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      opacity: 1;
      background: transparent; /* Remove default Bootstrap background */
      border: 1px solid #fff; /* White border for the close button */
      border-radius: 0;
      padding: 2px 5px;
      font-size: 0.8rem;
      line-height: 1;
      text-shadow: none;
    }
    .modal-header .btn-close:hover {
      background-color: #c0c0c0; /* Gray background on hover */
      color: var(--text-dark);
    }

    .modal-title {
      font-weight: 700;
      font-size: 1.1rem; /* Slightly smaller title font */
      color: #fff;
      display: flex;
      align-items: center;
    }
    .modal-title .fas {
        margin-right: 8px; /* Reduced margin */
    }
    .modal-body {
      padding: 15px; /* Reduced padding */
      font-size: 0.9rem; /* Slightly smaller body font */
      background-color: var(--content-bg);
    }
    .modal-footer {
      border-top: 1px solid var(--border-light);
      padding: 10px 15px; /* Reduced padding */
      background-color: var(--content-bg);
    }
    .form-text {
      font-size: 0.8em; /* Smaller helper text */
      color: var(--text-muted);
      margin-top: 3px; /* Reduced margin */
    }
    .form-text a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }
    .form-text a:hover {
      text-decoration: underline;
    }
    .spinner-border {
      margin-left: 5px;
    }
    /* Icons in modals */
    .modal-body .fas {
      font-size: 3rem; /* Slightly smaller icons for status modals */
      margin-bottom: 10px;
    }
    /* Summary text in modals */
    #testRecordSummary, #ptrSummary {
      border: 1px solid var(--border-light);
      padding: 10px;
      font-size: 0.8rem; /* Smaller summary text */
      background-color: #ffffff; /* White background for summaries */
      color: var(--text-dark);
      box-shadow: var(--inset-shadow); /* Sunken effect */
    }

    /* Adjust specific elements for a more vintage feel */
    #generateObservation {
      color: var(--primary-color);
      cursor: pointer;
      font-size: 1.2rem;
      border: 1px solid transparent; /* Mimic a hoverable icon button */
      padding: 3px;
      border-radius: 0;
    }
    #generateObservation:hover {
      background-color: #d0d0d0;
      border-color: var(--border-light);
      transform: none; /* Disable rotation */
    }

    #alertButton {
      background-color: #c0c0c0; /* Gray button */
      color: var(--text-dark);
      border-color: var(--border-light);
      font-size: 0.8rem; /* Smaller button */
      padding: 4px 8px;
      box-shadow: var(--raised-shadow);
    }
    #alertButton:hover {
      background-color: #a0a0a0;
      box-shadow: none;
      transform: translate(1px, 1px);
    }

    /* Specific adjustments for select elements to match the image */
    select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); /* Custom arrow for select */
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem 1rem;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Tab specific styling */
    .nav-tabs {
      border-bottom: none; /* Remove default Bootstrap bottom border */
      margin-bottom: 0;
      padding-left: 5px; /* Align tabs */
    }
    .nav-tabs .nav-item {
      margin-bottom: -1px; /* Overlap with content border */
    }
    .nav-tabs .nav-link {
      border: 1px solid var(--border-light);
      border-bottom: none; /* No bottom border for tabs */
      border-radius: 0; /* Sharp corners */
      background-color: #d0d0d0; /* Muted tab background */
      color: var(--text-dark);
      padding: 8px 15px;
      font-weight: 600;
      box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light); /* Raised effect */
      margin-right: 3px; /* Space between tabs */
      position: relative;
      top: 1px; /* Visual alignment */
    }
    .nav-tabs .nav-link:hover {
      background-color: #c0c0c0; /* Darker on hover */
      border-color: var(--border-light);
      box-shadow: none;
      transform: translate(1px, 1px);
    }
    .nav-tabs .nav-link.active {
      background-color: var(--content-bg); /* Active tab matches content background */
      border-bottom-color: var(--content-bg); /* Hide bottom border to merge with content */
      box-shadow: var(--inset-shadow); /* Inset shadow for active tab */
      top: 0; /* Align active tab to top */
      z-index: 1; /* Ensure it's above the content border */
    }

    .tab-content {
      border: 1px solid var(--border-light);
      border-top: 1px solid var(--highlight-border); /* Top highlight for content area */
      padding: 15px;
      background-color: var(--content-bg);
      box-shadow: var(--inset-shadow); /* Sunken effect for content area */
      min-height: 400px; /* Ensure content area has a minimum height */
    }

    /* Table styling for reports */
    .table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border-light);
      font-size: 0.85rem;
    }
    .table th, .table td {
      border: 1px solid var(--border-light);
      padding: 8px;
      text-align: left;
    }
    .table thead th {
      background-color: #c0c0c0; /* Header background */
      font-weight: 600;
      color: var(--text-dark);
      border-top: 1px solid var(--highlight-border);
      box-shadow: var(--inset-shadow);
    }
    .table tbody tr:nth-child(even) {
      background-color: #e0e0e0; /* Alternate row color */
    }
    .table tbody tr:hover {
      background-color: #d0d0d0; /* Hover effect */
    }
  </style>
</head>
<body class="p-4">

<div class="container">
<h3 class="mb-4 d-flex justify-content-between align-items-center">
  PTR Oil Testing Reports
  <button id="alertButton" class="btn btn-sm" title="Show outdated testing records">
    <i class="fas fa-exclamation-triangle"></i>
  </button>
</h3>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation" id="new-record-tab-item">
      <button class="nav-link active" id="new-record-tab" data-bs-toggle="tab" data-bs-target="#new-record" type="button" role="tab" aria-controls="new-record" aria-selected="true">
        <i class="fas fa-file-alt"></i> New Test Record
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="view-reports-tab" data-bs-toggle="tab" data-bs-target="#view-reports" type="button" role="tab" aria-controls="view-reports" aria-selected="false">
        <i class="fas fa-chart-bar"></i> View Reports
      </button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="new-record" role="tabpanel" aria-labelledby="new-record-tab">
      <form id="testForm">
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Region</label>
            <select class="form-select" id="region" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Division</label>
            <select class="form-select" id="division" required></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Substation</label>
            <select class="form-select" id="substation" required></select>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-12">
            <label class="form-label">PTR (Equipment Info)</label>
            <select class="form-select" id="ptrSelect" required></select>
            <div class="form-text">
              Can't find PTR? <a href="#" onclick="showPTRModal()"><i class="fas fa-plus-circle"></i> Add New</a>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Sample Collection Date</label>
            <input type="date" class="form-control" name="Sample Collection Date" id="sampleCollectionDate" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sample Testing Date</label>
            <input type="date" class="form-control" name="Sample Testing Date" id="sampleTestingDate" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Sample Collected By</label>
            <input type="text" class="form-control" name="Sample Collected By">
          </div>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Source Reference</label>
            <input type="text" class="form-control" name="Source Referance">
          </div>
          <div class="col-md-4">
            <label class="form-label">Testing Reference</label>
            <input type="text" class="form-control" name="Testing Referance">
          </div>
          <div class="col-md-4">
            <label class="form-label">Oil Sample Position</label>
            <select class="form-select" name="Oil Sample Position" required>
              <option value="">Select</option>
              <option value="Top">Top</option>
              <option value="Bottom">Bottom</option>
              <option value="OLTC">OLTC</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Physical Appearance</label>
            <select class="form-select" name="Physical Appearance" required>
              <option value="">Select</option>
              <option value="Pale Yellow">Pale Yellow</option>
              <option value="Clear">Clear</option>
              <option value="Brown">Brown</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Density (gm/CC)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="Density (gm/CC)" placeholder="≤ 0.89">
          </div>
          <div class="col-md-4">
            <label class="form-label">BDV with 2.5mm Gap (kV)</label>
            <input type="number" step="0.1" min="0" class="form-control" name="BDV with 2.5mm Gap (kV)" placeholder="≥ 40">
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Acidity (mg of KOH/gm)</label>
            <input type="number" step="0.01" min="0" class="form-control" name="Acidity (mg of KOH/gm)" placeholder="≤ 0.05">
          </div>
          <div class="col-md-4">
            <label class="form-label">Specific Resistance at 27 °C (ohm-cm)</label>
            <div class="input-group">
              <input
                type="number"
                step="0.5"
                min="0"
                class="form-control"
                name="Specific Resistance at 27 °C (ohm-cm)"
                id="resistance27"
                placeholder="Base value e.g. 5.6">
              <span class="input-group-text">× 10¹²</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Specific Resistance at 90 °C (ohm-cm)</label>
            <div class="input-group">
              <input
                type="number"
                step="0.5"
                min="0"
                class="form-control"
                name="Specific Resistance at 90 °C (ohm-cm)"
                id="resistance90"
                placeholder="Base value e.g. 5.6">
              <span class="input-group-text">× 10¹²</span>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Dielectric Dissipation Factor (tan δ)</label>
            <input type="number" step="0.0001" min="0" class="form-control" name="Dielectric Disssipation Factor (tan δ)" placeholder="≤ 0.015">
          </div>
          <div class="col-md-4">
            <label class="form-label">Moisture Content (PPM)</label>
            <input type="number" step="1" min="0" class="form-control" name="Moisture Content (PPM)" placeholder="≤ 20">
          </div>
          <div class="col-md-4">
            <label class="form-label">IFT (mN/m)</label>
            <input type="number" step="1" min="0" class="form-control" name="IFT (mN/m)" placeholder="≥ 40">
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label d-flex justify-content-between align-items-center">
            Observations
            <i class="fas fa-sync-alt text-primary" id="generateObservation" title="Regenerate Observation" style="cursor: pointer;"></i>
          </label>
          <textarea class="form-control" name="Observations" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-paper-plane"></i> Submit Record
        </button>
      </form>
    </div>

    <div class="tab-pane fade" id="view-reports" role="tabpanel" aria-labelledby="view-reports-tab">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Substation</th>
              <th>Equipment</th>
              <th>Capacity (MVA)</th>
              <th>Sample Testing Date</th>
              <th>Observations</th>
            </tr>
          </thead>
          <tbody id="reportsTableBody">
            <tr><td colspan="5" class="text-center">Loading reports...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="ptrModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title"><i class="fas fa-plus-square"></i> Add New PTR</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="ptrForm">
          <div class="modal-body row g-3 p-3">
            <div class="col-md-4">
              <label class="form-label">Region</label>
              <select name="Region" id="modalRegion" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Division</label>
              <select name="Division" id="modalDivision" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Substation</label>
              <select name="Substation" id="modalSubstation" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Equipment</label>
              <input name="Equipment" class="form-control" value="PTR" readonly>
            </div>

            <div class="col-md-4">
              <label class="form-label">Capacity (MVA)</label>
              <select name="Capacity (MVA)" class="form-select" required>
                <option value="">Select</option>
                <option value="3">3</option>
                <option value="6.3">6.3</option>
                <option value="10">10</option>
                <option value="20">20</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Make</label>
              <select name="Make" class="form-select" required>
                <option value="">Select</option>
                <option value="Marson's">Marson's</option>
                <option value="RTS Power">RTS Power</option>
                <option value="Toshiba">Toshiba</option>
                <option value="Vijai">Vijai</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Year of Manufacture</label>
              <select name="Year of Manufacture" id="yearDropdown" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Serial No.</label>
              <input type="text" name="Serial No." class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times-circle"></i> Cancel
            </button>
            <button type="submit" class="btn btn-success" id="addPtrBtn">
              <span class="btn-text"><i class="fas fa-save"></i> Add PTR</span>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmTestModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm Test Record Submission</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to submit this test record?</p>
          <div id="testRecordSummary" class="bg-light p-3 rounded small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="confirmTestSubmit">
            <span class="btn-text"><i class="fas fa-check"></i> Yes, Submit</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmPtrModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Confirm PTR Addition</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to add this PTR?</p>
          <div id="ptrSummary" class="bg-light p-3 rounded small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn btn-success" id="confirmPtrSubmit">
            <span class="btn-text"><i class="fas fa-check"></i> Yes, Add PTR</span>
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle"></i> Success!</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <i class="fas fa-check-circle text-success" style="font-size: 3.5rem;"></i>
          <p class="mt-3 fs-5" id="successMessage">Operation completed successfully!</p>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-primary d-none" id="addAnotherPtrBtn">
            <i class="fas fa-plus-square"></i> Add Another PTR
          </button>
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">
            <i class="fas fa-thumbs-up"></i> OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="duplicatePtrModal" tabindex="-1" aria-labelledby="duplicatePtrModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="duplicatePtrModalLabel"><i class="fas fa-exclamation-triangle"></i> Duplicate PTR Detected!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <i class="fas fa-exclamation-circle text-warning" style="font-size: 3.5rem;"></i>
          <p class="mt-3 fs-5">A PTR with the same details already exists in the list. Duplicate entry not allowed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-bs-dismiss="modal">
            <i class="fas fa-check"></i> OK
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<div class="modal fade" id="outdatedModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Testing schedule execeded</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul id="outdatedList" class="list-group small"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const scriptUrl = 'https://script.google.com/macros/s/AKfycbxhEdt6LWidyEwq0VUoHv55vSXX1DyWbAHqEppFA1X59j43mlgfxS1NVhXNdz5KpVbe/exec';
const testRecordsCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtpueyQwlq63VP2Tm2_vITV31jKBSceDGJQVJtYeqVVDBSg3QAHzLKrv60i6Z9oODXXzOE-fdfMb8b/pub?gid=906452022&single=true&output=csv"; // New constant for CSV URL

let mapData = [], ptrData = [], testRecords = []; // Added testRecords

// Utility functions for loading states
function setLoadingState(button, isLoading) {
  const btnText = button.querySelector('.btn-text');
  const spinner = button.querySelector('.spinner-border');
  
  if (isLoading) {
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');
    button.disabled = true;
  } else {
    btnText.classList.remove('d-none');
    spinner.classList.add('d-none');
    button.disabled = false;
  }
}

function showSuccessModal(message, showAddAnother = false) {
  document.getElementById('successMessage').textContent = message;

  const addBtn = document.getElementById('addAnotherPtrBtn');
  if (showAddAnother) {
    addBtn.classList.remove('d-none');
  } else {
    addBtn.classList.add('d-none');
  }

  new bootstrap.Modal(document.getElementById('successModal')).show();
}

document.getElementById('addAnotherPtrBtn').addEventListener('click', () => {
  const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
  successModal.hide();

  // Clear and reopen the PTR modal
  document.getElementById("ptrForm").reset();

  // If region/div/substation were already selected, prefill again
  document.getElementById("modalRegion").value = document.getElementById("region").value || '';
  
  // Trigger change events to populate dependent dropdowns in the modal
  const modalRegion = document.getElementById("modalRegion");
  if (modalRegion.value) modalRegion.dispatchEvent(new Event('change'));

  setTimeout(() => {
      const modalDivision = document.getElementById("modalDivision");
      modalDivision.value = document.getElementById("division").value || '';
      if (modalDivision.value) modalDivision.dispatchEvent(new Event('change'));

      setTimeout(() => {
          const modalSubstation = document.getElementById("modalSubstation");
          modalSubstation.value = document.getElementById("substation").value || '';
      }, 150); // Small delay to allow modalSubstation to populate
  }, 150); // Small delay to allow modalDivision to populate

  new bootstrap.Modal(document.getElementById("ptrModal")).show();
});

// Global variables for tab elements
let newRecordTabButton;
let viewReportsTabButton;
let newRecordTabPane;
let viewReportsTabPane;
let newRecordNavItem;
let outdatedListContent = null; // Cache for outdated list content

document.addEventListener("DOMContentLoaded", () => {
  // Initial fetch for essential data
  fetchData().then(() => {
    // Get tab elements after DOM is loaded
    newRecordTabButton = document.getElementById('new-record-tab');
    viewReportsTabButton = document.getElementById('view-reports-tab');
    newRecordTabPane = document.getElementById('new-record');
    viewReportsTabPane = document.getElementById('view-reports');
    newRecordNavItem = document.getElementById('new-record-tab-item'); // Get the parent nav-item by its new ID

    // Initial check for mobile view
    handleMobileView();

    // Listen for window resize to adjust view
    window.addEventListener('resize', handleMobileView);
  });

  populateYearDropdown(); // Populate year dropdown once on load
});

/**
 * Formats a date string into DD/MM/YYYY format.
 * Handles YYYY-MM-DD and DD/MM/YYYY input formats.
 * @param {string} dateString - The date string to format.
 * @returns {string} Formatted date string or 'N/A'/'Invalid Date'.
 */
function formatDateToDDMMYYYY(dateString) {
  if (!dateString) return 'N/A';
  let date;

  // Attempt to parse YYYY-MM-DD (from input type="date")
  if (dateString.includes('-') && dateString.split('-').length === 3) {
    date = new Date(dateString);
  }
  // Attempt to parse DD/MM/YYYY (from CSV)
  else if (dateString.includes('/') && dateString.split('/').length === 3) {
    const [day, month, year] = dateString.split('/').map(Number);
    // Note: Month is 0-indexed in JavaScript Date objects
    date = new Date(year, month - 1, day);
  } else {
    // Fallback for other formats or if it's already a Date object string
    date = new Date(dateString);
  }

  if (isNaN(date.getTime())) {
    return 'Invalid Date';
  }

  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
  const year = date.getFullYear();

  return `${day}/${month}/${year}`;
}

function handleMobileView() {
  const container = document.querySelector('.container');
  const myTab = document.getElementById('myTab'); // The ul for nav-tabs
  const myTabContent = document.getElementById('myTabContent'); // The div for tab-content
  let desktopMessageDiv = document.getElementById('desktopMessageDiv');

  if (window.innerWidth <= 768) {
    // Hide main tab navigation and content
    if (myTab) myTab.style.display = 'none';
    if (myTabContent) myTabContent.style.display = 'none';

    // Create or show the desktop message div
    if (!desktopMessageDiv) {
      desktopMessageDiv = document.createElement('div');
      desktopMessageDiv.id = 'desktopMessageDiv';
      desktopMessageDiv.className = 'text-center mt-3 p-3'; // Add padding for better look
      desktopMessageDiv.innerHTML = '<p style="color:red; font-weight:bold;">Please open on desktop for activity.</p>';
      container.insertBefore(desktopMessageDiv, myTab); // Insert before tabs
    }
    desktopMessageDiv.style.display = 'block';

    // Automatically open the outdatedModal
    // Ensure the data is loaded before opening the modal
    if (testRecords.length === 0) {
        fetchData().then(() => {
            document.getElementById("alertButton").click();
        });
    } else {
        document.getElementById("alertButton").click();
    }

  } else { // Desktop view
    // Show main tab navigation and content
    if (myTab) myTab.style.display = '';
    if (myTabContent) myTabContent.style.display = '';

    // Hide the desktop message div
    if (desktopMessageDiv) {
      desktopMessageDiv.style.display = 'none';
    }

    // Ensure the New Test Record tab is active on desktop by default
    if (newRecordTabButton && !newRecordTabButton.classList.contains('active')) {
      const newRecordTab = bootstrap.Tab.getInstance(newRecordTabButton) || new bootstrap.Tab(newRecordTabButton);
      newRecordTab.show();
    }

    // Hide outdatedModal if it's open (e.g., if user resized from mobile to desktop)
    const outdatedModalInstance = bootstrap.Modal.getInstance(document.getElementById('outdatedModal'));
    if (outdatedModalInstance) {
        outdatedModalInstance.hide();
    }
  }
}

function fetchData() {
  return Promise.all([
    fetch(scriptUrl + '?action=getInitialData').then(res => res.json()),
    fetch(testRecordsCsvUrl).then(res => res.text())
  ])
  .then(([initialData, csvText]) => {
    mapData = initialData.map;
    ptrData = initialData.ptrs;

    const lines = csvText.split("\n");
    const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ''));
    const parsedRecords = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",").map(c => c.trim().replace(/"/g, ''));
      if (cols.length === headers.length) {
        const record = Object.fromEntries(headers.map((h, j) => [h, cols[j]]));
        parsedRecords.push(record);
      }
    }
    testRecords = parsedRecords;

    populateRegionDropdown();
    populatePTRDropdown();
    populateModalRegionDropdown();
    populateReportsTable();
  })
  .catch(err => {
    console.error('Error fetching data:', err);
    showErrorModal("Failed to load initial data. Please try again.");
  });
}

function populateRegionDropdown() {
  const regionSelect = document.getElementById("region");
  const divisionSelect = document.getElementById("division");
  const substationSelect = document.getElementById("substation");

  // Populate Region dropdown
  const regionSet = [...new Set(mapData.map(r => r.Region))];
  regionSelect.innerHTML = `<option value="">Select</option>` + regionSet.map(r => `<option>${r}</option>`).join("");

  // === Event Listeners (attach once globally) ===

  regionSelect.addEventListener("change", () => {
    const selectedRegion = regionSelect.value;

    // Populate Division
    const divisions = [...new Set(mapData.filter(e => e.Region === selectedRegion).map(e => e.Division))];
    divisionSelect.innerHTML = `<option value="">Select</option>` + divisions.map(d => `<option>${d}</option>`).join("");

    // Reset downstream
    substationSelect.innerHTML = `<option value="">Select</option>`;

    // Trigger PTR filtering
    populatePTRDropdown();
  });

  divisionSelect.addEventListener("change", () => {
    const selectedRegion = regionSelect.value;
    const selectedDivision = divisionSelect.value;

    // Populate Substation
    const substations = [...new Set(mapData.filter(e => e.Region === selectedRegion && e.Division === selectedDivision)
      .map(e => e.Substation))];
    substationSelect.innerHTML = `<option value="">Select</option>` + substations.map(s => `<option>${s}</option>`).join("");

    // Trigger PTR filtering
    populatePTRDropdown();
  });

  substationSelect.addEventListener("change", () => {
    populatePTRDropdown();
  });
}


function populateModalRegionDropdown() {
  const modalRegionSelect = document.getElementById("modalRegion");
  modalRegionSelect.innerHTML = `<option value="">Select</option>` + [...new Set(mapData.map(e => e.Region))]
    .map(r => `<option value="${r}">${r}</option>`).join("");

  modalRegionSelect.onchange = () => {
    const selectedRegion = modalRegionSelect.value;
    const divisions = [...new Set(mapData.filter(e => e.Region === selectedRegion).map(e => e.Division))];
    const modalDivisionSelect = document.getElementById("modalDivision");
    modalDivisionSelect.innerHTML = `<option value="">Select</option>` + divisions.map(d => `<option value="${d}">${d}</option>`).join("");

    document.getElementById("modalSubstation").innerHTML = `<option value="">Select</option>`;

    modalDivisionSelect.onchange = () => {
      const selectedDivision = modalDivisionSelect.value;
      const substations = [...new Set(mapData.filter(e => e.Division === selectedDivision).map(e => e.Substation))];
      const modalSubstationSelect = document.getElementById("modalSubstation");
      modalSubstationSelect.innerHTML = `<option value="">Select</option>` + substations.map(s => `<option value="${s}">${s}</option>`).join("");
    };
  };
}

function populatePTRDropdown() {
  const region = document.getElementById("region").value;
  const division = document.getElementById("division").value;
  const substation = document.getElementById("substation").value;
  const ptrSelect = document.getElementById("ptrSelect");

  let filteredPTRs = ptrData;

  if (region) {
    filteredPTRs = filteredPTRs.filter(p => p.Region === region);
  }
  if (division) {
    filteredPTRs = filteredPTRs.filter(p => p.Division === division);
  }
  if (substation) {
    filteredPTRs = filteredPTRs.filter(p => p.Substation === substation);
  }

  ptrSelect.innerHTML = `<option value="">Select</option>` + filteredPTRs.map(p =>
    `<option value="${p['Serial No.']}">${p['Equipment']} | ${p['Make']} | ${p['Capacity (MVA)']} | ${p['Serial No.']} | ${p['Year of Manufacture']}</option>`
  ).join("");
}

function populateReportsTable() {
  const tableBody = document.getElementById("reportsTableBody");
  tableBody.innerHTML = ''; // Clear existing rows

  if (!testRecords || testRecords.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No test records available.</td></tr>';
    return;
  }

  // Sort records by 'Sample Testing Date' in descending order
  const sortedRecords = [...testRecords].sort((a, b) => {
    // Ensure consistent date parsing for sorting
    const dateA = new Date(a['Sample Testing Date'].includes('/') ? a['Sample Testing Date'].split('/').reverse().join('-') : a['Sample Testing Date']);
    const dateB = new Date(b['Sample Testing Date'].includes('/') ? b['Sample Testing Date'].split('/').reverse().join('-') : b['Sample Testing Date']);
    return dateB - dateA; // Descending order (latest to earliest)
  });

  sortedRecords.forEach(record => {
    const row = tableBody.insertRow();
    row.insertCell().textContent = record.Substation || 'N/A';
    row.insertCell().textContent = record.Equipment || 'N/A';
    row.insertCell().textContent = record['Capacity (MVA)'] || 'N/A';
    row.insertCell().textContent = formatDateToDDMMYYYY(record['Sample Testing Date']); // Apply formatting here
    row.insertCell().textContent = record.Observations || 'N/A';
  });
}


function populateYearDropdown() {
  const yearSelect = document.getElementById("yearDropdown");
  const currentYear = new Date().getFullYear();
  let options = `<option value="">Select</option>`;
  for (let y = currentYear; y >= 1990; y--) {
    options += `<option value="${y}">${y}</option>`;
  }
  yearSelect.innerHTML = options;
}


function showPTRModal() {
  // Reset modal form first to ensure clean state
  document.getElementById("ptrForm").reset();

  // Call population function
  populateModalRegionDropdown();

  // Pre-fill selected values
  const region = document.getElementById("region").value;
  const division = document.getElementById("division").value;
  const substation = document.getElementById("substation").value;

  // Prefill and trigger change events with a slight delay for dropdown propagation
  setTimeout(() => {
    const modalRegion = document.getElementById("modalRegion");
    modalRegion.value = region;
    // Only dispatch event if a region was actually selected to avoid unnecessary calls
    if (region) modalRegion.dispatchEvent(new Event('change'));

    setTimeout(() => {
      const modalDivision = document.getElementById("modalDivision");
      modalDivision.value = division;
      // Only dispatch event if a division was actually selected
      if (division) modalDivision.dispatchEvent(new Event('change'));

      setTimeout(() => {
        const modalSubstation = document.getElementById("modalSubstation");
        modalSubstation.value = substation;
      }, 150); // Small delay to allow modalSubstation to populate
    }, 150); // Small delay to allow modalDivision to populate
  }, 150); // Initial delay to ensure modal is ready

  new bootstrap.Modal(document.getElementById("ptrModal")).show();
}


// Submit test form
document.getElementById("testForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  
  // Get form data
  const formData = new FormData(form);
  const record = Object.fromEntries(formData.entries());

  // Convert 27°C resistance to actual value in ohm-cm × 10¹²
  const sr27 = parseFloat(record['Specific Resistance at 27 °C (ohm-cm)']);
  if (!isNaN(sr27)) {
    record['Specific Resistance at 27 °C (ohm-cm)'] = sr27 * 1e12;
  }

  // Convert 90°C resistance to actual value in ohm-cm × 10¹²
  const sr90 = parseFloat(record['Specific Resistance at 90 °C (ohm-cm)']);
  if (!isNaN(sr90)) {
    record['Specific Resistance at 90 °C (ohm-cm)'] = sr90 * 1e12;
  }

  // Add selected dropdown values
  record.Region = document.getElementById("region").value;
  record.Division = document.getElementById("division").value;
  record.Substation = document.getElementById("substation").value;

  // Add PTR details - ensure all PTR fields are included
  const ptrSerial = document.getElementById("ptrSelect").value.trim();
  const ptrDetails = ptrData.find(p => String(p['Serial No.']).trim() === ptrSerial);

  if (ptrDetails) {
    // Explicitly add each PTR field to ensure they're included
    record.Equipment = ptrDetails.Equipment || '';
    record['Capacity (MVA)'] = ptrDetails['Capacity (MVA)'] || '';
    record.Make = ptrDetails.Make || '';
    record['Serial No.'] = ptrDetails['Serial No.'] || '';
    record['Year of Manufacture'] = ptrDetails['Year of Manufacture'] || '';
    
    // Also copy any other PTR fields that might exist
    Object.keys(ptrDetails).forEach(key => {
      if (!record.hasOwnProperty(key)) {
        record[key] = ptrDetails[key];
      }
    });
  }

  console.log('Test Record Data:', record); // Debug log to verify data

  // Store pending record and show confirmation
  function colorize(param, value, goodIf, isResistance = false) {
    const number = parseFloat(value);
    if (isNaN(number)) return `<span>${value || 'N/A'}</span>`;

    let displayValue = number;
    if (isResistance) {
      displayValue = (number / 1e12).toFixed(4) + ' × 10¹²';
    }

    let isGood = false;
    if (goodIf === "max") isGood = number <= param;
    if (goodIf === "min") isGood = number >= param;

    const color = isGood ? "green" : "red";
    return `<span style="color:${color}; font-weight: 500">${displayValue}</span>`;
  }

  pendingTestRecord = record;
  
  // Create summary for confirmation
  const summary = `
    <strong>Region:</strong> ${record.Region}<br>
    <strong>Division:</strong> ${record.Division}<br>
    <strong>Substation:</strong> ${record.Substation}<br>
    <strong>Equipment:</strong> ${record.Equipment || 'N/A'}<br>
    <strong>Capacity (MVA):</strong> ${record['Capacity (MVA)'] || 'N/A'}<br>
    <strong>Make:</strong> ${record.Make || 'N/A'}<br>
    <strong>Serial No.:</strong> ${record['Serial No.'] || 'N/A'}<br>
    <strong>Year of Manufacture:</strong> ${record['Year of Manufacture'] || 'N/A'}<br>
    <strong>Sample Collection Date:</strong> ${record['Sample Collection Date'] || 'N/A'}<br>
    <strong>Sample Testing Date:</strong> ${record['Sample Testing Date'] || 'N/A'}<br>
    <strong>Sample Collected By:</strong> ${record['Sample Collected By'] || 'N/A'}<br>
    <strong>Source Referance:</strong> ${record['Source Referance'] || 'N/A'}<br>
    <strong>Testing Referance:</strong> ${record['Testing Referance'] || 'N/A'}<br>
    <strong>Oil Sample Position:</strong> ${record['Oil Sample Position'] || 'N/A'}<br>
    <strong>Physical Appearance:</strong> ${record['Physical Appearance'] || 'N/A'}<br>
    <strong>Density (gm/CC):</strong> ${colorize(0.89, record['Density (gm/CC)'], 'max')}<br>
    <strong>BDV with 2.5mm Gap (kV):</strong> ${colorize(40, record['BDV with 2.5mm Gap (kV)'], 'min')}<br>
    <strong>Acidity (mg of KOH/gm):</strong> ${colorize(0.05, record['Acidity (mg of KOH/gm)'], 'max')}<br>
    <strong>Specific Resistance at 27 °C (ohm-cm):</strong> ${colorize(6e12, record['Specific Resistance at 27 °C (ohm-cm)'], 'min', true)}<br>
    <strong>Specific Resistance at 90 °C (ohm-cm):</strong> ${colorize(0.5e12, record['Specific Resistance at 90 °C (ohm-cm)'], 'min', true)}<br>
    <strong>Dielectric Dissipation Factor (tan δ):</strong> ${colorize(0.015, record['Dielectric Disssipation Factor (tan δ)'], 'max')}<br>
    <strong>Moisture Content (PPM):</strong> ${colorize(20, record['Moisture Content (PPM)'], 'max')}<br>
    <strong>IFT (mN/m):</strong> ${colorize(40, record['IFT (mN/m)'], 'min')}<br>
    <strong>Observations:</strong> ${record['Observations'] || 'N/A'}<br>
  `;

  
  document.getElementById('testRecordSummary').innerHTML = summary;
  new bootstrap.Modal(document.getElementById('confirmTestModal')).show();
});

// Confirm test record submission
document.getElementById("confirmTestSubmit").addEventListener("click", function () {
  const button = this;
  setLoadingState(button, true);
  
  // Submit to Google Apps Script
  fetch(scriptUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=submitTestRecord&${new URLSearchParams({data: JSON.stringify(pendingTestRecord)}).toString()}`
  })
  .then(res => res.json())
  .then(result => {
    setLoadingState(button, false);
    bootstrap.Modal.getInstance(document.getElementById('confirmTestModal')).hide();
    
    // Reset form
    document.getElementById("testForm").reset();
    document.getElementById("region").value = "";
    document.getElementById("division").innerHTML = `<option value="">Select</option>`;
    document.getElementById("substation").innerHTML = `<option value="">Select</option>`;
    document.getElementById("ptrSelect").value = "";
    
    showSuccessModal("Test Record Submitted Successfully!");
    pendingTestRecord = null;
    fetchData(); // Re-fetch data to update reports table
  })
  .catch(err => {
    setLoadingState(button, false);
    console.error('Error submitting test record:', err);
    // Use a custom modal for error messages instead of alert()
    showErrorModal("Error submitting record. Please try again.");
  });
});

// Submit PTR modal form - CLIENT-SIDE DUPLICATE CHECK
document.getElementById("ptrForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  // Always force Equipment = PTR
  data.Equipment = "PTR";

  // Define fields for comparison and their expected type for normalization
  const fieldsToCompare = [
    { name: "Region", type: "string" },
    { name: "Division", "type": "string" },
    { name: "Substation", type: "string" },
    { name: "Equipment", type: "string" },
    { name: "Capacity (MVA)", type: "numeric" }, // Treated as numeric, string comparison after trim
    { name: "Make", type: "string" },
    { name: "Serial No.", type: "string" },     // Serial number can contain letters/special chars
    { name: "Year of Manufacture", type: "numeric" } // Treated as numeric, string comparison after trim
  ];

  const duplicate = ptrData.find(p => {
    return fieldsToCompare.every(fieldDef => {
      const fieldName = fieldDef.name;
      
      // Get values from existing PTR (p) and new data (data)
      // Convert to string and trim any whitespace from both sides
      let pValue = String(p[fieldName] || '').trim();
      let dataValue = String(data[fieldName] || '').trim();

      // Apply toLowerCase for string fields only, to ensure case-insensitivity
      if (fieldDef.type === "string") {
        pValue = pValue.toLowerCase();
        dataValue = dataValue.toLowerCase();
      }
      // For numeric types, we rely on String().trim() to normalize values
      // (e.g., '3' vs '3.0' might become '3' for both after trimming)

      return pValue === dataValue;
    });
  });

  if (duplicate) {
    // Show duplicate PTR modal
    new bootstrap.Modal(document.getElementById('duplicatePtrModal')).show();
    return;
  }

  // Store pending data and show confirmation
  pendingPtrData = data;

  // Create summary for confirmation
  const summary = `
    <strong>Region:</strong> ${data.Region}<br>
    <strong>Division:</strong> ${data.Division}<br>
    <strong>Substation:</strong> ${data.Substation}<br>
    <strong>Equipment:</strong> ${data.Equipment}<br>
    <strong>Capacity (MVA):</strong> ${data['Capacity (MVA)'] || 'N/A'}<br>
    <strong>Make:</strong> ${data.Make || 'N/A'}<br>
    <strong>Serial No.:</strong> ${data['Serial No.']}<br>
    <strong>Year of Manufacture:</strong> ${data['Year of Manufacture'] || 'N/A'}
  `;

  document.getElementById('ptrSummary').innerHTML = summary;

  bootstrap.Modal.getInstance(document.getElementById('ptrModal')).hide();
  new bootstrap.Modal(document.getElementById('confirmPtrModal')).show();
});


// Confirm PTR submission
document.getElementById("confirmPtrSubmit").addEventListener("click", function () {
  const button = this;
  setLoadingState(button, true);
  
  // Submit PTR to Google Apps Script
  fetch(scriptUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=addPTR&${new URLSearchParams({data: JSON.stringify(pendingPtrData)}).toString()}`
  })
  .then(res => res.json())
  .then(result => {
    setLoadingState(button, false);
    bootstrap.Modal.getInstance(document.getElementById('confirmPtrModal')).hide();
    
    // Handle server response for duplicate
    if (result.status === "error" && result.message === "PTR Already exists in the list!") {
        new bootstrap.Modal(document.getElementById('duplicatePtrModal')).show();
        // Re-open PTR modal if needed for user to correct, or just let them retry
        new bootstrap.Modal(document.getElementById("ptrModal")).show(); 
        pendingPtrData = null; // Clear pending data
        return; 
    }

    // Reset PTR form
    document.getElementById("ptrForm").reset();
    
    // Refresh data to include new PTR
    fetchData(); // This also calls populatePTRDropdown() and populateReportsTable()
    populateYearDropdown(); 
    
    showSuccessModal("PTR Added Successfully!", true);
    pendingPtrData = null;
  })
  .catch(err => {
    setLoadingState(button, false);
    console.error('Error adding PTR:', err);
    // Use a custom modal for error messages instead of alert()
    showErrorModal("Error adding PTR. Please try again.");
  });
});


document.addEventListener("DOMContentLoaded", () => {
  const collectionInput = document.getElementById("sampleCollectionDate");
  const testingInput = document.getElementById("sampleTestingDate");

  collectionInput.addEventListener("change", () => {
    if (collectionInput.value) {
      testingInput.min = collectionInput.value;
      if (testingInput.value && testingInput.value < collectionInput.value) {
        testingInput.value = "";
      }
    }
  });

  testingInput.addEventListener("change", () => {
    if (collectionInput.value && testingInput.value < collectionInput.value) {
      // Use a custom modal for error messages instead of alert()
      showErrorModal("Sample Testing Date must be after Sample Collection Date.");
      testingInput.value = "";
    }
  });
});
document.addEventListener("input", function (e) {
  if (e.target.type === "number" && parseFloat(e.target.value) < 0) {
    e.target.value = "";
  }
});
document.getElementById("generateObservation").addEventListener("click", () => {
  const getVal = (name) => {
    const val = parseFloat(document.querySelector(`[name="${name}"]`)?.value);
    return isNaN(val) ? null : val;
  };

  const fields = [
    "Density (gm/CC)",
    "BDV with 2.5mm Gap (kV)",
    "Acidity (mg of KOH/gm)",
    "Specific Resistance at 27 °C (ohm-cm)",
    "Specific Resistance at 90 °C (ohm-cm)",
    "Dielectric Disssipation Factor (tan δ)",
    "Moisture Content (PPM)",
    "IFT (mN/m)"
  ];

  // Check if any values are filled
  const allEmpty = fields.every(name => !document.querySelector(`[name="${name}"]`)?.value);

  const box = document.querySelector('[name="Observations"]');

  if (allEmpty) {
    box.value = "Please update the data to generate observation.";
    return;
  }

  const observations = [];

  const check = (label, value, threshold, type) => {
    if (value === null) return;

    if (type === "min" && value < threshold) {
      observations.push(`Value of ${label} is below the standard limit.`);
    } else if (type === "max" && value > threshold) {
      observations.push(`Value of ${label} exceeds the standard limit.`);
    }
  };

  // Threshold checks
  check("Density (gm/CC)", getVal("Density (gm/CC)"), 0.89, "max");
  check("BDV with 2.5mm Gap (kV)", getVal("BDV with 2.5mm Gap (kV)"), 40, "min");
  check("Acidity (mg of KOH/gm)", getVal("Acidity (mg of KOH/gm)"), 0.05, "max");

  const sr27 = getVal("Specific Resistance at 27 °C (ohm-cm)");
  if (sr27 !== null && sr27 * 1e12 < 6e12) { // Compare against 6e12 after multiplication
    observations.push("Value of Specific Resistance at 27 °C (ohm-cm) is below the standard limit.");
  }

  const sr90 = getVal("Specific Resistance at 90 °C (ohm-cm)");
  if (sr90 !== null && sr90 * 1e12 < 0.5e12) { // Compare against 0.5e12 after multiplication
    observations.push("Value of Specific Resistance at 90 °C (ohm-cm) is below the standard limit.");
  }

  check("Dielectric Dissipation Factor (tan δ)", getVal("Dielectric Disssipation Factor (tan δ)"), 0.015, "max");
  check("Moisture Content (PPM)", getVal("Moisture Content (PPM)"), 20, "max");
  check("IFT (mN/m)", getVal("IFT (mN/m)"), 40, "min");

  // Update the observation field
  box.value = observations.length
    ? observations.join('\n')
    : "All parameters are within standard limits.";
});

document.getElementById("alertButton").addEventListener("click", () => {
  // This uses the testRecordsCsvUrl directly, which is correct for this function
  fetch(testRecordsCsvUrl)
    .then(res => res.text())
    .then(csv => {
      const lines = csv.split("\n");
      const headers = lines[0].split(",").map(h => h.trim().replace(/"/g, ''));
      const threshold = new Date();
      threshold.setMonth(threshold.getMonth() - 3);

      const outdated = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",").map(c => c.trim().replace(/"/g, ''));
        if (cols.length !== headers.length) continue;

        const record = Object.fromEntries(headers.map((h, j) => [h, cols[j]]));

        const dateStr = record["Sample Testing Date"];
        if (!dateStr) continue;

        // Try to parse DD/MM/YYYY format
        let testDate = null;
        if (dateStr.includes("/")) {
          const [dd, mm, year] = dateStr.split("/").map(Number);
          if (year && mm && dd) testDate = new Date(year, mm - 1, dd);
        } else if (dateStr.includes("-")) {
          testDate = new Date(dateStr);
        }

        if (!testDate || isNaN(testDate)) continue;

        if (testDate < threshold) {
          outdated.push({
            Substation: record.Substation,
            Division: record.Division,
            Date: dateStr
          });
        }
      }

      const list = document.getElementById("outdatedList");
      list.innerHTML = "";

      if (outdated.length === 0) {
        list.innerHTML = `<li class="list-group-item text-success">All records are within 3 months.</li>`;
      } else {
        outdated.forEach(entry => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `${entry.Substation} (${entry.Division}) – Tested on ${entry.Date}`;
          list.appendChild(li);
        });
      }

      new bootstrap.Modal(document.getElementById("outdatedModal")).show();
    })
    .catch(err => {
      console.error("CSV fetch failed:", err);
      // Use a custom modal for error messages instead of alert()
      showErrorModal("Failed to fetch outdated records.");
    });
});

// Custom error modal (replaces alert())
function showErrorModal(message) {
  const errorModalHtml = `
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel"><i class="fas fa-exclamation-circle"></i> Error!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <i class="fas fa-times-circle text-danger" style="font-size: 3.5rem;"></i>
            <p class="mt-3 fs-5">${message}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
              <i class="fas fa-check"></i> OK
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  // Remove existing error modal if any
  const existingModal = document.getElementById('errorModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Append new error modal to body
  document.body.insertAdjacentHTML('beforeend', errorModalHtml);
  new bootstrap.Modal(document.getElementById('errorModal')).show();
}

</script>
</body>
</html>
