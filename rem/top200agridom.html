<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REM OSD Dashboard - DOM & AGRI</title>
    <!-- Prevent Caching during development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif; /* Use imported Inter font with a simple fallback */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .update-date {
            font-size: 0.9rem;
            opacity: 0.8;
            font-style: italic;
        }

        .summary-button {
            background-color: #f59e0b; /* Amber color */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8fafc;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-total { border-left-color: #3b82f6; } /* Blue */
        .card-osd { border-left-color: #ef4444; } /* Red */
        .card-agri { border-left-color: #10b981; } /* Green for AGRI */
        .card-dom { border-left-color: #f59e0b; } /* Amber for DOM */

        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .card-label {
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Nested Cards for OSD Breakdown */
        .nested-cards {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for nested cards */
            gap: 10px; /* Smaller gap for nested cards */
            margin-top: 15px;
        }

        .nested-card {
            background: #f0f4f8; /* Lighter background for nested cards */
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inset shadow for depth */
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .nested-card .card-value {
            font-size: 1.5rem; /* Smaller font for nested values */
            margin-bottom: 5px;
        }

        .nested-card .card-label {
            font-size: 0.8rem; /* Smaller font for nested labels */
        }

        /* Filters Section */
        .filters-section {
            padding: 30px;
            background: white;
            /* Removed border-bottom to reduce gap to table */
        }

        /* Removed checkbox-filters as per request */

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        select, input[type="text"] { /* Apply to text inputs only */
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%; /* Ensure inputs take full width */
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .search-box {
            grid-column: 1 / -1; /* Span across all columns */
            margin-top: 10px;
        }

        .download-button-container {
            text-align: right; /* Align button to the right */
            margin-bottom: 10px; /* Small gap to table */
        }

        .download-button {
            background-color: #10b981; /* Green color for download */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex; /* To align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }

        .download-button:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }


        /* Table Section */
        .table-container {
            padding: 15px 30px 30px 30px; /* Adjusted padding to control space above button */
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th {
            background: #f1f5f9;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        tr:hover {
            background: #f8fafc;
            cursor: pointer;
        }

        .last-payment {
            color: #dc2626;
            font-weight: 600;
        }

        .amount {
            font-weight: 600;
            text-align: right;
        }

        .sortable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }

        .sort-asc .sort-icon {
            transform: rotate(180deg);
        }

        .download-icon-header {
            text-align: center;
            cursor: pointer;
            font-size: 1.2em;
            color: #3b82f6;
            transition: color 0.3s ease;
        }

        .download-icon-header:hover {
            color: #2563eb;
        }


        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        .pagination-controls button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination-controls button:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .pagination-controls button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            box-shadow: none;
        }

        .pagination-controls span {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin: 0 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Darker overlay */
            z-index: 1000;
            overflow-y: auto; /* Allow vertical scrolling for the whole overlay if needed */
            backdrop-filter: blur(5px); /* Frosted glass effect */
        }

        .modal-content {
            position: relative; /* Changed from absolute to relative for better positioning */
            margin: 50px auto; /* Centered with margin */
            background: white;
            border-radius: 12px;
            max-width: 700px; /* Slightly wider modal */
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: fadeInScale 0.3s ease-out forwards; /* Add animation */
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack header and body vertically */
            max-height: calc(100vh - 100px); /* Limit height to avoid overflowing viewport */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px; /* Add padding here */
            flex-shrink: 0; /* Prevent header from shrinking */
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.8rem; /* Larger modal title */
            font-weight: 700;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2.5rem; /* Larger close button */
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Make it round */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .close-btn:hover {
            color: #374151;
            background-color: #f0f4f8;
        }

        .modal-body-scrollable {
            overflow-y: auto; /* Enable vertical scrolling for the body */
            padding: 20px 30px; /* Add padding to the scrollable area */
            flex-grow: 1; /* Allow body to take up remaining space */
        }

        /* Summary Modal Table */
        .summary-modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .summary-modal-table th, .summary-modal-table td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }
        .summary-modal-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }

        /* Class Toggle Switch in Modal */
        .class-toggle {
            display: flex;
            background-color: #e2e8f0;
            border-radius: 8px;
            padding: 4px;
        }
        .class-toggle-btn {
            padding: 6px 12px;
            border: none;
            background-color: transparent;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
        }
        .class-toggle-btn.active {
            background-color: white;
            color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
        }

        .detail-value {
            color: #1f2937;
            word-wrap: break-word; /* Ensure long values wrap */
        }

        /* Loading and Error Messages */
        .loading, .error {
            text-align: center;
            padding: 50px;
            font-size: 1.1rem;
        }

        .loading {
            color: #6b7280;
        }

        .error {
            color: #dc2626;
            font-weight: 600;
        }

        /* Loading Overlay and Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than modal */
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: #374151;
            font-weight: 600;
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8rem; /* Smaller for mobile */
            }
            .header .subtitle {
                font-size: 0.9rem; /* Smaller for mobile */
            }
            .summary-cards {
                grid-template-columns: 1fr; /* Stack cards on small screens */
            }
            .card-value {
                font-size: 1.8rem; /* Smaller for mobile */
            }
            .card-label {
                font-size: 0.8rem; /* Smaller for mobile */
            }
            .nested-card .card-value {
                font-size: 1.2rem; /* Smaller for mobile */
            }
            .nested-card .card-label {
                font-size: 0.7rem; /* Smaller for mobile */
            }
            select, input[type="text"] {
                padding: 10px; /* Slightly less padding for inputs/selects */
                font-size: 0.9rem; /* Smaller font for inputs/selects */
            }
            th, td {
                padding: 8px 6px; /* Reduced padding for table cells */
                font-size: 0.9rem; /* Smaller font for table content */
            }
            .modal-content {
                padding: 20px;
                width: 95%;
                margin: 20px auto;
            }
            .detail-grid {
                grid-template-columns: 1fr; /* Stack details on small screens */
            }
            .pagination-controls {
                flex-direction: column;
            }
            .pagination-controls button {
                margin: 5px 0;
                width: 80%; /* Make buttons wider */
            }
            .pagination-controls span {
                margin: 10px 0;
            }
            .download-button {
                padding: 8px 15px; /* Smaller padding for download button */
                font-size: 0.9rem; /* Smaller font for download button */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TOP 200 DOM & AGRI Defaulters</h1>
            <div class="subtitle">Outstanding Dues Dashboard</div>
            <div class="update-date" id="updateDate">Bill Date: Loading...</div>
            <button class="summary-button" onclick="showSummaryModal()">Show CCC Summary</button>
        </div>

        <div class="summary-cards">
            <!-- Total Defaulters Card -->
            <div class="summary-card card-total">
                <div class="card-value" id="totalDefaulters">-</div>
                <div class="card-label">Total Defaulters</div>
                <div class="nested-cards">
                    <div class="nested-card">
                        <div class="card-value" id="totalAGRIDefaulters">-</div>
                        <div class="card-label">AGRI</div>
                    </div>
                    <div class="nested-card">
                        <div class="card-value" id="totalDOMDefaulters">-</div>
                        <div class="card-label">DOM</div>
                    </div>
                </div>
            </div>

            <!-- Total OSD Card with breakdown -->
            <div class="summary-card card-osd">
                <div class="card-value" id="totalOSD">-</div>
                <div class="card-label">Total OSD</div>
                <div class="nested-cards">
                    <div class="nested-card">
                        <div class="card-value" id="agriOSD">-</div>
                        <div class="card-label">AGRI OSD</div>
                    </div>
                    <div class="nested-card">
                        <div class="card-value" id="domOSD">-</div>
                        <div class="card-label">DOM OSD</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-section">
            <!-- Removed checkbox-filters section as per request -->
            <div class="filters-grid">
                <div class="filter-group">
                    <select id="regionFilter">
                        <option value="">Select Region</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="divisionFilter">
                        <option value="">Select Division</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="cccFilter">
                        <option value="">Select CCC</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="classFilter">
                        <option value="">Select Class</option>
                    </select>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by CON_ID, Name, Address..." style="width: 100%;">
            </div>
        </div>

        <div class="table-container">
            <div class="download-button-container">
                <button class="download-button" onclick="downloadFilteredCSV()">
                    &#x2193; Download Filtered Data
                </button>
            </div>
            <div id="loadingMessage" class="loading">Loading data...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Sl</th>
                        <th>Con ID</th>
                        <th>CCC</th>
                        <th>Name</th>
                        <th>MRU</th>
                        <th>Mobile</th>
                        <th>Base Class</th>
                        <th id="osdHeader" class="sortable-header">
                            OSD (₹)
                            <span class="sort-icon">&#9660;</span>
                        </th>
                        <th>Locked OSD (₹)</th>
                        <th>Last Payment</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <button id="prevPageBtn" disabled>Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPageBtn" disabled>Next</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Consumer Details</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="detail-grid modal-body-scrollable">
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">CCC-wise Summary</div>
                <div class="class-toggle" id="summaryClassToggle">
                    <button class="class-toggle-btn active" onclick="showSummaryModal('all')">All</button>
                    <button class="class-toggle-btn" onclick="showSummaryModal('AGRI')">AGRI</button>
                    <button class="class-toggle-btn" onclick="showSummaryModal('DOM')">DOM</button>
                </div>
                <button class="close-btn" onclick="closeSummaryModal()">&times;</button>
            </div>
            <div id="summaryModalBody" class="modal-body-scrollable">
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Loading data... Please wait.</div>
    </div>

    <script>
        // Mapping for regions, divisions, and CCCs
        const mapping = {
            "MALDA REGION": {
                "MALDA DIVISION": {"MANIKCHAK CCC": "6611101", "GOLAPGANJ CCC": "6611102", "BAISHNABNAGAR CCC": "6611103", "KALIACHAK CCC": "6611104", "MOTHABARI CCC": "6611105", "SUJAPUR CCC": "6611106", "RATHBARI CCC": "6611107", "FULBARI CCC": "6611108", "MOKDUMPUR CCC": "6611109"},
                "CHANCHAL DIVISION": {"BHALUKA CCC": "6612101", "SAMSI CCC": "6612102", "PARANPUR CCC": "6612103", "CHANCHAL CCC": "6612104", "MALATIPUR CCC": "6612105", "HARISHCHANDRAPUR CCC": "6612106", "KUSHIDA CCC": "6612107"},
                "GAZOLE DIVISION": {"GAZOL CCC": "6613101", "AIHO. CCC": "6613102", "PANDUA CCC": "6613103", "BAMONGOLA CCC": "6613104", "OLD MALDA CCC": "6613105"}
            },
            "UTTAR DINAJPUR REGION": {
                "RAIGANJ DIVISION": {"ITAHAR CCC": "6621101", "HEMTABAD CCC": "6621102", "KALIYAGANJ CCC": "6621103", "RAIGANJ CCC": "6621104", "BIRNAGAR CCC": "6621105", "KARANDIGHI CCC": "6621106"},
                "ISLAMPUR DIVISION": {"ISLAMPUR CCC": "6622101", "CHOPRA CCC": "6622102", "DALKHOLA CCC": "6622103", "GOALPOKHER CCC": "6622104", "KANKI CCC": "6622105"}
            },
            "DAKSHIN DINAJPUR REGION": {
                "BALURGHAT DIVISION": {"BALURGHAT CCC": "6631101", "TAPAN CCC": "6631102", "KUMARGANJ CCC": "6631103", "HILI CCC": "6631104", "PATIRAM CCC": "6631105"},
                "BUNIADPUR DIVISION": {"BUNIADPUR CCC": "6632101", "KUSMANDI CCC": "6632102", "HARIRAMPUR CCC": "6632103", "GANGARAMPUR CCC": "6632104"}
            }
        };

        let allData = [];
        let filteredData = [];
        let cccCodeToNames = {};
        let currentPage = 1;
        const rowsPerPage = 20; // Max 20 data per page
        let currentSortColumn = 'NOTOSD_UPD'; // Default sort by OSD
        let currentSortDirection = 'desc'; // Default sort descending

        // URLs for the new data sources
        const AGRI_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFk-wa_x-dsthFXNsWa9wRxWOQrMD-yEiucvA2FtJIbwnTiGqVs3OT_eXxqyAOBqvGSDRiG-Hr0hK1/pub?gid=0&single=true&output=tsv';
        const DOM_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFk-wa_x-dsthFXNsWa9wRxWOQrMD-yEiucvA2FtJIbwnTiGqVs3OT_eXxqyAOBqvGSDRiG-Hr0hK1/pub?gid=1106133732&single=true&output=tsv';

        /**
         * Creates a reverse mapping from CCC codes to their corresponding region, division, and CCC names.
         * This helps in quickly retrieving location information for a given CCC_CODE from the data.
         */
        function createCCCMapping() {
            Object.keys(mapping).forEach(region => {
                Object.keys(mapping[region]).forEach(division => {
                    Object.keys(mapping[region][division]).forEach(ccc => {
                        const code = mapping[region][division][ccc];
                        cccCodeToNames[code] = {
                            region: region,
                            division: division,
                            // Store only the CCC name without " CCC"
                            ccc: ccc.replace(' CCC', '')
                        };
                    });
                });
            });
        }

        /**
         * Formats a date string from YYYYMMDD to DD/MM/YYYY.
         * @param {string} dateStr - The date string in YYYYMMDD format.
         * @returns {string} The formatted date string or 'N/A' if invalid.
         */
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return 'N/A';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${day}/${month}/${year}`;
        }

        /**
         * Calculates the difference in months between a given date string and the current date.
         * @param {string} dateStr - The date string in YYYYMMDD format.
         * @returns {string} The difference in months (e.g., "3 months ago", "Today", "N/A").
         */
        function getMonthsSince(dateStr) {
            if (!dateStr || dateStr.length !== 8) return 'N/A';

            const year = parseInt(dateStr.substring(0, 4));
            const month = parseInt(dateStr.substring(4, 6)) - 1; // Month is 0-indexed
            const day = parseInt(dateStr.substring(6, 8));

            const pastDate = new Date(year, month, day);
            const currentDate = new Date();

            // Set to start of the day for accurate month calculation
            pastDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);

            const diffTime = Math.abs(currentDate.getTime() - pastDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 30) { // Approximately one month
                return "Within 1 month";
            }

            let months = (currentDate.getFullYear() - pastDate.getFullYear()) * 12;
            months -= pastDate.getMonth();
            months += currentDate.getMonth();

            // Adjust if the day of the month is earlier in the current month
            if (currentDate.getDate() < pastDate.getDate()) {
                months--;
            }
            
            if (months < 0) return 'N/A'; // Future date or invalid calculation
            if (months === 0) return "Within 1 month";
            return `${months} months ago`;
        }


        /**
         * Formats a given amount into Indian currency format (Lakhs, Crores) for better readability.
         * @param {number|string} amount - The numeric amount to format.
         * @returns {string} The formatted currency string.
         */
        function formatIndianCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) return '0';

            const crore = 10000000;
            const lakh = 100000;

            if (num >= crore) {
                return (num / crore).toFixed(2) + ' Cr';
            } else if (num >= lakh) {
                return (num / lakh).toFixed(2) + ' L';
            } else {
                return new Intl.NumberFormat('en-IN').format(num);
            }
        }

        /**
         * Shows the loading overlay with a dynamic message.
         * @param {string} message - The message to display on the loading overlay.
         */
        function showLoadingOverlay(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = message; // Update the loading text
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        /**
         * Parses TSV data into an array of objects.
         * @param {string} tsvData - The TSV data string.
         * @returns {Array<Object>} An array of parsed data objects.
         */
        function parseTsv(tsvData) {
            const lines = tsvData.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split('\t');
                const record = {};
                headers.forEach((header, index) => {
                    record[header] = values[index] ? values[index].trim() : '';
                });
                return record;
            });
        }

        /**
         * Loads and parses TSV data from two Google Sheets (AGRI and DOM).
         * Combines the data, initializes filters, updates summary cards, and renders the table.
         * Handles loading and error messages.
         */
        async function loadData() {
            showLoadingOverlay("Downloading data... (AGRI & DOM)"); // Initial loading message
            // Hide the old loading message div, as we are now using the overlay
            document.getElementById('loadingMessage').style.display = 'none'; 
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                // Fetch both datasets concurrently
                const [agriResponse, domResponse] = await Promise.all([
                    fetch(AGRI_DATA_URL),
                    fetch(DOM_DATA_URL)
                ]);

                if (!agriResponse.ok) {
                    throw new Error(`HTTP error! status for AGRI data: ${agriResponse.status}`);
                }
                if (!domResponse.ok) {
                    throw new Error(`HTTP error! status for DOM data: ${domResponse.status}`);
                }

                const agriTsvData = await agriResponse.text();
                const domTsvData = await domResponse.text();
                
                showLoadingOverlay("Analysing data..."); // Update message after download

                // Parse and combine data
                const agriData = parseTsv(agriTsvData);
                const domData = parseTsv(domTsvData);
                
                // Assign a 'type' to each record for filtering/categorization
                agriData.forEach(item => item.TYPE = 'AGRI');
                domData.forEach(item => item.TYPE = 'DOM');

                allData = [...agriData, ...domData];

                createCCCMapping();
                initializeFilters();
                
                showLoadingOverlay("Loading visualization..."); // Update message before rendering
                filterAndSortData(); // Initial filter and render
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error loading data. Please try again later. ' + error.message;
            } finally {
                hideLoadingOverlay(); // Hide loading overlay when done (success or error)
            }
        }

        /**
         * Initializes the filter dropdowns (Region, Division, CCC, Base Class)
         * and sets up event listeners for cascading filters and data filtering.
         * Removed School, Party Office, and Tower filters.
         */
        function initializeFilters() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            const cccFilter = document.getElementById('cccFilter');
            const classFilter = document.getElementById('classFilter');
            
            // Populate regions
            Object.keys(mapping).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });

            // Get unique base classes (DOM and AGRI)
            const baseClasses = [...new Set(allData.map(item => item.BASE_CLASS).filter(cls => cls))];
            baseClasses.sort().forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classFilter.appendChild(option);
            });

            // Set placeholders for filters
            regionFilter.querySelector('option[value=""]').textContent = 'Select Region';
            divisionFilter.querySelector('option[value=""]').textContent = 'Select Division';
            cccFilter.querySelector('option[value=""]').textContent = 'Select CCC';
            classFilter.querySelector('option[value=""]').textContent = 'Select Class';

            // Event listeners for cascading filters
            regionFilter.addEventListener('change', updateDivisionFilter);
            divisionFilter.addEventListener('change', updateCCCFilter);
            
            // Filter event listeners for all filters and search input
            regionFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            divisionFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            cccFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            classFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; filterAndSortData(); });

            // OSD Header sort listener
            document.getElementById('osdHeader').addEventListener('click', () => {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                filterAndSortData();
            });

            // Pagination button event listeners
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        }

        /**
         * Updates the Division filter dropdown based on the selected Region.
         */
        function updateDivisionFilter() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            
            divisionFilter.innerHTML = '<option value="">Select Division</option>';
            
            if (regionFilter.value) {
                Object.keys(mapping[regionFilter.value]).forEach(division => {
                    const option = document.createElement('option');
                    option.value = division;
                    option.textContent = division;
                    divisionFilter.appendChild(option);
                });
            }
            
            updateCCCFilter(); // Also update CCC filter when division changes
        }

        /**
         * Updates the CCC filter dropdown based on the selected Region and Division.
         */
        function updateCCCFilter() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            const cccFilter = document.getElementById('cccFilter');
            
            cccFilter.innerHTML = '<option value="">Select CCC</option>';
            
            if (regionFilter.value && divisionFilter.value) {
                Object.keys(mapping[regionFilter.value][divisionFilter.value]).forEach(ccc => {
                    const option = document.createElement('option');
                    option.value = ccc;
                    option.textContent = ccc;
                    cccFilter.appendChild(option);
                });
            }
        }

        /**
         * Updates the summary cards with total defaulters, total OSD, and their DOM/AGRI breakdowns.
         * Also updates the last updated date.
         */
        function updateSummary() {
            const totalDefaulters = filteredData.length; // Now based on filteredData
            let totalOSD = 0;
            let agriDefaulters = 0;
            let domDefaulters = 0;
            let agriOSD = 0;
            let domOSD = 0;

            // Calculate totals based on currently filtered data
            filteredData.forEach(item => {
                const notOsd = parseFloat(item.NOTOSD_UPD || 0);
                totalOSD += notOsd;

                if (item.TYPE === 'AGRI') { // AGRI type
                    agriDefaulters++;
                    agriOSD += notOsd;
                } else if (item.TYPE === 'DOM') { // DOM type
                    domDefaulters++;
                    domOSD += notOsd;
                }
            });
            
            // Find max date from UPD_DT from allData for overall last updated date
            const maxDate = allData.reduce((max, item) => {
                const date = item.BDATE;
                if (date && date > max) return date;
                return max;
            }, '');

            document.getElementById('totalDefaulters').textContent = formatIndianCurrency(totalDefaulters);
            document.getElementById('totalOSD').textContent = formatIndianCurrency(totalOSD);
            document.getElementById('totalAGRIDefaulters').textContent = formatIndianCurrency(agriDefaulters);
            document.getElementById('totalDOMDefaulters').textContent = formatIndianCurrency(domDefaulters);
            document.getElementById('agriOSD').textContent = formatIndianCurrency(agriOSD);
            document.getElementById('domOSD').textContent = formatIndianCurrency(domOSD);
            document.getElementById('updateDate').textContent = `Bill Date: ${formatDate(maxDate)}`;
        }

        /**
         * Filters and sorts the `allData` based on selected region, division, CCC, base class, and search term.
         * Updates `filteredData` and then calls `renderTable` and `updateSummary`.
         */
        function filterAndSortData() {
            const regionFilter = document.getElementById('regionFilter').value;
            const divisionFilter = document.getElementById('divisionFilter').value;
            const cccFilter = document.getElementById('cccFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(item => {
                // Get location info for this CCC_CODE
                const locationInfo = cccCodeToNames[item.CCC_CODE];
                
                // Region filter
                if (regionFilter && (!locationInfo || locationInfo.region !== regionFilter)) {
                    return false;
                }
                
                // Division filter
                if (divisionFilter && (!locationInfo || locationInfo.division !== divisionFilter)) {
                    return false;
                }
                
                // CCC filter
                if (cccFilter && (!locationInfo || locationInfo.ccc !== cccFilter.replace(' CCC', ''))) { // Compare with CCC name without ' CCC'
                    return false;
                }
                
                // Base class filter
                if (classFilter && item.BASE_CLASS !== classFilter) {
                    return false;
                }
                
                // Search filter (CON_ID, Name, Address)
                if (searchTerm) {
                    const searchFields = [
                        item.CON_ID,
                        item.NAME,
                        item.ADDRESS
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });

            // Sort data
            filteredData.sort((a, b) => {
                const valA = parseFloat(a[currentSortColumn] || 0);
                const valB = parseFloat(b[currentSortColumn] || 0);

                if (currentSortDirection === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // Update sort icon
            const osdHeader = document.getElementById('osdHeader');
            const sortIcon = osdHeader.querySelector('.sort-icon');
            if (currentSortDirection === 'asc') {
                sortIcon.innerHTML = '&#9650;'; // Up arrow
                osdHeader.classList.remove('sort-desc');
                osdHeader.classList.add('sort-asc');
            } else {
                sortIcon.innerHTML = '&#9660;'; // Down arrow
                osdHeader.classList.remove('sort-asc');
                osdHeader.classList.add('sort-desc');
            }


            currentPage = 1; // Reset to first page after filtering and sorting
            updateSummary(); // Update summary based on newly filtered data
            renderTable(); // Render table with filtered data
        }

        /**
         * Renders the data table with pagination. Displays a subset of `filteredData`
         * based on `currentPage` and `rowsPerPage`.
         */
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.onclick = () => showDetails(item);
                
                // Get location info for this CCC_CODE for display in the table
                const locationInfo = cccCodeToNames[item.CCC_CODE];

                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td>${item.CON_ID || 'N/A'}</td>
                    <td>${locationInfo ? locationInfo.ccc : 'N/A'}</td>
                    <td>${item.NAME || 'N/A'}</td>
                    <td>${item.MRU || 'N/A'}</td> <!-- Display MRU -->
                    <td>${item.REG_MOB_NO || 'N/A'}</td> <!-- Display Mobile No -->
                    <td>${item.BASE_CLASS || 'N/A'}</td>
                    <td class="amount">${formatIndianCurrency(item.NOTOSD_UPD)}</td>
                    <td class="amount">${formatIndianCurrency(item.LOCKED_OSD)}</td>
                    <td class="last-payment">${getMonthsSince(item.LAST_PDT)}</td>
                `;
                
                tbody.appendChild(row);
            });

            updatePaginationControls();
        }

        /**
         * Updates the state of pagination buttons (Previous/Next) and page information.
         */
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        /**
         * Converts an array of objects to a CSV string.
         * @param {Array<Object>} data - The array of data objects.
         * @param {Array<string>} headers - The array of header keys to use for CSV columns.
         * @returns {string} The CSV formatted string.
         */
        function convertToCSV(data, headers) {
            const csvRows = [];
            // Add header row
            csvRows.push(headers.join(','));

            // Add data rows
            for (const row of data) {
                const values = headers.map(header => {
                    const val = row[header];
                    // Handle potential commas or newlines in data by enclosing in quotes
                    const escaped = ('' + val).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }

        /**
         * Downloads the filteredData as a CSV file.
         */
        function downloadFilteredCSV() {
            if (filteredData.length === 0) {
                console.warn("No filtered data to download.");
                return;
            }

            // Get all unique headers from the first item of allData, to ensure all original columns are present
            const headers = Object.keys(allData[0]);
            const csvString = convertToCSV(filteredData, headers);
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rem_osd_dashboard_filtered_data.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Displays a modal with detailed information about a selected consumer.
         * Formats OSD values using `formatIndianCurrency`.
         * @param {object} item - The data object for the selected consumer.
         */
        function showDetails(item) {
            const locationInfo = cccCodeToNames[item.CCC_CODE];
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="detail-label">Consumer ID:</div>
                <div class="detail-value">${item.CON_ID || 'N/A'}</div>
                
                <div class="detail-label">Name:</div>
                <div class="detail-value">${item.NAME || 'N/A'}</div>
                
                <div class="detail-label">Address:</div>
                <div class="detail-value">${item.ADDRESS || 'N/A'}</div>
                
                <div class="detail-label">Region:</div>
                <div class="detail-value">${locationInfo ? locationInfo.region : 'N/A'}</div>
                
                <div class="detail-label">Division:</div>
                <div class="detail-value">${locationInfo ? locationInfo.division : 'N/A'}</div>
                
                <div class="detail-label">CCC:</div>
                <div class="detail-value">${locationInfo ? locationInfo.ccc : 'N/A'}</div>
                
                <div class="detail-label">MRU:</div>
                <div class="detail-value">${item.MRU || 'N/A'}</div> <!-- Display MRU in modal -->

                <div class="detail-label">Registered Mobile No.:</div>
                <div class="detail-value">${item.REG_MOB_NO || 'N/A'}</div> <!-- Display Mobile No in modal -->
                
                <div class="detail-label">Base Class:</div>
                <div class="detail-value">${item.BASE_CLASS || 'N/A'}</div>
                
                <div class="detail-label">Consumer Type:</div>
                <div class="detail-value">${item.TYPE || 'N/A'}</div> <!-- Display new TYPE (AGRI/DOM) -->

                <div class="detail-label">Government Status:</div>
                <div class="detail-value">${item.GOVT_STAT || 'N/A'}</div>
                
                <div class="detail-label">Outstanding Dues:</div>
                <div class="detail-value">${formatIndianCurrency(item.NOTOSD_UPD)}</div>
                
                <div class="detail-label">Locked OSD:</div>
                <div class="detail-value">${formatIndianCurrency(item.LOCKED_OSD)}</div>
                
                <div class="detail-label">Bill Date:</div>
                <div class="detail-value">${formatDate(item.BDATE)}</div>
                
                <div class="detail-label">Last Payment:</div>
                <div class="detail-value">${getMonthsSince(item.LAST_PDT)} (Original: ${formatDate(item.LAST_PDT)})</div>
                
                <div class="detail-label">Report Date:</div>
                <div class="detail-value">${formatDate(item.UPD_DT)}</div>
                
                <div class="detail-label">Notice Issue Date:</div>
                <div class="detail-value">${formatDate(item.NOT_ISSUE_DT)}</div>
                
                <div class="detail-label">Installation No:</div>
                <div class="detail-value">${item.INST_NO || 'N/A'}</div>
                
                <div class="detail-label">Class Description:</div>
                <div class="detail-value">${item.CLASS_DESC || 'N/A'}</div>
                
                <div class="detail-label">Disconnection Flag:</div>
                <div class="detail-value">${item.DISC_FLAG || 'N/A'}</div>
            `;
            
            document.getElementById('detailModal').style.display = 'block';
        }

        /**
         * Calculates and displays a CCC-wise summary in a modal.
         * The summary is based on the currently filtered data.
         */
        function showSummaryModal(classType = 'all') {
            // Update active state on toggle buttons
            document.querySelectorAll('#summaryClassToggle .class-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#summaryClassToggle .class-toggle-btn[onclick="showSummaryModal('${classType}')"]`).classList.add('active');

            let dataForSummary = filteredData;
            if (classType !== 'all') {
                dataForSummary = filteredData.filter(item => item.TYPE === classType);
            }

            const summary = dataForSummary.reduce((acc, item) => {
                const cccCode = item.CCC_CODE;
                const locationInfo = cccCodeToNames[cccCode];
                const cccName = locationInfo ? locationInfo.ccc : 'Unknown CCC';
                const osd = parseFloat(item.NOTOSD_UPD || 0);

                if (!acc[cccName]) {
                    acc[cccName] = { count: 0, totalOSD: 0 };
                }

                acc[cccName].count++;
                acc[cccName].totalOSD += osd;

                return acc;
            }, {});

            // Convert to array and sort by total OSD descending
            const summaryArray = Object.keys(summary).map(cccName => ({
                cccName: cccName,
                count: summary[cccName].count,
                totalOSD: summary[cccName].totalOSD
            })).sort((a, b) => b.totalOSD - a.totalOSD);

            const modalBody = document.getElementById('summaryModalBody');
            let tableHTML = `<table class="summary-modal-table">
                                <thead>
                                    <tr>
                                        <th>Sl</th>
                                        <th>CCC Name</th>
                                        <th>Defaulter Count</th>
                                        <th>Total OSD (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            summaryArray.forEach((item, index) => {
                tableHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${item.cccName}</td>
                                <td>${item.count}</td>
                                <td class="amount">${formatIndianCurrency(item.totalOSD)}</td>
                              </tr>`;
            });

            tableHTML += `</tbody></table>`;
            modalBody.innerHTML = tableHTML;
            document.getElementById('summaryModal').style.display = 'block';
        }

        /**
         * Closes the detail modal.
         */
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        /**
         * Closes the summary modal.
         */
        function closeSummaryModal() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        /**
         * Closes the modal when clicking outside of its content.
         * @param {Event} event - The click event object.
         */
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const summaryModal = document.getElementById('summaryModal');
            if (event.target === summaryModal) {
                closeSummaryModal();
            } else if (event.target === detailModal) {
                closeModal();
            }
        }

        // Initialize the application when the window loads
        window.onload = loadData;
    </script>
</body>
</html>
