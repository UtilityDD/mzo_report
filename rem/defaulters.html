<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REM OSD Dashboard - Industrial & Commercial</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif; /* Changed to Inter as per instructions */
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 15px;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #2d3748;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .header-title-row {
            display: flex;
            align-items: center;
            justify-content: center; /* Center the group */
            margin-bottom: 8px; /* Space below the title row */
        }

        .header h1 {
            font-size: 2rem;
            /* margin-bottom: 8px; -- This will be moved to .header-title-row */
            font-weight: 700;
            margin-right: 10px; /* Space between title and button */
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 8px; /* Adjusted margin for better spacing */
        }

        .update-date {
            font-size: 0.9rem;
            opacity: 0.8;
            font-style: italic;
            margin-bottom: 10px; /* Added margin below update date */
        }

        .summary-icon-button {
            background-color: #f59e0b; /* Amber color from the other file, works well */
            color: white;
            border: none;
            padding: 5px 10px; /* Smaller padding */
            border-radius: 6px; /* Slightly smaller border-radius */
            cursor: pointer;
            font-size: 1.2rem; /* Larger font for the symbol */
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; /* To center the symbol */
            align-items: center;
            justify-content: center;
            line-height: 1; /* Ensure symbol is vertically centered */
        }

        .summary-icon-button:hover {
            background-color: #e08e0b; /* Darker amber on hover */
            transform: translateY(-1px);
        }

        /* Collapsible Section Header */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #4a5568;
            cursor: pointer;
            user-select: none; /* Prevent text selection on click */
            transition: background-color 0.3s ease;
        }

        .collapsible-header:hover {
            background-color: #5a6578;
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg); /* Point left when collapsed */
        }
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #2d3748;
            max-height: 500px; /* Adjust as needed for content */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }

        .summary-cards.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .summary-card {
            background: #4a5568;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-total { border-left-color: #3b82f6; } /* Blue */
        .card-osd { border-left-color: #ef4444; } /* Red */
        .card-commercial { border-left-color: #10b981; } /* Green */
        .card-industrial { border-left-color: #f59e0b; } /* Amber */

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #f7fafc;
        }

        .card-label {
            color: #a0aec0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Nested Cards for OSD Breakdown */
        .nested-cards {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for nested cards */
            gap: 10px; /* Smaller gap for nested cards */
            margin-top: 15px;
        }

        .nested-card {
            background: #2d3748; /* Lighter background for nested cards */
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inset shadow for depth */
            text-align: center;
            border: 1px solid #4a5568;
        }

        .nested-card .card-value {
            font-size: 1.5rem; /* Smaller font for nested values */
            margin-bottom: 5px;
        }

        .nested-card .card-label {
            font-size: 0.8rem; /* Smaller font for nested labels */
        }

        /* Filters Section */
        .filters-section {
            padding: 20px;
            background: #2d3748;
            /* Removed border-bottom to reduce gap to table */
        }

        .all-filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            align-items: center;
        }

        .all-filters-container label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #cbd5e0;
            cursor: pointer;
        }

        .all-filters-container input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: #3b82f6; /* Style checkbox */
        }


        select, input[type="text"] { /* Apply to text inputs only */
            padding: 10px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%; /* Ensure inputs take full width */
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .all-filters-container select {
            min-width: 200px; /* Give select dropdowns a minimum width */
            width: auto; /* Allow them to size based on content and min-width */
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            background-color: #2d3748;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* New styles for search and download button on same line */
        .search-and-download-row {
            display: flex;
            align-items: center;
            gap: 15px; /* Space between search and button */
            margin-top: 10px; /* Keep some top margin */
            margin-bottom: 0; /* Remove bottom margin to reduce gap to table */
        }

        .search-box {
            flex-grow: 1; /* Allow search input to take available space */
            margin-top: 0; /* Remove previous margin */
        }

        .search-and-download-row .download-button-container {
            text-align: unset; /* Remove right alignment */
            margin-bottom: 0; /* Remove previous margin */
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .download-button-container {
            /* Original styles for download-button-container,
               some overridden by .search-and-download-row .download-button-container */
            text-align: right;
            margin-bottom: 10px;
            /* This margin-bottom will be overridden when inside .search-and-download-row */
        }

        .download-button {
            background-color: #10b981; /* Green color for download */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex; /* To align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }

        .download-button:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }


        /* Table Section */
        .table-container {
            padding: 0 20px 20px 20px; /* Removed top padding to reduce gap */
            overflow-x: auto;
            overflow-y: auto; /* Enable vertical scrolling for the container */
            max-height: 70vh; /* Set a max-height to make the container scrollable */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #2d3748;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th {
            background: #4a5568;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: #e2e8f0;
            border-bottom: 2px solid #1a202c;
            position: sticky; /* Make the header sticky */
            top: 0; /* Stick to the top of the scrollable container */
            z-index: 10; /* Ensure it stays above the table body content */
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #4a5568;
            vertical-align: middle;
        }

        tr:hover {
            background: #4a5568;
            cursor: pointer;
        }

        .last-payment {
            color: #dc2626;
            font-weight: 600;
        }

        .amount {
            font-weight: 600;
            text-align: right;
        }

        .sortable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }

        .sort-asc .sort-icon {
            transform: rotate(180deg);
        }

        .download-icon-header {
            text-align: center;
            cursor: pointer;
            font-size: 1.2em;
            color: #3b82f6;
            transition: color 0.3s ease;
        }

        .download-icon-header:hover {
            color: #2563eb;
        }


        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
            background: #2d3748;
            border-top: 1px solid #4a5568;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .pagination-controls button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination-controls button:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .pagination-controls button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            box-shadow: none;
        }

        .pagination-controls span {
            font-size: 1rem;
            font-weight: 600;
            color: #cbd5e0;
            margin: 0 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* Darker overlay */
            z-index: 1000;
            overflow: auto; /* Enable scrolling for modal content */
            backdrop-filter: blur(5px); /* Frosted glass effect */
        }

        .modal-content {
            position: relative; /* Changed from absolute to relative for better positioning */
            margin: 50px auto; /* Centered with margin */
            background: #2d3748;
            border-radius: 12px;
            padding: 25px;
            max-width: 700px; /* Slightly wider modal */
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: fadeInScale 0.3s ease-out forwards; /* Add animation */
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #4a5568;
        }

        .modal-title {
            font-size: 1.5rem; /* Larger modal title */
            font-weight: 700;
            color: #f7fafc;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2.5rem; /* Larger close button */
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Make it round */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .close-btn:hover {
            color: #f7fafc;
            background-color: #4a5568;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .detail-label {
            font-weight: 600;
            color: #a0aec0;
        }

        .detail-value {
            color: #e2e8f0;
            word-wrap: break-word; /* Ensure long values wrap */
        }

        /* Summary Modal Table */
        .summary-modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .summary-modal-table th, .summary-modal-table td {
            border: 1px solid #4a5568;
            padding: 10px;
            text-align: left;
        }
        .summary-modal-table th {
            background-color: #4a5568;
            font-weight: 600;
            position: sticky; /* Make the header sticky */
            top: 0; /* Stick to the top of the scrollable container */
            z-index: 1; /* Ensure it stays above the table body */
        }

        /* Class Toggle Switch in Modal */
        .class-toggle {
            display: flex;
            background-color: #1a202c;
            border-radius: 8px;
            padding: 4px;
        }
        .class-toggle-btn {
            padding: 6px 12px;
            border: none;
            background-color: transparent;
            color: #a0aec0;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s;
        }
        .class-toggle-btn.active {
            background-color: #4a5568;
            color: #f7fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .modal-body-scrollable {
            max-height: 60vh; /* Set a max height to ensure scrolling is triggered */
            overflow-y: auto; /* Enable vertical scrolling for the body */
            /* Removed padding to let table fill the space, which helps with sticky header */
        }

        /* New styles for tabs inside the modal */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #4a5568;
            margin-bottom: 15px;
        }
        .modal-tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #a0aec0;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 3px solid transparent;
            transition: color 0.3s, border-color 0.3s;
        }
        .modal-tab-btn:hover {
            color: #f7fafc;
        }
        .modal-tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .modal-tab-panel {
            display: none;
        }
        .modal-tab-panel.active {
            display: block;
        }
        /* Loading and Error Messages */
        .loading, .error {
            text-align: center;
            padding: 50px;
            font-size: 1.1rem;
        }

        .loading {
            color: #6b7280;
        }

        .error {
            color: #dc2626;
            font-weight: 600;
        }

        /* Loading Overlay and Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than modal */
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            color: #4a5568;
            font-weight: 600;
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header-title-row {
                flex-direction: column; /* Stack title and button vertically */
                gap: 5px; /* Small gap when stacked */
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                margin-right: 0; /* Remove right margin when stacked */
                margin-bottom: 5px; /* Add bottom margin when stacked */
            }
            .summary-icon-button {
                font-size: 1rem; /* Smaller symbol on mobile */
                padding: 4px 8px;
                font-size: 1.8rem; /* Smaller for mobile */
            }
            .header .subtitle {
                font-size: 0.9rem; /* Smaller for mobile */
            }
            .summary-cards {
                grid-template-columns: 1fr; /* Stack cards on small screens */
            }
            .card-value {
                font-size: 1.8rem; /* Smaller for mobile */
            }
            .card-label {
                font-size: 0.8rem; /* Smaller for mobile */
            }
            .nested-card .card-value {
                font-size: 1.2rem; /* Smaller for mobile */
            }
            .nested-card .card-label {
                font-size: 0.7rem; /* Smaller for mobile */
            }
            select, input[type="text"] {
                padding: 10px; /* Slightly less padding for inputs/selects */
                font-size: 0.9rem; /* Smaller font for inputs/selects */
            }
            th, td {
                padding: 8px 6px; /* Reduced padding for table cells */
                font-size: 0.9rem; /* Smaller font for table content */
            }
            .modal-content {
                padding: 20px;
                width: 95%;
                margin: 20px auto;
            }
            .detail-grid {
                grid-template-columns: 1fr; /* Stack details on small screens */
            }
            .pagination-controls {
                flex-direction: column;
            }
            .pagination-controls button {
                margin: 5px 0;
                width: 80%; /* Make buttons wider */
            }
            .pagination-controls span {
                margin: 10px 0;
            }
            /* Responsive adjustments for search and download row */
            .search-and-download-row {
                flex-direction: column;
                align-items: stretch; /* Stretch items to full width */
                gap: 10px;
            }
            .search-and-download-row .search-box input {
                width: 100%; /* Ensure input takes full width */
            }
            .search-and-download-row .download-button-container {
                width: 100%; /* Make button container full width */
                text-align: center; /* Center button if it doesn't stretch */
                margin-bottom: 0; /* Ensure no extra margin */
            }
            .download-button {
                padding: 8px 15px; /* Smaller padding for download button */
                font-size: 0.9rem; /* Smaller font for download button */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title-row">
                <h1>REM OSD Dashboard</h1>
                <button class="summary-icon-button" onclick="showSummaryModal()" title="Show Summary">ðŸ“Š</button>
            </div>
            <div class="subtitle">Industrial & Commercial Outstanding Dues</div>
            <div class="update-date" id="updateDate">Last Updated: Loading...</div>
        </div>

        <div class="collapsible-header" onclick="toggleSummaryCards()">
            <h3>Dashboard Summary</h3>
            <span id="summaryToggleIcon" class="toggle-icon">&#9660;</span> <!-- Down arrow -->
        </div>

        <div class="summary-cards" id="summaryCardsContainer">
            <!-- Total Defaulters Card -->
            <div class="summary-card card-total">
                <div class="card-value" id="totalDefaulters">-</div>
                <div class="card-label">Total Defaulters</div>
                <div class="nested-cards">
                    <div class="nested-card">
                        <div class="card-value" id="totalCommercialDefaulters">-</div>
                        <div class="card-label">Commercial</div>
                    </div>
                    <div class="nested-card">
                        <div class="card-value" id="totalIndustrialDefaulters">-</div>
                        <div class="card-label">Industrial</div>
                    </div>
                </div>
            </div>

            <!-- Total OSD Card with breakdown -->
            <div class="summary-card card-osd">
                <div class="card-value" id="totalOSD">-</div>
                <div class="card-label">Total OSD</div>
                <div class="nested-cards">
                    <div class="nested-card">
                        <div class="card-value" id="commercialOSD">-</div>
                        <div class="card-label">Commercial OSD</div>
                    </div>
                    <div class="nested-card">
                        <div class="card-value" id="industrialOSD">-</div>
                        <div class="card-label">Industrial OSD</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-section">
            <div class="all-filters-container">
                <label>
                    <input type="checkbox" id="schoolFilter">
                    School
                </label>
                <label>
                    <input type="checkbox" id="partyOfficeFilter">
                    Party Office
                </label>
                <label>
                    <input type="checkbox" id="towerFilter">
                    Tower
                </label>
                <!-- Filters moved into the same container -->
                <select id="regionFilter">
                    <option value="">Select Region</option>
                </select>
                <select id="divisionFilter">
                    <option value="">Select Division</option>
                </select>
                <select id="cccFilter">
                    <option value="">Select CCC</option>
                </select>
                <select id="classFilter">
                    <option value="">Select Class</option>
                </select>
            </div>
            <div class="search-and-download-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by CON_ID, Name, Address, CCC Name..." style="width: 100%;">
                </div>
                <div class="download-button-container">
                    <button class="download-button" onclick="downloadFilteredCSV()">
                        &#x2193; Download Filtered Data
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingMessage" class="loading">Loading data...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Sl</th>
                        <th>Con ID</th> <!-- Changed from CON_ID -->
                        <th>CCC</th> <!-- New CCC Column -->
                        <th>Name</th>
                        <th>MRU</th>
                        <th>Mobile</th>
                        <th>Base Class</th>
                        <th id="osdHeader" class="sortable-header">
                            OSD (â‚¹)
                            <span class="sort-icon">&#9660;</span> <!-- Down arrow for descending by default -->
                        </th>
                        <th>Locked OSD (â‚¹)</th>
                        <th id="lastPaymentHeader" class="sortable-header">
                            Last Payment
                            <span class="sort-icon"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <button id="prevPageBtn" disabled>Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPageBtn" disabled>Next</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Consumer Details</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="detail-grid">
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Summary</div>
                <div class="class-toggle" id="summaryClassToggle">
                    <button class="class-toggle-btn active" onclick="showSummaryModal('all')">All</button>
                    <button class="class-toggle-btn" onclick="showSummaryModal('C')">Commercial</button>
                    <button class="class-toggle-btn" onclick="showSummaryModal('I')">Industrial</button>
                </div>
                <button class="close-btn" onclick="closeSummaryModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab-btn active" onclick="openSummaryTab(event, 'Region')">Region</button>
                <button class="modal-tab-btn" onclick="openSummaryTab(event, 'Division')">Division</button>
                <button class="modal-tab-btn" onclick="openSummaryTab(event, 'CCC')">CCC</button>
            </div>
            <div id="Region" class="modal-tab-panel active">
                <div id="regionSummaryBody" class="modal-body-scrollable"></div>
            </div>
            <div id="Division" class="modal-tab-panel">
                <div id="divisionSummaryBody" class="modal-body-scrollable"></div>
            </div>
            <div id="CCC" class="modal-tab-panel">
                <div id="cccSummaryBody" class="modal-body-scrollable"></div>
            </div>
        </div>
    </div>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading data... Please wait.</div>
    </div>

    <script>
        // Mapping for regions, divisions, and CCCs
        const mapping = {
            "MALDA REGION": {
                "MALDA DIVISION": {"MANIKCHAK CCC": "6611101", "GOLAPGANJ CCC": "6611102", "BAISHNABNAGAR CCC": "6611103", "KALIACHAK CCC": "6611104", "MOTHABARI CCC": "6611105", "SUJAPUR CCC": "6611106", "RATHBARI CCC": "6611107", "FULBARI CCC": "6611108", "MOKDUMPUR CCC": "6611109"},
                "CHANCHAL DIVISION": {"BHALUKA CCC": "6612101", "SAMSI CCC": "6612102", "PARANPUR CCC": "6612103", "CHANCHAL CCC": "6612104", "MALATIPUR CCC": "6612105", "HARISHCHANDRAPUR CCC": "6612106", "KUSHIDA CCC": "6612107"},
                "GAZOLE DIVISION": {"GAZOL CCC": "6613101", "AIHO. CCC": "6613102", "PANDUA CCC": "6613103", "BAMONGOLA CCC": "6613104", "OLD MALDA CCC": "6613105"}
            },
            "UTTAR DINAJPUR REGION": {
                "RAIGANJ DIVISION": {"ITAHAR CCC": "6621101", "HEMTABAD CCC": "6621102", "KALIYAGANJ CCC": "6621103", "RAIGANJ CCC": "6621104", "BIRNAGAR CCC": "6621105", "KARANDIGHI CCC": "6621106"},
                "ISLAMPUR DIVISION": {"ISLAMPUR CCC": "6622101", "CHOPRA CCC": "6622102", "DALKHOLA CCC": "6622103", "GOALPOKHER CCC": "6622104", "KANKI CCC": "6622105"}
            },
            "DAKSHIN DINAJPUR REGION": {
                "BALURGHAT DIVISION": {"BALURGHAT CCC": "6631101", "TAPAN CCC": "6631102", "KUMARGANJ CCC": "6631103", "HILI CCC": "6631104", "PATIRAM CCC": "6631105"},
                "BUNIADPUR DIVISION": {"BUNIADPUR CCC": "6632101", "KUSMANDI CCC": "6632102", "HARIRAMPUR CCC": "6632103", "GANGARAMPUR CCC": "6632104"}
            }
        };

        let allData = [];
        let filteredData = [];
        let cccCodeToNames = {};
        let currentPage = 1;
        const rowsPerPage = 20; // Max 20 data per page
        let currentSortColumn = 'NOTOSD_UPD'; // Default sort by OSD
        let currentSortDirection = 'desc'; // Default sort descending

        /**
         * Creates a reverse mapping from CCC codes to their corresponding region, division, and CCC names.
         * This helps in quickly retrieving location information for a given CCC_CODE from the data.
         */
        function createCCCMapping() {
            Object.keys(mapping).forEach(region => {
                Object.keys(mapping[region]).forEach(division => {
                    Object.keys(mapping[region][division]).forEach(ccc => {
                        const code = mapping[region][division][ccc];
                        cccCodeToNames[code] = {
                            region: region,
                            division: division,
                            // Store only the CCC name without " CCC"
                            ccc: ccc.replace(' CCC', '')
                        };
                    });
                });
            });
        }

        /**
         * Formats a date string from YYYYMMDD to DD/MM/YYYY.
         * @param {string} dateStr - The date string in YYYYMMDD format.
         * @returns {string} The formatted date string or 'N/A' if invalid.
         */
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return 'N/A';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${day}/${month}/${year}`;
        }

        /**
         * Calculates the difference in months between a given date string and the current date.
         * @param {string} dateStr - The date string in YYYYMMDD format.
         * @returns {string} The difference in months (e.g., "3 months ago", "Today", "N/A").
         */
        function getMonthsSince(dateStr) {
            if (!dateStr || dateStr.length !== 8) return 'N/A';

            const year = parseInt(dateStr.substring(0, 4));
            const month = parseInt(dateStr.substring(4, 6)) - 1; // Month is 0-indexed
            const day = parseInt(dateStr.substring(6, 8));

            const pastDate = new Date(year, month, day);
            const currentDate = new Date();

            // Set to start of the day for accurate month calculation
            pastDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);

            const diffTime = Math.abs(currentDate.getTime() - pastDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 30) { // Approximately one month
                return "Within 1 month";
            }

            let months = (currentDate.getFullYear() - pastDate.getFullYear()) * 12;
            months -= pastDate.getMonth();
            months += currentDate.getMonth();

            // Adjust if the day of the month is earlier in the current month
            if (currentDate.getDate() < pastDate.getDate()) {
                months--;
            }
            
            if (months < 0) return 'N/A'; // Future date or invalid calculation
            if (months === 0) return "Within 1 month";
            return `${months} months ago`;
        }


        /**
         * Formats a given amount into Indian currency format (Lakhs, Crores) for better readability.
         * @param {number|string} amount - The numeric amount to format.
         * @returns {string} The formatted currency string.
         */
        function formatIndianCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) return '0';

            const crore = 10000000;
            const lakh = 100000;

            if (num >= crore) {
                return (num / crore).toFixed(2) + ' Cr';
            } else if (num >= lakh) {
                return (num / lakh).toFixed(2) + ' L';
            } else {
                return new Intl.NumberFormat('en-IN').format(num);
            }
        }

        /**
         * Shows the loading overlay.
         */
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        /**
         * Loads and parses TSV data from a Google Sheet.
         * Initializes filters, updates summary cards, and renders the table upon successful data load.
         * Handles loading and error messages.
         */
        async function loadData() {
            showLoadingOverlay(); // Show loading overlay at the start
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQOynlOrqc0iXUKYDgqh-tTjIgDA5WidJDcDhYM7MhfKIZzZ7iduFD2LN4fYRXmVvcLCz1X-OJfcmRx/pub?gid=0&single=true&output=tsv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tsvData = await response.text();
                
                // Parse TSV data
                const lines = tsvData.trim().split('\n');
                const headers = lines[0].split('\t').map(h => h.trim());
                
                allData = lines.slice(1).map(line => {
                    const values = line.split('\t');
                    const record = {};
                    headers.forEach((header, index) => {
                        record[header] = values[index] ? values[index].trim() : '';
                    });
                    return record;
                });

                createCCCMapping();
                initializeFilters();
                filterAndSortData(); // Initial filter and render
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error loading data. Please try again later.';
            } finally {
                hideLoadingOverlay(); // Hide loading overlay when done (success or error)
            }
        }

        /**
         * Initializes the filter dropdowns (Region, Division, CCC, Base Class)
         * and sets up event listeners for cascading filters and data filtering.
         */
        function initializeFilters() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            const cccFilter = document.getElementById('cccFilter');
            const classFilter = document.getElementById('classFilter');
            const schoolFilter = document.getElementById('schoolFilter');
            const partyOfficeFilter = document.getElementById('partyOfficeFilter');
            const towerFilter = document.getElementById('towerFilter'); // New Tower filter

            // Populate regions
            Object.keys(mapping).forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });

            // Get unique base classes
            const baseClasses = [...new Set(allData.map(item => item.BASE_CLASS).filter(cls => cls))];
            baseClasses.sort().forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classFilter.appendChild(option);
            });

            // Set placeholders for filters
            regionFilter.querySelector('option[value=""]').textContent = 'Select Region';
            divisionFilter.querySelector('option[value=""]').textContent = 'Select Division';
            cccFilter.querySelector('option[value=""]').textContent = 'Select CCC';
            classFilter.querySelector('option[value=""]').textContent = 'Select Class';

            // Event listeners for cascading filters
            regionFilter.addEventListener('change', updateDivisionFilter);
            divisionFilter.addEventListener('change', updateCCCFilter);
            
            // Filter event listeners for all filters and search input
            regionFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            divisionFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            cccFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            classFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; filterAndSortData(); });
            schoolFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            partyOfficeFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); });
            towerFilter.addEventListener('change', () => { currentPage = 1; filterAndSortData(); }); // New Tower filter listener


            // OSD Header sort listener
            function setupSortableHeaders() {
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const sortKey = header.id === 'osdHeader' ? 'NOTOSD_UPD' : 'LAST_PDT';
                        
                        if (currentSortColumn === sortKey) {
                            // If same column, toggle direction
                            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            // If new column, set it and default to descending
                            currentSortColumn = sortKey;
                            currentSortDirection = 'desc';
                        }
                        filterAndSortData();
                    });
                });
            }
            setupSortableHeaders();

            // Pagination button event listeners
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        }

        /**
         * Updates the Division filter dropdown based on the selected Region.
         */
        function updateDivisionFilter() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            
            divisionFilter.innerHTML = '<option value="">Select Division</option>';
            
            if (regionFilter.value) {
                Object.keys(mapping[regionFilter.value]).forEach(division => {
                    const option = document.createElement('option');
                    option.value = division;
                    option.textContent = division;
                    divisionFilter.appendChild(option);
                });
            }
            
            updateCCCFilter(); // Also update CCC filter when division changes
        }

        /**
         * Updates the CCC filter dropdown based on the selected Region and Division.
         */
        function updateCCCFilter() {
            const regionFilter = document.getElementById('regionFilter');
            const divisionFilter = document.getElementById('divisionFilter');
            const cccFilter = document.getElementById('cccFilter');
            
            cccFilter.innerHTML = '<option value="">Select CCC</option>';
            
            if (regionFilter.value && divisionFilter.value) {
                Object.keys(mapping[regionFilter.value][divisionFilter.value]).forEach(ccc => {
                    const option = document.createElement('option');
                    option.value = ccc;
                    option.textContent = ccc;
                    cccFilter.appendChild(option);
                });
            }
        }

        /**
         * Updates the summary cards with total defaulters, total OSD, and their commercial/industrial breakdowns.
         * Also updates the last updated date.
         */
        function updateSummary() {
            const totalDefaulters = filteredData.length; // Now based on filteredData
            let totalOSD = 0;
            let commercialDefaulters = 0;
            let industrialDefaulters = 0;
            let commercialOSD = 0;
            let industrialOSD = 0;

            // Calculate totals based on currently filtered data
            filteredData.forEach(item => {
                const notOsd = parseFloat(item.NOTOSD_UPD || 0);
                totalOSD += notOsd;

                if (item.BASE_CLASS === 'C') { // Commercial
                    commercialDefaulters++;
                    commercialOSD += notOsd;
                } else if (item.BASE_CLASS === 'I') { // Industrial
                    industrialDefaulters++;
                    industrialOSD += notOsd;
                }
            });
            
            // Find max date from UPD_DT from allData for overall last updated date
            const maxDate = allData.reduce((max, item) => {
                const date = item.UPD_DT;
                if (date && date > max) return date;
                return max;
            }, '');

            document.getElementById('totalDefaulters').textContent = formatIndianCurrency(totalDefaulters);
            document.getElementById('totalOSD').textContent = formatIndianCurrency(totalOSD);
            document.getElementById('totalCommercialDefaulters').textContent = formatIndianCurrency(commercialDefaulters);
            document.getElementById('totalIndustrialDefaulters').textContent = formatIndianCurrency(industrialDefaulters);
            document.getElementById('commercialOSD').textContent = formatIndianCurrency(commercialOSD);
            document.getElementById('industrialOSD').textContent = formatIndianCurrency(industrialOSD);
            document.getElementById('updateDate').textContent = `Last Updated: ${formatDate(maxDate)}`;
        }

        /**
         * Filters and sorts the `allData` based on selected region, division, CCC, base class, search term, and OSD.
         * Updates `filteredData` and then calls `renderTable` and `updateSummary`.
         */
        function filterAndSortData() {
            const regionFilter = document.getElementById('regionFilter').value;
            const divisionFilter = document.getElementById('divisionFilter').value;
            const cccFilter = document.getElementById('cccFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const schoolFilterChecked = document.getElementById('schoolFilter').checked;
            const partyOfficeFilterChecked = document.getElementById('partyOfficeFilter').checked;
            const towerFilterChecked = document.getElementById('towerFilter').checked; // Get Tower filter state

            filteredData = allData.filter(item => {
                // Get location info for this CCC_CODE
                const locationInfo = cccCodeToNames[item.CCC_CODE];
                
                // Region filter
                if (regionFilter && (!locationInfo || locationInfo.region !== regionFilter)) {
                    return false;
                }
                
                // Division filter
                if (divisionFilter && (!locationInfo || locationInfo.division !== divisionFilter)) {
                    return false;
                }
                
                // CCC filter
                if (cccFilter && (!locationInfo || locationInfo.ccc !== cccFilter.replace(' CCC', ''))) { // Compare with CCC name without ' CCC'
                    return false;
                }
                
                // Base class filter
                if (classFilter && item.BASE_CLASS !== classFilter) {
                    return false;
                }
                
                // Search filter (CON_ID, Name, Address)
                if (searchTerm) { // Also search by CCC Name
                    const searchFields = [
                        item.CON_ID,
                        item.NAME,
                        item.ADDRESS
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        if (!locationInfo || !locationInfo.ccc.toLowerCase().includes(searchTerm))
                        return false;
                    }
                }

                // School filter
                if (schoolFilterChecked) {
                    const nameLower = (item.NAME || '').toLowerCase();
                    const addressLower = (item.ADDRESS || '').toLowerCase();
                    if (!(nameLower.includes('school') || addressLower.includes('school'))) {
                        return false;
                    }
                }

                // Party Office filter
                if (partyOfficeFilterChecked) {
                    const nameLower = (item.NAME || '').toLowerCase();
                    const addressLower = (item.ADDRESS || '').toLowerCase();
                    if (!(nameLower.includes('party') || addressLower.includes('party'))) {
                        return false;
                    }
                }

                // Tower filter
                if (towerFilterChecked) {
                    const nameLower = (item.NAME || '').toLowerCase();
                    const addressLower = (item.ADDRESS || '').toLowerCase();
                    const towerKeywords = ['indus', 'bharti', 'jio', 'bsnl' ,'telecom'];
                    const foundTowerKeyword = towerKeywords.some(keyword => 
                        nameLower.includes(keyword) || addressLower.includes(keyword)
                    );
                    if (!foundTowerKeyword) {
                        return false;
                    }
                }
                
                return true;
            });

            // Sort data
            filteredData.sort((a, b) => {
                // Use parseInt for date strings (YYYYMMDD) and parseFloat for numbers
                const valA = currentSortColumn === 'LAST_PDT' ? parseInt(a[currentSortColumn] || '0') : parseFloat(a[currentSortColumn] || 0);
                const valB = currentSortColumn === 'LAST_PDT' ? parseInt(b[currentSortColumn] || '0') : parseFloat(b[currentSortColumn] || 0);

                if (currentSortDirection === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // Update sort icons for all sortable headers
            document.querySelectorAll('.sortable-header').forEach(header => {
                const sortIcon = header.querySelector('.sort-icon');
                const headerSortKey = header.id === 'osdHeader' ? 'NOTOSD_UPD' : 'LAST_PDT';

                if (currentSortColumn === headerSortKey) {
                    if (currentSortDirection === 'asc') {
                        sortIcon.innerHTML = '&#9650;'; // Up arrow
                        header.classList.remove('sort-desc');
                        header.classList.add('sort-asc');
                    } else {
                        sortIcon.innerHTML = '&#9660;'; // Down arrow
                        header.classList.remove('sort-asc');
                        header.classList.add('sort-desc');
                    }
                } else {
                    sortIcon.innerHTML = ''; // Clear icon for non-active sort columns
                }
            });


            currentPage = 1; // Reset to first page after filtering and sorting
            updateSummary(); // Update summary based on newly filtered data
            renderTable(); // Render table with filtered data
        }

        /**
         * Renders the data table with pagination. Displays a subset of `filteredData`
         * based on `currentPage` and `rowsPerPage`.
         */
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.onclick = () => showDetails(item);
                
                // Get location info for this CCC_CODE for display in the table
                const locationInfo = cccCodeToNames[item.CCC_CODE];

                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td>${item.CON_ID || 'N/A'}</td>
                    <td>${locationInfo ? locationInfo.ccc : 'N/A'}</td> <!-- New CCC Column, now without " CCC" -->
                    <td>${item.NAME || 'N/A'}</td> <!-- Display Name -->
                    <td>${item.MRU || 'N/A'}</td>
                    <td>${item.REG_MOB_NO || 'N/A'}</td>
                    <td>${item.BASE_CLASS || 'N/A'}</td>
                    <td class="amount">${formatIndianCurrency(item.NOTOSD_UPD)}</td>
                    <td class="amount">${formatIndianCurrency(item.LOCKED_OSD)}</td>
                    <td class="last-payment">${getMonthsSince(item.LAST_PDT)}</td> <!-- Changed to months since -->
                `;
                
                tbody.appendChild(row);
            });

            updatePaginationControls();
        }

        /**
         * Updates the state of pagination buttons (Previous/Next) and page information.
         */
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        /**
         * Converts an array of objects to a CSV string.
         * @param {Array<Object>} data - The array of data objects.
         * @param {Array<string>} headers - The array of header keys to use for CSV columns.
         * @returns {string} The CSV formatted string.
         */
        function convertToCSV(data, headers) {
            const csvRows = [];
            // Add header row
            csvRows.push(headers.join(','));

            // Add data rows
            for (const row of data) {
                const values = headers.map(header => {
                    const val = row[header];
                    // Handle potential commas or newlines in data by enclosing in quotes
                    const escaped = ('' + val).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }

        /**
         * Downloads the filteredData as a CSV file.
         */
        function downloadFilteredCSV() {
            if (filteredData.length === 0) {
                console.warn("No filtered data to download.");
                return;
            }

            // Get all unique headers from the first item of allData, to ensure all original columns are present
            const headers = Object.keys(allData[0]);
            const csvString = convertToCSV(filteredData, headers);
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rem_osd_dashboard_filtered_data.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Displays a modal with detailed information about a selected consumer.
         * Formats OSD values using `formatIndianCurrency`.
         * @param {object} item - The data object for the selected consumer.
         */
        function showDetails(item) {
            const locationInfo = cccCodeToNames[item.CCC_CODE];
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="detail-label">Consumer ID:</div>
                <div class="detail-value">${item.CON_ID || 'N/A'}</div>
                
                <div class="detail-label">Name:</div>
                <div class="detail-value">${item.NAME || 'N/A'}</div>
                
                <div class="detail-label">Address:</div>
                <div class="detail-value">${item.ADDRESS || 'N/A'}</div>
                
                <div class="detail-label">Region:</div>
                <div class="detail-value">${locationInfo ? locationInfo.region : 'N/A'}</div>
                
                <div class="detail-label">Division:</div>
                <div class="detail-value">${locationInfo ? locationInfo.division : 'N/A'}</div>
                
                <div class="detail-label">CCC:</div>
                <div class="detail-value">${locationInfo ? locationInfo.ccc : 'N/A'}</div>
                
                <div class="detail-label">MRU:</div>
                <div class="detail-value">${item.MRU || 'N/A'}</div>

                <div class="detail-label">Mobile No:</div>
                <div class="detail-value">${item.REG_MOB_NO || 'N/A'}</div>

                <div class="detail-label">Base Class:</div>
                <div class="detail-value">${item.BASE_CLASS || 'N/A'}</div>
                
                <div class="detail-label">Government Status:</div>
                <div class="detail-value">${item.GOVT_STAT || 'N/A'}</div>
                
                <div class="detail-label">Outstanding Dues:</div>
                <div class="detail-value">${formatIndianCurrency(item.NOTOSD_UPD)}</div>
                
                <div class="detail-label">Locked OSD:</div>
                <div class="detail-value">${formatIndianCurrency(item.LOCKED_OSD)}</div>
                
                <div class="detail-label">Bill Date:</div>
                <div class="detail-value">${formatDate(item.BDATE)}</div>
                
                <div class="detail-label">Last Payment:</div>
                <div class="detail-value">${getMonthsSince(item.LAST_PDT)} (Original: ${formatDate(item.LAST_PDT)})</div> <!-- Changed to months since -->
                
                <div class="detail-label">Report Date:</div>
                <div class="detail-value">${formatDate(item.UPD_DT)}</div>
                
                <div class="detail-label">Notice Issue Date:</div>
                <div class="detail-value">${formatDate(item.NOT_ISSUE_DT)}</div>
                
                <div class="detail-label">Installation No:</div>
                <div class="detail-value">${item.INST_NO || 'N/A'}</div>
                
                <div class="detail-label">Class Description:</div>
                <div class="detail-value">${item.CLASS_DESC || 'N/A'}</div>
                
                <div class="detail-label">Disconnection Flag:</div>
                <div class="detail-value">${item.DISC_FLAG || 'N/A'}</div>
            `;
            
            document.getElementById('detailModal').style.display = 'block';
        }

        /**
         * Calculates and displays a summary in a modal.
         * The summary is based on the currently filtered data.
         */
        function showSummaryModal(classType = 'all') {
            // Update active state on toggle buttons
            document.querySelectorAll('#summaryClassToggle .class-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`#summaryClassToggle .class-toggle-btn[onclick="showSummaryModal('${classType}')"]`).classList.add('active');

            let dataForSummary = filteredData;
            const filteredByClass = classType === 'all' ? dataForSummary : dataForSummary.filter(item => item.BASE_CLASS === classType);

            // --- CCC Summary ---
            const cccSummary = filteredByClass.reduce((acc, item) => {
                const cccCode = item.CCC_CODE;
                const locationInfo = cccCodeToNames[cccCode];
                const cccName = locationInfo ? locationInfo.ccc : 'Unknown CCC';
                const osd = parseFloat(item.NOTOSD_UPD || 0);

                if (!acc[cccName]) {
                    acc[cccName] = { count: 0, totalOSD: 0 };
                }

                acc[cccName].count++;
                acc[cccName].totalOSD += osd;

                return acc;
            }, {});

            // Convert to array and sort by total OSD descending
            const cccSummaryArray = Object.keys(cccSummary).map(cccName => ({
                cccName: cccName,
                count: cccSummary[cccName].count,
                totalOSD: cccSummary[cccName].totalOSD
            })).sort((a, b) => b.totalOSD - a.totalOSD);

            const cccModalBody = document.getElementById('cccSummaryBody');
            let cccTableHTML = `<table class="summary-modal-table">
                                <thead>
                                    <tr>
                                        <th>Sl</th>
                                        <th>CCC Name</th>
                                        <th>Defaulter Count</th>
                                        <th>Total OSD (â‚¹)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            cccSummaryArray.forEach((item, index) => {
                cccTableHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${item.cccName}</td>
                                <td>${item.count}</td>
                                <td class="amount">${formatIndianCurrency(item.totalOSD)}</td>
                              </tr>`;
            });
            cccTableHTML += `</tbody></table>`;
            cccModalBody.innerHTML = cccTableHTML;

            // --- Render other summaries ---
            renderRegionSummary(filteredByClass);
            renderDivisionSummary(filteredByClass);

            document.getElementById('summaryModal').style.display = 'block';
        }

        function renderRegionSummary(data) {
            const summary = data.reduce((acc, item) => {
                const locationInfo = cccCodeToNames[item.CCC_CODE];
                if (!locationInfo) return acc;
                const regionName = locationInfo.region;
                const osd = parseFloat(item.NOTOSD_UPD || 0);

                if (!acc[regionName]) acc[regionName] = { count: 0, totalOSD: 0 };
                acc[regionName].count++;
                acc[regionName].totalOSD += osd;
                return acc;
            }, {});

            const summaryArray = Object.keys(summary).map(name => ({ name, ...summary[name] })).sort((a, b) => b.totalOSD - a.totalOSD);
            const body = document.getElementById('regionSummaryBody');
            body.innerHTML = createSummaryTable(summaryArray, 'Region');
        }

        function renderDivisionSummary(data) {
            const summary = data.reduce((acc, item) => {
                const locationInfo = cccCodeToNames[item.CCC_CODE];
                if (!locationInfo) return acc;
                const divisionName = locationInfo.division;
                const osd = parseFloat(item.NOTOSD_UPD || 0);

                if (!acc[divisionName]) acc[divisionName] = { count: 0, totalOSD: 0 };
                acc[divisionName].count++;
                acc[divisionName].totalOSD += osd;
                return acc;
            }, {});

            const summaryArray = Object.keys(summary).map(name => ({ name, ...summary[name] })).sort((a, b) => b.totalOSD - a.totalOSD);
            const body = document.getElementById('divisionSummaryBody');
            body.innerHTML = createSummaryTable(summaryArray, 'Division');
        }

        /**
         * Helper function to create a summary table HTML string.
         * @param {Array} summaryArray - The sorted array of summary data.
         * @param {string} headerName - The name for the first column header (e.g., 'Region').
         * @returns {string} The HTML string for the table.
         */
        function createSummaryTable(summaryArray, headerName) {
            let tableHTML = `<table class="summary-modal-table">
                                <thead>
                                    <tr>
                                        <th>Sl</th>
                                        <th>${headerName} Name</th>
                                        <th>Defaulter Count</th>
                                        <th>Total OSD (â‚¹)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            summaryArray.forEach((item, index) => {
                tableHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${item.name}</td>
                                <td>${item.count}</td>
                                <td class="amount">${formatIndianCurrency(item.totalOSD)}</td>
                              </tr>`;
            });

            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        /**
         * Handles tab switching within the summary modal.
         * @param {Event} evt - The click event.
         * @param {string} tabName - The name of the tab to open.
         */
        function openSummaryTab(evt, tabName) {
            // Get all elements with class="modal-tab-panel" and hide them
            const tabPanels = document.getElementsByClassName("modal-tab-panel");
            for (let i = 0; i < tabPanels.length; i++) {
                tabPanels[i].style.display = "none";
                tabPanels[i].classList.remove("active");
            }

            // Get all elements with class="modal-tab-btn" and remove the "active" class
            const tabButtons = document.getElementsByClassName("modal-tab-btn");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            const currentTabPanel = document.getElementById(tabName);
            if (currentTabPanel) {
                currentTabPanel.style.display = "block";
                currentTabPanel.classList.add("active");
            }
            evt.currentTarget.classList.add("active");
        }

        /**
         * Toggles the visibility of the summary cards section.
         */
        function toggleSummaryCards() {
            const summaryContainer = document.getElementById('summaryCardsContainer');
            const header = summaryContainer.previousElementSibling; // The .collapsible-header
            
            summaryContainer.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }


        /**
         * Closes the detail modal.
         */
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        /**
         * Closes the summary modal.
         */
        function closeSummaryModal() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        /**
         * Closes the modal when clicking outside of its content.
         * @param {Event} event - The click event object.
         */
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const summaryModal = document.getElementById('summaryModal');
            if (event.target === detailModal) {
                closeModal();
            } else if (event.target === summaryModal) {
                closeSummaryModal();
            }
        }

        // Initialize the application when the window loads
        window.onload = loadData;
    </script>
</body>
</html>
