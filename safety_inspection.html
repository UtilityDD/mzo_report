<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Safety Inspection Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* Reset and Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 5px;
      padding-top: 60px;
      /* to prevent overlap under sticky header */
    }


    /* Header */
    .header {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
      padding: 5px 12px;
      margin: 0;
      border-radius: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: block;
      text-align: center;
      align-items: center;
      flex-wrap: wrap;
      /* Allow wrapping on small screens */
    }

    .header h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .report-period {
      background-color: rgba(255, 255, 255, 0.15);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      display: inline-block;
      margin-top: 5px;
    }


    /* Dashboard Sections */

    .dashboard-section {
      background: white;
      padding: 5px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
    }

    .dashboard-section h2 {
      font-size: 16px;
      color: #1976D2;
      margin-bottom: 10px;
      border-bottom: 2px solid #eee;
      padding-bottom: 8px;
    }

    .filter-tabs-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      flex-wrap: nowrap;
      padding-bottom: 10px;
      /* For scrollbar space */
      margin-bottom: 5px;
      -webkit-overflow-scrolling: touch;
      /* Smooth scrolling on mobile */
    }

    /* Hide scrollbar but keep functionality */
    .filter-tabs-container::-webkit-scrollbar {
      display: none;
    }

    .filter-tabs-container {
      -ms-overflow-style: none;
      /* IE and Edge */
      scrollbar-width: none;
      /* Firefox */
    }

    /* Category Tabs */
    .category-tab {
      background-color: #e0e0e0;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      color: #555;
      transition: all 0.3s ease;
      min-width: 80px;
      text-align: center;
    }

    .category-tab:hover {
      background-color: #d0d0d0;
    }

    .category-tab.active {
      background-color: #2196F3;
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }


    /* Stat Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 8px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border-left: 5px solid;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
      z-index: 1;
      pointer-events: none;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-card .value {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 11px;
      color: #666;
    }

    .stat-card.total-inspected {
      border-left-color: #4CAF50;
    }

    .stat-card.total-rectified {
      border-left-color: #2196F3;
    }

    .stat-card.week-inspected {
      border-left-color: #00BCD4;
    }

    .stat-card.week-rectified {
      border-left-color: #9C27B0;
    }

    .stat-card.avg-inspected {
      border-left-color: #FFC107;
      /* Amber */
    }

    .stat-card.avg-rectified {
      border-left-color: #673AB7;
      /* Deep Purple */
    }


    /* Charts */
    .charts-section {
      display: grid;
      grid-template-columns: 1fr;
      /* Default to single column */
      gap: 15px;
    }

    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      /* Needed for chart responsiveness */
      height: 280px;
      /* Set a consistent height for chart containers */
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Mini Tables (details) */
    details {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-top: 15px;
      overflow: hidden;
    }

    summary {
      padding: 12px 15px;
      font-weight: bold;
      cursor: pointer;
      background-color: #f0f0f0;
      border-bottom: 1px solid #e0e0e0;
      list-style: none;
      /* Remove default arrow */
    }

    summary::-webkit-details-marker {
      display: none;
      /* Remove default arrow for Webkit */
    }

    summary::after {
      content: '‚ñº';
      /* Custom arrow */
      float: right;
      transition: transform 0.3s ease;
    }

    details[open] summary::after {
      transform: rotate(180deg);
    }

    .table-responsive {
      max-height: 400px;
      overflow: auto;
      /* Enables both vertical and horizontal scrolling */
      width: 100%;
    }

    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: white;
    }

    .mini-table th,
    .mini-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .mini-table th {
      background-color: #f5f5f5;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      /* Make header sticky */
      z-index: 2;
    }

    .mini-table th.sortable-header {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .mini-table th.sortable-header:hover {
      background-color: #e0f2ff;
    }

    /* Sticky first column for responsive tables */
    .mini-table th:first-child,
    .mini-table td:first-child {
      position: -webkit-sticky;
      /* For Safari */
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .mini-table th:first-child {
      z-index: 3;
      /* To stay on top of the body cells */
      background-color: #f5f5f5;
      /* Match header background */
    }

    .mini-table td:first-child {
      background-color: #fff;
      /* Match row background */
    }

    .mini-table tbody tr:hover td:first-child {
      background-color: #f0f0f0;
      /* Match hovered row background */
    }

    .mini-table tbody tr:hover {
      background-color: #f0f0f0;
    }

    .mini-table tbody tr.clickable-row:hover {
      background-color: #e9f5ff;
      cursor: pointer;
    }

    .status-inspected {
      color: #d32f2f;
      font-weight: bold;
    }


    /* Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      /* Darker overlay */
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      /* Adjust margin for better vertical alignment */
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      width: 90%;
      max-width: 700px;
      animation: slideIn 0.3s;
      max-height: 90vh;
      /* Limit modal height */
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .close-button:hover,
    .close-button:focus {
      color: #333;
      text-decoration: none;
    }

    .details-list {
      list-style: none;
      padding: 0;
    }

    .details-list li {
      background-color: #f9f9f9;
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .details-list li strong {
      color: #1976D2;
      font-size: 15px;
    }

    .details-list li p {
      margin-top: 5px;
      font-size: 14px;
      color: #555;
    }

    .details-list li a {
      color: #2196F3;
      text-decoration: none;
    }

    .details-list li a:hover {
      text-decoration: underline;
    }


    /* Map Modal Specific */
    .map-container {
      position: relative;
      width: 100%;
      padding-top: 75%;
      /* 4:3 Aspect Ratio (height / width * 100) */
      background-color: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .map-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .map-actions {
      margin-top: 15px;
      text-align: center;
    }

    .map-actions a {
      display: inline-block;
      background-color: #2196F3;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }

    .map-actions a:hover {
      background-color: #1976D2;
    }


    /* Keyframe Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }


    /* Responsive Design */
    @media (min-width: 768px) {
      /* Removed the two-column layout for charts to stack them vertically */
    }

    @media (max-width: 767px) {
      body {
        font-size: 14px;
        /* Smaller base font for mobile */
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header h1 {
        font-size: 18px;
      }

      .header p {
        font-size: 12px;
      }

      .container {
        padding: 10px;
        padding-top: 90px;
        /* Adjusted for new header height */
      }

      .category-tab {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 70px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-card .value {
        font-size: 24px;
      }

      .stat-card .label {
        font-size: 11px;
      }

      .modal-content {
        margin: 10px auto;
        padding: 20px;
        width: 95%;
        max-height: 95vh;
      }

      .modal-header h3 {
        font-size: 16px;
      }

      .mini-table th,
      .mini-table td {
        padding: 8px 10px;
        font-size: 11px;
      }

      .table-responsive {
        max-height: 300px;
      }

      .details-list li {
        padding: 10px;
      }

      .details-list li strong {
        font-size: 13px;
      }

      .details-list li p {
        font-size: 12px;
      }
    }

    .alert-icon {
      animation: pulse 1s infinite;
      font-size: 20px;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.3);
      }

      100% {
        transform: scale(1);
      }
    }

    .view-options-container {
      background-color: #fff3e0; /* Light orange/yellow to grab attention */
      border: 1px solid #ffe0b2;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      gap: 30px;
      animation: pulse-bg 2.5s infinite;
    }

    @keyframes pulse-bg {
      0% {
        box-shadow: 0 0 4px rgba(255, 183, 77, 0.3);
      }
      50% {
        box-shadow: 0 0 12px rgba(255, 183, 77, 0.7);
      }
      100% {
        box-shadow: 0 0 4px rgba(255, 183, 77, 0.3);
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <h1>Safety Inspection Dashboard</h1>
      <p class="report-period" id="reportPeriodText">Report from 21/10/2024 to 25/08/2025</p>
    </div>
  </header>

  <div class="container">
    <div class="loading" id="loading">
      <p>Loading data, please wait...</p>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">

      <div id="viewOptions" class="view-options-container">
        <label style="cursor: pointer; display: flex; align-items: center; font-size: 14px; font-weight: 500;">
          <input type="checkbox" id="weeklyCheckbox" style="margin-right: 5px; transform: scale(1.2);"> Weekly View
        </label>
        <label style="cursor: pointer; display: flex; align-items: center; font-size: 14px; font-weight: 500;">
          <input type="checkbox" id="chartCheckbox" style="margin-right: 5px; transform: scale(1.2);"> Chart View
        </label>
      </div>

      <div class="dashboard-section" id="dropdownFiltersContainer"
        style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <div>
          <label for="regionFilter" style="font-weight: bold; font-size: 12px; color: #555;">Region:</label>
          <select id="regionFilter" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;"></select>
        </div>
        <div>
          <label for="divisionFilter" style="font-weight: bold; font-size: 12px; color: #555;">Division:</label>
          <select id="divisionFilter" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;"></select>
        </div>
        <div>
          <label for="cccFilter" style="font-weight: bold; font-size: 12px; color: #555;">CCC:</label>
          <select id="cccFilter" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;"></select>
        </div>
      </div>

      <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <div class="stat-card total-inspected">
          <div class="value" id="totalInspected">0</div>
          <div class="label">Total Inspected</div>
        </div>
        <div class="stat-card total-rectified">
          <div class="value" id="totalRectified">0 <span id="totalRectifiedPercent"
              style="font-size: 16px; color: #555; font-weight: 500;">(0%)</span></div>
          <div class="label">Total Rectified</div>
        </div>
        <div class="stat-card avg-inspected">
          <div class="value" id="avgInspected">0.0</div>
          <div class="label">Weekly Average Inspection</div>
        </div>
        <div class="stat-card week-inspected">
          <div class="value" id="currentWeekInspectedCard">0</div>
          <div class="label" id="currentWeekLabel">Current Week Inspections</div>
        </div>
      </div>

      <div class="charts-section">
        <div id="mainTableSection" class="dashboard-section">
          <div id="weeklyOfficeFilterContainer" class="dashboard-section"
            style="display: none; padding: 10px; margin-top: -10px; margin-bottom: 10px;">
            <label for="weeklyOfficeFilter" style="margin-right: 10px; font-weight: bold; color: #555;">Filter by
              Office:</label>
            <select id="weeklyOfficeFilter" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;"></select>
          </div>
          <div id="tableContainer">
            <h2 id="tableTitle">CCC-Wise Status</h2>
            <div class="table-responsive">
              <table class="mini-table">
                <thead id="officeTableHeaderContainer">
                </thead>
                <tbody id="officeTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="chartViewContainer" class="chart-container" style="display: none;">
          <h2>Inspection vs Rectification Timeline</h2>
          <canvas id="timelineChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    let inspectionData = [];
    let timelineChart;
    let currentModalData = [];
    let lastUpdatedDate = null;
    let currentRegionalFilter = "all"; // NEW: Regional filter
    let currentDivisionFilter = "all"; // NEW: Division filter
    let currentCCCFilter = "all"; // NEW: CCC filter
    let showWeekly = false; // NEW: for checkbox
    let showChart = false; // NEW: for checkbox
    let sortColumn = 'total';
    let sortDirection = 'desc';
    let totalReportWeeks = 1; // NEW: To hold the fixed number of weeks for the entire report

    // NEW: Global variables for hierarchy lookups
    let officeDetailsMap = {};
    let regionalOfficeToDivisionsMap = {};
    let divisionToCCCsMap = {};
    let dynamicOfficeHierarchy = {}; // This will hold the structured hierarchy for UI filters



    // NEW: The mapping string provided by the user
    const newMappingString = `CODE	OFFICE NAME
6610000	MALDA REGION
1111111	MALDA DIV.
6611000	MALDA DIVISIOIN
6611101	MANIKCHAK CCC
6611102	GOLAPGANJ CCC
6611103	BAISHNABNAGAR CCC
6611104	KALIACHAK CCC
6611105	MOTHABARI CCC
6611106	SUJAPUR CCC
6611107	RATHBARI CCC
6611108	FULBARI CCC
6611109	MOKDUMPUR CCC
2222222	CHANCHAL DIV.
6612000	CHANCHAL DIVISION
6612101	BHALUKA CCC
6612102	SAMSI CCC
6612103	PARANPUR CCC
6612104	CHANCHAL CCC
6612105	MALATIPUR CCC
6612106	HARISHCHANDRAPUR CCC
6612107	KUSHIDA CCC
3333333	GAZOLE DIV.
6613000	GAZOLE DIVISION
6613101	GAZOL CCC
6613102	AIHO. CCC
6613103	PANDUA CCC
6613104	BAMONGOLA CCC
6613105	OLD MALDA CCC
6620000	UTTAR DINAJPUR REGION
4444444	RAIGANJ  DIV.
6621000	RAIGANJ  DIVISION
6621101	ITAHAR CCC
6621102	HEMTABAD CCC
6621103	KALIYAGANJ CCC
6621104	RAIGANJ CCC
6621105	BIRNAGAR CCC
6621106	KARANDIGHI CCC
5555555	ISLAMPUR DIV.
6622000	ISLAMPUR DIVISION
6622101	ISLAMPUR CCC
6622102	CHOPRA CCC
6622103	DALKHOLA CCC
6622104	GOALPOKHER CCC
6622105	KANKI CCC
6630000	DAKSHIN DINAJPUR REGION
6666666	BALURGHAT DIV.
6631000	BALURGHAT DIVISION
6631101	BALURGHAT CCC
6631102	TAPAN CCC
6631103	KUMARGANJ CCC
6631104	HILI CCC
6631105	PATIRAM CCC
7777777	BUNIADPUR DIV.
6632000	BUNIADPUR DIVISION
6632101	BUNIADPUR CCC
6632102	KUSMANDI CCC
6632103	HARIRAMPUR CCC
6632104	GANGARAMPUR CCC`;


    // NEW: Function to build the hierarchy maps from the provided mapping string
    function buildHierarchyMaps(mappingText) {
      const lines = mappingText.trim().split('\n').slice(1); // Skip header
      const parsedMapping = lines.map(line => {
        const parts = line.split('\t');
        return {
          code: parts[0].trim(),
          name: parts[1].trim()
        };
      });

      officeDetailsMap = {};
      regionalOfficeToDivisionsMap = {};
      divisionToCCCsMap = {};

      // First pass: Populate officeDetailsMap with types and initial data
      parsedMapping.forEach(item => {
        const isRegionalOffice = item.name.endsWith(' REGION');
        const isShortDivision = item.name.endsWith('DIV.'); // Preferred for UI and logic
        const isLongDivision = item.name.endsWith('DIVISION') && !isRegionalOffice; // Alternative division name, map to short
        const isCCC = item.name.endsWith('CCC');

        let type;
        if (isRegionalOffice) {
          type = 'regionalOffice';
        } else if (isShortDivision) {
          type = 'division'; // Use 'division' for both short and long, but prefer short for display
        } else if (isLongDivision) {
          type = 'divisionLong'; // Mark as long to link later
        } else if (isCCC) {
          type = 'ccc';
        } else {
          type = 'unknown';
        }

        officeDetailsMap[item.code] = {
          name: item.name, // The name as it appears in the mapping
          type: type,
          code: item.code,
          parentCode: null, // Will populate in second pass
          alternativeCode: null // For linking long division names to short codes
        };
      });

      // Second pass: Establish parent relationships and link long division names to short codes
      parsedMapping.forEach(item => {
        const details = officeDetailsMap[item.code];

        if (details.type === 'division') { // Short division names
          // Determine parent Regional Office Code based on prefix or explicit link
          let regionalOfficeCode = null;
          if (item.code === '1111111' || item.code === '2222222' || item.code === '3333333') regionalOfficeCode = '6610000'; // MALDA RO
          else if (item.code === '4444444' || item.code === '5555555') regionalOfficeCode = '6620000'; // UTTAR DINAJPUR RO
          else if (item.code === '6666666' || item.code === '7777777') regionalOfficeCode = '6630000'; // DAKSHIN DINAJPUR RO

          details.parentCode = regionalOfficeCode;
          if (regionalOfficeCode) {
            if (!regionalOfficeToDivisionsMap[regionalOfficeCode]) regionalOfficeToDivisionsMap[regionalOfficeCode] = [];
            regionalOfficeToDivisionsMap[regionalOfficeCode].push(item.code);
          }
        } else if (details.type === 'divisionLong') {
          // Find the corresponding short division code and link it
          let shortDivisionCode = null;
          if (item.code === '6611000') shortDivisionCode = '1111111'; // MALDA DIV.
          else if (item.code === '6612000') shortDivisionCode = '2222222'; // CHANCHAL DIV.
          else if (item.code === '6613000') shortDivisionCode = '3333333'; // GAZOLE DIV.
          else if (item.code === '6621000') shortDivisionCode = '4444444'; // RAIGANJ DIV.
          else if (item.code === '6622000') shortDivisionCode = '5555555'; // ISLAMPUR DIV.
          else if (item.code === '6631000') shortDivisionCode = '6666666'; // BALURGHAT DIV.
          else if (item.code === '6632000') shortDivisionCode = '7777777'; // BUNIADPUR DIV.

          details.alternativeCode = shortDivisionCode; // Store link to the preferred short code
        } else if (details.type === 'ccc') {
          // Find parent Division (short form preferred)
          let parentDivisionShortCode = null;
          if (item.code.startsWith('66111')) parentDivisionShortCode = '1111111'; // MALDA DIV.
          else if (item.code.startsWith('66121')) parentDivisionShortCode = '2222222'; // CHANCHAL DIV.
          else if (item.code.startsWith('66131')) parentDivisionShortCode = '3333333'; // GAZOLE DIV.
          else if (item.code.startsWith('66211')) parentDivisionShortCode = '4444444'; // RAIGANJ DIV.
          else if (item.code.startsWith('66221')) parentDivisionShortCode = '5555555'; // ISLAMPUR DIV.
          else if (item.code.startsWith('66311')) parentDivisionShortCode = '6666666'; // BALURGHAT DIV.
          else if (item.code.startsWith('66321')) parentDivisionShortCode = '7777777'; // BUNIADPUR DIV.

          details.parentCode = parentDivisionShortCode;
          if (parentDivisionShortCode) {
            if (!divisionToCCCsMap[parentDivisionShortCode]) divisionToCCCsMap[parentDivisionShortCode] = [];
            divisionToCCCsMap[parentDivisionShortCode].push(item.code);
          }
        }
      });

      // Construct the officeHierarchy for UI filter generation
      let constructedOfficeHierarchy = {};
      for (const roCode in regionalOfficeToDivisionsMap) {
        const roName = officeDetailsMap[roCode].name;
        constructedOfficeHierarchy[roName] = {
          divisions: {}
        };
        regionalOfficeToDivisionsMap[roCode].forEach(divisionCode => {
          const divisionName = officeDetailsMap[divisionCode].name;
          const cccNames = (divisionToCCCsMap[divisionCode] || []).map(cccCode => officeDetailsMap[cccCode].name);
          constructedOfficeHierarchy[roName].divisions[divisionName] = cccNames;
        });
      }
      return constructedOfficeHierarchy; // Return this new hierarchy
    }


    // Utility functions
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        // Assuming DD/MM/YYYY format
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      return new Date(dateStr); // Fallback for other formats
    }

    // NEW: Updated cleanOfficeName to also handle 'CODE NAME' format if needed from CSV 'Office' column
    function cleanOfficeName(officeName) {
      // This regex will remove any number of digits within parentheses at the end of the string
      // For example: "Office Name (123)" or "Office Name (123456789)" will both become "Office Name"
      return officeName.replace(/\s*\(\d+\)$/, '').trim();
    }

    function isWithinLastWeek(date) {
      if (!date) return false;
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      return date >= oneWeekAgo;
    }

    // NEW: Helper functions for weekly view
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
      return new Date(d.setDate(diff));
    }

    function getSunday(monday) {
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return sunday;
    }

    function getWeekKey(date) {
      const monday = getMonday(date);
      return monday.toISOString().split('T')[0]; // Returns YYYY-MM-DD
    }

    function formatWeekRange(monday, sunday) {
      const formattedMonday = monday.toLocaleDateString('en-GB'); // Format: dd/mm/yyyy
      const formattedSunday = sunday.toLocaleDateString('en-GB'); // Format: dd/mm/yyyy
      return `${formattedMonday} to ${formattedSunday}`;
    }

    function getOfficeCountsHtml(officeStats) {
      if (Object.keys(officeStats).length === 0) {
        return 'No data for offices.';
      }

      const sortedOffices = Object.entries(officeStats).sort(([, a], [, b]) => b.count - a.count);

      let html = '';
      if (sortedOffices.length > 0 && sortedOffices[0][1].count > 0) {
        const topOffice = sortedOffices[0];
        const countDisplay = Number.isInteger(topOffice[1].count) ? topOffice[1].count : topOffice[1].count.toFixed(1);
        html += `<div style="color: #B8860B; font-weight: bold;">‚≠ê ${topOffice[0]} (${countDisplay})</div>`;
      }

      // üßπ Removed the "Lowest" display line here

      return html;
    }


    function getCategory(description) {
      const lowerDesc = description.toLowerCase();
      if (lowerDesc.includes("spacer")) return "Spacer Issues";
      if (lowerDesc.includes("lt kiosk")) return "LT Kiosk Issues";
      if (lowerDesc.includes("ht 11 kv")) return "HT 11 KV Issues";
      if (lowerDesc.includes("ht 33 kv")) return "HT 33 KV Issues";
      if (lowerDesc.includes("lt") || lowerDesc.includes("low tension")) return "Other LT Issues";
      return "Other Issues";
    }

    function getRegionalOfficeFromCode(code) {
      let currentCode = code;
      while (currentCode) {
        const entry = officeDetailsMap[currentCode];
        if (!entry) break;
        if (entry.type === 'regionalOffice') return entry.name;
        if (entry.type === 'divisionLong' && entry.alternativeCode) {
          currentCode = entry.alternativeCode;
        } else {
          currentCode = entry.parentCode;
        }
      }
      return null;
    }

    function getDivisionFromCode(code) {
      let currentCode = code;
      while (currentCode) {
        const entry = officeDetailsMap[currentCode];
        if (!entry) break;
        if (entry.type === 'division') return entry.name;
        if (entry.type === 'divisionLong' && entry.alternativeCode) {
          currentCode = entry.alternativeCode;
        } else {
          currentCode = entry.parentCode;
        }
      }
      return null;
    }

    function extractOfficeCode(officeRaw) {
      const match = officeRaw.match(/\((\d+)\)$/); // Extract digits inside last parentheses
      return match ? match[1] : null;
    }

    // Load and process data
    async function loadData() {
      // Build the new hierarchy first
      dynamicOfficeHierarchy = buildHierarchyMaps(newMappingString);
      console.log("Dynamically constructed hierarchy:", dynamicOfficeHierarchy); // For debugging


      try {
        const response = await fetch('data/safety_inspection.json');
        const jsonData = await response.json();

        inspectionData = jsonData.map(row => {
          const officeCode = extractOfficeCode(row.Office || '');
          const officeMeta = officeDetailsMap[officeCode] || {};
          const officeNameForDisplay = officeMeta.name || cleanOfficeName(row.Office || '');

          let cccName = null;
          let divisionName = null;
          let regionName = null;

          if (officeMeta.type === 'ccc') {
            cccName = officeNameForDisplay;
            const divisionCode = officeMeta.parentCode;
            if (divisionCode) {
              divisionName = officeDetailsMap[divisionCode]?.name;
              const regionalCode = officeDetailsMap[divisionCode]?.parentCode;
              if (regionalCode) {
                regionName = officeDetailsMap[regionalCode]?.name;
              }
            }
          } else if (officeMeta.type === 'division' || officeMeta.type === 'divisionLong') {
            const shortDivisionCode = officeMeta.type === 'divisionLong' ? officeMeta.alternativeCode : officeCode;
            divisionName = officeDetailsMap[shortDivisionCode]?.name || officeNameForDisplay;
            const regionalCode = officeDetailsMap[shortDivisionCode]?.parentCode;
            if (regionalCode) {
              regionName = officeDetailsMap[regionalCode]?.name;
            }
          } else if (officeMeta.type === 'regionalOffice') {
            regionName = officeNameForDisplay;
          }

          return {
            officeCode: officeCode,
            office: officeNameForDisplay, // The name of the inspecting office (CCC or Division)
            ccc: cccName,
            division: divisionName,
            regionalOffice: regionName,
            location: row.Location || '',
            description: row.Description || '',
            category: getCategory(row.Description || ''),
            rectificationDoneBy: row['Rectification done by'] || '',
            rectificationDoneOn: parseDate(row['Rectification done on']),
            remarks: row.Remarks || '',
            status: row.Status || '',
            enteredOn: parseDate(row['Entered on']),
            updatedOn: parseDate(row['Updated on']),
            isRectified: row['Rectification done on'] && row['Rectification done on'].trim() !== ''
          };
        });

        // NEW: Calculate total weeks for the entire report period
        const allDatesForWeeks = inspectionData.flatMap(item => [item.enteredOn, item.rectificationDoneOn]).filter(Boolean);
        if (allDatesForWeeks.length > 1) {
          const earliestDate = new Date(Math.min(...allDatesForWeeks.map(d => d.getTime())));
          const latestDate = new Date(Math.max(...allDatesForWeeks.map(d => d.getTime()))); // Use latest date from data
          const timeDiff = latestDate.getTime() - earliestDate.getTime();
          const daysDiff = Math.max(1, timeDiff / (1000 * 3600 * 24));
          totalReportWeeks = Math.max(1, daysDiff / 7);

          const reportPeriodElement = document.getElementById('reportPeriodText');
          if (reportPeriodElement) {
            const formattedStartDate = earliestDate.toLocaleDateString('en-GB');
            const formattedEndDate = latestDate.toLocaleDateString('en-GB');
            reportPeriodElement.textContent = `Report from ${formattedStartDate} to ${formattedEndDate}`;
          }
        }

        processData();
        setupDropdownFilters();
        setupViewOptionsListener();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        // showNotStartedModal();
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = '<p>Error loading data. Please try again later.</p>';
      }
    }

    function setupViewOptionsListener() {
      // NEW: Listeners for checkboxes
      const weeklyCheckbox = document.getElementById('weeklyCheckbox');
      const chartCheckbox = document.getElementById('chartCheckbox');

      weeklyCheckbox.addEventListener('change', (event) => {
        showWeekly = event.target.checked;
        if (showWeekly) {
          chartCheckbox.checked = false; // Uncheck chart if weekly is checked
          showChart = false;
        }
        processData();
      });

      chartCheckbox.addEventListener('change', (event) => {
        showChart = event.target.checked;
        if (showChart) {
          weeklyCheckbox.checked = false; // Uncheck weekly if chart is checked
          showWeekly = false;
        }
        processData();
      });
    }

    function setupDropdownFilters() {
      const regionFilter = document.getElementById('regionFilter');
      const divisionFilter = document.getElementById('divisionFilter');
      const cccFilter = document.getElementById('cccFilter');

      // Populate Regions
      let regionOptions = '<option value="all">All Regions</option>';
      Object.keys(dynamicOfficeHierarchy).sort().forEach(regionName => {
        regionOptions += `<option value="${regionName}">${regionName}</option>`;
      });
      regionFilter.innerHTML = regionOptions;

      // Region Change Event
      regionFilter.addEventListener('change', (event) => {
        currentRegionalFilter = event.target.value;
        currentDivisionFilter = "all"; // Reset division
        currentCCCFilter = "all"; // Reset CCC

        // Populate Divisions
        let divisionOptions = '<option value="all">All Divisions</option>';
        if (currentRegionalFilter !== 'all') {
          const divisions = dynamicOfficeHierarchy[currentRegionalFilter]?.divisions || {};
          Object.keys(divisions).sort().forEach(divName => {
            divisionOptions += `<option value="${divName}">${divName}</option>`;
          });
        }
        divisionFilter.innerHTML = divisionOptions;
        cccFilter.innerHTML = '<option value="all">All CCCs</option>'; // Reset CCC dropdown
        divisionFilter.disabled = (currentRegionalFilter === 'all');
        cccFilter.disabled = true;

        processData();
      });

      // Division Change Event
      divisionFilter.addEventListener('change', (event) => {
        currentDivisionFilter = event.target.value;
        currentCCCFilter = "all"; // Reset CCC

        // Populate CCCs
        let cccOptions = '<option value="all">All CCCs</option>';
        if (currentDivisionFilter !== 'all') {
          const divisionCode = Object.keys(officeDetailsMap).find(code => officeDetailsMap[code].name === currentDivisionFilter);
          const cccCodes = divisionToCCCsMap[divisionCode] || [];
          cccCodes.map(code => officeDetailsMap[code].name).sort().forEach(cccName => {
            cccOptions += `<option value="${cccName}">${cccName}</option>`;
          });
        }
        cccFilter.innerHTML = cccOptions;
        cccFilter.disabled = (currentDivisionFilter === 'all');

        processData();
      });

      // CCC Change Event
      cccFilter.addEventListener('change', (event) => {
        currentCCCFilter = event.target.value;
        processData();
      });


      // Initial state
      divisionFilter.innerHTML = '<option value="all">All Divisions</option>';
      divisionFilter.disabled = true;
      cccFilter.innerHTML = '<option value="all">All CCCs</option>';
      cccFilter.disabled = true;
    }



    function processData() {
      let filteredData = inspectionData;
      // NEW: Apply regional filter
      if (currentRegionalFilter !== "all") {
        filteredData = filteredData.filter(item => item.regionalOffice === currentRegionalFilter);
      }

      // NEW: Apply division filter
      if (currentDivisionFilter !== "all") {
        filteredData = filteredData.filter(item => item.division === currentDivisionFilter);
      }

      // NEW: Apply CCC filter
      if (currentCCCFilter !== "all") {
        filteredData = filteredData.filter(item => item.ccc === currentCCCFilter);
      }

      const totalInspected = filteredData.length;
      const totalRectified = filteredData.filter(item => item.isRectified).length;
      const totalPending = totalInspected - totalRectified;
      const totalRectifiedPercent = totalInspected > 0 ? Math.round((totalRectified / totalInspected) * 100) : 0;
 
      // NEW: Current Week Calculations
      const today = new Date();
      const lastMonday = getMonday(today);
      const thisSunday = getSunday(lastMonday);
      const currentWeekInspectedCount = filteredData.filter(item => {
        return item.enteredOn >= lastMonday && item.enteredOn <= thisSunday;
      }).length;

      const avgInspected = (totalInspected / totalReportWeeks).toFixed(1);

      // Update stat cards
      document.getElementById('totalInspected').textContent = totalInspected;
      document.getElementById('totalRectified').childNodes[0].nodeValue = `${totalRectified} `;
      document.getElementById('totalRectifiedPercent').textContent = `(${totalRectifiedPercent}%)`;
      document.getElementById('avgInspected').textContent = avgInspected;
      document.getElementById('currentWeekInspectedCard').textContent = currentWeekInspectedCount;
      
      // Update Current Week Card Label with date range
      const formattedMonday = lastMonday.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit' });
      const formattedSunday = thisSunday.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit' });
      document.getElementById('currentWeekLabel').textContent = `Current Week (${formattedMonday} to ${formattedSunday})`;

      // Update charts
      updateMainTable(filteredData, totalReportWeeks);
      createTimelineChart(filteredData);
    }

    function updateMainTable(data, weeks = 1) {
      const tableHeaderContainer = document.getElementById('officeTableHeaderContainer');
      const tableBody = document.getElementById('officeTableBody');
      const tableTitle = document.getElementById('tableTitle');
      const tableContainer = document.getElementById('tableContainer');
      const chartContainer = document.getElementById('chartViewContainer');
      let tableHtml = '';

      // NEW: Toggle view based on checkboxes
      tableContainer.style.display = 'block';
      chartContainer.style.display = 'none';

      if (showChart) {
        tableContainer.style.display = 'none';
        chartContainer.style.display = 'block';
      } 

      // --- Aggregated Views ---
      const stats = {};
      let aggregationKey = 'regionalOffice'; // Default to region
      let headerLabel = 'Region';

      if (currentRegionalFilter === 'all') {
        aggregationKey = 'regionalOffice';
        headerLabel = 'Region';
        tableTitle.textContent = 'Region-Wise Status';
      } else if (currentRegionalFilter !== 'all' && currentDivisionFilter === 'all') {
        aggregationKey = 'division';
        headerLabel = 'Division';
        tableTitle.textContent = `Divisions in ${currentRegionalFilter}`;
      } else if (currentDivisionFilter !== 'all') {
        aggregationKey = 'ccc';
        headerLabel = 'CCC';
        tableTitle.textContent = `CCCs in ${currentDivisionFilter}`;
      }

      // NEW: Pre-filter data to ensure cards and table match
      // This ensures that items without a valid aggregation key are excluded from all calculations.
      const tableData = data.filter(item => item[aggregationKey]);

      // Recalculate card totals based on the data that will actually be in the table
      const cardTotalInspected = tableData.length;
      const cardTotalRectified = tableData.filter(item => item.isRectified).length;
      const cardTotalRectifiedPercent = cardTotalInspected > 0 ? Math.round((cardTotalRectified / cardTotalInspected) * 100) : 0;

      // Handle weekly view separately
      if (showWeekly) {
        tableTitle.textContent = 'Weekly Progress';

        const weeklyStats = {};

        data.forEach(item => {
          if (item.enteredOn) {
            const weekKey = getWeekKey(item.enteredOn);
            if (!weeklyStats[weekKey]) {
              const monday = getMonday(item.enteredOn);
              const sunday = getSunday(monday);
              weeklyStats[weekKey] = {
                monday: monday,
                sunday: sunday,
                weekRange: formatWeekRange(monday, sunday),
                inspected: 0,
                rectified: 0
              };
            }
            weeklyStats[weekKey].inspected++;
          }

          if (item.isRectified && item.rectificationDoneOn) {
            const weekKey = getWeekKey(item.rectificationDoneOn);
            if (!weeklyStats[weekKey]) {
              const monday = getMonday(item.rectificationDoneOn);
              const sunday = getSunday(monday);
              weeklyStats[weekKey] = {
                monday: monday,
                sunday: sunday,
                weekRange: formatWeekRange(monday, sunday),
                inspected: 0,
                rectified: 0
              };
            }
            weeklyStats[weekKey].rectified++;
          }
        });

        let weeklyArray = Object.entries(weeklyStats)
          .map(([key, stats]) => ({
            weekKey: key,
            ...stats
          }))
          .sort((a, b) => a.monday.getTime() - b.monday.getTime()); // Sort oldest to newest for calculation

        // Calculate cumulative pending
        let cumulativeInspected = 0;
        let cumulativeRectified = 0;
        weeklyArray = weeklyArray.map(week => {
          cumulativeInspected += week.inspected;
          cumulativeRectified += week.rectified;
          return {
            ...week,
            pending: cumulativeInspected - cumulativeRectified
          };
        });

        // Sort back to latest week first for display
        weeklyArray.sort((a, b) => b.monday.getTime() - a.monday.getTime());
        
        tableHeaderContainer.innerHTML = `
          <tr>
            <th>#</th>
            <th>Week</th>
            <th class="sortable-header">Inspected</th>
            <th class="sortable-header">Rectified</th>
            <th class="sortable-header">Pending</th>
          </tr>
        `;

        const totalWeeks = weeklyArray.length;
        weeklyArray.forEach((week, index) => {
          tableHtml += `
            <tr>
              <td>Week ${totalWeeks - index}</td>
              <td>${week.weekRange}</td> 
              <td>${week.inspected}</td>
              <td>${week.rectified}</td>
              <td>${week.pending}</td>
            </tr>
          `;
        });
        tableBody.innerHTML = tableHtml;
        return; // Exit early for weekly view
      }

      // Regular aggregated views (CCC, Division, Region)
      tableData.forEach(item => { // Use the pre-filtered tableData
        const key = item[aggregationKey];
        if (!key) return;

        if (!stats[key]) {
          stats[key] = {
            total: 0,
            rectified: 0,
            weekInspected: 0,
            weekRectified: 0,
            currentWeekInspected: 0, // Add this for the new column
            lastInspectionDate: null
          };
        }
        stats[key].total++;
        if (item.isRectified) stats[key].rectified++;
        if (isWithinLastWeek(item.enteredOn)) stats[key].weekInspected++;
        if (item.isRectified && isWithinLastWeek(item.rectificationDoneOn)) stats[key].weekRectified++;
        if (item.enteredOn) {
          // Calculate current week inspections for the table
          const today = new Date();
          const lastMonday = getMonday(today);
          const thisSunday = getSunday(lastMonday);
          if (item.enteredOn >= lastMonday && item.enteredOn <= thisSunday) {
            stats[key].currentWeekInspected++;
          }
          if (!stats[key].lastInspectionDate || item.enteredOn > stats[key].lastInspectionDate) {
            stats[key].lastInspectionDate = item.enteredOn;
          }
        }
      });

      tableHeaderContainer.innerHTML = `
         <tr>
            <th>#</th>
            <th class="sortable-header" onclick="setSort('name')">${headerLabel}${getSortIcon('name')}</th>
            <th class="sortable-header" onclick="setSort('currentWeekInspected')">This Week${getSortIcon('currentWeekInspected')}</th>
            <th class="sortable-header" onclick="setSort('lastInspectionDate')">Last Inspection${getSortIcon('lastInspectionDate')}</th>
            <th class="sortable-header" onclick="setSort('total')">Total${getSortIcon('total')}</th>
            <th class="sortable-header" onclick="setSort('rectified')">Rectified${getSortIcon('rectified')}</th>
            <th class="sortable-header" onclick="setSort('pending')">Pending${getSortIcon('pending')}</th>
            <th class="sortable-header" onclick="setSort('percentage')">% Complete${getSortIcon('percentage')}</th>
            <th class="sortable-header" style="text-align:center;" onclick="setSort('avgInspected')">Insp/Wk${getSortIcon('avgInspected')}</th>
            <th class="sortable-header" style="text-align:center;" onclick="setSort('avgRectified')">Rect/Wk${getSortIcon('avgRectified')}</th>
         </tr>
     `;

      const itemsArray = Object.entries(stats).map(([name, s]) => {
        const pending = s.total - s.rectified;
        const percentage = s.total > 0 ? Math.round((s.rectified / s.total) * 100) : 0;
        const avgInspected = parseFloat((s.total / weeks).toFixed(1));
        const avgRectified = parseFloat((s.rectified / weeks).toFixed(1));
        return {
          name,
          ...s,
          pending,
          percentage,
          avgInspected,
          avgRectified
        };
      });

      itemsArray.sort((a, b) => {
        let valA = a[sortColumn];
        let valB = b[sortColumn];

        // Handle nulls for dates: always at the bottom
        if (sortColumn === 'lastInspectionDate') {
          if (valA === null && valB === null) return 0;
          if (valA === null) return 1;
          if (valB === null) return -1;
        }

        // Handle different data types
        if (valA instanceof Date) {
          valA = valA.getTime();
          valB = valB.getTime();
        } else if (typeof valA === 'string') {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        }

        let comparison = 0;
        if (valA > valB) {
          comparison = 1;
        } else if (valA < valB) {
          comparison = -1;
        }

        return sortDirection === 'desc' ? comparison * -1 : comparison;
      });

      // NEW: Calculate totals for the footer row
      const grandTotalInspected = itemsArray.reduce((sum, item) => sum + item.total, 0);
      const grandTotalRectified = itemsArray.reduce((sum, item) => sum + item.rectified, 0);
      const grandTotalPending = grandTotalInspected - grandTotalRectified;
      const grandTotalPercentage = grandTotalInspected > 0 ? Math.round((grandTotalRectified / grandTotalInspected) * 100) : 0;
      const grandTotalAvgInspected = (grandTotalInspected / weeks).toFixed(1);
      const grandTotalAvgRectified = (grandTotalRectified / weeks).toFixed(1);

      // NEW: Create the total row HTML
      const totalRowHtml = `
        <tr style="background-color: #e3f2fd; font-weight: bold; border-top: 2px solid #90caf9;">
            <td></td>
            <td></td>
            <td>Grand Total</td>
            <td></td>
            <td>${grandTotalInspected}</td>
            <td>${grandTotalRectified}</td>
            <td>${grandTotalPending}</td>
            <td>${grandTotalPercentage}%</td>
            <td style="text-align:center;">${grandTotalAvgInspected}</td>
            <td style="text-align:center;">${grandTotalAvgRectified}</td>
        </tr>
      `;

      itemsArray.forEach((item, index) => {
        const lastInspectionFormatted = item.lastInspectionDate ? item.lastInspectionDate.toLocaleDateString('en-GB') : 'N/A';
        tableHtml += `
     <tr class="clickable-row" onclick="handleRowClick('${item.name}', '${aggregationKey}')">
                <td>${index + 1}</td>
                <td>${item.name}</td>
                <td>${item.currentWeekInspected}</td>
                <td>${lastInspectionFormatted}</td>
                 <td>${item.total}</td>
                 <td>${item.rectified}</td>
                <td>${item.pending}</td>
                <td>${item.percentage}%</td>
                 <td style="text-align:center;">${item.avgInspected.toFixed(1)}</td>
                 <td style="text-align:center;">${item.avgRectified.toFixed(1)}</td>
             </tr>
        `;
      });
      tableBody.innerHTML = tableHtml + totalRowHtml; // Add total row at the end
    }


    function createTimelineChart(data) {
      if (timelineChart) timelineChart.destroy();

      const monthlyData = {};

      data.forEach(item => {
        const monthYearEntered = item.enteredOn ? `${item.enteredOn.getFullYear()}-${(item.enteredOn.getMonth() + 1).toString().padStart(2, '0')}` : null;
        const monthYearRectified = item.rectificationDoneOn ? `${item.rectificationDoneOn.getFullYear()}-${(item.rectificationDoneOn.getMonth() + 1).toString().padStart(2, '0')}` : null;

        if (monthYearEntered) {
          if (!monthlyData[monthYearEntered]) {
            monthlyData[monthYearEntered] = {
              inspected: 0,
              rectified: 0
            };
          }
          monthlyData[monthYearEntered].inspected++;
        }

        if (monthYearRectified) {
          if (!monthlyData[monthYearRectified]) {
            monthlyData[monthYearRectified] = {
              inspected: 0,
              rectified: 0
            };
          }
          monthlyData[monthYearRectified].rectified++;
        }
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const labels = sortedMonths.map(my => {
        const [year, month] = my.split('-');
        return new Date(year, month - 1, 1).toLocaleDateString('en-US', {
          month: 'short',
          year: '2-digit'
        });
      });
      const inspectedCounts = sortedMonths.map(month => monthlyData[month].inspected);
      const rectifiedCounts = sortedMonths.map(month => monthlyData[month].rectified);

      const canvas = document.getElementById('timelineChart');
      // Ensure canvas itself doesn't have conflicting height from previous renders
      canvas.removeAttribute('style');
      const ctx = canvas.getContext('2d');

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Inspected',
            data: inspectedCounts,
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            fill: true,
            tension: 0.3
          }, {
            label: 'Rectified',
            data: rectifiedCounts,
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

    }


    window.onclick = function (event) {
      const modal = document.getElementById('modal');
      const detailsModal = document.getElementById('detailsModal');
      const mapModal = document.getElementById('mapModal');
      const itemDetailsModal = document.getElementById('itemDetailsModal'); // Add this line


    };


    // Initialize
    loadData();

    function setSort(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
        sortColumn = column;
        sortDirection = 'desc';
      }
      processData();
    }

    function getSortIcon(column) {
      if (sortColumn === column) {
        return sortDirection === 'desc' ? ' &#9660;' : ' &#9650;';
      }
      return '';
    }

    function showNotStartedModal() {
      const inspectedThisWeekCodes = new Set(
        inspectionData.filter(item => isWithinLastWeek(item.enteredOn)).map(item => item.officeCode)
      );

      const notInspectedThisWeekOffices = Object.entries(officeDetailsMap)
        .filter(([code, entry]) => entry.type === 'ccc' && !inspectedThisWeekCodes.has(code))
        .map(([code, entry]) => entry.name)
        .sort();

      const body = document.getElementById('notStartedBody');
      if (notInspectedThisWeekOffices.length === 0) {
        body.innerHTML = '<p>All offices have performed inspections this week. Great job!</p>';
      } else {
        body.innerHTML = `
      <p><strong>${notInspectedThisWeekOffices.length}</strong> offices have not done any inspection this week:</p>
      <ul style="margin-top: 10px; padding-left: 20px; max-height: 200px; overflow-y: auto;">
        ${notInspectedThisWeekOffices.map(name => `<li>${name}</li>`).join('')}
      </ul>
    `;
      }

      document.getElementById('notStartedModal').style.display = 'block';
    }

    function closeNotStartedModal() {
      document.getElementById('notStartedModal').style.display = 'none';
    }
  </script>
</body>

</html>
