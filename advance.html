<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Net Balance Analytics</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    /* Base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; /* Reverted font back to system defaults */
      background: #f0f2f5; /* Lighter background */
      min-height: 100vh;
      padding: 0.5rem; /* Slightly reduced padding */
      color: #1e293b;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 14px; /* Slightly smaller base font size */
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.08); /* More subtle shadow */
      overflow: hidden;
      padding-top: 50px; /* Space for fixed header */
    }

    /* Header styles */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 0.75rem 1rem; /* Reduced padding */
      text-align: center;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 1.1rem; /* Slightly smaller font */
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    /* Controls (filters) */
    .controls {
      padding: 0.75rem 1rem; /* Reduced padding */
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: grid;
      /* Desktop: 4 columns for filters */
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem; /* Reduced gap */
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem; /* Reduced gap */
    }

    /* Removed .control-label styles as labels are removed */

    select {
      padding: 0.4rem 0.6rem; /* Reduced padding */
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 0.8rem; /* Slightly smaller font */
      color: #374151;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15); /* More subtle shadow */
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* More compact columns */
      gap: 0.4rem; /* Reduced gap */
      padding: 0.75rem 1rem; /* Reduced padding */
      margin: 0.5rem 0;
    }

    .stat-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px; /* Slightly smaller border radius */
      padding: 0.6rem; /* Reduced padding */
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); /* More subtle shadow */
      transition: transform 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
    }

    .stat-card:hover {
      background: #f1f5f9;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .stat-value {
      font-size: 0.95rem; /* Slightly smaller font */
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.1rem; /* Reduced margin */
    }

    .stat-label {
      font-size: 0.65rem; /* Slightly smaller font */
      color: #6b7280;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    /* Overdue card specific styles */
    .overdue-card {
      background: #fef2f2; /* Light red background */
      border-color: #fca5a5; /* Red border */
    }
    .overdue-card .stat-value {
      color: #dc2626; /* Darker red text for value */
    }

    /* Chart containers */
    .chart-container {
      padding: 0.75rem 1rem; /* Reduced padding */
      position: relative;
    }

    .chart-container h2 {
      font-size: 0.95rem; /* Slightly smaller font */
      font-weight: 600;
      margin-bottom: 0.4rem; /* Reduced margin */
    }

    .chart-wrapper {
      height: 350px; /* Reduced height */
      position: relative;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.5rem; /* Added padding inside wrapper */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    /* Specific style for Division-wise Advance chart wrapper to remove scrollbar */
    #divisionChartWrapper {
      overflow-y: hidden; /* Prevent vertical scrolling */
      /* min-height will be set dynamically by JS */
    }


    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      border-radius: 8px;
    }

    .loading-spinner {
      width: 28px; /* Smaller spinner */
      height: 28px;
      border: 2px solid #e2e8eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 0.4rem; /* Reduced margin */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    /* Tab buttons */
    .tab-btn {
      padding: 0.4rem 0.8rem; /* Reduced padding */
      background: #e5e7eb;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.8rem; /* Slightly smaller font */
      transition: background 0.2s, color 0.2s;
    }
    .tab-btn:hover {
      background: #d1d5db;
    }
    .tab-btn.active-tab {
      background: #3b82f6;
      color: white;
    }

    /* Modal Layout */
    #detailsModal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
    }
    #detailsModal:not(.hidden) {
      display: flex;
    }
    .modal-backdrop {
      flex: 1;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem; /* Reduced padding */
    }
    .modal-box {
      background: white;
      border-radius: 10px; /* Slightly smaller border radius */
      max-height: 90vh;
      width: 100%;
      max-width: 550px; /* Slightly smaller max-width */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 0.8rem; /* Slightly smaller font */
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .modal-header {
      background: #f1f5f9;
      padding: 0.6rem 1rem; /* Reduced padding */
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 0.9rem; /* Slightly smaller font */
    }
    .modal-header button {
      background: none;
      border: none;
      font-size: 1.1rem; /* Slightly smaller font */
      cursor: pointer;
      color: #64748b;
      padding: 0.2rem;
    }
    .modal-header button:hover {
      color: #1e293b;
    }
    .modal-tabs {
      display: flex;
      gap: 0.4rem; /* Reduced gap */
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 40px; /* Adjusted top for header height */
      background: white;
      z-index: 9;
    }
    .modal-tabs .tab-btn {
      padding: 0.2rem 0.6rem; /* Reduced padding */
      font-size: 0.75rem; /* Smaller font */
      border-radius: 4px;
    }
    .modal-body {
      overflow-y: auto;
      padding: 0.75rem 1rem; /* Reduced padding */
      max-height: calc(90vh - 100px); /* Adjusted max-height */
    }
    .modal-item {
      padding: 0.3rem 0; /* Reduced padding */
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.8rem; /* Slightly smaller font */
      display: block;
    }
    .modal-item.hidden {
      display: none;
    }
    @media (min-width: 768px) {
      .modal-box {
        max-width: 800px; /* Slightly smaller max-width for larger screens */
      }
    }
    #topVendorValue {
      color: #dc2626; /* Tailwind Red-600 */
    }

    /* Skeleton loading style */
    .skeleton {
      background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
      background-size: 400% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }
    #startupAlert {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6); /* dark overlay */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    @media (max-width: 640px) {
      #startupAlert .modal-box {
        max-width: 90vw;
        font-size: 0.75rem; /* Smaller font */
        padding: 0.6rem; /* Reduced padding */
      }
    }
    .fullscreen-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    /* Styles for the new data table */
    .data-table-container {
      padding: 0.75rem 1rem; /* Reduced padding */
      margin-top: 0.75rem; /* Reduced margin */
      background: white;
      border-top: 1px solid #e2e8f0;
      overflow-x: auto; /* Enable horizontal scrolling for small screens */
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.4rem; /* Reduced margin */
      font-size: 0.8rem; /* Slightly smaller font */
    }

    .data-table th,
    .data-table td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.7rem; /* Reduced padding */
      text-align: left;
    }

    .data-table th {
      background: #f1f5f9;
      font-weight: 600;
      color: #475569;
      white-space: nowrap; /* Prevent wrapping of headers */
      cursor: pointer; /* Indicate sortable */
    }
    .data-table th .sort-icon {
        margin-left: 5px;
        font-size: 0.7em;
        vertical-align: middle;
    }


    .data-table tbody tr:nth-child(even) {
      background: #f8fafc;
    }

    .data-table tbody tr:hover {
      background: #eff6ff; /* Light blue on hover */
    }

    .summary-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0; /* Reduced padding */
      cursor: pointer;
      font-size: 0.95rem; /* Slightly smaller font */
      font-weight: 600;
      color: #1e293b;
    }

    .summary-table-header .bx {
      font-size: 1.1rem; /* Slightly smaller icon */
      transition: transform 0.2s ease-in-out;
    }

    .summary-table-header.collapsed .bx {
      transform: rotate(-90deg);
    }

    .summary-table-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      max-height: 1000px; /* Arbitrary large value for expanded state */
    }

    .summary-table-content.hidden {
      max-height: 0;
      padding-bottom: 0;
      padding-top: 0;
    }

    .summary-tabs {
      display: flex;
      gap: 0.4rem; /* Reduced gap */
      margin-bottom: 0.75rem; /* Reduced margin */
    }

    .summary-tabs .tab-btn {
      flex: 1;
      text-align: center;
      padding: 0.4rem; /* Reduced padding */
      font-size: 0.8rem; /* Slightly smaller font */
    }

    /* New styles for option buttons */
    .option-buttons-container {
      padding: 0.75rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      align-items: flex-start; /* Align items to the start for better layout with descriptions */
      margin-top: 0.5rem;
    }

    .option-button-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      flex: 1 1 calc(33% - 1rem); /* Roughly 3 per row on desktop */
      min-width: 150px; /* Minimum width for responsiveness */
      max-width: 250px; /* Max width to prevent stretching too much */
    }

    .option-button-group .tab-btn {
      width: 100%;
      margin-bottom: 0.4rem;
      background: #e5e7eb; /* Default background */
      color: #1e293b; /* Default text color */
      font-weight: 500; /* Default font weight */
      padding: 0.6rem;
    }

    .option-button-group .tab-btn:hover {
      background: #d1d5db;
    }

    .option-button-group .tab-btn.active-option { /* New class for active option button */
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .option-button-group .description {
      font-size: 0.75rem;
      color: #6b7280;
      line-height: 1.3;
      min-height: 3em; /* Ensure consistent height for descriptions */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 0 0.2rem;
    }


    /* Mobile optimizations */
    @media (max-width: 640px) {
      body {
        padding: 0.2rem;
        font-size: 13px; /* Smaller base font size for mobile */
        background: #f9fafb;
      }

      .header {
        padding: 0.3rem 0.5rem; /* Further reduced padding */
      }

      .header h1 {
        font-size: 0.9rem; /* Smaller font */
      }

      .app-container {
        border-radius: 8px;
        padding-top: 3rem; /* Adjusted for smaller header */
      }

      .controls {
        padding: 0.3rem 0.5rem; /* Further reduced padding */
        gap: 0.3rem; /* Further reduced gap */
        grid-template-columns: repeat(2, 1fr); /* 2 filters per row on mobile */
      }

      .control-label {
        font-size: 0.7rem; /* Smaller font */
      }

      select {
        padding: 0.3rem; /* Further reduced padding */
        font-size: 0.7rem; /* Smaller font */
      }

      .stats-grid {
        margin: 0.2rem 0;
        gap: 0.2rem; /* Further reduced gap */
        padding: 0.3rem 0.5rem;
      }

      .stat-card {
        padding: 0.3rem; /* Further reduced padding */
        border-radius: 6px;
      }

      .stat-value {
        font-size: 0.75rem; /* Smaller font */
      }

      .stat-label {
        font-size: 0.55rem; /* Smaller font */
      }

      .chart-container {
        padding: 0.3rem 0.5rem; /* Further reduced padding */
      }

      .chart-wrapper {
        height: 250px; /* Further reduced height */
        padding: 0.3rem;
      }

      .modal-box {
        font-size: 0.75rem; /* Smaller font */
        max-width: 95vw;
        padding: 0.5rem;
      }

      .modal-header h3 {
        font-size: 0.85rem; /* Smaller font */
      }

      .tab-btn {
        font-size: 0.7rem; /* Smaller font */
        padding: 0.2rem 0.4rem;
      }

      .data-table-container {
        padding: 0.3rem 0.5rem;
      }
      .data-table th,
      .data-table td {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      .summary-table-header {
        font-size: 0.85rem;
      }
      .summary-tabs .tab-btn {
        padding: 0.3rem;
        font-size: 0.75rem;
      }
      #modalSearch {
        padding: 0.3rem;
        font-size: 0.75rem;
      }
      .modal-tabs .tab-btn {
        font-size: 0.7rem;
      }
      .option-buttons-container {
        flex-direction: column; /* Stack buttons on mobile */
        align-items: stretch;
        gap: 0.5rem;
      }
      .option-button-group {
        width: 100%;
        max-width: none; /* Remove max-width on mobile */
        flex: none; /* Remove flex basis */
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .chart-wrapper {
        height: 220px; /* Even smaller height for very small screens */
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>üìä Advance to Vendors (CAPEX)</h1>
  </div>
  <div class="app-container">
    <div class="controls">
      <div class="control-group">
        <select id="locationFilter">
          <option value="all">All Divisions</option>
          <option value="Balurghat">Balurghat</option>
          <option value="Malda">Malda</option>
          <option value="Raiganj">Raiganj</option>
          <option value="Buniadpur">Buniadpur</option>
          <option value="Gazole">Gazole</option>
          <option value="Islampur">Islampur</option>
          <option value="Chanchal">Chanchal</option>
        </select>
      </div>

      <div class="control-group">
        <select id="unitFilter">
          <option value="all">All Units</option>
        </select>
      </div>

      <div class="control-group">
        <select id="vendorFilter">
          <option value="all">All Vendors</option>
        </select>
      </div>

      <div class="control-group">
        <select id="materialFilter">
          <option value="all">All Materials</option>
        </select>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalValue">‚Çπ0</div>
        <div class="stat-label">Total Balance</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="monthCount">0</div>
        <div class="stat-label">Active Months</div>
      </div>
      <div class="stat-card overdue-card">
        <div class="stat-value" id="overdue6mo">‚Çπ0</div>
        <div class="stat-label">Overdue (>6mo)</div>
      </div>
      <div class="stat-card overdue-card">
        <div class="stat-value" id="overdueValue">‚Çπ0</div>
        <div class="stat-label">Overdue (>12mo)</div>
      </div>
      <div class="stat-card overdue-card">
        <div class="stat-value" id="overdue24mo">‚Çπ0</div>
        <div class="stat-label">Overdue (>24mo)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="topVendorValue">‚Çπ0</div>
        <div class="stat-label" id="topVendorLabel">Top Vendor</div>
      </div>
    </div>

    <!-- New section for option buttons -->
    <div class="option-buttons-container">
      <div class="option-button-group">
        <button id="viewTimelineChartBtn" class="tab-btn">View Advance Timeline Chart</button>
      </div>
      <div class="option-button-group">
        <button id="viewDivisionChartBtn" class="tab-btn">View Division-wise Advance Chart</button>
      </div>
      <div class="option-button-group">
        <button id="viewSummaryTableBtn" class="tab-btn">View Summary Table</button>
      </div>
    </div>

    <div id="advanceTimelineChartSection" class="chart-container hidden">
      <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üìà Advance Timeline</h2>
      <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading data...</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
    <div id="divisionChartSection" class="chart-container hidden">
      <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üìç Division-wise Advance</h2>

      <div class="loading-overlay hidden" id="divisionLoadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Preparing chart...</div>
      </div>

      <div class="chart-wrapper" id="divisionChartWrapper">
        <canvas id="divisionChart"></canvas>
      </div>
    </div>

    <div id="summaryTableSection" class="data-table-container hidden">
      <div id="summaryTableHeader" class="summary-table-header">
        <h2>Summary Table</h2>
        <!-- Removed the collapse icon -->
      </div>
      <div id="summaryTableContent" class="summary-table-content">
        <div class="summary-tabs">
          <button id="divisionSummaryTabBtn" class="tab-btn active-tab">Division</button>
          <button id="unitSummaryTabBtn" class="tab-btn">Unit</button>
          <button id="agencySummaryTabBtn" class="tab-btn">Agency</button>
        </div>
        <table id="miniDataTable" class="data-table">
          <thead>
            <tr>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const sources = {
      "Balurghat": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRooKVx76f92WX_Q3j2u4UmA1yXN2cNcwSPVqiFjyY58oTplAg_Ieze4xket4Lq3qHEuLt9js0-kU8a/pub?gid=98784562&single=true&output=csv',
      "Malda": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHtBkI-9-cafLDNyCNtbnHX0B65dCawQHoO8oiFYQzeWBxu0u4VBXCqR5zgj5ylceF3piSl8rnholp/pub?gid=98784562&single=true&output=csv',
      "Raiganj": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-jd3bm9BCgUKNQCgr0Lj9paLYQ9oacLPlleCHXrtV1__58NyK_w19hbC4thzgPkdHtIAAP2nrnmyC/pub?gid=98784562&single=true&output=csv',
      "Buniadpur": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZPn6CB_cHTFVb8S5vpvaBnczj63fYMTI0RVEdMzVcQ8O6XQi5iwTbMp2xa5vsL6zHGWxezWUSehrN/pub?gid=98784562&single=true&output=csv',
      "Gazole": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeQ8Rj3WDvBw5FEYP2rYbRV7p0HvnxuXfBlfpTtJY_K-rnYCNoMsFM426rrGsK5tYMLmhK2LnJ1HP-/pub?gid=98784562&single=true&output=csv',
      "Islampur": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsXWZdt0B4LpbxbstdJv564CnjEBMCC_HwlssthZCXLTKpUFkF_dhQtEpN0KYD-eKiClTwA2WOhSB-/pub?gid=98784562&single=true&output=csv',
      "Chanchal": 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6XAKcdyjGWhdxB7FPTwzlEUN5fgLXFuLE_8VSSsiGvbfcY4uLPY8zzlnMmqAqEeF7J6FQqW26R-jr/pub?gid=98784562&single=true&output=csv'
    };

    function formatName(text) {
      if (!text || typeof text !== 'string') return '';
      if (text.trim().toLowerCase() === 'ccc') return 'CCC'; // keep CCC as is
      return text
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
    function populateLocationDropdown() {
      const locationSelect = document.getElementById('locationFilter');
      locationSelect.innerHTML = `<option value="all">All Divisions</option>`;
      Object.keys(sources).sort().forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = formatName(location);
        locationSelect.appendChild(option);
      });
    }

    let allData = []; // Store all parsed data
    let selectedLocation = 'all';
    let selectedUnit = 'all';
    let selectedVendor = 'all';
    let selectedMaterial = 'all'; // New state for material filter
    let chart; // This will now only refer to the balanceChart
    let divisionChart; // Reference for the division chart instance

    // Global variables to store summary data for tables
    let globalMonthlyBuckets = {};
    let globalLocationSums = {};
    let currentSummaryTab = 'division'; // default tab, now 'division'

    // NEW: Global variable to store the filter function for the modal
    let currentModalFilterFn = null;

    // NEW: Global variables for sorting state in summary table
    let currentSortColumn = null;
    let currentSortDirection = 'desc'; // 'asc' or 'desc'

    function toggleLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
      document.getElementById('divisionLoadingOverlay').classList.toggle('hidden', !show);

      document.querySelectorAll('.stat-card').forEach(card => {
        if (show) {
          card.classList.add('skeleton');
          card.querySelector('.stat-value').textContent = '‚Äî';
          card.querySelector('.stat-label').style.opacity = 0.6;
        } else {
          card.classList.remove('skeleton');
          card.querySelector('.stat-label').style.opacity = 1;
        }
      });
    }


    function formatCurrency(value) {
      if (value >= 10000000) {
        return (value / 10000000).toFixed(1) + ' Cr';
      } else if (value >= 100000) {
        return (value / 100000).toFixed(1) + ' L';
      } else if (value >= 1000) {
        return (value / 1000).toFixed(1) + 'K';
      }
      return value.toLocaleString('en-IN');
    }

    function parseDate(dateStr) {
      if (!dateStr || typeof dateStr !== 'string') return null;
      const parts = dateStr.split(/[/-]/);
      if (parts.length !== 3) return null;
      const [day, month, year] = parts.map(p => parseInt(p));
      if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
      return new Date(year, month - 1, day);
    }

    function formatMonthYear(date) {
      const month = date.getMonth() + 1;
      const year = date.getFullYear().toString().slice(-2);
      return `${month}/${year}`;
    }

    function findColumn(row, candidates) {
      for (const candidate of candidates) {
        if (row.hasOwnProperty(candidate)) return candidate;
        const key = Object.keys(row).find(k => k.toLowerCase() === candidate.toLowerCase());
        if (key) return key;
      }
      return null;
    }

function getFilteredData() {
  let filteredData = allData;
  if (selectedLocation !== 'all') filteredData = filteredData.filter(row => row.location === selectedLocation);
  if (selectedUnit !== 'all') filteredData = filteredData.filter(row => row.unit === selectedUnit);
  if (selectedVendor !== 'all') filteredData = filteredData.filter(row => row.vendor === selectedVendor);
  if (selectedMaterial !== 'all') filteredData = filteredData.filter(row => row.material === selectedMaterial);
  return filteredData;
}


    function populateDropdowns(resetDependent = false) {
      // Get base filtered data (without vendor/material filter for vendor/material dropdown)
      let baseFilteredData = allData;

      if (selectedLocation !== 'all') {
        baseFilteredData = baseFilteredData.filter(row => row.location === selectedLocation);
      }
      if (selectedUnit !== 'all') {
        baseFilteredData = baseFilteredData.filter(row => row.unit === selectedUnit);
      }

      // Get units based on location filter only
      let unitFilteredData = allData;
      if (selectedLocation !== 'all') {
        unitFilteredData = unitFilteredData.filter(row => row.location === selectedLocation);
      }

      const units = new Set();
      const vendors = new Set();
      const materials = new Set(); // New set for materials

      unitFilteredData.forEach(row => {
        if (row.unit) units.add(row.unit);
      });

      baseFilteredData.forEach(row => {
        if (row.vendor) vendors.add(row.vendor);
        if (row.material) materials.add(row.material); // Populate materials
      });

      // Populate unit dropdown
      const unitSelect = document.getElementById('unitFilter');
      const currentUnit = unitSelect.value;
      unitSelect.innerHTML = '<option value="all">All Units</option>';
      Array.from(units).sort().forEach(unit => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = formatName(unit);
        unitSelect.appendChild(option);
      });

      // Reset unit selection if it's no longer available or if we need to reset dependent filters
      const unitExists = [...unitSelect.options].some(opt => opt.value === currentUnit);
      if (!unitExists || resetDependent) {
        unitSelect.value = 'all';
        selectedUnit = 'all';
      } else {
        unitSelect.value = currentUnit;
      }

      // Populate vendor dropdown
      const vendorSelect = document.getElementById('vendorFilter');
      const currentVendor = vendorSelect.value;
      vendorSelect.innerHTML = '<option value="all">All Vendors</option>';
      Array.from(vendors).sort().forEach(vendor => {
        const option = document.createElement('option');
        option.value = vendor;
        option.textContent = formatName(vendor);
        vendorSelect.appendChild(option);
      });

      // Reset vendor selection if it's no longer available or if we need to reset dependent filters
      const vendorExists = [...vendorSelect.options].some(opt => opt.value === currentVendor);
      if (!vendorExists || resetDependent) {
        vendorSelect.value = 'all';
        selectedVendor = 'all';
      } else {
        vendorSelect.value = currentVendor;
      }

      // Populate material dropdown
      const materialSelect = document.getElementById('materialFilter');
      const currentMaterial = materialSelect.value;
      materialSelect.innerHTML = '<option value="all">All Materials</option>';
      Array.from(materials).sort().forEach(material => {
        const option = document.createElement('option');
        option.value = material;
        option.textContent = formatName(material);
        materialSelect.appendChild(option);
      });

      // Reset material selection if it's no longer available or if we need to reset dependent filters
      const materialExists = [...materialSelect.options].some(opt => opt.value === currentMaterial);
      if (!materialExists || resetDependent) {
        materialSelect.value = 'all';
        selectedMaterial = 'all';
      } else {
        materialSelect.value = currentMaterial;
      }
    }

    function filterAndProcessData() {
      const filteredData = getFilteredData();

      // Process filtered data for monthly chart and stats
      const monthlyBuckets = {};
      const vendorTotals = {};
      let topVendor = { name: '', total: 0 };

      filteredData.forEach(row => {
        const monthKey = formatMonthYear(row.date);
        monthlyBuckets[monthKey] = (monthlyBuckets[monthKey] || 0) + row.value;

        vendorTotals[row.vendor] = (vendorTotals[row.vendor] || 0) + row.value;
        if (vendorTotals[row.vendor] > topVendor.total) {
          topVendor.name = row.vendor;
          topVendor.total = vendorTotals[row.vendor];
        }
      });

      globalMonthlyBuckets = monthlyBuckets; // Store for summary table
      updateStats(monthlyBuckets, topVendor);
      // Only render chart if its section is visible
      if (!document.getElementById('advanceTimelineChartSection').classList.contains('hidden')) {
          renderChart(monthlyBuckets);
      }


      // Process filtered data for division chart
      const locationSums = {};
      filteredData.forEach(row => {
        if (!locationSums[row.location]) {
          locationSums[row.location] = 0;
        }
        locationSums[row.location] += row.value;
      });
      globalLocationSums = locationSums; // Store for summary table

      // Only render division chart if its section is visible
      if (!document.getElementById('divisionChartSection').classList.contains('hidden')) {
          renderDivisionChart(locationSums);
      }

      // When data changes, re-render the current summary tab with default sorting
      if (!document.getElementById('summaryTableSection').classList.contains('hidden')) {
          showSummaryTab(currentSummaryTab, currentSortColumn, currentSortDirection);
      }
    }

    function updateStats(monthlyBuckets, topVendor) {
      const values = Object.values(monthlyBuckets);
      const now = new Date();

      const stats = {
        total: values.reduce((sum, val) => sum + val, 0),
        months: values.length,
        overdue6mo: 0,
        overdue12mo: 0,
        overdue24mo: 0
      };

      Object.entries(monthlyBuckets).forEach(([key, value]) => {
        const [monthStr, yearStr] = key.split('/');
        const month = parseInt(monthStr) - 1;
        const year = parseInt('20' + yearStr);
        const date = new Date(year, month);
        const diffMonths = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());

        if (diffMonths > 6) stats.overdue6mo += value;
        if (diffMonths > 12) stats.overdue12mo += value;
        if (diffMonths > 24) stats.overdue24mo += value;
      });

      document.getElementById('totalValue').textContent = `‚Çπ${formatCurrency(stats.total)}`;
      document.getElementById('monthCount').textContent = stats.months;
      document.getElementById('overdue6mo').textContent = `‚Çπ${formatCurrency(stats.overdue6mo)}`;
      document.getElementById('overdueValue').textContent = `‚Çπ${formatCurrency(stats.overdue12mo)}`;
      document.getElementById('overdue24mo').textContent = `‚Çπ${formatCurrency(stats.overdue24mo)}`;
      document.getElementById('topVendorValue').textContent = `‚Çπ${formatCurrency(topVendor.total)}`;
      document.getElementById('topVendorLabel').textContent = `Top: ${formatName(topVendor.name) || 'N/A'}`;
    }

    // Define a custom plugin for the draggable line
    const draggableLinePlugin = {
        id: 'draggableLine',
        beforeInit: function(chart) {
            // Only apply this plugin to the 'balanceChart'
            if (chart.canvas.id !== 'balanceChart') return;

            chart.draggableLineX = null; // Stores the x-coordinate of the line
            chart.isDragging = false;
            chart.leftSum = 0;
            chart.rightSum = 0;

            const canvas = chart.canvas;
            canvas.addEventListener('mousedown', (e) => {
                if (chart.canvas.id !== 'balanceChart') return; // Double check
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                // Check if click is near the line (10px tolerance on either side)
                if (chart.draggableLineX !== null && Math.abs(mouseX - chart.draggableLineX) < 10) {
                    chart.isDragging = true;
                    canvas.style.cursor = 'ew-resize';
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (chart.canvas.id !== 'balanceChart') return; // Double check
                if (chart.isDragging) {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const chartArea = chart.chartArea;
                    // Constrain the line within chart area
                    chart.draggableLineX = Math.max(chartArea.left, Math.min(mouseX, chartArea.right));
                    chart.update(); // Redraw chart
                }
            });

            canvas.addEventListener('mouseup', () => {
                if (chart.canvas.id !== 'balanceChart') return; // Double check
                if (chart.isDragging) {
                    chart.isDragging = false;
                    canvas.style.cursor = 'default';
                    chart.update(); // Final update after drag ends
                }
            });

            // Handle mouse leaving the canvas while dragging
            canvas.addEventListener('mouseleave', () => {
                if (chart.canvas.id !== 'balanceChart') return; // Double check
                if (chart.isDragging) {
                    chart.isDragging = false;
                    canvas.style.cursor = 'default';
                    chart.update();
                }
            });
        },
        afterDraw: function(chart) { // Use afterDraw for drawing elements
            // Only apply this plugin to the 'balanceChart'
            if (chart.canvas.id !== 'balanceChart') return;

            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            const labels = chart.data.labels;
            const data = chart.data.datasets[0].data; // Cumulative data

            // Initialize default position if not set
            if (chart.draggableLineX === null && labels.length > 0) {
                const latestLabel = labels[labels.length - 1];
                const [latestMonthStr, latestYearStr] = latestLabel.split('/');
                const latestDate = new Date(2000 + parseInt(latestYearStr), parseInt(latestMonthStr) - 1);

                const targetDate = new Date(latestDate);
                targetDate.setMonth(targetDate.getMonth() - 24); // 24 months prior

                let closestLabelIndex = -1;
                let minDiff = Infinity;
                labels.forEach((label, index) => {
                    const [monthStr, yearStr] = label.split('/');
                    const date = new Date(2000 + parseInt(yearStr), parseInt(monthStr) - 1);
                    const diff = Math.abs(targetDate - date);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestLabelIndex = index;
                    }
                });

                const meta = chart.getDatasetMeta(0);
                if (closestLabelIndex !== -1 && meta.data[closestLabelIndex]) {
                    chart.draggableLineX = meta.data[closestLabelIndex].x;
                } else {
                    // Fallback: if less than 24 months data, place at the start of the chart
                    chart.draggableLineX = chartArea.left;
                }
            }

            if (chart.draggableLineX !== null) {
                ctx.save();

                // Draw the vertical line
                ctx.beginPath();
                ctx.strokeStyle = '#64748b'; // Grey color for the line
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]); // Dashed line
                ctx.moveTo(chart.draggableLineX, chartArea.top);
                ctx.lineTo(chart.draggableLineX, chartArea.bottom);
                ctx.stroke();

                // Calculate sums based on line position
                const meta = chart.getDatasetMeta(0);
                let currentLeftSum = 0;
                let currentRightSum = 0;
                const totalSum = data[data.length - 1] || 0; // Total cumulative sum

                // Find the index of the data point whose X is closest to and less than or equal to the line's X
                let splitIndex = 0; // Default to first index if line is before it
                for (let i = 0; i < meta.data.length; i++) {
                    if (meta.data[i].x <= chart.draggableLineX) {
                        splitIndex = i;
                    } else {
                        break;
                    }
                }
                // If the line is past the last data point, splitIndex should be latestMonthIndex
                if (chart.draggableLineX > meta.data[labels.length - 1].x) {
                    splitIndex = labels.length - 1;
                }

                if (splitIndex !== -1) {
                    // If the line is exactly on a data point, use its value
                    if (meta.data[splitIndex].x === chart.draggableLineX) {
                        currentLeftSum = data[splitIndex];
                    } else if (splitIndex < data.length - 1) {
                        // Interpolate if the line is between two points
                        const x0 = meta.data[splitIndex].x;
                        const y0 = data[splitIndex];
                        const x1 = meta.data[splitIndex + 1].x;
                        const y1 = data[splitIndex + 1];

                        if (x1 - x0 !== 0) { // Avoid division by zero
                            currentLeftSum = y0 + (y1 - y0) * ((chart.draggableLineX - x0) / (x1 - x0));
                        } else {
                            currentLeftSum = y0; // If points are on the same X, just use y0
                        }
                    } else {
                        currentLeftSum = data[splitIndex]; // Last point
                    }
                }
                currentLeftSum = Math.max(0, currentLeftSum); // Ensure non-negative
                currentRightSum = totalSum - currentLeftSum;
                currentRightSum = Math.max(0, currentRightSum); // Ensure non-negative

                chart.leftSum = currentLeftSum;
                chart.rightSum = currentRightSum;

                // Calculate month position from latest date
                const latestMonthIndex = labels.length - 1;
                let monthsFromLatest = 0;
                if (splitIndex >= 0 && latestMonthIndex >= 0) {
                    const dateAtLineLabel = labels[splitIndex];
                    const [lineMonthStr, lineYearStr] = dateAtLineLabel.split('/');
                    const dateAtLine = new Date(2000 + parseInt(lineYearStr), parseInt(lineMonthStr) - 1);

                    const latestDateLabel = labels[latestMonthIndex];
                    const [latestMonthStr, latestYearStr] = latestDateLabel.split('/');
                    const latestDate = new Date(2000 + parseInt(latestYearStr), parseInt(latestMonthStr) - 1);

                    monthsFromLatest = (latestDate.getFullYear() - dateAtLine.getFullYear()) * 12 + (latestDate.getMonth() - dateAtLine.getMonth());
                }


                // Display sums in boxes attached to the line
                const boxHeight = 28; // Slightly bigger height
                const textPadding = 6; // Slightly more padding
                const boxY = chartArea.top + 5; // Position near the top

                // Left Sum Box (only amount)
                const leftSumText = `‚Çπ${formatCurrency(chart.leftSum)}`;
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'; // Slightly bigger font
                const leftSumTextWidth = ctx.measureText(leftSumText).width;
                const leftSumBoxWidth = leftSumTextWidth + textPadding * 2;
                const leftSumBoxX = chart.draggableLineX - leftSumBoxWidth - 5; // 5px offset from the line

                // Ensure left box doesn't go off canvas to the left
                const adjustedLeftSumBoxX = Math.max(chartArea.left, leftSumBoxX);

                ctx.fillStyle = '#ef4444'; // Red for left
                ctx.fillRect(adjustedLeftSumBoxX, boxY, leftSumBoxWidth, boxHeight);
                ctx.fillStyle = 'white';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(leftSumText, adjustedLeftSumBoxX + textPadding, boxY + boxHeight / 2);


                // Right Sum Box (only amount)
                const rightSumText = `‚Çπ${formatCurrency(chart.rightSum)}`;
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'; // Slightly bigger font
                const rightSumTextWidth = ctx.measureText(rightSumText).width;
                const rightSumBoxWidth = rightSumTextWidth + textPadding * 2;
                const rightSumBoxX = chart.draggableLineX + 5; // 5px offset from the line

                // Ensure right box doesn't go off canvas to the right
                const adjustedRightSumBoxX = Math.min(chartArea.right - rightSumBoxWidth, rightSumBoxX);

                ctx.fillStyle = '#3b82f6'; // Blue for right
                ctx.fillRect(adjustedRightSumBoxX, boxY, rightSumBoxWidth, boxHeight);
                ctx.fillStyle = 'white';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(rightSumText, adjustedRightSumBoxX + textPadding, boxY + boxHeight / 2);


                // Month Position Box (middle)
                const monthPositionText = `${monthsFromLatest} Months`; /* Changed from "Months from Latest" */
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'; // Slightly bigger font
                const monthPositionTextWidth = ctx.measureText(monthPositionText).width;
                const monthPositionBoxWidth = monthPositionTextWidth + textPadding * 2;
                const monthPositionBoxX = chart.draggableLineX - (monthPositionBoxWidth / 2);

                // Ensure month position box stays within chart area
                const adjustedMonthPositionBoxX = Math.max(chartArea.left, Math.min(monthPositionBoxX, chartArea.right - monthPositionBoxWidth));

                ctx.fillStyle = '#475569'; // Darker grey for the middle box
                ctx.fillRect(adjustedMonthPositionBoxX, chartArea.top + 40, monthPositionBoxWidth, boxHeight);
                ctx.fillStyle = 'white';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(monthPositionText, adjustedMonthPositionBoxX + textPadding, chartArea.top + 40 + boxHeight / 2);


                ctx.restore();
            }
        }
    };

    Chart.register(draggableLinePlugin);

    function renderChart(monthlyBuckets) {
      const labels = Object.keys(monthlyBuckets).sort((a, b) => {
        const [ma, ya] = a.split('/').map(n => parseInt(n));
        const [mb, yb] = b.split('/').map(n => parseInt(n));
        const da = new Date(2000 + ya, ma - 1);
        const db = new Date(2000 + yb, mb - 1);
        return da - db;
      });

      if (labels.length === 0) {
        if (chart) {
          chart.destroy();
          chart = null;
        }
        return;
      }

      const now = new Date();
      // Calculate cumulative data
      let cumulativeSum = 0;
      const cumulativeData = labels.map(label => {
        cumulativeSum += monthlyBuckets[label];
        return cumulativeSum;
      });


      const config = {
        type: 'line', /* Line chart for area */
        data: {
          labels: labels,
          datasets: [{
            label: 'Cumulative Net Balance Value', /* Updated label */
            data: cumulativeData, /* Use cumulative data */
            backgroundColor: 'rgba(59, 130, 246, 0.5)', /* Area fill color */
            borderColor: '#3b82f6', /* Line color */
            borderWidth: 2,
            fill: true, /* Enable area fill */
            tension: 0.3 /* Smooth the line */
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 300 },
          layout: { padding: 10 },
          plugins: {
            legend: { display: false },
            datalabels: {
              display: context => window.innerWidth > 640,
              anchor: 'end',
              align: 'end',
              rotation: -90,
              color: '#1e293b',
              font: { size: 9, weight: 'bold' },
              formatter: value => `‚Çπ${formatCurrency(value)}`,
              clamp: true
            },
            tooltip: {
              callbacks: {
                title: context => context[0].label, // This is the month label
                label: context => {
                  const cumulativeValue = context.raw; // This is the cumulative value
                  return `Cumulative: ‚Çπ${formatCurrency(cumulativeValue)}`;
                },
                afterLabel: context => {
                  const month = context.label;
                  const [monthStr, yearStr] = month.split('/');
                  const monthNum = parseInt(monthStr);
                  const yearNum = 2000 + parseInt(yearStr);

                  const divisions = {};
                  // Get original (non-cumulative) values for the specific month
                  // This requires re-calculating or storing non-cumulative monthly data
                  // For now, let's just get the original monthly value from globalMonthlyBuckets
                  const originalMonthlyValue = globalMonthlyBuckets[month] || 0;

                  let details = [`Monthly: ‚Çπ${formatCurrency(originalMonthlyValue)}`];

                  // Add division breakdown for the specific month (non-cumulative)
                  getFilteredData().forEach(row => {
                    const rowMonth = row.date.getMonth() + 1;
                    const rowYear = row.date.getFullYear();
                    if (rowMonth === monthNum && rowYear === yearNum) {
                      const loc = row.location;
                      if (!divisions[loc]) divisions[loc] = 0;
                      divisions[loc] += row.value;
                    }
                  });

                  const sortedDivisions = Object.entries(divisions)
                    .sort((a, b) => b[1] - a[1])
                    .map(([loc, val]) => `   ${formatName(loc)}: ‚Çπ${formatCurrency(val)}`);

                  return details.concat(sortedDivisions);
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: '#64748b',
                font: { size: 9 },
                maxRotation: 90,
                minRotation: 90
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: '#f1f5f9',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                font: { size: 11 },
                callback: value => `‚Çπ${formatCurrency(value)}`
              }
            }
          }
        },
        plugins: [ChartDataLabels, draggableLinePlugin] /* Re-added draggableLinePlugin here */
      };

      if (chart) {
        chart.destroy();
      }

      const ctx = document.getElementById('balanceChart').getContext('2d');
      chart = new Chart(ctx, config);

      // Force show tooltip on the highest bar initially
      // Removed this line to prevent default tooltip visibility
      // const maxIndex = cumulativeData.indexOf(Math.max(...cumulativeData));
      // chart.tooltip.setActiveElements([{ datasetIndex: 0, index: maxIndex }], { x: 0, y: 0 });
      chart.update();
    }




    function renderDivisionChart(locationSums) { // Now accepts locationSums as an argument
      // If no specific locationSums passed, use global (e.g., for initial load)
      if (!locationSums) {
        locationSums = {};
        allData.forEach(row => {
          if (!locationSums[row.location]) {
            locationSums[row.location] = 0;
          }
          locationSums[row.location] += row.value;
        });
        globalLocationSums = locationSums; // Ensure global is updated even if called without arg
      }


      const labels = Object.keys(locationSums).sort();
      const data = labels.map(loc => locationSums[loc]);

      // Dynamic height calculation for the chart wrapper
      const minChartHeight = 250; // Minimum height for the chart
      const heightPerBar = 40; // Estimated height needed per bar (including spacing/label)
      const dynamicHeight = Math.max(minChartHeight, labels.length * heightPerBar + 100); // Add some padding for axes

      document.getElementById('divisionChartWrapper').style.height = `${dynamicHeight}px`;


      // Destroy existing chart instance if it exists
      if (divisionChart) { // Use the new divisionChart variable
        divisionChart.destroy();
      }

      const ctx = document.getElementById('divisionChart').getContext('2d');
      divisionChart = new Chart(ctx, { // Assign to divisionChart
        type: 'bar',
        data: {
          labels: labels.map(formatName),
          datasets: [{
            label: 'Division Total',
            data: data,
            backgroundColor: '#3b82f6',
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y', /* Make it a horizontal bar chart */
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: context => `‚Çπ${formatCurrency(context.raw)}`
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'start',
              rotation: 0, /* No rotation for horizontal bars */
              color: '#dc2626', /* Red color for labels */
              backgroundColor: 'white', /* White background for labels */
              padding: 4, /* Added padding */
              borderRadius: 4, /* Added border radius */
              font: {
                weight: 'bold',
                size: 9
              },
              formatter: value => `‚Çπ${formatCurrency(value)}`,
              clamp: true
            }
          },
          scales: {
            x: { /* X-axis for values */
              beginAtZero: true,
              grid: {
                color: '#f1f5f9',
                drawBorder: false
              },
              ticks: {
                color: '#64748b',
                callback: value => `‚Çπ${formatCurrency(value)}`
              }
            },
            y: { /* Y-axis for labels (divisions) */
              ticks: { color: '#64748b', font: { size: 10 } },
              grid: { display: false }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Function to set active option button
    function setActiveOptionButton(buttonId) {
      document.querySelectorAll('.option-button-group .tab-btn').forEach(btn => {
        btn.classList.remove('active-option');
      });
      document.getElementById(buttonId).classList.add('active-option');
    }

    // NEW: Generic function to render categorized summary tables
    function renderCategorizedSummaryTable(categoryType, sortColumn = null, sortDirection = null) {
      const table = document.getElementById('miniDataTable');
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');

      // Clear existing content
      tbody.innerHTML = ''; // Clear tbody first to prevent flicker

      const now = new Date();
      const summaryData = {};
      let totalSum = 0;
      let totalOverdue6M = 0; // New total for >6M
      let totalOverdue12M = 0;
      let totalOverdue24M = 0;

      // Filter data based on global filters (location, unit, vendor, material)
      const filteredData = getFilteredData();

      filteredData.forEach(row => {
        const categoryKey = row[categoryType] || 'Unknown';
        if (!summaryData[categoryKey]) {
          summaryData[categoryKey] = { total: 0, overdue6M: 0, overdue12M: 0, overdue24M: 0 }; // Added overdue6M
        }

        summaryData[categoryKey].total += row.value;
        totalSum += row.value; // Accumulate overall total

        const diffMonths = (now.getFullYear() - row.date.getFullYear()) * 12 + (now.getMonth() - row.date.getMonth());

        if (diffMonths > 6) { // Condition for >6M
          summaryData[categoryKey].overdue6M += row.value;
          totalOverdue6M += row.value; // Accumulate overall overdue >6M
        }
        if (diffMonths > 12) {
          summaryData[categoryKey].overdue12M += row.value;
          totalOverdue12M += row.value; // Accumulate overall overdue >12M
        }
        if (diffMonths > 24) {
          summaryData[categoryKey].overdue24M += row.value;
          totalOverdue24M += row.value; // Accumulate overall overdue >24M
        }
      });

      // Set table headers with sorting icons
      const categoryHeaderName = categoryType === 'vendor' ? 'Agency' : categoryType.charAt(0).toUpperCase() + categoryType.slice(1);
      
      // Store the actual data key for sorting
      const categorySortKey = categoryType; 

      // Add "Sl. No." header (not sortable) and updated overdue headers
      thead.innerHTML = `
        <th>Sl.</th>
        <th data-sort-key="${categorySortKey}">${categoryHeaderName} <span class="sort-icon"></span></th>
        <th data-sort-key="total">Total <span class="sort-icon"></span></th>
        <th data-sort-key="overdue6M">>6M <span class="sort-icon"></span></th>
        <th data-sort-key="overdue12M">>12M <span class="sort-icon"></span></th>
        <th data-sort-key="overdue24M">>24M <span class="sort-icon"></span></th>
      `;

      // Attach click listeners to headers for sorting (excluding Sl. No.)
      thead.querySelectorAll('th[data-sort-key]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.sortKey;
          let direction = 'desc'; // Default sort direction for new column click

          if (currentSortColumn === key) {
            // If clicking the same column, toggle direction
            direction = currentSortDirection === 'asc' ? 'desc' : 'asc';
          }
          currentSortColumn = key;
          currentSortDirection = direction;
          renderCategorizedSummaryTable(categoryType, currentSortColumn, currentSortDirection);
        });
      });

      // Apply sorting logic
      let sortedData = Object.entries(summaryData);

      if (sortColumn) {
        sortedData.sort((a, b) => {
          let valA, valB;
          if (sortColumn === categorySortKey) { // Sorting by category name (string)
            valA = formatName(a[0]);
            valB = formatName(b[0]);
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else { // Sorting by numeric values
            valA = a[1][sortColumn];
            valB = b[1][sortColumn];
            return sortDirection === 'asc' ? valA - valB : valB - valA;
          }
        });
      } else {
          // Default sort by total if no sortColumn is provided (initial load)
          sortedData.sort((a, b) => b[1].total - a[1].total);
          currentSortColumn = 'total';
          currentSortDirection = 'desc';
      }

      // Update sort icons
      thead.querySelectorAll('th[data-sort-key]').forEach(th => {
        const icon = th.querySelector('.sort-icon');
        if (th.dataset.sortKey === currentSortColumn) {
          icon.innerHTML = currentSortDirection === 'asc' ? '&#9650;' : '&#9660;'; // Up or Down arrow
        } else {
          icon.innerHTML = ''; // Clear icon for other columns
        }
      });


      sortedData.forEach(([key, data], index) => { // Added index for Sl. No.
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td> <!-- Serial Number -->
          <td>${formatName(key)}</td>
          <td>‚Çπ${formatCurrency(data.total)}</td>
          <td style="color:${data.overdue6M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(data.overdue6M)}</td>
          <td style="color:${data.overdue12M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(data.overdue12M)}</td>
          <td style="color:${data.overdue24M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(data.overdue24M)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Add total row at the end
      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = 'bold';
      totalRow.style.backgroundColor = '#e0e7ff'; /* Light blue background for total row */
      totalRow.innerHTML = `
        <td></td> <!-- Empty for Sl. No. -->
        <td>Total</td>
        <td>‚Çπ${formatCurrency(totalSum)}</td>
        <td style="color:${totalOverdue6M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(totalOverdue6M)}</td>
        <td style="color:${totalOverdue12M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(totalOverdue12M)}</td>
        <td style="color:${totalOverdue24M > 0 ? '#dc2626' : 'inherit'};">‚Çπ${formatCurrency(totalOverdue24M)}</td>
      `;
      tbody.appendChild(totalRow);
    }


    // Function to switch between summary tabs
    function showSummaryTab(tabName) {
      currentSummaryTab = tabName;
      // Reset sorting when switching tabs
      currentSortColumn = null;
      currentSortDirection = 'desc';

      // Update active tab styling
      document.getElementById('divisionSummaryTabBtn').classList.remove('active-tab');
      document.getElementById('unitSummaryTabBtn').classList.remove('active-tab');
      document.getElementById('agencySummaryTabBtn').classList.remove('active-tab');

      if (tabName === 'division') {
        document.getElementById('divisionSummaryTabBtn').classList.add('active-tab');
        renderCategorizedSummaryTable('location'); // Use 'location' as the internal key for Division
      } else if (tabName === 'unit') {
        document.getElementById('unitSummaryTabBtn').classList.add('active-tab');
        renderCategorizedSummaryTable('unit');
      } else if (tabName === 'agency') {
        document.getElementById('agencySummaryTabBtn').classList.add('active-tab');
        renderCategorizedSummaryTable('vendor'); // Use 'vendor' as the internal key for Agency
      }

      // Adjust the max-height of the collapsible content to fit the new table
      const content = document.getElementById('summaryTableContent');
      if (!content.classList.contains('hidden')) {
        content.style.maxHeight = content.scrollHeight + 'px';
      }
    }


    async function checkDataAge() {
      const outdatedDivisions = [];
      const today = new Date();

      const checkPromises = Object.entries(sources).map(async ([division, url]) => {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            // Log the specific URL that failed and its status, then skip this location
            console.error(`Failed to fetch data for ${division}: HTTP ${response.status} from ${url}`);
            return;
          }
          const text = await response.text();
          const lines = text.trim().split('\n');

          if (lines.length < 2) {
            outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî No data row found ‚ùå</div>`);
            return;
          }

          const firstRow = lines[1].split(',');
          const dateStr = firstRow[0].trim();

          if (!/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(dateStr)) {
            outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî Invalid or missing date ‚ùå</div>`);
            return;
          }

          const [dd, mm, yyyy] = dateStr.split(/[/-]/).map(Number);
          const fileDate = new Date(yyyy, mm - 1, dd);
          const diffDays = Math.floor((today - fileDate) / (1000 * 60 * 60 * 24));

          const line = `${formatName(division)} - ${diffDays} Days Old Data`;
          outdatedDivisions.push(
            `<div style="color: ${diffDays > 10 ? '#dc2626' : '#16a34a'}; font-weight: 500;">${line} ${diffDays > 10 ? '‚ùå' : '‚úÖ'}</div>`
          );
        } catch (err) {
          outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî Fetch error ‚ùå</div>`);
        }
      });

      await Promise.all(checkPromises);

      if (outdatedDivisions.length > 0) {
        const alertBox = document.getElementById('dataAgeAlert');
        const message = document.getElementById('dataAgeMessage');
        message.innerHTML = outdatedDivisions.join('');
        alertBox.style.display = 'flex';
        document.getElementById('initialLoader').style.display = 'none';

        return new Promise(resolve => {
          document.getElementById('dataAgeProceedBtn').onclick = () => {
            alertBox.style.display = 'none';
            resolve();
          };
        });
      } else {
        document.getElementById('initialLoader').style.display = 'none';
        return Promise.resolve(); // ‚úÖ Continue to loadData
      }
    }




    async function loadData() {
      toggleLoading(true);
      allData = [];

      const urls = Object.entries(sources);
      const promises = urls.map(async ([location, url]) => {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            // Log the specific URL that failed and its status, then skip this location
            console.error(`Failed to fetch data for ${location}: HTTP ${response.status} from ${url}`);
            return;
          }
          const csvText = await response.text();

          const results = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: false
          });

          const sampleRow = results.data[0] || {};
          const balanceCol = findColumn(sampleRow, ['Net Balance Value', 'Net Balance', 'Balance Value', 'Balance']);
          const dateCol = findColumn(sampleRow, ['Issued Date', 'Issue Date', 'Date']);
          const unitCol = findColumn(sampleRow, ['Unit', 'Units']);
          const vendorCol = findColumn(sampleRow, ['VendorName', 'Vendor']);
          const projectCol = findColumn(sampleRow, ['Project ID', 'ProjectID', 'Project Id', 'Project']);


          if (!balanceCol || !dateCol) {
            console.warn(`Missing columns in ${location}`);
            return;
          }

          results.data.forEach(row => {
            const dateValue = row[dateCol];
            const balanceValue = row[balanceCol];
            if (!dateValue || !balanceValue || balanceValue === '') return;

            const date = parseDate(dateValue);
            if (!date) return;

            let cleanValue = String(balanceValue).trim();
            cleanValue = cleanValue.replace(/[‚Çπ,\s]/g, '').replace(/[^\d.-]/g, '');
            const value = parseFloat(cleanValue);
            if (isNaN(value)) return;

            const qtyCol = findColumn(sampleRow, ['Net Balance Qty', 'Qty', 'Quantity']);
            const quantityRaw = qtyCol ? row[qtyCol]?.trim() : '';
            let quantity = parseFloat(String(quantityRaw).replace(/[^\d.-]/g, ''));
            if (isNaN(quantity)) quantity = 0;

            allData.push({
              location: location,
              unit: unitCol ? row[unitCol]?.trim() : 'Unknown',
              vendor: vendorCol ? row[vendorCol]?.trim() : 'Unknown',
              material: row['Material description']?.trim() || 'Unknown',
              projectid: projectCol ? row[projectCol]?.trim() : '',
              date: date,
              value: value,
              qty: quantity
            });




          });
        } catch (error) {
          // Catch any other errors during fetch or parsing for this specific URL
          console.error(`Error processing data for ${location} from ${url}:`, error);
        }
      });

      await Promise.all(promises);
      populateDropdowns(true); // Reset all dependent filters on initial load
      filterAndProcessData();
      // No initial render of charts/tables here, as they will be hidden by default
      // and rendered when their respective buttons are clicked.


      toggleLoading(false); // Ensure loading is hidden even if some fetches fail
    }

    // Event listeners
    document.getElementById("locationFilter").addEventListener("change", e => {
      selectedLocation = e.target.value;
      populateDropdowns(true); // Reset dependent filters when location changes
      filterAndProcessData();
    });

    document.getElementById("unitFilter").addEventListener("change", e => {
      selectedUnit = e.target.value;
      populateDropdowns(false); // Update vendor and material dropdown based on unit selection
      filterAndProcessData();
    });

    document.getElementById("vendorFilter").addEventListener("change", e => {
      selectedVendor = e.target.value;
      populateDropdowns(false); // Update material dropdown based on vendor selection
      filterAndProcessData();
    });

    // New event listener for material filter
    document.getElementById("materialFilter").addEventListener("change", e => {
      selectedMaterial = e.target.value;
      filterAndProcessData();
    });

    populateLocationDropdown();


    // Initial load
    checkDataAge().then(() => {
      loadData().then(() => {
        showStartupAlerts();
      });

    });


    // Now define the showStartupAlerts function below:
    function showStartupAlerts() {
      const data = allData;
      if (!data.length) {
        document.getElementById('initialLoader').style.display = 'none'; // ‚úÖ hide if no data
        return;
      }

      const summary = { all: {}, overdue: {} };

      for (const row of data) {
        const ageInMonths = (new Date() - row.date) / (1000 * 60 * 60 * 24 * 30);
        ['location', 'unit', 'vendor'].forEach(key => {
          const val = row[key] || 'Unknown';
          if (!summary.all[key]) summary.all[key] = {};
          if (!summary.overdue[key]) summary.overdue[key] = {};
          summary.all[key][val] = (summary.all[key][val] || 0) + row.value;
          if (ageInMonths > 12) summary.overdue[key][val] = (summary.overdue[key][val] || 0) + row.value;
        });
      }

      function topName(map) {
        const entries = Object.entries(map || {});
        if (!entries.length) return ['-', 0];
        const [name, val] = entries.sort((a, b) => b[1] - a[1])[0];
        return [name, val];
      }

      const alerts = [];

      // Add alerts for top 3 total balance divisions
      const sortedDivisions = Object.entries(summary.all.location || {}).sort((a, b) => b[1] - a[1]);
      if (sortedDivisions.length > 0) {
        alerts.push(`<strong>Top Divisions by Total Balance:</strong><br>${sortedDivisions.slice(0, 3).map(([name, val]) => `${formatName(name)}: ‚Çπ${formatCurrency(val)}`).join('<br>')}`);
      }

      // Add alerts for top 3 overdue divisions
      const sortedOverdueDivisions = Object.entries(summary.overdue.location || {}).sort((a, b) => b[1] - a[1]);
      if (sortedOverdueDivisions.length > 0) {
        alerts.push(`<strong>Top Divisions by Overdue Balance (>12mo):</strong><br>${sortedOverdueDivisions.slice(0, 3).map(([name, val]) => `<span style="color:#dc2626;">${formatName(name)}: ‚Çπ${formatCurrency(val)}</span>`).join('<br>')}`);
      }

      // Add alerts for top 3 total balance vendors
      const sortedVendors = Object.entries(summary.all.vendor || {}).sort((a, b) => b[1] - a[1]);
      if (sortedVendors.length > 0) {
        alerts.push(`<strong>Top Vendors by Total Balance:</strong><br>${sortedVendors.slice(0, 3).map(([name, val]) => `${formatName(name)}: ‚Çπ${formatCurrency(val)}`).join('<br>')}`);
      }

      // Add alerts for top 3 overdue vendors
      const sortedOverdueVendors = Object.entries(summary.overdue.vendor || {}).sort((a, b) => b[1] - a[1]);
      if (sortedOverdueVendors.length > 0) {
        alerts.push(`<strong>Top Vendors by Overdue Balance (>12mo):</strong><br>${sortedOverdueVendors.slice(0, 3).map(([name, val]) => `<span style="color:#dc2626;">${formatName(name)}: ‚Çπ${formatCurrency(val)}</span>`).join('<br>')}`);
      }

      if (!alerts.length) {
        document.getElementById('initialLoader').style.display = 'none'; // ‚úÖ hide loader if no alerts
        return;
      }

      let idx = 0;
      const alertBox = document.getElementById('startupAlert');
      const alertText = document.getElementById('alertText');

      const updateAlert = () => {
        alertText.innerHTML = alerts[idx];
        document.getElementById('prevAlertBtn').disabled = idx === 0;
        document.getElementById('nextAlertBtn').disabled = idx === alerts.length - 1;
      };

      document.getElementById('prevAlertBtn').onclick = () => {
        if (idx > 0) { idx--; updateAlert(); }
      };
      document.getElementById('nextAlertBtn').onclick = () => {
        if (idx < alerts.length - 1) { idx++; updateAlert(); }
      };
      document.getElementById('okAlertBtn').onclick = () => {
        alertBox.style.display = 'none';
      };

      alertBox.style.display = 'flex';

      // ‚úÖ hide loader when modal appears
      document.getElementById('initialLoader').style.display = 'none';

      updateAlert();
    }



    let modalDataMap = {}; // holds the currently rendered map
    let currentModalType = 'division'; // current tab, default to division

    // Modified openModal to store the filterFn
    function openModal(type = 'division', filterFn = null) {
      currentModalType = type;
      currentModalFilterFn = filterFn; // Store the filter function
      document.getElementById('detailsModal').classList.remove('hidden');
      renderDetails(type, currentModalFilterFn); // Pass the stored filterFn
    }

    function closeModal() {
      document.getElementById('detailsModal').classList.add('hidden');
      currentModalFilterFn = null; // Clear the filter function when modal closes
    }

    // Filter modal items based on search input
    function filterModalItems() {
      const search = document.getElementById('modalSearch').value.trim().toLowerCase();
      const items = document.querySelectorAll('.modal-item');
      items.forEach(item => {
        item.classList.toggle('hidden', !item.textContent.toLowerCase().includes(search));
      });
    }

    function exportModalToCSV() {
      const rows = [["Category", "Amount"]];
      for (const [key, value] of Object.entries(modalDataMap)) {
        rows.push([key, value]);
      }
      const csv = rows.map(r => r.join(",")).join("\n");
      const base64 = btoa(unescape(encodeURIComponent(csv)));
      const filename = `${currentModalType}_summary.csv`;

      const isAndroid = typeof window.AndroidBridge === "object" && typeof AndroidBridge.saveCsvBase64 === "function";

      if (isAndroid) {
        AndroidBridge.saveCsvBase64(base64, filename);
      } else {
        // Browser fallback
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Show message in browser
        // alert("CSV saved in Downloads folder"); // Replaced alert with custom modal if needed
      }
    }



    // Render filtered totals in modal
    function renderDetails(type, filterFn = null) {
      // Apply global filters first, then the card-specific filter
      const filtered = getFilteredData().filter(row => (typeof filterFn === 'function' ? filterFn(row) : true));
      modalDataMap = {};

      if (type === 'material') {
        const materialMap = {};

        filtered.forEach(row => {
          const mat = row.material || 'Unknown';
          if (!materialMap[mat]) {
            materialMap[mat] = { total: 0, qty: 0, projectIds: new Set() };
          }
          materialMap[mat].total += row.value;
          materialMap[mat].qty += row.qty || 0;

          if (row['projectid']) {
            materialMap[mat].projectIds.add(row['projectid']);
          }
        });

        modalDataMap = {}; // for CSV export

        const sorted = Object.entries(materialMap).sort((a, b) => b[1].total - a[1].total);
        const listHTML = sorted.map(([key, data], index) => {
          modalDataMap[key] = data.total;

          const projectList = Array.from(data.projectIds).join(", ");
          const projectLine = projectList
            ? `<div style="font-size: 0.75rem; font-style: italic; color: #555;">(${projectList})</div>`
            : '';
          return `<div class="modal-item"><strong>${index + 1}.</strong> ${key}: ‚Çπ${formatCurrency(data.total)} <span style="color:#555;">(Qty: ${data.qty})</span> ${projectLine}</div>`;
        }).join('');

        document.getElementById('modalTitle').textContent = `Material Wise Summary`;
        document.getElementById('modalContent').innerHTML = listHTML;

      } else if (type === 'division') {
        filtered.forEach(row => {
          const key = row.location;
          if (!modalDataMap[key]) modalDataMap[key] = 0;
          modalDataMap[key] += row.value;
        });

        const sorted = Object.entries(modalDataMap).sort((a, b) => b[1] - a[1]);
        const listHTML = sorted.map(([key, val], index) =>
          `<div class="modal-item"><strong>${index + 1}.</strong> ${formatName(key)}: ‚Çπ${formatCurrency(val)}</div>`
        ).join('');

        document.getElementById('modalTitle').textContent = `Division Wise Summary`;
        document.getElementById('modalContent').innerHTML = listHTML;

      } else {
        // Handle unit or vendor summary
        filtered.forEach(row => {
          const key = type === 'unit' ? row.unit : row.vendor;
          if (!modalDataMap[key]) modalDataMap[key] = 0;
          modalDataMap[key] += row.value;
        });

        const sorted = Object.entries(modalDataMap).sort((a, b) => b[1] - a[1]);
        const listHTML = sorted.map(([key, val], index) =>
          `<div class="modal-item"><strong>${index + 1}.</strong> ${formatName(key)}: ‚Çπ${formatCurrency(val)}</div>`
        ).join('');

        document.getElementById('modalTitle').textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Wise Summary`;
        document.getElementById('modalContent').innerHTML = listHTML;
      }


      // Reset search input
      document.getElementById('modalSearch').value = '';

      // Highlight selected tab
      document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active-tab');
      });
      const tabOrder = ['division', 'unit', 'vendor', 'material'];
      document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => {
        btn.classList.remove('active-tab');
      });
      document.querySelector(`.modal-tabs .tab-btn:nth-child(${tabOrder.indexOf(type) + 1})`)?.classList.add('active-tab');

    }


    // === Add this at the bottom of the script ===
    let isMouseOverLine = false; // Global flag for cursor logic

    document.addEventListener("DOMContentLoaded", () => {
      const statCards = document.querySelectorAll('.stat-card');

      statCards.forEach((card, i) => {
        card.addEventListener('click', () => {
          if (i === 0) openModal('division'); // Total Balance
          else if (i === 1) openModal('division'); // Active Months
          else if (i === 2) openModal('division', row => {
            const now = new Date();
            const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
            return diff > 6;
          }); // Overdue >6mo
          else if (i === 3) openModal('division', row => {
            const now = new Date();
            const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
            return diff > 12;
          }); // Overdue >12mo
          else if (i === 4) openModal('division', row => {
            const now = new Date();
            const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
            return diff > 24;
          }); // Overdue >24mo
          else if (i === 5) openModal('vendor'); // Top Vendor
        });
      });

      // Removed the click listener for summaryTableHeader to disable collapse
      // document.getElementById('summaryTableHeader').addEventListener('click', toggleSummaryTable);

      // UPDATED: Event listeners for new summary tabs
      document.getElementById('divisionSummaryTabBtn').addEventListener('click', () => showSummaryTab('division'));
      document.getElementById('unitSummaryTabBtn').addEventListener('click', () => showSummaryTab('unit'));
      document.getElementById('agencySummaryTabBtn').addEventListener('click', () => showSummaryTab('agency'));

      // NEW: Event listeners for option buttons
      document.getElementById('viewTimelineChartBtn').addEventListener('click', () => {
        document.getElementById('advanceTimelineChartSection').classList.remove('hidden');
        document.getElementById('divisionChartSection').classList.add('hidden');
        document.getElementById('summaryTableSection').classList.add('hidden');
        renderChart(globalMonthlyBuckets); // Re-render chart when shown
        setActiveOptionButton('viewTimelineChartBtn'); // Highlight this button
      });

      document.getElementById('viewDivisionChartBtn').addEventListener('click', () => {
        document.getElementById('divisionChartSection').classList.remove('hidden');
        document.getElementById('advanceTimelineChartSection').classList.add('hidden');
        document.getElementById('summaryTableSection').classList.add('hidden');
        renderDivisionChart(globalLocationSums); // Re-render chart when shown
        setActiveOptionButton('viewDivisionChartBtn'); // Highlight this button
      });

      document.getElementById('viewSummaryTableBtn').addEventListener('click', () => {
        document.getElementById('summaryTableSection').classList.remove('hidden');
        document.getElementById('advanceTimelineChartSection').classList.add('hidden');
        document.getElementById('divisionChartSection').classList.add('hidden');
        // Ensure summary table content is always visible when this button is clicked
        document.getElementById('summaryTableContent').classList.remove('hidden');
        document.getElementById('summaryTableContent').style.maxHeight = document.getElementById('summaryTableContent').scrollHeight + 'px';

        showSummaryTab(currentSummaryTab); // Re-render table when shown
        setActiveOptionButton('viewSummaryTableBtn'); // Highlight this button
      });


      // Re-added balanceChartCanvas event listeners as draggableLinePlugin is re-added
      const balanceChartCanvas = document.getElementById('balanceChart');
      if (balanceChartCanvas) {
          balanceChartCanvas.addEventListener('mousemove', (e) => {
              // Ensure chart is initialized and not currently dragging by the user
              if (!chart || chart.isDragging) return;

              const rect = balanceChartCanvas.getBoundingClientRect();
              const mouseX = e.clientX - rect.left;

              // Check if mouse is over the draggable line area
              if (chart.draggableLineX !== null && Math.abs(mouseX - chart.draggableLineX) < 10) {
                  if (!isMouseOverLine) {
                      balanceChartCanvas.style.cursor = 'ew-resize';
                      isMouseOverLine = true;
                  }
              } else {
                  if (isMouseOverLine) {
                      balanceChartCanvas.style.cursor = 'default';
                      isMouseOverLine = false;
                  }
              }
          });

          balanceChartCanvas.addEventListener('mouseleave', () => {
              // Only reset cursor if not currently dragging
              if (isMouseOverLine && !chart.isDragging) {
                  balanceChartCanvas.style.cursor = 'default';
                  isMouseOverLine = false;
              }
          });
      }
    });

    function formatName(text) {
      if (!text || typeof text !== 'string') return '';
      if (text.trim().toLowerCase() === 'ccc') return 'CCC'; // leave CCC as is
      return text
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

  </script>

  <div id="detailsModal" class="hidden">
    <div class="modal-backdrop">
      <div class="modal-box">
        <div class="modal-header">
          <h3 id="modalTitle">Details</h3>
          <button onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-tabs">
          <!-- MODIFIED: Pass currentModalFilterFn to each tab's renderDetails call -->
          <button onclick="renderDetails('division', currentModalFilterFn)" class="tab-btn">Division</button>
          <button onclick="renderDetails('unit', currentModalFilterFn)" class="tab-btn">Unit</button>
          <button onclick="renderDetails('vendor', currentModalFilterFn)" class="tab-btn">Vendor</button>
          <button onclick="renderDetails('material', currentModalFilterFn)" class="tab-btn">Material</button>
        </div>

        <div style="padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
          <input id="modalSearch" placeholder="Search..." style="flex: 1; padding: 0.4rem; font-size: 0.85rem; border: 1px solid #ccc; border-radius: 4px;" oninput="filterModalItems()" />
          <button onclick="exportModalToCSV()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Export CSV</button>
        </div>
        <div id="modalContent" class="modal-body"></div>
      </div>
    </div>
  </div>

  <div id="startupAlert" class="modal-backdrop" style="display:none;">
    <div class="modal-box" style="max-width:400px; padding:1rem; text-align:center;">
      <div style="font-weight:600; font-size:1rem; margin-bottom:0.5rem;">üö® Critical Summary</div>
      <div id="alertText" style="font-size:0.85rem; min-height:60px;"></div>
      <div style="margin-top:1rem; display:flex; justify-content:space-between;">
        <button id="prevAlertBtn" class="tab-btn">‚¨Ö Prev</button>
        <button id="nextAlertBtn" class="tab-btn">Next ‚û°</button>
        <button id="okAlertBtn" class="tab-btn" style="background:#3b82f6; color:white;">OK</button>
      </div>
    </div>
  </div>

  <div id="dataAgeAlert" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 3000;">
    <div class="modal-box" style="max-width: 500px; text-align: center; padding: 1rem;">
      <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem;">‚ö†Ô∏è Data Age Alert</div>
      <div id="dataAgeMessage" style="font-size: 0.9rem; padding: 0.5rem; max-height: 60vh; overflow-y: auto;"></div>
      <button id="dataAgeProceedBtn" class="tab-btn" style="margin-top: 1rem; background: #2563eb; color: white;">Proceed</button>
    </div>
  </div>

  <div id="initialLoader" class="fullscreen-modal" style="display:flex;">
    <div style="text-align: center;">
      <div class="loading-spinner" style="margin: 1rem auto;"></div>
      <div style="color:white; font-size: 1rem;">Initializing Dashboard...</div>
    </div>
  </div>

</body>
</html>
