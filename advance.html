
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Net Balance Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">


  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      padding: 0.5rem;
      color: #1e293b;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

.header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 1rem;
  text-align: center;
  z-index: 1000;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Add space so content is not hidden under the header */
.app-container {
  padding-top: 50px;
}



    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.025em;
    }

    .controls {
      padding: 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .control-label {
      font-weight: 500;
      color: #475569;
      font-size: 0.875rem;
    }

    select {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 0.875rem;
      color: #374151;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 0.5rem;
  padding: 0.5rem;
  margin: 0.5rem 0;
}

.stat-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 0.75rem;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  transition: transform 0.15s ease, background 0.15s ease;
}

.stat-card:hover {
  background: #f1f5f9;
  transform: translateY(-2px);
}

.stat-value {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 0.2rem;
}

.stat-label {
  font-size: 0.7rem;
  color: #6b7280;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}


    .chart-container {
      padding: 1rem;
      position: relative;
    }

    .chart-wrapper {
      height: 500px;
      position: relative;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      border-radius: 8px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #64748b;
      font-size: 0.875rem;
      font-weight: 500;
    }

.hidden {
  display: none !important;
}


    /* Mobile optimizations */
@media (max-width: 640px) {
  body {
    padding: 0.2rem;
    font-size: 14px;
    background: #f9fafb;
  }

  .header {
    padding: 0.4rem 0.5rem;
  }

  .header h1 {
    font-size: 1rem;
  }

  .app-container {
    border-radius: 6px;
    padding-top: 3.5rem;
  }

  .controls {
    padding: 0.2rem;
    gap: 0.4rem;
    grid-template-columns: 1fr;
  }

  .control-label {
    font-size: 0.75rem;
  }

  select {
    padding: 0.35rem;
    font-size: 0.75rem;
  }

  .stats-grid {
    margin: 0.25rem 0;
    gap: 0.3rem;
  }

  .stat-card {
    padding: 0.4rem;
    border-radius: 8px;
  }

  .stat-value {
    font-size: 0.85rem;
  }

  .stat-label {
    font-size: 0.65rem;
  }

  .chart-container {
    padding: 0.3rem;
  }

  .chart-wrapper {
    height: 280px;
  }

  .modal-box {
    font-size: 0.8rem;
  }

  .modal-header h3 {
    font-size: 0.9rem;
  }

  .tab-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .chart-wrapper {
    height: 280px;
  }
}

body {
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-size: 15px;
}

select,
input {
  font-family: inherit;
  line-height: 1.2;
}

    .tab-btn {
  padding: 0.5rem 1rem;
  background: #e5e7eb;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
}
.tab-btn:hover {
  background: #d1d5db;
}
/* Modal Layout */
#detailsModal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: none;
}
#detailsModal:not(.hidden) {
  display: flex;
}
.modal-backdrop {
  flex: 1;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}
.modal-box {
  background: white;
  border-radius: 8px;
  max-height: 90vh;
  width: 100%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-size: 0.85rem;
}
.modal-header {
  background: #f1f5f9;
  padding: 0.75rem 1rem;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid #e5e7eb;
}
.modal-header h3 {
  margin: 0;
  font-size: 1rem;
}
.modal-header button {
  background: none;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
}
.modal-tabs {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-bottom: 1px solid #e2e8f0;
  position: sticky;
  top: 42px;
  background: white;
  z-index: 9;
}
.tab-btn {
  padding: 0.25rem 0.75rem;
  font-size: 0.85rem;
  background: #e5e7eb;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.tab-btn:hover {
  background: #d1d5db;
}
.modal-body {
  overflow-y: auto;
  padding: 1rem;
  max-height: calc(90vh - 100px);
}
.modal-item {
  padding: 0.5rem 0;
  border-bottom: 1px solid #f1f5f9;
  font-size: 0.85rem;
}
.modal-item {
  padding: 0.4rem 0;
  border-bottom: 1px solid #f1f5f9;
  font-size: 0.85rem;
  display: block;
}
.modal-item.hidden {
  display: none;
}
@media (min-width: 768px) {
  .modal-box {
    max-width: 900px;
  }
}
.tab-btn.active-tab {
  background: #3b82f6;
  color: white;
}
#topVendorValue {
  color: #dc2626; /* Tailwind Red-600 */
}
/* Skeleton loading style */
.skeleton {
  background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
  background-size: 400% 100%;
  animation: shimmer 1.2s ease-in-out infinite;
  border-radius: 6px;
}

@keyframes shimmer {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}
#startupAlert {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6); /* dark overlay */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
@media (max-width: 640px) {
  #startupAlert .modal-box {
    max-width: 90vw;
    font-size: 0.8rem;
    padding: 0.75rem;
  }
}
.fullscreen-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}
/* Styles for the new data table */
.data-table-container {
  padding: 1rem;
  margin-top: 1rem;
  background: white;
  border-top: 1px solid #e2e8f0;
  overflow-x: auto; /* Enable horizontal scrolling for small screens */
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
  font-size: 0.85rem;
}

.data-table th,
.data-table td {
  border: 1px solid #e5e7eb;
  padding: 0.6rem 0.8rem;
  text-align: left;
}

.data-table th {
  background: #f1f5f9;
  font-weight: 600;
  color: #475569;
  white-space: nowrap; /* Prevent wrapping of headers */
}

.data-table tbody tr:nth-child(even) {
  background: #f8fafc;
}

.data-table tbody tr:hover {
  background: #eff6ff; /* Light blue on hover */
}

@media (max-width: 640px) {
  .data-table-container {
    padding: 0.5rem;
  }
  .data-table th,
  .data-table td {
    padding: 0.4rem 0.6rem;
    font-size: 0.75rem;
  }
}

.summary-table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  color: #1e293b;
}

.summary-table-header .bx {
  font-size: 1.2rem;
  transition: transform 0.2s ease-in-out;
}

.summary-table-header.collapsed .bx {
  transform: rotate(-90deg);
}

.summary-table-content {
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  max-height: 1000px; /* Arbitrary large value for expanded state */
}

.summary-table-content.hidden {
  max-height: 0;
  padding-bottom: 0;
  padding-top: 0;
}

.summary-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.summary-tabs .tab-btn {
  flex: 1;
  text-align: center;
  padding: 0.5rem;
  font-size: 0.875rem;
}
  </style>
</head>
<body>
  
      <div class="header">
      <h1>üìä Advance to Vendors</h1>
    </div>
  <div class="app-container">
    <div class="controls">
      <div class="control-group">
        <select id="locationFilter">
          <option value="all">All Divisions</option>
          <option value="Balurghat">Balurghat</option>
          <option value="Malda">Malda</option>
          <option value="Raiganj">Raiganj</option>
          <option value="Buniadpur">Buniadpur</option>
            <option value="Gazole">Gazole</option>
              <option value="Islampur">Islampur</option>
  <option value="Chanchal">Chanchal</option>


        </select>
      </div>
      
      <div class="control-group">
        <select id="unitFilter">
          <option value="all">All Units</option>
        </select>
      </div>

      <div class="control-group">
        <select id="vendorFilter">
          <option value="all">All Vendors</option>
        </select>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalValue">‚Çπ0</div>
        <div class="stat-label">Total Balance</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="monthCount">0</div>
        <div class="stat-label">Active Months</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="overdue6mo">‚Çπ0</div>
        <div class="stat-label">Overdue (&gt;6mo)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="overdueValue">‚Çπ0</div>
        <div class="stat-label">Overdue (&gt;12mo)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="overdue24mo">‚Çπ0</div>
        <div class="stat-label">Overdue (&gt;24mo)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="topVendorValue">‚Çπ0</div>
        <div class="stat-label" id="topVendorLabel">Top Vendor</div>
      </div>
    </div>

    <div class="chart-container">
      <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üìà Advance Timeline</h2>
      <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading data...</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
<div class="chart-container">
  <h2 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">üìç Division-wise Advance</h2>
  
  <div class="loading-overlay hidden" id="divisionLoadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Preparing chart...</div>
  </div>

  <div class="chart-wrapper">
    <canvas id="divisionChart"></canvas>
  </div>
</div>

    <div class="data-table-container">
      <div id="summaryTableHeader" class="summary-table-header">
        <h2>Summary Table</h2>
        <i class="bx bx-chevron-down"></i>
      </div>
      <div id="summaryTableContent" class="summary-table-content">
        <div class="summary-tabs">
          <button id="monthlySummaryTabBtn" class="tab-btn active-tab">Monthly Summary</button>
          <button id="divisionSummaryTabBtn" class="tab-btn">Division Summary</button>
        </div>
        <table id="miniDataTable" class="data-table">
          <thead>
            <tr>
              </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
const sources = {
  "Balurghat": 'data/adv_Balurghat.json',
  "Malda": 'data/adv_Malda.json',
  "Raiganj": 'data/adv_Raiganj.json',
  "Buniadpur": 'data/adv_Buniadpur.json',
  "Gazole": 'data/adv_Gazole.json',
  "Islampur": 'data/adv_Islampur.json',
  "Chanchal": 'data/adv_Chanchal.json'
};


function formatName(text) {
  if (!text || typeof text !== 'string') return '';
  if (text.trim().toLowerCase() === 'ccc') return 'CCC'; // keep CCC as is
  return text
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
function populateLocationDropdown() {
  const locationSelect = document.getElementById('locationFilter');
  locationSelect.innerHTML = `<option value="all">All Divisions</option>`;
  Object.keys(sources).sort().forEach(location => {
    const option = document.createElement('option');
    option.value = location;
    option.textContent = formatName(location);
    locationSelect.appendChild(option);
  });
}

    let allData = []; // Store all parsed data
    let selectedLocation = 'all';
    let selectedUnit = 'all';
    let selectedVendor = 'all';
    let chart;

    // Global variables to store summary data for tables
    let globalMonthlyBuckets = {};
    let globalLocationSums = {};
    let currentSummaryTab = 'monthly'; // default tab

  function toggleLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
  document.getElementById('divisionLoadingOverlay').classList.toggle('hidden', !show);

  document.querySelectorAll('.stat-card').forEach(card => {
    if (show) {
      card.classList.add('skeleton');
      card.querySelector('.stat-value').textContent = '‚Äî';
      card.querySelector('.stat-label').style.opacity = 0.6;
    } else {
      card.classList.remove('skeleton');
      card.querySelector('.stat-label').style.opacity = 1;
    }
  });
}


    function formatCurrency(value) {
      if (value >= 10000000) {
        return (value / 10000000).toFixed(1) + ' Cr';
      } else if (value >= 100000) {
        return (value / 100000).toFixed(1) + ' L';
      } else if (value >= 1000) {
        return (value / 1000).toFixed(1) + 'K';
      }
      return value.toLocaleString('en-IN');
    }

    function parseDate(dateStr) {
      if (!dateStr || typeof dateStr !== 'string') return null;
      const parts = dateStr.split(/[/-]/);
      if (parts.length !== 3) return null;
      const [day, month, year] = parts.map(p => parseInt(p));
      if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
      return new Date(year, month - 1, day);
    }

    function formatMonthYear(date) {
      const month = date.getMonth() + 1;
      const year = date.getFullYear().toString().slice(-2);
      return `${month}/${year}`;
    }

    function findColumn(row, candidates) {
      for (const candidate of candidates) {
        if (row.hasOwnProperty(candidate)) return candidate;
        const key = Object.keys(row).find(k => k.toLowerCase() === candidate.toLowerCase());
        if (key) return key;
      }
      return null;
    }

    function getFilteredData() {
      let filteredData = allData;
      
      if (selectedLocation !== 'all') {
        filteredData = filteredData.filter(row => row.location === selectedLocation);
      }
      if (selectedUnit !== 'all') {
        filteredData = filteredData.filter(row => row.unit === selectedUnit);
      }
      if (selectedVendor !== 'all') {
        filteredData = filteredData.filter(row => row.vendor === selectedVendor);
      }
      
      return filteredData;
    }

    function populateDropdowns(resetDependent = false) {
      // Get base filtered data (without vendor filter for vendor dropdown)
      let baseFilteredData = allData;
      
      if (selectedLocation !== 'all') {
        baseFilteredData = baseFilteredData.filter(row => row.location === selectedLocation);
      }
      if (selectedUnit !== 'all') {
        baseFilteredData = baseFilteredData.filter(row => row.unit === selectedUnit);
      }

      // Get units based on location filter only
      let unitFilteredData = allData;
      if (selectedLocation !== 'all') {
        unitFilteredData = unitFilteredData.filter(row => row.location === selectedLocation);
      }

      const units = new Set();
      const vendors = new Set();
      
      unitFilteredData.forEach(row => {
        if (row.unit) units.add(row.unit);
      });

      baseFilteredData.forEach(row => {
        if (row.vendor) vendors.add(row.vendor);
      });

      // Populate unit dropdown
      const unitSelect = document.getElementById('unitFilter');
      const currentUnit = unitSelect.value;
      unitSelect.innerHTML = '<option value="all">All Units</option>';
Array.from(units).sort().forEach(unit => {
  const option = document.createElement('option');
  option.value = unit;
  option.textContent = formatName(unit);
  unitSelect.appendChild(option);
});


      // Reset unit selection if it's no longer available or if we need to reset dependent filters
      const unitExists = [...unitSelect.options].some(opt => opt.value === currentUnit);
      if (!unitExists || resetDependent) {
        unitSelect.value = 'all';
        selectedUnit = 'all';
      } else {
        unitSelect.value = currentUnit;
      }

      // Populate vendor dropdown
      const vendorSelect = document.getElementById('vendorFilter');
      const currentVendor = vendorSelect.value;
      vendorSelect.innerHTML = '<option value="all">All Vendors</option>';
Array.from(vendors).sort().forEach(vendor => {
  const option = document.createElement('option');
  option.value = vendor;
  option.textContent = formatName(vendor);
  vendorSelect.appendChild(option);
});

      // Reset vendor selection if it's no longer available or if we need to reset dependent filters
      const vendorExists = [...vendorSelect.options].some(opt => opt.value === currentVendor);
      if (!vendorExists || resetDependent) {
        vendorSelect.value = 'all';
        selectedVendor = 'all';
      } else {
        vendorSelect.value = currentVendor;
      }
    }

    function filterAndProcessData() {
      const filteredData = getFilteredData();

      // Process filtered data for monthly chart and stats
      const monthlyBuckets = {};
      const vendorTotals = {};
      let topVendor = { name: '', total: 0 };

      filteredData.forEach(row => {
const monthKey = formatMonthYear(row.issuedDate);
        monthlyBuckets[monthKey] = (monthlyBuckets[monthKey] || 0) + row.value;

        vendorTotals[row.vendor] = (vendorTotals[row.vendor] || 0) + row.value;
        if (vendorTotals[row.vendor] > topVendor.total) {
          topVendor.name = row.vendor;
          topVendor.total = vendorTotals[row.vendor];
        }
      });

      globalMonthlyBuckets = monthlyBuckets; // Store for summary table
      updateStats(monthlyBuckets, topVendor);
      renderChart(monthlyBuckets);

      // Process filtered data for division chart
      const locationSums = {};
      filteredData.forEach(row => {
        if (!locationSums[row.location]) {
          locationSums[row.location] = 0;
        }
        locationSums[row.location] += row.value;
      });
      globalLocationSums = locationSums; // Store for summary table

      renderDivisionChart(locationSums); // Pass locationSums to renderDivisionChart
      showSummaryTab(currentSummaryTab); // Re-render current summary tab with new data
    }

    function updateStats(monthlyBuckets, topVendor) {
      const values = Object.values(monthlyBuckets);
      const now = new Date();
      
      const stats = {
        total: values.reduce((sum, val) => sum + val, 0),
        months: values.length,
        overdue6mo: 0,
        overdue12mo: 0,
        overdue24mo: 0
      };

      Object.entries(monthlyBuckets).forEach(([key, value]) => {
        const [monthStr, yearStr] = key.split('/');
        const month = parseInt(monthStr) - 1;
        const year = parseInt('20' + yearStr);
        const date = new Date(year, month);
const diffMonths = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());

        if (diffMonths > 6) stats.overdue6mo += value;
        if (diffMonths > 12) stats.overdue12mo += value;
        if (diffMonths > 24) stats.overdue24mo += value;
      });

      document.getElementById('totalValue').textContent = `‚Çπ${formatCurrency(stats.total)}`;
      document.getElementById('monthCount').textContent = stats.months;
      document.getElementById('overdue6mo').textContent = `‚Çπ${formatCurrency(stats.overdue6mo)}`;
      document.getElementById('overdueValue').textContent = `‚Çπ${formatCurrency(stats.overdue12mo)}`;
      document.getElementById('overdue24mo').textContent = `‚Çπ${formatCurrency(stats.overdue24mo)}`;
      document.getElementById('topVendorValue').textContent = `‚Çπ${formatCurrency(topVendor.total)}`;
      document.getElementById('topVendorLabel').textContent = `Top: ${formatName(topVendor.name) || 'N/A'}`;
    }

function renderChart(monthlyBuckets) {
  const labels = Object.keys(monthlyBuckets).sort((a, b) => {
    const [ma, ya] = a.split('/').map(n => parseInt(n));
    const [mb, yb] = b.split('/').map(n => parseInt(n));
    const da = new Date(2000 + ya, ma - 1);
    const db = new Date(2000 + yb, mb - 1);
    return da - db;
  });

  if (labels.length === 0) {
    if (chart) {
      chart.destroy();
      chart = null;
    }
    return;
  }

  const now = new Date();
  const data = labels.map(label => monthlyBuckets[label]);

  const colors = labels.map(label => {
    const [monthStr, yearStr] = label.split('/');
    const month = parseInt(monthStr) - 1;
    const year = parseInt('20' + yearStr);
    const date = new Date(year, month);
    const diffMonths = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
    return diffMonths > 12;
  });

  const backgroundColors = colors.map(isOverdue => isOverdue ? '#ef4444' : '#3b82f6');

  const config = {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Net Balance Value',
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 0,
        borderRadius: 3,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 300 },
      layout: { padding: 10 },
      plugins: {
        legend: { display: false },
        datalabels: {
          display: context => window.innerWidth > 640,
          anchor: 'end',
          align: 'end',
          rotation: -90,
          color: '#1e293b',
          font: { size: 9, weight: 'bold' },
          formatter: value => `‚Çπ${formatCurrency(value)}`,
          clamp: true
        },
        tooltip: {
          callbacks: {
            title: context => context[0].label,
            label: context => {
              const value = context.raw;
              const labelIndex = context.dataIndex;
              const status = colors[labelIndex] ? ' (Overdue)' : ' (Current)';
              return `‚Çπ${formatCurrency(value)}${status}`;
            },
            afterLabel: context => {
              const month = context.label;
              const [monthStr, yearStr] = month.split('/');
              const monthNum = parseInt(monthStr);
              const yearNum = 2000 + parseInt(yearStr);

              const divisions = {};
              getFilteredData().forEach(row => {
const issued = row.issuedDate instanceof Date ? row.issuedDate : new Date(row.issuedDate);
if (isNaN(issued)) return;

const rowMonth = issued.getMonth() + 1;
const rowYear = issued.getFullYear();

                if (rowMonth === monthNum && rowYear === yearNum) {
                  const loc = row.location;
                  if (!divisions[loc]) divisions[loc] = 0;
                  divisions[loc] += row.value;
                }
              });

              return Object.entries(divisions)
                .sort((a, b) => b[1] - a[1])
                .map(([loc, val]) => `   ${formatName(loc)}: ‚Çπ${formatCurrency(val)}`);
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            color: '#64748b',
            font: { size: 9 },
            maxRotation: 90,
            minRotation: 90
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: '#f1f5f9',
            drawBorder: false
          },
          ticks: {
            color: '#64748b',
            font: { size: 11 },
            callback: value => `‚Çπ${formatCurrency(value)}`
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  };

  if (chart) {
    chart.destroy();
  }

  const ctx = document.getElementById('balanceChart').getContext('2d');
  chart = new Chart(ctx, config);

  // Force show tooltip on the highest bar initially
  const maxIndex = data.indexOf(Math.max(...data));
  chart.tooltip.setActiveElements([{ datasetIndex: 0, index: maxIndex }], { x: 0, y: 0 });
  chart.update();
}




function renderDivisionChart(locationSums) { // Now accepts locationSums as an argument
  // If no specific locationSums passed, use global (e.g., for initial load)
  if (!locationSums) {
    locationSums = {};
    allData.forEach(row => {
      if (!locationSums[row.location]) {
        locationSums[row.location] = 0;
      }
      locationSums[row.location] += row.value;
    });
    globalLocationSums = locationSums; // Ensure global is updated even if called without arg
  }


  const labels = Object.keys(locationSums).sort();
  const data = labels.map(loc => locationSums[loc]);

  // Destroy existing chart instance if it exists
  const existingChart = Chart.getChart('divisionChart');
  if (existingChart) {
    existingChart.destroy();
  }

  const ctx = document.getElementById('divisionChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.map(formatName),
      datasets: [{
        label: 'Division Total',
        data: data,
        backgroundColor: '#3b82f6',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `‚Çπ${formatCurrency(context.raw)}`
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'start',
          rotation: -90,
          color: '#1e293b',
          font: {
            weight: 'bold',
            size: 9
          },
          formatter: value => `‚Çπ${formatCurrency(value)}`,
          clamp: true
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 10 } },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#64748b',
            callback: value => `‚Çπ${formatCurrency(value)}`
          },
          grid: { color: '#f1f5f9' }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// Function to toggle the summary table visibility
function toggleSummaryTable() {
  const content = document.getElementById('summaryTableContent');
  const header = document.getElementById('summaryTableHeader');
  const icon = header.querySelector('.bx');

  content.classList.toggle('hidden');
  header.classList.toggle('collapsed');

  // Adjust max-height based on visibility
  if (content.classList.contains('hidden')) {
    content.style.maxHeight = '0';
  } else {
    content.style.maxHeight = content.scrollHeight + 'px'; // Set to actual scroll height
  }
}

// Function to render the monthly summary table
function renderMonthlySummaryTable() {
  const table = document.getElementById('miniDataTable');
  const thead = table.querySelector('thead tr');
  const tbody = table.querySelector('tbody');

  // Clear existing content
  thead.innerHTML = '<th>Month</th><th>Total Value (‚Çπ)</th>';
  tbody.innerHTML = '';

  // Sort monthly buckets by date
  const sortedMonths = Object.keys(globalMonthlyBuckets).sort((a, b) => {
    const [ma, ya] = a.split('/').map(Number);
    const [mb, yb] = b.split('/').map(Number);
    const dateA = new Date(2000 + ya, ma - 1);
    const dateB = new Date(2000 + yb, mb - 1);
    return dateA - dateB;
  });

  sortedMonths.forEach(month => {
    const value = globalMonthlyBuckets[month];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${month}</td><td>‚Çπ${formatCurrency(value)}</td>`;
    tbody.appendChild(tr);
  });
}

// Function to render the division summary table
function renderDivisionSummaryTable() {
  const table = document.getElementById('miniDataTable');
  const thead = table.querySelector('thead tr');
  const tbody = table.querySelector('tbody');

  // Clear existing content
  thead.innerHTML = '<th>Division</th><th>Total Value (‚Çπ)</th>';
  tbody.innerHTML = '';

  // Sort divisions by value (descending)
  const sortedDivisions = Object.entries(globalLocationSums).sort((a, b) => b[1] - a[1]);

  sortedDivisions.forEach(([division, value]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${formatName(division)}</td><td>‚Çπ${formatCurrency(value)}</td>`;
    tbody.appendChild(tr);
  });
}

// Function to switch between summary tabs
function showSummaryTab(tabName) {
  currentSummaryTab = tabName;

  // Update active tab styling
  document.getElementById('monthlySummaryTabBtn').classList.remove('active-tab');
  document.getElementById('divisionSummaryTabBtn').classList.remove('active-tab');

  if (tabName === 'monthly') {
    document.getElementById('monthlySummaryTabBtn').classList.add('active-tab');
    renderMonthlySummaryTable();
  } else if (tabName === 'division') {
    document.getElementById('divisionSummaryTabBtn').classList.add('active-tab');
    renderDivisionSummaryTable();
  }

  // Adjust the max-height of the collapsible content to fit the new table
  const content = document.getElementById('summaryTableContent');
  if (!content.classList.contains('hidden')) {
    content.style.maxHeight = content.scrollHeight + 'px';
  }
}


async function checkDataAge() {
  const outdatedDivisions = [];
  const today = new Date();

  const checkPromises = Object.entries(sources).map(async ([division, url]) => {
    try {
      const response = await fetch(url);
      const json = await response.json();

      if (!json.length) {
        outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî No data ‚ùå</div>`);
        return;
      }

      const latestDate = json
        .map(row => new Date(row.reportingDate || row.date))
        .filter(date => !isNaN(date))
        .sort((a, b) => b - a)[0];

      if (!latestDate) {
        outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî Invalid or missing date ‚ùå</div>`);
        return;
      }

      const diffDays = Math.floor((today - latestDate) / (1000 * 60 * 60 * 24));
      const line = `${formatName(division)} - ${diffDays} Days Old Data`;

      outdatedDivisions.push(
        `<div style="color: ${diffDays > 10 ? '#dc2626' : '#16a34a'}; font-weight: 500;">${line} ${diffDays > 10 ? '‚ùå' : '‚úÖ'}</div>`
      );
    } catch (err) {
      outdatedDivisions.push(`<div style="color: #dc2626; font-weight: 500;">${division} ‚Äî Fetch error ‚ùå</div>`);
    }
  });

  await Promise.all(checkPromises);

  const alertBox = document.getElementById('dataAgeAlert');
  const message = document.getElementById('dataAgeMessage');

  if (outdatedDivisions.length) {
    message.innerHTML = outdatedDivisions.join('');
    alertBox.style.display = 'flex';
    document.getElementById('initialLoader').style.display = 'none';

    return new Promise(resolve => {
      document.getElementById('dataAgeProceedBtn').onclick = () => {
        alertBox.style.display = 'none';
        resolve();
      };
    });
  } else {
    document.getElementById('initialLoader').style.display = 'none';
    return Promise.resolve();
  }
}





async function loadData() {
  toggleLoading(true);
  allData = [];

  try {
    const urls = Object.entries(sources);
    const promises = urls.map(async ([location, url]) => {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const json = await response.json();

      json.forEach(row => {
row.reportingDate = new Date(row.reportingDate);
row.issuedDate = new Date(row.issuedDate);
allData.push({
  ...row,
  location,
  reportingDate: row.reportingDate,
  issuedDate: row.issuedDate,
  qty: row.qty || 0,
  unit: row.unit || 'Unknown',
  vendor: row.vendor || 'Unknown',
  material: row.material || 'Unknown',
  projectid: row.projectid || ''
});
      });
    });

    await Promise.all(promises);
    populateDropdowns(true); // Reset all dependent filters on initial load
    filterAndProcessData();
    renderDivisionChart();

  } catch (error) {
    console.error("Loading error:", error);
  } finally {
    toggleLoading(false);
  }
}


    // Event listeners
    document.getElementById("locationFilter").addEventListener("change", e => {
      selectedLocation = e.target.value;
      populateDropdowns(true); // Reset dependent filters when location changes
      filterAndProcessData();
    });

    document.getElementById("unitFilter").addEventListener("change", e => {
      selectedUnit = e.target.value;
      populateDropdowns(false); // Update vendor dropdown based on unit selection
      filterAndProcessData();
    });

    document.getElementById("vendorFilter").addEventListener("change", e => {
      selectedVendor = e.target.value;
      filterAndProcessData();
    });
populateLocationDropdown();


// Initial load
checkDataAge().then(() => {
loadData().then(() => {
  showStartupAlerts();
});

});


// Now define the showStartupAlerts function below:
function showStartupAlerts() {
  const data = allData;
  if (!data.length) {
    document.getElementById('initialLoader').style.display = 'none'; // ‚úÖ hide if no data
    return;
  }

  const summary = { all: {}, overdue: {} };

  for (const row of data) {
    const ageInMonths = (new Date() - row.date) / (1000 * 60 * 60 * 24 * 30);
    ['location', 'unit', 'vendor'].forEach(key => {
      const val = row[key] || 'Unknown';
      if (!summary.all[key]) summary.all[key] = {};
      if (!summary.overdue[key]) summary.overdue[key] = {};
      summary.all[key][val] = (summary.all[key][val] || 0) + row.value;
      if (ageInMonths > 12) summary.overdue[key][val] = (summary.overdue[key][val] || 0) + row.value;
    });
  }

  function topName(map) {
    const entries = Object.entries(map || {});
    if (!entries.length) return ['-', 0];
    const [name, val] = entries.sort((a, b) => b[1] - a[1])[0];
    return [name, val];
  }

  const alerts = [];

  // ... (existing alert creation code)

  if (!alerts.length) {
    document.getElementById('initialLoader').style.display = 'none'; // ‚úÖ hide loader if no alerts
    return;
  }

  let idx = 0;
  const alertBox = document.getElementById('startupAlert');
  const alertText = document.getElementById('alertText');

  const updateAlert = () => {
    alertText.innerHTML = alerts[idx];
    document.getElementById('prevAlertBtn').disabled = idx === 0;
    document.getElementById('nextAlertBtn').disabled = idx === alerts.length - 1;
  };

  document.getElementById('prevAlertBtn').onclick = () => {
    if (idx > 0) { idx--; updateAlert(); }
  };
  document.getElementById('nextAlertBtn').onclick = () => {
    if (idx < alerts.length - 1) { idx++; updateAlert(); }
  };
  document.getElementById('okAlertBtn').onclick = () => {
    alertBox.style.display = 'none';
  };

  alertBox.style.display = 'flex';

  // ‚úÖ hide loader when modal appears
  document.getElementById('initialLoader').style.display = 'none';

  updateAlert();
}



let modalDataMap = {}; // holds the currently rendered map
let currentModalType = 'unit'; // current tab

function closeModal() {
  document.getElementById('detailsModal').classList.add('hidden');
}

function openModal(type = 'unit', filterFn = null) {
  currentModalType = type;
  document.getElementById('detailsModal').classList.remove('hidden');
  renderDetails(type, filterFn);
}

// Filter modal items based on search input
function filterModalItems() {
  const search = document.getElementById('modalSearch').value.trim().toLowerCase();
  const items = document.querySelectorAll('.modal-item');
  items.forEach(item => {
    item.classList.toggle('hidden', !item.textContent.toLowerCase().includes(search));
  });
}

function exportModalToCSV() {
  const rows = [["Category", "Amount"]];
  for (const [key, value] of Object.entries(modalDataMap)) {
    rows.push([key, value]);
  }
  const csv = rows.map(r => r.join(",")).join("\n");
  const base64 = btoa(unescape(encodeURIComponent(csv)));
  const filename = `${currentModalType}_summary.csv`;

  const isAndroid = typeof window.AndroidBridge === "object" && typeof AndroidBridge.saveCsvBase64 === "function";

  if (isAndroid) {
    AndroidBridge.saveCsvBase64(base64, filename);
  } else {
    // Browser fallback
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // Show message in browser
    alert("CSV saved in Downloads folder");
  }
}



// Render filtered totals in modal
function renderDetails(type, filterFn = null) {
  const filtered = getFilteredData().filter(row => (typeof filterFn === 'function' ? filterFn(row) : true));
  modalDataMap = {};

  if (type === 'material') {
    const materialMap = {};

    filtered.forEach(row => {
      const mat = row.material || 'Unknown';
      if (!materialMap[mat]) {
materialMap[mat] = { total: 0, qty: 0, projectIds: new Set() };
        materialMap[mat].projectIds.add(row['projectid']);

      }
      materialMap[mat].total += row.value;
        materialMap[mat].qty += row.qty || 0;

      if (row['projectid']) {
        materialMap[mat].projectIds.add(row['projectid']);
      }
    });

    modalDataMap = {}; // for CSV export

    const sorted = Object.entries(materialMap).sort((a, b) => b[1].total - a[1].total);
    const listHTML = sorted.map(([key, data], index) => {
      modalDataMap[key] = data.total;

      const projectList = Array.from(data.projectIds).join(", ");
      const projectLine = projectList
        ? `<div style="font-size: 0.75rem; font-style: italic; color: #555;">(${projectList})</div>`
        : '';
return `<div class="modal-item"><strong>${index + 1}.</strong> ${key}: ‚Çπ${formatCurrency(data.total)} <span style="color:#555;">(Qty: ${data.qty})</span> ${projectLine}</div>`;
    }).join('');

    document.getElementById('modalTitle').textContent = `Material Wise Summary`;
    document.getElementById('modalContent').innerHTML = listHTML;

  } else if (type === 'division') {
    filtered.forEach(row => {
      const key = row.location;
      if (!modalDataMap[key]) modalDataMap[key] = 0;
      modalDataMap[key] += row.value;
    });

    const sorted = Object.entries(modalDataMap).sort((a, b) => b[1] - a[1]);
    const listHTML = sorted.map(([key, val], index) =>
      `<div class="modal-item"><strong>${index + 1}.</strong> ${formatName(key)}: ‚Çπ${formatCurrency(val)}</div>`
    ).join('');

    document.getElementById('modalTitle').textContent = `Division Wise Summary`;
    document.getElementById('modalContent').innerHTML = listHTML;

  } else {
    // Handle unit or vendor summary
    filtered.forEach(row => {
      const key = type === 'unit' ? row.unit : row.vendor;
      if (!modalDataMap[key]) modalDataMap[key] = 0;
      modalDataMap[key] += row.value;
    });

    const sorted = Object.entries(modalDataMap).sort((a, b) => b[1] - a[1]);
    const listHTML = sorted.map(([key, val], index) =>
      `<div class="modal-item"><strong>${index + 1}.</strong> ${formatName(key)}: ‚Çπ${formatCurrency(val)}</div>`
    ).join('');

    document.getElementById('modalTitle').textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Wise Summary`;
    document.getElementById('modalContent').innerHTML = listHTML;
  }


  // Reset search input
  document.getElementById('modalSearch').value = '';

  // Highlight selected tab
document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => {
  btn.classList.remove('active-tab');
});
const tabOrder = ['division', 'unit', 'vendor', 'material'];
document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => {
  btn.classList.remove('active-tab');
});
document.querySelector(`.modal-tabs .tab-btn:nth-child(${tabOrder.indexOf(type) + 1})`)?.classList.add('active-tab');

}


// === Add this at the bottom of the script ===
  document.addEventListener("DOMContentLoaded", () => {
    const statCards = document.querySelectorAll('.stat-card');

statCards.forEach((card, i) => {
  card.addEventListener('click', () => {
    if (i === 0) openModal('division'); // Total Balance
    else if (i === 1) openModal('division'); // Active Months
    else if (i === 2) openModal('division', row => {
      const now = new Date();
      const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
      return diff > 6;
    }); // Overdue >6mo
    else if (i === 3) openModal('division', row => {
      const now = new Date();
      const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
      return diff > 12;
    }); // Overdue >12mo
    else if (i === 4) openModal('division', row => {
      const now = new Date();
      const diff = (now - row.date) / (1000 * 60 * 60 * 24 * 30);
      return diff > 24;
    }); // Overdue >24mo
    else if (i === 5) openModal('vendor'); // Top Vendor
  });
});

document.getElementById('summaryTableHeader').addEventListener('click', toggleSummaryTable);
document.getElementById('monthlySummaryTabBtn').addEventListener('click', () => showSummaryTab('monthly'));
document.getElementById('divisionSummaryTabBtn').addEventListener('click', () => showSummaryTab('division'));
  });

  function formatName(text) {
  if (!text || typeof text !== 'string') return '';
  if (text.trim().toLowerCase() === 'ccc') return 'CCC'; // leave CCC as is
  return text
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

  </script>

<div id="detailsModal" class="hidden">
  <div class="modal-backdrop">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modalTitle">Details</h3>
        <button onclick="closeModal()">√ó</button>
      </div>
<div class="modal-tabs">
  <button onclick="renderDetails('division')" class="tab-btn">Division</button>
  <button onclick="renderDetails('unit')" class="tab-btn">Unit</button>
  <button onclick="renderDetails('vendor')" class="tab-btn">Vendor</button>
  <button onclick="renderDetails('material')" class="tab-btn">Material</button>
</div>

      <div style="padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
        <input id="modalSearch" placeholder="Search..." style="flex: 1; padding: 0.4rem; font-size: 0.85rem; border: 1px solid #ccc; border-radius: 4px;" oninput="filterModalItems()" />
        <button onclick="exportModalToCSV()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Export CSV</button>
      </div>
      <div id="modalContent" class="modal-body"></div>
    </div>
  </div>
</div>

<div id="startupAlert" class="modal-backdrop" style="display:none;">
  <div class="modal-box" style="max-width:400px; padding:1rem; text-align:center;">
    <div style="font-weight:600; font-size:1rem; margin-bottom:0.5rem;">üö® Critical Summary</div>
    <div id="alertText" style="font-size:0.85rem; min-height:60px;"></div>
    <div style="margin-top:1rem; display:flex; justify-content:space-between;">
      <button id="prevAlertBtn" class="tab-btn">‚¨Ö Prev</button>
      <button id="nextAlertBtn" class="tab-btn">Next ‚û°</button>
      <button id="okAlertBtn" class="tab-btn" style="background:#3b82f6; color:white;">OK</button>
    </div>
  </div>
</div>

<div id="dataAgeAlert" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 3000;">
  <div class="modal-box" style="max-width: 500px; text-align: center; padding: 1rem;">
    <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem;">‚ö†Ô∏è Data Age Alert</div>
    <div id="dataAgeMessage" style="font-size: 0.9rem; padding: 0.5rem; max-height: 60vh; overflow-y: auto;"></div>
    <button id="dataAgeProceedBtn" class="tab-btn" style="margin-top: 1rem; background: #2563eb; color: white;">Proceed</button>
  </div>
</div>

<div id="initialLoader" class="fullscreen-modal" style="display:flex;">
  <div style="text-align: center;">
    <div class="loading-spinner" style="margin: 1rem auto;"></div>
    <div style="color:white; font-size: 1rem;">Initializing Dashboard...</div>
  </div>
</div>

</body>
</html>
```
