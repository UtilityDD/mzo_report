<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Safety Inspection Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* Reset and Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      padding-top: 90px;
      /* to prevent overlap under sticky header */
    }


    /* Header */
    .header {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
      padding: 16px;
      margin: 0;
      border-radius: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      /* Allow wrapping on small screens */
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .header .last-updated {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 5px;
    }


    /* Dashboard Sections */
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: #555;
    }

    .dashboard-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .dashboard-section h2 {
      font-size: 20px;
      color: #1976D2;
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }


    /* Category Tabs */
    .category-tab {
      background-color: #e0e0e0;
      border: none;
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
      transition: all 0.3s ease;
      min-width: 80px;
      text-align: center;
    }

    .category-tab:hover {
      background-color: #d0d0d0;
    }

    .category-tab.active {
      background-color: #2196F3;
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }


    /* Stat Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border-left: 5px solid;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
      z-index: 1;
      pointer-events: none;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .label {
      font-size: 14px;
      color: #666;
    }

    .office-counts {
      font-size: 11px;
      color: #888;
      margin-top: 10px;
      line-height: 1.4;
      min-height: 3em;
      /* Ensure consistent height */
    }

    .stat-card.total-inspected {
      border-left-color: #4CAF50;
    }

    .stat-card.total-rectified {
      border-left-color: #2196F3;
    }

    .stat-card.total-pending {
      border-left-color: #FF5722;
    }

    .stat-card.week-inspected {
      border-left-color: #00BCD4;
    }

    .stat-card.week-rectified {
      border-left-color: #9C27B0;
    }


    /* Charts */
    .charts-section {
      display: grid;
      grid-template-columns: 1fr;
      /* Default to single column */
      gap: 20px;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      /* Needed for chart responsiveness */
      height: 400px;
      /* Set a consistent height for chart containers */
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Mini Tables (details) */
    details {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-top: 20px;
      overflow: hidden;
    }

    summary {
      padding: 15px;
      font-weight: bold;
      cursor: pointer;
      background-color: #f0f0f0;
      border-bottom: 1px solid #e0e0e0;
      list-style: none;
      /* Remove default arrow */
    }

    summary::-webkit-details-marker {
      display: none;
      /* Remove default arrow for Webkit */
    }

    summary::after {
      content: '▼';
      /* Custom arrow */
      float: right;
      transition: transform 0.3s ease;
    }

    details[open] summary::after {
      transform: rotate(180deg);
    }

    .table-responsive {
      max-height: 400px;
      /* Or adjust as needed */
      overflow-y: auto;
      width: 100%;
    }

    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background-color: white;
    }

    .mini-table th,
    .mini-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .mini-table th {
      background-color: #f5f5f5;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      /* Make header sticky */
      z-index: 2;
    }

    .mini-table tbody tr:hover {
      background-color: #f0f0f0;
    }


    /* Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      /* Darker overlay */
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      /* Adjust margin for better vertical alignment */
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      width: 90%;
      max-width: 700px;
      animation: slideIn 0.3s;
      max-height: 90vh;
      /* Limit modal height */
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 22px;
      color: #1976D2;
    }

    .close-button {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .close-button:hover,
    .close-button:focus {
      color: #333;
      text-decoration: none;
    }

    .modal-body {
      overflow-y: auto;
      /* Enable scrolling for modal content */
      flex-grow: 1;
      /* Allow body to take available space */
    }

    .office-summary .office-item {
      padding: 12px 0;
      border-bottom: 1px dashed #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .office-summary .office-item:last-child {
      border-bottom: none;
    }

    .office-summary .office-item span:first-child {
      font-weight: 500;
      color: #444;
    }

    .office-summary .office-item span:last-child {
      font-weight: 600;
      color: #2196F3;
    }

    .details-list {
      list-style: none;
      padding: 0;
    }

    .details-list li {
      background-color: #f9f9f9;
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .details-list li strong {
      color: #1976D2;
      font-size: 15px;
    }

    .details-list li p {
      margin-top: 5px;
      font-size: 14px;
      color: #555;
    }

    .details-list li a {
      color: #2196F3;
      text-decoration: none;
    }

    .details-list li a:hover {
      text-decoration: underline;
    }


    /* Map Modal Specific */
    .map-container {
      position: relative;
      width: 100%;
      padding-top: 75%;
      /* 4:3 Aspect Ratio (height / width * 100) */
      background-color: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .map-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .map-actions {
      margin-top: 15px;
      text-align: center;
    }

    .map-actions a {
      display: inline-block;
      background-color: #2196F3;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }

    .map-actions a:hover {
      background-color: #1976D2;
    }


    /* Keyframe Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }


    /* Responsive Design */
    @media (min-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 767px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header .last-updated {
        margin-top: 10px;
      }

      .container {
        padding: 10px;
        padding-top: 80px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-card .value {
        font-size: 28px;
      }

      .stat-card .label {
        font-size: 12px;
      }

      .modal-content {
        margin: 10px auto;
        padding: 20px;
        width: 95%;
        max-height: 95vh;
      }

      .modal-header h3 {
        font-size: 18px;
      }

      .mini-table th,
      .mini-table td {
        padding: 8px 10px;
        font-size: 12px;
      }

      .table-responsive {
        max-height: 300px;
      }

      .details-list li {
        padding: 10px;
      }

      .details-list li strong {
        font-size: 14px;
      }

      .details-list li p {
        font-size: 13px;
      }
    }

    .alert-icon {
  animation: pulse 1s infinite;
  font-size: 20px;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}

  </style>
</head>

<body>
  <header class="header">
    <div>
      <h1>Safety Inspection Dashboard</h1>
      <p>Overview of Inspection and Rectification Status</p>
    </div>
    <div class="last-updated" id="updatedOn">
      Loading report period...
    </div>
  </header>

  <div class="container">
    <div class="loading" id="loading">
      <p>Loading data, please wait...</p>
    </div>

    <div class="dashboard" id="dashboard" style="display: none;">

      <div class="dashboard-section">
        <h2>Filter by Category</h2>
        <div id="categoryTabs" style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="category-tab active" data-category="all">All</button>
          <button class="category-tab" data-category="Spacer Issues">Spacer Issues</button>
          <button class="category-tab" data-category="LT Kiosk Issues">LT Kiosk Issues</button>
          <button class="category-tab" data-category="Other LT Issues">Other LT Issues</button>
          <button class="category-tab" data-category="HT 11 KV Issues">HT 11 KV Issues</button>
          <button class="category-tab" data-category="HT 33 KV Issues">HT 33 KV Issues</button>
          <button class="category-tab" data-category="Other Issues">Other Issues</button>
        </div>

        <div id="regionalTabs" style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap; border-top: 1px solid #ccc; padding-top: 10px;">
          <button class="category-tab active" data-filter-type="regional" data-filter-value="all">All Regions</button>
          </div>

        <div id="divisionTabs" style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap; border-top: 1px solid #ccc; padding-top: 10px; display: none;">
          <button class="category-tab active" data-filter-type="division" data-filter-value="all">All Divisions</button>
          </div>

      </div>

      <div class="stats-grid">
        <div class="stat-card total-inspected" onclick="openModal('total')">
          <div class="value" id="totalInspected">0</div>
          <div class="label">Total Inspected</div>
          <div class="office-counts" id="totalOfficeCounts"></div>
        </div>
        <div class="stat-card total-rectified" onclick="openModal('rectified')">
          <div class="value" id="totalRectified">0</div>
          <div class="label">Total Rectified</div>
          <div class="office-counts" id="rectifiedOfficeCounts"></div>
        </div>
        <div class="stat-card total-pending" onclick="openModal('pending')">
          <div class="value" id="totalPending">0</div>
          <div class="label">Total Pending</div>
          <div class="office-counts" id="pendingOfficeCounts"></div>
        </div>
        <div class="stat-card week-inspected" onclick="openModal('weekInspected')">
          <div class="value" id="weekInspected">0</div>
          <div class="label">Inspected This Week</div>
          <div class="office-counts" id="weekInspectedOfficeCounts"></div>
        </div>
        <div class="stat-card week-rectified" onclick="openModal('weekRectified')">
          <div class="value" id="weekRectified">0</div>
          <div class="label">Rectified This Week</div>
          <div class="office-counts" id="weekRectifiedOfficeCounts"></div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-container">
          <h2>Office-wise Status Distribution</h2>
          <canvas id="officeChart"></canvas>
          <details>
            <summary>Detailed Office Status Table</summary>
            <div class="table-responsive">
              <table class="mini-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Office</th>
                    <th>Total</th>
                    <th>Rectified</th>
                    <th>Pending</th>
                    <th>% Complete</th>
                  </tr>
                </thead>
                <tbody id="officeTableBody">
                  </tbody>
              </table>
            </div>
          </details>
        </div>

        <div class="chart-container">
          <h2>Inspection vs Rectification Timeline</h2>
          <canvas id="timelineChart"></canvas>
          <details>
            <summary>Monthly Trend Table</summary>
            <div class="table-responsive">
              <table class="mini-table">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Inspected</th>
                    <th>Rectified</th>
                    <th>Net Pending</th>
                  </tr>
                </thead>
                <tbody id="monthlyTrendTableBody">
                  </tbody>
              </table>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Office Summary</h3>
        <span class="close-button" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body" id="modalBody">
        </div>
    </div>
  </div>

  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="detailsModalTitle">Pending Items Details</h3>
        <span class="close-button" onclick="closeDetailsModal()">×</span>
      </div>
      <div class="modal-body" id="detailsModalBody">
        </div>
    </div>
  </div>

  <div class="modal" id="mapModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="mapModalTitle">Location Map</h3>
        <span class="close-button" onclick="closeMapModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="map-container">
          <iframe id="mapIframe" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div class="map-actions">
          <a id="mapDirectionLink" href="#" target="_blank" rel="noopener noreferrer">Get Directions</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let inspectionData = [];
    let officeChart, timelineChart;
    let currentModalData = [];
    let lastUpdatedDate = null;
    let currentCategoryFilter = "all"; // Existing category filter
    let currentRegionalFilter = "all"; // NEW: Regional filter
    let currentDivisionFilter = "all"; // NEW: Division filter

    // NEW: Global variables for hierarchy lookups
    let officeDetailsMap = {};
    let regionalOfficeToDivisionsMap = {};
    let divisionToCCCsMap = {};
    let dynamicOfficeHierarchy = {}; // This will hold the structured hierarchy for UI filters


    // NEW: The mapping string provided by the user
    const newMappingString = `CODE	OFFICE NAME
6610000	MALDA REGIONAL OFFICE
1111111	MALDA DIV.
6611000	MALDA DIVISIOIN
6611101	MANIKCHAK CCC
6611102	GOLAPGANJ CCC
6611103	BAISHNABNAGAR CCC
6611104	KALIACHAK CCC
6611105	MOTHABARI CCC
6611106	SUJAPUR CCC
6611107	RATHBARI CCC
6611108	FULBARI CCC
6611109	MOKDUMPUR CCC
2222222	CHANCHAL DIV.
6612000	CHANCHAL DIVISION
6612101	BHALUKA CCC
6612102	SAMSI CCC
6612103	PARANPUR CCC
6612104	CHANCHAL CCC
6612105	MALATIPUR CCC
6612106	HARISHCHANDRAPUR CCC
6612107	KUSHIDA CCC
3333333	GAZOLE DIV.
6613000	GAZOLE DIVISION
6613101	GAZOL CCC
6613102	AIHO. CCC
6613103	PANDUA CCC
6613104	BAMONGOLA CCC
6613105	OLD MALDA CCC
6620000	UTTAR DINAJPUR REGIONAL OFFICE
4444444	RAIGANJ  DIV.
6621000	RAIGANJ  DIVISION
6621101	ITAHAR CCC
6621102	HEMTABAD CCC
6621103	KALIYAGANJ CCC
6621104	RAIGANJ CCC
6621105	BIRNAGAR CCC
6621106	KARANDIGHI CCC
5555555	ISLAMPUR DIV.
6622000	ISLAMPUR DIVISION
6622101	ISLAMPUR CCC
6622102	CHOPRA CCC
6622103	DALKHOLA CCC
6622104	GOALPOKHER CCC
6622105	KANKI CCC
6630000	DAKSHIN DINAJPUR REGIONAL OFFICE
6666666	BALURGHAT DIV.
6631000	BALURGHAT DIVISION
6631101	BALURGHAT CCC
6631102	TAPAN CCC
6631103	KUMARGANJ CCC
6631104	HILI CCC
6631105	PATIRAM CCC
7777777	BUNIADPUR DIV.
6632000	BUNIADPUR DIVISION
6632101	BUNIADPUR CCC
6632102	KUSMANDI CCC
6632103	HARIRAMPUR CCC
6632104	GANGARAMPUR CCC`;


    // NEW: Function to build the hierarchy maps from the provided mapping string
    function buildHierarchyMaps(mappingText) {
      const lines = mappingText.trim().split('\n').slice(1); // Skip header
      const parsedMapping = lines.map(line => {
        const parts = line.split('\t');
        return {
          code: parts[0].trim(),
          name: parts[1].trim()
        };
      });

      officeDetailsMap = {};
      regionalOfficeToDivisionsMap = {};
      divisionToCCCsMap = {};

      // First pass: Populate officeDetailsMap with types and initial data
      parsedMapping.forEach(item => {
        const isRegionalOffice = item.name.includes('REGIONAL OFFICE');
        const isShortDivision = item.name.endsWith('DIV.'); // Preferred for UI and logic
        const isLongDivision = item.name.endsWith('DIVISION') && !isRegionalOffice; // Alternative division name, map to short
        const isCCC = item.name.endsWith('CCC');

        let type;
        if (isRegionalOffice) {
          type = 'regionalOffice';
        } else if (isShortDivision) {
          type = 'division'; // Use 'division' for both short and long, but prefer short for display
        } else if (isLongDivision) {
          type = 'divisionLong'; // Mark as long to link later
        } else if (isCCC) {
          type = 'ccc';
        } else {
          type = 'unknown';
        }

        officeDetailsMap[item.code] = {
          name: item.name, // The name as it appears in the mapping
          type: type,
          code: item.code,
          parentCode: null, // Will populate in second pass
          alternativeCode: null // For linking long division names to short codes
        };
      });

      // Second pass: Establish parent relationships and link long division names to short codes
      parsedMapping.forEach(item => {
        const details = officeDetailsMap[item.code];

        if (details.type === 'division') { // Short division names
          // Determine parent Regional Office Code based on prefix or explicit link
          let regionalOfficeCode = null;
          if (item.code === '1111111' || item.code === '2222222' || item.code === '3333333') regionalOfficeCode = '6610000'; // MALDA RO
          else if (item.code === '4444444' || item.code === '5555555') regionalOfficeCode = '6620000'; // UTTAR DINAJPUR RO
          else if (item.code === '6666666' || item.code === '7777777') regionalOfficeCode = '6630000'; // DAKSHIN DINAJPUR RO

          details.parentCode = regionalOfficeCode;
          if (regionalOfficeCode) {
            if (!regionalOfficeToDivisionsMap[regionalOfficeCode]) regionalOfficeToDivisionsMap[regionalOfficeCode] = [];
            regionalOfficeToDivisionsMap[regionalOfficeCode].push(item.code);
          }
        } else if (details.type === 'divisionLong') {
          // Find the corresponding short division code and link it
          let shortDivisionCode = null;
          if (item.code === '6611000') shortDivisionCode = '1111111'; // MALDA DIV.
          else if (item.code === '6612000') shortDivisionCode = '2222222'; // CHANCHAL DIV.
          else if (item.code === '6613000') shortDivisionCode = '3333333'; // GAZOLE DIV.
          else if (item.code === '6621000') shortDivisionCode = '4444444'; // RAIGANJ DIV.
          else if (item.code === '6622000') shortDivisionCode = '5555555'; // ISLAMPUR DIV.
          else if (item.code === '6631000') shortDivisionCode = '6666666'; // BALURGHAT DIV.
          else if (item.code === '6632000') shortDivisionCode = '7777777'; // BUNIADPUR DIV.

          details.alternativeCode = shortDivisionCode; // Store link to the preferred short code
        } else if (details.type === 'ccc') {
          // Find parent Division (short form preferred)
          let parentDivisionShortCode = null;
          if (item.code.startsWith('66111')) parentDivisionShortCode = '1111111'; // MALDA DIV.
          else if (item.code.startsWith('66121')) parentDivisionShortCode = '2222222'; // CHANCHAL DIV.
          else if (item.code.startsWith('66131')) parentDivisionShortCode = '3333333'; // GAZOLE DIV.
          else if (item.code.startsWith('66211')) parentDivisionShortCode = '4444444'; // RAIGANJ DIV.
          else if (item.code.startsWith('66221')) parentDivisionShortCode = '5555555'; // ISLAMPUR DIV.
          else if (item.code.startsWith('66311')) parentDivisionShortCode = '6666666'; // BALURGHAT DIV.
          else if (item.code.startsWith('66321')) parentDivisionShortCode = '7777777'; // BUNIADPUR DIV.

          details.parentCode = parentDivisionShortCode;
          if (parentDivisionShortCode) {
            if (!divisionToCCCsMap[parentDivisionShortCode]) divisionToCCCsMap[parentDivisionShortCode] = [];
            divisionToCCCsMap[parentDivisionShortCode].push(item.code);
          }
        }
      });

      // Construct the officeHierarchy for UI filter generation
      let constructedOfficeHierarchy = {};
      for (const roCode in regionalOfficeToDivisionsMap) {
        const roName = officeDetailsMap[roCode].name;
        constructedOfficeHierarchy[roName] = {
          divisions: {}
        };
        regionalOfficeToDivisionsMap[roCode].forEach(divisionCode => {
          const divisionName = officeDetailsMap[divisionCode].name;
          const cccNames = (divisionToCCCsMap[divisionCode] || []).map(cccCode => officeDetailsMap[cccCode].name);
          constructedOfficeHierarchy[roName].divisions[divisionName] = cccNames;
        });
      }
      return constructedOfficeHierarchy; // Return this new hierarchy
    }


    // Utility functions
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        // Assuming DD/MM/YYYY format
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      return new Date(dateStr); // Fallback for other formats
    }

    // NEW: Updated cleanOfficeName to also handle 'CODE NAME' format if needed from CSV 'Office' column
function cleanOfficeName(officeName) {
  // This regex will remove any number of digits within parentheses at the end of the string
  // For example: "Office Name (123)" or "Office Name (123456789)" will both become "Office Name"
  return officeName.replace(/\s*\(\d+\)$/, '').trim();
}

    function isWithinLastWeek(date) {
      if (!date) return false;
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      return date >= oneWeekAgo;
    }

function getOfficeCountsHtml(officeStats) {
  if (Object.keys(officeStats).length === 0) {
    return 'No data for offices.';
  }

  const sortedOffices = Object.entries(officeStats).sort(([, a], [, b]) => b.count - a.count);

  let html = '';
  if (sortedOffices.length > 0) {
    const topOffice = sortedOffices[0];
    html += `<div style="color: green;">Highest: ${topOffice[0]} (${topOffice[1].count})</div>`;
  }

  // 🧹 Removed the "Lowest" display line here

  return html;
}


    function getCategory(description) {
      const lowerDesc = description.toLowerCase();
      if (lowerDesc.includes("spacer")) return "Spacer Issues";
      if (lowerDesc.includes("lt kiosk")) return "LT Kiosk Issues";
      if (lowerDesc.includes("ht 11 kv")) return "HT 11 KV Issues";
      if (lowerDesc.includes("ht 33 kv")) return "HT 33 KV Issues";
      if (lowerDesc.includes("lt") || lowerDesc.includes("low tension")) return "Other LT Issues";
      return "Other Issues";
    }

    // NEW: Function to get regional office from CCC name (now uses officeDetailsMap)
function getDivisionFromCCC(cccNameCleaned) {
  for (const code in officeDetailsMap) {
    const entry = officeDetailsMap[code];

    if (entry.name === cccNameCleaned) {
      // If it's a CCC, trace to parent division
      if (entry.type === 'ccc' && entry.parentCode) {
        return officeDetailsMap[entry.parentCode]?.name || null;
      }

      // If it's a DIVISION (long form), resolve to short
      if (entry.type === 'divisionLong' && entry.alternativeCode) {
        return officeDetailsMap[entry.alternativeCode]?.name || null;
      }

      // If it's a DIV. itself
      if (entry.type === 'division') {
        return entry.name;
      }
    }
  }

  return null; // Fallback
}

function getRegionalOfficeFromCode(code) {
  let currentCode = code;
  while (currentCode) {
    const entry = officeDetailsMap[currentCode];
    if (!entry) break;
    if (entry.type === 'regionalOffice') return entry.name;
    if (entry.type === 'divisionLong' && entry.alternativeCode) {
      currentCode = entry.alternativeCode;
    } else {
      currentCode = entry.parentCode;
    }
  }
  return null;
}

function getDivisionFromCode(code) {
  let currentCode = code;
  while (currentCode) {
    const entry = officeDetailsMap[currentCode];
    if (!entry) break;
    if (entry.type === 'division') return entry.name;
    if (entry.type === 'divisionLong' && entry.alternativeCode) {
      currentCode = entry.alternativeCode;
    } else {
      currentCode = entry.parentCode;
    }
  }
  return null;
}

function extractOfficeCode(officeRaw) {
  const match = officeRaw.match(/\((\d+)\)$/); // Extract digits inside last parentheses
  return match ? match[1] : null;
}

    // Load and process data
    async function loadData() {
      // Build the new hierarchy first
      dynamicOfficeHierarchy = buildHierarchyMaps(newMappingString);
      console.log("Dynamically constructed hierarchy:", dynamicOfficeHierarchy); // For debugging


      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTUm6Gh0XpY34TNrlP1vR767xZQ8KGAHmx4jKVSoai-QB07mo5eblxOmjaE9OiTMy8FdoqYdhZ3izmE/pub?gid=612020297&single=true&output=csv');
        const csvText = await response.text();

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
inspectionData = results.data.map(row => {
  const updatedOnDate = parseDate(row['Updated on']);
  if (updatedOnDate && (!lastUpdatedDate || updatedOnDate > lastUpdatedDate)) {
    lastUpdatedDate = updatedOnDate;
  }

  const officeCode = extractOfficeCode(row.Office || '');
  const officeMeta = officeDetailsMap[officeCode] || {};
  const officeName = officeMeta.name || cleanOfficeName(row.Office || '');

  return {
    officeCode: officeCode,                           // Use code for all logic
    office: officeName,                               // Use official name for display
    regionalOffice: getRegionalOfficeFromCode(officeCode),
    division: getDivisionFromCode(officeCode),
    location: row.Location || '',
    description: row.Description || '',
    category: getCategory(row.Description || ''),
    rectificationDoneBy: row['Rectification done by'] || '',
    rectificationDoneOn: parseDate(row['Rectification done on']),
    remarks: row.Remarks || '',
    status: row.Status || '',
    enteredOn: parseDate(row['Entered on']) || new Date(),
    updatedOn: updatedOnDate,
    isRectified: row['Rectification done on'] && row['Rectification done on'].trim() !== ''
  };
});






            // Update the "Updated on" information in header
            const updatedOnElement = document.getElementById('updatedOn');
            const dates = inspectionData.flatMap(item => [item.enteredOn, item.updatedOn].filter(Boolean));
            if (dates.length > 0) {
              const earliestDate = new Date(Math.min(...dates.map(d => d.getTime())));
              const latestDate = new Date(Math.max(...dates.map(d => d.getTime())));
              updatedOnElement.textContent = `Report from ${earliestDate.toLocaleDateString('en-GB')} to ${latestDate.toLocaleDateString('en-GB')}`;
            } else {
              updatedOnElement.textContent = 'Report period: Not available';
            }

            // NEW: Populate Regional Tabs dynamically
            const regionalTabsContainer = document.getElementById('regionalTabs');
            let regionalHtml = '<button class="category-tab active" data-filter-type="regional" data-filter-value="all">All Regions</button>';
            for (const roName in dynamicOfficeHierarchy) {
              regionalHtml += `<button class="category-tab" data-filter-type="regional" data-filter-value="${roName}">${roName}</button>`;
            }
            regionalTabsContainer.innerHTML = regionalHtml;


            function updateCategoryTabPercentages() {
              const totalCount = inspectionData.length;
              const categoryCounts = {};

              inspectionData.forEach(item => {
                const category = item.category || 'Other Issues';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
              });

              document.querySelectorAll("#categoryTabs .category-tab").forEach(tab => { // Target only original category tabs
                const category = tab.dataset.category;
                const count = category === "all" ? totalCount : (categoryCounts[category] || 0);
                const percent = Math.round((count / totalCount) * 100);
                const baseLabel = category === "all" ? "All" : category;
                const showPercent = category === "all" ? "" : ` (${count})`; // Display count instead of percentage
                tab.textContent = baseLabel + showPercent;
              });
            }

            processData();
            updateCategoryTabPercentages();
            setupNewFilterListeners(); // NEW: Call new listener setup
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            showNotStartedModal();
          }
        });
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = '<p>Error loading data. Please try again later.</p>';
      }
    }


    // Existing category filter listeners
    document.querySelectorAll("#categoryTabs .category-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll("#categoryTabs .category-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentCategoryFilter = tab.dataset.category;
        processData(); // Refresh dashboard based on filter
      });
    });

    // NEW: Setup listeners for new regional/division filters
    function setupNewFilterListeners() {
      // Regional Tabs
      document.querySelectorAll("#regionalTabs .category-tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll("#regionalTabs .category-tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          currentRegionalFilter = tab.dataset.filterValue;

          // Reset division filter when regional changes
          currentDivisionFilter = "all";
          document.getElementById('divisionTabs').style.display = 'none'; // Hide divisions by default
          generateDivisionTabs(currentRegionalFilter); // Generate divisions for selected region
          processData();
        });
      });

      // Division Tabs (dynamic, so add listener after generation)
      document.getElementById('divisionTabs').addEventListener('click', (event) => {
        if (event.target.classList.contains('category-tab')) {
          document.querySelectorAll("#divisionTabs .category-tab").forEach(t => t.classList.remove("active"));
          event.target.classList.add("active");
          currentDivisionFilter = event.target.dataset.filterValue;
          processData();
        }
      });
    }

    // NEW: Function to generate division tabs (uses dynamicOfficeHierarchy)
    function generateDivisionTabs(regionalOfficeName) {
      const divisionTabsContainer = document.getElementById('divisionTabs');
      let html = '<button class="category-tab active" data-filter-type="division" data-filter-value="all">All Divisions</button>';

      if (regionalOfficeName !== "all" && dynamicOfficeHierarchy[regionalOfficeName]) {
        for (const division in dynamicOfficeHierarchy[regionalOfficeName].divisions) {
          html += `<button class="category-tab" data-filter-type="division" data-filter-value="${division}">${division}</button>`;
        }
        divisionTabsContainer.style.display = 'flex'; // Show divisions if a regional office is selected
      } else {
        divisionTabsContainer.style.display = 'none'; // Hide if "All Regions" or no region selected
      }
      divisionTabsContainer.innerHTML = html;
    }


    function processData() {
      let filteredData = inspectionData;

      // Apply category filter (existing logic)
      if (currentCategoryFilter !== "all") {
        filteredData = filteredData.filter(item => item.category === currentCategoryFilter);
      }

      // NEW: Apply regional filter
      if (currentRegionalFilter !== "all") {
        filteredData = filteredData.filter(item => item.regionalOffice === currentRegionalFilter);
      }

      // NEW: Apply division filter
      if (currentDivisionFilter !== "all") {
        filteredData = filteredData.filter(item => item.division === currentDivisionFilter);
      }

      const totalInspected = filteredData.length;
      const totalRectified = filteredData.filter(item => item.isRectified).length;
      const totalPending = totalInspected - totalRectified;

      const weekInspected = filteredData.filter(item => isWithinLastWeek(item.enteredOn)).length;
      const weekRectified = filteredData.filter(item =>
        item.isRectified && isWithinLastWeek(item.rectificationDoneOn)
      ).length;

      // Update stat cards
      document.getElementById('totalInspected').textContent = totalInspected;
      document.getElementById('totalRectified').textContent = totalRectified;
      document.getElementById('totalPending').textContent = totalPending;
      document.getElementById('weekInspected').textContent = weekInspected;
      document.getElementById('weekRectified').textContent = weekRectified;

      // Update office counts
      updateOfficeCountsForCard('total', filteredData);
      updateOfficeCountsForCard('rectified', filteredData.filter(item => item.isRectified));
      updateOfficeCountsForCard('pending', filteredData.filter(item => !item.isRectified));
      updateOfficeCountsForCard('weekInspected', filteredData.filter(item => isWithinLastWeek(item.enteredOn)));
      updateOfficeCountsForCard('weekRectified', filteredData.filter(item =>
        item.isRectified && isWithinLastWeek(item.rectificationDoneOn)
      ));

      // Update charts
      createOfficeChart(filteredData);
      createTimelineChart(filteredData);
    }

    function updateOfficeCountsForCard(cardType, data) {
      const officeStats = {};

      data.forEach(item => {
        if (!officeStats[item.office]) { // Ensure item.office is the CCC name here
          officeStats[item.office] = {
            count: 0
          };
        }
        officeStats[item.office].count++;
      });

      const elementId = cardType === 'total' ? 'totalOfficeCounts' :
        cardType === 'rectified' ? 'rectifiedOfficeCounts' :
        cardType === 'pending' ? 'pendingOfficeCounts' :
        cardType === 'weekInspected' ? 'weekInspectedOfficeCounts' :
        'weekRectifiedOfficeCounts';

      const element = document.getElementById(elementId);
      element.innerHTML = getOfficeCountsHtml(officeStats);
    }

    function createOfficeChart(data) {
      if (officeChart) officeChart.destroy();

const officeStats = {};

// Initialize all CCCs from the hierarchy with 0 values
for (const code in officeDetailsMap) {
  const entry = officeDetailsMap[code];
  if (entry.type === 'ccc') {
    officeStats[entry.name] = { total: 0, rectified: 0, pending: 0 };
  }
}

// Count based on actual data
data.forEach(item => {
  const officeName = item.office;
  if (!officeStats[officeName]) {
    officeStats[officeName] = { total: 0, rectified: 0, pending: 0 };
  }
  officeStats[officeName].total++;
  if (item.isRectified) officeStats[officeName].rectified++;
  else officeStats[officeName].pending++;
});


      const offices = Object.keys(officeStats);
      const rectifiedData = offices.map(office => officeStats[office].rectified);
      const pendingData = offices.map(office => officeStats[office].pending);

      const canvas = document.getElementById('officeChart');
      // Ensure canvas itself doesn't have conflicting height from previous renders
      canvas.removeAttribute('style');
      const ctx = canvas.getContext('2d');

      officeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: offices,
          datasets: [{
            label: 'Rectified',
            data: rectifiedData,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }, {
            label: 'Pending',
            data: pendingData,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y', // Make it a horizontal bar chart
          scales: {
            x: {
              beginAtZero: true,
              stacked: true
            },
            y: {
              stacked: true
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.raw;
                  return label;
                },
                afterBody: function(context) {
                  const officeName = context[0].label;
                  const total = officeStats[officeName].total;
                  const rectified = officeStats[officeName].rectified;
                  const pending = officeStats[officeName].pending;
                  return `Total: ${total}\nRectified: ${rectified}\nPending: ${pending}`;
                }
              }
            }
          }
        }
      });

      // Populate mini table
      const tableBody = document.getElementById('officeTableBody');
      let tableHtml = '';
      const sortedOffices = [...offices].sort((a, b) => officeStats[b].total - officeStats[a].total);
      sortedOffices.forEach((office, index) => {
        const stats = officeStats[office];
        const percentage = stats.total > 0 ? Math.round((stats.rectified / stats.total) * 100) : 0;
        tableHtml += `
            <tr>
                <td>${index + 1}</td>
                <td>${office}</td>
                <td>${stats.total}</td>
                <td>${stats.rectified}</td>
                <td>${stats.pending}</td>
                <td>${percentage}%</td>
            </tr>
        `;
      });
      tableBody.innerHTML = tableHtml;
    }




    function createTimelineChart(data) {
      if (timelineChart) timelineChart.destroy();

      const monthlyData = {};

      data.forEach(item => {
        const monthYearEntered = item.enteredOn ? `${item.enteredOn.getFullYear()}-${(item.enteredOn.getMonth() + 1).toString().padStart(2, '0')}` : null;
        const monthYearRectified = item.rectificationDoneOn ? `${item.rectificationDoneOn.getFullYear()}-${(item.rectificationDoneOn.getMonth() + 1).toString().padStart(2, '0')}` : null;

        if (monthYearEntered) {
          if (!monthlyData[monthYearEntered]) {
            monthlyData[monthYearEntered] = {
              inspected: 0,
              rectified: 0
            };
          }
          monthlyData[monthYearEntered].inspected++;
        }

        if (monthYearRectified) {
          if (!monthlyData[monthYearRectified]) {
            monthlyData[monthYearRectified] = {
              inspected: 0,
              rectified: 0
            };
          }
          monthlyData[monthYearRectified].rectified++;
        }
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      const labels = sortedMonths.map(my => {
        const [year, month] = my.split('-');
        return new Date(year, month - 1, 1).toLocaleDateString('en-US', {
          month: 'short',
          year: '2-digit'
        });
      });
      const inspectedCounts = sortedMonths.map(month => monthlyData[month].inspected);
      const rectifiedCounts = sortedMonths.map(month => monthlyData[month].rectified);

      const canvas = document.getElementById('timelineChart');
      // Ensure canvas itself doesn't have conflicting height from previous renders
      canvas.removeAttribute('style');
      const ctx = canvas.getContext('2d');

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Inspected',
            data: inspectedCounts,
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            fill: true,
            tension: 0.3
          }, {
            label: 'Rectified',
            data: rectifiedCounts,
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Populate monthly trend table
      const monthlyTrendTableBody = document.getElementById('monthlyTrendTableBody');
      let monthlyTableHtml = '';
      sortedMonths.forEach(monthKey => {
        const stats = monthlyData[monthKey];
        const netPending = stats.inspected - stats.rectified;
        const [year, month] = monthKey.split('-');
        const monthName = new Date(year, month - 1, 1).toLocaleDateString('en-US', {
          month: 'long',
          year: 'numeric'
        });

        monthlyTableHtml += `
            <tr>
                <td>${monthName}</td>
                <td>${stats.inspected}</td>
                <td>${stats.rectified}</td>
                <td>${netPending}</td>
            </tr>
        `;
      });
      monthlyTrendTableBody.innerHTML = monthlyTableHtml;
    }


    function openModal(type) {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      let title = '';
      let filteredData = [];

      // Logic to filter based on currentCategoryFilter, currentRegionalFilter, currentDivisionFilter
      // Start with the full inspection data
      let baseDataForModal = inspectionData;

      // Apply category filter
      if (currentCategoryFilter !== "all") {
        baseDataForModal = baseDataForModal.filter(item => item.category === currentCategoryFilter);
      }
      // Apply regional filter
      if (currentRegionalFilter !== "all") {
        baseDataForModal = baseDataForModal.filter(item => item.regionalOffice === currentRegionalFilter);
      }
      // Apply division filter
      if (currentDivisionFilter !== "all") {
        baseDataForModal = baseDataForModal.filter(item => item.division === currentDivisionFilter);
      }


      switch (type) {
        case 'total':
          title = 'Total Inspected - Office Summary';
          filteredData = baseDataForModal;
          break;
        case 'rectified':
          title = 'Rectified Items - Office Summary';
          filteredData = baseDataForModal.filter(item => item.isRectified);
          break;
        case 'pending':
          title = 'Pending Items - Office Summary';
          filteredData = baseDataForModal.filter(item => !item.isRectified);
          break;
        case 'weekInspected':
          title = 'This Week Inspected - Office Summary';
          filteredData = baseDataForModal.filter(item => isWithinLastWeek(item.enteredOn));
          break;
        case 'weekRectified':
          title = 'This Week Rectified - Office Summary';
          filteredData = baseDataForModal.filter(item => item.isRectified && isWithinLastWeek(item.rectificationDoneOn));
          break;
      }


      currentModalData = filteredData;
      modalTitle.textContent = title;

      // First: gather full stats from all data, but only for the offices that are visible after regional/division filter
      const officeStats = {};
      const officesInFilteredView = new Set(filteredData.map(item => item.office)); // Get CCCs visible in current view

      inspectionData.forEach(item => {
        const office = item.office; // This is the CCC Name
        // Only include stats for offices relevant to the current regional/division filter
        if (officesInFilteredView.has(office)) {
          if (!officeStats[office]) {
            officeStats[office] = {
              total: 0,
              rectified: 0,
              pending: 0,
              weekInspected: 0,
              weekRectified: 0
            };
          }
          officeStats[office].total++;
          if (item.isRectified) officeStats[office].rectified++;
          else officeStats[office].pending++;

          if (isWithinLastWeek(item.enteredOn)) officeStats[office].weekInspected++;
          if (item.isRectified && isWithinLastWeek(item.rectificationDoneOn)) officeStats[office].weekRectified++;
        }
      });

      // Filter displayed offices from filteredData (which is already filtered by type)
const displayCounts = {};

// Initialize all CCCs from the hierarchy even with 0 data
for (const code in officeDetailsMap) {
  const entry = officeDetailsMap[code];
  if (entry.type === 'ccc') {
    const regionMatch = (currentRegionalFilter === 'all' || getRegionalOfficeFromCode(code) === currentRegionalFilter);
    const divisionMatch = (currentDivisionFilter === 'all' || getDivisionFromCode(code) === currentDivisionFilter);

    if (regionMatch && divisionMatch) {
      displayCounts[code] = 0;
    }
  }
}


// Then count actual data
filteredData.forEach(item => {
  const code = item.officeCode;
  if (!displayCounts[code]) displayCounts[code] = 0;
  displayCounts[code]++;
});


      modalTitle.innerHTML = `${title} <span style="font-size: 13px; opacity: 0.7;">(${Object.keys(displayCounts).length} Offices)</span>`;

let html = '<div class="office-summary">';

// Convert displayCounts to array and sort by value (descending)
const sortedCodes = Object.entries(displayCounts)
  .sort(([, a], [, b]) => b - a)
  .map(([code]) => code);

for (const code of sortedCodes) {
  const office = officeDetailsMap[code]?.name || code;
  const stat = officeStats[office] || {
    total: 0,
    rectified: 0,
    pending: 0,
    weekInspected: 0,
    weekRectified: 0
  };
  const zeroClass = displayCounts[code] === 0 ? 'opacity: 0.5;' : '';

  let extra = '';
  if (type === 'total') {
    extra = `<div style="font-size: 11px; color: #666;">Rectified: ${stat.rectified} | Pending: ${stat.pending}</div>`;
  } else if (type === 'rectified') {
    extra = `<div style="font-size: 11px; color: #666;">Total: ${stat.total} | Pending: ${stat.pending}</div>`;
  } else if (type === 'pending') {
    extra = `<div style="font-size: 11px; color: #666;">Total: ${stat.total} | Rectified: ${stat.rectified}</div>`;
  } else if (type === 'weekInspected') {
    extra = `<div style="font-size: 11px; color: #666;">Rectified This Week: ${stat.weekRectified}</div>`;
  } else if (type === 'weekRectified') {
    extra = `<div style="font-size: 11px; color: #666;">Inspected This Week: ${stat.weekInspected}</div>`;
  }

  html += `
    <div class="office-item" style="flex-direction: column; align-items: flex-start; ${zeroClass}">
      <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
        <span style="font-size: 14px; color: #333;">${office}</span>
        <span style="display: flex; align-items: center; gap: 6px;">
          <span style="font-weight: 600; color: #2196F3;">${displayCounts[code]}</span>
          ${type === 'pending' ? `<span style="color:#1976D2; font-size: 18px; cursor: pointer;" title="View pending items" onclick="openDetailsModal('${office}')">🔍</span>` : ''}
        </span>
      </div>
      ${extra}
    </div>
  `;
}

html += '</div>';


      modalBody.innerHTML = html;
      modal.style.display = 'block';
    }



    function openDetailsModal(officeName) {
      const detailsModal = document.getElementById('detailsModal');
      const detailsModalTitle = document.getElementById('detailsModalTitle');
      const detailsModalBody = document.getElementById('detailsModalBody');

      detailsModalTitle.textContent = `Pending Items for ${officeName}`;

      const pendingItems = currentModalData.filter(item => item.office === officeName && !item.isRectified);

      let html = '';
      if (pendingItems.length === 0) {
        html = '<p>No pending items for this office.</p>';
      } else {
        html = '<ul class="details-list">';
        pendingItems.forEach((item, index) => {
          const daysPending = Math.floor((new Date() - item.enteredOn) / (1000 * 60 * 60 * 24));
          html += `
            <li>
                <strong>Item ${index + 1}:</strong> ${item.description}<br>
                <p>Location: <a href="#" onclick="openMapModal('${encodeURIComponent(item.location)}')">${item.location || 'Not Specified'}</a></p>
                <p>Entered On: ${item.enteredOn ? item.enteredOn.toLocaleDateString('en-GB') : 'N/A'}</p>
                <p>Days Pending: ${isNaN(daysPending) ? 'N/A' : daysPending}</p>
            </li>
          `;
        });
        html += '</ul>';
      }

      detailsModalBody.innerHTML = html;
      detailsModal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
      document.getElementById("mapIframe").src = ""; // Optional: reset iframe
    }

    function closeDetailsModal() {
      document.getElementById('detailsModal').style.display = 'none';
    }

    function isWebView() {
      return /(wv|WebView)/i.test(navigator.userAgent);
    }

    function openMapModal(location) {
      const decoded = decodeURIComponent(location || '').trim();

      if (!decoded || decoded.toLowerCase().includes('not specified')) {
        alert("Location is not valid or missing.");
        return;
      }

      const embedUrl = `https://maps.google.com/maps?q=${encodeURIComponent(decoded)}&output=embed`;
      const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(decoded)}`;

      document.getElementById("mapIframe").src = embedUrl;
      document.getElementById("mapDirectionLink").href = directionsUrl;

      document.getElementById("mapModal").style.display = "block";
    }


    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      const detailsModal = document.getElementById('detailsModal');
      const mapModal = document.getElementById('mapModal');

      if (event.target === modal) closeModal();
      if (event.target === detailsModal) closeDetailsModal();
      if (event.target === mapModal) closeMapModal();
    };


    // Initialize
    loadData();

    function showNotStartedModal() {
  const inspectedCodes = new Set(inspectionData.map(item => item.officeCode));

  const notStartedOffices = Object.entries(officeDetailsMap)
    .filter(([code, entry]) => entry.type === 'ccc' && !inspectedCodes.has(code))
    .map(([code, entry]) => entry.name)
    .sort();

  const body = document.getElementById('notStartedBody');
  if (notStartedOffices.length === 0) {
    body.innerHTML = '<p>All offices have started inspection.</p>';
  } else {
    body.innerHTML = `
      <p><strong>${notStartedOffices.length}</strong> offices have not started inspection:</p>
      <ul style="margin-top: 10px; padding-left: 20px;">
        ${notStartedOffices.map(name => `<li>${name}</li>`).join('')}
      </ul>
    `;
  }

  document.getElementById('notStartedModal').style.display = 'block';
}

function closeNotStartedModal() {
  document.getElementById('notStartedModal').style.display = 'none';
}

  </script>

<div class="modal" id="notStartedModal" style="display: none;">
  <div class="modal-content" style="max-width: 520px;">
    <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
      <h3 style="color: #d32f2f; display: flex; align-items: center; gap: 10px;">
        <span class="alert-icon">⚠️</span>
        Inspection Not Started
      </h3>
    </div>
    <div class="modal-body" id="notStartedBody" style="margin-top: 10px; font-size: 14px; color: #333;"></div>
    <div style="text-align: right; margin-top: 20px;">
      <button onclick="closeNotStartedModal()" style="padding: 8px 16px; background-color: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
    </div>
  </div>
</div>


</body>

</html>
