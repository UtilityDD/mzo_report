<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>/* Material Design Base Styles */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #fafafa;
    color: #202124;
    line-height: 1.5;
    margin: 0;
    padding: 0;
}

/* Container & Layout */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
}

/* Header Styles */
.header {
    background: #fff;
    border-bottom: 1px solid #e8eaed;
    padding: 16px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.header h1 {
    font-size: 24px;
    font-weight: 400;
    color: #202124;
    margin: 0;
    letter-spacing: -0.5px;
}

/* Auth Card */
.auth-card {
    background: #fff;
    border-radius: 12px;
    padding: 32px 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 400px;
    margin: 0 auto;
}

.auth-header h1 {
    font-size: 28px;
    font-weight: 400;
    color: #202124;
    margin: 0 0 24px 0;
    text-align: center;
}

/* Form Elements */
input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    background: #fff;
    transition: border-color 0.2s ease;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

button {
    background: #1a73e8;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-family: inherit;
}

button:hover {
    background: #1557b0;
}

button:active {
    transform: translateY(1px);
}

/* Tables */
.detail-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.detail-table th,
.detail-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e8eaed;
    font-size: 14px;
}

.detail-table th {
    background: #f8f9fa;
    font-weight: 500;
    color: #3c4043;
    font-size: 13px;
    letter-spacing: 0.25px;
    text-transform: uppercase;
}

.detail-table tr:hover {
    background: #f1f3f4;
}

.detail-table tr:last-child td {
    border-bottom: none;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin: 24px 0;
}

.stat-card {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-left: 4px solid #1a73e8;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: #fff;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

/* Utility Classes */
.no-results {
    text-align: center;
    padding: 24px;
    color: #5f6368;
    font-size: 14px;
}

.text-center { text-align: center; }
.text-muted { color: #5f6368; }
.mb-16 { margin-bottom: 16px; }
.mt-24 { margin-top: 24px; }

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 12px;
    }
    
    .header h1 {
        font-size: 20px;
    }
    
    .auth-card {
        padding: 24px 16px;
        margin: 16px;
    }
    
    .auth-header h1 {
        font-size: 24px;
    }
    
    .modal-content {
        width: calc(100% - 24px);
        margin: 12px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .stat-card {
        padding: 16px;
    }
}

@media (max-width: 480px) {
    .header h1 {
        font-size: 18px;
    }
    
    .auth-header h1 {
        font-size: 22px;
    }
    
    .detail-table th,
    .detail-table td {
        padding: 8px;
        font-size: 12px;
    }
}
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>üîê</h1>
                <p>Please enter your PIN to access the Employee Dashboard</p>
            </div>
            <div>
                <input type="password" class="pin-input" id="pinInput" 
                       placeholder="Enter PIN..." 
                       onkeypress="handlePinKeyPress(event)"
                       maxlength="10">
                <button class="auth-btn" id="authBtn" onclick="validatePin()">
                    <span id="authBtnText">üîì Authenticate</span>
                </button>
                <div id="authError" class="error-message" style="display: none;"></div>
                <div id="authLoading" class="loading-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content - Hidden until authenticated -->
    <div id="dashboardContent" class="dashboard">
        <div class="container">
            <div class="header">
                <h1>Employee Dashboard</h1>
                
            </div>

            <div class="search-section">
                <button class="search-btn" onclick="openSearchModal()">
                    üîç Search Employee
                </button>
            </div>

<div class="stats-grid">
  <div class="stat-card" onclick="openDesignationModal()">
    <div class="stat-icon">üë•</div>
    <div class="stat-number" id="totalEmployees">-</div>
    <div class="stat-label">Total Employees</div>
  </div>
  <div class="stat-card" onclick="openProfitCenterModal()">
    <div class="stat-icon">üè¢</div>
    <div class="stat-number" id="profitCenters">-</div>
    <div class="stat-label">Profit Centers</div>
  </div>
  <div class="stat-card" onclick="openCostCenterModal()">
    <div class="stat-icon">üéØ</div>
    <div class="stat-number" id="costCenters">-</div>
    <div class="stat-label">Cost Centers</div>
  </div>
</div>

        </div>

        <!-- Search Modal -->
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Search Employee</h2>
                    <span class="close" onclick="closeSearchModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Enter employee name or employee number..." 
                           oninput="searchEmployees()">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Employee Details</h2>
                    <span class="close" onclick="closeDetailModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="employeeDetails"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Designation Modal -->
<div id="designationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Designation-wise Count</h2>
      <span class="close" onclick="closeDesignationModal()">&times;</span>
    </div>
    <div class="modal-body" id="designationList"></div>
  </div>
</div>

<!-- Employee List Modal -->
<div id="employeeListModal" class="modal" style="z-index: 1100;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Employee List</h2>
      <span class="close" onclick="closeEmployeeListModal()">&times;</span>
    </div>
    <div class="modal-body" id="employeeListBody"></div>
  </div>
</div>
<!-- Profit Center Modal -->
<div id="profitCenterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Profit Center-wise Summary</h2>
      <span class="close" onclick="closeProfitCenterModal()">&times;</span>
    </div>
    <div class="modal-body" id="profitCenterList"></div>
  </div>
</div>

<!-- Cost Center Modal -->
<div id="costCenterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Cost Center-wise Summary</h2>
      <span class="close" onclick="closeCostCenterModal()">&times;</span>
    </div>
    <div class="modal-body" id="costCenterList"></div>
  </div>
</div>


    <script>
        let employeeData = [];
        let authorizedPins = [];
        let isDataLoaded = false;
        let isAuthenticated = false;

        // Load PIN data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadAuthorizedPins();
        });

        async function loadAuthorizedPins() {
            // Load PINs from Sheet2, Column B
            // Note: You may need to adjust the gid parameter for Sheet2
            const pinUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRXojudL5q-ln7pXOcbLaGsBqznppnvsINcp8xEFvpJUWRCiC7bjii9eZYSu0istzyM91m4yybd5g-/pub?gid=2073511562&single=true&output=csv';
            
            try {
                showAuthLoading('Loading authorization data...');
                const response = await fetch(pinUrl);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: false,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Extract Column B (index 1) values, skipping header row
                        authorizedPins = results.data.slice(1).map(row => {
                            return row[1] ? row[1].toString().trim() : null;
                        }).filter(pin => pin && pin !== '');
                        
                        hideAuthLoading();
                        console.log('Loaded authorized PINs');
                        
                        // Focus on PIN input
                        document.getElementById('pinInput').focus();
                    },
                    error: function(error) {
                        console.error('Error loading PINs:', error);
                        showAuthError('Failed to load authorization data. Please refresh the page.');
                        hideAuthLoading();
                    }
                });
            } catch (error) {
                console.error('Error fetching PIN data:', error);
                showAuthError('Failed to connect to authorization server. Please check your internet connection.');
                hideAuthLoading();
            }
        }

        function handlePinKeyPress(event) {
            if (event.key === 'Enter') {
                validatePin();
            }
        }

        async function validatePin() {
            const pinInput = document.getElementById('pinInput');
            const enteredPin = pinInput.value.trim();
            
            if (!enteredPin) {
                showAuthError('Please enter a PIN.');
                return;
            }

            if (authorizedPins.length === 0) {
                showAuthError('Authorization data not loaded. Please refresh the page.');
                return;
            }

            showAuthLoading('Validating PIN...');
            disableAuthButton(true);
            
            // Small delay to show loading state
            setTimeout(() => {
                if (authorizedPins.includes(enteredPin)) {
                    // PIN is valid - authenticate user and load dashboard
                    isAuthenticated = true;
                    showAuthLoading('Access granted! Loading dashboard...');
                    
                    setTimeout(() => {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('dashboardContent').style.display = 'block';
                        loadEmployeeData();
                    }, 1000);
                } else {
                    // PIN is invalid
                    showAuthError('Ask admin to authorize you.');
                    pinInput.value = '';
                    pinInput.focus();
                    hideAuthLoading();
                    disableAuthButton(false);
                }
            }, 1500);
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showAuthLoading(message) {
            const loadingDiv = document.getElementById('authLoading');
            loadingDiv.textContent = message;
            loadingDiv.style.display = 'block';
        }

        function hideAuthLoading() {
            document.getElementById('authLoading').style.display = 'none';
        }

        function disableAuthButton(disabled) {
            const authBtn = document.getElementById('authBtn');
            authBtn.disabled = disabled;
            document.getElementById('authBtnText').textContent = disabled ? '‚è≥ Validating...' : 'üîì Authenticate';
        }

        async function loadEmployeeData() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRXojudL5q-ln7pXOcbLaGsBqznppnvsINcp8xEFvpJUWRCiC7bjii9eZYSu0istzyM91m4yybd5g-/pub?gid=2110628491&single=true&output=csv';
            
            try {
                showLoading();
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Clean headers by removing whitespace
                        employeeData = results.data.map(row => {
                            const cleanRow = {};
                            Object.keys(row).forEach(key => {
                                const cleanKey = key.trim();
                                cleanRow[cleanKey] = row[key];
                            });
                            return cleanRow;
                        }).filter(row => row.Name && row.Name.trim() !== '');
                        
                        updateStats();
                        isDataLoaded = true;
                        hideLoading();
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        showError('Failed to load employee data. Please try again.');
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to fetch employee data. Please check your internet connection.');
            }
        }

        function updateStats() {
            const totalEmployees = employeeData.length;
            const profitCenters = new Set(employeeData.map(emp => emp['Profit Center Code']).filter(code => code)).size;
            const costCenters = new Set(employeeData.map(emp => emp['Cost Center Code']).filter(code => code)).size;

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('profitCenters').textContent = profitCenters;
            document.getElementById('costCenters').textContent = costCenters;
        }

        function showLoading() {
            document.getElementById('totalEmployees').textContent = '...';
            document.getElementById('profitCenters').textContent = '...';
            document.getElementById('costCenters').textContent = '...';
        }

        function hideLoading() {
            // Stats are updated in updateStats()
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.search-section'));
        }

        function openSearchModal() {
            if (!isDataLoaded) {
                alert('Employee data is still loading. Please wait a moment.');
                return;
            }
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('searchInput').focus();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (searchTerm === '') {
                resultsDiv.innerHTML = '';
                return;
            }

            const filteredEmployees = employeeData.filter(employee => {
                const name = (employee.Name || '').toString().toLowerCase();
                const empNo = (employee['Employee No'] || '').toString().toLowerCase();
                return name.includes(searchTerm) || empNo.includes(searchTerm);
            });

            if (filteredEmployees.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No employees found matching your search.</div>';
                return;
            }

            let html = '';
            filteredEmployees.forEach((employee, index) => {
                html += `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${employee.Name || 'N/A'}</h4>
                            <p>Employee No: ${employee['Employee No'] || 'N/A'} | ${employee.Designation || 'N/A'}</p>
                        </div>
                        <button class="detail-btn" onclick="showEmployeeDetails(${employeeData.indexOf(employee)})">
                            Show Details
                        </button>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function showEmployeeDetails(index) {
            const employee = employeeData[index];
            const detailsDiv = document.getElementById('employeeDetails');

            let html = '<table class="detail-table">';
            
            const fieldsToShow = [
                'Employee No', 'Name', 'Profit Center Code', 'Profit Center Name',
                'Cost Center Code', 'Cost Center Name', 'Legacy ID', 'Position',
                'Designation', 'Class', 'Date of joining', 'Date of Retirement',
                'Date of Increment', 'IFSC Code', 'Bank Account No', 'Payscale Group',
                'Payscale Level', 'Pay', 'Grade Pay', 'Dearness Allowance',
                'House Rent Allowance', 'Gross Salary', 'PF A/C Number',
                'PF Trust ID', 'Lock Status'
            ];

            fieldsToShow.forEach(field => {
                const value = employee[field] || 'N/A';
                html += `
                    <tr>
                        <th>${field}</th>
                        <td>${value}</td>
                    </tr>
                `;
            });

            html += '</table>';
            detailsDiv.innerHTML = html;

            closeSearchModal();
            document.getElementById('detailModal').style.display = 'block';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const searchModal = document.getElementById('searchModal');
            const detailModal = document.getElementById('detailModal');
            
            if (event.target === searchModal) {
                closeSearchModal();
            }
            if (event.target === detailModal) {
                closeDetailModal();
            }
            if (event.target === document.getElementById('designationModal')) {
  closeDesignationModal();
}
if (event.target === document.getElementById('employeeListModal')) {
  closeEmployeeListModal();
}
if (event.target === document.getElementById('profitCenterModal')) {
  closeProfitCenterModal();
}
if (event.target === document.getElementById('costCenterModal')) {
  closeCostCenterModal();
}

        }

function openDesignationModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const designationMap = {};

  // Group by designation, track highest salary in each group
  employeeData.forEach(emp => {
    const desig = emp.Designation || "Unknown";
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!designationMap[desig]) {
      designationMap[desig] = {
        count: 1,
        topSalary: gross
      };
    } else {
      designationMap[desig].count += 1;
      if (gross > designationMap[desig].topSalary) {
        designationMap[desig].topSalary = gross;
      }
    }
  });

  // Sort by top salary within each designation
  const sorted = Object.entries(designationMap).sort((a, b) => {
    return b[1].topSalary - a[1].topSalary;
  });

  const container = document.getElementById('designationList');
  container.innerHTML = '';

  sorted.forEach(([desig, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${desig}</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openEmployeeList('${desig.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('designationModal').style.display = 'block';
}



function openProfitCenterModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const map = {};

  employeeData.forEach(emp => {
    const code = emp['Profit Center Code'] || 'Unknown';
    const name = emp['Profit Center Name'] || 'Unnamed';
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!map[code]) {
      map[code] = { name, count: 1, topSalary: gross };
    } else {
      map[code].count++;
      map[code].topSalary = Math.max(map[code].topSalary, gross);
    }
  });

const sorted = Object.entries(map).sort((a, b) => b[1].count - a[1].count);
  const container = document.getElementById('profitCenterList');
  container.innerHTML = '';

  sorted.forEach(([code, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${data.name} (${code})</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openGroupEmployeeList('Profit Center Code', '${code.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('profitCenterModal').style.display = 'block';
}

function openCostCenterModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const map = {};

  employeeData.forEach(emp => {
    const code = emp['Cost Center Code'] || 'Unknown';
    const name = emp['Cost Center Name'] || 'Unnamed';
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!map[code]) {
      map[code] = { name, count: 1, topSalary: gross };
    } else {
      map[code].count++;
      map[code].topSalary = Math.max(map[code].topSalary, gross);
    }
  });

const sorted = Object.entries(map).sort((a, b) => b[1].count - a[1].count);
  const container = document.getElementById('costCenterList');
  container.innerHTML = '';

  sorted.forEach(([code, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${data.name} (${code})</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openGroupEmployeeList('Cost Center Code', '${code.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('costCenterModal').style.display = 'block';
}

function openGroupEmployeeList(fieldName, value) {
  const list = employeeData
    .filter(emp => (emp[fieldName] || '') === value)
.sort((a, b) => {
  const placeA = (a['Cost Center Name'] || '').toLowerCase();
  const placeB = (b['Cost Center Name'] || '').toLowerCase();
  return placeA.localeCompare(placeB);
});

  const container = document.getElementById('employeeListBody');

  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
    let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
    list.forEach(emp => {
      html += `
        <tr>
          <td>${emp.Name || 'N/A'}</td>
          <td>${emp['Employee No'] || 'N/A'}</td>
          <td>${emp['Cost Center Name'] || 'N/A'}</td>
        </tr>
      `;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  document.getElementById('employeeListModal').style.display = 'block';
}

function closeProfitCenterModal() {
  document.getElementById('profitCenterModal').style.display = 'none';
}

function closeCostCenterModal() {
  document.getElementById('costCenterModal').style.display = 'none';
}


function closeDesignationModal() {
  document.getElementById('designationModal').style.display = 'none';
}

function openEmployeeList(designation) {
const list = employeeData
  .filter(emp => (emp.Designation || '') === designation)
.sort((a, b) => {
  const placeA = (a['Cost Center Name'] || '').toLowerCase();
  const placeB = (b['Cost Center Name'] || '').toLowerCase();
  return placeA.localeCompare(placeB);
});

  const container = document.getElementById('employeeListBody');
  
  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
    let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
    list.forEach(emp => {
      html += `
        <tr>
          <td>${emp.Name || 'N/A'}</td>
          <td>${emp['Employee No'] || 'N/A'}</td>
          <td>${emp['Cost Center Name'] || 'N/A'}</td>
        </tr>
      `;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  document.getElementById('employeeListModal').style.display = 'block';
}

function closeEmployeeListModal() {
  document.getElementById('employeeListModal').style.display = 'none';
}

    </script>
</body>
</html>
