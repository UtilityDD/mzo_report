<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
   <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        /* Authentication Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100dvh;       
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .auth-header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            color: #1976d2;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .pin-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }

        .pin-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .auth-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            min-height: 44px;
        }

        .auth-btn:hover:not(:disabled) {
            background: #1565c0;
        }

        .auth-btn:disabled {
            background: #ccc;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            text-align: left;
        }

        .loading-message {
            color: #666;
            margin-top: 12px;
            font-size: 14px;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: #1976d2;
            color: white;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            padding: 16px;
        }

        .search-section {
                    margin-top: 16px;
            margin-bottom: 16px;
        }

        .search-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: #1565c0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon {
            font-size: 1.5rem;
            color: #1976d2;
        }

        .stat-text {
            display: flex;
            flex-direction: column;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-arrow {
            color: #ccc;
            font-size: 1.2rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
        }
#detailModal {
    z-index: 1200;
}
        .modal-content {
            background: white;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #1976d2;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .close {
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            min-width: 32px;
            text-align: center;
        }

        .modal-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .employee-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }

        .employee-item:active {
            background: #f0f0f0;
        }

        .employee-info h4 {
            margin: 0 0 4px 0;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        .employee-info p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .detail-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            min-height: 32px;
            transition: background 0.2s;
        }

        .detail-btn:hover {
            background: #1565c0;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .detail-table th,
        .detail-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .detail-table th {
            background: #f5f5f5;
            font-weight: 500;
            color: #333;
            font-size: 12px;
        }

        .detail-table td {
            font-size: 13px;
        }

        .no-results {
            text-align: center;
            padding: 32px 16px;
            color: #666;
            font-size: 14px;
        }

        /* Responsive adjustments for larger screens */
        @media (min-width: 768px) {
            .modal-content {
                margin: 5% auto;
                width: 90%;
                max-width: 600px;
                height: auto;
                max-height: 80vh;
                border-radius: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
            }
        }

        /* Android-style loading indicator */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        @media (max-width: 767px) {
  .header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    z-index: 999;
    border-bottom: 1px solid #ccc;
  }

  .dashboard .container {
    padding-top: 80px; /* Add enough space to prevent overlap with fixed header */
  }
}

    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>üîê</h1>
                <p>Please enter your PIN to access the Employee Dashboard</p>
            </div>
            <div>
                <input type="password" class="pin-input" id="pinInput" 
                       placeholder="Enter PIN..." 
                       onkeypress="handlePinKeyPress(event)"
                       maxlength="10">
                <button class="auth-btn" id="authBtn" onclick="validatePin()">
                    <span id="authBtnText">üîì Authenticate</span>
                </button>
                <div id="authError" class="error-message" style="display: none;"></div>
                <div id="authLoading" class="loading-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content - Hidden until authenticated -->
    <div id="dashboardContent" class="dashboard">
                    <div class="header">
                <h1>Employee Dashboard</h1>
                <p>Malda Zone Only</p>
            </div>
        <div class="container">
            <div class="search-section">
                <button class="search-btn" onclick="openSearchModal()">
                    üîç Search Employee
                </button>
            </div>

<div class="stats-grid">
  <div class="stat-card" onclick="openDesignationModal()">
    <div class="stat-icon">üë•</div>
    <div class="stat-number" id="totalEmployees">-</div>
    <div class="stat-label">Total Employees</div>
  </div>
  <div class="stat-card" onclick="openProfitCenterModal()">
    <div class="stat-icon">üè¢</div>
    <div class="stat-number" id="profitCenters">-</div>
    <div class="stat-label">Profit Centers</div>
  </div>
  <div class="stat-card" onclick="openCostCenterModal()">
    <div class="stat-icon">üéØ</div>
    <div class="stat-number" id="costCenters">-</div>
    <div class="stat-label">Cost Centers</div>
  </div>
<div class="stat-card" onclick="openRetirementModal()" style="border-left: 4px solid #d32f2f;">
  <div class="stat-icon" style="color: #d32f2f;">ü´Ç</div>
  <div class="stat-number" style="color: #d32f2f;" id="upcomingRetirements">-</div>
  <div class="stat-label" style="color: #d32f2f;">Upcoming Retirements</div>
</div>
</div>

        </div>

        <!-- Search Modal -->
        <div id="searchModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Search Employee</h2>
                    <span class="close" onclick="closeSearchModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Enter employee name or employee number..." 
                           oninput="searchEmployees()">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Employee Details</h2>
                    <span class="close" onclick="closeDetailModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="employeeDetails"></div>
                </div>
            </div>
        </div>
    </div>



<!-- Employee List Modal -->
<div id="employeeListModal" class="modal" style="z-index: 1100;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Employee List</h2>
      <span class="close" onclick="closeEmployeeListModal()">&times;</span>
    </div>
    <div class="modal-body" id="employeeListBody"></div>
  </div>
</div>
<!-- Profit Center Modal -->
<div id="profitCenterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Profit Center-wise Summary</h2>
      <span class="close" onclick="closeProfitCenterModal()">&times;</span>
    </div>
    <div class="modal-body" id="profitCenterList"></div>
  </div>
</div>

<!-- Cost Center Modal -->
<div id="costCenterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Cost Center-wise Summary</h2>
      <span class="close" onclick="closeCostCenterModal()">&times;</span>
    </div>
    <div class="modal-body" id="costCenterList"></div>
  </div>
</div>
<!-- Designation Modal -->
<div id="designationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Designation-wise Count</h2>
      <span class="close" onclick="closeDesignationModal()">&times;</span>
    </div>
    <div class="modal-body" id="designationList"></div>
  </div>
</div>
<!-- Retirement Modal -->
<div id="retirementModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="background: #d32f2f;">
      <h2>Upcoming Retirements</h2>
      <span class="close" onclick="closeRetirementModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="stats-grid">
        <div class="stat-card" onclick="openRetirementListModal('3 months')" style="border-left: 4px solid #ff5722;">
          <div class="stat-content">
            <div class="stat-icon" style="color: #ff5722;">‚ö†Ô∏è</div>
            <div class="stat-text">
              <div class="stat-number" style="color: #ff5722;" id="retire3Months">-</div>
              <div class="stat-label">Within 3 Months</div>
            </div>
          </div>
          <div class="stat-arrow">‚Ä∫</div>
        </div>
        <div class="stat-card" onclick="openRetirementListModal('6 months')" style="border-left: 4px solid #ff9800;">
          <div class="stat-content">
            <div class="stat-icon" style="color: #ff9800;">üìÖ</div>
            <div class="stat-text">
              <div class="stat-number" style="color: #ff9800;" id="retire6Months">-</div>
              <div class="stat-label">Within 6 Months</div>
            </div>
          </div>
          <div class="stat-arrow">‚Ä∫</div>
        </div>
        <div class="stat-card" onclick="openRetirementListModal('1 year')" style="border-left: 4px solid #ffc107;">
          <div class="stat-content">
            <div class="stat-icon" style="color: #ffc107;">üìã</div>
            <div class="stat-text">
              <div class="stat-number" style="color: #ffc107;" id="retire1Year">-</div>
              <div class="stat-label">Within 1 Year</div>
            </div>
          </div>
          <div class="stat-arrow">‚Ä∫</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Retirement List Modal -->
<div id="retirementListModal" class="modal" style="z-index: 1100;">
  <div class="modal-content">
    <div class="modal-header" style="background: #d32f2f;">
      <h2 id="retirementListTitle">Retirement List</h2>
      <span class="close" onclick="closeRetirementListModal()">&times;</span>
    </div>
    <div class="modal-body" id="retirementListBody"></div>
  </div>
</div>
    <script>
        
        let employeeData = [];
        let authorizedPins = [];
        let isDataLoaded = false;
        let isAuthenticated = false;
        let openedFromSearch = false;
        let openedFromList = false;


        // Load PIN data on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadAuthorizedPins();
        });

        async function loadAuthorizedPins() {
            // Load PINs from Sheet2, Column B
            // Note: You may need to adjust the gid parameter for Sheet2
            const pinUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRXojudL5q-ln7pXOcbLaGsBqznppnvsINcp8xEFvpJUWRCiC7bjii9eZYSu0istzyM91m4yybd5g-/pub?gid=2073511562&single=true&output=csv';
            
            try {
                showAuthLoading('Loading authorization data...');
                const response = await fetch(pinUrl);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: false,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Extract Column B (index 1) values, skipping header row
                        authorizedPins = results.data.slice(1).map(row => {
                            return row[1] ? row[1].toString().trim() : null;
                        }).filter(pin => pin && pin !== '');
                        
                        hideAuthLoading();
                        console.log('Loaded authorized PINs');
                        
                        // Focus on PIN input
                        document.getElementById('pinInput').focus();
                    },
                    error: function(error) {
                        console.error('Error loading PINs:', error);
                        showAuthError('Failed to load authorization data. Please refresh the page.');
                        hideAuthLoading();
                    }
                });
            } catch (error) {
                console.error('Error fetching PIN data:', error);
                showAuthError('Failed to connect to authorization server. Please check your internet connection.');
                hideAuthLoading();
            }
        }

        function handlePinKeyPress(event) {
            if (event.key === 'Enter') {
                validatePin();
            }
        }

        async function validatePin() {
            const pinInput = document.getElementById('pinInput');
            const enteredPin = pinInput.value.trim();
            
            if (!enteredPin) {
                showAuthError('Please enter a PIN.');
                return;
            }

            if (authorizedPins.length === 0) {
                showAuthError('Authorization data not loaded. Please refresh the page.');
                return;
            }

            showAuthLoading('Validating PIN...');
            disableAuthButton(true);
            
            // Small delay to show loading state
            setTimeout(() => {
                if (authorizedPins.includes(enteredPin)) {
                    // PIN is valid - authenticate user and load dashboard
                    isAuthenticated = true;
                    showAuthLoading('Access granted! Loading dashboard...');
                    
                    setTimeout(() => {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('dashboardContent').style.display = 'block';
                        loadEmployeeData();
                    }, 1000);
                } else {
                    // PIN is invalid
                    showAuthError('Ask admin to authorize you.');
                    pinInput.value = '';
                    pinInput.focus();
                    hideAuthLoading();
                    disableAuthButton(false);
                }
            }, 1500);
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showAuthLoading(message) {
            const loadingDiv = document.getElementById('authLoading');
            loadingDiv.textContent = message;
            loadingDiv.style.display = 'block';
        }

        function hideAuthLoading() {
            document.getElementById('authLoading').style.display = 'none';
        }

        function disableAuthButton(disabled) {
            const authBtn = document.getElementById('authBtn');
            authBtn.disabled = disabled;
            document.getElementById('authBtnText').textContent = disabled ? '‚è≥ Validating...' : 'üîì Authenticate';
        }

        async function loadEmployeeData() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRXojudL5q-ln7pXOcbLaGsBqznppnvsINcp8xEFvpJUWRCiC7bjii9eZYSu0istzyM91m4yybd5g-/pub?gid=2110628491&single=true&output=csv';
            
            try {
                showLoading();
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Clean headers by removing whitespace
                        employeeData = results.data.map(row => {
                            const cleanRow = {};
                            Object.keys(row).forEach(key => {
                                const cleanKey = key.trim();
                                cleanRow[cleanKey] = row[key];
                            });
                            return cleanRow;
                        }).filter(row => row.Name && row.Name.trim() !== '');
                        
                        updateStats();
                        isDataLoaded = true;
                        hideLoading();
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        showError('Failed to load employee data. Please try again.');
                    }
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('Failed to fetch employee data. Please check your internet connection.');
            }
        }

        function updateStats() {
            const totalEmployees = employeeData.length;
            const profitCenters = new Set(employeeData.map(emp => emp['Profit Center Code']).filter(code => code)).size;
            const costCenters = new Set(employeeData.map(emp => emp['Cost Center Code']).filter(code => code)).size;

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('profitCenters').textContent = profitCenters;
            document.getElementById('costCenters').textContent = costCenters;
        }

        function showLoading() {
            document.getElementById('totalEmployees').textContent = '...';
            document.getElementById('profitCenters').textContent = '...';
            document.getElementById('costCenters').textContent = '...';
        }

        function hideLoading() {
            // Stats are updated in updateStats()
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.search-section'));
        }

        function openSearchModal() {
            if (!isDataLoaded) {
                alert('Employee data is still loading. Please wait a moment.');
                return;
            }
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('searchInput').focus();
        }

        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (searchTerm === '') {
                resultsDiv.innerHTML = '';
                return;
            }

            const filteredEmployees = employeeData.filter(employee => {
                const name = (employee.Name || '').toString().toLowerCase();
                const empNo = (employee['Employee No'] || '').toString().toLowerCase();
                return name.includes(searchTerm) || empNo.includes(searchTerm);
            });

            if (filteredEmployees.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">No employees found matching your search.</div>';
                return;
            }

            let html = '';
            filteredEmployees.forEach((employee, index) => {
                html += `
                    <div class="employee-item">
                        <div class="employee-info">
                            <h4>${employee.Name || 'N/A'}</h4>
                            <p>Employee No: ${employee['Employee No'] || 'N/A'} | ${employee.Designation || 'N/A'}</p>
                        </div>
                            <button class="detail-btn" onclick="openedFromSearch = true; showEmployeeDetails(${employeeData.indexOf(employee)})">
                            Show Details
                        </button>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

function showEmployeeDetails(index) {
    const employee = employeeData[index];
    const detailsDiv = document.getElementById('employeeDetails');
    
    // Update modal header with employee name
    const modalHeader = document.querySelector('#detailModal .modal-header h2');
    modalHeader.innerHTML = `${employee.Name || 'Employee Details'}`;
    
    // Calculate service duration
// Calculate service duration
let serviceDuration = '';
const joiningDate = employee['Date of joining'];
if (joiningDate && joiningDate !== 'N/A' && joiningDate !== '' && joiningDate !== null && joiningDate !== undefined) {
    let joinDate;
    if (typeof joiningDate === 'number') {
        // Convert Excel serial date
        const excelEpoch = new Date(1900, 0, 1);
        joinDate = new Date(excelEpoch.getTime() + (joiningDate - 2) * 24 * 60 * 60 * 1000);
    } else {
        // Handle string dates - check format
        const dateStr = joiningDate.toString().trim();
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // Assume DD/MM/YYYY format and convert to MM/DD/YYYY
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                joinDate = new Date(`${month}/${day}/${year}`);
            } else {
                joinDate = new Date(dateStr);
            }
        } else if (dateStr.includes('.')) {
            const parts = dateStr.split('.');
            if (parts.length === 3) {
                // Handle DD.MM.YYYY format
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                joinDate = new Date(`${month}/${day}/${year}`);
            } else {
                joinDate = new Date(dateStr);
            }
        } else {
            joinDate = new Date(dateStr);
        }
    }
    
    if (!isNaN(joinDate.getTime()) && joinDate.getFullYear() > 1900) {
        const today = new Date();
        let years = today.getFullYear() - joinDate.getFullYear();
        let months = today.getMonth() - joinDate.getMonth();
        let days = today.getDate() - joinDate.getDate();
        
        if (days < 0) {
            months--;
            days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
        }
        if (months < 0) {
            years--;
            months += 12;
        }
        
        // Ensure non-negative values
        years = Math.max(0, years);
        months = Math.max(0, months);
        days = Math.max(0, days);
        
        serviceDuration = `<p style="color: #1976d2; font-weight: bold; margin-bottom: 16px;">Serving for ${years} yrs, ${months} months, ${days} days</p>`;
    }
}

let html = serviceDuration + '<table class="detail-table">';            
            const fieldsToShow = [
                'Employee No', 'Name', 'Profit Center Code', 'Profit Center Name',
                'Cost Center Code', 'Cost Center Name', 'Legacy ID', 'Position',
                'Designation', 'Class', 'Date of joining', 'Date of Retirement',
                'Date of Increment', 'IFSC Code', 'Bank Account No', 'Payscale Group',
                'Payscale Level', 'Pay', 'Grade Pay', 'Dearness Allowance',
                'House Rent Allowance', 'Gross Salary', 'PF A/C Number',
                'PF Trust ID', 'Lock Status'
            ];

fieldsToShow.forEach(field => {
    let value = employee[field] || 'N/A';
    
    // Handle date fields
    if ((field === 'Date of joining' || field === 'Date of Retirement' || field === 'Date of Increment') && value !== 'N/A') {
        if (typeof value === 'number') {
            // Convert Excel serial date to JavaScript date
            const excelEpoch = new Date(1900, 0, 1);
            const jsDate = new Date(excelEpoch.getTime() + (value - 2) * 24 * 60 * 60 * 1000);
            value = jsDate.toLocaleDateString('en-GB');
        }
    }
    
    html += `
        <tr>
            <th>${field}</th>
            <td>${value}</td>
        </tr>
    `;
});

            html += '</table>';
            detailsDiv.innerHTML = html;

if (!openedFromSearch) {
    closeSearchModal();
} else {
    openedFromSearch = false;
}

if (!openedFromList) {
    closeEmployeeListModal();
} else {
    openedFromList = false;
}

document.getElementById('detailModal').style.display = 'block';

        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const searchModal = document.getElementById('searchModal');
            const detailModal = document.getElementById('detailModal');
            
            if (event.target === searchModal) {
                closeSearchModal();
            }
            if (event.target === detailModal) {
                closeDetailModal();
            }
            if (event.target === document.getElementById('designationModal')) {
  closeDesignationModal();
}
if (event.target === document.getElementById('employeeListModal')) {
  closeEmployeeListModal();
}
if (event.target === document.getElementById('profitCenterModal')) {
  closeProfitCenterModal();
}
if (event.target === document.getElementById('costCenterModal')) {
  closeCostCenterModal();
}

        }

function openDesignationModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const designationMap = {};

  // Group by designation, track highest salary in each group
  employeeData.forEach(emp => {
    const desig = emp.Designation || "Unknown";
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!designationMap[desig]) {
      designationMap[desig] = {
        count: 1,
        topSalary: gross
      };
    } else {
      designationMap[desig].count += 1;
      if (gross > designationMap[desig].topSalary) {
        designationMap[desig].topSalary = gross;
      }
    }
  });

  // Sort by top salary within each designation
  const sorted = Object.entries(designationMap).sort((a, b) => {
    return b[1].topSalary - a[1].topSalary;
  });

  const container = document.getElementById('designationList');
  container.innerHTML = '';

  sorted.forEach(([desig, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${desig}</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openEmployeeList('${desig.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('designationModal').style.display = 'block';
}



function openProfitCenterModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const map = {};

  employeeData.forEach(emp => {
    const code = emp['Profit Center Code'] || 'Unknown';
    const name = emp['Profit Center Name'] || 'Unnamed';
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!map[code]) {
      map[code] = { name, count: 1, topSalary: gross };
    } else {
      map[code].count++;
      map[code].topSalary = Math.max(map[code].topSalary, gross);
    }
  });

const sorted = Object.entries(map).sort((a, b) => b[1].count - a[1].count);
  const container = document.getElementById('profitCenterList');
  container.innerHTML = '';

  sorted.forEach(([code, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${data.name} (${code})</h4>
        <p>${data.count} employees</p>
      </div>
<button class="detail-btn" onclick="openDesignationWithinProfitCenter('${code.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('profitCenterModal').style.display = 'block';
}

function openDesignationWithinProfitCenter(profitCenterCode) {
  const filtered = employeeData.filter(emp => (emp['Profit Center Code'] || '') === profitCenterCode);
  const designationMap = {};

  filtered.forEach(emp => {
    const desig = emp.Designation || "Unknown";
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!designationMap[desig]) {
      designationMap[desig] = {
        count: 1,
        topSalary: gross
      };
    } else {
      designationMap[desig].count += 1;
      designationMap[desig].topSalary = Math.max(designationMap[desig].topSalary, gross);
    }
  });

  const sorted = Object.entries(designationMap).sort((a, b) => b[1].topSalary - a[1].topSalary);
  const container = document.getElementById('designationList');
  container.innerHTML = '';

  sorted.forEach(([desig, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${desig}</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openEmployeeListFiltered('${profitCenterCode.replace(/'/g, "\\'")}', '${desig.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('designationModal').style.display = 'block';
}

function openDesignationWithinCostCenter(costCenterCode) {
  const filtered = employeeData.filter(emp => (emp['Cost Center Code'] || '') === costCenterCode);
  const designationMap = {};

  filtered.forEach(emp => {
    const desig = emp.Designation || "Unknown";
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!designationMap[desig]) {
      designationMap[desig] = {
        count: 1,
        topSalary: gross
      };
    } else {
      designationMap[desig].count += 1;
      designationMap[desig].topSalary = Math.max(designationMap[desig].topSalary, gross);
    }
  });

  const sorted = Object.entries(designationMap).sort((a, b) => b[1].topSalary - a[1].topSalary);
  const container = document.getElementById('designationList');
  container.innerHTML = '';

  sorted.forEach(([desig, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${desig}</h4>
        <p>${data.count} employees</p>
      </div>
      <button class="detail-btn" onclick="openEmployeeListFilteredByCostCenter('${costCenterCode.replace(/'/g, "\\'")}', '${desig.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('designationModal').style.display = 'block';
}

function openCostCenterModal() {
  if (!isDataLoaded) return alert("Data is still loading...");

  const map = {};

  employeeData.forEach(emp => {
    const code = emp['Cost Center Code'] || 'Unknown';
    const name = emp['Cost Center Name'] || 'Unnamed';
    const gross = parseFloat(emp['Gross Salary']) || 0;

    if (!map[code]) {
      map[code] = { name, count: 1, topSalary: gross };
    } else {
      map[code].count++;
      map[code].topSalary = Math.max(map[code].topSalary, gross);
    }
  });

const sorted = Object.entries(map).sort((a, b) => b[1].count - a[1].count);
  const container = document.getElementById('costCenterList');
  container.innerHTML = '';

  sorted.forEach(([code, data]) => {
    const div = document.createElement('div');
    div.className = 'employee-item';
    div.innerHTML = `
      <div class="employee-info">
        <h4>${data.name} (${code})</h4>
        <p>${data.count} employees</p>
      </div>
<button class="detail-btn" onclick="openDesignationWithinCostCenter('${code.replace(/'/g, "\\'")}')">View</button>
    `;
    container.appendChild(div);
  });

  document.getElementById('costCenterModal').style.display = 'block';
}

function openGroupEmployeeList(fieldName, value) {
const list = employeeData
  .filter(emp => (emp[fieldName] || '') === value)
  .sort((a, b) => {
    const salaryA = parseFloat(a['Gross Salary']) || 0;
    const salaryB = parseFloat(b['Gross Salary']) || 0;
    const salaryCompare = salaryB - salaryA;
    
    if (salaryCompare !== 0) return salaryCompare;
    
    const placeA = (a['Cost Center Name'] || '').toLowerCase();
    const placeB = (b['Cost Center Name'] || '').toLowerCase();
    return placeA.localeCompare(placeB);
  });

  const container = document.getElementById('employeeListBody');

  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
list.forEach(emp => {
  const empIndex = employeeData.indexOf(emp);
  html += `
<tr style="cursor: pointer;" onclick="openedFromList = true; showEmployeeDetails(${empIndex})">
      <td>${emp.Name || 'N/A'}<br><i>${emp.Designation || 'N/A'}</i></td>
      <td>${emp['Employee No'] || 'N/A'}</td>
      <td>${emp['Cost Center Name'] || 'N/A'}</td>
    </tr>
  `;
});
    html += '</table>';
    container.innerHTML = html;
  }

  document.getElementById('employeeListModal').style.display = 'block';
}

function closeProfitCenterModal() {
  document.getElementById('profitCenterModal').style.display = 'none';
}

function closeCostCenterModal() {
  document.getElementById('costCenterModal').style.display = 'none';
}


function closeDesignationModal() {
  document.getElementById('designationModal').style.display = 'none';
}

function openEmployeeList(designation) {
  const list = employeeData
    .filter(emp => {
      const empDesignation = emp.Designation || "Unknown";
      return empDesignation === designation;
    })
    .sort((a, b) => {
      const salaryA = parseFloat(a['Gross Salary']) || 0;
      const salaryB = parseFloat(b['Gross Salary']) || 0;
      const salaryCompare = salaryB - salaryA;
      
      if (salaryCompare !== 0) return salaryCompare;
      
      const placeA = (a['Cost Center Name'] || '').toLowerCase();
      const placeB = (b['Cost Center Name'] || '').toLowerCase();
      return placeA.localeCompare(placeB);
    });

  const container = document.getElementById('employeeListBody');
  
  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
    let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
    list.forEach(emp => {
      const empIndex = employeeData.indexOf(emp);
      html += `
<tr style="cursor: pointer;" onclick="openedFromList = true; showEmployeeDetails(${empIndex})">
          <td>${emp.Name || 'N/A'}<br><i>${emp.Designation || 'N/A'}</i></td>
          <td>${emp['Employee No'] || 'N/A'}</td>
          <td>${emp['Cost Center Name'] || 'N/A'}</td>
        </tr>
      `;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  document.getElementById('employeeListModal').style.display = 'block';
}
function openEmployeeListFiltered(profitCenterCode, designation) {
  const list = employeeData.filter(emp => 
    (emp['Profit Center Code'] || '') === profitCenterCode &&
    (emp.Designation || 'Unknown') === designation
  ).sort((a, b) => {
    const salaryA = parseFloat(a['Gross Salary']) || 0;
    const salaryB = parseFloat(b['Gross Salary']) || 0;
    const salaryCompare = salaryB - salaryA;
    if (salaryCompare !== 0) return salaryCompare;

    const placeA = (a['Cost Center Name'] || '').toLowerCase();
    const placeB = (b['Cost Center Name'] || '').toLowerCase();
    return placeA.localeCompare(placeB);
  });

  const container = document.getElementById('employeeListBody');
  
  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
    let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
    list.forEach(emp => {
      const empIndex = employeeData.indexOf(emp);
      html += `
<tr style="cursor: pointer;" onclick="openedFromList = true; showEmployeeDetails(${empIndex})">
        <td>${emp.Name || 'N/A'}<br><i>${emp.Designation || 'N/A'}</i></td>
        <td>${emp['Employee No'] || 'N/A'}</td>
        <td>${emp['Cost Center Name'] || 'N/A'}</td>
      </tr>
    `;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  closeDesignationModal();  // Optional: Close Designation Modal
  document.getElementById('employeeListModal').style.display = 'block';
}
function openEmployeeListFilteredByCostCenter(costCenterCode, designation) {
  const list = employeeData.filter(emp => 
    (emp['Cost Center Code'] || '') === costCenterCode &&
    (emp.Designation || 'Unknown') === designation
  ).sort((a, b) => {
    const salaryA = parseFloat(a['Gross Salary']) || 0;
    const salaryB = parseFloat(b['Gross Salary']) || 0;
    const salaryCompare = salaryB - salaryA;
    if (salaryCompare !== 0) return salaryCompare;

    const placeA = (a['Cost Center Name'] || '').toLowerCase();
    const placeB = (b['Cost Center Name'] || '').toLowerCase();
    return placeA.localeCompare(placeB);
  });

  const container = document.getElementById('employeeListBody');

  if (list.length === 0) {
    container.innerHTML = '<p class="no-results">No employees found.</p>';
  } else {
    let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Place of Posting</th></tr>';
    list.forEach(emp => {
      const empIndex = employeeData.indexOf(emp);
      html += `
<tr style="cursor: pointer;" onclick="openedFromList = true; showEmployeeDetails(${empIndex})">
        <td>${emp.Name || 'N/A'}<br><i>${emp.Designation || 'N/A'}</i></td>
        <td>${emp['Employee No'] || 'N/A'}</td>
        <td>${emp['Cost Center Name'] || 'N/A'}</td>
      </tr>
    `;
    });
    html += '</table>';
    container.innerHTML = html;
  }

  closeDesignationModal();  // Optional
  document.getElementById('employeeListModal').style.display = 'block';
}

function closeEmployeeListModal() {
  document.getElementById('employeeListModal').style.display = 'none';
}
// ADD THESE FUNCTIONS TO YOUR JAVASCRIPT SECTION

function updateStats() {
    const totalEmployees = employeeData.length;
    const profitCenters = new Set(employeeData.map(emp => emp['Profit Center Code']).filter(code => code)).size;
    const costCenters = new Set(employeeData.map(emp => emp['Cost Center Code']).filter(code => code)).size;
    
    // Calculate upcoming retirements
    const retirementCounts = calculateUpcomingRetirements();

    document.getElementById('totalEmployees').textContent = totalEmployees;
    document.getElementById('profitCenters').textContent = profitCenters;
    document.getElementById('costCenters').textContent = costCenters;
    document.getElementById('upcomingRetirements').textContent = retirementCounts.total;
}

function calculateUpcomingRetirements() {
    const today = new Date();
    const threeMonths = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000));
    const sixMonths = new Date(today.getTime() + (180 * 24 * 60 * 60 * 1000));
    const oneYear = new Date(today.getTime() + (365 * 24 * 60 * 60 * 1000));
    
    let retire3Months = 0;
    let retire6Months = 0;
    let retire1Year = 0;
    
    employeeData.forEach(emp => {
        const retirementDate = parseRetirementDate(emp['Date of Retirement']);
        if (retirementDate && !isNaN(retirementDate.getTime()) && retirementDate > today) {
            if (retirementDate <= oneYear) {
                retire1Year++;
            }
            if (retirementDate <= threeMonths) {
                retire3Months++;
            }
            if (retirementDate <= sixMonths) {
                retire6Months++;
            }
        }
    });
    
    // Update the retirement modal counters
    if (document.getElementById('retire3Months')) {
        document.getElementById('retire3Months').textContent = retire3Months;
        document.getElementById('retire6Months').textContent = retire6Months;
        document.getElementById('retire1Year').textContent = retire1Year;
    }
    
    // Main card should show total within 1 year only
    return { total: retire1Year, retire3Months, retire6Months, retire1Year };
}

function parseRetirementDate(dateStr) {
    if (!dateStr || dateStr === 'N/A' || dateStr === '' || dateStr === null || dateStr === undefined) {
        return null;
    }
    
    let retirementDate;
    if (typeof dateStr === 'number') {
        // Convert Excel serial date
        const excelEpoch = new Date(1900, 0, 1);
        retirementDate = new Date(excelEpoch.getTime() + (dateStr - 2) * 24 * 60 * 60 * 1000);
    } else {
        // Handle string dates - check if it's DD.MM.YYYY format
        const dateString = dateStr.toString().trim();
        if (dateString.includes('.')) {
            const parts = dateString.split('.');
            if (parts.length === 3) {
                // Convert DD.MM.YYYY to MM/DD/YYYY
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                retirementDate = new Date(`${month}/${day}/${year}`);
            } else {
                retirementDate = new Date(dateString);
            }
        } else if (dateString.includes('/')) {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                // Assume DD/MM/YYYY format
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                retirementDate = new Date(`${month}/${day}/${year}`);
            } else {
                retirementDate = new Date(dateString);
            }
        } else {
            retirementDate = new Date(dateString);
        }
    }
    
    return retirementDate;
}

function openRetirementModal() {
    if (!isDataLoaded) return alert("Data is still loading...");
    
    calculateUpcomingRetirements();
    document.getElementById('retirementModal').style.display = 'block';
}

function closeRetirementModal() {
    document.getElementById('retirementModal').style.display = 'none';
}

function openRetirementListModal(period) {
    const today = new Date();
    let endDate;
    let title;
    
    switch(period) {
        case '3 months':
            endDate = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000));
            title = 'Retiring within 3 Months';
            break;
        case '6 months':
            endDate = new Date(today.getTime() + (180 * 24 * 60 * 60 * 1000));
            title = 'Retiring within 6 Months';
            break;
        case '1 year':
            endDate = new Date(today.getTime() + (365 * 24 * 60 * 60 * 1000));
            title = 'Retiring within 1 Year';
            break;
    }
    
    const retiringEmployees = employeeData.filter(emp => {
        const retirementDate = parseRetirementDate(emp['Date of Retirement']);
        return retirementDate && !isNaN(retirementDate.getTime()) && 
               retirementDate > today && retirementDate <= endDate;
    }).sort((a, b) => {
        const dateA = parseRetirementDate(a['Date of Retirement']);
        const dateB = parseRetirementDate(b['Date of Retirement']);
        return dateA - dateB; // Sort by retirement date (earliest first)
    });
    
    document.getElementById('retirementListTitle').textContent = title;
    const container = document.getElementById('retirementListBody');
    
    if (retiringEmployees.length === 0) {
        container.innerHTML = '<p class="no-results">No employees retiring in this period.</p>';
    } else {
        let html = '<table class="detail-table"><tr><th>Name</th><th>Employee No</th><th>Retirement Date</th><th>Place of Posting</th></tr>';
        retiringEmployees.forEach(emp => {
            const empIndex = employeeData.indexOf(emp);
            const retirementDate = parseRetirementDate(emp['Date of Retirement']);
            const formattedDate = retirementDate ? retirementDate.toLocaleDateString('en-GB') : 'N/A';
            
            html += `
<tr style="cursor: pointer;" onclick="openedFromList = true; showEmployeeDetails(${empIndex})">
                    <td>${emp.Name || 'N/A'}<br><i>${emp.Designation || 'N/A'}</i></td>
                    <td>${emp['Employee No'] || 'N/A'}</td>
                    <td style="color: #d32f2f; font-weight: bold;">${formattedDate}</td>
                    <td>${emp['Cost Center Name'] || 'N/A'}</td>
                </tr>
            `;
        });
        html += '</table>';
        container.innerHTML = html;
    }
    
    document.getElementById('retirementListModal').style.display = 'block';
}

function closeRetirementListModal() {
    document.getElementById('retirementListModal').style.display = 'none';
}

// ADD THIS TO THE EXISTING window.onclick FUNCTION
// Add these lines to the existing window.onclick function:
if (event.target === document.getElementById('retirementModal')) {
    closeRetirementModal();
}
if (event.target === document.getElementById('retirementListModal')) {
    closeRetirementListModal();
}
    </script>
</body>
</html>
