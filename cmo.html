<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CMO Grievances</title>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --primary-light: #42a5f5;
      --primary-dark: #0d47a1;
      --secondary: #ff5722;
      --accent: #ffc107;
      --text-primary: #212121;
      --text-secondary: #757575;
      --bg-light: #fafafa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --surface: #ffffff;
      --divider: #e0e0e0;
      --shadow: rgba(0,0,0,0.1);
      --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      --elevation-4: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Header - Android Style */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--primary);
      color: white;
      z-index: 1000;
      box-shadow: var(--elevation-2);
      padding: 12px 0;
    }
    
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 0 16px;
    }
    
    h1 {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
      letter-spacing: 0.0125em;
    }
    
    #report-date {
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.87;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #report-date i {
      font-size: 0.7rem;
    }
    
    #total-pending-zone {
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(255,255,255,0.15);
      padding: 4px 12px;
      border-radius: 12px;
      margin-top: 2px;
    }
    
    /* Main content with top padding for fixed header */
    .main-content {
      padding-top: 120px;
      min-height: 100vh;
    }
    
    /* Breadcrumb - Material Design */
    .breadcrumb {
      display: flex;
      padding: 8px 0;
      margin: 0;
      list-style: none;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.875rem;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      color: var(--text-secondary);
    }
    
    .breadcrumb-item a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .breadcrumb-item a:hover {
      background-color: rgba(25, 118, 210, 0.08);
    }
    
    .breadcrumb-item:not(:first-child)::before {
      content: "›";
      padding: 0 4px;
      color: var(--text-secondary);
      font-weight: 300;
    }
    
    /* Slider - Material Design */
    #slider-container {
      background: var(--surface);
      padding: 16px;
      margin: 8px 0;
      border-radius: 8px;
      box-shadow: var(--elevation-1);
    }
    
    #slider-container label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      display: block;
      margin-bottom: 12px;
    }
    
    .slider-flex {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    #slider-container input[type="range"] {
      flex: 1;
      appearance: none;
      height: 4px;
      background: var(--divider);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }
    
    #slider-container input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--elevation-1);
    }
    
    #slider-container input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--primary);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: var(--elevation-1);
    }
    
    #selectedMonth {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--primary);
      min-width: 120px;
      text-align: right;
    }
    
    /* Cards - Material Design */
    .card-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .card {
      background: var(--surface);
      border-radius: 8px;
      box-shadow: var(--elevation-1);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      border: none;
    }
    
    .card:hover {
      box-shadow: var(--elevation-2);
    }
    
    .card:active {
      transform: scale(0.98);
    }
    
    .card.completed {
      border-left: 4px solid var(--success);
    }
    
    .card .toggle-indicator {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      transition: transform 0.2s ease;
      font-size: 1.2rem;
    }
    
    .card.active .toggle-indicator {
      transform: translateY(-50%) rotate(180deg);
    }
    
    .card h3 {
      margin: 0 24px 8px 0;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.2;
    }
    
    .card.completed h3 {
      color: var(--success);
    }
    
    .card-stats {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    
    .card p {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--primary);
    }
    
    .card.completed p {
      color: var(--success);
    }
    
    .count-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 400;
    }
    
    /* Tables - Material Design */
    .table-container {
      background: var(--surface);
      border-radius: 8px;
      margin: 8px 0 16px 0;
      box-shadow: var(--elevation-1);
      overflow: hidden;
    }
    
    .table-container h3 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      background: rgba(25, 118, 210, 0.04);
    }
    
    .table-container h3 i {
      margin-right: 8px;
      color: var(--primary);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: var(--surface);
      color: var(--text-primary);
      font-weight: 500;
      text-align: left;
      padding: 16px;
      font-size: 0.875rem;
      border-bottom: 1px solid var(--divider);
    }
    
    td {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr.clickable:hover td {
      background: rgba(25, 118, 210, 0.04);
    }
    
    tr.clickable {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    /* Action buttons - Material Design */
    .details-icon {
      cursor: pointer;
      color: var(--primary);
      font-weight: 500;
      background: rgba(25, 118, 210, 0.08);
      padding: 8px 12px;
      border-radius: 20px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
      border: none;
      min-height: 36px;
    }
    
    .details-icon:hover {
      background: rgba(25, 118, 210, 0.12);
    }
    
    .details-icon:active {
      transform: scale(0.95);
    }
    
    /* Modal - Material Design */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }
    
    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--elevation-4);
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 24px 24px 8px 24px;
      position: relative;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--text-primary);
      padding-right: 40px;
    }
    
    .modal-close {
      position: absolute;
      right: 16px;
      top: 16px;
      cursor: pointer;
      color: var(--text-secondary);
      background: transparent;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 20px;
      transition: all 0.2s;
      border: none;
    }
    
    .modal-close:hover {
      background: rgba(0,0,0,0.04);
    }
    
    .modal-body {
      padding: 0 24px 24px 24px;
    }
    
    #modal-live-since {
      color: var(--danger);
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 16px;
      padding: 8px 12px;
      background: rgba(244, 67, 54, 0.08);
      border-radius: 4px;
      border-left: 4px solid var(--danger);
    }
    
    #modal-text {
      line-height: 1.6;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    
    .modal-category {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #modal-phone {
      display: flex;
      align-items: center;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
    }
    
    .phone-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--success);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      box-shadow: var(--elevation-1);
    }
    
    .phone-icon:hover {
      background: #388e3c;
      transform: scale(1.05);
    }
    
    .phone-number {
      font-size: 1rem;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Loading state */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .loading::after {
      content: "";
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--divider);
      margin-bottom: 16px;
    }
    
    /* Card expansion group */
    .card-expansion-group {
      margin-bottom: 8px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      .main-content {
        padding-top: 100px;
      }
      
      .header-content {
        padding: 0 16px;
      }
      
      h1 {
        font-size: 1.125rem;
      }
      
      #total-pending-zone {
        font-size: 0.75rem;
        padding: 3px 10px;
      }
      
      .slider-flex {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      #selectedMonth {
        text-align: left;
        min-width: auto;
      }
      
      .card {
        padding: 12px 16px;
      }
      
      .card h3 {
        font-size: 0.9rem;
        margin-right: 20px;
      }
      
      .card p {
        font-size: 1.25rem;
      }
      
      .count-label {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 12px 16px;
        font-size: 0.8rem;
      }
      
      .table-container h3 {
        padding: 12px 16px;
        font-size: 0.9rem;
      }
      
      .modal {
        padding: 8px;
      }
      
      .modal-header {
        padding: 16px 16px 8px 16px;
      }
      
      .modal-header h3 {
        font-size: 1.125rem;
        padding-right: 32px;
      }
      
      .modal-close {
        right: 8px;
        top: 8px;
        width: 36px;
        height: 36px;
      }
      
      .modal-body {
        padding: 0 16px 16px 16px;
      }
      
      .details-icon {
        padding: 6px 12px;
        font-size: 0.8rem;
        min-height: 32px;
      }
    }
    
    /* Nested table styling for complaint lists */
    tr[id^="ps-"] td {
      padding: 0 !important;
    }
    
    tr[id^="ps-"] td > div {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
      background: rgba(25, 118, 210, 0.02);
    }
    
    tr[id^="ps-"] td > div table {
      margin: 0;
    }
    
    tr[id^="ps-"] td > div table th {
      background: rgba(25, 118, 210, 0.06);
      color: var(--primary);
      font-size: 0.8rem;
      padding: 12px 16px;
    }
    
    tr[id^="ps-"] td > div table td {
      padding: 12px 16px;
      font-size: 0.8rem;
    }
    
    tr[id^="ps-"] td > div .details-icon {
      background: rgba(255, 87, 34, 0.08);
      color: var(--secondary);
    }
    
    tr[id^="ps-"] td > div .details-icon:hover {
      background: rgba(255, 87, 34, 0.12);
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <h1>CMO Grievances</h1>
    <div id="report-date">
      <i class="fas fa-calendar-alt"></i>
      <span>Loading latest report...</span>
    </div>
    <div id="total-pending-zone"></div>
  </div>
</header>

<div class="main-content">
  <div class="container">
    <div id="breadcrumb-container"></div>
    
    <div id="slider-container">
      <label for="monthSlider">Filter by Age of Grievance</label>
      <div class="slider-flex">
        <input type="range" id="monthSlider" min="0" value="0">
        <span id="selectedMonth">All grievances</span>
      </div>
    </div>

    <div id="card-sections-container">
      <div id="pending-with-cards" class="card-container">
        <div class="loading"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Grievance Details</h3>
      <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="modal-live-since" style="display:none;"></div>
      <div id="modal-text"></div>
      <div id="modal-phone" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- Include PapaParse library -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7GVh5HflVhouhVfFOEN2RuA1kCBedmD4Q0CJP02K61DAtWuo3P8XIS8CO7ocZQuJ20uCJBa9qsgZ6/pub?gid=1066071765&single=true&output=csv";

let data = [];

let currentNavigation = {
  pendingWith: null,
  policeStation: null
};

function fetchCSV(url) {
  document.getElementById('pending-with-cards').innerHTML = '<div class="loading"></div>';
  return fetch(url)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.text();
    })
    .then(csvText => {
      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });
      return parsed.data;
    })
    .catch(error => {
      console.error('Error fetching CSV:', error);
      document.getElementById('pending-with-cards').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>Failed to load data. Please try again later.</p>
        </div>
      `;
    });
}

function groupAndCount(arr, key) {
  const count = {};
  arr.forEach(item => {
    const k = item[key]?.trim() || "Unknown";
    count[k] = (count[k] || 0) + 1;
  });
  return Object.entries(count).sort((a, b) => {
    if (a[0] === "Disposed / pending with HQ") return 1;
    if (b[0] === "Disposed / pending with HQ") return -1;
    return b[1] - a[1];
  });
}

function updateReportDate() {
  const dates = data.map(d => d["Report Date"]).filter(Boolean);
  const maxDate = dates.sort().reverse()[0];
  const reportDateEl = document.getElementById('report-date');
  reportDateEl.innerHTML = `<i class="fas fa-calendar-alt"></i><span>Report as on ${maxDate}</span>`;

  const pendingCount = data.filter(d => d["Pending With"] && d["Pending With"].trim() !== "Disposed / pending with HQ").length;
  document.getElementById('total-pending-zone').textContent = `Total Pending: ${pendingCount}`;
}

function renderBreadcrumb() {
  const container = document.getElementById('breadcrumb-container');
  if (!currentNavigation.pendingWith) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<ul class="breadcrumb">';
  html += '<li class="breadcrumb-item"><a onclick="resetNavigation()">Dashboard</a></li>';
  
  if (currentNavigation.pendingWith) {
    html += `<li class="breadcrumb-item">${currentNavigation.pendingWith}</li>`;
  }
  
  if (currentNavigation.policeStation) {
    html += `<li class="breadcrumb-item">${currentNavigation.policeStation}</li>`;
  }
  
  html += '</ul>';
  container.innerHTML = html;
}

function resetNavigation() {
  currentNavigation = {
    pendingWith: null,
    policeStation: null
  };
  
  renderBreadcrumb();
  renderCards();
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';

  const match = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (match) {
    let [_, dd, mm, yyyy] = match;
    if (yyyy.length === 2) {
      yyyy = parseInt(yyyy) > 50 ? '19' + yyyy : '20' + yyyy;
    }
    return `${dd.padStart(2, '0')}/${mm.padStart(2, '0')}/${yyyy}`;
  }

  try {
    const dateObj = new Date(dateString);
    if (isNaN(dateObj)) return dateString;
    return dateObj.toLocaleDateString('en-GB');
  } catch (e) {
    return dateString;
  }
}

function renderCards() {
  const cardsContainer = document.getElementById('card-sections-container');
  cardsContainer.innerHTML = '<div id="pending-with-cards" class="card-container"></div>';

  const container = document.getElementById('pending-with-cards');
  const groups = groupAndCount(data, 'Pending With');
  const pendingOnly = data.filter(d => d["Pending With"]?.trim() !== "Disposed / pending with HQ");
  const total = pendingOnly.length;

  if (groups.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>No grievances found</p>
      </div>
    `;
    return;
  }

  groups.forEach(([key, count]) => {
    const keyId = btoa(key).replace(/=/g, '');
    const cardGroupDiv = document.createElement('div');
    cardGroupDiv.className = 'card-expansion-group';
    cardGroupDiv.id = `group-${keyId}`;

    const percentage = key === 'Disposed / pending with HQ' ? null : ((count / total) * 100).toFixed(1);

    const card = document.createElement('div');
    card.className = key === 'Disposed / pending with HQ' ? 'card completed' : 'card';
    card.innerHTML = `
      <h3>${key}</h3>
      <div class="card-stats">
        <p>${count}</p>
        <span class="count-label">
          grievances${percentage !== null ? ` (${percentage}%)` : ''}
        </span>
      </div>
      <div class="toggle-indicator"><i class="fas fa-chevron-down"></i></div>
    `;

    card.onclick = function () {
      const isActive = this.classList.contains('active');
      this.classList.toggle('active');

      const tableDiv = document.getElementById(`table-${keyId}`);
      if (isActive) {
        tableDiv.innerHTML = '';
      } else {
        expandPoliceStationTable(key, `table-${keyId}`);
      }
    };

    cardGroupDiv.appendChild(card);

    const tableContainer = document.createElement('div');
    tableContainer.id = `table-${keyId}`;
    cardGroupDiv.appendChild(tableContainer);

    container.appendChild(cardGroupDiv);
  });
}

function expandPoliceStationTable(pendingWith, containerId) {
  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = null;
  renderBreadcrumb();

  const tableContainer = document.getElementById(`table-${btoa(pendingWith).replace(/=/g, '')}`);
  tableContainer.innerHTML = '';

  const filtered = data.filter(d => d["Pending With"] === pendingWith);
  const psCounts = groupAndCount(filtered, 'Police Station');

  let html = `<div class="table-container">
    <h3><i class="fas fa-building"></i>${pendingWith} - Police Station-wise Count</h3>
    <table>
      <thead>
        <tr>
          <th>Police Station</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>`;

  psCounts.forEach(([ps, count], index) => {
    const rowId = `ps-${btoa(pendingWith + '||' + ps).replace(/=/g, '')}`;
    html += `
      <tr class="clickable" onclick="toggleComplaintList('${pendingWith}', '${ps.replace(/'/g, "\\'")}', '${rowId}')">
        <td>${ps}</td>
        <td><strong>${count}</strong></td>
      </tr>
      <tr id="${rowId}" style="display:none;"><td colspan="2"><div></div></td></tr>
    `;
  });

  html += '</tbody></table></div>';
  tableContainer.innerHTML = html;
}

function toggleComplaintList(pendingWith, policeStation, rowId) {
  const containerRow = document.getElementById(rowId);
  const innerDiv = containerRow.querySelector('div');

  const isVisible = containerRow.style.display !== 'none';

  if (isVisible) {
    containerRow.style.display = 'none';
    innerDiv.innerHTML = '';
    return;
  }

  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = policeStation;
  renderBreadcrumb();

  const filtered = data.filter(d => d["Pending With"] === pendingWith && d["Police Station"] === policeStation);
  const sorted = filtered.sort((a, b) => new Date(a["Received Date & Time"]) - new Date(b["Received Date & Time"]));

  let html = `<div style="padding: 10px 0;"><table style="width:100%;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Received Date</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>`;

  sorted.forEach(item => {
    const receivedDate = formatDate(item["Received Date & Time"]);
    const description = item["Grievance Description"]?.replace(/`/g, "'") || 'No description available';
    const phoneNumber = item["Phone"] || '';

    html += `<tr>
      <td>${item["Name"] || 'N/A'}</td>
      <td>${receivedDate}</td>
      <td><span class="details-icon" onclick="showModal(
  '${description.replace(/'/g, "\\'")}',
  '${phoneNumber.replace(/'/g, "\\'")}',
  '${item["Grievance Since"] || ''}',
  '${item["Pending With"] || ''}',
  '${(item["Grievance Category"] || '').replace(/'/g, "\\'")}'
)">

        <i class="fas fa-file-alt"></i> View
      </span></td>
    </tr>`;
  });

  html += '</tbody></table></div>';

  innerDiv.innerHTML = html;
  containerRow.style.display = '';
}

function expandGrievanceList(pendingWith, policeStation, containerId) {
  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = policeStation;
  renderBreadcrumb();
  
  // Get the container for this specific grievance list
  const containerElement = document.getElementById(containerId);
  const tableContainer = containerElement.querySelector(`#table-${pendingWith.replace(/\s+/g, '-').toLowerCase()}`);
  
  // Check if we're showing the same police station - if so, we can toggle back to police station list
  const currentTable = tableContainer.querySelector('.table-container h3');
  if (currentTable && currentTable.textContent.includes(policeStation)) {
    // Go back to police station list
    expandPoliceStationTable(pendingWith, containerId);
    return;
  }
  
  const filtered = data.filter(d => d["Pending With"] === pendingWith && d["Police Station"] === policeStation);
  const sorted = filtered.sort((a, b) => new Date(a["Received Date & Time"]) - new Date(b["Received Date & Time"]));
  
  let html = `<div class="table-container">
    <h3><i class="fas fa-clipboard-list"></i> ${pendingWith} - ${policeStation} - Complaints</h3>`;
  
  if (sorted.length === 0) {
    html += `<div class="empty-state">
      <i class="fas fa-search"></i>
      <p>No complaints found</p>
    </div>`;
  } else {
    html += `<table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Received Date</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>`;
      
    sorted.forEach(item => {
      // Format date for better readability - only show the date part, not time
      const receivedDate = formatDate(item["Received Date & Time"]);
      
      // Escape any backticks in description and phone number
      const description = item["Grievance Description"]?.replace(/`/g, "'") || 'No description available';
      const phoneNumber = item["Phone"] || '';
      
      html += `<tr>
        <td>${item["Name"] || 'N/A'}</td>
        <td>${receivedDate}</td>
        <td><span class="details-icon" onclick="showModal('${description.replace(/'/g, "\\'")}', '${phoneNumber.replace(/'/g, "\\'")}')">
          <i class="fas fa-file-alt"></i> View
        </span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  tableContainer.innerHTML = html;
}

function showModal(text, phoneNumber, liveSinceDays, pendingWith, category) {
  // Clear old content
  const modalText = document.getElementById('modal-text');
  modalText.innerHTML = '';

  // Insert category (if any)
  if (category) {
    const modalCategory = document.createElement('div');
    modalCategory.style.fontSize = '0.85rem';
    modalCategory.style.fontStyle = 'italic';
    modalCategory.style.color = '#666';
    modalCategory.textContent = `Category: ${category}`;
    modalText.appendChild(modalCategory);
  }

  // Insert description
  const descDiv = document.createElement('div');
  descDiv.style.marginTop = '5px';
  descDiv.innerText = text;
  modalText.appendChild(descDiv);

  // Live since days
  const liveSinceDiv = document.getElementById('modal-live-since');
  if (liveSinceDays && pendingWith !== "Disposed / pending with HQ") {
    liveSinceDiv.innerText = `Grievance LIVE since ${liveSinceDays} Days`;
    liveSinceDiv.style.display = 'block';
  } else {
    liveSinceDiv.style.display = 'none';
  }

  // Phone
  const phoneContainer = document.getElementById('modal-phone');
  if (phoneNumber) {
    phoneContainer.innerHTML = `
      <a href="tel:${phoneNumber}" class="phone-icon">
        <i class="fas fa-phone"></i>
      </a>
      <span class="phone-number">${phoneNumber}</span>
    `;
    phoneContainer.style.display = 'flex';
  } else {
    phoneContainer.style.display = 'none';
  }

  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}



function closeModal() {
  document.getElementById('modal').style.display = 'none';
  
  // Re-enable scroll on body
  document.body.style.overflow = 'auto';
}

// Initialize
let originalData = [];

fetchCSV(sheetURL).then(res => {
  if (res) {
    data = res;
    originalData = [...res];
    updateReportDate();
    setupGrievanceAgeSlider();
    renderCards();
  }
});
function setupGrievanceAgeSlider() {
  const slider = document.getElementById('monthSlider');
  const display = document.getElementById('selectedMonth');

  // Convert all "Grievance Since" values to numbers (days)
  const daysArray = originalData.map(d => parseInt(d["Grievance Since"], 10)).filter(d => !isNaN(d));
  const maxDays = Math.max(...daysArray);
  const maxMonths = Math.ceil(maxDays / 30);

  // Set slider attributes
  slider.max = maxMonths;
  slider.value = 0;

  display.textContent = 'All grievances';

  slider.addEventListener('input', () => {
    const selectedMonths = parseInt(slider.value, 10);
    display.textContent = selectedMonths === 0
      ? 'All grievances'
      : formatMonthYear(selectedMonths);
    filterByGrievanceAge(selectedMonths);
  });
}

function filterByGrievanceAge(minMonths) {
  const filtered = originalData.filter(d => {
    const days = parseInt(d["Grievance Since"], 10);
    return !isNaN(days) && days >= (minMonths * 30);
  });

  data = filtered;
    updateReportDate(); // ← Add this line
  renderCards();
}

function formatMonthYear(months) {
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  let text = 'Older than ';
  if (years > 0) text += `${years} year${years > 1 ? 's' : ''} `;
  if (remainingMonths > 0) text += `${remainingMonths} month${remainingMonths > 1 ? 's' : ''}`;
  return text.trim();
}


// Add event listener to close modal when clicking outside
document.getElementById('modal').addEventListener('click', function(event) {
  if (event.target === this) {
    closeModal();
  }
});

// Add escape key listener for modal
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && document.getElementById('modal').style.display === 'flex') {
    closeModal();
  }
});



</script>

</body>
</html>
