<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CMO Grievances</title>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --primary-light: #42a5f5;
      --primary-dark: #0d47a1;
      --secondary: #ff5722;
      --accent: #ffc107;
      --text-primary: #212121;
      --text-secondary: #757575;
      --bg-light: #fafafa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --surface: #ffffff;
      --divider: #e0e0e0;
      --shadow: rgba(0,0,0,0.1);
      --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --elevation-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      --elevation-4: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Header - Android Style */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--primary);
      color: white;
      z-index: 1000;
      box-shadow: var(--elevation-2);
      padding: 12px 0;
    }
    
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 0 16px;
    }
    
    h1 {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
      letter-spacing: 0.0125em;
    }
    
    #report-date {
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.87;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #report-date i {
      font-size: 0.7rem;
    }
    
    #total-pending-zone {
      font-size: 0.8rem;
      font-weight: 500;
      background: rgba(255,255,255,0.15);
      padding: 4px 12px;
      border-radius: 12px;
      margin-top: 2px;
    }
    
    /* Main content with top padding for fixed header */
    .main-content {
      padding-top: 120px;
      min-height: 100vh;
    }
    
    /* Breadcrumb - Material Design */
    .breadcrumb {
      display: flex;
      padding: 8px 0;
      margin: 0;
      list-style: none;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.875rem;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      color: var(--text-secondary);
    }
    
    .breadcrumb-item a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .breadcrumb-item a:hover {
      background-color: rgba(25, 118, 210, 0.08);
    }
    
    .breadcrumb-item:not(:first-child)::before {
      content: "â€º";
      padding: 0 4px;
      color: var(--text-secondary);
      font-weight: 300;
    }
    
    /* Time Filter Buttons */
    #time-filter-buttons {
      background: var(--surface);
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      box-shadow: var(--elevation-1);
      display: flex;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
      gap: 8px; /* Gap between buttons */
      justify-content: center; /* Center buttons horizontally */
    }

    #time-filter-buttons button {
      background-color: #e0e0e0; /* Simple gray for inactive */
      color: var(--text-primary); /* Dark text for gray buttons */
      border: none;
      border-radius: 20px; /* Pill shape */
      padding: 8px 16px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
      box-shadow: var(--elevation-1);
    }

    #time-filter-buttons button.active {
      background-color: var(--primary); /* Darker blue for active state */
      color: white; /* White text for active button */
      box-shadow: var(--elevation-2);
      transform: translateY(-1px); /* Slight lift */
    }

    /* Cards - Material Design (for original accordion cards) */
    .card-container {
      display: flex; /* Changed from column to flex to support wrapping for district cards */
      flex-wrap: wrap; /* Allow wrapping */
      gap: 8px;
      margin-bottom: 16px;
    }

    /* Styles for district cards specific container */
    #district-summary-cards {
        display: flex; 
        justify-content: flex-start;
        margin-bottom: 16px; /* Space below district cards */
    }
    
    .card {
      background: var(--surface);
      border-radius: 8px;
      box-shadow: var(--elevation-1);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      border: none;
      flex: 1; /* Allow cards to grow and shrink */
      min-width: 150px; /* Minimum width for cards */
      max-width: calc(33.33% - 8px); /* Max width for 3 cards per row, adjusting for gap */
      box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }

    /* Specific styling for the 'All Districts' card */
    .card.all-districts {
        background-color: var(--primary-light);
        color: white;
        min-width: 180px;
        max-width: 250px; /* Make it a bit wider */
    }
    .card.all-districts h3 {
        color: white;
    }
    .card.all-districts .stat-line p, .card.all-districts .stat-line span { /* Target new stat-line elements */
        color: rgba(255,255,255,0.8);
    }
    .card.all-districts .stat-line p { /* Adjust font size for All Districts card */
        font-size: 1.8rem;
    }
    
    .card:hover {
      box-shadow: var(--elevation-2);
    }
    
    .card:active {
      transform: scale(0.98);
    }
    
    .card.completed {
      border-left: 4px solid var(--success);
    }

    /* New styles for stat lines within district cards */
    .stat-line {
        display: flex; /* Use flexbox to align number and text horizontally */
        align-items: baseline; /* Align them on the same baseline */
        gap: 4px; /* Small gap between number and text */
        margin-top: 5px; /* Add some space between stat lines */
    }

    .stat-line:first-of-type {
        margin-top: 0; /* No top margin for the first stat line */
    }

    .stat-line p {
        margin: 0; /* Remove default paragraph margins */
        padding: 0;
        line-height: 1; /* Ensure tight vertical spacing */
        font-size: 1.5rem; /* Reapply original font size for number */
        font-weight: 400; /* Reapply original font weight */
        color: var(--primary); /* Reapply original color */
    }

    .stat-line span {
        font-size: 0.875rem; /* Reapply original font size for label */
        color: var(--text-secondary); /* Reapply original color */
        font-weight: 400;
    }

    /* Special style for pending count in district cards */
    .stat-line.pending-count p {
        color: var(--danger); /* Red color for pending count */
    }

    /* Special style for disposed count in district cards */
    .stat-line.disposed-count p {
        color: var(--success);
    }
    
    /* Tables - Material Design */
    .table-container {
      background: var(--surface);
      border-radius: 8px;
      margin: 8px 0 16px 0;
      box-shadow: var(--elevation-1);
      overflow: hidden;
    }
    
    .table-container h3 {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      background: rgba(25, 118, 210, 0.04);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: var(--primary-dark); /* Changed header background */
      color: white; /* Changed header text color */
      font-weight: 500;
      text-align: left;
      padding: 12px 16px; /* Made more compact */
      font-size: 0.8rem; /* Made more compact */
      border-bottom: 1px solid var(--divider);
    }
    
    td {
      padding: 12px 16px; /* Made more compact */
      border-bottom: 1px solid var(--divider);
      font-size: 0.8rem; /* Made more compact */
      color: var(--text-primary);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr.clickable:hover td {
      background: rgba(25, 118, 210, 0.1); /* Changed hover background for contrast */
    }
    
    tr.clickable {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    /* Action buttons - Material Design */
    .details-icon {
      cursor: pointer;
      color: var(--primary);
      font-weight: 500;
      background: rgba(25, 118, 210, 0.08);
      padding: 8px 12px;
      border-radius: 20px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.875rem;
      border: none;
      min-height: 36px;
    }
    
    .details-icon:hover {
      background: rgba(25, 118, 210, 0.12);
    }
    
    .details-icon:active {
      transform: scale(0.95);
    }
    
    /* Modal - Material Design */
    /* Styling for the original detail modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 4500; /* Increased to be above grievance list modal */
      padding: 16px;
    }

    /* Styling for the original grievance list modal */
    #grievance-list-modal {
      z-index: 4000; /* Lower than detail modal, but above content */
    }

    #police-station-list-modal {
      z-index: 3500; /* Between detail and all grievances modal */
    }

    /* New remarks modal */
    #remarks-modal {
      z-index: 4600; /* Higher than detail modal */
    }
    
    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 500px; /* Reverted to original max-width for detail modal */
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--elevation-4);
      max-height: 80vh;
      overflow-y: auto;
    }

    #grievance-list-modal .modal-content, #police-station-list-modal .modal-content {
      max-width: 700px; /* Specific width for list modals */
    }

    #remarks-modal .modal-content {
      max-width: 400px; /* Smaller width for remarks modal */
    }
    
    .modal-header {
      padding: 24px 24px 8px 24px;
      position: relative;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--text-primary);
      padding-right: 40px;
    }
    
    .modal-close {
      position: absolute;
      right: 16px;
      top: 16px;
      cursor: pointer;
      color: var(--text-secondary);
      background: transparent;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 20px;
      transition: all 0.2s;
      border: none;
    }
    
    .modal-close:hover {
      background: rgba(0,0,0,0.04);
    }
    
    .modal-body {
      padding: 0 24px 24px 24px;
    }

    #grievance-list-modal .modal-body, #police-station-list-modal .modal-body { /* Specific padding for list modal */
      padding:0 16px 16px;
    }
    
    #modal-live-since {
      color: var(--danger);
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 16px;
      padding: 8px 12px;
      background: rgba(244, 67, 54, 0.08);
      border-radius: 4px;
      border-left: 4px solid var(--danger);
    }
    
    #modal-text {
      line-height: 1.6;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    
    .modal-category {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    #modal-phone {
      display: flex;
      align-items: center;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
      flex-wrap: wrap; /* Allow wrapping of phone and remarks button */
      gap: 10px; /* Gap between phone and button */
    }
    
    .phone-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--success);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      box-shadow: var(--elevation-1);
    }
    
    .phone-icon:hover {
      background: #388e3c;
      transform: scale(1.05);
    }
    
    .phone-number {
      font-size: 1rem;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Loading state */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      width: 100%; /* Ensure loading spinner is centered in its container */
    }
    
    .loading::after {
      content: "";
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
      width: 100%; /* Ensure empty state message is centered */
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--divider);
      margin-bottom: 16px;
    }
    
    /* Styles for the new table structure for main categories */
    .category-header-row td {
        padding: 12px 16px; /* Consistent with new td padding */
        font-weight: 500;
        font-size: 0.8rem; /* Consistent with new td font size */
        color: var(--text-primary);
        background: var(--surface);
        border-bottom: 1px solid var(--divider);
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .category-header-row:hover td {
        background: rgba(25, 118, 210, 0.1); /* Changed hover background for contrast */
    }

    /* Styles for the nested table content inside the expandable row */
    /* These styles are no longer directly applicable to main categories, but kept for nested police station tables */
    tr[id^="ps-"] td {
      padding: 0 !important;
    }
    
    tr[id^="ps-"] td > div {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
      background: rgba(25, 118, 210, 0.02);
    }
    
    tr[id^="ps-"] td > div table {
      margin: 0;
    }
    
    tr[id^="ps-"] td > div table th {
      background: var(--primary-dark); /* Changed header background */
      color: white; /* Changed header text color */
      font-size: 0.8rem;
      padding: 12px 16px;
    }
    
    tr[id^="ps-"] td > div table td {
      padding: 12px 16px;
      font-size: 0.8rem;
    }
    
    tr[id^="ps-"] td > div .details-icon {
      background: rgba(255, 87, 34, 0.08);
      color: var(--secondary);
    }
    
    tr[id^="ps-"] td > div .details-icon:hover {
      background: rgba(255, 87, 34, 0.12);
    }

    /* New Loading Modal Styles */
    #loading-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9); /* Semi-transparent white overlay */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 5000; /* Highest z-index for loading modal */
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 500;
        gap: 20px;
    }

    #loading-modal .loading::after { /* Use the existing spinner style */
        border: 4px solid var(--divider);
        border-top: 4px solid var(--primary);
        width: 50px;
        height: 50px;
    }

    #loading-message {
        margin-top: 10px;
        font-size: 1.1em;
        color: var(--text-secondary);
    }
    
    /* Custom float button (from original cmo1.html) */
    #grievance-float-btn {
      position: fixed;
      top: 30px;
      right: 20px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      font-size: 1.2rem;
      z-index: 1100;
      box-shadow: var(--elevation-2);
      animation: pulse 2s infinite;
      cursor: pointer;
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.5); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      .main-content {
        padding-top: 100px;
      }
      
      .header-content {
        padding: 0 16px;
      }
      
      h1 {
        font-size: 1.125rem;
      }
      
      #total-pending-zone {
        font-size: 0.75rem;
        padding: 3px 10px;
      }
      
      /* District cards responsive behavior */
      #district-summary-cards {
        flex-direction: column; /* Stack cards vertically on small screens */
        align-items: center; /* Center stacked cards */
      }
      .card {
        min-width: unset; /* Remove minimum width */
        max-width: 100%; /* Allow cards to take full width */
        flex: 1 1 auto; /* Allow growth and shrink for full width */
        width: 100%; /* Ensure they take full width when stacked */
      }
      .card h3 {
        font-size: 1rem; /* Smaller font for title */
      }
      .stat-line p {
        font-size: 1.3rem; /* Smaller font for numbers */
      }
      .stat-line span {
        font-size: 0.8rem; /* Smaller font for labels */
      }
      .card.all-districts {
        min-width: unset;
        max-width: 100%;
      }

      /* Time filter buttons responsive behavior */
      #time-filter-buttons {
        justify-content: center; /* Center buttons when they wrap */
        gap: 6px; /* Reduce gap */
        padding: 10px;
      }
      #time-filter-buttons button {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      /* Original cmo1.html overrides */
      .slider-flex { /* This was removed but the style remained */
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      #selectedMonth { /* This was removed but the style remained */
        text-align: left;
        min-width: auto;
      }
      
      .card { /* This targets original main cards */
        padding: 12px 16px;
      }
      
      .card h3 { /* This targets original main cards */
        font-size: 0.9rem;
        margin-right: 20px;
      }
      
      .card p { /* This targets original main cards */
        font-size: 1.25rem;
      }
      
      .count-label { /* This targets original main cards */
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 12px 16px;
        font-size: 0.8rem;
      }
      
      .table-container h3 {
        padding: 12px 16px;
        font-size: 0.9rem;
      }
      
      .modal {
        padding: 8px;
      }
      
      .modal-header {
        padding: 16px 16px 8px 16px;
      }
      
      .modal-header h3 {
        font-size: 1.125rem;
        padding-right: 32px;
      }
      
      .modal-close {
        right: 8px;
        top: 8px;
        width: 36px;
        height: 36px;
      }
      
      .modal-body {
        padding: 0 16px 16px 16px;
      }
      
      .details-icon {
        padding: 6px 12px;
        font-size: 0.8rem;
        min-height: 32px;
      }
    }
    
    /* Nested table styling for complaint lists (for police station tables inside modals) */
    /* This section is still relevant as police station tables are nested within the new modal structure */
    tr[id^="ps-"] td {
      padding: 0 !important; /* Reset padding from parent tr */
    }
    
    tr[id^="ps-"] td > div {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
      background: rgba(25, 118, 210, 0.02);
    }
    
    tr[id^="ps-"] td > div table {
      margin: 0;
    }
    
    tr[id^="ps-"] td > div table th {
      background: var(--primary-dark); /* Changed header background */
      color: white; /* Changed header text color */
      font-size: 0.8rem;
      padding: 12px 16px;
    }
    
    tr[id^="ps-"] td > div table td {
      padding: 12px 16px;
      font-size: 0.8rem;
    }
    
    tr[id^="ps-"] td > div .details-icon {
      background: rgba(255, 87, 34, 0.08);
      color: var(--secondary);
    }
    
    tr[id^="ps-"] td > div .details-icon:hover {
      background: rgba(255, 87, 34, 0.12);
    }

    /* Styles for the new modal tabs */
    .modal-tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px; /* Adjusted padding to match modal body */
      background-color: var(--bg-light); /* Light background for tabs area */
      border-bottom: 1px solid var(--divider);
      justify-content: center; /* Center tabs */
    }

    .modal-tab-button {
      background-color: #e0e0e0;
      color: var(--text-primary);
      border: none;
      border-radius: 20px;
      padding: 6px 12px; /* Made tabs a bit more compact */
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
      box-shadow: var(--elevation-1);
    }

    .modal-tab-button.active {
      background-color: var(--primary);
      color: white;
      box-shadow: var(--elevation-2);
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <h1>CMO Grievances</h1>
    <div id="report-date">
      <i class="fas fa-calendar-alt"></i>
      <span>Loading latest report...</span>
    </div>
    <div id="total-pending-zone"></div>
  </div>
</header>

<div class="main-content">
  <div class="container">
    <div id="breadcrumb-container"></div>
    
    <!-- New section for District-wise summary cards -->
    <div id="district-summary-cards" class="card-container">
      <!-- District cards will be dynamically generated here -->
      <div class="loading"></div>
    </div>

    <!-- Replaced slider with time filter buttons -->
    <div id="time-filter-buttons">
      <!-- Buttons will be dynamically generated here -->
    </div>

    <div id="card-sections-container">
      <!-- The pending-with-cards div will now contain a table directly -->
      <div id="pending-with-cards" class="table-container"> 
        <div class="loading"></div>
      </div>
    </div>
  </div>
</div>

<!-- Original Detail Modal -->
<div class="modal" id="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Grievance Details</h3>
      <p id="name-details"></p> <!-- Your added p tag -->
      <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="modal-live-since" style="display:none;"></div>
      <div id="modal-text"></div>
      <div id="modal-phone" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- New: Police Station List Modal (replaces accordion expansion for main categories) -->
<div class="modal" id="police-station-list-modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="police-station-list-modal-title">Police Station List</h3>
      <button class="modal-close" onclick="closePoliceStationListModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div style="overflow-x:auto;">
        <div id="police-station-table-content"></div> <!-- Content populated by renderPoliceStationTable -->
      </div>
    </div>
  </div>
</div>


<!-- Original Grievance List Modal (now also used for Police Station specific lists) -->
<div class="modal" id="grievance-list-modal" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h3 id="grievance-list-modal-title">All Grievances</h3>
      <button class="modal-close" onclick="closeGrievanceListModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="district-tabs-container" class="modal-tabs-container">
      <!-- District tabs will be dynamically generated here -->
    </div>
    <div class="modal-body" style="padding:0 16px 16px;">
      <div style="overflow-x:auto;">
        <table id="grievance-table" style="width:100%;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Pending With</th>
              <th>Pending Since</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- New Remarks Modal Structure -->
<div class="modal" id="remarks-modal" style="display:none;">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
      <h3>Last Update Remarks</h3>
      <button class="modal-close" onclick="closeRemarksModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p id="remarks-content"></p>
    </div>
  </div>
</div>

<!-- Loading Modal Structure (New) -->
<div id="loading-modal" style="display:none;">
    <div class="loading"></div>
    <div id="loading-message">Loading...</div>
</div>

<!-- Float button from original cmo1.html -->
<button id="grievance-float-btn" onclick="openComprehensiveGrievanceListModal()">
  <i class="fas fa-list-ul"></i>
</button>

<!-- Include PapaParse library -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7GVh5HflVhouhVfFOEN2RuA1kCBedmD4Q0CJP02K61DAtWuo3P8XIS8CO7ocZQuJ20uCJBa9qsgZ6/pub?gid=1066071765&single=true&output=csv";

// Constants for retry logic
const MAX_RETRIES = 3;
const INITIAL_RETRY_DELAY_MS = 1000; // 1 second

let originalData = []; // Stores the full, unfiltered data from CSV
let data = []; // Stores the currently filtered data (by age and district)

let selectedDistrict = null; // New state variable to hold the currently selected district
let selectedMinMonths = 0; // New state variable for the selected minimum months filter

let currentNavigation = {
  district: null, // New: track selected district in navigation
  pendingWith: null, // Track selected pendingWith in navigation
  policeStation: null // Track selected policeStation in navigation
};

// --- Loading Modal Functions (New) ---
function showLoadingModal(message) {
    const loadingModal = document.getElementById('loading-modal');
    const loadingMessage = document.getElementById('loading-message');
    if (loadingModal && loadingMessage) {
        loadingMessage.textContent = message;
        loadingModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function updateLoadingMessage(message) {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
        loadingMessage.textContent = message;
    }
}

function hideLoadingModal() {
    const loadingModal = document.getElementById('loading-modal');
    if (loadingModal) {
        loadingModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

/**
 * Fetches CSV data from the provided URL with retry logic (exponential backoff).
 * @param {string} url - The URL of the CSV file.
 * @returns {Promise<Array|null>} A promise that resolves with the parsed CSV data or null if fetching fails.
 */
async function fetchCSV(url) {
  showLoadingModal('Loading data from source...');
  document.getElementById('district-summary-cards').innerHTML = '<div class="loading"></div>'; // Initial loading state for new sections
  document.getElementById('pending-with-cards').innerHTML = '<div class="loading"></div>'; // Ensure original loading state is shown

  for (let i = 0; i < MAX_RETRIES; i++) {
    try {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      const csvText = await res.text();
      updateLoadingMessage('Processing raw data...');
      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });
      return parsed.data; // Success, return data
    } catch (error) {
      console.error(`Attempt ${i + 1} failed to fetch CSV:`, error);
      if (i < MAX_RETRIES - 1) {
        const delay = INITIAL_RETRY_DELAY_MS * Math.pow(2, i);
        updateLoadingMessage(`Retrying in ${delay / 1000} seconds...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      } else {
        // Last attempt failed, show error message
        const errorMessage = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <p>Failed to load data after multiple attempts. Please check your internet connection or the Google Sheet URL and its public access settings.</p>
          </div>
        `;
        document.getElementById('district-summary-cards').innerHTML = errorMessage;
        document.getElementById('pending-with-cards').innerHTML = errorMessage; // Update original error location
        hideLoadingModal();
        return null; // Return null to indicate failure
      }
    }
  }
  return null; // Should not be reached, but good practice
}

function groupAndCount(arr, key) {
  const count = {};
  arr.forEach(item => {
    const k = item[key]?.trim() || "Unknown";
    count[k] = (count[k] || 0) + 1;
  });
  return Object.entries(count).sort((a, b) => {
    // This sorting logic prioritizes "Disposed / pending with HQ" to the end if it's included.
    // However, with the new filter in renderCards, it won't be present here for the main cards.
    if (a[0] === "Disposed / pending with HQ") return 1;
    if (b[0] === "Disposed / pending with HQ") return -1;
    return b[1] - a[1];
  });
}

// New: group and count by district
function groupAndCountByDistrict(arr) {
    const districtList = ["Uttar Dinajpur", "Malda", "Dakshin Dinajpur"];
    const districtSummary = {};

    districtList.forEach(districtName => {
        districtSummary[districtName] = { pending: 0, disposed: 0, total: 0 };
    });

    arr.forEach(item => {
        const district = item["District"]?.trim();
        if (districtList.includes(district)) {
            if (!districtSummary[district]) {
                districtSummary[district] = { pending: 0, disposed: 0, total: 0 };
            }
            if (item["Pending With"] && item["Pending With"].trim() === "Disposed / pending with HQ") {
                districtSummary[district].disposed++;
            } else {
                districtSummary[district].pending++;
            }
            districtSummary[district].total++;
        }
    });
    return Object.entries(districtSummary).map(([district, counts]) => ({
        district,
        ...counts
    })).sort((a, b) => {
        const aIndex = districtList.indexOf(a.district);
        const bIndex = districtList.indexOf(b.district);

        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
        if (aIndex !== -1) return -1;
        if (bIndex !== -1) return 1;
        return b.total - a.total;
    });
}

function updateReportDate() {
  const dates = data.map(d => d["Report Date"]).filter(Boolean);
  const maxDate = dates.length > 0 ? dates.sort().reverse()[0] : 'N/A'; // Handle empty data
  const reportDateEl = document.getElementById('report-date');
  reportDateEl.innerHTML = `<i class="fas fa-calendar-alt"></i><span>Report as on ${maxDate}</span>`;

  // Update total pending/disposed for header (from cmo.html)
  const pendingCount = data.filter(d => d["Pending With"] && d["Pending With"].trim() !== "Disposed / pending with HQ").length;
  const disposedCount = data.filter(d => d["Pending With"] && d["Pending With"].trim() === "Disposed / pending with HQ").length;
  document.getElementById('total-pending-zone').textContent = `Total Pending: ${pendingCount} / Total Disposed: ${disposedCount}`;
}

function renderBreadcrumb() {
  const container = document.getElementById('breadcrumb-container');
  // Include district in breadcrumb logic
  if (!currentNavigation.district && !currentNavigation.pendingWith && !currentNavigation.policeStation) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<ul class="breadcrumb">';
  html += '<li class="breadcrumb-item"><a onclick="resetNavigation()">Dashboard</a></li>';
  
  if (currentNavigation.district) {
    // Escape single quotes for the string if it contains any
    html += `<li class="breadcrumb-item"><a onclick="selectDistrictAndResetChildren(${JSON.stringify(currentNavigation.district).replace(/"/g, '&quot;')})">${currentNavigation.district}</a></li>`;
  }

  if (currentNavigation.pendingWith) {
    html += `<li class="breadcrumb-item"><a onclick="openPoliceStationListModal(${JSON.stringify(currentNavigation.pendingWith).replace(/"/g, '&quot;')})">${currentNavigation.pendingWith}</a></li>`;
  }
  
  if (currentNavigation.policeStation) {
    html += `<li class="breadcrumb-item">${currentNavigation.policeStation}</li>`;
  }
  
  html += '</ul>';
  container.innerHTML = html;
}

function resetNavigation() {
  selectedDistrict = null; // Reset selected district
  currentNavigation = {
    pendingWith: null,
    policeStation: null,
    district: null // Reset district navigation
  };
  filterDataAndRender(); // Rerender all based on new filters
}

// New: select district and reset children (from cmo.html)
function selectDistrictAndResetChildren(district) {
    selectedDistrict = district;
    currentNavigation.district = district;
    currentNavigation.pendingWith = null; // Reset pendingWith
    currentNavigation.policeStation = null; // Reset policeStation
    filterDataAndRender(); // Re-render everything with new district filter
}


function formatDate(dateString) {
  if (!dateString) return 'N/A';

  const match = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (match) {
    let [_, dd, mm, yyyy] = match;
    if (yyyy.length === 2) {
      yyyy = parseInt(yyyy) > 50 ? '19' + yyyy : '20' + yyyy;
    }
    return `${dd.padStart(2, '0')}/${mm.padStart(2, '0')}/${yyyy}`;
  }

  try {
    const dateObj = new Date(dateString);
    if (isNaN(dateObj)) return dateString;
    return dateObj.toLocaleDateString('en-GB');
  } catch (e) {
    return dateString;
  }
}

// renderCards function now renders categories in a table format
function renderCards() {
  const cardsContainer = document.getElementById('pending-with-cards');
  cardsContainer.innerHTML = ''; // Clear content

  // Filter out "Disposed / pending with HQ" explicitly for the main categories
  const pendingOnlyData = data.filter(d => d["Pending With"]?.trim() !== "Disposed / pending with HQ");
  const groups = groupAndCount(pendingOnlyData, 'Pending With');
  
  const totalPendingForPercentage = pendingOnlyData.length;

  if (groups.length === 0) {
    cardsContainer.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>No pending grievances found for the current selection (excluding 'Disposed / pending with HQ').</p>
      </div>
    `;
    return;
  }

  // Create the main table structure inside a div that uses table-container styling
  const mainTableWrapper = document.createElement('div');
  mainTableWrapper.className = 'table-container'; // Apply existing table container styling

  const table = document.createElement('table');
  table.id = 'main-pending-with-table'; // Give the main table an ID

  table.innerHTML = `
    <thead>
      <tr>
        <th>Pending With Category</th>
        <th>Count</th>
      </tr>
    </thead>
    <tbody id="pending-with-table-body">
    </tbody>
  `;
  
  mainTableWrapper.appendChild(table);
  cardsContainer.appendChild(mainTableWrapper); // Append the wrapper to the cardsContainer

  const tbody = document.getElementById('pending-with-table-body');

  groups.forEach(([key, count]) => {
    const percentage = ((count / totalPendingForPercentage) * 100).toFixed(1);

    // Main row for the category
    const categoryRow = document.createElement('tr');
    categoryRow.className = 'clickable category-header-row'; // Add a class for specific styling

    categoryRow.innerHTML = `
      <td>${key}</td>
      <td><strong>${count}</strong> <span class="count-label">(${percentage}%)</span></td>
    `;
    
    // Attach click listener to the category row to open a modal
    categoryRow.onclick = function() {
      openPoliceStationListModal(key);
    };

    tbody.appendChild(categoryRow);
  });
}

/**
 * Opens a modal to display Police Station-wise counts for a given 'Pending With' category.
 * @param {string} pendingWithCategory - The category to display.
 */
function openPoliceStationListModal(pendingWithCategory) {
  currentNavigation.pendingWith = pendingWithCategory;
  currentNavigation.policeStation = null; // Reset policeStation when opening this modal
  renderBreadcrumb();

  const modalTitle = document.getElementById('police-station-list-modal-title');
  modalTitle.textContent = `${pendingWithCategory} - Police Station Wise Breakdown`;

  const policeStationTableContent = document.getElementById('police-station-table-content');
  // Pass the filtered data directly to renderPoliceStationTable
  const filteredDataForPS = data.filter(d => d["Pending With"] === pendingWithCategory);
  renderPoliceStationTable(filteredDataForPS, pendingWithCategory, policeStationTableContent);

  document.getElementById('police-station-list-modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

/**
 * Renders the Police Station-wise count table into a specified container.
 * This is called by openPoliceStationListModal.
 * @param {Array} dataToRender - The data already filtered by the parent category.
 * @param {string} pendingWithCategory - The parent category (for breadcrumb and filtering complaints).
 * @param {HTMLElement} containerElement - The DOM element where the table will be rendered.
 */
function renderPoliceStationTable(dataToRender, pendingWithCategory, containerElement) {
  containerElement.innerHTML = ''; // Clear content

  const psCounts = groupAndCount(dataToRender, 'Police Station');

  let html = `<div class="table-container">
    <h3><i class="fas fa-building"></i>Police Station-wise Count</h3>
    <table>
      <thead>
        <tr>
          <th>Police Station</th>
          <th>Count</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>`;

  if (psCounts.length === 0) {
      html += `<tr><td colspan="3"><div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>No Police Stations found for this category.</p>
      </div></td></tr>`;
  } else {
    psCounts.forEach(([ps, count]) => {
      html += `
        <tr class="clickable">
          <td>${ps}</td>
          <td><strong>${count}</strong></td>
          <td>
            <span class="details-icon" onclick="openGrievancesForPoliceStationModal(${JSON.stringify(pendingWithCategory).replace(/"/g, '&quot;')}, ${JSON.stringify(ps).replace(/"/g, '&quot;')})">
              <i class="fas fa-file-alt"></i> View Complaints
            </span>
          </td>
        </tr>
      `;
    });
  }

  html += '</tbody></table></div>';
  containerElement.innerHTML = html;
}

/**
 * Closes the Police Station List modal.
 */
function closePoliceStationListModal() {
  document.getElementById('police-station-list-modal').style.display = 'none';
  document.body.style.overflow = 'auto';
  currentNavigation.pendingWith = null; // Reset pendingWith on close
  currentNavigation.policeStation = null; // Also reset policeStation
  renderBreadcrumb();
}


/**
 * Opens the Grievance List modal, filtered by a specific Police Station and Pending With category.
 * @param {string} pendingWith - The 'Pending With' category.
 * @param {string} policeStation - The 'Police Station'.
 */
function openGrievancesForPoliceStationModal(pendingWith, policeStation) {
  currentNavigation.pendingWith = pendingWith; // Keep parent navigation context
  currentNavigation.policeStation = policeStation;
  renderBreadcrumb();

  const modalTitle = document.getElementById('grievance-list-modal-title');
  modalTitle.textContent = `${policeStation} Complaints (${pendingWith})`;

  const tbody = document.getElementById('grievance-table').querySelector('tbody');
  tbody.innerHTML = '';

  const filtered = data.filter(d => 
      d["Pending With"] === pendingWith && 
      d["Police Station"] === policeStation &&
      d["Pending With"]?.trim() !== "Disposed / pending with HQ"
  );
const sorted = filtered.sort((a, b) => parseInt(b["Grievance Since"]) - parseInt(a["Grievance Since"]));

  renderModalGrievanceTable(sorted); // Call a dedicated function for rendering the table
  
  document.getElementById('grievance-list-modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

/**
 * Renders the grievance table content within the comprehensive list modal.
 * @param {Array} grievancesToDisplay - The array of grievance objects to display.
 */
function renderModalGrievanceTable(grievancesToDisplay) {
  const tbody = document.getElementById('grievance-table').querySelector('tbody');
  tbody.innerHTML = ''; // Clear existing content

  if (grievancesToDisplay.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state">
      <i class="fas fa-folder-open"></i>
      <p>No grievances found for this selection.</p>
    </div></td></tr>`;
  } else {
    grievancesToDisplay.forEach(item => {
      const row = document.createElement('tr');
      // Escape special characters for string arguments to showModal
      const description = item["Grievance Description"] || 'No description available';
      const phoneNumber = item["Phone"] || '';
      const grievanceSince = item["Grievance Since"] || '';
      const itemPendingWith = item["Pending With"] || '';
      const grievanceCategory = item["Grievance Category"] || '';
      const itemName = item["Name"] || 'N/A'; // Get the name
      const lastRemarks = item["Last ATN Remarks"] || ''; // Get the last remarks

      row.innerHTML = `
        <td>${itemName}</td>
        <td>${itemPendingWith || 'N/A'}</td>
        <td>${grievanceSince || 'N/A'} days</td>
        <td>
          <span class="details-icon" onclick="showModal(
            ${JSON.stringify(description).replace(/"/g, '&quot;')},
            ${JSON.stringify(phoneNumber).replace(/"/g, '&quot;')},
            ${JSON.stringify(grievanceSince).replace(/"/g, '&quot;')},
            ${JSON.stringify(itemPendingWith).replace(/"/g, '&quot;')},
            ${JSON.stringify(grievanceCategory).replace(/"/g, '&quot;')},
            ${JSON.stringify(itemName).replace(/"/g, '&quot;')},
            ${JSON.stringify(lastRemarks).replace(/"/g, '&quot;')}
          )"><i class="fas fa-file-alt"></i> View</span>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Function to show individual grievance details modal (from original cmo1.html)
function showModal(text, phoneNumber, liveSinceDays, pendingWith, category, name, lastRemarks) { // Added 'name' parameter
  const modalText = document.getElementById('modal-text');
  modalText.innerHTML = ''; // Clear old content

  // Set the name in the p tag
  document.getElementById('name-details').textContent = name ? `Name: ${name}` : '';


  // Insert category (if any)
  if (category) {
    const modalCategory = document.createElement('div');
    modalCategory.className = 'modal-category'; // Use class for styling
    modalCategory.textContent = `Category: ${category}`;
    modalText.appendChild(modalCategory);
  }

  // Insert description
  const descDiv = document.createElement('div');
  descDiv.style.marginTop = '5px';
  descDiv.innerText = text;
  modalText.appendChild(descDiv);

  // Live since days
  const liveSinceDiv = document.getElementById('modal-live-since');
  if (liveSinceDays && pendingWith !== "Disposed / pending with HQ") {
    liveSinceDiv.innerText = `Grievance LIVE since ${liveSinceDays} Days`;
    liveSinceDiv.style.display = 'block';
  } else {
    liveSinceDiv.style.display = 'none';
  }

  // Phone and Last Update Remarks button
  const phoneContainer = document.getElementById('modal-phone');
  phoneContainer.innerHTML = ''; // Clear existing content

  if (phoneNumber) {
    const phoneLink = document.createElement('a');
    phoneLink.href = `tel:${phoneNumber}`;
    phoneLink.className = 'phone-icon';
    phoneLink.innerHTML = `<i class="fas fa-phone"></i>`;
    phoneContainer.appendChild(phoneLink);

    const phoneNumberSpan = document.createElement('span');
    phoneNumberSpan.className = 'phone-number';
    phoneNumberSpan.textContent = phoneNumber;
    phoneContainer.appendChild(phoneNumberSpan);
  }

  if (lastRemarks) {
    const remarksButton = document.createElement('button');
    remarksButton.className = 'details-icon';
    remarksButton.style.marginLeft = phoneNumber ? '10px' : '0'; // Add margin if there's a phone number
    remarksButton.innerHTML = `<i class="fas fa-comment-dots"></i> View Last Update`;
    remarksButton.onclick = function() {
        showRemarksModal(lastRemarks);
    };
    phoneContainer.appendChild(remarksButton);
  }

  phoneContainer.style.display = (phoneNumber || lastRemarks) ? 'flex' : 'none';


  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

/**
 * Function to close individual grievance details modal.
 */
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.body.style.overflow = 'auto';
  document.getElementById('name-details').textContent = ''; // Clear name on close
}

/**
 * Opens a comprehensive list of all pending grievances (excluding disposed).
 * This is triggered by the floating action button.
 */
function openComprehensiveGrievanceListModal() {
  currentNavigation.pendingWith = null; // Reset navigation context for this view
  currentNavigation.policeStation = null;
  renderBreadcrumb();

  const modalTitle = document.getElementById('grievance-list-modal-title');
  modalTitle.textContent = `All Pending Grievances`;

  const modal = document.getElementById('grievance-list-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  // Base data for this modal (all data, filtered by initial districts and current time filter)
  const baseDataForModal = originalData.filter(d => 
      ["Uttar Dinajpur", "Malda", "Dakshin Dinajpur"].includes(d["District"]?.trim()) &&
      (parseInt(d["Grievance Since"], 10) >= (selectedMinMonths * 30) || selectedMinMonths === 0)
  ).filter(item => (item["Pending With"] || "").trim() !== "Disposed / pending with HQ");

  const uniqueDistricts = [...new Set(baseDataForModal.map(d => d["District"]?.trim()).filter(Boolean))].sort();
  const tabsContainer = document.getElementById('district-tabs-container');
  tabsContainer.innerHTML = ''; // Clear existing tabs

  // Add 'All Districts' tab
  const allDistrictsButton = document.createElement('button');
  allDistrictsButton.className = 'modal-tab-button active';
  allDistrictsButton.textContent = 'All Districts';
  allDistrictsButton.onclick = () => filterModalGrievanceListByDistrict('All Districts', baseDataForModal);
  tabsContainer.appendChild(allDistrictsButton);

  // Add individual district tabs
  uniqueDistricts.forEach(district => {
    const button = document.createElement('button');
    button.className = 'modal-tab-button';
    button.textContent = district;
    button.onclick = () => filterModalGrievanceListByDistrict(district, baseDataForModal);
    tabsContainer.appendChild(button);
  });

  // Initially display "All Districts" grievances
  filterModalGrievanceListByDistrict('All Districts', baseDataForModal);
}

/**
 * Filters the grievance list modal content by district and renders the table.
 * @param {string} selectedTabDistrict - The district to filter by, or 'All Districts'.
 * @param {Array} baseDataForModal - The full dataset available for this modal (already time-filtered).
 */
function filterModalGrievanceListByDistrict(selectedTabDistrict, baseDataForModal) {
  // Update active tab styling
  document.querySelectorAll('#district-tabs-container .modal-tab-button').forEach(button => {
    button.classList.remove('active');
    if (button.textContent === selectedTabDistrict) {
      button.classList.add('active');
    }
  });

  let filteredGrievances = [...baseDataForModal];
  if (selectedTabDistrict !== 'All Districts') {
    filteredGrievances = filteredGrievances.filter(item => item["District"]?.trim() === selectedTabDistrict);
  }

  // Sort by 'Grievance Since' in descending order
  const sorted = filteredGrievances.sort((a, b) => parseInt(b["Grievance Since"]) - parseInt(a["Grievance Since"]));
  renderModalGrievanceTable(sorted);
}


/**
 * Function to close all grievances list modal.
 */
function closeGrievanceListModal() {
  document.getElementById('grievance-list-modal').style.display = 'none';
  document.body.style.overflow = 'auto';
  // Reset policeStation when closing this modal
  currentNavigation.policeStation = null; 
  renderBreadcrumb();
}

/**
 * Shows the remarks modal with the provided text.
 * @param {string} remarks - The remarks text to display.
 */
function showRemarksModal(remarks) {
  const remarksContent = document.getElementById('remarks-content');
  remarksContent.textContent = remarks || 'No remarks available.';
  document.getElementById('remarks-modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

/**
 * Closes the remarks modal.
 */
function closeRemarksModal() {
  document.getElementById('remarks-modal').style.display = 'none';
  document.body.style.overflow = 'auto';
}


// New: setup time filter buttons (from cmo.html)
function setupTimeFilterButtons() {
  const buttonContainer = document.getElementById('time-filter-buttons');
  buttonContainer.innerHTML = ''; // Clear existing content

  const timeOptions = [
    { label: 'All', months: 0 },
    { label: '1M+', months: 1 },
    { label: '2M+', months: 2 },
    { label: '3M+', months: 3 },
    { label: '4M+', months: 4 },
    { label: '5M+', months: 5 },
    { label: '6M+', months: 6 },
    { label: '10M+', months: 10 },
    { label: '1Y+', months: 12 }
  ];

  timeOptions.forEach(option => {
    const button = document.createElement('button');
    button.textContent = option.label;
    button.dataset.months = option.months; // Store months value in data attribute

    button.addEventListener('click', () => {
      // Remove 'active' class from all buttons
      document.querySelectorAll('#time-filter-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      // Add 'active' class to the clicked button
      button.classList.add('active');

      selectedMinMonths = option.months; // Update the global filter state
      filterDataAndRender(); // Re-render the dashboard
    });
    buttonContainer.appendChild(button);
  });

  // Set 'All' button as active by default on initial load
  const allButton = buttonContainer.querySelector('button[data-months="0"]');
  if (allButton) {
    allButton.classList.add('active');
  }
}

// New: render district summary cards (from cmo.html) - moved to before filterDataAndRender
function renderDistrictSummaryCards() {
    const container = document.getElementById('district-summary-cards');
    container.innerHTML = ''; // Clear previous cards

    // Get summaries from the current filtered 'data'
    const districtSummaries = groupAndCountByDistrict(data);

    // Add an "All Districts" card if a specific district is currently selected
    if (selectedDistrict) {
         const allDistrictsCard = document.createElement('div');
         allDistrictsCard.className = 'card all-districts'; // Add a specific class for styling
         allDistrictsCard.addEventListener('click', () => {
             selectedDistrict = null; // Reset district filter
             resetNavigation(); // Reset all navigation states and re-render
         });
         allDistrictsCard.innerHTML = `
             <h3><i class="fas fa-undo"></i> All Districts</h3>
             <div class="stat-line">
                 <p>${data.length}</p> <!-- Also use 'data.length' for overall total in view -->
                 <span>total grievances</span>
             </div>
         `;
         container.appendChild(allDistrictsCard);
    }

    // Render cards for each district
    districtSummaries.forEach(summary => {
        const card = document.createElement('div');
        card.className = 'card';
        // Add a class for selected district for potential styling if needed
        if (selectedDistrict === summary.district) {
            card.classList.add('active-district');
            card.style.border = '2px solid var(--primary)'; // Highlight active district
        }
        card.addEventListener('click', () => {
            selectedDistrict = summary.district; // Set the selected district
            resetNavigation(); // Re-render the whole dashboard with this district filter applied
        });
        card.innerHTML = `
            <h3>${summary.district}</h3>
            <div class="stat-line pending-count"> <!-- Added pending-count class -->
                <p>${summary.pending}</p>
                <span>pending</span>
            </div>
            <div class="stat-line disposed-count">
                <p>${summary.disposed}</p>
                <span>disposed/pending with HQ</span>
            </div>
        `;
        container.appendChild(card);
    });

    // Show/hide the container based on whether there are cards to display
    if (districtSummaries.length === 0 && !selectedDistrict) {
        container.style.display = 'none';
    } else {
        container.style.display = 'flex'; // Ensure it's visible if there are cards
    }
}


// New: Central function to apply all filters (age, district) and trigger rendering (from cmo.html)
function filterDataAndRender() {
    showLoadingModal('Processing data...'); // Show loading modal during filtering
    let tempFilteredData = [...originalData];

    // 1. Apply Age Filter based on selectedMinMonths
    if (selectedMinMonths > 0) {
        tempFilteredData = tempFilteredData.filter(d => {
            const days = parseInt(d["Grievance Since"], 10);
            return !isNaN(days) && days >= (selectedMinMonths * 30);
        });
    }

    // 2. Apply District Filter
    if (selectedDistrict) {
        tempFilteredData = tempFilteredData.filter(d => d["District"] === selectedDistrict);
    }

    // Update the global `data` variable with the final filtered set
    data = tempFilteredData;

    updateLoadingMessage('Visualizing data...');

    updateReportDate();
    renderBreadcrumb();
    renderDistrictSummaryCards(); // Render new district cards
    renderCards(); // Render Pending With categories in a table
    
    hideLoadingModal(); // Hide loading modal after rendering
}

// --- Event Listeners and Initial Load ---

// Add event listener to close original detail modal when clicking outside
document.getElementById('modal').addEventListener('click', function(event) {
  if (event.target === this) {
    closeModal();
  }
});

// Add event listener to close Police Station list modal when clicking outside
document.getElementById('police-station-list-modal').addEventListener('click', function(event) {
  if (event.target === this) {
    closePoliceStationListModal();
  }
});

// Add event listener to close original grievance list modal when clicking outside
document.getElementById('grievance-list-modal').addEventListener('click', function(event) {
  if (event.target === this) {
    closeGrievanceListModal();
  }
});

// Add escape key listener for all modals
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    if (document.getElementById('modal').style.display === 'flex') {
      closeModal();
    } else if (document.getElementById('police-station-list-modal').style.display === 'flex') {
      closePoliceStationListModal();
    } else if (document.getElementById('grievance-list-modal').style.display === 'flex') {
      closeGrievanceListModal();
    } else if (document.getElementById('remarks-modal').style.display === 'flex') {
      closeRemarksModal();
    }
  }
});

// Initial data fetch and setup
fetchCSV(sheetURL).then(res => {
  if (res) {
    // Filter originalData immediately after fetching to only include desired districts
    originalData = res.filter(d => 
        ["Uttar Dinajpur", "Malda", "Dakshin Dinajpur"].includes(d["District"]?.trim())
    );
    
    setupTimeFilterButtons(); // Initialize time filter buttons
    filterDataAndRender(); // Initial render with all data (now filtered by district)
  }
});

</script>

</body>
</html>
