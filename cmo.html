<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CMO Grievances</title>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #3f51b5;
      --primary-light: #757de8;
      --primary-dark: #002984;
      --secondary: #ff6e40;
      --accent: #ffc400;
      --text-primary: #212121;
      --text-secondary: #757575;
      --bg-light: #f5f7ff;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    header {
      background: var(--primary);
      color: white;
      padding: 20px 0;
      position: relative;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    header::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 0;
      width: 100%;
      height: 10px;
      background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
    }
    
    h1 {
      text-align: center;
      margin: 0;
      font-weight: 600;
      font-size: 2rem;
    }
    
    #report-date {
      text-align: center;
      color: rgba(255,255,255,0.9);
      font-weight: 500;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    
    /* Dashboard Stats */
    .dashboard-title {
      font-size: 1.2rem;
      margin: 25px 0 15px;
      padding-left: 10px;
      border-left: 4px solid var(--secondary);
      color: var(--primary-dark);
    }
    
.card-container {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  margin-bottom: 20px;
}


    .card {
  background: var(--card-bg);
  border-radius: 6px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  padding: 0.7rem 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border-top: 3px solid var(--primary);
  display: flex;
  flex-direction: column;
  position: relative;
}

    
    .card.completed {
      border-top: 4px solid var(--success);
    }
    
    .card .toggle-indicator {
      position: absolute;
      right: 10px;
      top: 10px;
      color: var(--primary);
      transition: transform 0.3s ease;
    }
    
    .card.active .toggle-indicator {
      transform: rotate(180deg);
    }
    
    .card.completed h3 {
      color: var(--success);
    }
    
    .card.completed p {
      color: var(--success);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
      background: linear-gradient(to bottom right, #ffffff, #f0f4ff);
    }
    
    .card h3 {
  margin: 0 0 6px 0;
  font-size: 0.95rem;
  color: var(--primary-dark);
}

.card p {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--secondary);
}

    
.card .count-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin: 0;
}

    
    /* Tables */
    .table-container {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      overflow: hidden;
    }
    
    .table-container h3 {
      color: var(--primary-dark);
      font-size: 1.1rem;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(63, 81, 181, 0.08);
      color: var(--primary-dark);
      font-weight: 500;
      text-align: left;
      padding: 12px 15px;
      font-size: 0.9rem;
    }
    
    td {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
      color: var(--text-primary);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover td {
      background: rgba(63, 81, 181, 0.05);
    }
    
    tr.clickable {
      cursor: pointer;
    }
    
    .details-icon {
      cursor: pointer;
      color: var(--primary);
      font-weight: bold;
      background: rgba(63, 81, 181, 0.1);
      padding: 5px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      display: inline-block;
    }
    
    .details-icon:hover {
      background: rgba(63, 81, 181, 0.2);
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      padding: 20px;
      border-radius: 8px;
      overflow-y: auto;
      max-height: 80vh;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      right: 15px;
      top: 15px;
      cursor: pointer;
      color: var(--danger);
      background: rgba(244, 67, 54, 0.1);
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: rgba(244, 67, 54, 0.2);
    }
    
    #modal-text {
      line-height: 1.6;
      margin-top: 10px;
      color: var(--text-primary);
    }
    
    #modal-phone {
      display: flex;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .phone-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--success);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .phone-icon:hover {
      background: #3d8b40;
      transform: scale(1.05);
    }
    
    .phone-number {
      font-size: 1rem;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      padding: 0;
      margin-bottom: 15px;
      list-style: none;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .breadcrumb-item a {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .breadcrumb-item:not(:first-child)::before {
      content: "/";
      padding: 0 8px;
      color: #ccc;
    }
    
    /* Responsive Adjustments */
  /* Add this to your existing CSS */

/* Table improvements */
.table-container {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  margin-bottom: 25px;
  overflow: hidden;
}

/* Color coding for different table levels */
/* First level tables - Police station list */
#pending-with-cards .table-container table th {
  background: rgba(63, 81, 181, 0.08);
  color: var(--primary-dark);
}

/* Second level tables - Complaints list */
tr[id^="ps-"] td > div table {
  background-color: #fff5f0;
  border: 1px solid rgba(255, 110, 64, 0.1);
  border-radius: 4px;
}

tr[id^="ps-"] td > div table th {
  background: rgba(255, 110, 64, 0.1);
  color: var(--secondary);
}

tr[id^="ps-"] td > div table tr:hover td {
  background: rgba(255, 110, 64, 0.05);
}

tr[id^="ps-"] td > div .details-icon {
  background: rgba(255, 110, 64, 0.1);
  color: var(--secondary);
}

tr[id^="ps-"] td > div .details-icon:hover {
  background: rgba(255, 110, 64, 0.2);
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  /* Card adjustments for mobile */
  .card-container {
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 0.5rem;
}

.card {
  padding: 0.5rem;
}

.card h3 {
  font-size: 0.85rem;
}

.card p {
  font-size: 1.1rem;
}

.card .count-label {
  font-size: 0.7rem;
}
  
  /* Table container adjustments */
  .table-container {
    border-radius: 6px;
    padding: 10px !important;
    margin-bottom: 15px;
  }
  
  /* Table styles for mobile view */
  table {
    min-width: 100%; /* Override previous min-width */
  }
  
  th, td {
    padding: 8px 10px !important; /* Override any other padding */
    font-size: 0.8rem;
  }
  
  /* Complaint level tables (nested tables) */
  tr[id^="ps-"] td {
    padding: 0 !important;
  }
  
  tr[id^="ps-"] td > div {
    margin: 6px 0;
  }
  
  /* View button adjustments for better touch targets */
  .details-icon {
    padding: 6px 10px !important;
    min-width: 70px;
    text-align: center;
    border-radius: 4px;
    display: inline-block;
  }
  
  /* Make rows easier to tap */
  tr.clickable td {
    padding-top: 12px !important;
    padding-bottom: 12px !important;
  }
  
  /* Modal adjustments for mobile */
  .modal-content {
    width: 90%;
    max-width: 90%;
    padding: 15px !important;
    border-radius: 6px;
  }
  
  /* Space-saving header on mobile */
  header {
    padding: 15px 0;
  }
  
  h1 {
    font-size: 1.6rem;
  }
  
  #report-date {
    font-size: 0.8rem;
  }
  
  /* Dashboard title adjustment */
  .dashboard-title {
    font-size: 1.1rem;
    margin: 20px 0 12px;
  }
  
  /* Extra compact view for complaint tables */
  tr[id^="ps-"] td > div table th,
  tr[id^="ps-"] td > div table td {
    padding: 6px 8px !important;
  }
  
  /* Better spacing for complaint tables */
  tr[id^="ps-"] td > div {
    padding: 5px;
  }
}
    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .loading::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: #ddd;
      margin-bottom: 15px;
    }
    
    /* New class for card and its expansion */
    .card-expansion-group {
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
  th, td {
    padding-left: 18px !important;
    padding-right: 18px !important;
  }

  .table-container {
    padding-left: 18px !important;
    padding-right: 18px !important;
  }

  .modal-content {
    padding: 15px !important;
  }
}
/* Responsive slider layout */
.slider-flex {
  display: flex;
  align-items: center;
  gap: 10px;
}

#slider-container input[type="range"] {
  flex: 1;
  appearance: none;
  height: 6px;
  background: #ddd;
  border-radius: 4px;
  outline: none;
  transition: background 0.3s;
}

#slider-container input[type="range"]::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  background: var(--primary);
  border-radius: 50%;
  cursor: pointer;
}

#slider-container input[type="range"]::-moz-range-thumb {
  width: 16px;
  height: 16px;
  background: var(--primary);
  border: none;
  border-radius: 50%;
  cursor: pointer;
}

#selectedMonth {
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--primary-dark);
  min-width: 100px;
  text-align: right;
}

@media (max-width: 768px) {
  .slider-flex {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }

  #selectedMonth {
    text-align: left;
    font-size: 0.85rem;
    min-width: auto;
  }

  #slider-container label {
    font-size: 0.9rem;
  }
}
home-float-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
}
    
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>CMO Grievances</h1>
    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 5px;">
      <div id="report-date" style="color: rgba(255,255,255,0.9); font-weight: 500; font-size: 0.9rem;">
        Loading latest report...
      </div>
      <div id="total-pending-zone" style="
        font-weight:600;
        font-size:1rem;
        margin-top:6px;
        background-color: #fff3cd;
        color: #856404;
        padding: 6px 12px;
        border-radius: 6px;
      "></div>
    </div>
    
  

  </div>
</header>

<div class="container">
  <div id="breadcrumb-container"></div>
  
<div id="slider-container" style="margin: 10px 0;">
  <label for="monthSlider" style="font-weight: 500; display: block; margin-bottom: 6px;">
    Filter by Age of Grievance:
  </label>
  <div class="slider-flex">
    <input type="range" id="monthSlider" min="0" value="0">
    <span id="selectedMonth">All grievances</span>
  </div>
</div>

  <div id="card-sections-container">
    <div id="pending-with-cards" class="card-container">
      <div class="loading"></div>
    </div>
  </div>
</div>
<br>
<br>

<div class="modal" id="modal" style="display:none;">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></span>
    <h3>Grievance Details</h3>
    <div id="modal-live-since" style="color:red; font-weight:bold; margin-top:5px;"></div>
    <div id="modal-text"></div>
    <div id="modal-phone"></div>
  </div>
</div>

<!-- Include PapaParse library -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7GVh5HflVhouhVfFOEN2RuA1kCBedmD4Q0CJP02K61DAtWuo3P8XIS8CO7ocZQuJ20uCJBa9qsgZ6/pub?gid=1066071765&single=true&output=csv";

let data = [];

let currentNavigation = {
  pendingWith: null,
  policeStation: null
};

function fetchCSV(url) {
  document.getElementById('pending-with-cards').innerHTML = '<div class="loading"></div>';
  return fetch(url)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.text();
    })
    .then(csvText => {
      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });
      return parsed.data;
    })
    .catch(error => {
      console.error('Error fetching CSV:', error);
      document.getElementById('pending-with-cards').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>Failed to load data. Please try again later.</p>
        </div>
      `;
    });
}

function groupAndCount(arr, key) {
  const count = {};
  arr.forEach(item => {
    const k = item[key]?.trim() || "Unknown";
    count[k] = (count[k] || 0) + 1;
  });
  return Object.entries(count).sort((a, b) => {
    // Special case for "Completed" to always be last
    if (a[0] === "Completed") return 1;
    if (b[0] === "Completed") return -1;
    return b[1] - a[1]; // Default sort by count (descending)
  });
}

function updateReportDate() {
  const dates = data.map(d => d["Report Date"]).filter(Boolean);
  const maxDate = dates.sort().reverse()[0];
  document.getElementById('report-date').innerHTML = `<i class="fas fa-calendar-alt"></i> Report as on ${maxDate}`;

  const pendingCount = data.filter(d => d["Pending With"] && d["Pending With"].trim() !== "Completed").length;
  document.getElementById('total-pending-zone').textContent = `Total Pending under Zone: ${pendingCount}`;
}


function renderBreadcrumb() {
  const container = document.getElementById('breadcrumb-container');
  if (!currentNavigation.pendingWith) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<ul class="breadcrumb">';
  html += '<li class="breadcrumb-item"><a onclick="resetNavigation()">Dashboard</a></li>';
  
  if (currentNavigation.pendingWith) {
    html += `<li class="breadcrumb-item">${currentNavigation.pendingWith}</li>`;
  }
  
  if (currentNavigation.policeStation) {
    html += `<li class="breadcrumb-item">${currentNavigation.policeStation}</li>`;
  }
  
  html += '</ul>';
  container.innerHTML = html;
}

function resetNavigation() {
  currentNavigation = {
    pendingWith: null,
    policeStation: null
  };
  
  renderBreadcrumb();
  renderCards();
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';

  // Match dd/mm/yyyy or dd-mm-yyyy
  const match = dateString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (match) {
    let [_, dd, mm, yyyy] = match;
    if (yyyy.length === 2) {
      yyyy = parseInt(yyyy) > 50 ? '19' + yyyy : '20' + yyyy;
    }
    return `${dd.padStart(2, '0')}/${mm.padStart(2, '0')}/${yyyy}`;
  }

  // Fallback
  try {
    const dateObj = new Date(dateString);
    if (isNaN(dateObj)) return dateString;
    return dateObj.toLocaleDateString('en-GB');
  } catch (e) {
    return dateString;
  }
}


function renderCards() {
  const cardsContainer = document.getElementById('card-sections-container');
  cardsContainer.innerHTML = '<div id="pending-with-cards" class="card-container"></div>';

  const container = document.getElementById('pending-with-cards');
  const groups = groupAndCount(data, 'Pending With');
  const pendingOnly = data.filter(d => d["Pending With"]?.trim() !== "Completed");
  const total = pendingOnly.length;

  if (groups.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>No grievances found</p>
      </div>
    `;
    return;
  }

  groups.forEach(([key, count]) => {
    const keyId = btoa(key).replace(/=/g, '');
    const cardGroupDiv = document.createElement('div');
    cardGroupDiv.className = 'card-expansion-group';
    cardGroupDiv.id = `group-${keyId}`;

    const percentage = key === 'Completed' ? null : ((count / total) * 100).toFixed(1);

    const card = document.createElement('div');
    card.className = key === 'Completed' ? 'card completed' : 'card';
    card.innerHTML = `
      <h3 title="${key}">${key}</h3>
      <div style="display: flex; align-items: center; gap: 6px;">
        <p style="margin: 0;">${count}</p>
        <span class="count-label" style="margin: 0;">
          grievances${percentage !== null ? ` (${percentage}%)` : ''}
        </span>
      </div>
      <div class="toggle-indicator"><i class="fas fa-chevron-down"></i></div>
    `;

    card.onclick = function () {
      const isActive = this.classList.contains('active');
      this.classList.toggle('active');

      const tableDiv = document.getElementById(`table-${keyId}`);
      if (isActive) {
        tableDiv.innerHTML = '';
      } else {
        expandPoliceStationTable(key, `table-${keyId}`);
      }
    };

    cardGroupDiv.appendChild(card);

    const tableContainer = document.createElement('div');
    tableContainer.id = `table-${keyId}`;
    cardGroupDiv.appendChild(tableContainer);

    container.appendChild(cardGroupDiv); // Use container here
  });
}


function expandPoliceStationTable(pendingWith, containerId) {
  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = null;
  renderBreadcrumb();

  const tableContainer = document.getElementById(`table-${btoa(pendingWith).replace(/=/g, '')}`);
  tableContainer.innerHTML = '';

  const filtered = data.filter(d => d["Pending With"] === pendingWith);
  const psCounts = groupAndCount(filtered, 'Police Station');

  let html = `<div class="table-container">
    <h3><i class="fas fa-building"></i> ${pendingWith} - Police Station-wise Count</h3>
    <table>
      <thead>
        <tr>
          <th>Police Station</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>`;

  psCounts.forEach(([ps, count], index) => {
    const rowId = `ps-${btoa(pendingWith + '||' + ps).replace(/=/g, '')}`;
    html += `
      <tr class="clickable" onclick="toggleComplaintList('${pendingWith}', '${ps.replace(/'/g, "\\'")}', '${rowId}')">
        <td>${ps}</td>
        <td><strong>${count}</strong></td>
      </tr>
      <tr id="${rowId}" style="display:none;"><td colspan="2"><div></div></td></tr>
    `;
  });

  html += '</tbody></table></div>';
  tableContainer.innerHTML = html;
}
function toggleComplaintList(pendingWith, policeStation, rowId) {
  const containerRow = document.getElementById(rowId);
  const innerDiv = containerRow.querySelector('div');

  const isVisible = containerRow.style.display !== 'none';

  if (isVisible) {
    containerRow.style.display = 'none';
    innerDiv.innerHTML = '';
    return;
  }

  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = policeStation;
  renderBreadcrumb();

  const filtered = data.filter(d => d["Pending With"] === pendingWith && d["Police Station"] === policeStation);
  const sorted = filtered.sort((a, b) => new Date(a["Received Date & Time"]) - new Date(b["Received Date & Time"]));

  let html = `<div style="padding: 10px 0;"><table style="width:100%;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Received Date</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>`;

  sorted.forEach(item => {
    const receivedDate = formatDate(item["Received Date & Time"]);
    const description = item["Grievance Description"]?.replace(/`/g, "'") || 'No description available';
    const phoneNumber = item["Phone"] || '';

    html += `<tr>
      <td>${item["Name"] || 'N/A'}</td>
      <td>${receivedDate}</td>
      <td><span class="details-icon" onclick="showModal(
  '${description.replace(/'/g, "\\'")}',
  '${phoneNumber.replace(/'/g, "\\'")}',
  '${item["Grievance Since"] || ''}',
  '${item["Pending With"] || ''}',
  '${(item["Grievance Category"] || '').replace(/'/g, "\\'")}'
)">

        <i class="fas fa-file-alt"></i> View
      </span></td>
    </tr>`;
  });

  html += '</tbody></table></div>';

  innerDiv.innerHTML = html;
  containerRow.style.display = '';
}

function expandGrievanceList(pendingWith, policeStation, containerId) {
  currentNavigation.pendingWith = pendingWith;
  currentNavigation.policeStation = policeStation;
  renderBreadcrumb();
  
  // Get the container for this specific grievance list
  const containerElement = document.getElementById(containerId);
  const tableContainer = containerElement.querySelector(`#table-${pendingWith.replace(/\s+/g, '-').toLowerCase()}`);
  
  // Check if we're showing the same police station - if so, we can toggle back to police station list
  const currentTable = tableContainer.querySelector('.table-container h3');
  if (currentTable && currentTable.textContent.includes(policeStation)) {
    // Go back to police station list
    expandPoliceStationTable(pendingWith, containerId);
    return;
  }
  
  const filtered = data.filter(d => d["Pending With"] === pendingWith && d["Police Station"] === policeStation);
  const sorted = filtered.sort((a, b) => new Date(a["Received Date & Time"]) - new Date(b["Received Date & Time"]));
  
  let html = `<div class="table-container">
    <h3><i class="fas fa-clipboard-list"></i> ${pendingWith} - ${policeStation} - Complaints</h3>`;
  
  if (sorted.length === 0) {
    html += `<div class="empty-state">
      <i class="fas fa-search"></i>
      <p>No complaints found</p>
    </div>`;
  } else {
    html += `<table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Received Date</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>`;
      
    sorted.forEach(item => {
      // Format date for better readability - only show the date part, not time
      const receivedDate = formatDate(item["Received Date & Time"]);
      
      // Escape any backticks in description and phone number
      const description = item["Grievance Description"]?.replace(/`/g, "'") || 'No description available';
      const phoneNumber = item["Phone"] || '';
      
      html += `<tr>
        <td>${item["Name"] || 'N/A'}</td>
        <td>${receivedDate}</td>
        <td><span class="details-icon" onclick="showModal('${description.replace(/'/g, "\\'")}', '${phoneNumber.replace(/'/g, "\\'")}')">
          <i class="fas fa-file-alt"></i> View
        </span></td>
      </tr>`;
    });
    
    html += '</tbody></table>';
  }
  
  html += '</div>';
  tableContainer.innerHTML = html;
}

function showModal(text, phoneNumber, liveSinceDays, pendingWith, category) {
  // Clear old content
  const modalText = document.getElementById('modal-text');
  modalText.innerHTML = '';

  // Insert category (if any)
  if (category) {
    const modalCategory = document.createElement('div');
    modalCategory.style.fontSize = '0.85rem';
    modalCategory.style.fontStyle = 'italic';
    modalCategory.style.color = '#666';
    modalCategory.textContent = `Category: ${category}`;
    modalText.appendChild(modalCategory);
  }

  // Insert description
  const descDiv = document.createElement('div');
  descDiv.style.marginTop = '5px';
  descDiv.innerText = text;
  modalText.appendChild(descDiv);

  // Live since days
  const liveSinceDiv = document.getElementById('modal-live-since');
  if (liveSinceDays && pendingWith !== "Completed") {
    liveSinceDiv.innerText = `Grievance LIVE since ${liveSinceDays} Days`;
    liveSinceDiv.style.display = 'block';
  } else {
    liveSinceDiv.style.display = 'none';
  }

  // Phone
  const phoneContainer = document.getElementById('modal-phone');
  if (phoneNumber) {
    phoneContainer.innerHTML = `
      <a href="tel:${phoneNumber}" class="phone-icon">
        <i class="fas fa-phone"></i>
      </a>
      <span class="phone-number">${phoneNumber}</span>
    `;
    phoneContainer.style.display = 'flex';
  } else {
    phoneContainer.style.display = 'none';
  }

  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}



function closeModal() {
  document.getElementById('modal').style.display = 'none';
  
  // Re-enable scroll on body
  document.body.style.overflow = 'auto';
}

// Initialize
let originalData = [];

fetchCSV(sheetURL).then(res => {
  if (res) {
    data = res;
    originalData = [...res];
    updateReportDate();
    setupGrievanceAgeSlider();
    renderCards();
  }
});
function setupGrievanceAgeSlider() {
  const slider = document.getElementById('monthSlider');
  const display = document.getElementById('selectedMonth');

  // Convert all "Grievance Since" values to numbers (days)
  const daysArray = originalData.map(d => parseInt(d["Grievance Since"], 10)).filter(d => !isNaN(d));
  const maxDays = Math.max(...daysArray);
  const maxMonths = Math.ceil(maxDays / 30);

  // Set slider attributes
  slider.max = maxMonths;
  slider.value = 0;

  display.textContent = 'All grievances';

  slider.addEventListener('input', () => {
    const selectedMonths = parseInt(slider.value, 10);
    display.textContent = selectedMonths === 0
      ? 'All grievances'
      : formatMonthYear(selectedMonths);
    filterByGrievanceAge(selectedMonths);
  });
}

function filterByGrievanceAge(minMonths) {
  const filtered = originalData.filter(d => {
    const days = parseInt(d["Grievance Since"], 10);
    return !isNaN(days) && days >= (minMonths * 30);
  });

  data = filtered;
    updateReportDate(); // ← Add this line
  renderCards();
}

function formatMonthYear(months) {
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  let text = 'Older than ';
  if (years > 0) text += `${years} year${years > 1 ? 's' : ''} `;
  if (remainingMonths > 0) text += `${remainingMonths} month${remainingMonths > 1 ? 's' : ''}`;
  return text.trim();
}


// Add event listener to close modal when clicking outside
document.getElementById('modal').addEventListener('click', function(event) {
  if (event.target === this) {
    closeModal();
  }
});

// Add escape key listener for modal
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape' && document.getElementById('modal').style.display === 'flex') {
    closeModal();
  }
});

</script>
  
  <!-- Font Awesome & Materialize CSS (if not already included) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

<!-- Materialize JS (for tooltip) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<!-- Home button script -->
<script src="home-button.js"></script>

  

</body>
</html>
