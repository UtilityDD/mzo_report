<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DTR Load Measurement</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background-color: #121212;
  color: #f5f5f5;
  font-family: Arial, sans-serif;
}
label {
  color: #ccc;
  font-weight: 500;
}
.card {
  background-color: #1f1f1f;
  border-radius: 15px;
}
.btn-success, .btn-primary, .btn-danger {
  font-size: 1.1rem;
  padding: 10px;
}
.spinner-border {
  width: 1.5rem;
  height: 1.5rem;
}
#existingDetails {
  background: #2a2a2a;
  padding: 10px;
  border-radius: 10px;
  font-size: 0.9rem;
}
</style>
</head>
<body class="p-3">

<div class="container">
  <div class="card shadow p-4">
    <h4 class="text-center mb-4">Update DTR Load Measurement</h4>

    <!-- Search Section -->
    <div class="input-group mb-3">
      <input type="text" id="searchDTR" class="form-control" placeholder="Enter DTR Code">
      <button class="btn btn-primary" id="searchBtn">Search</button>
    </div>
    <div id="searchStatus" class="mb-3 text-center"></div>

    <!-- Existing Details -->
    <div id="existingDetails" class="mb-3 d-none"></div>

    <!-- Data Entry Form -->
    <form id="dtrForm" class="d-none">
      <div class="mb-3">
        <label for="DATE_OF_MEASUREMENT">Date of Measurement</label>
        <input type="date" id="DATE_OF_MEASUREMENT" class="form-control" required>
      </div>

      <div class="mb-3">
        <label for="NEW_CAPA_KV">Confirm Capacity (kVA)</label>
        <select id="NEW_CAPA_KV" class="form-select" required>
          <option value="">Select</option>
          <option>10</option>
          <option>25</option>
          <option>63</option>
          <option>100</option>
        </select>
      </div>

      <div class="row">
        <div class="col-4 mb-3">
          <label for="LOAD_R">Load R</label>
          <input type="number" id="LOAD_R" class="form-control" required>
        </div>
        <div class="col-4 mb-3">
          <label for="LOAD_Y">Load Y</label>
          <input type="number" id="LOAD_Y" class="form-control" required>
        </div>
        <div class="col-4 mb-3">
          <label for="LOAD_B">Load B</label>
          <input type="number" id="LOAD_B" class="form-control" required>
        </div>
      </div>

      <div class="mb-3">
        <label for="REMARKS">Remarks</label>
        <textarea id="REMARKS" class="form-control" rows="2"></textarea>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success flex-fill" id="submitBtn">
          Submit
        </button>
        <button type="button" class="btn btn-danger flex-fill" id="resetBtn">
          Exit
        </button>
      </div>
    </form>

    <div id="status" class="mt-3 text-center"></div>
  </div>
</div>

<script>
const API_URL = "PASTE_YOUR_DEPLOYED_SCRIPT_URL_HERE";
let currentDTR = null;

// Search Button Click
document.getElementById("searchBtn").addEventListener("click", async function(){
  let code = document.getElementById("searchDTR").value.trim();
  if(!code){
    document.getElementById("searchStatus").innerHTML = "<span class='text-danger'>Please enter a DTR Code</span>";
    return;
  }
  document.getElementById("searchStatus").innerHTML = '<div class="spinner-border text-light"></div> Searching...';
  
  try {
    const res = await fetch(`${API_URL}?action=search&code=${encodeURIComponent(code)}`);
    const data = await res.json();

    if(data && data.DTR_CODE){
      currentDTR = data;
      document.getElementById("existingDetails").innerHTML = Object.entries(data)
        .map(([k,v]) => `<strong>${k}</strong>: ${v}`).join("<br>");
      document.getElementById("existingDetails").classList.remove("d-none");
      document.getElementById("dtrForm").classList.remove("d-none");
      document.getElementById("searchStatus").innerHTML = "";
    } else {
      document.getElementById("searchStatus").innerHTML = "<span class='text-danger'>No DTR found with this code</span>";
      document.getElementById("existingDetails").classList.add("d-none");
      document.getElementById("dtrForm").classList.add("d-none");
    }
  } catch (err) {
    document.getElementById("searchStatus").innerHTML = "<span class='text-danger'>Error connecting to API</span>";
  }
});

// Form Submit
document.getElementById("dtrForm").addEventListener("submit", async function(e){
  e.preventDefault();
  let submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
  document.getElementById("status").innerHTML = "";

  const payload = {
    DTR_CODE: currentDTR.DTR_CODE,
    DATE_OF_MEASUREMENT: document.getElementById("DATE_OF_MEASUREMENT").value,
    NEW_CAPA_KV: document.getElementById("NEW_CAPA_KV").value,
    LOAD_R: parseFloat(document.getElementById("LOAD_R").value),
    LOAD_Y: parseFloat(document.getElementById("LOAD_Y").value),
    LOAD_B: parseFloat(document.getElementById("LOAD_B").value),
    REMARKS: document.getElementById("REMARKS").value.trim()
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(result.status === "success"){
      document.getElementById("status").innerHTML = 
        `<span class="text-success fw-bold">${result.updated ? "✅ Updated successfully!" : "✅ Saved successfully!"}</span>`;
      document.getElementById("dtrForm").reset();
      document.getElementById("dtrForm").classList.add("d-none");
      document.getElementById("existingDetails").classList.add("d-none");
    } else {
      document.getElementById("status").innerHTML = `<span class="text-danger">❌ ${result.message}</span>`;
    }
  } catch (err) {
    document.getElementById("status").innerHTML = "<span class='text-danger'>❌ Error saving data</span>";
  }

  submitBtn.disabled = false;
  submitBtn.innerHTML = "Submit";
});

// Exit Button
document.getElementById("resetBtn").addEventListener("click", function(){
  document.getElementById("dtrForm").reset();
  document.getElementById("dtrForm").classList.add("d-none");
  document.getElementById("existingDetails").classList.add("d-none");
  document.getElementById("searchDTR").value = "";
  document.getElementById("status").innerHTML = "";
  document.getElementById("searchStatus").innerHTML = "";
});
</script>

</body>
</html>
