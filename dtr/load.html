<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update DTR Load Measurement</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    .readonly-field {
      background-color: #e9ecef;
    }
  </style>
</head>
<body class="py-4">

<div class="container">
  <div class="card shadow-lg">
    <div class="card-header bg-primary text-white text-center">
      <h4 class="mb-0">Update DTR Load Measurement</h4>
    </div>
    <div class="card-body">

      <!-- Search Section -->
      <div class="mb-3">
        <label class="form-label">DTR Code</label>
        <div class="input-group">
          <input type="text" id="dtrCode" class="form-control" placeholder="Enter DTR Code">
          <button class="btn btn-primary" onclick="searchDTR()" id="searchButton">Search</button>
        </div>
      </div>

      <!-- Existing Data -->
      <div id="existingData" class="mb-3 d-none">
        <h5>Existing Details</h5>
        <div id="details" class="small border rounded p-2 bg-light"></div>
      </div>

      <!-- New Data Entry -->
      <div id="newDataEntry" class="d-none">
        <h5>New Data Entry</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Date of Measurement</label>
            <input type="date" id="DATE_OF_MEASUREMENT" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">New Location Name</label>
            <input type="text" id="NEW_LOC_NAME" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">New Feeder Name</label>
            <input type="text" id="NEW_FDR_NAME" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">New Capacity (KV)</label>
            <input type="number" id="NEW_CAPA_KV" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Load R</label>
            <input type="number" id="LOAD_R" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Load Y</label>
            <input type="number" id="LOAD_Y" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Load B</label>
            <input type="number" id="LOAD_B" class="form-control">
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-success flex-fill" id="submitButton" onclick="saveData()">Submit</button>
          <button class="btn btn-danger flex-fill" onclick="closeApp()">Exit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p id="modalMsg" class="mb-3"></p>
        <div id="modalButtons"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentDTR = null;
  let updateModal = new bootstrap.Modal(document.getElementById('messageModal'));

  function showModal(message, buttonsHtml) {
    document.getElementById("modalMsg").innerText = message;
    document.getElementById("modalButtons").innerHTML = buttonsHtml || `<button class="btn btn-primary" data-bs-dismiss="modal">OK</button>`;
    updateModal.show();
  }

  function searchDTR() {
    let code = document.getElementById("dtrCode").value.trim();
    if (!code) {
      showModal("Please enter a DTR Code");
      return;
    }
    document.getElementById("searchButton").innerText = "Searching...";
    document.getElementById("searchButton").disabled = true;

    google.script.run.withSuccessHandler(function(data) {
      document.getElementById("searchButton").innerText = "Search";
      document.getElementById("searchButton").disabled = false;

      if (data) {
        currentDTR = data;
        let html = "";
        for (let key in data) {
          html += `<strong>${key}</strong>: ${data[key]}<br>`;
        }
        document.getElementById("details").innerHTML = html;
        document.getElementById("existingData").classList.remove("d-none");
        document.getElementById("newDataEntry").classList.remove("d-none");
      } else {
        showModal("No DTR found with this code");
        document.getElementById("existingData").classList.add("d-none");
        document.getElementById("newDataEntry").classList.add("d-none");
      }
    }).getDTRDataByCode(code);
  }

  function validateNewData() {
    if (!document.getElementById("DATE_OF_MEASUREMENT").value) return "Date is required";
    if (!document.getElementById("NEW_LOC_NAME").value.trim()) return "Location is required";
    if (!document.getElementById("NEW_FDR_NAME").value.trim()) return "Feeder is required";
    return null;
  }

  function saveData(updateFlag = false) {
    let error = validateNewData();
    if (error) {
      showModal(error);
      return;
    }

    let payload = {
      DTR_CODE: currentDTR.DTR_CODE,
      DATE_OF_MEASUREMENT: document.getElementById("DATE_OF_MEASUREMENT").value,
      NEW_LOC_NAME: document.getElementById("NEW_LOC_NAME").value,
      NEW_FDR_NAME: document.getElementById("NEW_FDR_NAME").value,
      NEW_CAPA_KV: document.getElementById("NEW_CAPA_KV").value,
      LOAD_R: document.getElementById("LOAD_R").value,
      LOAD_Y: document.getElementById("LOAD_Y").value,
      LOAD_B: document.getElementById("LOAD_B").value
    };

    document.getElementById("submitButton").innerText = "Saving...";
    document.getElementById("submitButton").disabled = true;

    google.script.run.withSuccessHandler(function(msg) {
      document.getElementById("submitButton").innerText = "Submit";
      document.getElementById("submitButton").disabled = false;

      if (msg.startsWith("EXISTS|") && !updateFlag) {
        let dateTaken = msg.split("|")[1];
        showModal(
          `Load measurement already taken on ${dateTaken}. Do you want to update?`,
          `<button class="btn btn-success" onclick="saveData(true)">Yes, Update</button>
           <button class="btn btn-danger" onclick="closeApp()">No, Exit</button>`
        );
        return;
      }

      if (msg === "UPDATED") {
        showModal("Data updated successfully!");
      } else if (msg === "ADDED") {
        showModal("Data saved successfully!");
      }
    }).saveLoadMeasurement(payload, updateFlag);
  }

  function closeApp() {
    if (google.script && google.script.host) {
      google.script.host.close();
    } else {
      showModal("Close action only works in Apps Script web app");
    }
  }
</script>
</body>
</html>
