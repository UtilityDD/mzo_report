<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DTR Load Measurement</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root {
    --bg-dark: #0f0f23;
    --bg-card: #1a1a2e;
    --bg-input: #16213e;
    --text-primary: #e5e7eb;
    --text-secondary: #9ca3af;
    --accent: #6366f1;
    --accent-hover: #4f46e5;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --border: #374151;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  }

  * { box-sizing: border-box; }

  body {
    background: linear-gradient(135deg, var(--bg-dark) 0%, #0f172a 50%, #1e1b4b 100%);
    color: var(--text-primary);
    font-family: 'SF Pro Display', 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
    min-height: 100vh;
    margin: 0;
    overflow-x: hidden;
  }

  .floating-shapes {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .shape:nth-child(1) { width: 80px; height: 80px; top: 20%; left: 10%; animation-delay: 0s; }
  .shape:nth-child(2) { width: 60px; height: 60px; top: 60%; right: 15%; animation-delay: 2s; }
  .shape:nth-child(3) { width: 100px; height: 100px; bottom: 20%; left: 60%; animation-delay: 4s; }

  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
  }

  .container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 1rem;
    position: relative;
    z-index: 2;
  }

  .main-card {
    background: rgba(26, 26, 46, 0.9);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 24px;
    box-shadow: var(--shadow);
    padding: 1.5rem; /* Made more compact */
    animation: slideUp 0.6s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .header {
    text-align: center;
    margin-bottom: 1.5rem; /* Made more compact */
  }

  .header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
  }

  .search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .search-input {
    flex: 1;
    background: var(--bg-input);
    border: 2px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .search-input::placeholder {
    color: var(--text-secondary);
  }

  .btn {
    border: none;
    border-radius: 12px;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover));
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
  }

  .btn-success {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
  }

  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
  }

  /* Updated style for compact search results */
  .search-results-compact {
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 1rem;
    margin: 1rem 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Multi-column layout */
    gap: 0.75rem; /* Compact spacing */
  }

  .search-result-item {
    padding: 0.5rem 0;
    border-bottom: 1px dashed var(--border); /* Subtle separator */
  }

  .search-result-item:last-child {
    border-bottom: none; /* No border for the last item */
  }

  .search-result-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.2rem;
  }

  .search-result-value {
    font-size: 0.95rem;
    color: var(--text-primary);
    font-weight: 500;
  }


  .form-section {
    background: rgba(22, 33, 62, 0.8);
    border-radius: 20px;
    padding: 1.25rem; /* Made more compact */
    margin-top: 1.5rem;
    border: 1px solid var(--border);
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .form-section h5 {
    margin-bottom: 1rem; /* Made more compact */
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.75rem; /* Made more compact */
    margin-bottom: 0.75rem; /* Adjusted for compactness */
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-label {
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: 0.4rem;
    font-size: 0.9rem;
  }

  .form-control, .form-select {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    padding: 0.6rem 0.8rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
  }

  .form-control::placeholder {
    color: var(--text-secondary);
  }

  .load-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .load-input {
    text-align: center;
    position: relative;
  }

  .load-input.red { border-left: 3px solid #ef4444; }
  .load-input.yellow { border-left: 3px solid #eab308; }
  .load-input.blue { border-left: 3px solid #3b82f6; }

  .error-msg {
    color: var(--error);
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
    margin: 1rem 0;
  }

  .success-msg {
    color: var(--success);
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
    margin: 1rem 0;
  }

  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    animation: modalFadeIn 0.3s ease;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: var(--bg-card);
    margin: 5% auto;
    padding: 2rem;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
  }

  .close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .close:hover {
    background: rgba(239, 68, 68, 0.2);
    color: var(--error);
  }

  .confirmation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .confirmation-item {
    background: var(--bg-input);
    padding: 0.75rem;
    border-radius: 8px;
    border-left: 3px solid var(--accent);
  }

  .confirmation-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
  }

  .confirmation-value {
    color: var(--text-primary);
    font-weight: 500;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  /* Loading Overlay Styles */
  .loading-overlay {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent dark background */
    backdrop-filter: blur(5px);
    z-index: 1001; /* Higher than modals */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: white;
    font-size: 1.2rem;
  }

  .loading-overlay .loading-spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }

  /* PIN Modal Specific Styles */
  #pinModal {
    display: flex; /* Show by default on load */
    align-items: center;
    justify-content: center;
    z-index: 1002; /* Higher than other modals */
  }

  #pinModal .modal-content {
    max-width: 400px; /* Smaller for PIN entry */
    text-align: center;
  }

  #pinModal input[type="password"] {
    margin-bottom: 1rem;
    text-align: center;
  }

  #pinModal .error-msg {
    margin-top: 1rem;
  }

  /* Initially hide the main content */
  #mainContentWrapper {
    display: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 0.5rem; margin: 1rem auto; }
    .main-card { padding: 1rem; } /* Adjusted for smaller screens */
    .search-container { flex-direction: column; }
    .form-row { grid-template-columns: 1fr; }
    .load-grid { grid-template-columns: 1fr; }
    .confirmation-grid { grid-template-columns: 1fr; }
    .modal-actions { flex-direction: column; }
  }

  /* Specific style for button loading spinner */
  .btn .spinner {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    vertical-align: middle;
    margin-left: 0.5em;
  }

  /* Rejection Modal Specific Styles */
  #rejectionModal .modal-content {
    max-width: 500px;
    text-align: center;
  }
  #rejectionModal .modal-body p {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
  }
</style>
</head>
<body>

<div class="floating-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<!-- PIN Entry Modal -->
<div id="pinModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">🔒 Enter PIN to Proceed</h5>
      <!-- No close button for PIN modal until authenticated -->
    </div>
    <div class="modal-body">
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Please enter your authorization PIN.</p>
      <input type="password" id="pinInput" class="form-control" placeholder="Enter PIN" maxlength="4">
      <button class="btn btn-primary" id="submitPinBtn" onclick="validatePin()">
        🔑 Submit PIN
      </button>
      <div id="pinError" class="error-msg" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- Main Content Wrapper - Initially hidden -->
<div id="mainContentWrapper">
  <div class="container">
    <div class="main-card">
      <div class="header">
        <h1>⚡ DTR Load Measurement</h1>
        <p style="color: var(--text-secondary); margin: 0;">Search and update transformer load data</p>
      </div>

      <div class="search-container">
        <input type="text" id="searchCode" class="search-input" placeholder="Enter DTR Code">
        <button class="btn btn-primary" onclick="searchDTR()">
          🔍 Search
        </button>
      </div>

      <!-- Result display area -->
      <div id="result"></div>

      <div id="formSection" class="form-section" style="display:none;">
        <h5 style="color: var(--text-primary);">✏️ Update Load Information</h5>
        
        <form id="dtrForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">📅 Date of Measurement</label>
              <input type="date" id="DATE_OF_MEASUREMENT" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">⚙️ Capacity (kVA)</label>
              <select id="NEW_CAPA_KV" class="form-select">
                <option value="">Select Capacity</option>
                <option value="10kVA">10 kVA</option>
                <option value="25kVA">25 kVA</option>
                <option value="63kVA">63 kVA</option>
                <option value="100kVA">100 kVA</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">📍 Location Name</label>
              <input type="text" id="NEW_LOC_NAME" class="form-control" placeholder="Enter location">
            </div>
            <div class="form-group">
              <label class="form-label">🔌 Feeder Name</label>
              <input type="text" id="NEW_FDR_NAME" class="form-control" placeholder="Enter feeder">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">📊 Load Measurements (Amps)</label>
            <div class="load-grid">
              <div class="form-group">
                <input type="number" id="LOAD_R" class="form-control load-input red" placeholder="R Phase" step="0.1">
              </div>
              <div class="form-group">
                <input type="number" id="LOAD_Y" class="form-control load-input yellow" placeholder="Y Phase" step="0.1">
              </div>
              <div class="form-group">
                <input type="number" id="LOAD_B" class="form-control load-input blue" placeholder="B Phase" step="0.1">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">💭 Remarks</label>
            <textarea id="REMARKS" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="button" class="btn btn-success" style="flex: 1;" onclick="showConfirmation()">
              ✅ Submit Data
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetSearch()">
              ❌ Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">✅ Confirm Submission</h5>
      <button class="close" onclick="closeModal('confirmationModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Please verify the information before submitting:</p>
      <div id="confirmationData" class="confirmation-grid"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">Cancel</button>
      <button class="btn btn-success" onclick="confirmAndSubmit()">
        🚀 Confirm & Submit
      </button>
    </div>
  </div>
</div>

<!-- Rejection Modal (New) -->
<div id="rejectionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" style="color: var(--error);">🚫 Update Rejected</h5>
      <button class="close" onclick="closeModal('rejectionModal')">&times;</button>
    </div>
    <div class="modal-body">
      <p id="rejectionMessage"></p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('rejectionModal')">OK</button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loading-spinner"></div>
  <p>Updating data...</p>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbzAdLj605vd5e9DlxbEbuLIhODCU13Syh0rSAeeXJ6Qomc_klC6f2WywQ7tutz9qnHDKQ/exec";
const pinSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTMdZNG8ktcf_-CWlhykS75a9RVAL5YHIN7glhcxIDOZssS_c_OmQEx_TzG8Hz1Wa1FbMIKxlHVeR/pub?gid=0&single=true&output=csv";
// New URL for the update data sheet - CORRECTED TYPO HERE
const updateDataSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZPPnIF-T7wgii6J35a-3Wz7RC86Zq-eMSQud795CVJV-92Vy9oJjO6TDpjpgiLNAVPcVn6X_keILV/pub?gid=1835924766&single=true&output=csv";


// Global variables
window.currentCode = null;
window.isAuthenticated = false; // Tracks if PIN is successfully authenticated
window.userAuthorizedDTRPrefix = null; // Stores the dtr-autho value for the logged-in user

/**
 * Parses CSV text into an array of objects.
 * @param {string} csv - The CSV data as a string.
 * @returns {Array<Object>} An array of objects, where each object represents a row.
 */
function parseCSV(csv) {
    const lines = csv.split('\n').filter(line => line.trim() !== '');
    if (lines.length === 0) return [];

    const headers = lines[0].split(',').map(header => header.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(value => value.trim());
        const obj = {};
        for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j];
        }
        result.push(obj);
    }
    return result;
}

/**
 * Shows a loading spinner and disables the target button.
 * @param {HTMLElement} buttonElement - The button element to modify.
 * @param {string} originalText - The original text content of the button.
 */
function showButtonLoading(buttonElement, originalText) {
    buttonElement.dataset.originalText = originalText; // Store original text
    buttonElement.innerHTML = `<span class="spinner"></span> Checking...`;
    buttonElement.disabled = true;
}

/**
 * Hides the loading spinner and re-enables the target button.
 * @param {HTMLElement} buttonElement - The button element to modify.
 */
function hideButtonLoading(buttonElement) {
    buttonElement.innerHTML = buttonElement.dataset.originalText; // Restore original text
    buttonElement.disabled = false;
}

/**
 * Validates the entered PIN against the Google Sheet, checking both PIN and dtr-autho columns.
 */
async function validatePin() {
    const pinInput = document.getElementById("pinInput");
    const enteredPin = pinInput.value.trim();
    const pinErrorDiv = document.getElementById("pinError");
    const submitPinBtn = document.getElementById("submitPinBtn");

    pinErrorDiv.style.display = "none"; // Hide previous errors
    pinErrorDiv.textContent = "";

    if (!enteredPin) {
        pinErrorDiv.textContent = "Please enter a PIN.";
        pinErrorDiv.style.display = "block";
        return;
    }

    showButtonLoading(submitPinBtn, '🔑 Submit PIN'); // Show loading on button

    try {
        const response = await fetch(pinSheetUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const pinData = parseCSV(csvText);

        // Find the row where the PIN matches
        const foundUser = pinData.find(row => row.PIN === enteredPin);

        if (foundUser && foundUser['dtr-autho']) { // Check if both PIN and dtr-autho exist
            window.isAuthenticated = true;
            window.userAuthorizedDTRPrefix = foundUser['dtr-autho']; // Store the authorized prefix
            document.getElementById("pinModal").style.display = "none";
            document.getElementById("mainContentWrapper").style.display = "block"; // Show main content
            pinInput.value = ""; // Clear PIN input
        } else {
            window.isAuthenticated = false;
            window.userAuthorizedDTRPrefix = null; // Clear prefix if authentication fails
            pinErrorDiv.textContent = "No authorization. Invalid PIN or missing DTR authorization.";
            pinErrorDiv.style.display = "block";
        }
    } catch (error) {
        console.error("Error fetching or validating PIN:", error);
        pinErrorDiv.textContent = "Could not validate PIN. Please try again later.";
        pinErrorDiv.style.display = "block";
    } finally {
        hideButtonLoading(submitPinBtn); // Hide loading on button
    }
}

/**
 * Searches for DTR data based on the provided code, enforcing user authorization.
 */
function searchDTR() {
  const code = document.getElementById("searchCode").value.trim();
  
  // Clear previous messages and results
  document.getElementById("result").innerHTML = "";
  document.getElementById("formSection").style.display = "none";
  window.currentCode = null;

  if (!window.isAuthenticated) {
    showError("Please enter a valid PIN to access this functionality.");
    return;
  }

  if (!code) {
    showError("Please enter a DTR Code");
    return;
  }

  // Authorization check based on DTR code and user's dtr-autho prefix
  if (window.isAuthenticated && window.userAuthorizedDTRPrefix && !code.startsWith(window.userAuthorizedDTRPrefix)) {
    showError("Either no DTR exists with this code or you are not authorized to update this DTR.");
    document.getElementById("formSection").style.display = "none"; // Ensure form is hidden
    return;
  }

  showLoading("Searching DTR..."); // Show loading overlay before search with specific text

  fetch(`${scriptUrl}?action=search&code=${code}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "success" && data.data) {
        displayResults(data.data);
        document.getElementById("formSection").style.display = "block";
        window.currentCode = code;
        // Populate form fields with fetched data if available
        populateForm(data.data);
      } else {
        // Only confirm that no DTR was found, do not offer to add new data
        showError("Either no DTR exists with this code or you are not authorized to update this DTR.");
        document.getElementById("formSection").style.display = "none"; // Ensure form is hidden
        window.currentCode = null; // Clear current code if no DTR found
      }
    })
    .catch(err => {
      console.error("Fetch error:", err);
      showError("Connection error. Please try again.");
      document.getElementById("formSection").style.display = "none"; // Hide form on connection error
    })
    .finally(() => {
      hideLoading(); // Hide loading overlay after search (success or error)
    });
}

/**
 * Displays the fetched DTR data in a compact, multi-column text format.
 * @param {object} data - The DTR data to display.
 */
function displayResults(data) {
  let html = '<div class="search-results-compact">'; // Use a new class for styling
  for (const key in data) {
    // Exclude the 'code' from display if it's already in the search input
    if (key.toLowerCase() === 'code') continue; 
    const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    html += `
      <div class="search-result-item">
        <div class="search-result-label">${displayKey}</div>
        <div class="search-result-value">${data[key] || 'N/A'}</div>
      </div>
    `;
  }
  html += '</div>';
  document.getElementById("result").innerHTML = html;
}

/**
 * Populates the form fields with fetched data.
 * @param {object} data - The DTR data to populate the form with.
 */
function populateForm(data) {
  // Map fetched data keys to form field IDs
  const fieldMap = {
    'DATE_OF_MEASUREMENT': 'DATE_OF_MEASUREMENT',
    'LOC_NAME': 'NEW_LOC_NAME', // Assuming LOC_NAME from fetched data maps to NEW_LOC_NAME input
    'FDR_NAME': 'NEW_FDR_NAME', // Assuming FDR_NAME from fetched data maps to NEW_FDR_NAME input
    'CAPA_KV': 'NEW_CAPA_KV',   // Assuming CAPA_KV from fetched data maps to NEW_CAPA_KV select
    'LOAD_R': 'LOAD_R',
    'LOAD_Y': 'LOAD_Y',
    'LOAD_B': 'LOAD_B',
    'REMARKS': 'REMARKS'
  };

  for (const fetchedKey in fieldMap) {
    const elementId = fieldMap[fetchedKey];
    const element = document.getElementById(elementId);
    if (element && data[fetchedKey]) {
      element.value = data[fetchedKey];
    }
  }
}

/**
 * Displays an error message.
 * @param {string} message - The error message to display.
 */
function showError(message) {
  document.getElementById("result").innerHTML = `<div class="error-msg">⚠️ ${message}</div>`;
}

/**
 * Displays a success message.
 * @param {string} message - The success message to display.
 */
function showSuccess(message) {
  document.getElementById("result").innerHTML = `<div class="success-msg">🎉 ${message}</div>`;
}

/**
 * Shows the confirmation modal with the data to be submitted,
 * or the rejection modal if the update date is too soon.
 */
async function showConfirmation() {
  const requiredFields = ['DATE_OF_MEASUREMENT', 'LOAD_R', 'LOAD_Y', 'LOAD_B'];
  for (const field of requiredFields) {
    const value = document.getElementById(field).value.trim();
    if (!value) {
      showError(`Please fill in the ${field.replace(/_/g, ' ').toLowerCase()}`);
      return;
    }
  }

  const currentMeasurementDateStr = document.getElementById("DATE_OF_MEASUREMENT").value;
  const currentMeasurementDate = new Date(currentMeasurementDateStr);

  showLoading("Checking previous updates...");

  try {
    const response = await fetch(updateDataSheetUrl);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const csvText = await response.text();
    const updateData = parseCSV(csvText);

    const foundDTR = updateData.find(row => row.DTR_CODE === window.currentCode);

    if (foundDTR) {
      const lastMeasurementDateStr = foundDTR['DATE_OF_MEASUREMENT'];
      const lastMeasurementDate = new Date(lastMeasurementDateStr);

      const timeDifference = currentMeasurementDate.getTime() - lastMeasurementDate.getTime();
      const daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

      if (daysDifference < 15) {
        const rejectionMessage = `Update rejected. Last Load Measurement date was ${lastMeasurementDateStr}. ` +
                                 `Current update date is ${currentMeasurementDateStr}. ` +
                                 `Updates are allowed only after 15 days.`;
        document.getElementById("rejectionMessage").textContent = rejectionMessage;
        document.getElementById("rejectionModal").style.display = "flex";
        hideLoading();
        return; // Stop the submission process
      }
    }

    // If no previous record found, or if it's older than 15 days, proceed to normal confirmation
    displayConfirmationModalContent();

  } catch (error) {
    console.error("Error checking last measurement date:", error);
    showError("Could not check previous update history. Please try again.");
  } finally {
    hideLoading();
  }
}

/**
 * Populates and displays the main confirmation modal.
 */
function displayConfirmationModalContent() {
  const data = {
    'DTR Code': window.currentCode,
    'Date of Measurement': document.getElementById("DATE_OF_MEASUREMENT").value,
    'Location': document.getElementById("NEW_LOC_NAME").value || 'Not specified',
    'Feeder': document.getElementById("NEW_FDR_NAME").value || 'Not specified',
    'Capacity': document.getElementById("NEW_CAPA_KV").value || 'Not specified',
    'Load R': document.getElementById("LOAD_R").value + ' A',
    'Load Y': document.getElementById("LOAD_Y").value + ' A',
    'Load B': document.getElementById("LOAD_B").value + ' A',
    'Remarks': document.getElementById("REMARKS").value || 'None'
  };

  let html = '';
  for (const [key, value] of Object.entries(data)) {
    html += `
      <div class="confirmation-item">
        <div class="confirmation-label">${key}</div>
        <div class="confirmation-value">${value}</div>
      </div>
    `;
  }

  document.getElementById("confirmationData").innerHTML = html;
  document.getElementById("confirmationModal").style.display = "block";
}


/**
 * Closes the specified modal.
 * @param {string} modalId - The ID of the modal to close.
 */
function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}

/**
 * Confirms the submission and calls submitData.
 */
function confirmAndSubmit() {
  closeModal('confirmationModal'); // Close the confirmation modal
  submitData();
}

/**
 * Shows the loading overlay.
 * @param {string} message - The message to display in the loading overlay.
 */
function showLoading(message = "Updating data...") {
  document.getElementById("loadingOverlay").querySelector('p').textContent = message;
  document.getElementById("loadingOverlay").style.display = "flex";
}

/**
 * Hides the loading overlay.
 */
function hideLoading() {
  document.getElementById("loadingOverlay").style.display = "none";
}

/**
 * Submits the DTR data to the Google Apps Script.
 */
function submitData() {
  showLoading(); // Show loading overlay before submission
  
  const payload = {
    DTR_CODE: window.currentCode,
    DATE_OF_MEASUREMENT: document.getElementById("DATE_OF_MEASUREMENT").value,
    NEW_LOC_NAME: document.getElementById("NEW_LOC_NAME").value,
    NEW_FDR_NAME: document.getElementById("NEW_FDR_NAME").value,
    NEW_CAPA_KV: document.getElementById("NEW_CAPA_KV").value,
    LOAD_R: parseFloat(document.getElementById("LOAD_R").value) || 0,
    LOAD_Y: parseFloat(document.getElementById("LOAD_Y").value) || 0,
    LOAD_B: parseFloat(document.getElementById("LOAD_B").value) || 0,
    REMARKS: document.getElementById("REMARKS").value
  };

  fetch(scriptUrl, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      showSuccess(data.updated ? "Data Successfully Updated!" : "Data Successfully Added!");
      setTimeout(() => resetSearch(), 2000);
    } else {
      showError("Submission failed: " + (data.message || "Unknown error"));
    }
  })
  .catch(err => {
    showError("Connection error. Please try again.");
  })
  .finally(() => {
    hideLoading(); // Hide loading overlay after submission (success or error)
  });
}

/**
 * Resets the search input, result area, and form.
 */
function resetSearch() {
  document.getElementById("searchCode").value = "";
  document.getElementById("result").innerHTML = "";
  document.getElementById("dtrForm").reset();
  document.getElementById("formSection").style.display = "none";
  window.currentCode = null;
}

// Event listeners
document.getElementById("searchCode").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault(); // Prevent default form submission
    searchDTR();
  }
});

// Event listener for PIN input
document.getElementById("pinInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        validatePin();
    }
});

// Close modal when clicking outside (only for confirmation modal and rejection modal)
window.onclick = function(event) {
  const confirmationModal = document.getElementById("confirmationModal");
  const rejectionModal = document.getElementById("rejectionModal");
  if (event.target === confirmationModal) {
    closeModal('confirmationModal');
  }
  if (event.target === rejectionModal) {
    closeModal('rejectionModal');
  }
}

// On page load, show the PIN modal and hide main content
window.onload = function() {
    document.getElementById("pinModal").style.display = "flex";
    document.getElementById("mainContentWrapper").style.display = "none";
};
</script>

</body>
</html>
