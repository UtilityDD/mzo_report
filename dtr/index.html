<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DTR Data Analysis</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Poppins Font (from original HTML) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* Custom CSS from your provided index.html for the 'mountain visual theme' */
    :root {
      --primary-color: #316ac5;
      --secondary-color: #a0a0a0;
      --success-color: #5cb85c;
      --warning-color: #f0ad4e;
      --info-color: #5bc0de;
      --background-light: #ece9d8;
      --content-bg: #e5e5e5;
      --text-dark: #000000;
      --text-muted: #6c757d;
      --border-light: #808080;
      --shadow-light: rgba(0, 0, 0, 0.2);
      --highlight-border: #ffffff;
      --inset-shadow: inset 1px 1px 2px rgba(0,0,0,0.4);
      --raised-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light);
      --tab-active-bg: #ffffff;
    }

    body {
      font-family: 'Tahoma', 'MS Sans Serif', 'Segoe UI', 'Poppins', sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
      font-size: 0.9rem;
      padding: 20px; /* Add some padding around the body */
    }
    .container {
      background-color: var(--content-bg);
      padding: 20px;
      border-radius: 0;
      border: 1px solid var(--border-light);
      box-shadow: 0 0 0 1px var(--highlight-border), 2px 2px 5px var(--shadow-light);
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 1200px; /* Increased max-width for visualization */
    }
    h3 {
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 20px;
      text-align: left;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-light);
      background-color: var(--primary-color);
      color: #fff;
      padding: 8px 15px;
      margin-left: -20px;
      margin-right: -20px;
      margin-top: -20px;
      border-radius: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2rem;
    }

    /* Card styling */
    .card {
      border: 1px solid var(--border-light);
      border-radius: 0;
      box-shadow: none;
      background-color: var(--content-bg);
    }
    .card-header {
      border-bottom: 1px solid var(--border-light);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      font-weight: 600;
      font-size: 1rem;
      padding: 8px 15px;
      background-color: #c0c0c0;
      color: var(--text-dark);
      border-bottom: 1px solid var(--border-light);
      border-top: 1px solid var(--highlight-border);
      position: relative;
      box-shadow: var(--inset-shadow);
    }
    .card-header.bg-primary {
      background-color: var(--primary-color) !important;
      color: #fff !important;
      box-shadow: none !important;
    }

    /* Buttons */
    .btn {
      border-radius: 0;
      padding: 6px 15px;
      font-weight: 600;
      transition: none;
      border: 1px solid var(--border-light);
      background-image: linear-gradient(to bottom, #f0f0f0, #c0c0c0);
      color: var(--text-dark);
      box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light);
    }
    .btn:hover {
      background-image: linear-gradient(to bottom, #c0c0c0, #f0f0f0);
      box-shadow: none;
      transform: translate(1px, 1px);
    }
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: #fff;
      background-image: linear-gradient(to bottom, var(--primary-color), #214f9d);
      box-shadow: 1px 1px 0px rgba(255,255,255,0.3), 2px 2px 0px var(--primary-color);
    }
    .btn-primary:hover {
      background-image: linear-gradient(to bottom, #214f9d, var(--primary-color));
      border-color: var(--primary-color);
    }
    .btn-secondary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: var(--text-dark);
      background-image: linear-gradient(to bottom, #d0d0d0, #a0a0d0);
      box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light);
    }
    .btn-secondary:hover {
      background-image: linear-gradient(to bottom, #a0a0d0, #d0d0d0);
      border-color: var(--secondary-color);
    }

    /* Table styling */
    .table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border-light);
      font-size: 0.85rem;
      margin-top: 15px; /* Added margin for separation */
    }
    .table th, .table td {
      border: 1px solid var(--border-light);
      padding: 8px;
      text-align: left;
    }
    .table thead th {
      background-color: #c0c0c0;
      font-weight: 600;
      color: var(--text-dark);
      border-top: 1px solid var(--highlight-border);
      box-shadow: var(--inset-shadow);
      position: sticky; /* Sticky header */
      top: 0;
      z-index: 1;
      cursor: pointer; /* Indicate sortable columns */
    }
    .table thead th i {
        margin-left: 5px;
        font-size: 0.7em;
        vertical-align: middle;
    }
    .table tbody tr:nth-child(even) {
      background-color: #e0e0e0;
    }
    .table tbody tr:hover {
      background-color: #d0d0d0;
    }
    .table-row-clickable {
        cursor: pointer;
        transition: background-color 0.1s ease;
    }
    .table-row-clickable:hover {
        background-color: #c0c0c0; /* Darker hover for clickable rows */
    }
    .table tfoot tr {
        font-weight: 700;
        background-color: #d0d0d0; /* Highlight total row */
        border-top: 2px solid var(--border-light);
    }


    /* Summary Cards */
    .summary-card {
        background-color: var(--content-bg);
        border: 1px solid var(--border-light);
        box-shadow: 0 0 0 1px var(--highlight-border), 2px 2px 5px var(--shadow-light);
        padding: 15px;
        border-radius: 0;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .summary-card h5 {
        font-size: 1rem;
        margin-bottom: 10px;
        color: var(--primary-color);
    }
    .summary-card .value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-dark);
    }
    .summary-card .label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Direct Capacity Analysis Button */
    .btn-direct-capacity {
        padding: 2px 6px;
        font-size: 0.7rem;
        margin-left: 5px;
        background-image: linear-gradient(to bottom, #f0f0f0, #c0c0c0);
        color: var(--text-dark);
        border: 1px solid var(--border-light);
        box-shadow: 1px 1px 0px var(--highlight-border), 2px 2px 0px var(--border-light);
    }
    .btn-direct-capacity:hover {
        background-image: linear-gradient(to bottom, #c0c0c0, #f0f0f0);
        box-shadow: none;
        transform: translate(1px, 1px);
    }

    

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 10px; /* Add some padding for mobile view */
      }
      .container {
        margin-top: 0;
        margin-bottom: 0;
        padding: 15px;
        width: 100%;
        max-width: 100%;
        border-radius: 0;
        border: none;
        box-shadow: none;
      }
      h3 {
        font-size: 1.1rem;
        padding: 10px 15px;
        margin-left: -15px;
        margin-right: -15px;
        margin-top: -15px;
        border-radius: 0;
      }
      .card {
        border-radius: 0;
      }
      .card-header {
        font-size: 1rem;
        padding: 10px 15px;
        border-radius: 0;
      }
      .btn {
        padding: 10px 16px; /* Increased padding for better touch experience */
        font-size: 0.9rem;
      }
      .table th, .table td {
        padding: 8px;
        font-size: 0.9rem; /* Increased font size for readability */
        white-space: normal; /* Allow table content to wrap */
      }
      .table-responsive {
          border: 1px solid var(--border-light);
      }
      .summary-card {
          padding: 15px;
          font-size: 0.9rem;
          width: 100%; /* Make summary cards full width */
      }
      .summary-card h5 {
          font-size: 1rem;
      }
      .summary-card .value {
          font-size: 1.1rem;
      }
      /* Stack navigation controls on mobile */
      #breadcrumb-navigation {
          width: 100%;
      }
      .ms-auto {
          width: 100%;
          margin-left: 0 !important;
          margin-top: 10px;
      }
      #directLevelSelect {
          width: 100% !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h3 class="mb-4">
    <i class="fas fa-chart-pie me-2"></i> DTR Data Analysis Dashboard
  </h3>

  <!-- Navigation/Drill-down controls -->
  <div class="mb-4 d-flex flex-wrap gap-2 align-items-center">
    <div id="breadcrumb-navigation" class="d-flex flex-wrap gap-2">
      <button class="btn btn-primary" id="homeBtn">
        <i class="fas fa-home me-2"></i>Overall (Region-wise)
      </button>
    </div>
    <div class="ms-auto">
      <label for="directLevelSelect" class="form-label mb-0 me-2">Go to:</label>
      <select class="form-select" id="directLevelSelect" style="width: auto; display: inline-block;">
        <option value="REGION">Region-wise</option>
        <option value="DIVN NAME">Division-wise</option>
        <option value="SUPP_OFF">CCC-wise</option>
        <option value="SS_NAME">SS-wise</option>
        <option value="FDR_NAME">Feeder-wise</option>
        <option value="CAPA_KV">Capacity-wise</option>
      </select>
    </div>
  </div>

  <!-- Total Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="summary-card">
        <h5>Total DTRs (Overall)</h5>
        <div class="value" id="overallDTRCount">0</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="summary-card">
        <h5>Total Capacity (Overall)</h5>
        <div class="value" id="overallCapacitySum">0 kVA</div>
      </div>
    </div>
  </div>

  <!-- Main Visualization Area (now primarily for tables) -->
  <div id="visualization-area">

    <!-- Region-wise Analysis -->
    <div class="card mb-4" id="region-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-globe me-2"></i> Region-wise Analysis
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="regionTable">
            <thead>
              <tr>
                <th data-sort-key="name">Region <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="capa_kv_sum">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
                <th>Actions</th> <!-- Added for direct capacity analysis -->
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-center" id="loadingMessage">Loading data...</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Division-wise Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="division-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-building me-2"></i> Division-wise Analysis (<span id="currentRegion"></span>)
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="divisionTable">
            <thead>
              <tr>
                <th data-sort-key="name">Division Name <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="capa_kv_sum">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
                <th>Actions</th> <!-- Added for direct capacity analysis -->
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-center">Select a Region to view Divisions.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- CCC-wise Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="ccc-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-store me-2"></i> CCC-wise Analysis (<span id="currentDivision"></span>)
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="cccTable">
            <thead>
              <tr>
                <th data-sort-key="name">CCC Name <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="capa_kv_sum">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="text-center">Select a Division to view CCCs.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- SS-wise Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="ss-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-charging-station me-2"></i> SS-wise Analysis (<span id="currentCCC"></span>)
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="ssTable">
            <thead>
              <tr>
                <th data-sort-key="name">SS Name <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="capa_kv_sum">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
                <th>Actions</th> <!-- Added for direct capacity analysis -->
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-center">Select a CCC to view SS.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Feeder-wise Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="feeder-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-network-wired me-2"></i> Feeder-wise Analysis (<span id="currentSS"></span>)
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="feederTable">
            <thead>
              <tr>
                <th data-sort-key="name">Feeder Name <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="capa_kv_sum">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="text-center">Select an SS to view Feeders.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Capacity-wise Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="capacity-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-bolt me-2"></i> Capacity-wise Analysis (<span id="currentFeeder"></span>)
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="capacityTable">
            <thead>
              <tr>
                <th data-sort-key="CAPA_KV_value">Capacity (kVA) <i class="fas fa-sort"></i></th>
                <th data-sort-key="dtr_count">DTR Count <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_count">% Share (Count) <i class="fas fa-sort"></i></th>
                <th data-sort-key="percentage_of_capacity">% Share (Capacity) <i class="fas fa-sort"></i></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-center">Select a Feeder to view Capacities.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- DTR List Analysis (initially hidden) -->
    <div class="card mb-4 d-none" id="dtr-list-analysis-card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-list me-2"></i> DTRs for Capacity: <span id="currentCapacity"></span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="dtrListTable">
            <thead>
              <tr>
                <th data-sort-key="DTR_CODE">DTR Code <i class="fas fa-sort"></i></th>
                <th data-sort-key="LOC_NAME">Location <i class="fas fa-sort"></i></th>
                <th data-sort-key="CAT">Category <i class="fas fa-sort"></i></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" class="text-center">Select a Capacity to view DTRs.</td></tr>
            </tbody>
            <tfoot>
              <!-- Total row will be added here by JavaScript -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- /#visualization-area -->

</div> <!-- /.container -->

<!-- DTR Detail Modal -->
<div class="modal fade" id="dtrDetailModal" tabindex="-1" aria-labelledby="dtrDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="dtrDetailModalLabel">DTR Details: <span id="modalDTRCode"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalDTRDetailsBody">
        <!-- DTR details will be populated here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let dtrRawData = []; // Will store the fetched data
  let overallTotals = { dtr_count: 0, capa_kv_sum: 0 }; // Stores overall totals

  let currentLevel = 'REGION'; // Tracks the current drill-down level
  let currentFilter = {}; // Stores the filters for the current view (e.g., { REGION: 'MALDA' })

  // Global state for sorting
  let sortState = { key: null, direction: 'asc' }; // key: column to sort by, direction: 'asc' or 'desc'

  const hierarchy = ['REGION', 'DIVN NAME', 'SUPP_OFF', 'SS_NAME', 'FDR_NAME', 'CAPA_KV', 'DTR_LIST'];
  const tableBodies = {
    'REGION': document.querySelector('#regionTable tbody'),
    'DIVN NAME': document.querySelector('#divisionTable tbody'),
    'SUPP_OFF': document.querySelector('#cccTable tbody'),
    'SS_NAME': document.querySelector('#ssTable tbody'),
    'FDR_NAME': document.querySelector('#feederTable tbody'),
    'CAPA_KV': document.querySelector('#capacityTable tbody'),
    'DTR_LIST': document.querySelector('#dtrListTable tbody') // New DTR list table body
  };
  // Reference to the tfoot elements for each table
  const tableFooters = {
    'REGION': document.querySelector('#regionTable tfoot'),
    'DIVN NAME': document.querySelector('#divisionTable tfoot'),
    'SUPP_OFF': document.querySelector('#cccTable tfoot'),
    'SS_NAME': document.querySelector('#ssTable tfoot'),
    'FDR_NAME': document.querySelector('#feederTable tfoot'),
    'CAPA_KV': document.querySelector('#capacityTable tfoot'),
    'DTR_LIST': document.querySelector('#dtrListTable tfoot') // New DTR list table footer
  };


  const analysisCards = {
    'REGION': document.getElementById('region-analysis-card'),
    'DIVN NAME': document.getElementById('division-analysis-card'),
    'SUPP_OFF': document.getElementById('ccc-analysis-card'),
    'SS_NAME': document.getElementById('ss-analysis-card'),
    'FDR_NAME': document.getElementById('feeder-analysis-card'),
    'CAPA_KV': document.getElementById('capacity-analysis-card'),
    'DTR_LIST': document.getElementById('dtr-list-analysis-card') // New DTR list card
  };
  const breadcrumbNav = document.getElementById('breadcrumb-navigation');
  const homeBtn = document.getElementById('homeBtn');
  const directLevelSelect = document.getElementById('directLevelSelect');

  const overallDTRCountElem = document.getElementById('overallDTRCount');
  const overallCapacitySumElem = document.getElementById('overallCapacitySum');

  const dtrDetailModal = new bootstrap.Modal(document.getElementById('dtrDetailModal'));
  const modalDTRCodeElem = document.getElementById('modalDTRCode');
  const modalDTRDetailsBodyElem = document.getElementById('modalDTRDetailsBody');

  let loadingInterval; // Variable to hold the interval for loading animation

  function startLoadingAnimation() {
    const loadingMessageElement = document.getElementById('loadingMessage');
    if (!loadingMessageElement) return;

    let dots = 0;
    loadingMessageElement.textContent = 'Loading data';
    loadingInterval = setInterval(() => {
      dots = (dots + 1) % 4;
      loadingMessageElement.textContent = 'Loading data' + '.'.repeat(dots);
    }, 300);
  }

  function stopLoadingAnimation() {
    clearInterval(loadingInterval);
    const loadingMessageElement = document.getElementById('loadingMessage');
    if (loadingMessageElement) {
      loadingMessageElement.textContent = 'Loading data...'; // Reset to default or empty
    }
  }


  // Event listener for the Home button
  homeBtn.addEventListener('click', () => {
    currentLevel = 'REGION';
    currentFilter = {};
    sortState = { key: null, direction: 'asc' }; // Reset sort state
    renderDashboard();
  });

  // Event listener for direct level selection dropdown
  directLevelSelect.addEventListener('change', (event) => {
    const selectedLevel = event.target.value;
    currentLevel = selectedLevel;
    currentFilter = {}; // Reset filter when directly jumping to a level
    sortState = { key: null, direction: 'asc' }; // Reset sort state
    renderDashboard();
  });

  // Function to fetch and parse CSV data
  async function fetchDTRData() {
    startLoadingAnimation(); // Start animation
    // Corrected CSV URL
    const dtrCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZPPnIF-T7wgii6J35a-3Wz7RC86Zq-eMSQud795CVJV-92Vy9oJjO6TDpjpgiLNAVPcVn6X_keILV/pub?gid=2125422147&single=true&output=csv';

    try {
      const response = await fetch(dtrCsvUrl);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const csvText = await response.text();

      const lines = csvText.split('\n').filter(line => line.trim() !== ''); // Filter out empty lines
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const parsedData = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
        if (cols.length === headers.length) {
          const record = {};
          headers.forEach((header, index) => {
            record[header] = cols[index];
          });
          parsedData.push(record);
        }
      }
      dtrRawData = parsedData;

      // Calculate overall totals once after fetching data
      overallTotals.dtr_count = dtrRawData.length;
      overallTotals.capa_kv_sum = dtrRawData.reduce((sum, item) => sum + (parseFloat(item.CAPA_KV) || 0), 0);

      overallDTRCountElem.textContent = overallTotals.dtr_count;
      overallCapacitySumElem.textContent = formatCapacity(overallTotals.capa_kv_sum);

      console.log('DTR Data Loaded:', dtrRawData); // For debugging
      renderDashboard(); // Render dashboard after data is loaded
      stopLoadingAnimation(); // Stop animation on success
    } catch (error) {
      console.error('Error loading DTR data:', error);
      stopLoadingAnimation(); // Stop animation on error
      // Display an error message to the user
      // Corrected colspan for error message in table
      document.getElementById('regionTable').innerHTML = '<tbody><tr><td colspan="6" class="text-center text-danger">Failed to load DTR data. Please check the source URL or your network connection.</td></tr></tbody>';
    }
  }

  // Helper function to format capacity into kVA or MVA
  function formatCapacity(value) {
      if (value === null || isNaN(value)) return 'N/A';
      if (value >= 1000) {
          return (value / 1000).toFixed(2) + ' MVA';
      }
      return value.toFixed(2) + ' kVA';
  }

  // Function to process and aggregate data
  function aggregateData(data, groupByField, filter = {}) {
    if (groupByField === 'DTR_LIST') {
        // For DTR_LIST, just filter the raw data based on the current filter
        return data.filter(item => {
            for (const key in filter) {
                // Special handling for CAPA_KV to match float values
                if (key === 'CAPA_KV') {
                    if (parseFloat(item[key]) !== parseFloat(filter[key])) {
                        return false;
                    }
                } else if (item[key] !== filter[key]) {
                    return false;
                }
            }
            return true;
        });
    }

    const aggregated = {};
    let totalCount = 0;
    let totalCapacity = 0;

    data.forEach(item => {
      // Apply filters
      let matchesFilter = true;
      for (const key in filter) {
        if (item[key] !== filter[key]) {
          matchesFilter = false;
          break;
        }
      }

      if (matchesFilter) {
        let groupKey = item[groupByField];
        // Exclude last 12 characters from CCC name for visualization
        if (groupByField === 'SUPP_OFF' && groupKey && groupKey.length > 12) {
            groupKey = groupKey.slice(0, -12).trim();
        }

        if (!aggregated[groupKey]) {
          aggregated[groupKey] = {
            name: groupKey,
            dtr_count: 0,
            capa_kv_sum: 0,
            original_filter: { ...filter, [groupByField]: item[groupByField] } // Store original value for drill-down
          };
        }
        aggregated[groupKey].dtr_count++;
        aggregated[groupKey].capa_kv_sum += parseFloat(item.CAPA_KV) || 0;

        totalCount++;
        totalCapacity += parseFloat(item.CAPA_KV) || 0;
      }
    });

    // Convert to array and calculate percentages
    const result = Object.values(aggregated).map(item => {
      item.percentage_of_count = (totalCount > 0 ? (item.dtr_count / totalCount) * 100 : 0).toFixed(2);
      item.percentage_of_capacity = (totalCapacity > 0 ? (item.capa_kv_sum / totalCapacity) * 100 : 0).toFixed(2);
      return item;
    });

    // Apply sorting based on sortState
    if (sortState.key) {
        result.sort((a, b) => {
            let valA, valB;
            if (sortState.key === 'name' || sortState.key === 'DTR_CODE' || sortState.key === 'LOC_NAME' || sortState.key === 'CAT') { // For alphabetical sorting
                valA = (a[sortState.key] || a.name || '').toLowerCase(); // Use a.name for aggregated data, or actual field for DTR_LIST
                valB = (b[sortState.key] || b.name || '').toLowerCase();
                return sortState.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            } else if (sortState.key === 'CAPA_KV_value') { // For Capacity-wise table's first column (Capacity kVA)
                valA = parseFloat(a.name); // 'name' holds the capacity value for CAPA_KV
                valB = parseFloat(b.name);
                return sortState.direction === 'asc' ? valA - valB : valB - valA;
            } else { // For numeric columns (dtr_count, capa_kv_sum, percentages)
                valA = parseFloat(a[sortState.key]);
                valB = parseFloat(b[sortState.key]);
                return sortState.direction === 'asc' ? valA - valB : valB - valA;
            }
        });
    } else if (groupByField === 'CAPA_KV') {
        // Default sort for CAPA_KV if no specific sort key is set (ascending by capacity value)
        result.sort((a, b) => parseFloat(a.name) - parseFloat(b.name));
    } else if (groupByField === 'DTR_LIST') {
        // Default sort for DTR_LIST (alphabetical by DTR_CODE)
        result.sort((a, b) => (a.DTR_CODE || '').localeCompare(b.DTR_CODE || ''));
    }
    else {
        // Default sort for other fields if no specific sort key is set (alphabetical by name)
        result.sort((a, b) => a.name.localeCompare(b.name));
    }

    return result;
  }

  // Function to render tables
  function renderTable(data, tableBodyElement, currentGroupByField) {
    tableBodyElement.innerHTML = ''; // Clear existing rows
    const tableFooterElement = tableFooters[currentGroupByField];
    tableFooterElement.innerHTML = ''; // Clear existing footer row

    // Get the parent table element
    const tableElement = tableBodyElement.closest('table');
    let headers = [];
    if (tableElement) {
        const tableHeaderRow = tableElement.querySelector('thead tr');
        if (tableHeaderRow) {
            headers = Array.from(tableHeaderRow.querySelectorAll('th[data-sort-key]'));
        }
    } else {
        console.error('Parent table element not found for:', currentGroupByField);
        const colspan = (currentGroupByField === 'CAPA_KV') ? 4 : (currentGroupByField === 'DTR_LIST' ? 3 : 6);
        tableBodyElement.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">Error: Table structure invalid. Cannot render data.</td></tr>`;
        return;
    }


    // Reset all sort icons
    headers.forEach(header => {
        const icon = header.querySelector('i');
        if (icon) {
            icon.classList.remove('fa-sort-up', 'fa-sort-down');
            icon.classList.add('fa-sort');
        }
    });

    // Set the current sort icon
    if (sortState.key) {
        // Find the header within the CURRENT table's headers collection
        const currentSortHeader = Array.from(headers).find(header => header.dataset.sortKey === sortState.key);
        if (currentSortHeader) { // Check if the header exists in the current table
            const icon = currentSortHeader.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-sort');
                icon.classList.add(sortState.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
            }
        }
    }

    // Removed the individual header click listeners here, as they are now handled by event delegation.

    if (data.length === 0) {
      const colspan = (currentGroupByField === 'CAPA_KV') ? 4 : (currentGroupByField === 'DTR_LIST' ? 3 : 6); // Adjusted colspan for DTR_LIST
      tableBodyElement.innerHTML = `<tr><td colspan="${colspan}" class="text-center">No data available for this selection.</td></tr>`;
      return;
    }

    let currentTableTotalCount = 0;
    let currentTableTotalCapacity = 0; // Only relevant for aggregated tables

    data.forEach(item => {
      const row = tableBodyElement.insertRow();
      let cellsHtml = '';

      if (currentGroupByField === 'DTR_LIST') {
        cellsHtml += `<td class="dtr-code-clickable" data-dtr-code="${item.DTR_CODE}" style="cursor:pointer; color: var(--primary-color);"><strong>${item.DTR_CODE || 'N/A'}</strong></td>`;
        cellsHtml += `<td>${item.LOC_NAME || 'N/A'}</td>`;
        cellsHtml += `<td>${item.CAT || 'N/A'}</td>`;
        currentTableTotalCount++;

        row.innerHTML = cellsHtml; // Set innerHTML first

        // Attach click listener for DTR Code to show modal
        const dtrCodeElement = row.querySelector('.dtr-code-clickable');
        if (dtrCodeElement) { // Ensure element exists before adding listener
            dtrCodeElement.addEventListener('click', () => {
                showDTRDetailModal(item);
            });
        }

      } else if (currentGroupByField === 'CAPA_KV') {
        cellsHtml += `<td>${item.name || 'N/A'}</td>`; // Capacity value
        cellsHtml += `<td>${item.dtr_count}</td>`;
        cellsHtml += `<td>${item.percentage_of_count}%</td>`;
        cellsHtml += `<td>${item.percentage_of_capacity}%</td>`;

        currentTableTotalCount += item.dtr_count;
        currentTableTotalCapacity += parseFloat(item.name) * item.dtr_count; // Sum of (capacity * count)

        row.innerHTML = cellsHtml; // Set innerHTML first

        // Make capacity rows clickable to drill down to DTR_LIST
        row.style.cursor = 'pointer';
        row.classList.add('table-row-clickable');
        row.addEventListener('click', () => {
            currentLevel = 'DTR_LIST';
            // The filter for DTR_LIST will be the current filter plus the selected CAPA_KV
            currentFilter = { ...currentFilter, 'CAPA_KV': item.name };
            sortState = { key: null, direction: 'asc' }; // Reset sort state for new table
            renderDashboard();
        });

      } else {
        // For other aggregated tables (Region, Division, CCC, SS, Feeder)
        cellsHtml += `<td>${item.name || 'N/A'}</td>
                      <td>${item.dtr_count}</td>
                      <td>${formatCapacity(item.capa_kv_sum)}</td>
                      <td>${item.percentage_of_count}%</td>
                      <td>${item.percentage_of_capacity}%</td>
                      <td>`;
        // Add direct capacity analysis button for relevant levels
        if (['REGION', 'DIVN NAME', 'SS_NAME'].includes(currentGroupByField)) {
            cellsHtml += `<button class="btn btn-sm btn-direct-capacity" title="View Capacity Analysis for ${item.name}" data-original-filter='${JSON.stringify(item.original_filter)}'>
                            <i class="fas fa-bolt me-1"></i> Capacity
                          </button>`;
        }
        cellsHtml += `</td>`;

        row.innerHTML = cellsHtml; // Set innerHTML first

        currentTableTotalCount += item.dtr_count;
        currentTableTotalCapacity += item.capa_kv_sum;

        // Add click listener for drill-down (unless it's the last level before DTR_LIST)
        // This condition ensures the generic row click is NOT applied to CAPA_KV or DTR_LIST
        if (currentGroupByField !== 'CAPA_KV' && currentGroupByField !== 'DTR_LIST') {
            row.style.cursor = 'pointer';
            row.classList.add('table-row-clickable');
            row.addEventListener('click', (event) => {
                // Prevent drill-down if the click was on the "Capacity" button
                if (event.target.closest('.btn-direct-capacity')) {
                    return;
                }
                const nextLevelIndex = hierarchy.indexOf(currentGroupByField) + 1;
                // Ensure we don't drill down from Feeder to DTR_LIST directly via row click,
                // as CAPA_KV is the intended intermediate step.
                if (nextLevelIndex < hierarchy.length - 1) {
                    currentLevel = hierarchy[nextLevelIndex];
                    currentFilter = item.original_filter;
                    sortState = { key: null, direction: 'asc' }; // Reset sort state on drill-down
                    renderDashboard();
                }
            });
        }
      }
    });

    // Add total row at the bottom
    const totalRow = tableFooterElement.insertRow();
    if (currentGroupByField === 'DTR_LIST') {
        totalRow.innerHTML = `
            <td><strong>Total DTRs</strong></td>
            <td><strong>${currentTableTotalCount}</strong></td>
            <td></td> <!-- Empty cell for Category -->
        `;
    } else if (currentGroupByField !== 'CAPA_KV') {
        totalRow.innerHTML = `
            <td><strong>Total</strong></td>
            <td><strong>${currentTableTotalCount}</strong></td>
            <td><strong>${formatCapacity(currentTableTotalCapacity)}</strong></td>
            <td><strong>100.00%</strong></td>
            <td><strong>100.00%</strong></td>
            <td></td> <!-- Empty cell for Actions column -->
        `;
    } else {
        // For Capacity-wise table, total capacity is sum of (capacity * count)
        const totalCapacityForCapacityWise = data.reduce((sum, item) => sum + (parseFloat(item.name) * item.dtr_count), 0);
        totalRow.innerHTML = `
            <td><strong>Total</strong></td>
            <td><strong>${currentTableTotalCount}</strong></td>
            <td><strong>${formatCapacity(totalCapacityForCapacityWise)}</strong></td>
            <td><strong>100.00%</strong></td>
        `;
    }


    // Attach event listeners to the "Capacity" buttons after they are rendered
    tableBodyElement.querySelectorAll('.btn-direct-capacity').forEach(button => {
        button.addEventListener('click', () => {
            currentLevel = 'CAPA_KV';
            currentFilter = JSON.parse(button.dataset.originalFilter); // Parse the stored filter
            sortState = { key: null, direction: 'asc' }; // Reset sort state on direct capacity view
            renderDashboard();
        });
    });
  }

  // Function to show DTR detail modal
  function showDTRDetailModal(dtrData) {
      modalDTRCodeElem.textContent = dtrData.DTR_CODE || 'N/A';
      let detailsHtml = '<ul class="list-group list-group-flush">';
      for (const key in dtrData) {
          if (dtrData.hasOwnProperty(key)) {
              detailsHtml += `<li class="list-group-item"><strong>${key.replace(/_/g, ' ')}:</strong> ${dtrData[key]}</li>`;
          }
      }
      detailsHtml += '</ul>';
      modalDTRDetailsBodyElem.innerHTML = detailsHtml;
      dtrDetailModal.show();
  }

  // Function to update breadcrumb navigation
  function updateBreadcrumb() {
    breadcrumbNav.innerHTML = '';
    breadcrumbNav.appendChild(homeBtn); // Always keep Home button

    const currentFilterKeys = Object.keys(currentFilter);
    let currentPath = {};

    for (let i = 0; i < hierarchy.indexOf(currentLevel); i++) {
      const field = hierarchy[i];
      const value = currentFilter[field];
      if (value) {
        currentPath[field] = value;
        const breadcrumbButton = document.createElement('button');
        breadcrumbButton.className = 'btn btn-secondary';
        // Display original value in breadcrumb
        let displayValue = value;
        if (field === 'SUPP_OFF' && value.length > 12) {
            displayValue = value.slice(0, -12).trim();
        }
        breadcrumbButton.innerHTML = `<i class="fas fa-chevron-right mx-1"></i> ${displayValue}`;
        breadcrumbButton.dataset.level = field;
        breadcrumbButton.dataset.value = value; // Store original value in dataset
        breadcrumbButton.addEventListener('click', (event) => {
          const clickedLevel = event.target.dataset.level;
          // Reconstruct filter up to the clicked level
          const newFilter = {};
          for(let j = 0; j <= hierarchy.indexOf(clickedLevel); j++) {
            const hField = hierarchy[j];
            if (currentFilter[hField]) { // Check if the filter exists for this level in the current path
              newFilter[hField] = currentFilter[hField];
            }
          }
          currentLevel = clickedLevel;
          currentFilter = newFilter;
          sortState = { key: null, direction: 'asc' }; // Reset sort state on breadcrumb navigation
          renderDashboard();
        });
        breadcrumbNav.appendChild(breadcrumbButton);
      }
    }
  }


  // Main function to render the dashboard based on current level and filter
  function renderDashboard() {
    // Hide all analysis cards first
    Object.values(analysisCards).forEach(card => card.classList.add('d-none'));

    // Determine the field to group by for the current level
    const groupByField = currentLevel;

    // Show the relevant card
    analysisCards[groupByField].classList.remove('d-none');

    // Update current level labels
    if (groupByField === 'DIVN NAME') {
      document.getElementById('currentRegion').textContent = currentFilter.REGION || '';
    } else if (groupByField === 'SUPP_OFF') {
      document.getElementById('currentDivision').textContent = currentFilter['DIVN NAME'] || '';
    } else if (groupByField === 'SS_NAME') {
      document.getElementById('currentCCC').textContent = currentFilter['SUPP_OFF'] || '';
    } else if (groupByField === 'FDR_NAME') {
      document.getElementById('currentSS').textContent = currentFilter['SS_NAME'] || '';
    } else if (groupByField === 'CAPA_KV') {
      // For Capacity-wise, the header should reflect the path leading to it
      let pathDisplay = [];
      if (currentFilter.REGION) pathDisplay.push(currentFilter.REGION);
      if (currentFilter['DIVN NAME']) pathDisplay.push(currentFilter['DIVN NAME']);
      if (currentFilter.SS_NAME) pathDisplay.push(currentFilter.SS_NAME);
      document.getElementById('currentFeeder').textContent = pathDisplay.join(' > ') || 'Overall';
    } else if (groupByField === 'DTR_LIST') {
        // For DTR_LIST, show the capacity it's filtering by
        let pathDisplay = [];
        if (currentFilter.REGION) pathDisplay.push(currentFilter.REGION);
        if (currentFilter['DIVN NAME']) pathDisplay.push(currentFilter['DIVN NAME']);
        if (currentFilter.SS_NAME) pathDisplay.push(currentFilter.SS_NAME);
        if (currentFilter.FDR_NAME) pathDisplay.push(currentFilter.FDR_NAME);
        if (currentFilter.CAPA_KV) pathDisplay.push(currentFilter.CAPA_KV + ' kVA');
        document.getElementById('currentCapacity').textContent = pathDisplay.join(' > ') || 'Overall';
    }

    // Update the direct level select dropdown to reflect the current level
    directLevelSelect.value = currentLevel;

    // Aggregate data for the current view
    const aggregatedData = aggregateData(dtrRawData, groupByField, currentFilter);

    // Render table for the current view
    renderTable(aggregatedData, tableBodies[groupByField], groupByField);

    // Update breadcrumb navigation
    updateBreadcrumb();
  }

  // Global event listener for sorting table headers using event delegation
  document.addEventListener('click', (event) => {
      const clickedHeader = event.target.closest('th[data-sort-key]');
      if (clickedHeader) {
          // Check if the clicked header belongs to the currently active table
          // This prevents sorting a hidden table if a click bubbles up from somewhere else
          const activeTableElement = analysisCards[currentLevel].querySelector('table');
          if (activeTableElement && activeTableElement.contains(clickedHeader)) {
              const newSortKey = clickedHeader.dataset.sortKey;
              let newSortDirection = 'asc';

              if (sortState.key === newSortKey) {
                  // If clicking the same header, toggle direction
                  newSortDirection = (sortState.direction === 'asc') ? 'desc' : 'asc';
              }
              // Update global sort state
              sortState = { key: newSortKey, direction: newSortDirection };
              renderDashboard(); // Re-render with new sort state
          }
      }
  });


  // Initial data fetch when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    fetchDTRData(); // This will call renderDashboard() upon successful data fetch
  });

</script>
</body>
</html>
