<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defective Meter Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* Base styles for the entire application */
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: #f0f2f5; /* Lighter background for a modern feel */
            color: #1e293b; /* Dark text for readability */
            font-size: 14px; /* Slightly larger base font for better legibility */
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px; /* Max width for content */
            margin: 0 auto; /* Center the container */
            padding: 15px; /* Increased padding around the content */
        }
        
        /* Card component styling */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px; /* More rounded corners for a softer look */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Stronger shadow for depth */
            transition: all 0.3s ease; /* Smooth transition for hover effects */
        }

        .card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12); /* Enhanced shadow on hover */
        }
        
        /* Header section styling */
        .header {
            padding: 15px 20px; /* Increased padding */
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between; /* Distribute items with space between */
            align-items: center;
        }
        
        .title {
            font-size: 20px; /* Larger title */
            font-weight: 700; /* Bolder */
            color: #0f172a; /* Darker title color */
            margin: 0;
        }
        
        .subtitle {
            font-size: 12px; /* Slightly larger subtitle */
            color: #64748b; /* Muted grey for subtitle */
            margin: 0;
            margin-top: 2px;
        }
        
        /* Metric grid and individual metric card styling */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive grid for metrics */
            gap: 12px; /* Increased gap between metric cards */
            margin-bottom: 15px; /* Increased margin below the grid */
        }
        
        .metric-card {
            background: linear-gradient(135deg, #ffffff, #f0f9ff); /* Subtle gradient background */
            border: 1px solid #dbeafe; /* Lighter border color */
            border-radius: 8px;
            padding: 12px 15px; /* Increased padding */
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Smooth hover effects */
            cursor: pointer; /* Indicate clickable */
        }

        .metric-card:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Subtle shadow on hover */
        }
        
        .metric-label {
            font-size: 11px; /* Slightly larger label */
            color: #475569; /* Darker grey for labels */
            text-transform: uppercase;
            letter-spacing: 0.7px; /* Increased letter spacing */
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 24px; /* Larger value */
            font-weight: 700; /* Bolder */
            color: #1a56db; /* Primary blue for metric values */
            margin: 0;
        }
        
        /* Filter section styling */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsive grid for filters */
            gap: 10px; /* Increased gap between filter selects */
            padding: 15px 20px; /* Increased padding */
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .filter-select {
            padding: 8px 12px; /* Increased padding */
            border: 1px solid #cbd5e1; /* Slightly darker border */
            border-radius: 6px; /* More rounded */
            font-size: 13px; /* Slightly larger font */
            background: white;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            border-color: #3b82f6; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Stronger shadow on focus */
        }
        
        .filter-select:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Main content tabs styling */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            gap: 4px; /* Increased gap between tabs */
            padding: 0 20px; /* Increased padding */
            background: #ffffff;
        }
        
        .tab-btn {
            padding: 10px 18px; /* Increased padding */
            border: none;
            background: none;
            font-size: 14px; /* Slightly larger font */
            font-weight: 600; /* Bolder */
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent; /* Thicker border */
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            color: #3b82f6; /* Active tab color */
            border-bottom-color: #3b82f6; /* Active tab underline color */
        }
        
        .tab-btn:hover:not(.active) {
            color: #374151;
            background-color: #f8fafc; /* Subtle hover background */
        }
        
        /* Table container and row styling */
        .table-container {
            max-height: 450px; /* Slightly increased max height for scrollable content */
            overflow-y: auto; /* Enable vertical scrolling */
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
            border-radius: 0 0 8px 8px; /* Rounded bottom corners */
        }
        
        /* MODAL CONTENT: Ensure it's a flex container and doesn't scroll itself */
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%; /* Responsive width */
            max-width: 700px; /* Max width for desktop */
            max-height: 90vh; /* Constrain the modal itself */
            overflow: hidden; /* Hide overflow of modal content, letting flex children manage it */
            padding: 20px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            display: flex; /* Use flexbox for modal content layout */
            flex-direction: column; /* Stack children vertically */
        }

        /* MODAL TABLE CONTAINER: Allow it to grow and handle its own scrolling */
        .modal-content .table-container {
            flex-grow: 1; /* Allow table container to take remaining space */
            overflow-y: auto; /* Enable vertical scrolling for the table itself */
            max-height: none; /* Remove fixed max-height calculation here, as flex-grow should handle it */
            border-top: none; /* Remove top border as it's part of modal body now */
            border-radius: 0; /* No specific border radius needed here */
        }

        .table-header {
            background: #f1f5f9; /* Lighter header background */
            padding: 10px 20px; /* Increased padding */
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px; /* Slightly larger font */
            font-weight: 700; /* Bolder */
            color: #475569; /* Darker text */
            position: sticky; /* Sticky header for scrolling tables */
            top: 0;
            z-index: 10;
        }
        
        .table-row {
            padding: 8px 20px; /* Increased padding */
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px; /* Slightly larger font */
            transition: background-color 0.15s ease;
        }
        
        .table-row:hover {
            background: #f8fafc; /* Subtle hover background for table rows */
        }
        
        .table-row:last-child {
            border-bottom: none; /* No border for the last row */
        }
        
        /* Specific style for clickable rows in CCC modal */
        .ccc-row-modal {
            cursor: pointer; /* Indicate clickable rows */
        }

        .ccc-row-modal:hover {
            background-color: #e0f2fe; /* Light blue background on hover */
        }
        
        /* Expand button for age analysis details */
        .expand-btn {
            background: none;
            border: none;
            color: #64748b;
            font-size: 10px;
            cursor: pointer;
            padding: 4px; /* Increased padding */
            border-radius: 4px; /* More rounded */
            transition: all 0.15s ease;
        }
        
        .expand-btn:hover {
            background: #e2e8f0;
            color: #374151;
            transform: scale(1.1); /* Slight scale on hover */
        }
        
        .month-details {
            background: #f8fafc; /* Lighter background */
            padding: 6px 0; /* Increased padding */
            margin-top: 6px; /* Increased margin */
            border-left: 3px solid #dbeafe; /* Thicker, colored border */
        }
        
        .month-row {
            padding: 4px 12px; /* Increased padding */
            font-size: 12px; /* Slightly larger font */
            color: #475569; /* Darker grey */
        }
        
        /* Loading spinner animation */
        .loading-spinner {
            width: 18px; /* Larger spinner */
            height: 18px; /* Larger spinner */
            border: 3px solid #e2e8f0; /* Thicker border */
            border-top: 3px solid #3b82f6; /* Thicker, colored top border */
            border-radius: 50%;
            animation: spin 0.8s linear infinite; /* Faster spin animation */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Global loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85); /* Semi-transparent white overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of other content */
            transition: opacity 0.3s ease, visibility 0.3s ease; /* Smooth fade in/out */
            visibility: hidden; /* Hidden by default */
        }

        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .loading-overlay p {
            margin-top: 10px;
            font-size: 16px;
            color: #374151;
            font-weight: 500;
        }
        
        /* Year Tabs specific styles */
        .year-tabs-container {
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); /* Responsive columns for smaller screens */
            gap: 8px;
            flex-wrap: wrap; /* Allow wrapping of items */
            justify-content: flex-start;
        }
        
        /* Responsive adjustment for year tabs: 8 items per line for desktop */
        @media (min-width: 640px) { /* Bootstrap 'sm' breakpoint equivalent */
            .year-tabs-container {
                grid-template-columns: repeat(8, 1fr); /* 8 years per line for tablets/desktop */
            }
        }

        .year-tab-btn {
            padding: 6px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .year-tab-btn.active {
            background: #3b82f6; /* Active year tab background */
            color: white; /* Active year tab text color */
            border-color: #3b82f6;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2); /* Shadow for active tab */
        }

        .year-tab-btn:hover:not(.active) {
            background-color: #e0f2fe; /* Light blue hover */
            border-color: #93c5fd;
            color: #1a56db;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Darker overlay for modals */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher z-index than loading overlay */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Utility classes for Bootstrap compatibility, adjusted for clarity/consistency */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; } /* For consumer data */
        .grid-5 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; } /* For consumer data */
        .grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); } /* For consumer data with BASE_CLASS */
        .grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); } /* For consumer data with CONN_STAT */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .ml-2 { margin-left: 8px; }
        .mt-1 { margin-top: 4px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .font-mono { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; } /* Improved monospace font stack */
        .text-gray-500 { color: #64748b; }
        .text-red-500 { color: #ef4444; }
        .py-4 { padding: 16px 0; }
        .opacity-70 { opacity: 0.7; }
        
        /* Bootstrap additions for additional utilities */
        .group:hover .group-hover\:opacity-100 { opacity: 1; }
        .blur { filter: blur(4px); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <!-- Global loading overlay, shown while data is being fetched -->
    <div class="loading-overlay" id="global-loading-overlay">
        <div class="loading-spinner"></div>
        <p>Please wait... Loading data</p>
    </div>

    <div class="container">
        <!-- Header section of the dashboard -->
        <div class="card" style="margin-bottom: 15px;">
            <div class="header">
                <div>
<div class="d-flex align-items-center gap-2">
  <h1 class="title">Defective Meter Dashboard</h1>
  <button onclick="openModal('suggestion-modal-overlay')" title="Click for Smart Suggestion"
    class="position-relative group btn p-0 border-0 bg-transparent">
    <!-- Glowing background pulse -->
    <div class="position-absolute top-0 start-0 w-100 h-100 rounded-circle bg-warning opacity-70 blur animate-pulse"></div>

    <!-- Static icon on top -->
    <svg class="position-relative text-warning" xmlns="http://www.w3.org/2000/svg"
      width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 2a7 7 0 017 7c0 2.5-1.5 4.5-3.5 5.5V17a1 1 0 01-1 1h-5a1 1 0 01-1-1v-2.5C6.5 13.5 5 11.5 5 9a7 7 0 017-7z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 21h6" />
    </svg>

    <!-- Tooltip on hover -->
    <span
      class="position-absolute start-100 ms-2 top-50 translate-middle-y bg-warning-subtle text-warning-emphasis small fw-medium px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 transition">
      Best Practice
    </span>
  </button>
</div>


                    <p id="report-date" class="subtitle"></p>
                </div>
                <!-- This loading indicator is for internal use, global one is preferred -->
                <div id="loading-indicator" class="loading-spinner hidden"></div> 
            </div>
        </div>

        <!-- Metric cards displaying key statistics -->
        <div class="metric-grid">
            <div class="metric-card" data-metric-type="total">
                <div class="metric-label">Total Defective</div>
                <div id="total-meters" class="metric-value">0</div>
            </div>
            <div class="metric-card" data-metric-type="agri">
                <div class="metric-label">Agri Meters</div>
                <div id="total-agri" class="metric-value">0</div>
            </div>
<div class="metric-card bg-danger-subtle border border-danger-subtle shadow-sm" data-metric-type="over10years">
    <div class="metric-label text-danger">Defects >10 Years</div>
    <div id="more-than-10-years" class="metric-value text-danger">0</div>
</div>

            <!-- New Metric Card: Defects >5 Years -->
            <div class="metric-card" data-metric-type="over5years">
                <div class="metric-label">Defects >5 Years</div>
                <div id="more-than-5-years" class="metric-value">0</div>
            </div>
            <!-- New Metric Card: 3-Ph Defective -->
            <div class="metric-card" data-metric-type="3phase">
                <div class="metric-label">3-Ph Defective</div>
                <div id="three-ph-defective" class="metric-value">0</div>
            </div>
            <!-- New Metric Card: Industrial Defective -->
            <div class="metric-card" data-metric-type="industrial">
                <div class="metric-label">Industrial Defective</div>
                <div id="industrial-defective" class="metric-value">0</div>
            </div>
            <!-- New Metric Card: Smart Meter -->
<div class="metric-card bg-danger-subtle border border-danger shadow-sm" data-metric-type="smartmeter">
    <div class="metric-label text-danger-emphasis">Smart Meter</div>
    <div id="smart-meter-count" class="metric-value text-danger">0</div>
</div>

        </div>

        <!-- Main content area, including filters, year tabs, and main tabs -->
        <div class="card">
            <!-- Filter dropdowns for region, division, and CCC -->
            <div class="filters">
                <select id="region-select" class="filter-select">
                    <option value="">All Regions</option>
                </select>
                <select id="division-select" class="filter-select" disabled>
                    <option value="">All Divisions</option>
                </select>
                <select id="ccc-select" class="filter-select" disabled>
                    <option value="">All CCCs</option>
                </select>
                <!-- New Class filter dropdown -->
                <select id="class-select" class="filter-select">
                    <option value="">All Classes</option>
                </select>
            </div>

            <!-- Dynamically populated year-wise tabs -->
            <div id="year-tabs-container" class="year-tabs-container">
                <!-- Year tabs will be dynamically loaded here by JavaScript -->
            </div>

            <!-- Main navigation tabs: Age Analysis, By CCC, By Phase -->
            <div class="tabs">
                <button id="tab-age-analysis" class="tab-btn">Age Analysis</button>
                <button id="tab-ccc-wise" class="tab-btn">By CCC</button>
                <button id="tab-phase-wise" class="tab-btn">By Phase</button>
                <!-- New Tab: By Class -->
                <button id="tab-by-class" class="tab-btn active">By Class</button>
            </div>

            <!-- Content area for the selected tab -->
            <div id="tab-content">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status" style="margin: 0 auto 8px;"></div>
                    <p class="text-secondary">Loading data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CCC-wise Modal Structure -->
    <div id="ccc-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="ccc-modal-title">CCC-wise Data</h3>
                <button class="modal-close-btn" onclick="closeModal('ccc-modal-overlay')">&times;</button>
            </div>
            <div id="ccc-modal-body" class="table-container">
                <!-- CCC-wise data will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Consumer-wise Modal Structure -->
    <div id="consumer-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="consumer-modal-title">Consumer-wise Data</h3>
                <button class="modal-close-btn" onclick="closeModal('consumer-modal-overlay')">&times;</button>
            </div>
            <div id="consumer-modal-body" class="table-container">
                <!-- Consumer-wise data will be loaded here -->
            </div>
        </div>
    </div>

    <!-- DETAIL Modal: show full row details -->
    <div id="detail-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detail-modal-title">Consumer Details</h3>
                <button class="modal-close-btn" onclick="closeModal('detail-modal-overlay')">&times;</button>
            </div>
            <div id="detail-modal-body" class="table-container">
                <!-- Full row details will be loaded here -->
            </div>
        </div>
    </div>
    
    <script>
        // Global variables to store data and current state
        let defectiveMeterData = [];
        let filteredData = [];
        let currentActiveTab = 'by-class'; // Default active tab changed to 'by-class'
        let currentSelectedYear = 'All'; // Default selected year for filtering
let smartMeterCount = 0;

        // Hardcoded mapping for regions, divisions, and CCCs
        const regionDivisionCccMapping = [
            {
                "regionName": "MALDA REGION", "regionCode": "6610000",
                "divisions": [
                    {
                        "divisionName": "MALDA DIVISIOIN", "divisionCode": "6611000",
                        "cccs": [
                            {"cccName": "MANIKCHAK CCC", "cccCode": "6611101"},
                            {"cccName": "GOLAPGANJ CCC", "cccCode": "6611102"},
                            {"cccName": "BAISHNABNAGAR CCC", "cccCode": "6611103"},
                            {"cccName": "KALIACHAK CCC", "cccCode": "6611104"},
                            {"cccName": "MOTHABARI CCC", "cccCode": "6611105"},
                            {"cccName": "SUJAPUR CCC", "cccCode": "6611106"},
                            {"cccName": "RATHBARI CCC", "cccCode": "6611107"},
                            {"cccName": "FULBARI CCC", "cccCode": "6611108"},
                            {"cccName": "MOKDUMPUR CCC", "cccCode": "6611109"}
                        ]
                    },
                    {
                        "divisionName": "CHANCHAL DIVISION", "divisionCode": "6612000",
                        "cccs": [
                            {"cccName": "BHALUKA CCC", "cccCode": "6612101"},
                            {"cccName": "SAMSI CCC", "cccCode": "6612102"},
                            {"cccName": "PARANPUR CCC", "cccCode": "6612103"},
                            {"cccName": "CHANCHAL CCC", "cccCode": "6612104"},
                            {"cccName": "MALATIPUR CCC", "cccCode": "6612105"},
                            {"cccName": "HARISHCHANDRAPUR CCC", "cccCode": "6612106"},
                            {"cccName": "KUSHIDA CCC", "cccCode": "6612107"}
                        ]
                    },
                    {
                        "divisionName": "GAZOLE DIVISION", "divisionCode": "6613000",
                        "cccs": [
                            {"cccName": "GAZOL CCC", "cccCode": "6613101"},
                            {"cccName": "AIHO. CCC", "cccCode": "6613102"},
                            {"cccName": "PANDUA CCC", "cccCode": "6613103"},
                            {"cccName": "BAMONGOLA CCC", "cccCode": "6613104"},
                            {"cccName": "OLD MALDA CCC", "cccCode": "6613105"}
                        ]
                    }
                ]
            },
            {
                "regionName": "UTTAR DINAJPUR REGION", "regionCode": "6620000",
                "divisions": [
                    {
                        "divisionName": "RAIGANJ DIVISION", "divisionCode": "6621000",
                        "cccs": [
                            {"cccName": "ITAHAR CCC", "cccCode": "6621101"},
                            {"cccName": "HEMTABAD CCC", "cccCode": "6621102"},
                            {"cccName": "KALIYAGANJ CCC", "cccCode": "6621103"},
                            {"cccName": "RAIGANJ CCC", "cccCode": "6621104"},
                            {"cccName": "BIRNAGAR CCC", "cccCode": "6621105"},
                            {"cccName": "KARANDIGHI CCC", "cccCode": "6621106"}
                        ]
                    },
                    {
                        "divisionName": "ISLAMPUR DIVISION", "divisionCode": "6622000",
                        "cccs": [
                            {"cccName": "ISLAMPUR CCC", "cccCode": "6622101"},
                            {"cccName": "CHOPRA CCC", "cccCode": "6622102"},
                            {"cccName": "DALKHOLA CCC", "cccCode": "6622103"},
                            {"cccName": "GOALPOKHER CCC", "cccCode": "6622104"},
                            {"cccName": "KANKI CCC", "cccCode": "6622105"}
                        ]
                    }
                ]
            },
            {
                "regionName": "DAKSHIN DINAJPUR REGION", "regionCode": "6630000",
                "divisions": [
                    {
                        "divisionName": "BALURGHAT DIVISION", "divisionCode": "6631000",
                        "cccs": [
                            {"cccName": "BALURGHAT CCC", "cccCode": "6631101"},
                            {"cccName": "TAPAN CCC", "cccCode": "6631102"},
                            {"cccName": "KUMARGANJ CCC", "cccCode": "6631103"},
                            {"cccName": "HILI CCC", "cccCode": "6631104"},
                            {"cccName": "PATIRAM CCC", "cccCode": "6631105"}
                        ]
                    },
                    {
                        "divisionName": "BUNIADPUR DIVISION", "divisionCode": "6632000",
                        "cccs": [
                            {"cccName": "BUNIADPUR CCC", "cccCode": "6632101"},
                            {"cccName": "KUSMANDI CCC", "cccCode": "6632102"},
                            {"cccName": "HARIRAMPUR CCC", "cccCode": "6632103"},
                            {"cccName": "GANGARAMPUR CCC", "cccCode": "6632104"}
                        ]
                    }
                ]
            }
        ];

        // Get references to DOM elements
        const regionSelect = document.getElementById('region-select');
        const divisionSelect = document.getElementById('division-select');
        const cccSelect = document.getElementById('ccc-select');
        const classSelect = document.getElementById('class-select'); // New: Class select element
        const totalMetersCard = document.getElementById('total-meters');
        const totalAgriCard = document.getElementById('total-agri');
        const moreThan10YearsCard = document.getElementById('more-than-10-years');
        const moreThan5YearsCard = document.getElementById('more-than-5-years'); 
        const threePhDefectiveCard = document.getElementById('three-ph-defective'); 
        const industrialDefectiveCard = document.getElementById('industrial-defective'); 
        const reportDateElement = document.getElementById('report-date');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContent = document.getElementById('tab-content');
        const globalLoadingOverlay = document.getElementById('global-loading-overlay'); 
        const yearTabsContainer = document.getElementById('year-tabs-container');
        const metricCards = document.querySelectorAll('.metric-card'); // All metric cards

        // --- ADDED: modal DOM references (fixes runtime errors when opening modals) ---
const cccModalOverlay = document.getElementById('ccc-modal-overlay');
const cccModalTitle = document.getElementById('ccc-modal-title');
const cccModalBody = document.getElementById('ccc-modal-body');

const consumerModalOverlay = document.getElementById('consumer-modal-overlay');
const consumerModalTitle = document.getElementById('consumer-modal-title');
const consumerModalBody = document.getElementById('consumer-modal-body');

// --- ADDED: detail modal DOM references ---
const detailModalOverlay = document.getElementById('detail-modal-overlay');
const detailModalTitle = document.getElementById('detail-modal-title');
const detailModalBody = document.getElementById('detail-modal-body');
        // --- ADDED: event listeners for filters, tabs and metric cards ---
/**
 * Wire up UI interactions: filters, tabs, metric cards.
 */
(function attachUiListeners() {
    // Region -> populate divisions, then filter
    regionSelect.addEventListener('change', () => {
        populateDivisions(regionSelect.value);
        globalLoadingOverlay.classList.add('visible');
        debouncedFilterData();
    });

    // Division -> populate cccs, then filter
    divisionSelect.addEventListener('change', () => {
        populateCccs(divisionSelect.value);
        globalLoadingOverlay.classList.add('visible');
        debouncedFilterData();
    });

    // CCC -> filter
    cccSelect.addEventListener('change', () => {
        globalLoadingOverlay.classList.add('visible');
        debouncedFilterData();
    });

    // Class -> filter
    classSelect.addEventListener('change', () => {
        globalLoadingOverlay.classList.add('visible');
        debouncedFilterData();
    });

    // Tab buttons -> switch active tab and render
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Map button id to renderTabContent tab names
            switch (btn.id) {
                case 'tab-age-analysis':
                    currentActiveTab = 'age-analysis';
                    break;
                case 'tab-ccc-wise':
                    currentActiveTab = 'ccc-wise';
                    break;
                case 'tab-phase-wise':
                    currentActiveTab = 'phase-wise';
                    break;
                case 'tab-by-class':
                default:
                    currentActiveTab = 'by-class';
                    break;
            }

            globalLoadingOverlay.classList.add('visible');
            debouncedRenderTabContent(currentActiveTab);
        });
    });

    // Metric cards -> open CCC-wise modal for that metric
    metricCards.forEach(card => {
        card.addEventListener('click', () => {
            const metricType = card.dataset.metricType;
            if (metricType) {
                renderCccWiseModalContent(metricType);
            }
        });
    });
})();
        /**
         * Debounce utility function to limit how often a function can run.
         * @param {function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {function} The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Parses a date string in YYYYMMDD format into a Date object.
         * @param {string} dateString - The date string to parse.
         * @returns {Date|null} A Date object if parsing is successful, otherwise null.
         */
        function parseDate(dateString) {
            if (!dateString || dateString.length !== 8 || dateString === "00000000") {
                return null;
            }
            const year = parseInt(dateString.substring(0, 4), 10);
            const month = parseInt(dateString.substring(4, 6), 10) - 1; // Month is 0-indexed
            const day = parseInt(dateString.substring(6, 8), 10);
            return new Date(year, month, day);
        }

        /**
         * Formats a Date object into DD-MM-YYYY string format.
         * @param {Date} date - The Date object to format.
         * @returns {string} The formatted date string, or 'N/A' if date is null.
         */
        function formatDateToDDMMYYYY(date) {
            if (!date) return 'N/A';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        /**
         * Populates the region select dropdown.
         */
        function populateRegions() {
            regionSelect.innerHTML = '<option value="">All Regions</option>';
            regionDivisionCccMapping.forEach(region => {
                const option = document.createElement('option');
                option.value = region.regionCode;
                option.textContent = region.regionName;
                regionSelect.appendChild(option);
            });
        }

        /**
         * Populates the division select dropdown based on the selected region.
         * @param {string} selectedRegionCode - The code of the selected region.
         */
        function populateDivisions(selectedRegionCode) {
            divisionSelect.innerHTML = '<option value="">All Divisions</option>';
            divisionSelect.disabled = true;
            cccSelect.innerHTML = '<option value="">All CCCs</option>';
            cccSelect.disabled = true;

            if (selectedRegionCode) {
                const selectedRegion = regionDivisionCccMapping.find(r => r.regionCode === selectedRegionCode);
                if (selectedRegion) {
                    selectedRegion.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.divisionCode;
                        option.textContent = division.divisionName;
                        divisionSelect.appendChild(option);
                    });
                    divisionSelect.disabled = false;
                }
            }
        }

        /**
         * Populates the CCC select dropdown based on the selected division.
         * @param {string} selectedDivisionCode - The code of the selected division.
         */
        function populateCccs(selectedDivisionCode) {
            cccSelect.innerHTML = '<option value="">All CCCs</option>';
            cccSelect.disabled = true;

            if (selectedDivisionCode) {
                let selectedDivision = null;
                // Find the selected division across all regions
                for (const region of regionDivisionCccMapping) {
                    selectedDivision = region.divisions.find(d => d.divisionCode === selectedDivisionCode);
                    if (selectedDivision) break;
                }

                if (selectedDivision) {
                    selectedDivision.cccs.forEach(ccc => {
                        const option = document.createElement('option');
                        option.value = ccc.cccCode;
                        option.textContent = ccc.cccName;
                        cccSelect.appendChild(option);
                    });
                    cccSelect.disabled = false;
                }
            }
        }

        /**
         * Populates the Class select dropdown with unique base classes.
         */
        function populateClasses() {
            const classes = new Set();
            defectiveMeterData.forEach(item => {
                if (item.BASE_CLASS) {
                    classes.add(item.BASE_CLASS);
                }
            });

            const sortedClasses = Array.from(classes).sort(); // Sort classes alphabetically

            classSelect.innerHTML = '<option value="">All Classes</option>';
            sortedClasses.forEach(baseClass => {
                const option = document.createElement('option');
                option.value = baseClass;
                option.textContent = baseClass;
                classSelect.appendChild(option);
            });
        }

        /**
         * Retrieves the CCC name based on its code.
         * @param {string} cccCode - The code of the CCC.
         * @returns {string} The name of the CCC or its code if not found.
         */
        function getCccName(cccCode) {
            for (const region of regionDivisionCccMapping) {
                for (const division of region.divisions) {
                    const ccc = division.cccs.find(c => c.cccCode === cccCode);
                    if (ccc) return ccc.cccName;
                }
            }
            return cccCode; // Return code if name not found
        }

        /**
         * Populates the year tabs based on the available data.
         */
        function populateYearTabs() {
            const years = new Set();
            defectiveMeterData.forEach(item => {
                const defDate = parseDate(item.FIRST_REPORTED_DEF_DT);
                if (defDate) {
                    years.add(defDate.getFullYear());
                }
            });

            const sortedYears = Array.from(years).sort((a, b) => b - a); // Sort years in descending order

            yearTabsContainer.innerHTML = ''; // Clear previous tabs

            // Add "All Years" tab
            const allYearsBtn = document.createElement('button');
            allYearsBtn.classList.add('year-tab-btn');
            allYearsBtn.textContent = 'All Years';
            allYearsBtn.dataset.year = 'All';
            if (currentSelectedYear === 'All') {
                allYearsBtn.classList.add('active');
            }
            yearTabsContainer.appendChild(allYearsBtn);

            // Add individual year tabs
            sortedYears.forEach(year => {
                const button = document.createElement('button');
                button.classList.add('year-tab-btn');
                button.textContent = year;
                button.dataset.year = year;
                if (currentSelectedYear == year) { // Use == for comparison with number
                    button.classList.add('active');
                }
                yearTabsContainer.appendChild(button);
            });

            // Add event listeners to newly created year tabs with debounce
            document.querySelectorAll('.year-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    globalLoadingOverlay.classList.add('visible'); // Show loading overlay immediately
                    document.querySelectorAll('.year-tab-btn').forEach(yBtn => yBtn.classList.remove('active'));
                    this.classList.add('active');
                    currentSelectedYear = this.dataset.year;
                    debouncedFilterData(); // Call debounced filterData
                });
            });
        }

        /**
         * Filters the defective meter data based on selected region, division, CCC, and year.
         * This function is debounced to prevent excessive calls during rapid user input.
         */
        function filterData() {
            const selectedRegionCode = regionSelect.value;
            const selectedDivisionCode = divisionSelect.value;
            const selectedCccCode = cccSelect.value;
            const selectedClass = classSelect.value; // New: Get selected class
            const selectedYear = currentSelectedYear;

            filteredData = defectiveMeterData.filter(item => {
                let matchesRegion = true;
                let matchesDivision = true;
                let matchesCcc = true;
                let matchesClass = true; // New: Class filter flag
                let matchesYear = true;

                // Filter by Region
                if (selectedRegionCode) {
                    const region = regionDivisionCccMapping.find(r => r.regionCode === selectedRegionCode);
                    if (region) {
                        const cccCodesInRegion = region.divisions.flatMap(d => d.cccs.map(c => c.cccCode));
                        matchesRegion = cccCodesInRegion.includes(item.CCC_CODE);
                    } else {
                        matchesRegion = false;
                    }
                }

                // Filter by Division
                if (selectedDivisionCode) {
                    let divisionFound = false;
                    for (const region of regionDivisionCccMapping) {
                        const division = region.divisions.find(d => d.divisionCode === selectedDivisionCode);
                        if (division) {
                            const cccCodesInDivision = division.cccs.map(c => c.cccCode);
                            matchesDivision = cccCodesInDivision.includes(item.CCC_CODE);
                            divisionFound = true;
                            break;
                        }
                    }
                    if (!divisionFound) matchesDivision = false;
                }

                // Filter by CCC
                if (selectedCccCode) {
                    matchesCcc = (item.CCC_CODE === selectedCccCode);
                }

                // New: Filter by Class
                if (selectedClass) {
                    matchesClass = (item.BASE_CLASS === selectedClass);
                }

                // Filter by Year
                if (selectedYear !== 'All') {
                    const itemYear = parseDate(item.FIRST_REPORTED_DEF_DT)?.getFullYear();
                    matchesYear = (itemYear == selectedYear); // Use == for comparison with number
                }

                return matchesRegion && matchesDivision && matchesCcc && matchesClass && matchesYear; // Include new filter
            });

            updateDashboard(); // Update dashboard metrics and tab content after filtering
            globalLoadingOverlay.classList.remove('visible'); // Hide loading overlay after update
        }

        // Debounced version of filterData
        const debouncedFilterData = debounce(filterData, 300); // 300ms delay

        /**
         * Updates the dashboard's metric cards and renders the current tab content.
         */
function updateDashboard() {
    const reportAsOnDateStr = defectiveMeterData.length > 0 ? defectiveMeterData[0].REPORT_AS_ON : null;
    const reportAsOnDate = parseDate(reportAsOnDateStr);
    reportDateElement.textContent = `Updated: ${formatDateToDDMMYYYY(reportAsOnDate)}`;

    totalMetersCard.textContent = filteredData.length.toLocaleString();
    totalAgriCard.textContent = filteredData.filter(item => item.BASE_CLASS === 'A').length.toLocaleString();

    let moreThan10YearsCount = 0;
    let moreThan5YearsCount = 0;
    let threePhDefectiveCount = 0;
    let industrialDefectiveCount = 0;
    let smartMeterCount = 0;

    if (reportAsOnDate) {
        filteredData.forEach(item => {
            const firstReportedDefDate = parseDate(item.FIRST_REPORTED_DEF_DT);
            if (firstReportedDefDate) {
                const diffTime = Math.abs(reportAsOnDate.getTime() - firstReportedDefDate.getTime());
                const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
                if (diffYears > 10) {
                    moreThan10YearsCount++;
                }
                if (diffYears > 5) {
                    moreThan5YearsCount++;
                }
            }

            if (item.PHASE === '3') {
                threePhDefectiveCount++;
            }

            if (item.BASE_CLASS === 'I') {
                industrialDefectiveCount++;
            }

            // Smart Meter logic: Meter number starts with IJ, IL, or IT
            if (/^IJ|^IL|^IT/.test(item.METER_NO || '')) {
                smartMeterCount++;
            }
        });
    }

    moreThan10YearsCard.textContent = moreThan10YearsCount.toLocaleString();
    moreThan5YearsCard.textContent = moreThan5YearsCount.toLocaleString();
    threePhDefectiveCard.textContent = threePhDefectiveCount.toLocaleString();
    industrialDefectiveCard.textContent = industrialDefectiveCount.toLocaleString();

    const smartMeterCard = document.getElementById('smart-meter-count');
    if (smartMeterCard) {
        smartMeterCard.textContent = smartMeterCount.toLocaleString();
    }

    debouncedRenderTabContent(currentActiveTab);
}


        /**
         * Renders the content for the currently active tab.
         * This function is debounced to prevent excessive calls during rapid tab switching.
         * @param {string} tabName - The name of the tab to render ('age-analysis', 'ccc-wise', 'phase-wise', 'by-class').
         */
        function renderTabContent(tabName) {
            let content = '';

            // helper to build month short name consistently
            const monthShort = (date) => date.toLocaleString('en-US', { month: 'short' });

            const totalCount = filteredData.length || 0; // total used to calculate percentages

            if (tabName === 'age-analysis') {
                const counts = {};

                if (currentSelectedYear === 'All') {
                    // Group by year
                    filteredData.forEach(item => {
                        const defDate = parseDate(item.FIRST_REPORTED_DEF_DT);
                        if (defDate) {
                            const year = defDate.getFullYear();
                            counts[year] = (counts[year] || 0) + 1;
                        }
                    });

                    const sortedYears = Object.keys(counts).sort((a, b) => b - a);

                    content = `
                        <div class="table-header">
                            <div class="grid-3">
                                <div>Year</div>
                                <div class="text-right">Count</div>
                                <div class="text-right">%</div>
                            </div>
                        </div>
                        <div class="table-container">
                    `;

                    sortedYears.forEach(year => {
                        const cnt = counts[year] || 0;
                        const pct = totalCount ? ((cnt / totalCount) * 100).toFixed(1) : '0.0';
                        content += `
                            <div class="table-row">
                                <div class="grid-3">
                                    <div class="font-medium">${year}</div>
                                    <div class="text-right font-semibold">${cnt.toLocaleString()}</div>
                                    <div class="text-right">${pct}%</div>
                                </div>
                            </div>
                        `;
                    });

                    content += `</div>`;
                } else {
                    // Group by month
                    const monthOrder = {
                        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                    };

                    filteredData.forEach(item => {
                        const defDate = parseDate(item.FIRST_REPORTED_DEF_DT);
                        if (defDate) {
                            const month = monthShort(defDate);
                            counts[month] = (counts[month] || 0) + 1;
                        }
                    });

                    const sortedMonths = Object.keys(counts).sort((a, b) => monthOrder[a] - monthOrder[b]);

                    content = `
                        <div class="table-header">
                            <div class="grid-3">
                                <div>Month</div>
                                <div class="text-right">Count</div>
                                <div class="text-right">%</div>
                            </div>
                        </div>
                        <div class="table-container">
                    `;

                    sortedMonths.forEach(month => {
                        const cnt = counts[month] || 0;
                        const pct = totalCount ? ((cnt / totalCount) * 100).toFixed(1) : '0.0';
                        content += `
                            <div class="table-row">
                                <div class="grid-3">
                                    <div class="font-medium">${month}</div>
                                    <div class="text-right font-semibold">${cnt.toLocaleString()}</div>
                                    <div class="text-right">${pct}%</div>
                                </div>
                            </div>
                        `;
                    });

                    content += `</div>`;
                }

                tabContent.innerHTML = content;
                globalLoadingOverlay.classList.remove('visible');
            } else if (tabName === 'ccc-wise') {
                const cccCounts = {};
                filteredData.forEach(item => {
                    const cccCode = item.CCC_CODE;
                    cccCounts[cccCode] = (cccCounts[cccCode] || 0) + 1;
                });

                content = `
                    <div class="table-header">
                        <div class="grid-3">
                            <div>Name</div>
                            <div class="text-right">Count</div>
                            <div class="text-right">%</div>
                        </div>
                    </div>
                    <div class="table-container">
                `;

                Object.entries(cccCounts).sort(([,a],[,b]) => b-a).forEach(([cccCode, count]) => {
                    const pct = totalCount ? ((count / totalCount) * 100).toFixed(1) : '0.0';
                    content += `
                        <div class="table-row ccc-row" data-ccc-code="${cccCode}" data-ccc-name="${getCccName(cccCode)}">
                            <div class="grid-3">
                                <div class="truncate">${getCccName(cccCode)}</div>
                                <div class="text-right font-semibold">${count.toLocaleString()}</div>
                                <div class="text-right">${pct}%</div>
                            </div>
                        </div>
                    `;
                });

                content += `</div>`;

            } else if (tabName === 'phase-wise') {
                const phaseCounts = {};
                filteredData.forEach(item => {
                    const phase = item.PHASE || 'N/A';
                    phaseCounts[phase] = (phaseCounts[phase] || 0) + 1;
                });

                content = `
                    <div class="table-header">
                        <div class="grid-3">
                            <div>Phase</div>
                            <div class="text-right">Count</div>
                            <div class="text-right">%</div>
                        </div>
                    </div>
                    <div class="table-container">
                `;

                Object.entries(phaseCounts).sort(([,a],[,b]) => b-a).forEach(([phase, count]) => {
                    const pct = totalCount ? ((count / totalCount) * 100).toFixed(1) : '0.0';
                    content += `
                        <div class="table-row">
                            <div class="grid-3">
                                <div class="font-medium">${phase}</div>
                                <div class="text-right font-semibold">${count.toLocaleString()}</div>
                                <div class="text-right">${pct}%</div>
                            </div>
                        </div>
                    `;
                });

                content += `</div>`;
            } else if (tabName === 'by-class') { 
                const classCounts = {};
                filteredData.forEach(item => {
                    const baseClass = item.BASE_CLASS || 'N/A'; 
                    classCounts[baseClass] = (classCounts[baseClass] || 0) + 1;
                });

                content = `
                    <div class="table-header">
                        <div class="grid-3">
                            <div>Class</div>
                            <div class="text-right">Count</div>
                            <div class="text-right">%</div>
                        </div>
                    </div>
                    <div class="table-container">
                `;

                Object.entries(classCounts).sort(([,a],[,b]) => b-a).forEach(([baseClass, count]) => {
                    const pct = totalCount ? ((count / totalCount) * 100).toFixed(1) : '0.0';
                    content += `
                        <div class="table-row">
                            <div class="grid-3">
                                <div class="font-medium">${baseClass}</div>
                                <div class="text-right font-semibold">${count.toLocaleString()}</div>
                                <div class="text-right">${pct}%</div>
                            </div>
                        </div>
                    `;
                });

                content += `</div>`;
            }

            tabContent.innerHTML = content;

            // Add event listeners for CCC rows in the main tab if it's 'ccc-wise'
            if (tabName === 'ccc-wise') {
                document.querySelectorAll('.ccc-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const cccCode = this.dataset.cccCode;
                        const cccName = this.dataset.cccName;
                        renderConsumerWiseModalContent(cccCode, cccName, 'total'); 
                    });
                });
            }

            globalLoadingOverlay.classList.remove('visible'); // Hide loading overlay after rendering
        }

        // Debounced version of renderTabContent
        const debouncedRenderTabContent = debounce(renderTabContent, 300); // 300ms delay

        /**
         * Opens a modal by adding the 'visible' class.
         * @param {string} modalId - The ID of the modal overlay element.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('visible');
        }

        /**
         * Closes a modal by removing the 'visible' class.
         * @param {string} modalId - The ID of the modal overlay element.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('visible');
        }

        /**
         * Renders the CCC-wise data in a modal based on the clicked metric card.
         * @param {string} metricType - The type of metric clicked ('total', 'agri', 'over10years', 'over5years', '3phase', 'industrial').
         */
function renderCccWiseModalContent(metricType) {
    globalLoadingOverlay.classList.add('visible'); // Show loading overlay immediately

    let modalTitleText = '';
    let dataForModal = [];

    if (metricType === 'total') {
        modalTitleText = 'Total Defective Meters (CCC-wise)';
        dataForModal = filteredData;
    } else if (metricType === 'agri') {
        modalTitleText = 'Agri Meters (CCC-wise)';
        dataForModal = filteredData.filter(item => item.BASE_CLASS === 'A');
    } else if (metricType === 'over10years') {
        modalTitleText = 'Defects >10 Years (CCC-wise)';
        const reportAsOnDate = parseDate(defectiveMeterData[0].REPORT_AS_ON);
        dataForModal = filteredData.filter(item => {
            const firstReportedDefDate = parseDate(item.FIRST_REPORTED_DEF_DT);
            if (firstReportedDefDate && reportAsOnDate) {
                const diffTime = Math.abs(reportAsOnDate.getTime() - firstReportedDefDate.getTime());
                const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
                return diffYears > 10;
            }
            return false;
        });
    } else if (metricType === 'over5years') {
        modalTitleText = 'Defects >5 Years (CCC-wise)';
        const reportAsOnDate = parseDate(defectiveMeterData[0].REPORT_AS_ON);
        dataForModal = filteredData.filter(item => {
            const firstReportedDefDate = parseDate(item.FIRST_REPORTED_DEF_DT);
            if (firstReportedDefDate && reportAsOnDate) {
                const diffTime = Math.abs(reportAsOnDate.getTime() - firstReportedDefDate.getTime());
                const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
                return diffYears > 5;
            }
            return false;
        });
    } else if (metricType === '3phase') {
        modalTitleText = '3-Phase Defective Meters (CCC-wise)';
        dataForModal = filteredData.filter(item => item.PHASE === '3');
    } else if (metricType === 'industrial') {
        modalTitleText = 'Industrial Defective Meters (CCC-wise)';
        dataForModal = filteredData.filter(item => item.BASE_CLASS === 'I');
    } else if (metricType === 'smartmeter') {
        modalTitleText = 'Smart Meters (CCC-wise)';
        dataForModal = filteredData.filter(item => /^(IJ|IL|IT)/.test(item.METER_NO || ''));
    }


    const cccCounts = {};
    dataForModal.forEach(item => {
        const cccCode = item.CCC_CODE;
        cccCounts[cccCode] = (cccCounts[cccCode] || 0) + 1;
    });

    let modalContent = `
        <div class="table-header">
            <div class="grid-2">
                <div>Name</div>
                <div class="text-right">Count</div>
            </div>
        </div>
        <div class="table-container">
    `;

    Object.entries(cccCounts).sort(([,a],[,b]) => b-a).forEach(([cccCode, count]) => {
        modalContent += `
            <div class="table-row ccc-row-modal" data-ccc-code="${cccCode}" data-ccc-name="${getCccName(cccCode)}" data-metric-type="${metricType}">
                <div class="grid-2">
                    <div class="truncate">${getCccName(cccCode)}</div>
                    <div class="text-right font-semibold">${count.toLocaleString()}</div>
                </div>
            </div>
        `;
    });

    modalContent += `</div>`;

    cccModalTitle.textContent = modalTitleText;
    cccModalBody.innerHTML = modalContent;
    openModal('ccc-modal-overlay');

    // Event listeners to show consumer-wise details on CCC row click
    document.querySelectorAll('.ccc-row-modal').forEach(row => {
        row.addEventListener('click', function () {
            const cccCode = this.dataset.cccCode;
            const cccName = this.dataset.cccName;
            const originalMetricType = this.dataset.metricType;
            renderConsumerWiseModalContent(cccCode, cccName, originalMetricType);
        });
    });

    globalLoadingOverlay.classList.remove('visible'); // Hide overlay
}


        /**
         * Renders the consumer-wise data in a modal for a specific CCC.
         * @param {string} cccCode - The CCC code to filter consumers by.
         * @param {string} cccName - The name of the CCC for the modal title.
         * @param {string} originalMetricType - The type of metric that initiated the first modal.
         */
function renderConsumerWiseModalContent(cccCode, cccName, originalMetricType) {
    let consumersInCcc = filteredData.filter(item => item.CCC_CODE === cccCode);
    const reportAsOnDate = parseDate(defectiveMeterData[0].REPORT_AS_ON);

    if (originalMetricType === 'over10years') {
        consumersInCcc = consumersInCcc.filter(item => {
            const firstReportedDefDate = parseDate(item.FIRST_REPORTED_DEF_DT);
            if (firstReportedDefDate && reportAsOnDate) {
                const diffYears = (reportAsOnDate - firstReportedDefDate) / (1000 * 60 * 60 * 24 * 365.25);
                return diffYears > 10;
            }
            return false;
        });
    } else if (originalMetricType === 'over5years') {
        consumersInCcc = consumersInCcc.filter(item => {
            const firstReportedDefDate = parseDate(item.FIRST_REPORTED_DEF_DT);
            if (firstReportedDefDate && reportAsOnDate) {
                const diffYears = (reportAsOnDate - firstReportedDefDate) / (1000 * 60 * 60 * 24 * 365.25);
                return diffYears > 5;
            }
            return false;
        });
    } else if (originalMetricType === '3phase') {
        consumersInCcc = consumersInCcc.filter(item => item.PHASE === '3');
    } else if (originalMetricType === 'agri') {
        consumersInCcc = consumersInCcc.filter(item => item.BASE_CLASS === 'A');
    } else if (originalMetricType === 'industrial') {
        consumersInCcc = consumersInCcc.filter(item => item.BASE_CLASS === 'I');
    } else if (originalMetricType === 'smartmeter') {
        consumersInCcc = consumersInCcc.filter(item => /^(IJ|IL|IT)/.test(item.METER_NO || ''));
    }

    // --- ADDED: sort by FIRST_REPORTED_DEF_DT earliest -> latest; null/invalid dates go to the end ---
    consumersInCcc.sort((a, b) => {
        const da = parseDate(a.FIRST_REPORTED_DEF_DT);
        const db = parseDate(b.FIRST_REPORTED_DEF_DT);
        if (!da && !db) return 0;
        if (!da) return 1; // place invalid/null dates after valid ones
        if (!db) return -1;
        return da - db; // ascending: earliest (smallest) first
    });

    consumerModalTitle.textContent = `${cccName} – Consumers`;

    let modalContent = `
        <div class="table-header">
            <div class="grid-5">
                <div>Name</div>
                <div>Meter No</div>
                <div class="text-right">Reported Date</div>
                <div class="text-right">Class</div>
                <div class="text-right">Load</div>
            </div>
        </div>
        <div class="table-container">
    `;

    consumersInCcc.forEach(item => {
        modalContent += `
            <div class="table-row consumer-row-modal" data-idx="${item.__idx}">
                <div class="grid-5">
                    <div class="truncate">${item.NAME || ''}</div>
                    <div class="truncate">${item.METER_NO || ''}</div>
                    <div class="text-right">${formatDateToDDMMYYYY(parseDate(item.FIRST_REPORTED_DEF_DT))}</div>
                    <div class="text-right">${item.BASE_CLASS || ''}</div>
                    <div class="text-right">${item.CONN_LOAD || ''}</div>
                </div>
            </div>
        `;
    });

    modalContent += `</div>`;
    consumerModalBody.innerHTML = modalContent;
    openModal('consumer-modal-overlay');

    // attach click handlers to consumer rows to open detail modal
    document.querySelectorAll('.consumer-row-modal').forEach(row => {
        row.addEventListener('click', function () {
            const idx = parseInt(this.dataset.idx, 10);
            if (!Number.isNaN(idx)) renderDetailModal(idx);
        });
    });
}

/**
         * Simple CSV parser that returns array of objects using first row as headers.
         * Handles quoted fields and doubled quotes inside quotes.
         * @param {string} text - Raw CSV text
         * @returns {Array<Object>}
         */
        function parseCSV(text) {
            if (!text) return [];
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            const parseLine = (line) => {
                const values = [];
                let cur = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        // If double quotes inside quoted field, consume one and append a quote
                        if (inQuotes && line[i + 1] === '"') {
                            cur += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (ch === ',' && !inQuotes) {
                        values.push(cur);
                        cur = '';
                    } else {
                        cur += ch;
                    }
                }
                values.push(cur);
                return values;
            };

            const headers = parseLine(lines[0]).map(h => h.trim());
            const rows = lines.slice(1);
            const result = rows.map(row => {
                const values = parseLine(row);
                const obj = {};
                headers.forEach((h, idx) => {
                    obj[h] = values[idx] !== undefined ? values[idx] : '';
                });
                return obj;
            });
            return result;
        }

        // Initialize the dashboard when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            globalLoadingOverlay.classList.add('visible'); // Show global loading overlay on initial load

            try {
                // Load a single CSV file from the project root
                const response = await fetch('defective_meter.csv');
                if (!response.ok) {
                    throw new Error(`Failed to fetch defective_meter.csv (${response.status})`);
                }
                const csvText = await response.text();

                // Parse CSV into array of objects. CSV header must match field names used in the script
                defectiveMeterData = parseCSV(csvText);

                // --- ADDED: keep original index for each row so we can open details later ---
                defectiveMeterData.forEach((r, i) => { r.__idx = i; });

                // If there are numeric fields stored as strings and you need conversions,
                // add conversions here (optional). The rest of the code expects keys like:
                // FIRST_REPORTED_DEF_DT, REPORT_AS_ON, CCC_CODE, BASE_CLASS, PHASE, METER_NO, NAME, CONN_LOAD, etc.
                
                populateRegions();
                populateClasses();
                populateYearTabs();
                filterData(); // Initial update

            } catch (error) {
                console.error('Error loading data:', error);
                tabContent.innerHTML = `
                    <div class="text-center py-4">
                        <p class="font-medium text-red-500">Failed to load data</p>
                        <p class="text-gray-500 opacity-70 mt-1">Please ensure defective_meter.csv is present in the project root and correctly formatted.</p>
                    </div>
                `;
            } finally {
                globalLoadingOverlay.classList.remove('visible');
                openModal('suggestion-modal-overlay');
            }
        });

        // --- ADDED: render detail modal for a single row by original index ---
        function renderDetailModal(originalIndex) {
            const row = defectiveMeterData[originalIndex];
            if (!row) return;
            detailModalTitle.textContent = `${row.NAME || row.METER_NO || 'Record Details'}`;

            // Build key/value list (skip __idx)
            let html = `<div class="table-header"><div class="grid-2"><div>Field</div><div class="text-right">Value</div></div></div><div class="table-container">`;
            Object.entries(row).forEach(([k, v]) => {
                if (k === '__idx') return;
                html += `
                    <div class="table-row">
                        <div class="grid-2">
                            <div class="font-medium">${k}</div>
                            <div class="text-right">${String(v ?? '')}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            detailModalBody.innerHTML = html;
            openModal('detail-modal-overlay');
        }

        // --- ADDED: open detail modal on consumer row click in consumer-wise modal ---
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.consumer-row-modal');
            if (target) {
                const idx = target.dataset.idx;
                if (idx) {
                    renderDetailModal(idx);
                }
            }
        });
    </script>

<!-- Suggestion Modal -->
<div id="suggestion-modal-overlay" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header flex justify-between items-center mb-2">
      <h3 class="text-lg font-semibold text-orange-600">Best Practice</h3>
      <button class="text-2xl text-gray-400 hover:text-gray-600" onclick="closeModal('suggestion-modal-overlay')">&times;</button>
    </div>
    <div class="table-container text-sm text-gray-800 px-2">
      <p class="mb-2">To ensure better impact and transparency, prioritize meter replacement as follows:</p>
      <ul class="list-disc pl-6 space-y-1">
        <li><span class="font-medium text-gray-900">Oldest defective meters first</span> – systematically clear cases year-wise from 2011 onward.</li>
        <li><span class="font-medium text-gray-900">3-Phase meters</span> – typically high consumption, requires urgent attention.</li>
        <li><span class="font-medium text-gray-900">High connected load consumers</span> – important focus for prompt visible result.</li>
      </ul>
      <p class="mt-3 italic text-gray-600">This focused approach accelerates grievance resolution and boosts revenue performance.</p>

      <!-- Alert Message for SMs -->
      <div class="mt-4 p-3 rounded border border-red-400 bg-red-100 text-red-700 font-semibold text-sm">
        🔴 <strong>Important:</strong> Ask SMs to test replaced meters under the Test Board at CCC, maintain proper records, and confirm condition before final disposal.  
        Many meters may still be functional, as "defective" inputs by meter-readers may not always be accurate.
      </div>
    </div>
  </div>
</div>


</body>
</html>
