<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Meter Data Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the body using Inter font and a light gray background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Lighter background for a cleaner look */
            color: #343a40; /* Darker text for better contrast */
        }
        /* Container for the main dashboard content, centered with shadow and rounded corners */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff; /* Pure white background */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Stronger, softer shadow */
            border: 1px solid #e9ecef; /* Subtle border */
        }
        /* Styling for the main tab buttons */
        .tab-button {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid #ced4da; /* Default subtle border */
            white-space: nowrap; /* Prevent text wrapping */
            background-color: #e9ecef; /* Light gray background for inactive */
            color: #495057; /* Darker text for inactive */
        }
        /* Active state for the main tab button - SAP blue */
        .tab-button.active {
            background-color: #007bff; /* SAP-like blue */
            color: #fff;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3); /* Blue shadow */
            border-color: #007bff; /* Blue border */
        }
        /* Hover state for inactive main tab buttons */
        .tab-button:not(.active):hover {
            background-color: #dee2e6; /* Slightly darker gray on hover */
            color: #212529; /* Darker text on hover */
            border-color: #adb5bd;
        }
        /* Hidden by default, active main tab content will be displayed */
        .tab-content {
            display: none;
            padding-top: 1.5rem; /* pt-6 */
        }
        /* Active main tab content display */
        .tab-content.active {
            display: block;
        }

        /* Styling for the sub-tab buttons */
        .sub-tab-button {
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid #a2d2ff; /* Lighter blue border */
            white-space: nowrap;
            background-color: #e6f2ff; /* Very light blue background */
            color: #007bff; /* Primary blue text */
            font-size: 0.875rem; /* text-sm */
        }
        /* Active state for the sub-tab button - SAP blue */
        .sub-tab-button.active {
            background-color: #007bff; /* SAP-like blue */
            color: #fff;
            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.2); /* Subtle blue shadow */
            border-color: #007bff;
        }
        /* Hover state for inactive sub-tab buttons */
        .sub-tab-button:not(.active):hover {
            background-color: #cce5ff; /* Slightly darker light blue on hover */
            color: #0056b3; /* Darker blue text on hover */
            border-color: #92c5f7;
        }
        /* Hidden by default, active sub-tab content will be displayed */
        .sub-tab-content {
            display: none;
            padding-top: 1rem; /* pt-4 */
        }
        /* Active sub-tab content display */
        .sub-tab-content.active {
            display: block;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: separate; /* For rounded corners */
            border-spacing: 0; /* Remove default spacing */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Ensures rounded corners are visible */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            border: 1px solid #dee2e6; /* Light gray border */
        }
        /* Table header and data cell padding and alignment */
        th, td {
            padding: 1rem 1.5rem; /* py-4 px-6 */
            text-align: left;
            border-bottom: 1px solid #e9ecef; /* Very light gray border */
        }
        /* Table header specific styling */
        th {
            background-color: #f2f4f6; /* Light gray header background */
            font-weight: 600; /* font-semibold */
            color: #495057; /* Darker gray text */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            letter-spacing: 0.05em; /* tracking-wider */
        }
        /* Remove bottom border from last row's cells */
        tr:last-child td {
            border-bottom: none;
        }
        /* Alternate row background for better readability */
        tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White background for odd rows */
        }
        tbody tr:nth-child(even) {
            background-color: #fcfdfe; /* Very light subtle background for even rows */
        }
        /* Hover effect for table rows */
        tbody tr:hover {
            background-color: #e9f5ff; /* Light blue on hover */
        }
        /* Grand Total Row Styling */
        .font-bold.bg-blue-100 {
            background-color: #d1ecf1; /* Light info blue */
            color: #0c5460; /* Darker info blue text */
            font-weight: 700; /* Bolder */
        }
        .font-bold.bg-blue-100 td {
            border-top: 2px solid #007bff; /* Stronger top border for total row */
        }

        /* Loader spinner styling */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff; /* Match primary blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 2rem auto;
            display: none; /* Hidden by default */
        }
        /* Keyframe animation for the loader spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            display: none; /* Hidden by default */
            max-width: 400px;
            text-align: center;
            border: 1px solid #dc3545; /* Red border for error */
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #dc3545; /* Red for error title */
        }
        .message-box p {
            margin-bottom: 1.5rem;
            color: #495057; /* Dark gray for message content */
        }
        .message-box button {
            background-color: #007bff; /* SAP-like blue */
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message-box button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            .tab-button, .sub-tab-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            th, td {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            /* Make table horizontally scrollable on small screens */
            .overflow-x-auto {
                overflow-x: auto;
            }
            /* Adjust spacing for filter dropdowns */
            .filter-group-container {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }
            .filter-group-container > div {
                width: 100%;
            }
            .filter-group-container select {
                width: 100%;
            }
            /* Adjust button group spacing */
            .flex-wrap {
                justify-content: center;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container">
        <h1 id="dashboard-title" class="text-3xl font-bold text-center mb-6 text-blue-800">Smart Meter Data Dashboard</h1>

        <!-- Filter Group Container -->
        <div class="filter-group-container bg-gray-50 p-6 rounded-lg shadow-inner mb-8 border border-gray-200 flex flex-wrap justify-center gap-4">
            <!-- Filter by Nature of Connection -->
            <div class="text-center">
                <label for="nat-of-conn-filter" class="block text-gray-700 text-lg font-semibold mb-2">Nature of Connection:</label>
                <select id="nat-of-conn-filter" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="ALL">ALL</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Filter by Region -->
            <div class="text-center">
                <label for="region-filter" class="block text-gray-700 text-lg font-semibold mb-2">Region:</label>
                <select id="region-filter" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="ALL">ALL</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Filter by Division -->
            <div class="text-center">
                <label for="division-filter" class="block text-gray-700 text-lg font-semibold mb-2">Division:</label>
                <select id="division-filter" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="ALL">ALL</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- Filter by CCC -->
            <div class="text-center">
                <label for="ccc-filter" class="block text-gray-700 text-lg font-semibold mb-2">CCC:</label>
                <select id="ccc-filter" class="p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="ALL">ALL</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
        </div>

        <!-- Main Tab navigation buttons -->
        <div class="flex justify-center mb-2 bg-gray-200 rounded-lg p-2 space-x-2 flex-wrap">
            <button class="tab-button active" data-tab="region">By Region</button>
            <button class="tab-button" data-tab="division">By Division</button>
            <button class="tab-button" data-tab="ccc">By CCC</button>
        </div>

        <!-- Loader spinner displayed during data fetch and processing -->
        <div id="loader" class="loader"></div>
        
        <!-- Data display area, hidden until data is loaded -->
        <div id="data-display" class="relative">
            <!-- Region Tab Content -->
            <div id="region-tab" class="tab-content active">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700"></h2> <!-- Removed text here -->
                <!-- Sub-tab navigation for Region -->
                <div class="sub-tabs flex justify-center mb-4 bg-gray-100 rounded-lg p-1 space-x-1 flex-wrap">
                    <button class="sub-tab-button active" data-main-tab="region" data-sub-filter-type="all">All</button>
                    <button class="sub-tab-button" data-main-tab="region" data-sub-filter-type="conn_phase">Connection Phase</button>
                    <button class="sub-tab-button" data-main-tab="region" data-sub-filter-type="govt_stat">Govt. Status</button>
                </div>
                <div id="region-sub-content-all" class="sub-tab-content active overflow-x-auto"></div>
                <div id="region-sub-content-conn_phase" class="sub-tab-content overflow-x-auto"></div>
                <div id="region-sub-content-govt_stat" class="sub-tab-content overflow-x-auto"></div>
            </div>

            <!-- Division Tab Content -->
            <div id="division-tab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700"></h2> <!-- Removed text here -->
                <!-- Sub-tab navigation for Division -->
                <div class="sub-tabs flex justify-center mb-4 bg-gray-100 rounded-lg p-1 space-x-1 flex-wrap">
                    <button class="sub-tab-button active" data-main-tab="division" data-sub-filter-type="all">All</button>
                    <button class="sub-tab-button" data-main-tab="division" data-sub-filter-type="conn_phase">Connection Phase</button>
                    <button class="sub-tab-button" data-main-tab="division" data-sub-filter-type="govt_stat">Govt. Status</button>
                </div>
                <div id="division-sub-content-all" class="sub-tab-content active overflow-x-auto"></div>
                <div id="division-sub-content-conn_phase" class="sub-tab-content overflow-x-auto"></div>
                <div id="division-sub-content-govt_stat" class="sub-tab-content overflow-x-auto"></div>
            </div>

            <!-- CCC Tab Content -->
            <div id="ccc-tab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700"></h2> <!-- Removed text here -->
                <!-- Sub-tab navigation for CCC -->
                <div class="sub-tabs flex justify-center mb-4 bg-gray-100 rounded-lg p-1 space-x-1 flex-wrap">
                    <button class="sub-tab-button active" data-main-tab="ccc" data-sub-filter-type="all">All</button>
                    <button class="sub-tab-button" data-main-tab="ccc" data-sub-filter-type="conn_phase">Connection Phase</button>
                    <button class="sub-tab-button" data-main-tab="ccc" data-sub-filter-type="govt_stat">Govt. Status</button>
                </div>
                <div id="ccc-sub-content-all" class="sub-tab-content active overflow-x-auto"></div>
                <div id="ccc-sub-content-conn_phase" class="sub-tab-content overflow-x-auto"></div>
                <div id="ccc-sub-content-govt_stat" class="sub-tab-content overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box for alerts -->
    <div id="message-box-overlay" class="message-box-overlay"></div>
    <div id="message-box" class="message-box">
        <h3 id="message-box-title"></h3>
        <p id="message-box-content"></p>
        <button id="message-box-ok">OK</button>
    </div>

    <script>
        // Data mapping for CCC, Division, and Region codes to their names
        const mapping = {
            "6610000": { // MALDA REGION
                name: "MALDA REGION",
                divisions: {
                    "6611000": {
                        name: "MALDA DIVISION",
                        cccs: {
                            "6611101": "MANIKCHAK CCC",
                            "6611102": "GOLAPGANJ CCC",
                            "6611103": "BAISHNABNAGAR CCC",
                            "6611104": "KALIACHAK CCC",
                            "6611105": "MOTHABARI CCC",
                            "6611106": "SUJAPUR CCC",
                            "6611107": "RATHBARI CCC",
                            "6611108": "FULBARI CCC",
                            "6611109": "MOKDUMPUR CCC"
                        }
                    },
                    "6612000": {
                        name: "CHANCHAL DIVISION",
                        cccs: {
                            "6612101": "BHALUKA CCC",
                            "6612102": "SAMSI CCC",
                            "6612103": "PARANPUR CCC",
                            "6612104": "CHANCHAL CCC",
                            "6612105": "MALATIPUR CCC",
                            "6612106": "HARISHCHANDRAPUR CCC",
                            "6612107": "KUSHIDA CCC"
                        }
                    },
                    "6613000": {
                        name: "GAZOLE DIVISION",
                        cccs: {
                            "6613101": "GAZOL CCC",
                            "6613102": "AIHO CCC",
                            "6613103": "PANDUA CCC",
                            "6613104": "BAMONGOLA CCC",
                            "6613105": "OLD MALDA CCC"
                        }
                    }
                }
            },
            "6620000": { // UTTAR DINAJPUR REGION
                name: "UTTAR DINAJPUR REGION",
                divisions: {
                    "6621000": {
                        name: "RAIGANJ DIVISION",
                        cccs: {
                            "6621101": "ITAHAR CCC",
                            "6621102": "HEMTABAD CCC",
                            "6621103": "KALIYAGANJ CCC",
                            "6621104": "RAIGANJ CCC",
                            "6621105": "BIRNAGAR CCC",
                            "6621106": "KARANDIGHI CCC"
                        }
                    },
                    "6622000": {
                        name: "ISLAMPUR DIVISION",
                        cccs: {
                            "6622101": "ISLAMPUR CCC",
                            "6622102": "CHOPRA CCC",
                            "6622103": "DALKHOLA CCC",
                            "6622104": "GOALPOKHER CCC",
                            "6622105": "KANKI CCC"
                        }
                    }
                }
            },
            "6630000": { // DAKSHIN DINAJPUR REGION
                name: "DAKSHIN DINAJPUR REGION",
                divisions: {
                    "6631000": {
                        name: "BALURGHAT DIVISION",
                        cccs: {
                            "6631101": "BALURGHAT CCC",
                            "6631102": "TAPAN CCC",
                            "6631103": "KUMARGANJ CCC",
                            "6631104": "HILI CCC",
                            "6631105": "PATIRAM CCC"
                        }
                    },
                    "6632000": {
                        name: "BUNIADPUR DIVISION",
                        cccs: {
                            "6632101": "BUNIADPUR CCC",
                            "6632102": "KUSMANDI CCC",
                            "6632103": "HARIRAMPUR CCC",
                            "6632104": "GANGARAMPUR CCC"
                        }
                    }
                }
            }
        };

        // Flat lookup maps for codes to names, populated from the 'mapping' object
        const cccCodeToName = {};
        const divisionCodeToName = {};
        const regionCodeToName = {};

        // Loop through the hierarchical mapping to populate the flat lookup maps
        for (const regionCode in mapping) {
            const region = mapping[regionCode];
            regionCodeToName[regionCode] = region.name;
            for (const divisionCode in region.divisions) {
                const division = region.divisions[divisionCode];
                divisionCodeToName[divisionCode] = division.name;
                for (const cccCode in division.cccs) {
                    cccCodeToName[cccCode] = division.cccs[cccCode];
                }
            }
        }

        // --- Custom Message Box Functions ---
        /**
         * Displays a custom message box with a title and message.
         * @param {string} title - The title of the message box.
         * @param {string} message - The content message to display.
         */
        function showMessageBox(title, message) {
            const messageBox = document.getElementById('message-box');
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-content').textContent = message;
            messageBox.style.display = 'block';
            messageBoxOverlay.style.display = 'block';
        }

        // Event listener for the OK button in the message box to close it
        document.getElementById('message-box-ok').addEventListener('click', () => {
            document.getElementById('message-box').style.display = 'none';
            document.getElementById('message-box-overlay').style.display = 'none';
        });

        // --- Global Variables and Constants ---
        const DATA_SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT14UNb16VXXvprznMsFgOFIKZvENOqHF5OzaECC6O5FbrhMtZel-iPrHPe1jAzHNgHvZ6FTK5yGAtx/pub?gid=0&single=true&output=tsv";
        let allRawData = []; // Stores the raw parsed data from the TSV (complete dataset)
        let filteredData = []; // Stores data after applying all filters

        // Detailed structure for processed data, including sub-filter aggregations
        let processedData = {
            region: {
                all: {}, // Aggregation for all connections in regions (within current NAT_OF_CONN filter)
                conn_phase: {},  // Aggregation for regions by connection phase (within current NAT_OF_CONN filter)
                govt_stat: {}    // Aggregation for regions by govt. status (within current NAT_OF_CONN filter)
            },
            division: {
                all: {},
                conn_phase: {},
                govt_stat: {}
            },
            ccc: {
                all: {},
                conn_phase: {},
                govt_stat: {}
            }
        };

        let baseClasses = new Set(); // Stores all unique BASE_CLASS values encountered in the data
        let natOfConnTypes = new Set(); // Stores all unique NAT_OF_CONN types (for the main filter dropdown)
        let connPhaseTypes = new Set(); // Stores all unique CONN_PHASE types (for sub-tabs)
        let govtStatTypes = new Set(); // Stores all unique GOVT_STAT types (for sub-tabs)

        const loader = document.getElementById('loader'); // HTML element for the loading spinner
        const dataDisplay = document.getElementById('data-display'); // HTML element for the data content area
        const natOfConnFilter = document.getElementById('nat-of-conn-filter'); // HTML element for the filter dropdown
        const regionFilter = document.getElementById('region-filter');
        const divisionFilter = document.getElementById('division-filter');
        const cccFilter = document.getElementById('ccc-filter');


        // --- Loader Visibility Functions ---
        /**
         * Shows the loading spinner and hides the data display area.
         */
        function showLoader() {
            loader.style.display = 'block';
            dataDisplay.style.display = 'none';
        }

        /**
         * Hides the loading spinner and shows the data display area.
         */
        function hideLoader() {
            loader.style.display = 'none';
            dataDisplay.style.display = 'block';
        }

        // --- Data Fetching and Parsing ---
        /**
         * Fetches TSV data from the specified URL using exponential backoff for retries.
         * @param {number} retries - Current retry attempt.
         * @param {number} delay - Current delay before retrying (in ms).
         * @returns {Promise<string>} A promise that resolves with the TSV text.
         */
        async function fetchTsvData(retries = 0, delay = 1000) {
            try {
                const response = await fetch(DATA_SOURCE_URL);
                if (!response.ok) {
                    if (response.status === 429 && retries < 5) { // Too Many Requests, retry up to 5 times
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}s... (Attempt ${retries + 1})`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchTsvData(retries + 1, delay * 2); // Exponential backoff
                    }
                    throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                }
                return await response.text();
            } catch (error) {
                console.error("Error fetching TSV data:", error);
                showMessageBox("Data Fetch Error", `Failed to load data: ${error.message}. Please check your internet connection or try again later.`);
                throw error; // Re-throw to propagate the error
            }
        }

        /**
         * Parses TSV text into an array of JavaScript objects.
         * Each object represents a row, with keys derived from the TSV headers.
         * Handles potential malformed rows by skipping them and logging a warning.
         * @param {string} tsv - The TSV data as a single string.
         * @returns {Array<Object>} An array of objects, where each object corresponds to a row in the TSV.
         */
        function parseTsv(tsv) {
            const lines = tsv.trim().split('\n');
            if (lines.length === 0) {
                console.warn("TSV data is empty.");
                return [];
            }

            const headers = lines[0].split('\t').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t').map(value => value.trim());
                // Ensure the number of values matches the number of headers
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row ${i + 1}: Expected ${headers.length} columns, but got ${values.length}. Row content: "${lines[i]}"`);
                    continue; // Skip this row if it's malformed
                }
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }
            return data;
        }

        // --- Filter Population Functions ---
        /**
         * Populates a given select element with options from a set of types.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         * @param {Set<string>} typesSet - The set of unique types to add as options.
         * @param {Object} [codeToNameMap] - Optional: A map to convert codes to display names.
         */
        function populateFilterDropdown(selectElement, typesSet, codeToNameMap = {}) {
            selectElement.innerHTML = '<option value="ALL">ALL</option>'; // Always start with ALL
            const sortedTypes = Array.from(typesSet).sort();
            sortedTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = codeToNameMap[type] || type; // Use mapped name or raw type
                selectElement.appendChild(option);
            });
        }

        /**
         * Populates the 'Nature of Connection' filter dropdown with unique values from the raw data.
         */
        function populateNatOfConnFilter() {
            natOfConnTypes.clear();
            allRawData.forEach(row => {
                if (row.NAT_OF_CONN) {
                    natOfConnTypes.add(row.NAT_OF_CONN.trim());
                }
            });
            populateFilterDropdown(natOfConnFilter, natOfConnTypes);
        }

        /**
         * Populates the Region filter dropdown with unique regions from the data.
         */
        function populateRegionFilter() {
            const uniqueRegions = new Set();
            allRawData.forEach(row => {
                let foundRegionCode = null;
                let foundInMapping = false; // Declare foundInMapping here
                for (const regionCode of Object.keys(mapping || {})) {
                    const region = mapping[regionCode];
                    if (region && region.divisions) {
                        for (const divCode of Object.keys(region.divisions || {})) {
                            const division = region.divisions[divCode];
                            if (division && division.cccs && division.cccs[row.CCC_CODE]) {
                                foundRegionCode = regionCode;
                                foundInMapping = true;
                                break;
                            }
                        }
                    }
                    if (foundInMapping) break;
                }
                if (foundRegionCode) {
                    uniqueRegions.add(foundRegionCode);
                }
            });
            populateFilterDropdown(regionFilter, uniqueRegions, regionCodeToName);
        }

        /**
         * Populates the Division filter dropdown based on the selected Region.
         */
        function populateDivisionFilter() {
            const selectedRegionCode = regionFilter.value;
            const uniqueDivisions = new Set();

            if (selectedRegionCode === 'ALL') {
                for (const regCode of Object.keys(mapping || {})) {
                    if (mapping[regCode] && mapping[regCode].divisions) {
                        for (const divCode of Object.keys(mapping[regCode].divisions || {})) {
                            uniqueDivisions.add(divCode);
                        }
                    }
                }
            } else {
                if (mapping[selectedRegionCode] && mapping[selectedRegionCode].divisions) {
                    for (const divCode of Object.keys(mapping[selectedRegionCode].divisions || {})) {
                        uniqueDivisions.add(divCode);
                    }
                }
            }
            populateFilterDropdown(divisionFilter, uniqueDivisions, divisionCodeToName);
            populateCccFilter();
        }

        /**
         * Populates the CCC filter dropdown based on the selected Division.
         */
        function populateCccFilter() {
            const selectedRegionCode = regionFilter.value;
            const selectedDivisionCode = divisionFilter.value;
            const uniqueCccs = new Set();

            if (selectedDivisionCode === 'ALL') {
                if (selectedRegionCode === 'ALL') {
                    for (const regCode of Object.keys(mapping || {})) {
                        if (mapping[regCode] && mapping[regCode].divisions) {
                            for (const divCode of Object.keys(mapping[regCode].divisions || {})) {
                                if (mapping[regCode].divisions[divCode] && mapping[regCode].divisions[divCode].cccs) {
                                    for (const cccCode of Object.keys(mapping[regCode].divisions[divCode].cccs || {})) {
                                        uniqueCccs.add(cccCode);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    if (mapping[selectedRegionCode] && mapping[selectedRegionCode].divisions) {
                        for (const divCode of Object.keys(mapping[selectedRegionCode].divisions || {})) {
                            if (mapping[selectedRegionCode].divisions[divCode] && mapping[selectedRegionCode].divisions[divCode].cccs) {
                                for (const cccCode of Object.keys(mapping[selectedRegionCode].divisions[divCode].cccs || {})) {
                                    uniqueCccs.add(cccCode);
                                }
                            }
                        }
                    }
                }
            } else {
                for (const regCode of Object.keys(mapping || {})) {
                    if (selectedRegionCode !== 'ALL' && regCode !== selectedRegionCode) continue;

                    if (mapping[regCode] && mapping[regCode].divisions && mapping[regCode].divisions[selectedDivisionCode]) {
                        if (mapping[regCode].divisions[selectedDivisionCode].cccs) {
                            for (const cccCode of Object.keys(mapping[regCode].divisions[selectedDivisionCode].cccs || {})) {
                                uniqueCccs.add(cccCode);
                            }
                        }
                    }
                }
            }
            populateFilterDropdown(cccFilter, uniqueCccs, cccCodeToName);
        }

        // --- Main Filter Application (Combined Filters) ---
        /**
         * Applies all selected filters (Nature of Connection, Region, Division, CCC)
         * to the raw data and triggers processing/rendering.
         */
        function applyAllFilters() {
            const selectedNatOfConn = natOfConnFilter.value;
            const selectedRegion = regionFilter.value;
            const selectedDivision = divisionFilter.value;
            const selectedCcc = cccFilter.value;

            filteredData = allRawData.filter(row => {
                // Filter by Nature of Connection
                if (selectedNatOfConn !== 'ALL' && (!row.NAT_OF_CONN || row.NAT_OF_CONN.trim() !== selectedNatOfConn)) {
                    return false;
                }

                // Determine the Region, Division, CCC codes for the current row
                let rowRegionCode = null;
                let rowDivisionCode = null;
                let rowCccCode = row.CCC_CODE;

                let foundInMapping = false;
                for (const regCode in (mapping || {})) {
                    const region = mapping[regCode];
                    if (region && region.divisions) {
                        for (const divCode in (region.divisions || {})) {
                            const division = region.divisions[divCode];
                            if (division && division.cccs && division.cccs[row.CCC_CODE]) {
                                rowRegionCode = regCode;
                                rowDivisionCode = divCode;
                                foundInMapping = true;
                                break;
                            }
                        }
                    }
                    if (foundInMapping) break;
                }

                // Filter by Region
                if (selectedRegion !== 'ALL' && rowRegionCode !== selectedRegion) {
                    return false;
                }

                // Filter by Division
                if (selectedDivision !== 'ALL' && rowDivisionCode !== selectedDivision) {
                    return false;
                }

                // Filter by CCC
                if (selectedCcc !== 'ALL' && rowCccCode !== selectedCcc) {
                    return false;
                }

                return true;
            });

            // After filtering, re-process and re-render the tables
            processData();
            renderTables();
            // Ensure the main tab and sub-tab are set to their defaults after filter change
            const currentMainTab = document.querySelector('.tab-button.active')?.dataset.tab || 'region';
            switchTab(currentMainTab); // Re-activate current main tab to reset its sub-tabs
        }

        // --- Data Processing and Aggregation ---
        /**
         * Resets and processes data for all aggregation types (all, conn_phase, govt_stat)
         * across regions, divisions, and CCCs based on the `filteredData`.
         */
        function processData() {
            // Reset processed data and unique types for sub-filters
            processedData = {
                region: { all: {}, conn_phase: {}, govt_stat: {} },
                division: { all: {}, conn_phase: {}, govt_stat: {} },
                ccc: { all: {}, conn_phase: {}, govt_stat: {} }
            };
            baseClasses.clear(); // Clear base classes as they might change with filtered data
            connPhaseTypes.clear();
            govtStatTypes.clear();

            filteredData.forEach(row => { // Now processing `filteredData`
                const cccCode = row.CCC_CODE;
                const baseClass = row.BASE_CLASS ? row.BASE_CLASS.toUpperCase() : 'UNKNOWN_CLASS';
                const connPhase = row.CONN_PHASE ? row.CONN_PHASE.trim() : 'UNKNOWN_CONN_PHASE';
                const govtStat = row.GOVT_STAT ? row.GOVT_STAT.trim() : 'UNKNOWN_GOVT_STAT';

                // Add to unique filter types for sub-tabs
                connPhaseTypes.add(connPhase);
                govtStatTypes.add(govtStat);

                // Add to unique base classes (these are collected from the currently filtered dataset)
                baseClasses.add(baseClass);

                // Default to unknown names if not found in the mapping
                let cccName = `Unknown CCC (${cccCode})`;
                let divisionName = `Unknown Division (N/A)`;
                let regionName = `Unknown Region (N/A)`;

                // Find CCC, Division, and Region names from the hierarchical mapping
                let foundInMapping = false;
                for (const regCode in (mapping || {})) {
                    const region = mapping[regCode];
                    if (region && region.divisions) {
                        for (const divCode in (region.divisions || {})) {
                            const division = region.divisions[divCode];
                            if (division && division.cccs && division.cccs[cccCode]) {
                                cccName = division.cccs[cccCode];
                                divisionName = division.name;
                                regionName = region.name;
                                foundInMapping = true;
                                break;
                            }
                        }
                    }
                    if (foundInMapping) break;
                }

                // --- Aggregate for CCC ---
                // All connections in this CCC (within the current NAT_OF_CONN filter)
                processedData.ccc.all[cccName] = processedData.ccc.all[cccName] || {};
                processedData.ccc.all[cccName][baseClass] = (processedData.ccc.all[cccName][baseClass] || 0) + 1;
                
                // By Connection Phase for this CCC
                if (connPhase !== 'UNKNOWN_CONN_PHASE') {
                    processedData.ccc.conn_phase[connPhase] = processedData.ccc.conn_phase[connPhase] || {};
                    processedData.ccc.conn_phase[connPhase][cccName] = processedData.ccc.conn_phase[connPhase][cccName] || {};
                    processedData.ccc.conn_phase[connPhase][cccName][baseClass] = (processedData.ccc.conn_phase[connPhase][cccName][baseClass] || 0) + 1;
                }

                // By Govt. Status for this CCC
                if (govtStat !== 'UNKNOWN_GOVT_STAT') {
                    processedData.ccc.govt_stat[govtStat] = processedData.ccc.govt_stat[govtStat] || {};
                    processedData.ccc.govt_stat[govtStat][cccName] = processedData.ccc.govt_stat[govtStat][cccName] || {};
                    processedData.ccc.govt_stat[govtStat][cccName][baseClass] = (processedData.ccc.govt_stat[govtStat][cccName][baseClass] || 0) + 1;
                }

                // --- Aggregate for Division ---
                // All connections in this Division (within the current NAT_OF_CONN filter)
                processedData.division.all[divisionName] = processedData.division.all[divisionName] || {};
                processedData.division.all[divisionName][baseClass] = (processedData.division.all[divisionName][baseClass] || 0) + 1;

                // By Connection Phase for this Division
                if (connPhase !== 'UNKNOWN_CONN_PHASE') {
                    processedData.division.conn_phase[connPhase] = processedData.division.conn_phase[connPhase] || {};
                    processedData.division.conn_phase[connPhase][divisionName] = processedData.division.conn_phase[connPhase][divisionName] || {};
                    processedData.division.conn_phase[connPhase][divisionName][baseClass] = (processedData.division.conn_phase[connPhase][divisionName][baseClass] || 0) + 1;
                }

                // By Govt. Status for this Division
                if (govtStat !== 'UNKNOWN_GOVT_STAT') {
                    processedData.division.govt_stat[govtStat] = processedData.division.govt_stat[govtStat] || {};
                    processedData.division.govt_stat[govtStat][divisionName] = processedData.division.govt_stat[govtStat][divisionName] || {};
                    processedData.division.govt_stat[govtStat][divisionName][baseClass] = (processedData.division.govt_stat[govtStat][divisionName][baseClass] || 0) + 1;
                }

                // --- Aggregate for Region ---
                // All connections in this Region (within the current NAT_OF_CONN filter)
                processedData.region.all[regionName] = processedData.region.all[regionName] || {};
                processedData.region.all[regionName][baseClass] = (processedData.region.all[regionName][baseClass] || 0) + 1;

                // By Connection Phase for this Region
                if (connPhase !== 'UNKNOWN_CONN_PHASE') {
                    processedData.region.conn_phase[connPhase] = processedData.region.conn_phase[connPhase] || {};
                    processedData.region.conn_phase[connPhase][regionName] = processedData.region.conn_phase[connPhase][regionName] || {};
                    processedData.region.conn_phase[connPhase][regionName][baseClass] = (processedData.region.conn_phase[connPhase][regionName][baseClass] || 0) + 1;
                }

                // By Govt. Status for this Region
                if (govtStat !== 'UNKNOWN_GOVT_STAT') {
                    processedData.region.govt_stat[govtStat] = processedData.region.govt_stat[govtStat] || {};
                    processedData.region.govt_stat[govtStat][regionName] = processedData.region.govt_stat[govtStat][regionName] || {};
                    processedData.region.govt_stat[govtStat][regionName][baseClass] = (processedData.region.govt_stat[govtStat][regionName][baseClass] || 0) + 1;
                }
            });
        }

        // --- Table Generation ---
        /**
         * Generates an HTML table string from the aggregated data for a specific view.
         * The table includes rows for each unit, columns for each base class, and a total column/row.
         * @param {Object} dataForView - The aggregated data slice for the current view (e.g., `processedData.region.all` or `processedData.region.conn_phase['SINGLE PHASE']`).
         * @param {string} unitNameHeader - The text for the header of the first column (e.g., "Region Name").
         * @returns {string} The complete HTML string representing the table.
         */
        function generateTableHtml(dataForView, unitNameHeader) {
            // Sort base classes alphabetically for consistent column order
            const sortedBaseClasses = Array.from(baseClasses).sort();
            
            let tableHtml = `
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="py-4 px-6 text-sm font-semibold text-gray-700 uppercase tracking-wider">${unitNameHeader}</th>
            `;
            sortedBaseClasses.forEach(className => {
                tableHtml += `<th class="py-4 px-6 text-sm font-semibold text-gray-700 uppercase tracking-wider">${className}</th>`;
            });
            tableHtml += `
                            <th class="py-4 px-6 text-sm font-semibold text-gray-700 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedUnitNames = Object.keys(dataForView).sort();

            sortedUnitNames.forEach(unitName => {
                tableHtml += `<tr>`;
                tableHtml += `<td class="py-4 px-6 text-gray-800">${unitName}</td>`;
                let totalCount = 0; // Initialize total count for the current row/unit
                sortedBaseClasses.forEach(className => {
                    const count = (dataForView[unitName] && dataForView[unitName][className]) || 0; // Get count, default to 0 if not present
                    tableHtml += `<td class="py-4 px-6 text-gray-700">${count}</td>`;
                    totalCount += count; // Add to row total
                });
                tableHtml += `<td class="py-4 px-6 text-gray-900 font-bold">${totalCount}</td>`;
                tableHtml += `</tr>`;
            });

            // --- Grand Total Row ---
            tableHtml += `
                <tr class="font-bold bg-blue-100">
                    <td class="py-4 px-6 text-blue-800">Grand Total</td>
            `;
            let grandTotal = 0; // Initialize grand total for all classes across all units
            sortedBaseClasses.forEach(className => {
                let classTotal = 0;
                sortedUnitNames.forEach(unitName => {
                    classTotal += (dataForView[unitName] && dataForView[unitName][className]) || 0;
                });
                tableHtml += `<td class="py-4 px-6 text-blue-800">${classTotal}</td>`;
                grandTotal += classTotal; // Add to overall grand total
            });
            tableHtml += `<td class="py-4 px-6 text-blue-900">${grandTotal}</td>`;
            tableHtml += `</tr>`;

            tableHtml += `
                    </tbody>
                </table>
            `;
            return tableHtml;
        }

        /**
         * Renders all tables into their respective container elements based on the processedData.
         * This function will populate content for ALL main tabs and ALL sub-tabs.
         */
        function renderTables() {
            // Region Tables
            document.getElementById('region-sub-content-all').innerHTML = generateTableHtml(processedData.region.all, "Region Name");
            // Dynamic sub-sub-tabs for Connection Phase within Region
            const regionConnPhaseContainer = document.getElementById('region-sub-content-conn_phase');
            regionConnPhaseContainer.innerHTML = ''; // Clear previous content
            Array.from(connPhaseTypes).sort().forEach(type => {
                regionConnPhaseContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.region.conn_phase[type] || {}, "Region Name")}
                    </div>
                `;
            });

            // Dynamic sub-sub-tabs for Govt. Status within Region
            const regionGovtStatContainer = document.getElementById('region-sub-content-govt_stat');
            regionGovtStatContainer.innerHTML = ''; // Clear previous content
            Array.from(govtStatTypes).sort().forEach(type => {
                regionGovtStatContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.region.govt_stat[type] || {}, "Region Name")}
                    </div>
                `;
            });

            // Division Tables
            document.getElementById('division-sub-content-all').innerHTML = generateTableHtml(processedData.division.all, "Division Name");
            // Dynamic sub-sub-tabs for Connection Phase within Division
            const divisionConnPhaseContainer = document.getElementById('division-sub-content-conn_phase');
            divisionConnPhaseContainer.innerHTML = ''; // Clear previous content
            Array.from(connPhaseTypes).sort().forEach(type => {
                divisionConnPhaseContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.division.conn_phase[type] || {}, "Division Name")}
                    </div>
                `;
            });
            // Dynamic sub-sub-tabs for Govt. Status within Division
            const divisionGovtStatContainer = document.getElementById('division-sub-content-govt_stat');
            divisionGovtStatContainer.innerHTML = ''; // Clear previous content
            Array.from(govtStatTypes).sort().forEach(type => {
                divisionGovtStatContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.division.govt_stat[type] || {}, "Division Name")}
                    </div>
                `;
            });

            // CCC Tables
            document.getElementById('ccc-sub-content-all').innerHTML = generateTableHtml(processedData.ccc.all, "CCC Name");
            // Dynamic sub-sub-tabs for Connection Phase within CCC
            const cccConnPhaseContainer = document.getElementById('ccc-sub-content-conn_phase');
            cccConnPhaseContainer.innerHTML = ''; // Clear previous content
            Array.from(connPhaseTypes).sort().forEach(type => {
                cccConnPhaseContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.ccc.conn_phase[type] || {}, "CCC Name")}
                    </div>
                `;
            });
            // Dynamic sub-sub-tabs for Govt. Status within CCC
            const cccGovtStatContainer = document.getElementById('ccc-sub-content-govt_stat');
            cccGovtStatContainer.innerHTML = ''; // Clear previous content
            Array.from(govtStatTypes).sort().forEach(type => {
                cccGovtStatContainer.innerHTML += `
                    <h3 class="text-xl font-semibold mb-3 mt-4 text-gray-600">${type}</h3>
                    <div class="overflow-x-auto">
                        ${generateTableHtml(processedData.ccc.govt_stat[type] || {}, "CCC Name")}
                    </div>
                `;
            });
        }

        // --- Tab Switching Logic ---
        /**
         * Controls the visibility of main tab content and the active state of main tab buttons.
         * @param {string} mainTabId - The data-tab attribute value of the main tab to activate (e.g., 'region', 'division', 'ccc').
         */
        function switchTab(mainTabId) {
            // Remove 'active' class from all main tab buttons and content areas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add 'active' class to the selected main tab button and its corresponding content area
            document.querySelector(`.tab-button[data-tab="${mainTabId}"]`).classList.add('active');
            document.getElementById(`${mainTabId}-tab`).classList.add('active');

            // Also, ensure the "All" sub-tab is active for the newly selected main tab
            switchSubTab(mainTabId, 'all');
        }

        /**
         * Controls the visibility of sub-tab content and the active state of sub-tab buttons.
         * @param {string} mainTabId - The ID of the parent main tab (e.g., 'region', 'division', 'ccc').
         * @param {string} subFilterType - The type of sub-filter to activate (e.g., 'all', 'conn_phase', 'govt_stat').
         */
        function switchSubTab(mainTabId, subFilterType) {
            // Remove 'active' class from all sub-tab buttons within the current main tab
            document.querySelectorAll(`#${mainTabId}-tab .sub-tab-button`).forEach(button => {
                button.classList.remove('active');
            });
            // Hide all sub-tab content within the current main tab
            document.querySelectorAll(`#${mainTabId}-tab .sub-tab-content`).forEach(content => {
                content.classList.remove('active');
            });

            // Activate the selected sub-tab button
            document.querySelector(`#${mainTabId}-tab .sub-tab-button[data-sub-filter-type="${subFilterType}"]`).classList.add('active');
            
            // Show the corresponding sub-tab content
            document.getElementById(`${mainTabId}-sub-content-${subFilterType}`).classList.add('active');
        }

        // Add event listeners for all main tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Add event listeners for all sub-tab buttons
        document.querySelectorAll('.sub-tabs .sub-tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchSubTab(button.dataset.mainTab, button.dataset.subFilterType);
            });
        });

        // Add event listeners for the new filter dropdowns
        natOfConnFilter.addEventListener('change', applyAllFilters);
        regionFilter.addEventListener('change', () => {
            populateDivisionFilter(); // Repopulate divisions based on new region selection
            applyAllFilters(); // Apply all filters
        });
        divisionFilter.addEventListener('change', () => {
            populateCccFilter(); // Repopulate CCCs based on new division selection
            applyAllFilters(); // Apply all filters
        });
        cccFilter.addEventListener('change', applyAllFilters);

        /**
         * Finds the maximum DATE_OF_EFFECT from the raw data and updates the dashboard title.
         */
        function updateDashboardTitleWithDate() {
            let maxDate = ''; // Initialize with an empty string for comparison

            allRawData.forEach(row => {
                if (row.DATE_OF_EFFECT && row.DATE_OF_EFFECT.length === 8) {
                    // Assuming YYYYMMDD format, string comparison works for finding max date
                    if (row.DATE_OF_EFFECT > maxDate) {
                        maxDate = row.DATE_OF_EFFECT;
                    }
                }
            });

            const dashboardTitleElement = document.getElementById('dashboard-title');
            if (maxDate) {
                // Format YYYYMMDD to DD/MM/YYYY
                const formattedDate = `${maxDate.substring(6, 8)}/${maxDate.substring(4, 6)}/${maxDate.substring(0, 4)}`;
                dashboardTitleElement.innerHTML = `Smart Meter Data Dashboard <span class="text-xl font-normal">as of ${formattedDate}</span>`;
            } else {
                dashboardTitleElement.innerHTML = `Smart Meter Data Dashboard <span class="text-xl font-normal">(Date Not Available)</span>`;
            }
        }


        // --- Dashboard Initialization ---
        /**
         * Initializes the dashboard: fetches data, processes it, renders tables, and sets the default tab.
         * Handles loading states and error display.
         */
        async function initDashboard() {
            showLoader(); // Display the loading spinner
            try {
                const tsvText = await fetchTsvData(); // Fetch the data
                allRawData = parseTsv(tsvText); // Parse the TSV into an array of objects
                
                // If no data or parsing failed, show an error message and exit
                if (allRawData.length === 0) {
                    showMessageBox("No Data Available", "The dashboard received no data or the data could not be parsed correctly. Please ensure the data source is valid.");
                    hideLoader();
                    return;
                }
                
                populateNatOfConnFilter(); // Populate the NAT_OF_CONN filter dropdown
                populateRegionFilter(); // Populate the Region filter dropdown
                populateDivisionFilter(); // Populate the Division filter dropdown (initially all)
                populateCccFilter(); // Populate the CCC filter dropdown (initially all)

                applyAllFilters(); // Apply all initial filters (which are "ALL" by default)
                updateDashboardTitleWithDate(); // Update the title with the latest date
                switchTab('region'); // Set 'By Region' as the default active main tab
            } catch (error) {
                // Error handling is already done within fetchTsvData.
                console.error("Dashboard initialization failed:", error);
            } finally {
                hideLoader(); // Hide the loader regardless of success or failure
            }
        }

        // Ensure the dashboard initialization runs only after the entire window content is loaded
        window.onload = initDashboard;
    </script>
</body>
</html>
