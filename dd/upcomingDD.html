<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upcoming DD Consumers</title>
<!-- Google Fonts for Inter and proper fallback -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Custom Styles -->
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #111827; /* bg-gray-900 */
    color: #f3f4f6; /* text-gray-100 */
    padding: 1rem; /* p-4 */
    min-height: 100vh;
  }

  /* Generic Utilities */
  .hidden { display: none !important; }
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Typography */
  .page-title {
    margin-bottom: 0.25rem; /* mb-1 */
    font-size: 1.875rem; /* text-3xl */
    line-height: 2.25rem;
    font-weight: 700; /* font-bold */
  }
  .page-subtitle {
    margin-bottom: 1rem; /* mb-4 */
    font-size: 0.875rem; /* text-sm */
    line-height: 1.25rem;
    color: #9ca3af; /* text-gray-400 */
  }

  /* Layout */
  .main-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1rem; /* gap-4 */
    margin-bottom: 1.5rem; /* mb-6 */
  }
  .main-flex-layout {
    display: flex;
    flex-direction: column;
    gap: 1.5rem; /* gap-6 */
    align-items: flex-start;
  }
  @media (max-width: 767px) {
    .main-flex-layout {
      display: flex;
      flex-direction: column;
    }
  }


  /* Summary Cards */
  .summary-card {
    background-color: #1f2937; /* bg-gray-800 */
    padding: 0.5rem; /* p-2 */
    border-radius: 0.75rem; /* rounded-xl */
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
    text-align: center;
  }
  .summary-card-title {
    color: #9ca3af; /* text-gray-400 */
    font-size: 0.75rem; /* text-xs */
  }
  .summary-card-value {
    font-size: 1.25rem; /* text-xl */
    font-weight: 800; /* font-extrabold */
    margin-top: 0;
  }
  .summary-card.clickable {
    cursor: pointer;
  }

  /* New Pulsing Dots Animation */
  .pulsing-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.75rem; /* gap-3 */
    margin-bottom: 0.5rem;
  }
  .pulsing-dots .dot {
    width: 0.75rem; /* w-3 */
    height: 0.75rem; /* h-3 */
    background-color: #60a5fa; /* bg-blue-400 */
    border-radius: 9999px; /* rounded-full */
    animation: pulse 1.4s infinite ease-in-out both;
  }
  .pulsing-dots .dot:nth-child(1) {
    animation-delay: -0.32s;
  }
  .pulsing-dots .dot:nth-child(2) {
    animation-delay: -0.16s;
  }
  @keyframes pulse {
    0%, 80%, 100% {
      transform: scale(0);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.0);
      opacity: 1;
    }
  }
  
  /* Table & Filters */
  .table-container {
    flex-grow: 1;
    width: 100%;
  }
  .filters-and-search {
    margin-bottom: 1rem; /* mb-4 */
    display: flex;
    flex-direction: column;
    gap: 0.5rem; /* space-y-2 */
  }
  .filter-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem; /* gap-2 */
  }
  .filter-btn {
    font-size: 0.875rem; /* text-sm */
    border: 1px solid transparent;
    border-radius: 0.5rem; /* rounded-lg */
    padding: 0.25rem 0.75rem; /* px-3 py-1 */
    background-color: #374151; /* bg-gray-700 */
    color: #e5e7eb; /* text-gray-200 */
    transition: background-color 0.15s;
    cursor: pointer;
  }
  .filter-btn:hover {
    background-color: #4b5563; /* hover:bg-gray-600 */
  }
  .search-container {
    display: flex;
    align-items: center;
    gap: 0.5rem; /* gap-2 */
  }
  .search-input {
    width: 100%;
    background-color: #374151; /* bg-gray-700 */
    color: #f3f4f6; /* text-gray-100 */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #4b5563; /* border-gray-600 */
    padding: 0.5rem 1rem; /* px-4 py-2 */
  }
  .search-input:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    --tw-ring-color: #3b82f6; /* focus:ring-blue-500 */
    box-shadow: 0 0 0 2px var(--tw-ring-color);
    border-color: #3b82f6; /* focus:border-blue-500 */
  }
  .download-btn {
    padding: 0.5rem; /* p-2 */
    background-color: #374151; /* bg-gray-700 */
    color: #34d399; /* text-green-400 */
    border-radius: 0.5rem; /* rounded-lg */
    transition: background-color 0.15s;
    cursor: pointer;
  }
  .download-btn:hover {
    background-color: #16a34a; /* hover:bg-green-600 */
  }
  .summary-btn {
    padding: 0.5rem; /* p-2 */
    background-color: #374151; /* bg-gray-700 */
    color: #60a5fa; /* text-blue-400 */
    border-radius: 0.5rem; /* rounded-lg */
    transition: background-color 0.15s;
    cursor: pointer;
  }
  .summary-btn:hover {
    background-color: #1d4ed8; /* hover:bg-blue-700 */
  }
  .download-btn .lucide {
    width: 1.25rem; /* w-5 */
    height: 1.25rem; /* h-5 */
  }
  .summary-btn .lucide {
    width: 1.25rem; /* w-5 */
    height: 1.25rem; /* h-5 */
  }

  /* Table */
  .table-wrapper {
    overflow-x: auto;
    border-radius: 0.75rem; /* rounded-xl */
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
  }
  .data-table {
    width: 100%;
    font-size: 0.875rem; /* text-sm */
    text-align: left;
    color: #d1d5db; /* text-gray-300 */
  }
  .data-table thead {
    font-size: 0.75rem; /* text-xs */
    color: #f3f4f6; /* text-gray-100 */
    text-transform: uppercase;
    background-color: #374151; /* bg-gray-700 */
  }
  .data-table th[onclick] {
    cursor: pointer;
    transition: background-color 0.15s;
  }
  .data-table th[onclick]:hover {
    background-color: #4b5563; /* hover:bg-gray-600 */
  }
  .sort-indicator {
    display: inline-block;
    margin-left: 0.25rem;
  }
  .data-table th, .data-table td {
    padding: 0.5rem 0.75rem; /* px-3 py-2 */
    white-space: nowrap;
  }
  .data-table tbody {
    background-color: #1f2937; /* bg-gray-800 */
    divide-y: 1px solid #374151; /* divide-y divide-gray-700 */
  }
  .data-table tbody tr {
    border-bottom: 1px solid #374151;
    transition: background-color 0.15s ease-in-out;
  }
  .data-table tbody tr:hover {
    background-color: #374151; /* hover:bg-gray-700 */
  }
  .data-table tbody tr { cursor: pointer; }

  /* Pagination */
  .pagination-nav { margin-top: 1rem; }
  .data-table tfoot tr {
    background-color: #374151; /* bg-gray-700 */
    font-weight: 600; /* font-semibold */
    color: #f3f4f6; /* text-gray-100 */
  }
  /* Summary Modal Tabs */
  .summary-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #374151; /* border-gray-700 */
  }
  .summary-tab-btn {
    padding: 0.5rem 1rem;
    border: none;
    background-color: transparent;
    color: #9ca3af; /* text-gray-400 */
    cursor: pointer;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px; /* To align with the container's border */
    transition: color 0.2s, border-color 0.2s;
  }
  .summary-tab-btn:hover {
    color: #f3f4f6; /* text-gray-100 */
  }
  .summary-tab-btn.active {
    color: #60a5fa; /* text-blue-400 */
    border-color: #60a5fa; /* border-blue-400 */
  }
  /* Sticky header for summary modal table */
  #summaryModal .table-wrapper {
    max-height: 60vh;
    overflow-y: auto;
  }
  #summaryModal .data-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #374151; /* Ensure background is not transparent */
  }
  .pagination-list {
    display: flex;
    justify-content: center;
    font-size: 1rem; /* text-base */
    height: 2.5rem; /* h-10 */
  }
  .pagination-list li:not(:first-child) { margin-left: -1px; }
  .pagination-list a {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 0.75rem;
    height: 2.5rem;
    line-height: 1.25rem;
    color: #9ca3af; /* dark:text-gray-400 */
    background-color: #1f2937; /* dark:bg-gray-800 */
    border: 1px solid #374151; /* dark:border-gray-700 */
    transition: all 0.2s;
  }
  .pagination-list a:hover {
    background-color: #374151; /* dark:hover:bg-gray-700 */
    color: #fff; /* dark:hover:text-white */
  }
  .pagination-list li:first-child a { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
  .pagination-list li:last-child a { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
  .pagination-list a.active {
    z-index: 10;
    color: #fff; /* dark:text-white */
    background-color: #374151; /* dark:bg-gray-700 */
    border-color: #4b5563; /* dark:border-gray-700 */
  }
  .pagination-list a.disabled {
    pointer-events: none;
    opacity: 0.5;
  }

  /* Modals */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 1001; /* Ensure modals appear above loading overlay */
    overflow-y: auto;
  }
  .modal-center-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 1rem 0;
    text-align: center;
  }
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(107, 114, 128, 0.75); /* bg-gray-500 bg-opacity-75 */
    transition: opacity 0.15s;
  }
  .modal-panel {
    display: inline-block;
    vertical-align: middle;
    background-color: #1f2937; /* bg-gray-800 */
    border-radius: 0.5rem; /* rounded-lg */
    text-align: left;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); /* shadow-xl */
    transition: all 0.3s;
    margin: 2rem 0;
    position: relative; /* Ensure z-index works correctly */
    width: 100%;
  }

  /* Responsive Breakpoints */
  @media (min-width: 640px) { /* sm */
    .filters-and-search {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      gap: 0;
    }
    .search-input { width: 16rem; /* sm:w-64 */ }
    .modal-center-container { padding: 0; }
    .modal-panel { max-width: 32rem; /* sm:max-w-lg */ }
  }

  @media (min-width: 768px) { /* md */
    .main-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .summary-card-title { font-size: 0.875rem; }
    .summary-card-value { font-size: 1.5rem; }
    .main-flex-layout { flex-direction: row; }
    .left-pane-container { width: 25%; }
  }
  .loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(17, 24, 39, 0.8);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .page-link {
    transition: all 0.2s;
  }
  /* Additional styles for buttons and specific elements */
  .action-btn { background-color: #2563eb; color: white; padding: 2px 4px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; transition: background-color 0.15s; }
  .action-btn:hover { background-color: #1d4ed8; }
  .action-btn.updated { background-color: #16a34a; }
  .action-btn.updated:hover { background-color: #15803d; }
  .action-btn.disconnected { background-color: #dc2626; } /* New style for disconnected status */
  .action-btn.disconnected:hover { background-color: #b91c1c; }
  .action-btn.disabled { background-color: #4b5563; color: #d1d5db; }
  .action-btn .lucide { width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; margin-right: 4px; }

  /* New Login Page Styles */
  .login-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background-color: #111827; /* bg-gray-900 */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .login-card {
    background-color: #1f2937; /* bg-gray-800 */
    border-radius: 0.75rem; /* rounded-xl */
    padding: 2.5rem; /* p-10 */
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); /* shadow-xl */
    width: 100%;
    max-width: 24rem; /* max-w-sm */
    text-align: center;
  }
  .login-title {
    font-size: 1.5rem; /* text-2xl */
    font-weight: 700; /* font-bold */
    color: #f3f4f6; /* text-gray-100 */
    margin-bottom: 0.5rem; /* mb-2 */
  }
  .login-subtitle {
    font-size: 0.875rem; /* text-sm */
    color: #9ca3af; /* text-gray-400 */
    margin-bottom: 2rem; /* mb-8 */
  }
  .login-input {
    width: 100%;
    background-color: #374151; /* bg-gray-700 */
    color: #f3f4f6; /* text-gray-100 */
    border-radius: 0.5rem; /* rounded-lg */
    border: 1px solid #4b5563; /* border-gray-600 */
    padding: 0.75rem 1rem; /* px-4 py-3 */
    font-size: 1rem;
    box-sizing: border-box; /* Ensure padding is included in width/height */
    text-align: center;
    letter-spacing: 0.5em; /* For PIN-like spacing */
  }
  .login-input:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    --tw-ring-color: #3b82f6; /* focus:ring-blue-500 */
    box-shadow: 0 0 0 2px var(--tw-ring-color);
    border-color: #3b82f6; /* focus:border-blue-500 */
  }
  .login-btn {
    width: 100%;
    margin-top: 1.5rem; /* mt-6 */
    background-color: #2563eb; /* bg-blue-600 */
    color: #fff;
    font-weight: 600; /* font-semibold */
    padding: 0.75rem 1rem; /* Match input padding */
    border-radius: 0.5rem; /* rounded-lg */
    box-sizing: border-box; /* Ensure padding is included in width/height */
    transition: background-color 0.2s;
    cursor: pointer;
  }
  .login-btn:hover {
    background-color: #1d4ed8; /* hover:bg-blue-700 */
  }
  .login-error {
    color: #f87171; /* text-red-400 */
    font-size: 0.875rem; /* text-sm */
    margin-top: 1rem; /* mt-4 */
  }

  /* New Minimal Action Modal Styles */
  .action-modal-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 0.75rem 1rem;
    font-weight: 500;
    border-radius: 0.5rem;
    transition: background-color 0.2s, color 0.2s;
    cursor: pointer;
    border: 1px solid #4b5563; /* border-gray-600 */
  }
  .action-modal-btn .lucide {
    margin-right: 0.5rem;
  }
  .action-modal-btn.live { background-color: #16a34a; color: white; border-color: #16a34a; }
  .action-modal-btn.live:hover { background-color: #15803d; }
  .action-modal-btn.disconnected { background-color: #dc2626; color: white; border-color: #dc2626; }
  .action-modal-btn.disconnected:hover { background-color: #b91c1c; }
  .action-modal-btn.cancel { background-color: transparent; color: #d1d5db; }
  .action-modal-btn.cancel:hover { background-color: #374151; }
</style>
<!-- New Minimal Filter Styles -->
<style>
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem; /* gap-1 */
  }
  .filter-item {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.5rem; /* py-1.5 px-2 */
    border-radius: 0.375rem; /* rounded-md */
    cursor: pointer;
    transition: background-color 0.15s;
    user-select: none;
  }
  .filter-item:hover {
    background-color: #374151; /* hover:bg-gray-700 */
  }
  .filter-item input[type="radio"] {
    display: none;
  }
  .filter-item .custom-checkbox {
    width: 1rem; /* w-4 */
    height: 1rem; /* h-4 */
    border: 2px solid #6b7280; /* border-gray-500 */
    border-radius: 0.25rem; /* rounded-sm */
    margin-right: 0.75rem; /* mr-3 */
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .filter-item input[type="radio"]:checked + .custom-checkbox {
    background-color: #3b82f6; /* bg-blue-500 */
    border-color: #3b82f6; /* border-blue-500 */
  }
  .filter-item input[type="radio"]:checked + .custom-checkbox::after {
    content: '✔';
    color: white;
    font-size: 0.75rem; /* text-xs */
    font-weight: bold;
  }
  .filter-item .label-text {
    font-size: 0.875rem; /* text-sm */
    color: #d1d5db; /* text-gray-300 */
  }
  /* Styles for Region/Division headers to align with checkbox items */
  .ccc-region-title, .ccc-division-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .ccc-region-title .selection-area, .ccc-division-title .selection-area {
    display: flex;
    align-items: center;
    flex-grow: 1;
    padding: 0.375rem 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.15s;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
<!-- PIN Login Modal -->
<div id="loginModal" class="login-overlay">
  <div class="login-card">
    <h3 class="login-title">Dashboard Access</h3>
    <p class="login-subtitle">Please enter your PIN to continue.</p>
    <div>
      <label for="pinInput" class="sr-only">PIN</label>
      <input type="password" id="pinInput" placeholder="••••••" class="login-input" autocomplete="current-password" />
    </div>
    <button id="loginBtn" class="login-btn">Login</button>
    <p id="loginError" class="login-error hidden">Invalid PIN. Please try again.</p>
  </div>
</div>

<h2 id="pageTitle" class="page-title">Upcoming DD Consumers</h2>
<p id="earliestDateHeader" class="page-subtitle"></p>

<!-- Summary Cards -->
<div class="main-grid">
  <div class="summary-card">
    <h5 class="summary-card-title">Total Records</h5>
    <h3 id="totalCount" class="summary-card-value">0</h3>
  </div>
  <div class="summary-card">
    <h5 class="summary-card-title">Total OSD</h5>
    <h3 id="totalOSD" class="summary-card-value">0</h3>
  </div>
  <div class="summary-card">
    <h5 class="summary-card-title">Zero OSD DD</h5>
    <h3 id="zeroOSDCount" class="summary-card-value">0</h3>
  </div>
  <div id="foundLiveCard" class="summary-card clickable"
     onclick="onFoundLiveFilter()">
  <h5 class="summary-card-title">Found LIVE</h5>
  <h3 id="foundLiveCount" class="summary-card-value">0</h3>
</div>

<div id="foundDisconnectedCard" class="summary-card clickable"
     onclick="onFoundDisconnectedFilter()">
  <h5 class="summary-card-title">Found Disconnected</h5>
  <h3 id="foundDisconnectedCount" class="summary-card-value">0</h3>
</div>

</div>

<!-- New Office Dropdown Filters -->
<div id="officeFilters" class="office-filters-container">
  <select id="regionFilter" onchange="onRegionChange()"></select>
  <select id="divisionFilter" onchange="onDivisionChange()"></select>
  <select id="cccFilter" onchange="onCCCChange()"></select>
</div>

<!-- Main Layout Container -->
<div class="main-flex-layout" id="mainLayoutContainer">    
  <!-- Table and Pagination -->
    <div class="table-container">
        <!-- Universal Search and Filter Buttons -->
        <div class="filters-and-search">
        <div class="filter-buttons-container">
<button id="alreadyDDBtn" class="filter-btn" onclick="onAlreadyDDFilter()">
  Already DD (<span id="alreadyDDCount">0</span>)
</button>
<button id="ddTodayBtn" class="filter-btn" onclick="onDDTodayFilter()">
  DD on Today (<span id="ddTodayCount">0</span>)
</button>
<button id="dd7Btn" class="filter-btn" onclick="onDD7Filter()">
  DD in 7 days (<span id="dd7Count">0</span>)
</button>
<button id="dd15Btn" class="filter-btn" onclick="onDD15Filter()">
  DD in 15 days (<span id="dd15Count">0</span>)
</button>
<button id="dd30Btn" class="filter-btn" onclick="onDD30Filter()">
  DD in 30 days (<span id="dd30Count">0</span>)
</button>
<button id="liveBtn" class="filter-btn" onclick="onLiveFilter()">
  Live (<span id="liveBtnCount">0</span>)
</button>
<button id="disconnectedBtn" class="filter-btn" onclick="onDisconnectedFilter()">
  Disconnected (<span id="disconnectedBtnCount">0</span>)
</button>
        </div>
        <div class="search-container">
            <input
            type="text"
            id="universalSearch"
            class="search-input"
            placeholder="Search by any field..."
            oninput="onUniversalSearch()"
            />
            <button id="downloadCsvBtn" title="Download as CSV" onclick="downloadCSV()" class="download-btn">
                <span data-lucide="download" class="lucide"></span>
            </button>
            <button id="viewSummaryBtn" title="View Summary" onclick="showSummaryModal()" class="summary-btn">
                <span data-lucide="bar-chart-2" class="lucide"></span>
            </button>
        </div>
        </div>

        <div class="table-wrapper">
        <table class="data-table">
            <thead>
            <tr>
                <th scope="col" onclick="setSort('CON_ID')">CON_ID<span class="sort-indicator" id="sort-CON_ID"></span></th>
                <th scope="col" onclick="setSort('NAME')">NAME<span class="sort-indicator" id="sort-NAME"></span></th>
                <th scope="col" onclick="setSort('REG_MOB_NO')">Mobile No.<span class="sort-indicator" id="sort-REG_MOB_NO"></span></th>
                <th scope="col" onclick="setSort('BASE_CLASS')">Class<span class="sort-indicator" id="sort-BASE_CLASS"></span></th>
                <th scope="col" onclick="setSort('CONN_PHASE')">Ph<span class="sort-indicator" id="sort-CONN_PHASE"></span></th>
                <th scope="col" onclick="setSort('GOVT_STAT')">Govt.<span class="sort-indicator" id="sort-GOVT_STAT"></span></th>
                <th scope="col" onclick="setSort('CCC_CODE')">CCC Name<span class="sort-indicator" id="sort-CCC_CODE"></span></th>
                <th scope="col" onclick="setSort('dd_due_date')">DD Due Date<span class="sort-indicator" id="sort-dd_due_date"></span></th>
                <th scope="col" onclick="setSort('OUTSTANDING')">OSD<span class="sort-indicator" id="sort-OUTSTANDING"></span></th>
                <th scope="col">Action</th>
            </tr>
            </thead>
            <tbody id="data-body"></tbody>
        </table>
        </div>
        <nav class="pagination-nav">
        <ul class="pagination-list" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-overlay" id="loading" style="display:none;">
  <div class="loading-content">
    <div class="pulsing-dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
    <p class="text-gray-300">Loading...</p>
  </div>
</div>


<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="modal-center-container">
    <div class="modal-backdrop" aria-hidden="true"></div>
    <span class="hidden" aria-hidden="true">&#8203;</span>
    <div class="modal-panel">
      <div style="background-color: #1f2937; padding: 1.5rem 1.5rem 1rem;">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
            <h3 class="text-lg leading-6 font-medium text-gray-100" id="confirmModalTitle">
              Confirm Action
            </h3>
            <div class="mt-2">
              <p class="text-sm text-gray-300" id="confirmModalMessage">
                Are you sure you want to perform this action?
              </p>
            </div>
          </div>
        </div>
      </div>
      <div style="background-color: #374151; padding: 0.75rem 1.5rem; display: flex; flex-direction: row-reverse;">
        <button type="button" id="confirmYesBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
          Yes
        </button>
        <button type="button" id="confirmNoBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          No
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Message Modal -->
<div id="messageModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="modal-center-container">
    <div class="modal-backdrop" aria-hidden="true"></div>
    <div class="modal-panel" style="max-width: 20rem; text-align: center;">
      <div style="background-color: #1f2937; padding: 1.5rem;">
        <h3 class="text-lg leading-6 font-medium text-gray-100 flex items-center justify-center gap-2" id="messageModalTitle">
          <!-- Icon will be injected here if needed -->
          Message
        </h3>
        <div class="mt-2">
          <p class="text-sm text-gray-400" id="messageModalMessage">
            This is a message.
          </p>
        </div>
      </div>
      <div style="background-color: #1f2937; padding: 0 1.5rem 1.5rem;">
        <button type="button" id="messageOkBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Compact Modal for Row Details -->
<div id="rowDetailModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="modal-center-container">
    <div class="modal-backdrop" aria-hidden="true"></div>
    <span class="hidden" aria-hidden="true">&#8203;</span>
    <div class="modal-panel">
      <div style="background-color: #374151; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <h3 class="text-lg leading-6 font-medium text-gray-100" id="rowDetailModalTitle">
          Consumer Details
        </h3>
        <button type="button" class="text-gray-400 hover:text-gray-100 focus:outline-none" onclick="hideModal('rowDetailModal')">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div style="background-color: #1f2937; padding: 1.5rem; font-size: 0.875rem;" id="rowDetailModalBody">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>
</div>

<!-- New Action Modal -->
<div id="actionModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="modal-center-container">
    <div class="modal-backdrop" aria-hidden="true"></div>
    <div class="modal-panel" style="max-width: 20rem; padding: 1.5rem;">
      <h3 class="text-lg font-semibold text-gray-100 text-center mb-4" id="actionModalTitle">
        Update Observation
      </h3>
      <div class="flex flex-col gap-3">
        <button type="button" id="actionLiveBtn" class="action-modal-btn live">
          <span data-lucide="check-circle-2"></span>
          Found Live
        </button>
        <button type="button" id="actionDisconnectedBtn" class="action-modal-btn disconnected">
          <span data-lucide="x-circle"></span>
          Found Disconnected
        </button>
        <button type="button" onclick="hideModal('actionModal')" class="action-modal-btn cancel mt-2">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Summary Table Modal -->
<div id="summaryModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="modal-center-container">
    <div class="modal-backdrop" aria-hidden="true"></div>
    <span class="hidden" aria-hidden="true">&#8203;</span>
    <div class="modal-panel" style="max-width: 56rem;"> <!-- max-w-5xl -->
      <div style="background-color: #374151; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
        <h3 class="text-lg leading-6 font-medium text-gray-100" id="summaryModalTitle">
          Unit-wise Summary
        </h3>
        <button type="button" class="text-gray-400 hover:text-red-500 focus:outline-none" onclick="hideModal('summaryModal')" style="position: relative; z-index: 20;">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div style="background-color: #1f2937; padding: 1.5rem; font-size: 0.875rem;">
        <div class="summary-tabs">
          <button class="summary-tab-btn" onclick="switchSummaryTab('region', this)">Region-wise</button>
          <button class="summary-tab-btn" onclick="switchSummaryTab('division', this)">Division-wise</button>
          <button class="summary-tab-btn" onclick="switchSummaryTab('ccc', this)">CCC-wise</button>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead id="summaryTableHead"></thead>
            <tbody id="summaryTableBody"></tbody>
            <tfoot id="summaryTableFoot"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Supabase configuration
const SUPABASE_URL = "https://unsmtschmcvftfqwabaq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuc210c2NobWN2ZnRmcXdhYmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NzA1MTYsImV4cCI6MjA2OTE0NjUxNn0.X3_q0FyEjam4ct03sjiqINz0_Hfu0AlWgRcymA3us9o";
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
// --- Auth scope (NEW) ---
let AUTH_SCOPE = { dd_view: null, dd_edit: null };
let CAN_EDIT = false;

const cccHierarchy = {
  "6610000": {
    name: "MALDA REGION",
    divisions: {
      "6611000": {
        name: "MALDA DIVISIOIN",
        cccs: {
          "6611101": "MANIKCHAK CCC",
          "6611102": "GOLAPGANJ CCC",
          "6611103": "BAISHNABNAGAR CCC",
          "6611104": "KALIACHAK CCC",
          "6611105": "MOTHABARI CCC",
          "6611106": "SUJAPUR CCC",
          "6611107": "RATHBARI CCC",
          "6611108": "FULBARI CCC",
          "6611109": "MOKDUMPUR CCC"
        }
      },
      "6613000": {
        name: "GAZOLE DIVISIOIN",
        cccs: {
          "6613101": "GAZOL CCC",
          "6613102": "AIHO CCC",
          "6613103": "PANDUA CCC",
          "6613104": "BAMONGOLA CCC",
          "6613105": "OLD MALDA CCC"
        }
      },
      "6612000": {
        name: "CHANCHAL DIVISION",
        cccs: {
          "6612101": "BHALUKA CCC",
          "6612102": "SAMSI CCC",
          "6612103": "PARANPUR CCC",
          "6612104": "CHANCHAL CCC",
          "6612105": "MALATIPUR CCC",
          "6612106": "HARISHCHANDRAPUR CCC",
          "6612107": "KUSHIDA CCC"
        }
      }
    }
  },
  "6620000": {
    name: "UTTAR DINAJPUR REGION",
    divisions: {
      "6621000": {
        name: "RAIGANJ DIVISION",
        cccs: {
          "6621101": "ITAHAR CCC",
          "6621102": "HEMTABAD CCC",
          "6621103": "KALIYAGANJ CCC",
          "6621104": "RAIGANJ CCC",
          "6621105": "BIRNAGAR CCC",
          "6621106": "KARANDIGHI CCC"
        }
      },
      "6622000": {
        name: "ISLAMPUR DIVISION",
        cccs: {
          "6622101": "ISLAMPUR CCC",
          "6622102": "CHOPRA CCC",
          "6622103": "DALKHOLA CCC",
          "6622104": "GOALPOKHER CCC",
          "6622105": "KANKI CCC"
        }
      }
    }
  },
  "6630000": {
    name: "DAKSHIN DINAJPUR REGION",
    divisions: {
      "6631000": {
        name: "BALURGHAT DIVISION",
        cccs: {
          "6631101": "BALURGHAT CCC",
          "6631102": "TAPAN CCC",
          "6631103": "KUMARGANJ CCC",
          "6631104": "HILI CCC",
          "6631105": "PATIRAM CCC"
        }
      },
      "6632000": {
        name: "BUNIADPUR DIVISION",
        cccs: {
          "6632101": "BUNIADPUR CCC",
          "6632102": "KUSMANDI CCC",
          "6632103": "HARIRAMPUR CCC",
          "6632104": "GANGARAMPUR CCC"
        }
      }
    }
  }
};
function getAllowedCCCList(dd_view) {
  if (!dd_view) return [];

  // If 'all', return an empty array meaning no restriction
  if (dd_view.toLowerCase() === "all") return [];

  const allowedCCCs = [];

  // If Region code (ends with 0000)
  if (/^\d{7}$/.test(dd_view) && dd_view.endsWith("0000")) {
    const region = cccHierarchy[dd_view];
    if (region) {
      for (const divisionKey in region.divisions) {
        const division = region.divisions[divisionKey];
        allowedCCCs.push(...Object.keys(division.cccs));
      }
    }
  }
  // If Division code (ends with 000)
  else if (/^\d{7}$/.test(dd_view) && dd_view.endsWith("000")) {
    for (const regionKey in cccHierarchy) {
      const region = cccHierarchy[regionKey];
      if (region.divisions[dd_view]) {
        allowedCCCs.push(...Object.keys(region.divisions[dd_view].cccs));
        break;
      }
    }
  }
  // If CCC code (full 7 digits, specific office)
  else if (/^\d{7}$/.test(dd_view)) {
    allowedCCCs.push(dd_view);
  }

  return allowedCCCs;
}

// Helper to map CCC_CODE to name (without "CCC")
function getCCCName(code) {
    code = String(code);
    // Check if it's a Region code
    if (cccHierarchy[code]) {
        return cccHierarchy[code].name.replace(/ REGION$/i, '');
    }

    // Check if it's a Division or CCC code
    for (const regionKey in cccHierarchy) {
        const region = cccHierarchy[regionKey];
        // Check divisions
        if (region.divisions && region.divisions[code]) {
            return region.divisions[code].name.replace(/ (DIVISION|DIVISIOIN)$/i, '');
        }
        // Check CCCs within divisions
        for (const divisionKey in region.divisions) {
            const division = region.divisions[divisionKey];
            if (division.cccs && division.cccs[code]) {
                return division.cccs[code].replace(" CCC", "");
            }
        }
    }
    return code; // Fallback to code if not found
}

// Helper to group CCC codes by region/division
function groupCCCByHierarchy(cccCodes) {
  const grouped = {};
  for (const regionKey in cccHierarchy) {
    const region = cccHierarchy[regionKey];
    let regionHasAny = false;
    const divisions = {};
    for (const divisionKey in region.divisions) {
      const division = region.divisions[divisionKey];
      const cccs = {};
      for (const cccCode in division.cccs) {
        if (cccCodes.includes(cccCode)) {
          cccs[cccCode] = division.cccs[cccCode];
          regionHasAny = true;
        }
      }
      if (Object.keys(cccs).length > 0) {
        divisions[divisionKey] = { name: division.name, cccs };
      }
    }
    if (regionHasAny) {
      grouped[regionKey] = { name: region.name, divisions };
    }
  }
  return grouped;
}

// --- NEW: Update page title with selected office ---
function updatePageTitle() {
  const titleEl = document.getElementById('pageTitle');
  let officeName = null;

  if (document.getElementById('cccFilter').value) {
    officeName = getCCCName(document.getElementById('cccFilter').value);
  } else if (document.getElementById('divisionFilter').value) {
    officeName = getCCCName(document.getElementById('divisionFilter').value);
  } else if (document.getElementById('regionFilter').value) {
    officeName = getCCCName(document.getElementById('regionFilter').value);
  }
  if (officeName) {
    titleEl.innerText = `Upcoming DD Consumers (${officeName})`;
  } else {
    titleEl.innerText = 'Upcoming DD Consumers';
  }
}
// Helper to format date to DD-MM-YYYY
function formatDate(dateStr) {
  if (!dateStr) return "";
  const [year, month, day] = dateStr.split('-');
  return `${day}-${month}-${year}`;
}
let pendingObservationUpdate = null;

let currentPage = 1;
const rowsPerPage = 20;
let totalRows = 0;
let allCCC = [];
let universalSearchValue = "";
let alreadyDDActive = false;
let alreadyDDCount = 0;
let ddTodayActive = false;
let ddTodayCount = 0;
let dd7Active = false, dd15Active = false, dd30Active = false;
let dd7Count = 0, dd15Count = 0, dd30Count = 0;
let foundLiveActive = false, foundDisconnectedActive = false;
let foundLiveCount = 0, foundDisconnectedCount = 0;
let currentFilteredRows = [];
let liveBtnActive = false, disconnectedBtnActive = false;
let liveBtnCount = 0, disconnectedBtnCount = 0;

let sortColumn = 'OUTSTANDING';
let sortDirection = 'desc';
let summarySort = { column: 'totalInspected', direction: 'desc' };

let allFilteredRowsForSummary = []; // Store all rows for summary modal


// Function to show a custom message modal
function showMessageModal(title, message, icon = null) {
  const titleEl = document.getElementById('messageModalTitle');
  document.getElementById('messageModalMessage').innerText = message;
  
  if (icon) {
    titleEl.innerHTML = `<span data-lucide="${icon}" class="w-5 h-5"></span> ${title}`;
    lucide.createIcons();
  } else {
    titleEl.innerText = title;
  }

  document.getElementById('messageModal').classList.remove('hidden');
}

// Function to show a custom confirmation modal
function showConfirmModal(title, message, onConfirm) {
  document.getElementById('confirmModalTitle').innerText = title;
  document.getElementById('confirmModalMessage').innerText = message;
  document.getElementById('confirmModal').classList.remove('hidden');

  const yesBtn = document.getElementById('confirmYesBtn');
  const noBtn = document.getElementById('confirmNoBtn');

  // Clear previous event listeners
  const newYesBtn = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
  const newNoBtn = noBtn.cloneNode(true);
  noBtn.parentNode.replaceChild(newNoBtn, noBtn);

  newYesBtn.addEventListener('click', () => {
    hideModal('confirmModal');
    onConfirm();
  });

  newNoBtn.addEventListener('click', () => {
    hideModal('confirmModal');
  });
}

// Function to hide a modal
function hideModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// Attach event listeners for modals
document.getElementById('messageOkBtn').addEventListener('click', () => hideModal('messageModal'));

// Fetch all unique CCC_CODEs for the left pane (no row limit)
async function fetchAllCCCFromDB() {
  let all = [];
  let from = 0;
  let step = 1000;
  let keepGoing = true;
  while (keepGoing) {
    let { data, error } = await client
      .from("upcomingdd")
      .select("CCC_CODE")
      .range(from, from + step - 1);
    if (error) {
      console.error(error);
      break;
    }
    if (data.length === 0) break;
    all = all.concat(data);
    if (data.length < step) break;
    from += step;
  }
  // Remove duplicates, convert all codes to string, skip null/empty
  const seen = new Set();
  let unique = [];
  for (const row of all) {
    let val = row.CCC_CODE;
    if (val === null || val === undefined || val === "") continue;
    val = String(val);
    if (!seen.has(val)) {
      seen.add(val);
      unique.push(val);
    }
  }
  return unique;
}

// Function to fetch the earliest DD Due Date
async function fetchEarliestDuedate() {
  const { data, error } = await client
    .from("upcomingdd")
    .select("dd_due_date")
    .order("dd_due_date", { ascending: true })
    .not("dd_due_date", "is", null)
    .limit(1);

  if (error) {
    console.error("Error fetching earliest DD Due Date:", error);
    return null;
  }
  return data.length > 0 ? data[0].dd_due_date : null;
}

// Function to fetch the latest DD Due Date
async function fetchLatestDuedate() {
  const { data, error } = await client
    .from("upcomingdd")
    .select("dd_due_date")
    .order("dd_due_date", { ascending: false })
    .not("dd_due_date", "is", null)
    .limit(1);

  if (error) {
    console.error("Error fetching latest DD Due Date:", error);
    return null;
  }
  return data.length > 0 ? data[0].dd_due_date : null;
}

// Initial load: fetch all CCCs, then render left pane and table
async function initialLoad() {
  showLoading(true);

  // Fetch earliest and latest dates and update the header
  const [earliestDate, latestDate] = await Promise.all([
    fetchEarliestDuedate(),
    fetchLatestDuedate()
  ]);
  if (earliestDate && latestDate) {
    document.getElementById("earliestDateHeader").innerText = `from ${formatDate(earliestDate)} to ${formatDate(latestDate)}`;
  } else if (earliestDate) {
    document.getElementById("earliestDateHeader").innerText = `from ${formatDate(earliestDate)}`;
  } else {
    document.getElementById("earliestDateHeader").innerText = "No upcoming DD dates found.";
  }

  allCCC = await fetchAllCCCFromDB();

  populateRegionFilter();
  updatePageTitle(); // Set initial title
  fetchPage(1);
  // Re-render Lucide icons after everything is loaded
  lucide.createIcons();
}

// --- New Dropdown Filter Logic ---
function populateRegionFilter() {
  const regionFilter = document.getElementById('regionFilter');
  regionFilter.innerHTML = '<option value="">All Regions</option>';

  let availableRegions = new Set();
  if (AUTH_SCOPE?.dd_view && AUTH_SCOPE.dd_view !== 'all') {
    const allowed = new Set(getAllowedCCCList(AUTH_SCOPE.dd_view));
    allCCC = allCCC.filter(c => allowed.has(c));
  }

  const grouped = groupCCCByHierarchy(allCCC);
  for (const regionKey in grouped) {
    availableRegions.add(regionKey);
  }

  for (const regionKey of availableRegions) {
    regionFilter.innerHTML += `<option value="${regionKey}">${cccHierarchy[regionKey].name}</option>`;
  }

  // Pre-selection based on auth scope
  const dd = String(AUTH_SCOPE.dd_view);
  if (/^\d{7}$/.test(dd)) {
    if (dd.endsWith('0000')) { // Region
      regionFilter.value = dd;
    } else if (dd.endsWith('000')) { // Division
      for (const rKey in cccHierarchy) {
        if (cccHierarchy[rKey].divisions[dd]) {
          regionFilter.value = rKey;
          break;
        }
      }
    } else { // CCC
      for (const rKey in cccHierarchy) {
        for (const dKey in cccHierarchy[rKey].divisions) {
          if (cccHierarchy[rKey].divisions[dKey].cccs[dd]) {
            regionFilter.value = rKey;
            break;
          }
        }
      }
    }
  }

  if (AUTH_SCOPE.dd_view && AUTH_SCOPE.dd_view !== 'all' && !dd.endsWith('0000')) {
      regionFilter.disabled = true;
  }

  onRegionChange(true); // Pass flag to handle initial pre-selection
}

function onRegionChange(isInitialLoad = false) {
  const regionKey = document.getElementById('regionFilter').value;
  const divisionFilter = document.getElementById('divisionFilter');
  divisionFilter.innerHTML = '<option value="">All Divisions</option>';

  if (regionKey) {
    const region = cccHierarchy[regionKey];
    const grouped = groupCCCByHierarchy(allCCC);
    const availableDivisions = grouped[regionKey] ? Object.keys(grouped[regionKey].divisions) : [];

    for (const divisionKey of availableDivisions) {
      divisionFilter.innerHTML += `<option value="${divisionKey}">${region.divisions[divisionKey].name}</option>`;
    }
    divisionFilter.disabled = false;
  } else {
    divisionFilter.disabled = true;
  }

  // Pre-selection for division
  const dd = String(AUTH_SCOPE.dd_view);
  if (isInitialLoad && /^\d{7}$/.test(dd)) {
    if (dd.endsWith('000')) { // Division
        divisionFilter.value = dd;
    } else { // CCC
        for (const dKey in cccHierarchy[regionKey]?.divisions) {
            if (cccHierarchy[regionKey].divisions[dKey].cccs[dd]) {
                divisionFilter.value = dKey;
                break;
            }
        }
    }
  }

  if (AUTH_SCOPE.dd_view && AUTH_SCOPE.dd_view !== 'all' && !dd.endsWith('000')) {
      divisionFilter.disabled = true;
  }

  onDivisionChange(isInitialLoad);
}

function onDivisionChange(isInitialLoad = false) {
  const regionKey = document.getElementById('regionFilter').value;
  const divisionKey = document.getElementById('divisionFilter').value;
  const cccFilter = document.getElementById('cccFilter');
  cccFilter.innerHTML = '<option value="">All Offices</option>';

  if (regionKey && divisionKey) {
    const division = cccHierarchy[regionKey].divisions[divisionKey];
    const grouped = groupCCCByHierarchy(allCCC);
    const availableCCCs = grouped[regionKey]?.divisions[divisionKey] ? Object.keys(grouped[regionKey].divisions[divisionKey].cccs) : [];

    for (const cccCode of availableCCCs) {
      cccFilter.innerHTML += `<option value="${cccCode}">${division.cccs[cccCode].replace(" CCC", "")}</option>`;
    }
    cccFilter.disabled = false;
  } else {
    cccFilter.disabled = true;
  }

  // Pre-selection for CCC
  const dd = String(AUTH_SCOPE.dd_view);
  if (isInitialLoad && /^\d{7}$/.test(dd) && !dd.endsWith('000')) {
      cccFilter.value = dd;
  }

  if (AUTH_SCOPE.dd_view && AUTH_SCOPE.dd_view !== 'all' && /^\d{7}$/.test(dd) && !dd.endsWith('000')) {
      cccFilter.disabled = true;
  }

  if (!isInitialLoad) {
    onCCCChange();
  }
}

function onCCCChange() {
  currentPage = 1;
  resetAllDDButtons(); // Reset secondary filters
  updatePageTitle();
  fetchPage(currentPage);
}

// Helper to format numbers as Cr, Lakh, k
function formatAmount(num) {
  num = Number(num);
  if (isNaN(num)) return "";
  if (num >= 1e7) return (num / 1e7).toFixed(2).replace(/\.00$/, "") + " Cr";
  if (num >= 1e5) return (num / 1e5).toFixed(2).replace(/\.00$/, "") + " Lakh";
  if (num >= 1e3) return (num / 1e3).toFixed(2).replace(/\.00$/, "") + "k";
  return num.toString();
}

// --- NEW: Animate numbers counting up ---
function animateCountUp(elementId, endValue, isAmount = false) {
  const element = document.getElementById(elementId);
  if (!element) return;

  // Try to parse the current number, default to 0 if not a number
  const startValueText = element.innerText.replace(/[^0-9.]/g, '');
  let startValue = parseFloat(startValueText) || 0;

  // For formatted amounts like "1.2 Lakh", convert back to a raw number
  if (element.innerText.toLowerCase().includes('cr')) startValue *= 1e7;
  if (element.innerText.toLowerCase().includes('lakh')) startValue *= 1e5;
  if (element.innerText.toLowerCase().includes('k')) startValue *= 1e3;

  const duration = 1500; // Animation duration in ms
  let startTime = null;

  function animation(currentTime) {
    if (startTime === null) startTime = currentTime;
    const progress = Math.min((currentTime - startTime) / duration, 1);
    const currentValue = Math.floor(progress * (endValue - startValue) + startValue);

    element.innerText = isAmount ? formatAmount(currentValue) : currentValue.toLocaleString();

    if (progress < 1) {
      requestAnimationFrame(animation);
    } else {
      element.innerText = isAmount ? formatAmount(endValue) : endValue.toLocaleString();
    }
  }
  requestAnimationFrame(animation);
}
// --- Update fetchPage to use correct logic for DD in X days buttons ---
async function fetchPage(page, isForExport = false) {
  showLoading(true);
  try {
    currentPage = page;
    let from = (page - 1) * rowsPerPage;
    let to = from + rowsPerPage - 1;
    
    let query = client
      .from("upcomingdd")
      .select(
        "CON_ID,NAME,ADDRESS,REG_MOB_NO,BASE_CLASS,CONN_PHASE,GOVT_STAT,NAT_OF_CONN,CONN_LOAD,MRU,METER_NO,discon_dt1,CCC_CODE,OUTSTANDING,dd_due_date,observation",
        { count: "exact" }
      );
    
    const selectedCCC = document.getElementById('cccFilter').value;
    const selectedDivision = document.getElementById('divisionFilter').value;
    const selectedRegion = document.getElementById('regionFilter').value;

    if (selectedCCC) {
      query = query.eq("CCC_CODE", selectedCCC);
    } else if (selectedDivision) {
      const cccList = Object.keys(cccHierarchy[selectedRegion].divisions[selectedDivision].cccs);
      query = query.in("CCC_CODE", cccList);
    } else if (selectedRegion) {
      let cccList = [];
      for (const divisionKey in cccHierarchy[selectedRegion].divisions) {
        const division = cccHierarchy[selectedRegion].divisions[divisionKey];
        cccList = cccList.concat(Object.keys(division.cccs));
      }
      query = query.in("CCC_CODE", cccList);
    }

    // --- SERVER-SIDE FILTERING ---
    const today = todayStr();
    const norm = (s) => (s || "").trim().toLowerCase();

    if (alreadyDDActive) {
      query = query.lt("dd_due_date", today);
    } else if (ddTodayActive) {
      query = query.eq("dd_due_date", today);
    } else if (dd7Active) {
      query = query.gte("dd_due_date", today).lte("dd_due_date", dateOffsetStr(6));
    } else if (dd15Active) {
      query = query.gte("dd_due_date", today).lte("dd_due_date", dateOffsetStr(14));
    } else if (dd30Active) {
      query = query.gte("dd_due_date", today).lte("dd_due_date", dateOffsetStr(29));
    } else if (foundLiveActive || liveBtnActive) {
      query = query.ilike("observation", "%visited, found live%");
    } else if (foundDisconnectedActive || disconnectedBtnActive) {
      query = query.ilike("observation", "%visited, found disconnected%");
    }

    if (universalSearchValue) {
      const searchString = `%${universalSearchValue}%`;
      query = query.or(
        `CON_ID::text.ilike.${searchString},NAME.ilike.${searchString},REG_MOB_NO::text.ilike.${searchString},BASE_CLASS.ilike.${searchString},CONN_PHASE.ilike.${searchString},GOVT_STAT.ilike.${searchString},OUTSTANDING::text.ilike.${searchString},dd_due_date::text.ilike.${searchString}`
      );
    }

    // Apply dynamic sorting
    const isAscending = sortDirection === 'asc';
    query = query.order(sortColumn, { ascending: isAscending });

    if (!isForExport) {
      query = query.range(from, to);
    }

    const { data: pageRows, error, count } = await query;

    if (error) {
      throw error;
    }

    if (isForExport) {
      return pageRows; // Return all data for CSV export
    }

    totalRows = count;
    currentFilteredRows = pageRows; // Store only the current page for modal clicks

    // --- UPDATE DASHBOARD COUNTS ---
    // These counts should reflect the base CCC selection, not the active filters.
    // We'll run a separate, broader query for this, including CCC_CODE for the summary modal.
    let countQuery = client.from("upcomingdd").select("CCC_CODE, dd_due_date, observation, OUTSTANDING", { count: "exact", head: false });

    if (selectedCCC) {
      countQuery = countQuery.eq("CCC_CODE", selectedCCC);
    } else if (selectedDivision) {
      const cccList = Object.keys(cccHierarchy[selectedRegion].divisions[selectedDivision].cccs);
      countQuery = countQuery.in("CCC_CODE", cccList);
    } else if (selectedRegion) {
      let cccList = [];
      for (const divisionKey in cccHierarchy[selectedRegion].divisions) {
        cccList = cccList.concat(Object.keys(cccHierarchy[selectedRegion].divisions[divisionKey].cccs));
      }
      countQuery = countQuery.in("CCC_CODE", cccList);
    }

    // --- FIX: Paginate through all results for accurate counts ---
    let allRows = [];
    let offset = 0;
    const step = 1000; // Supabase's default limit
    while (true) {
      const { data, error: countError } = await countQuery.range(offset, offset + step - 1);
      
      if (countError) {
        throw countError;
      }

      if (data && data.length > 0) {
        allRows = allRows.concat(data);
        offset += data.length;
      }

      if (!data || data.length < step) {
        break; // Exit loop if we've fetched all data
      }
    }

    allFilteredRowsForSummary = allRows; // Store for summary modal
    animateCountUp("totalCount", allRows.length);

    let totalOSD = 0, zeroOSDCount = 0;
    for (const row of allRows) {
      let val = Number(row.OUTSTANDING);
      if (!isNaN(val)) totalOSD += val;
      if (val === 0 || isNaN(val) || row.OUTSTANDING === null) zeroOSDCount++;
    }
    animateCountUp("totalOSD", totalOSD, true);
    animateCountUp("zeroOSDCount", zeroOSDCount);

    alreadyDDCount = allRows.filter(
      (row) => row.dd_due_date && row.dd_due_date < today
    ).length;
    animateCountUp("alreadyDDCount", alreadyDDCount);

    ddTodayCount = allRows.filter(
      (row) => row.dd_due_date && row.dd_due_date === today
    ).length;
    animateCountUp("ddTodayCount", ddTodayCount);

    dd7Count = allRows.filter(row => row.dd_due_date && row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(6)).length;
    animateCountUp("dd7Count", dd7Count);

    dd15Count = allRows.filter(row => row.dd_due_date && row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(14)).length;
    animateCountUp("dd15Count", dd15Count);

    dd30Count = allRows.filter(row => row.dd_due_date && row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(29)).length;
    animateCountUp("dd30Count", dd30Count);

    foundLiveCount = allRows.filter(
      (r) => norm(r.observation) === "visited, found live"
    ).length;
    animateCountUp("foundLiveCount", foundLiveCount);
    
    foundDisconnectedCount = allRows.filter(
      (r) => norm(r.observation) === "visited, found disconnected"
    ).length;
    animateCountUp("foundDisconnectedCount", foundDisconnectedCount);
    animateCountUp("liveBtnCount", foundLiveCount);
    animateCountUp("disconnectedBtnCount", foundDisconnectedCount);

    renderTable(pageRows);
    renderPagination();
    updateSortIndicators();
    lucide.createIcons();
  } catch (err) {
    showMessageModal(
      "Error",
      "Failed to load table data. Please check your connection or try again."
    );
    console.error(err);
    renderTable([]);
    document.getElementById("totalCount").innerText = "0";
    document.getElementById("totalOSD").innerText = "0";
    document.getElementById("zeroOSDCount").innerText = "0";
    document.getElementById("alreadyDDCount").innerText = "0";
    document.getElementById("ddTodayCount").innerText = "0";
    document.getElementById("dd7Count").innerText = "0";
    document.getElementById("dd15Count").innerText = "0";
    document.getElementById("dd30Count").innerText = "0";
    document.getElementById("foundLiveCount").innerText = "0";
    document.getElementById("foundDisconnectedCount").innerText = "0";
    document.getElementById("liveBtnCount").innerText = "0";
    document.getElementById("disconnectedBtnCount").innerText = "0";
    renderPagination();
  } finally {
    showLoading(false);
  }
}

// Update showRowModal to include new fields in the modal
function showRowModal(row) {
  const fields = [
    { label: "CON_ID", value: row.CON_ID },
    { label: "NAME", value: row.NAME },
    { label: "Address", value: row.ADDRESS },
    { label: "Mobile No.", value: row.REG_MOB_NO },
    { label: "Class", value: row.BASE_CLASS },
    { label: "Ph", value: row.CONN_PHASE },
    { label: "Govt.", value: row.GOVT_STAT },
    { label: "Nature of Connection", value: row.NAT_OF_CONN },
    { label: "Load", value: row.CONN_LOAD },
    { label: "MRU", value: row.MRU },
    { label: "Meter No.", value: row.METER_NO },
    { label: "Disconnection Date", value: formatDate(row.discon_dt1) },
    { label: "CCC Name", value: getCCCName(row.CCC_CODE) },
    { label: "DD Due Date", value: formatDate(row.dd_due_date) },
    { label: "OSD", value: formatAmount(row.OUTSTANDING) },
    { label: "Observation", value: row.observation }
  ];
  let html = `<div class="grid grid-cols-2 gap-x-4 gap-y-2">`;
  for (const f of fields) {
    html += `<div class="font-medium text-gray-300">${f.label}:</div><div class="text-right text-gray-100">${f.value ?? ""}</div>`;
  }
  html += `</div>`;
  document.getElementById("rowDetailModalBody").innerHTML = html;
  document.getElementById('rowDetailModal').classList.remove('hidden');
}

// Update renderTable to add row click handler
function renderTable(data) {
  let tbody = document.getElementById("data-body");
  tbody.innerHTML = "";
  const today = todayStr();

  // compute allowed edit scope once
  const allowedSet =
    AUTH_SCOPE?.dd_edit?.toLowerCase() === 'all'
      ? null
      : new Set(getAllowedCCCList(AUTH_SCOPE?.dd_edit));

  // only allow edit if 'all' OR this row's CCC is in the allowed set
  const canEditRow = (row) =>
    AUTH_SCOPE?.dd_edit &&
    (
      AUTH_SCOPE.dd_edit.toLowerCase() === 'all' ||
      (allowedSet && allowedSet.has(String(row.CCC_CODE)))
    );

  data.forEach(row => {
    const ddDueDate = row.dd_due_date ? formatDate(row.dd_due_date) : "";
    const ddDueDateStyle = (row.dd_due_date && row.dd_due_date < today)
      ? 'style="color:#dc2626; font-weight:bold;"'
      : '';

    // inline cell helper
    const editable = (field) =>
      canEditRow(row)
        ? `contenteditable="true" onblur="updateField(${row.CON_ID}, '${field}', this.innerText)"`
        : "";

    // gate the Action button too
// gate the Action button too
    let actionButtonHTML;
    if (row.observation) {
      const observationText = (row.observation || '').toLowerCase();
      if (observationText.includes('live')) {
        actionButtonHTML = `
          <button class="action-btn updated" style="cursor: default;" onclick="event.stopPropagation();">
            <span data-lucide="check-circle" class="lucide"></span>
            <span>Live</span>
          </button>`;
      } else if (observationText.includes('disconnected')) {
        actionButtonHTML = `
          <button class="action-btn disconnected" style="cursor: default;" onclick="event.stopPropagation();">
            <span data-lucide="x-circle" class="lucide"></span>
            <span>Disconnected</span>
          </button>`;
      }
    } else if (canEditRow(row)) { // Only show the editable action button if no observation exists
  actionButtonHTML = `
    <button class="action-btn"
            onclick="event.stopPropagation(); showActionModal(${row.CON_ID})">
      <span data-lucide="edit" class="lucide"></span>
      <span>Action</span>
    </button>`;
} else {
  // Disabled-looking button for unauthorized users
  actionButtonHTML = `
    <button class="action-btn disabled" style="cursor: not-allowed;"
            onclick="event.stopPropagation(); showMessageModal('Not Authorized', 'You do not have permission to perform this action.', 'lock')">
      <span data-lucide="lock" class="lucide"></span>
      <span>Action</span>
    </button>`;
}


    tbody.innerHTML += `
      <tr onclick='showRowModal(${JSON.stringify(row).replace(/'/g, "&apos;")})'>
        <td>${row.CON_ID}</td>
        <td ${editable('NAME')}>${row.NAME || ""}</td>
        <td ${editable('REG_MOB_NO')}>${row.REG_MOB_NO || ""}</td>
        <td ${editable('BASE_CLASS')}>${row.BASE_CLASS || ""}</td>
        <td ${editable('CONN_PHASE')}>${row.CONN_PHASE || ""}</td>
        <td ${editable('GOVT_STAT')}>${row.GOVT_STAT || ""}</td>
        <td>${getCCCName(row.CCC_CODE)}</td>
        <td ${ddDueDateStyle}>${ddDueDate}</td>
        <td>${formatAmount(row.OUTSTANDING)}</td>
        <td>${actionButtonHTML}</td>
      </tr>`;
  });
}

function setSort(column) {
  if (sortColumn === column) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortColumn = column;
    sortDirection = 'desc'; // Default to descending for a new column
  }
  fetchPage(1);
}

function updateSortIndicators() {
  document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
  const indicatorEl = document.getElementById(`sort-${sortColumn}`);
  if (indicatorEl) {
    indicatorEl.textContent = sortDirection === 'asc' ? '▲' : '▼';
  }
}
function renderPagination() {
  let totalPages = Math.ceil(totalRows / rowsPerPage);
  let pagination = document.getElementById("pagination");
  pagination.innerHTML = "";

  if (totalPages <= 1) return;

  const maxPagesToShow = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
  let endPage = startPage + maxPagesToShow - 1;
  if (endPage > totalPages) {
    endPage = totalPages;
    startPage = Math.max(1, endPage - maxPagesToShow + 1);
  }

  // Previous arrow
  pagination.innerHTML += `
    <li>
      <a href="#" onclick="if(${currentPage > 1}) { fetchPage(${currentPage - 1}); }" class="page-link ${currentPage === 1 ? 'disabled' : ''}">&laquo;</a>
    </li>
  `;

  // Page numbers
  for (let i = startPage; i <= endPage; i++) {
    pagination.innerHTML += `
      <li>
        <a href="#" onclick="fetchPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</a>
      </li>
    `;
  }

  // Next arrow
  pagination.innerHTML += `
    <li>
      <a href="#" onclick="if(${currentPage < totalPages}) { fetchPage(${currentPage + 1}); }" class="page-link ${currentPage === totalPages ? 'disabled' : ''}">&raquo;</a>
    </li>
  `;
}

async function updateField(id, field, value) {
  let { error } = await client
    .from("upcomingdd")
    .update({ [field]: value })
    .eq("CON_ID", id);

  if (error) {
    showMessageModal("Error", "Error updating field: " + error.message);
    console.error(error);
  }
}

// Function to show the new action modal
function showActionModal(id) {
  document.getElementById('actionModal').classList.remove('hidden');

  const disconnectedBtn = document.getElementById('actionDisconnectedBtn');
  const liveBtn = document.getElementById('actionLiveBtn');

  // Clear previous event listeners and re-add them to prevent duplicates
  const newDisconnectedBtn = disconnectedBtn.cloneNode(true);
  disconnectedBtn.parentNode.replaceChild(newDisconnectedBtn, disconnectedBtn);
  const newLiveBtn = liveBtn.cloneNode(true);
  liveBtn.parentNode.replaceChild(newLiveBtn, liveBtn);

  newDisconnectedBtn.addEventListener('click', () => {
    hideModal('actionModal');
    // Show confirmation modal before updating observation
    showConfirmModal("Confirm Observation", "Are you sure you want to mark this as 'Visited, found disconnected'?", () => {
      updateObservation(id, 'Visited, found disconnected');
    });
  });

  newLiveBtn.addEventListener('click', () => {
    hideModal('actionModal');
    // Show confirmation modal before updating observation
    showConfirmModal("Confirm Observation", "Are you sure you want to mark this as 'Visited, found live'?", () => {
      updateObservation(id, 'Visited, found live');
    });
  });
}

// Function to update the observation column
async function updateObservation(id, observation) {
  showLoading(true);
  let { error } = await client
    .from("upcomingdd")
    .update({ observation: observation })
    .eq("CON_ID", id);

  if (error) {
    showMessageModal("Error", "Error updating observation: " + error.message);
    console.error(error);
  } else {
    showMessageModal("Success", `Observation updated successfully for CON_ID ${id}.`);
    // Re-fetch the current page to update the table UI
    fetchPage(currentPage);
  }
  showLoading(false);
}

function showLoading(show) {
  const loadingEl = document.getElementById("loading");
  if (show) {
    loadingEl.style.display = "flex";
  } else {
    loadingEl.style.display = "none";
  }
}



// Helper to fetch all OUTSTANDING values for the current filter (in batches)
async function fetchAllOutstandingForFilter() {
  let all = [];
  let from = 0;
  let step = 1000;
  let filterQuery = client
    .from("upcomingdd")
    .select("OUTSTANDING");

  const selectedCCC = document.getElementById('cccFilter').value;
  const selectedDivision = document.getElementById('divisionFilter').value;
  const selectedRegion = document.getElementById('regionFilter').value;

  if (selectedCCC) {
    filterQuery = filterQuery.eq("CCC_CODE", selectedCCC);
  } else if (selectedDivision) {
    const cccList = Object.keys(cccHierarchy[selectedRegion].divisions[selectedDivision].cccs);
    filterQuery = filterQuery.in("CCC_CODE", cccList);
  } else if (selectedRegion) {
    let cccList = [];
    for (const divisionKey in cccHierarchy[selectedRegion].divisions) {
      const division = cccHierarchy[selectedRegion].divisions[divisionKey];
      cccList = cccList.concat(Object.keys(division.cccs));
    }
    filterQuery = filterQuery.in("CCC_CODE", cccList);
  }

  while (true) {
    let { data, error } = await filterQuery.range(from, from + step - 1);
    if (error) {
      console.error(error);
      break;
    }
    if (!data || data.length === 0) break;
    all = all.concat(data);
    if (data.length < step) break;
    from += step;
  }
  return all;
}

// Universal search handler
function onUniversalSearch() {
  universalSearchValue = document.getElementById("universalSearch").value.trim().toLowerCase();
  resetAllDDButtons();
  currentPage = 1;
  fetchPage(currentPage);
}

// Filter button handlers
function onAlreadyDDFilter() {
  const active = !alreadyDDActive;
  resetAllDDButtons();
  alreadyDDActive = active;
  if (alreadyDDActive) {
    document.getElementById("alreadyDDBtn").style.backgroundColor = '#2563eb'; // bg-blue-600
    document.getElementById("alreadyDDBtn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onDDTodayFilter() {
  const active = !ddTodayActive;
  resetAllDDButtons();
  ddTodayActive = active;
  if (ddTodayActive) {
    document.getElementById("ddTodayBtn").style.backgroundColor = '#16a34a'; // bg-green-600
    document.getElementById("ddTodayBtn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onDD7Filter() {
  const active = !dd7Active;
  resetAllDDButtons();
  dd7Active = active;
  if (dd7Active) {
    document.getElementById("dd7Btn").style.backgroundColor = '#ca8a04'; // bg-yellow-600
    document.getElementById("dd7Btn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onDD15Filter() {
  const active = !dd15Active;
  resetAllDDButtons();
  dd15Active = active;
  if (dd15Active) {
    document.getElementById("dd15Btn").style.backgroundColor = '#0891b2'; // bg-cyan-600
    document.getElementById("dd15Btn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onDD30Filter() {
  const active = !dd30Active;
  resetAllDDButtons();
  dd30Active = active;
  if (dd30Active) {
    document.getElementById("dd30Btn").style.backgroundColor = '#6b7280'; // bg-gray-500
    document.getElementById("dd30Btn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}
function onFoundLiveFilter() {
  const active = !foundLiveActive;
  resetAllDDButtons();
  foundLiveActive = active;
  if (foundLiveActive) {
    const el = document.getElementById("foundLiveCard");
    el.style.backgroundColor = '#15803d'; // bg-green-700
    el.style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}
function onLiveFilter() {
  const active = !liveBtnActive;
  resetAllDDButtons();
  liveBtnActive = active;
  if (liveBtnActive) {
    document.getElementById("liveBtn").style.backgroundColor = '#16a34a'; // bg-green-600
    document.getElementById("liveBtn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onDisconnectedFilter() {
  const active = !disconnectedBtnActive;
  resetAllDDButtons();
  disconnectedBtnActive = active;
  if (disconnectedBtnActive) {
    document.getElementById("disconnectedBtn").style.backgroundColor = '#dc2626'; // bg-red-600
    document.getElementById("disconnectedBtn").style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

function onFoundDisconnectedFilter() {
  const active = !foundDisconnectedActive;
  resetAllDDButtons();
  foundDisconnectedActive = active;
  if (foundDisconnectedActive) {
    const el = document.getElementById("foundDisconnectedCard");
    el.style.backgroundColor = '#b91c1c'; // bg-red-700
    el.style.color = '#fff';
  }
  universalSearchValue = "";
  document.getElementById("universalSearch").value = "";
  currentPage = 1;
  fetchPage(currentPage);
}

// Reset all DD filter buttons to default state
function resetAllDDButtons() {
  alreadyDDActive = false;
  ddTodayActive = false;
  dd7Active = false;
  dd15Active = false;
  dd30Active = false;
  foundLiveActive = false;
  foundDisconnectedActive = false;
  liveBtnActive = false;
  disconnectedBtnActive = false;

  document.querySelectorAll('#alreadyDDBtn, #ddTodayBtn, #dd7Btn, #dd15Btn, #dd30Btn').forEach(btn => {
    btn.style.backgroundColor = '';
    btn.style.color = '';
  });

  document.getElementById("foundLiveCard").style.backgroundColor = '';
  document.getElementById("foundLiveCard").style.color = '';
  document.getElementById("foundDisconnectedCard").style.backgroundColor = '';
  document.getElementById("foundDisconnectedCard").style.color = '';

  document.getElementById("liveBtn").style.backgroundColor = '';
  document.getElementById("liveBtn").style.color = '';
  document.getElementById("disconnectedBtn").style.backgroundColor = '';
  document.getElementById("disconnectedBtn").style.color = '';
}

async function downloadCSV() {
  showMessageModal("Info", "Preparing download... This may take a moment for large datasets.");
  
  // Fetch all data matching the current filters, without pagination
  const dataToExport = await fetchPage(1, true);

  hideModal('messageModal');

  if (!dataToExport || dataToExport.length === 0) {
    showMessageModal("Info", "No data to download.");
    return;
  }
  
  // Define headers.
  const headers = [
    "CON_ID", "NAME", "ADDRESS", "MRU", "REG_MOB_NO", "BASE_CLASS", "CONN_PHASE",
    "GOVT_STAT", "NAT_OF_CONN", "CONN_LOAD", "METER_NO", "discon_dt1", "CCC_CODE",
    "CCC_NAME", "OUTSTANDING", "dd_due_date", "observation"
  ];

  // Helper to escape CSV values
  const escapeCsvValue = (value) => {
    if (value === null || value === undefined) return "";
    value = String(value);
    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
      value = value.replace(/"/g, '""');
      return `"${value}"`;
    }
    return value;
  };

  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += headers.join(",") + "\r\n";

  dataToExport.forEach(row => {
    const rowData = [
      escapeCsvValue(row.CON_ID), escapeCsvValue(row.NAME), escapeCsvValue(row.ADDRESS),
      escapeCsvValue(row.MRU),
      escapeCsvValue(row.REG_MOB_NO), escapeCsvValue(row.BASE_CLASS), escapeCsvValue(row.CONN_PHASE),
      escapeCsvValue(row.GOVT_STAT), escapeCsvValue(row.NAT_OF_CONN), escapeCsvValue(row.CONN_LOAD),
      escapeCsvValue(row.METER_NO),
      escapeCsvValue(row.discon_dt1 ? formatDate(row.discon_dt1) : ''),
      escapeCsvValue(row.CCC_CODE), escapeCsvValue(getCCCName(row.CCC_CODE)),
      escapeCsvValue(row.OUTSTANDING),
      escapeCsvValue(row.dd_due_date ? formatDate(row.dd_due_date) : ''),
      escapeCsvValue(row.observation)
    ];
    csvContent += rowData.join(",") + "\r\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  const today = new Date().toISOString().slice(0, 10);
  link.setAttribute("download", `upcoming_dd_export_${today}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// --- Summary Modal Logic ---
let currentSummaryLevel = 'region'; // Default summary level
async function showSummaryModal() {
  showLoading(true);
  try {
    const selectedRegion = document.getElementById('regionFilter').value;
    const selectedDivision = document.getElementById('divisionFilter').value;
    const selectedCCC = document.getElementById('cccFilter').value;

    // Determine initial tab based on main filter selection
    if (selectedCCC || selectedDivision) currentSummaryLevel = 'ccc';
    else if (selectedRegion) currentSummaryLevel = 'division';
    else currentSummaryLevel = 'region';

    // Generate and render the summary for the determined level
    generateAndRenderSummary(currentSummaryLevel);
    document.getElementById('summaryModal').classList.remove('hidden');

  } catch (e) {
    console.error("Error generating summary:", e);
    showMessageModal("Error", "Could not generate summary. Please try again.");
  } finally {
    showLoading(false);
    lucide.createIcons();
  }
}

function switchSummaryTab(level, tabElement) {
  currentSummaryLevel = level;
  generateAndRenderSummary(level);
  // Update active tab style
  document.querySelectorAll('.summary-tab-btn').forEach(btn => btn.classList.remove('active'));
  tabElement.classList.add('active');
}

function generateAndRenderSummary(summaryLevel) {
  let units = {};
  let tableTitle = "Unit";

  if (summaryLevel === 'region') {
    units = cccHierarchy;
    tableTitle = "Region";
  } else if (summaryLevel === 'division') {
    for (const rKey in cccHierarchy) {
      Object.assign(units, cccHierarchy[rKey].divisions);
    }
    tableTitle = "Division";
  } else if (summaryLevel === 'ccc') {
    for (const rKey in cccHierarchy) {
      for (const dKey in cccHierarchy[rKey].divisions) {
        Object.assign(units, cccHierarchy[rKey].divisions[dKey].cccs);
      }
    }
    tableTitle = "CCC";
  }

  const summaryData = {};
  const today = todayStr();
  const norm = (s) => (s || "").trim().toLowerCase();

  for (const row of allFilteredRowsForSummary) {
    const unitKey = findUnitKey(row.CCC_CODE, summaryLevel);
    if (!unitKey) continue;

    if (!summaryData[unitKey]) {
      summaryData[unitKey] = { total: 0, alreadyDD: 0, live: 0, disconnected: 0 };
    }
    summaryData[unitKey].total++;
    if (row.dd_due_date && row.dd_due_date < today) summaryData[unitKey].alreadyDD++;
    if (norm(row.observation) === "visited, found live") summaryData[unitKey].live++;
    if (norm(row.observation) === "visited, found disconnected") summaryData[unitKey].disconnected++;
  }

  const totals = { total: 0, alreadyDD: 0, live: 0, disconnected: 0 };
  for (const key in summaryData) {
    totals.total += summaryData[key].total;
    totals.alreadyDD += summaryData[key].alreadyDD;
    totals.live += summaryData[key].live;
    totals.disconnected += summaryData[key].disconnected;
  }

  renderSummaryTable(summaryData, units, tableTitle, totals);
}

function setSummarySort(column) {
  if (summarySort.column === column) {
    summarySort.direction = summarySort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    summarySort.column = column;
    // Default sort direction based on column type
    summarySort.direction = column === 'name' ? 'asc' : 'desc';
  }
  // Re-render the current tab with the new sort order
  generateAndRenderSummary(currentSummaryLevel);
}


// Helper to get today's date in YYYY-MM-DD
function todayStr() {
  const d = new Date();
  return d.toISOString().slice(0, 10);
}

// Helper to get date string offset by days
function dateOffsetStr(days) {
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0, 10);
}

function findUnitKey(cccCode, level) {
  for (const rKey in cccHierarchy) {
    if (level === 'region') {
      for (const dKey in cccHierarchy[rKey].divisions) {
        if (cccHierarchy[rKey].divisions[dKey].cccs[cccCode]) return rKey;
      }
    } else { // level is 'division' or 'ccc'
      for (const dKey in cccHierarchy[rKey].divisions) {
        if (level === 'division') {
          if (cccHierarchy[rKey].divisions[dKey].cccs[cccCode]) return dKey;
        } else { // level is 'ccc'
          if (cccHierarchy[rKey].divisions[dKey].cccs[cccCode]) return cccCode;
        }
      }
    }
  }
  return null;
}

function renderSummaryTable(data, units, title, totals) {
  const head = document.getElementById('summaryTableHead');
  const body = document.getElementById('summaryTableBody');
  const foot = document.getElementById('summaryTableFoot');

  // Update active tab style
  document.querySelectorAll('.summary-tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.summary-tab-btn[onclick*="'${currentSummaryLevel}'"]`).classList.add('active');

  const getIndicator = (col) => {
    if (summarySort.column === col) {
      return summarySort.direction === 'asc' ? '▲' : '▼';
    }
    return '';
  };

  head.innerHTML = `
    <tr>
      <th onclick="setSummarySort('name')">${title}<span class="sort-indicator">${getIndicator('name')}</span></th>
      <th onclick="setSummarySort('total')">Total Count<span class="sort-indicator">${getIndicator('total')}</span></th>
      <th onclick="setSummarySort('alreadyDD')">Already DD<span class="sort-indicator">${getIndicator('alreadyDD')}</span></th>
      <th onclick="setSummarySort('totalInspected')">Total Inspected<span class="sort-indicator">${getIndicator('totalInspected')}</span></th>
      <th onclick="setSummarySort('live')">Live<span class="sort-indicator">${getIndicator('live')}</span></th>
      <th onclick="setSummarySort('disconnected')">Disconnected<span class="sort-indicator">${getIndicator('disconnected')}</span></th>
    </tr>`;

  // Get unit keys and sort them based on the current sort state
  const sortedUnitKeys = Object.keys(units).sort((keyA, keyB) => {
    const dataA = data[keyA] || { total: 0, alreadyDD: 0, live: 0, disconnected: 0 };
    const dataB = data[keyB] || { total: 0, alreadyDD: 0, live: 0, disconnected: 0 };
    
    let valA, valB;
    if (summarySort.column === 'name') {
      valA = getCCCName(keyA);
      valB = getCCCName(keyB);
    } else if (summarySort.column === 'totalInspected') {
      valA = dataA.live + dataA.disconnected;
      valB = dataB.live + dataB.disconnected;
    } else {
      valA = dataA[summarySort.column] || 0;
      valB = dataB[summarySort.column] || 0;
    }

    if (summarySort.direction === 'asc') {
      return typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
    } else {
      return typeof valB === 'string' ? valB.localeCompare(valA) : valB - valA;
    }
  });

  let bodyHtml = '';
  // Iterate over the sorted keys to build the table body
  for (const unitKey of sortedUnitKeys) {
    // Skip units that have no data to display
    if (!data[unitKey] || data[unitKey].total === 0) continue;

    const d = data[unitKey] || { total: 0, alreadyDD: 0, live: 0, disconnected: 0 };
    const totalInspected = d.live + d.disconnected;
    const unitName = getCCCName(unitKey);
    bodyHtml += `
      <tr>
        <td>${unitName}</td><td>${d.total}</td><td>${d.alreadyDD}</td><td>${totalInspected}</td><td>${d.live}</td><td>${d.disconnected}</td>
      </tr>`;
  }
  body.innerHTML = bodyHtml;

  // Render the total row in the footer
  if (totals) {
    const totalInspected = totals.live + totals.disconnected;
    foot.innerHTML = `
      <tr>
        <td>Total</td><td>${totals.total}</td><td>${totals.alreadyDD}</td><td>${totalInspected}</td><td>${totals.live}</td><td>${totals.disconnected}</td>
      </tr>`;
  } else {
    foot.innerHTML = '';
  }
}

// Initial load
// --- PIN login flow (NEW) ---
document.getElementById("loginBtn").addEventListener("click", async () => {
  const pin = (document.getElementById("pinInput").value || "").trim();
  if (!pin) return;

  // Look up scope from Supabase user_auth by PIN
  const { data, error } = await client
    .from("user_auth")
    .select("dd_view, dd_edit")
    .eq("pin", pin)
    .single();

  if (error || !data) {
    document.getElementById("loginError").classList.remove("hidden");
    return;
  }

  AUTH_SCOPE.dd_view = data.dd_view;
  AUTH_SCOPE.dd_edit = data.dd_edit;
  CAN_EDIT = (data.dd_edit === 'all' || data.dd_edit === data.dd_view);

  // Hide modal and load the page
  document.getElementById("loginModal").classList.add('hidden');
  initialLoad();
});
</script>

</body>
</html>
