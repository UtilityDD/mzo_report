<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upcoming DD Consumers</title>
  <!-- Google Fonts for Inter and proper fallback -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Custom Styles -->
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #0f172a;
      /* Slate 900 */
      color: #f8fafc;
      /* Slate 50 */
      padding: 1rem;
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      margin: 0;
    }

    .app-container {
      max-width: 1440px;
      margin: 0 auto;
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Generic Utilities */
    .hidden {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Typography */
    .page-title {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.025em;
      margin-bottom: 0.5rem;
      background: linear-gradient(to right, #60a5fa, #a855f7);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
      font-size: 0.875rem;
      color: #94a3b8;
      /* Slate 400 */
      margin-bottom: 2rem;
      font-weight: 500;
    }

    /* Layout */
    .main-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 640px) {
      .main-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 1024px) {
      .main-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (min-width: 1280px) {
      .main-grid {
        grid-template-columns: repeat(7, minmax(0, 1fr));
      }
    }

    /* Summary Cards */
    .summary-card {
      background: rgba(30, 41, 59, 0.7);
      /* Slate 800 with opacity */
      backdrop-filter: blur(8px);
      padding: 1.25rem;
      border-radius: 1rem;
      border: 1px solid rgba(51, 65, 85, 0.5);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .summary-card.master {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border: none;
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }

    @media (min-width: 1024px) {
      .summary-card.master {
        grid-column: span 1;
      }
    }

    .summary-card-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .summary-card.master .summary-card-title {
      color: rgba(255, 255, 255, 0.8);
    }

    .summary-card-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }

    .summary-card.clickable {
      cursor: pointer;
    }

    .summary-card.clickable:hover {
      transform: translateY(-4px);
      background: rgba(30, 41, 59, 0.9);
      border-color: #3b82f6;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }

    .summary-card.master .summary-card-title {
      color: #bfdbfe;
    }

    .summary-card.clickable {
      cursor: pointer;
    }

    /* New Pulsing Dots Animation */
    .pulsing-dots {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      /* gap-3 */
      margin-bottom: 0.5rem;
    }

    .pulsing-dots .dot {
      width: 0.75rem;
      /* w-3 */
      height: 0.75rem;
      /* h-3 */
      background-color: #60a5fa;
      /* bg-blue-400 */
      border-radius: 9999px;
      /* rounded-full */
      animation: pulse 1.4s infinite ease-in-out both;
    }

    .pulsing-dots .dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .pulsing-dots .dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes pulse {

      0%,
      80%,
      100% {
        transform: scale(0);
        opacity: 0.5;
      }

      40% {
        transform: scale(1.0);
        opacity: 1;
      }
    }

    /* Table & Filters */
    .table-container {
      flex-grow: 1;
      /* Ensure table container can grow and take available space */
      min-height: 0;
      /* Allow flex item to shrink below its content size */
      width: 100%;
    }

    .filters-and-search {
      margin-bottom: 1rem;
      /* mb-4 */
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      /* space-y-2 */
    }

    .filter-buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      /* gap-2 */
    }

    .filter-btn {
      font-size: 0.8125rem;
      font-weight: 600;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      background-color: #1e293b;
      color: #94a3b8;
      transition: all 0.2s;
      cursor: pointer;
    }

    .filter-btn:hover {
      background-color: #334155;
      color: #fff;
    }

    .filter-btn.active {
      background-color: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .search-container {
      display: flex;
      position: relative;
      /* For hint positioning */
      align-items: center;
      gap: 0.5rem;
      /* gap-2 */
    }

    .search-input {
      width: 100%;
      background-color: rgba(30, 41, 59, 0.5);
      color: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #334155;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background-color: #1e293b;
    }

    .download-btn {
      padding: 0.625rem;
      background-color: #1e293b;
      color: #10b981;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .download-btn:hover {
      background-color: #064e3b;
      color: #fff;
    }

    .summary-btn {
      padding: 0.625rem;
      background-color: #1e293b;
      color: #3b82f6;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .summary-btn:hover {
      background-color: #1d4ed8;
      /* hover:bg-blue-700 */
    }

    .download-btn .lucide {
      width: 1.25rem;
      /* w-5 */
      height: 1.25rem;
      /* h-5 */
    }

    .summary-btn .lucide {
      width: 1.25rem;
      /* w-5 */
      height: 1.25rem;
      /* h-5 */
    }

    /* New Summary Hint Styles */
    .summary-hint {
      position: absolute;
      bottom: 100%;
      /* Position it above the button */
      right: 0;
      margin-bottom: 0.75rem;
      /* 12px space */
      background-color: #facc15;
      /* bg-yellow-400 */
      color: #1f2937;
      /* text-gray-800 */
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      /* rounded-lg */
      font-size: 0.875rem;
      /* text-sm */
      font-weight: 500;
      white-space: nowrap;
      z-index: 50;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      pointer-events: none;
      /* Prevent interaction */
    }

    .summary-hint.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .summary-hint-arrow {
      position: absolute;
      bottom: -0.4rem;
      /* Adjust to connect with the hint box */
      right: 1.25rem;
      /* Position over the summary button icon */
      width: 0.8rem;
      height: 0.8rem;
      background-color: #facc15;
      /* bg-yellow-400 */
      transform: rotate(45deg);
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 60vh;
      background: rgba(30, 41, 59, 0.3);
      border-radius: 1rem;
      border: 1px solid rgba(51, 65, 85, 0.4);
    }

    .data-table {
      width: 100%;
      font-size: 0.875rem;
      text-align: left;
      color: #cbd5e1;
      border-collapse: collapse;
    }

    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      color: #f8fafc;
      background: #1e293b;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .data-table th,
    .data-table td {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.4);
    }

    .data-table th[onclick] {
      cursor: pointer;
      transition: background 0.2s;
    }

    .data-table th[onclick]:hover {
      background: #334155;
    }

    /* Status-based highlighting for DD Due Date */
    .dd-status-critical {
      color: #f87171;
      font-weight: 700;
    }

    /* Already DD */
    .dd-status-warning {
      color: #fbbf24;
      font-weight: 600;
    }

    /* Today / 7 days */
    .dd-status-info {
      color: #60a5fa;
    }

    /* 15/30 days */

    #summaryTableBody tr {
      cursor: pointer;
      transition: background-color 0.15s;
    }

    #summaryTableBody tr:hover {
      background-color: #374151;
    }

    .data-table tbody tr {
      background-color: transparent;
      transition: all 0.2s;
      cursor: pointer;
    }

    .data-table tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }

    .data-table tbody tr:last-child {
      border-bottom: none;
    }

    /* Pagination */
    .pagination-nav {
      margin-top: 1rem;
    }

    .data-table tfoot tr {
      background-color: #374151;
      /* bg-gray-700 */
      font-weight: 600;
      /* font-semibold */
      color: #f3f4f6;
      /* text-gray-100 */
    }

    /* Summary Modal Tabs */
    .summary-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #374151;
      /* border-gray-700 */
    }

    .summary-tab-btn {
      padding: 0.5rem 1rem;
      border: none;
      background-color: transparent;
      color: #9ca3af;
      /* text-gray-400 */
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      /* To align with the container's border */
      transition: color 0.2s, border-color 0.2s;
    }

    .summary-tab-btn:hover {
      color: #f3f4f6;
      /* text-gray-100 */
    }

    .summary-tab-btn.active {
      color: #60a5fa;
      /* text-blue-400 */
      border-color: #60a5fa;
      /* border-blue-400 */
    }

    /* Sticky header for summary modal table */
    #summaryModal .table-wrapper {
      max-height: 60vh;
      overflow-y: auto;
    }

    #summaryModal .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #374151;
      /* Ensure background is not transparent */
    }

    .pagination-list {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .pagination-list a {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      background-color: #1e293b;
      border: 1px solid #334155;
      color: #94a3b8;
      font-weight: 500;
      transition: all 0.2s;
    }

    .pagination-list a:hover {
      border-color: #3b82f6;
      color: #fff;
      background-color: #334155;
    }

    .pagination-list a.active {
      background-color: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .pagination-list a.disabled {
      opacity: 0.3;
      pointer-events: none;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 1001;
      /* Ensure modals appear above loading overlay */
      overflow-y: auto;
    }

    .modal-center-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem 0;
      text-align: center;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(107, 114, 128, 0.75);
      /* bg-gray-500 bg-opacity-75 */
      transition: opacity 0.15s;
    }

    .modal-panel {
      display: inline-block;
      vertical-align: middle;
      background-color: #1f2937;
      /* bg-gray-800 */
      border-radius: 0.5rem;
      /* rounded-lg */
      text-align: left;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      /* shadow-xl */
      transition: all 0.3s;
      margin: 2rem 0;
      position: relative;
      /* Ensure z-index works correctly */
      width: 100%;
    }

    /* Responsive Breakpoints */
    @media (min-width: 640px) {

      /* sm */
      .filters-and-search {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 0;
      }

      .search-input {
        width: 16rem;
        /* sm:w-64 */
      }

      .modal-center-container {
        padding: 0;
      }

      .modal-panel {
        max-width: 32rem;
        /* sm:max-w-lg */
      }
    }

    @media (min-width: 768px) {

      /* md */
      .main-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }

      .summary-card-title {
        font-size: 0.875rem;
      }

      .summary-card-value {
        font-size: 1.5rem;
      }

      .main-flex-layout {
        flex-direction: row;
      }

      .left-pane-container {
        width: 25%;
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(17, 24, 39, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .page-link {
      transition: all 0.2s;
    }

    /* Additional styles for buttons and specific elements */
    .action-btn {
      background-color: #2563eb;
      color: white;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      transition: background-color 0.15s;
    }

    .action-btn:hover {
      background-color: #1d4ed8;
    }

    .action-btn.updated {
      background-color: #16a34a;
    }

    .action-btn.updated:hover {
      background-color: #15803d;
    }

    .action-btn.disconnected {
      background-color: #dc2626;
    }

    /* New style for disconnected status */
    .action-btn.disconnected:hover {
      background-color: #b91c1c;
    }

    .action-btn.disabled {
      background-color: #4b5563;
      color: #d1d5db;
    }

    .action-btn .lucide {
      width: 1rem;
      height: 1rem;
      display: inline-block;
      vertical-align: middle;
      margin-right: 4px;
    }

    /* New Login Page Styles */
    .login-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background-color: #111827;
      /* bg-gray-900 */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .login-card {
      background-color: #1f2937;
      /* bg-gray-800 */
      border-radius: 0.75rem;
      /* rounded-xl */
      padding: 2.5rem;
      /* p-10 */
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      /* shadow-xl */
      width: 100%;
      max-width: 24rem;
      /* max-w-sm */
      text-align: center;
    }

    .login-title {
      font-size: 1.5rem;
      /* text-2xl */
      font-weight: 700;
      /* font-bold */
      color: #f3f4f6;
      /* text-gray-100 */
      margin-bottom: 0.5rem;
      /* mb-2 */
    }

    .login-subtitle {
      font-size: 0.875rem;
      /* text-sm */
      color: #9ca3af;
      /* text-gray-400 */
      margin-bottom: 2rem;
      /* mb-8 */
    }

    /* .divide-y replacement */
    .divide-y-custom> :not([hidden])~ :not([hidden]) {
      border-top-width: 1px;
      border-color: #374151;
      /* gray-700 */
    }

    .login-input {
      width: 100%;
      background-color: #374151;
      /* bg-gray-700 */
      color: #f3f4f6;
      /* text-gray-100 */
      border-radius: 0.5rem;
      /* rounded-lg */
      border: 1px solid #4b5563;
      /* border-gray-600 */
      padding: 0.75rem 1rem;
      /* px-4 py-3 */
      font-size: 1rem;
      box-sizing: border-box;
      /* Ensure padding is included in width/height */
      text-align: center;
      letter-spacing: 0.5em;
      /* For PIN-like spacing */
    }

    .login-input:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      --tw-ring-color: #3b82f6;
      /* focus:ring-blue-500 */
      box-shadow: 0 0 0 2px var(--tw-ring-color);
      border-color: #3b82f6;
      /* focus:border-blue-500 */
    }

    .login-btn {
      width: 100%;
      margin-top: 1.5rem;
      /* mt-6 */
      background-color: #2563eb;
      /* bg-blue-600 */
      color: #fff;
      font-weight: 600;
      /* font-semibold */
      padding: 0.75rem 1rem;
      /* Match input padding */
      border-radius: 0.5rem;
      /* rounded-lg */
      box-sizing: border-box;
      /* Ensure padding is included in width/height */
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .login-btn:hover {
      background-color: #1d4ed8;
      /* hover:bg-blue-700 */
    }

    .login-error {
      color: #f87171;
      /* text-red-400 */
      font-size: 0.875rem;
      /* text-sm */
      margin-top: 1rem;
      /* mt-4 */
    }

    /* New Minimal Action Modal Styles */
    .action-modal-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0.75rem 1rem;
      font-weight: 500;
      border-radius: 0.5rem;
      transition: background-color 0.2s, color 0.2s;
      cursor: pointer;
      border: 1px solid #4b5563;
      /* border-gray-600 */
    }

    .action-modal-btn .lucide {
      margin-right: 0.5rem;
    }

    .action-modal-btn.live {
      background-color: #16a34a;
      color: white;
      border-color: #16a34a;
    }

    .action-modal-btn.live:hover {
      background-color: #15803d;
    }

    .action-modal-btn.disconnected {
      background-color: #dc2626;
      color: white;
      border-color: #dc2626;
    }

    .action-modal-btn.disconnected:hover {
      background-color: #b91c1c;
    }

    .action-modal-btn.cancel {
      background-color: transparent;
      color: #d1d5db;
    }

    .action-modal-btn.cancel:hover {
      background-color: #374151;
    }
  </style>
  <!-- New Minimal Filter Styles -->
  <style>
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      /* gap-1 */
    }

    .filter-item {
      display: flex;
      align-items: center;
      padding: 0.375rem 0.5rem;
      /* py-1.5 px-2 */
      border-radius: 0.375rem;
      /* rounded-md */
      cursor: pointer;
      transition: background-color 0.15s;
      user-select: none;
    }

    .filter-item:hover {
      background-color: #374151;
      /* hover:bg-gray-700 */
    }

    .filter-item input[type="radio"] {
      display: none;
    }

    .filter-item .custom-checkbox {
      width: 1rem;
      /* w-4 */
      height: 1rem;
      /* h-4 */
      border: 2px solid #6b7280;
      /* border-gray-500 */
      border-radius: 0.25rem;
      /* rounded-sm */
      margin-right: 0.75rem;
      /* mr-3 */
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .filter-item input[type="radio"]:checked+.custom-checkbox {
      background-color: #3b82f6;
      /* bg-blue-500 */
      border-color: #3b82f6;
      /* border-blue-500 */
    }

    .filter-item input[type="radio"]:checked+.custom-checkbox::after {
      content: 'âœ”';
      color: white;
      font-size: 0.75rem;
      /* text-xs */
      font-weight: bold;
    }

    .filter-item .label-text {
      font-size: 0.875rem;
      /* text-sm */
      color: #d1d5db;
      /* text-gray-300 */
    }

    /* Graceful Office Filters */
    .office-filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      background: rgba(30, 41, 59, 0.4);
      padding: 0.75rem;
      border-radius: 1rem;
      border: 1px solid rgba(51, 65, 85, 0.3);
    }

    .office-filters-container select {
      flex: 1;
      min-width: 180px;
      background: #1e293b;
      color: #f1f5f9;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
    }

    .office-filters-container select:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .office-filters-container select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Modal Styles Refinement */
    .modal-panel {
      background: #0f172a;
      border-radius: 1.25rem;
      border: 1px solid rgba(51, 65, 85, 0.5);
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      background: #1e293b;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Consumer Portal Modal - Fullscreenish */
    #consumerPortal .modal-panel {
      width: 95vw;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
    }

    #consumerPortal .modal-body {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
    }

    /* Minimal Search & Actions */
    .portal-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .minimal-input {
      flex: 1;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 0.625rem 1rem;
      color: #f1f5f9;
      font-size: 0.875rem;
    }

    .minimal-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border-radius: 0.75rem;
      background: #1e293b;
      color: #94a3b8;
      border: 1px solid #334155;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .minimal-btn:hover {
      background: #334155;
      color: #fff;
    }

    .minimal-btn.primary {
      background: #3b82f6;
      color: #fff;
      border: none;
    }

    .minimal-btn.primary:hover {
      background: #2563eb;
    }
  </style>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>

  <div class="app-container">
    <div class="landing-header">
      <h2 id="pageTitle" class="page-title">Upcoming DD Consumers</h2>
      <p id="earliestDateHeader" class="page-subtitle"></p>
    </div>

    <!-- Graceful Office Dropdown Filters -->
    <div id="officeFilters" class="office-filters-container">
      <select id="regionFilter" onchange="onRegionChange()"></select>
      <select id="divisionFilter" onchange="onDivisionChange()"></select>
      <select id="cccFilter" onchange="onCCCChange()"></select>
    </div>

    <!-- Summary Cards -->
    <div class="main-grid">
      <div class="summary-card master">
        <h5 class="summary-card-title">Total Records / OSD</h5>
        <h3 class="summary-card-value"><span id="totalCount">0</span> / <span id="totalOSD">0</span></h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('zero_osd')">
        <h5 class="summary-card-title">Zero OSD DD</h5>
        <h3 class="summary-card-value"><span id="zeroOSDCount">0</span> / <span id="zeroOSDOSD">0</span></h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('already_dd')">
        <h5 class="summary-card-title">Already DD</h5>
        <h3 class="summary-card-value"><span id="alreadyDDCountCard">0</span> / <span id="alreadyDDOSDCard">0</span>
        </h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('dd_today')">
        <h5 class="summary-card-title">DD Today</h5>
        <h3 class="summary-card-value"><span id="ddTodayCountCard">0</span> / <span id="ddTodayOSDCard">0</span></h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('dd_7')">
        <h5 class="summary-card-title">DD 7 Days</h5>
        <h3 class="summary-card-value"><span id="dd7CountCard">0</span> / <span id="dd7OSDCard">0</span></h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('dd_15')">
        <h5 class="summary-card-title">DD 15 Days</h5>
        <h3 class="summary-card-value"><span id="dd15CountCard">0</span> / <span id="dd15OSDCard">0</span></h3>
      </div>
      <div class="summary-card clickable" onclick="showSummaryModal('dd_30')">
        <h5 class="summary-card-title">DD 30 Days</h5>
        <h3 class="summary-card-value"><span id="dd30CountCard">0</span> / <span id="dd30OSDCard">0</span></h3>
      </div>
    </div>


    <!-- Main Layout Container (Hidden on Landing) -->
    <div class="main-flex-layout home-view-hidden" id="mainLayoutContainer">
      <!-- Secondary Filters & Search -->
      <div class="filters-and-search w-full">

        <div class="search-container">
          <input type="text" id="universalSearch" class="search-input" placeholder="Search Customer ID, Name, Phone..."
            oninput="debounceSearch()">
          <button onclick="onUniversalSearch()" class="download-btn" title="Search">
            <span data-lucide="search"></span>
          </button>
          <button onclick="downloadCSV()" class="download-btn" title="Download CSV">
            <span data-lucide="download"></span>
          </button>
          <div style="position: relative;">
            <div id="summaryHint" class="summary-hint">
              Check Unit-wise summary!
              <div class="summary-hint-arrow"></div>
            </div>
            <button onclick="showSummaryModal()" class="summary-btn" title="Unit-wise Summary">
              <span data-lucide="bar-chart-2"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Consumer Table -->
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th onclick="setSort('CON_ID')">CON_ID <span id="sort-CON_ID" class="sort-indicator"></span></th>
                <th onclick="setSort('NAME')">NAME <span id="sort-NAME" class="sort-indicator"></span></th>
                <th onclick="setSort('REG_MOB_NO')">PHONE <span id="sort-REG_MOB_NO" class="sort-indicator"></span></th>
                <th onclick="setSort('BASE_CLASS')">CLASS <span id="sort-BASE_CLASS" class="sort-indicator"></span></th>
                <th onclick="setSort('CONN_PHASE')">PH <span id="sort-CONN_PHASE" class="sort-indicator"></span></th>
                <th onclick="setSort('GOVT_STAT')">GOVT <span id="sort-GOVT_STAT" class="sort-indicator"></span></th>
                <th onclick="setSort('CCC_CODE')">OFFICE <span id="sort-CCC_CODE" class="sort-indicator"></span></th>
                <th onclick="setSort('discon_dt_iso')">DISCON DT <span id="sort-discon_dt_iso"
                    class="sort-indicator"></span></th>
                <th onclick="setSort('dd_due_date')">DD DUE DATE <span id="sort-dd_due_date"
                    class="sort-indicator"></span></th>
                <th onclick="setSort('OUTSTANDING')">OSD <span id="sort-OUTSTANDING" class="sort-indicator"></span></th>
                <th>ACTION</th>
              </tr>
            </thead>
            <tbody id="data-body"></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav class="pagination-nav">
          <ul id="pagination" class="pagination-list"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-overlay" id="loading" style="display:none;">
    <div class="loading-content">
      <div class="pulsing-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <p class="text-gray-300">Loading...</p>
    </div>
  </div>


  <!-- Custom Confirmation Modal -->
  <div id="confirmModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <span class="hidden" aria-hidden="true">&#8203;</span>
      <div class="modal-panel">
        <div style="background-color: #1f2937; padding: 1.5rem 1.5rem 1rem;">
          <div class="sm:flex sm:items-start">
            <div
              class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
              <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              <h3 class="text-lg leading-6 font-medium text-gray-100" id="confirmModalTitle">
                Confirm Action
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-300" id="confirmModalMessage">
                  Are you sure you want to perform this action?
                </p>
              </div>
            </div>
          </div>
        </div>
        <div style="background-color: #374151; padding: 0.75rem 1.5rem; display: flex; flex-direction: row-reverse;">
          <button type="button" id="confirmYesBtn"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Yes
          </button>
          <button type="button" id="confirmNoBtn"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            No
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Message Modal -->
  <div id="messageModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <div class="modal-panel" style="max-width: 20rem; text-align: center;">
        <div style="background-color: #1f2937; padding: 1.5rem;">
          <h3 class="text-lg leading-6 font-medium text-gray-100 flex items-center justify-center gap-2"
            id="messageModalTitle">
            <!-- Icon will be injected here if needed -->
            Message
          </h3>
          <div class="mt-2">
            <p class="text-sm text-gray-400" id="messageModalMessage">
              This is a message.
            </p>
          </div>
        </div>
        <div style="background-color: #1f2937; padding: 0 1.5rem 1.5rem;">
          <button type="button" id="messageOkBtn"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Modal for Row Details -->
  <div id="rowDetailModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <span class="hidden" aria-hidden="true">&#8203;</span>
      <div class="modal-panel">
        <div
          style="background-color: #374151; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
          <h3 class="text-lg leading-6 font-medium text-gray-100" id="rowDetailModalTitle">
            Consumer Details
          </h3>
          <button type="button" class="text-gray-400 hover:text-gray-100 focus:outline-none"
            onclick="hideModal('rowDetailModal')">
            <span class="sr-only">Close</span>
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div style="background-color: #1f2937; padding: 1.5rem; font-size: 0.875rem;" id="rowDetailModalBody">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- New Action Modal -->
  <div id="actionModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <div class="modal-panel" style="max-width: 20rem; padding: 1.5rem;">
        <h3 class="text-lg font-semibold text-gray-100 text-center mb-4" id="actionModalTitle">
          Update Observation
        </h3>
        <div class="flex flex-col gap-3">
          <button type="button" id="actionLiveBtn" class="action-modal-btn live">
            <span data-lucide="check-circle-2"></span>
            Found Live
          </button>
          <button type="button" id="actionDisconnectedBtn" class="action-modal-btn disconnected">
            <span data-lucide="x-circle"></span>
            Found Disconnected
          </button>
          <button type="button" onclick="hideModal('actionModal')" class="action-modal-btn cancel mt-2">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Table Modal -->
  <div id="summaryModal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true" onclick="hideModal('summaryModal')"></div>
      <span class="hidden" aria-hidden="true">&#8203;</span>
      <div class="modal-panel" style="max-width: 56rem;">
        <div class="modal-header">
          <h3 class="text-lg font-semibold text-gray-100" id="summaryModalTitle">Unit-wise Summary</h3>
          <button type="button" class="text-gray-400 hover:text-red-500 transition-colors"
            onclick="hideModal('summaryModal')">
            <span data-lucide="x" class="h-6 w-6"></span>
          </button>
        </div>
        <div style="padding: 1.5rem;">
          <div class="summary-tabs">
            <button class="summary-tab-btn" onclick="switchSummaryTab('region', this)">Region-wise</button>
            <button class="summary-tab-btn" onclick="switchSummaryTab('division', this)">Division-wise</button>
            <button class="summary-tab-btn" onclick="switchSummaryTab('ccc', this)">CCC-wise</button>
          </div>
          <div class="table-wrapper">
            <table class="data-table">
              <thead id="summaryTableHead"></thead>
              <tbody id="summaryTableBody"></tbody>
              <tfoot id="summaryTableFoot"></tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Consumer Portal Modal (Phase 3) -->
  <div id="consumerPortal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal-center-container">
      <div class="modal-backdrop" aria-hidden="true" onclick="hideModal('consumerPortal')"></div>
      <div class="modal-panel">
        <div class="modal-header">
          <div>
            <h3 class="text-lg font-bold text-gray-100" id="portalTitle">Consumer List</h3>
            <p class="text-xs text-gray-400" id="portalSubTitle">Detailed view of selected unit</p>
          </div>
          <button type="button" class="text-gray-400 hover:text-red-500 transition-colors"
            onclick="hideModal('consumerPortal')">
            <span data-lucide="x" class="h-6 w-6"></span>
          </button>
        </div>
        <div class="modal-body">
          <div class="portal-actions">
            <div class="relative flex-1">
              <input type="text" id="portalSearch" class="minimal-input" placeholder="Search consumers in this view..."
                oninput="onPortalSearch()">
            </div>
            <button onclick="downloadCSVFromPortal()" class="minimal-btn" title="Download current view">
              <span data-lucide="download"></span>
              Export
            </button>
          </div>
          <div class="table-wrapper" style="max-height: calc(90vh - 200px);">
            <table class="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th onclick="setPortalSort('CON_ID')">CON_ID</th>
                  <th onclick="setPortalSort('NAME')">NAME</th>
                  <th onclick="setPortalSort('REG_MOB_NO')">Mobile</th>
                  <th onclick="setPortalSort('dd_due_date')">Due Date</th>
                  <th onclick="setPortalSort('OUTSTANDING')">OSD</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="portalDataBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Google Sheets configuration
    const SHEET_ID = "1aUeVnSc-OmFqqrUdoZxv8v8659u52zlIWddnpJgU9Uk";
    const GID = "487034861";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

    let rawSheetData = []; // Local cache for all data

    const cccHierarchy = {
      "6610000": {
        name: "MALDA REGION",
        divisions: {
          "6611000": {
            name: "MALDA DIVISIOIN",
            cccs: {
              "6611101": "MANIKCHAK CCC",
              "6611102": "GOLAPGANJ CCC",
              "6611103": "BAISHNABNAGAR CCC",
              "6611104": "KALIACHAK CCC",
              "6611105": "MOTHABARI CCC",
              "6611106": "SUJAPUR CCC",
              "6611107": "RATHBARI CCC",
              "6611108": "FULBARI CCC",
              "6611109": "MOKDUMPUR CCC"
            }
          },
          "6613000": {
            name: "GAZOLE DIVISIOIN",
            cccs: {
              "6613101": "GAZOL CCC",
              "6613102": "AIHO CCC",
              "6613103": "PANDUA CCC",
              "6613104": "BAMONGOLA CCC",
              "6613105": "OLD MALDA CCC"
            }
          },
          "6612000": {
            name: "CHANCHAL DIVISION",
            cccs: {
              "6612101": "BHALUKA CCC",
              "6612102": "SAMSI CCC",
              "6612103": "PARANPUR CCC",
              "6612104": "CHANCHAL CCC",
              "6612105": "MALATIPUR CCC",
              "6612106": "HARISHCHANDRAPUR CCC",
              "6612107": "KUSHIDA CCC"
            }
          }
        }
      },
      "6620000": {
        name: "UTTAR DINAJPUR REGION",
        divisions: {
          "6621000": {
            name: "RAIGANJ DIVISION",
            cccs: {
              "6621101": "ITAHAR CCC",
              "6621102": "HEMTABAD CCC",
              "6621103": "KALIYAGANJ CCC",
              "6621104": "RAIGANJ CCC",
              "6621105": "BIRNAGAR CCC",
              "6621106": "KARANDIGHI CCC"
            }
          },
          "6622000": {
            name: "ISLAMPUR DIVISION",
            cccs: {
              "6622101": "ISLAMPUR CCC",
              "6622102": "CHOPRA CCC",
              "6622103": "DALKHOLA CCC",
              "6622104": "GOALPOKHER CCC",
              "6622105": "KANKI CCC"
            }
          }
        }
      },
      "6630000": {
        name: "DAKSHIN DINAJPUR REGION",
        divisions: {
          "6631000": {
            name: "BALURGHAT DIVISION",
            cccs: {
              "6631101": "BALURGHAT CCC",
              "6631102": "TAPAN CCC",
              "6631103": "KUMARGANJ CCC",
              "6631104": "HILI CCC",
              "6631105": "PATIRAM CCC"
            }
          },
          "6632000": {
            name: "BUNIADPUR DIVISION",
            cccs: {
              "6632101": "BUNIADPUR CCC",
              "6632102": "KUSMANDI CCC",
              "6632103": "HARIRAMPUR CCC",
              "6632104": "GANGARAMPUR CCC"
            }
          }
        }
      }
    };
    function getAllowedCCCList() {
      return []; // Always return empty for no restriction
    }

    // Helper to map CCC_CODE to name (consistent with filters)
    function getCCCName(code) {
      code = String(code);
      if (cccHierarchy[code]) {
        return cccHierarchy[code].name;
      }
      for (const rKey in cccHierarchy) {
        const r = cccHierarchy[rKey];
        if (r.divisions && r.divisions[code]) {
          return r.divisions[code].name;
        }
        for (const dKey in r.divisions) {
          const d = r.divisions[dKey];
          if (d.cccs && d.cccs[code]) {
            return d.cccs[code].replace(" CCC", "");
          }
        }
      }
      return code;
    }

    // Prepare a flat map for easy lookup
    const flatCCCHierarchy = {};
    for (const rKey in cccHierarchy) {
      const region = cccHierarchy[rKey];
      for (const dKey in region.divisions) {
        const division = region.divisions[dKey];
        for (const cccCode in division.cccs) {
          flatCCCHierarchy[cccCode] = { zone: rKey, div: dKey };
        }
      }
    }

    // --- Update page title with selected office ---
    function updatePageTitle() {
      const titleEl = document.getElementById('pageTitle');
      let officeName = null;

      if (document.getElementById('cccFilter').value) {
        officeName = getCCCName(document.getElementById('cccFilter').value);
      } else if (document.getElementById('divisionFilter').value) {
        officeName = getCCCName(document.getElementById('divisionFilter').value);
      } else if (document.getElementById('regionFilter').value) {
        officeName = getCCCName(document.getElementById('regionFilter').value);
      }
      if (officeName) {
        titleEl.innerText = `Upcoming DD Consumers (${officeName})`;
      } else {
        titleEl.innerText = 'Upcoming DD Consumers';
      }
    }
    // Helper to format date to DD-MM-YYYY
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const [year, month, day] = dateStr.split('-');
      return `${day}-${month}-${year}`;
    }
    let pendingObservationUpdate = null;

    let currentPage = 1;
    const rowsPerPage = 20;
    let totalRows = 0;
    let allCCC = [];
    let universalSearchValue = "";
    let alreadyDDActive = false;
    let ddTodayActive = false;
    let dd7Active = false, dd15Active = false, dd30Active = false;
    let foundLiveActive = false, foundDisconnectedActive = false;
    let currentFilteredRows = [];
    let liveBtnActive = false, disconnectedBtnActive = false;

    let sortColumn = 'OUTSTANDING';
    let sortDirection = 'desc';
    let summarySort = { column: 'totalInspected', direction: 'desc' };

    let allFilteredRowsForSummary = []; // Store all rows for summary modal


    // Function to show a custom message modal
    function showMessageModal(title, message, icon = null) {
      const titleEl = document.getElementById('messageModalTitle');
      document.getElementById('messageModalMessage').innerText = message;

      if (icon) {
        titleEl.innerHTML = `<span data-lucide="${icon}" class="w-5 h-5"></span> ${title}`;
        lucide.createIcons();
      } else {
        titleEl.innerText = title;
      }

      document.getElementById('messageModal').classList.remove('hidden');
    }

    // Function to show a custom confirmation modal
    function showConfirmModal(title, message, onConfirm) {
      document.getElementById('confirmModalTitle').innerText = title;
      document.getElementById('confirmModalMessage').innerText = message;
      document.getElementById('confirmModal').classList.remove('hidden');

      const yesBtn = document.getElementById('confirmYesBtn');
      const noBtn = document.getElementById('confirmNoBtn');

      // Clear previous event listeners
      const newYesBtn = yesBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
      const newNoBtn = noBtn.cloneNode(true);
      noBtn.parentNode.replaceChild(newNoBtn, noBtn);

      newYesBtn.addEventListener('click', () => {
        hideModal('confirmModal');
        onConfirm();
      });

      newNoBtn.addEventListener('click', () => {
        hideModal('confirmModal');
      });
    }

    // Function to hide a modal
    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Attach event listeners for modals
    document.getElementById('messageOkBtn').addEventListener('click', () => hideModal('messageModal'));

    // Fetch all unique CCC_CODEs for the left pane (no row limit)
    function csvToJSON(csv) {
      const lines = csv.split("\n");
      const result = [];
      const headers = lines[0].split(",").map(h => h.replace(/^"|"$/g, '').trim());

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const obj = {};
        const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Split by comma outside quotes

        headers.forEach((header, index) => {
          let val = currentline[index] ? currentline[index].replace(/^"|"$/g, '').trim() : "";
          obj[header] = val;
        });
        result.push(obj);
      }
      return result;
    }

    async function fetchDataFromGoogleSheet() {
      const response = await fetch(CSV_URL);
      const csvText = await response.text();
      const jsonData = csvToJSON(csvText);

      const today = new Date();

      function parseYYYYMMDD(str) {
        if (!str || str.length !== 8) return null;
        const y = parseInt(str.substring(0, 4), 10);
        const m = parseInt(str.substring(4, 6), 10) - 1;
        const d = parseInt(str.substring(6, 8), 10);
        const date = new Date(y, m, d);
        return isNaN(date.getTime()) ? null : date;
      }

      return jsonData.map(row => {
        // Calculate DD due date: DISCON_DT + 180 days
        let ddDueDate = "";
        if (row.DISCON_DT) {
          const disconDate = parseYYYYMMDD(String(row.DISCON_DT));
          if (disconDate) {
            const dueDateObj = new Date(disconDate);
            dueDateObj.setDate(dueDateObj.getDate() + 180);
            ddDueDate = dueDateObj.toISOString().slice(0, 10);
          }
        }

        return {
          ...row,
          CON_ID: row.CON_ID || row.CONSUMER_ID || "", // Fallback if headers vary
          OUTSTANDING: parseFloat(row.OUTSTANDING) || 0,
          discon_dt_iso: row.DISCON_DT ? (parseYYYYMMDD(String(row.DISCON_DT))?.toISOString().slice(0, 10) || "") : "",
          dd_due_date: ddDueDate
        };
      });
    }

    // Initial load: fetch all data from Google Sheets, then render
    async function initialLoad() {
      showLoading(true);
      try {
        rawSheetData = await fetchDataFromGoogleSheet();

        // Find earliest and latest dates from calculated dd_due_date
        const dates = rawSheetData.map(r => r.dd_due_date).filter(d => d).sort();

        if (dates.length > 0) {
          document.getElementById("earliestDateHeader").innerText = `from ${formatDate(dates[0])} to ${formatDate(dates[dates.length - 1])}`;
        } else {
          document.getElementById("earliestDateHeader").innerText = "No upcoming DD dates found.";
        }

        // Enrich data with hierarchy codes for summary grouping
        rawSheetData.forEach(row => {
          const hierarchy = flatCCCHierarchy[String(row.CCC_CODE)];
          if (hierarchy) {
            row.ZONE_CODE = hierarchy.zone;
            row.DIV_CODE = hierarchy.div;
          }
        });

        // Get unique CCC codes for filters
        allCCC = [...new Set(rawSheetData.map(r => String(r.CCC_CODE)).filter(c => c && c !== "undefined"))];

        populateRegionFilter();
        updatePageTitle();
        fetchPage(1);
      } catch (err) {
        console.error("Error in initial load:", err);
        showMessageModal("Error", "Failed to load data from Google Sheets.");
      } finally {
        showLoading(false);
        lucide.createIcons();
      }
    }

    function populateRegionFilter() {
      const regionFilter = document.getElementById('regionFilter');
      regionFilter.innerHTML = '<option value="">All Regions</option>';

      for (const regionKey in cccHierarchy) {
        regionFilter.innerHTML += `<option value="${regionKey}">${cccHierarchy[regionKey].name}</option>`;
      }
      onRegionChange();
    }


    function onRegionChange() {
      const regionKey = document.getElementById('regionFilter').value;
      const divisionFilter = document.getElementById('divisionFilter');
      divisionFilter.innerHTML = '<option value="">All Divisions</option>';

      if (regionKey) {
        const region = cccHierarchy[regionKey];
        for (const divisionKey in region.divisions) {
          divisionFilter.innerHTML += `<option value="${divisionKey}">${region.divisions[divisionKey].name}</option>`;
        }
        divisionFilter.disabled = false;
      } else {
        divisionFilter.disabled = true;
      }

      onDivisionChange();
    }

    function onDivisionChange() {
      const regionKey = document.getElementById('regionFilter').value;
      const divisionKey = document.getElementById('divisionFilter').value;
      const cccFilter = document.getElementById('cccFilter');
      cccFilter.innerHTML = '<option value="">All Offices</option>';

      if (regionKey && divisionKey) {
        const division = cccHierarchy[regionKey].divisions[divisionKey];
        for (const cccCode in division.cccs) {
          cccFilter.innerHTML += `<option value="${cccCode}">${division.cccs[cccCode].replace(" CCC", "")}</option>`;
        }
        cccFilter.disabled = false;
      } else {
        cccFilter.disabled = true;
      }

      onCCCChange();
    }

    function onCCCChange() {
      currentPage = 1;
      if (document.getElementById('regionFilter').value) {
        showMainContent();
      }
      resetAllDDButtons(); // Reset secondary filters
      updatePageTitle();
      fetchPage(currentPage);
    }

    // Helper to format numbers as Cr, Lakh, k
    function formatAmount(num) {
      num = Number(num);
      if (isNaN(num)) return "";
      if (num >= 1e7) return (num / 1e7).toFixed(2).replace(/\.00$/, "") + " Cr";
      if (num >= 1e5) return (num / 1e5).toFixed(2).replace(/\.00$/, "") + " Lakh";
      if (num >= 1e3) return (num / 1e3).toFixed(2).replace(/\.00$/, "") + "k";
      return num.toString();
    }

    // --- NEW: Animate numbers counting up ---
    function animateCountUp(elementId, endValue, isAmount = false) {
      const element = document.getElementById(elementId);
      if (!element) return;

      // Try to parse the current number, default to 0 if not a number
      const startValueText = element.innerText.replace(/[^0-9.]/g, '');
      let startValue = parseFloat(startValueText) || 0;

      // For formatted amounts like "1.2 Lakh", convert back to a raw number
      if (element.innerText.toLowerCase().includes('cr')) startValue *= 1e7;
      if (element.innerText.toLowerCase().includes('lakh')) startValue *= 1e5;
      if (element.innerText.toLowerCase().includes('k')) startValue *= 1e3;

      const duration = 1500; // Animation duration in ms
      let startTime = null;

      function animation(currentTime) {
        if (startTime === null) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const currentValue = Math.floor(progress * (endValue - startValue) + startValue);

        element.innerText = isAmount ? formatAmount(currentValue) : currentValue.toLocaleString();

        if (progress < 1) {
          requestAnimationFrame(animation);
        } else {
          element.innerText = isAmount ? formatAmount(endValue) : endValue.toLocaleString();
        }
      }
      requestAnimationFrame(animation);
    }

    // --- NEW: Show temporary hint for summary button ---
    function showSummaryHint() {
      const hint = document.getElementById('summaryHint');
      if (!hint) return;

      // Show the hint after a short delay
      setTimeout(() => {
        hint.classList.remove('hidden');
        setTimeout(() => hint.classList.add('visible'), 10); // Add 'visible' class to trigger transition
      }, 1000); // 1-second delay before showing

      // Hide the hint after 10 seconds
      setTimeout(() => {
        hint.classList.remove('visible');
        // Optional: add hidden back after transition ends
        setTimeout(() => hint.classList.add('hidden'), 500);
      }, 11000); // 1s delay + 10s visible = 11s total
    }
    // --- Update fetchPage to use correct logic for DD in X days buttons ---
    async function fetchPage(page, isForExport = false) {
      showLoading(true);
      try {
        currentPage = page;
        const today = todayStr();
        const norm = (s) => (s || "").trim().toLowerCase();

        // 1. Filter by Office
        const selectedCCC = document.getElementById('cccFilter').value;
        const selectedDivision = document.getElementById('divisionFilter').value;
        const selectedRegion = document.getElementById('regionFilter').value;

        let filtered = rawSheetData;

        if (selectedCCC) {
          filtered = filtered.filter(row => String(row.CCC_CODE) === selectedCCC);
        } else if (selectedDivision) {
          const cccList = Object.keys(cccHierarchy[selectedRegion].divisions[selectedDivision].cccs);
          filtered = filtered.filter(row => cccList.includes(String(row.CCC_CODE)));
        } else if (selectedRegion) {
          let cccList = [];
          for (const divisionKey in cccHierarchy[selectedRegion].divisions) {
            cccList = cccList.concat(Object.keys(cccHierarchy[selectedRegion].divisions[divisionKey].cccs));
          }
          filtered = filtered.filter(row => cccList.includes(String(row.CCC_CODE)));
        }

        // --- DASHBOARD COUNTS (Reflect base selection) ---
        allFilteredRowsForSummary = filtered;
        animateCountUp("totalCount", filtered.length);

        let totalOSD = 0, zeroOSDCount = 0, zeroOSDOSD = 0;
        let alreadyDD_C = 0, alreadyDD_O = 0;
        let ddToday_C = 0, ddToday_O = 0;
        let dd7_C = 0, dd7_O = 0;
        let dd15_C = 0, dd15_O = 0;
        let dd30_C = 0, dd30_O = 0;

        filtered.forEach(row => {
          let val = row.OUTSTANDING || 0;
          totalOSD += val;
          if (val === 0) {
            zeroOSDCount++;
            zeroOSDOSD += val;
          }

          const dueDate = row.dd_due_date;
          if (dueDate) {
            if (dueDate < today) { alreadyDD_C++; alreadyDD_O += val; }
            if (dueDate === today) { ddToday_C++; ddToday_O += val; }
            if (dueDate >= today && dueDate <= dateOffsetStr(6)) { dd7_C++; dd7_O += val; }
            if (dueDate >= today && dueDate <= dateOffsetStr(14)) { dd15_C++; dd15_O += val; }
            if (dueDate >= today && dueDate <= dateOffsetStr(29)) { dd30_C++; dd30_O += val; }
          }
        });

        animateCountUp("totalOSD", totalOSD, true);
        animateCountUp("zeroOSDCount", zeroOSDCount);
        animateCountUp("zeroOSDOSD", zeroOSDOSD, true);
        animateCountUp("alreadyDDCountCard", alreadyDD_C);
        animateCountUp("alreadyDDOSDCard", alreadyDD_O, true);
        animateCountUp("ddTodayCountCard", ddToday_C);
        animateCountUp("ddTodayOSDCard", ddToday_O, true);
        animateCountUp("dd7CountCard", dd7_C);
        animateCountUp("dd7OSDCard", dd7_O, true);
        animateCountUp("dd15CountCard", dd15_C);
        animateCountUp("dd15OSDCard", dd15_O, true);
        animateCountUp("dd30CountCard", dd30_C);
        animateCountUp("dd30OSDCard", dd30_O, true);

        // 2. Filter by Active Buttons
        if (alreadyDDActive) {
          filtered = filtered.filter(row => row.dd_due_date && row.dd_due_date < today);
        } else if (ddTodayActive) {
          filtered = filtered.filter(row => row.dd_due_date === today);
        } else if (dd7Active) {
          filtered = filtered.filter(row => row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(6));
        } else if (dd15Active) {
          filtered = filtered.filter(row => row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(14));
        } else if (dd30Active) {
          filtered = filtered.filter(row => row.dd_due_date >= today && row.dd_due_date <= dateOffsetStr(29));
        } else if (foundLiveActive || liveBtnActive) {
          filtered = filtered.filter(row => norm(row.observation).includes("live"));
        } else if (foundDisconnectedActive || disconnectedBtnActive) {
          filtered = filtered.filter(row => norm(row.observation).includes("disconnected"));
        }

        // 3. Search
        if (universalSearchValue) {
          const s = universalSearchValue.toLowerCase();
          filtered = filtered.filter(row =>
            String(row.CON_ID).toLowerCase().includes(s) ||
            String(row.NAME).toLowerCase().includes(s) ||
            String(row.REG_MOB_NO).toLowerCase().includes(s) ||
            String(row.BASE_CLASS).toLowerCase().includes(s) ||
            String(row.CONN_PHASE).toLowerCase().includes(s) ||
            String(row.GOVT_STAT).toLowerCase().includes(s) ||
            String(row.OUTSTANDING).toLowerCase().includes(s) ||
            String(row.discon_dt_iso).toLowerCase().includes(s) ||
            String(row.dd_due_date).toLowerCase().includes(s)
          );
        }

        // 4. Sort
        const col = sortColumn;
        const dir = sortDirection === 'asc' ? 1 : -1;
        filtered.sort((a, b) => {
          let va = a[col] || "";
          let vb = b[col] || "";
          if (typeof va === 'string') va = va.toLowerCase();
          if (typeof vb === 'string') vb = vb.toLowerCase();
          if (va < vb) return -1 * dir;
          if (va > vb) return 1 * dir;
          return 0;
        });

        if (isForExport) return filtered;

        totalRows = filtered.length;
        const pageRows = filtered.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        currentFilteredRows = pageRows;

        renderTable(pageRows);
        renderPagination();
        updateSortIndicators();
        lucide.createIcons();
      } catch (err) {
        console.error(err);
        showMessageModal("Error", "Failed to process data.");
      } finally {
        showLoading(false);
      }
    }

    // Update showRowModal to include new fields in the modal
    function showRowModal(row) {
      const fields = [
        { label: "CON_ID", value: row.CON_ID },
        { label: "NAME", value: row.NAME },
        { label: "Address", value: row.ADDRESS },
        { label: "Mobile No.", value: row.REG_MOB_NO },
        { label: "Class", value: row.BASE_CLASS },
        { label: "Ph", value: row.CONN_PHASE },
        { label: "Govt.", value: row.GOVT_STAT },
        { label: "Nature of Connection", value: row.NAT_OF_CONN },
        { label: "Load", value: row.CONN_LOAD },
        { label: "MRU", value: row.MRU },
        { label: "Meter No.", value: row.METER_NO },
        { label: "Disconnection Date", value: formatDate(row.discon_dt1) },
        { label: "CCC Name", value: getCCCName(row.CCC_CODE) },
        { label: "DD Due Date", value: formatDate(row.dd_due_date) },
        { label: "OSD", value: formatAmount(row.OUTSTANDING) },
        { label: "Observation", value: row.observation }
      ];
      let html = `<div class="grid grid-cols-2 gap-x-4 gap-y-2">`;
      for (const f of fields) {
        html += `<div class="font-medium text-gray-300">${f.label}:</div><div class="text-right text-gray-100">${f.value ?? ""}</div>`;
      }
      html += `</div>`;
      document.getElementById("rowDetailModalBody").innerHTML = html;
      document.getElementById('rowDetailModal').classList.remove('hidden');
    }

    // Update renderTable to render data without editing capabilities (Read-Only)
    function renderTable(data) {
      let tbody = document.getElementById("data-body");
      tbody.innerHTML = "";
      const today = todayStr();

      data.forEach(row => {
        const ddDueDate = row.dd_due_date ? formatDate(row.dd_due_date) : "";
        const ddDueDateStyle = (row.dd_due_date && row.dd_due_date < today)
          ? 'style="color:#dc2626; font-weight:bold;"'
          : '';

        let actionButtonHTML = "";
        if (row.observation) {
          const observationText = (row.observation || '').toLowerCase();
          if (observationText.includes('live')) {
            actionButtonHTML = `
          <button class="action-btn updated" style="cursor: default;" onclick="event.stopPropagation();">
            <span data-lucide="check-circle" class="lucide"></span>
            <span>Live</span>
          </button>`;
          } else if (observationText.includes('disconnected')) {
            actionButtonHTML = `
          <button class="action-btn disconnected" style="cursor: default;" onclick="event.stopPropagation();">
            <span data-lucide="x-circle" class="lucide"></span>
            <span>Disconnected</span>
          </button>`;
          }
        } else {
          // Default action button (non-functional in read-only mode)
          actionButtonHTML = `
          <button class="action-btn disabled" style="cursor: not-allowed;"
                  onclick="event.stopPropagation(); showMessageModal('Read Only', 'This dashboard is now read-only.')">
            <span data-lucide="info" class="lucide"></span>
            <span>Details</span>
          </button>`;
        }

        tbody.innerHTML += `
      <tr onclick='showRowModal(${JSON.stringify(row).replace(/'/g, "&apos;")})'>
        <td>${row.CON_ID}</td>
        <td>${row.NAME || ""}</td>
        <td>${row.REG_MOB_NO || ""}</td>
        <td>${row.BASE_CLASS || ""}</td>
        <td>${row.CONN_PHASE || ""}</td>
        <td>${row.GOVT_STAT || ""}</td>
        <td>${getCCCName(row.CCC_CODE)}</td>
        <td>${formatDate(row.discon_dt_iso)}</td>
        <td ${ddDueDateStyle}>${ddDueDate}</td>
        <td>${formatAmount(row.OUTSTANDING)}</td>
        <td>${actionButtonHTML}</td>
      </tr>`;
      });
      lucide.createIcons();
    }

    function setSort(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'asc' : 'desc';
      } else {
        sortColumn = column;
        sortDirection = 'desc'; // Default to descending for a new column
      }
      fetchPage(1);
    }

    function updateSortIndicators() {
      document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
      const indicatorEl = document.getElementById(`sort-${sortColumn}`);
      if (indicatorEl) {
        indicatorEl.textContent = sortDirection === 'asc' ? 'â–²' : 'â–¼';
      }
    }
    function renderPagination() {
      let totalPages = Math.ceil(totalRows / rowsPerPage);
      let pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      if (totalPages <= 1) return;

      const maxPagesToShow = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = startPage + maxPagesToShow - 1;
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }

      // Previous arrow
      pagination.innerHTML += `
    <li>
      <a href="#" onclick="if(${currentPage > 1}) { fetchPage(${currentPage - 1}); }" class="page-link ${currentPage === 1 ? 'disabled' : ''}">&laquo;</a>
    </li>
  `;

      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
      <li>
        <a href="#" onclick="fetchPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</a>
      </li>
    `;
      }

      // Next arrow
      pagination.innerHTML += `
    <li>
      <a href="#" onclick="if(${currentPage < totalPages}) { fetchPage(${currentPage + 1}); }" class="page-link ${currentPage === totalPages ? 'disabled' : ''}">&raquo;</a>
    </li>
  `;
    }

    async function updateField(id, field, value) {
      showMessageModal("ReadOnly", "This dashboard is now Read-Only (Google Sheets). Changes cannot be saved back.");
    }

    async function updateObservation(id, observation) {
      showMessageModal("ReadOnly", "This dashboard is now Read-Only (Google Sheets). Observations cannot be updated.");
    }

    function showLoading(show) {
      const loadingEl = document.getElementById("loading");
      if (show) {
        loadingEl.style.display = "flex";
      } else {
        loadingEl.style.display = "none";
      }
    }
    function showMainContent() {
      const mainLayout = document.getElementById("mainLayoutContainer");
      if (mainLayout) {
        mainLayout.classList.remove('home-view-hidden');
      }
    }

    function onUniversalSearch() {
      universalSearchValue = document.getElementById("universalSearch").value.trim().toLowerCase();
      showMainContent();
      resetAllDDButtons();
      currentPage = 1;
      fetchPage(currentPage);
    }

    // Filter buttons were removed from UI in the redesign. 
    // State-based filtering is now handled by summary cards and drill-down logic.

    // Reset all DD filter buttons to default state
    function resetAllDDButtons() {
      alreadyDDActive = false;
      ddTodayActive = false;
      dd7Active = false;
      dd15Active = false;
      dd30Active = false;
      foundLiveActive = false;
      foundDisconnectedActive = false;
      liveBtnActive = false;
      disconnectedBtnActive = false;

      // Old UI buttons were removed in redesign
    }

    async function downloadCSV() {
      showMessageModal("Info", "Preparing download... This may take a moment for large datasets.");

      // Fetch all data matching the current filters, without pagination
      const dataToExport = await fetchPage(1, true);

      hideModal('messageModal');

      if (!dataToExport || dataToExport.length === 0) {
        showMessageModal("Info", "No data to download.");
        return;
      }

      // Define headers.
      const headers = [
        "CON_ID", "NAME", "ADDRESS", "MRU", "REG_MOB_NO", "BASE_CLASS", "CONN_PHASE",
        "GOVT_STAT", "NAT_OF_CONN", "CONN_LOAD", "METER_NO", "discon_dt1", "CCC_CODE",
        "CCC_NAME", "OUTSTANDING", "dd_due_date", "observation"
      ];

      // Helper to escape CSV values
      const escapeCsvValue = (value) => {
        if (value === null || value === undefined) return "";
        value = String(value);
        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
          value = value.replace(/"/g, '""');
          return `"${value}"`;
        }
        return value;
      };

      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += headers.join(",") + "\r\n";

      dataToExport.forEach(row => {
        const rowData = [
          escapeCsvValue(row.CON_ID), escapeCsvValue(row.NAME), escapeCsvValue(row.ADDRESS),
          escapeCsvValue(row.MRU),
          escapeCsvValue(row.REG_MOB_NO), escapeCsvValue(row.BASE_CLASS), escapeCsvValue(row.CONN_PHASE),
          escapeCsvValue(row.GOVT_STAT), escapeCsvValue(row.NAT_OF_CONN), escapeCsvValue(row.CONN_LOAD),
          escapeCsvValue(row.METER_NO),
          escapeCsvValue(row.discon_dt1 ? formatDate(row.discon_dt1) : ''),
          escapeCsvValue(row.CCC_CODE), escapeCsvValue(getCCCName(row.CCC_CODE)),
          escapeCsvValue(row.OUTSTANDING),
          escapeCsvValue(row.dd_due_date ? formatDate(row.dd_due_date) : ''),
          escapeCsvValue(row.observation)
        ];
        csvContent += rowData.join(",") + "\r\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      const today = new Date().toISOString().slice(0, 10);
      link.setAttribute("download", `upcoming_dd_export_${today}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // --- Portal Logic (Phase 3) ---
    let portalBaseData = [];
    let portalFilteredData = [];
    let portalSearchValue = "";
    let portalSortColumn = "dd_due_date";
    let portalSortDirection = "asc";

    function openPortal(officeCode) {
      const today = todayStr();
      const code = String(officeCode);
      const officeKey = summaryTab === 'region' ? 'ZONE_CODE' : (summaryTab === 'division' ? 'DIV_CODE' : 'CCC_CODE');

      // 1. Get base data based on summary selection
      let data = allFilteredRowsForSummary.filter(r => String(r[officeKey]) === code);

      // 2. Apply category filters
      if (summaryFilterType === 'zero_osd') data = data.filter(r => r.OUTSTANDING === 0);
      else if (summaryFilterType === 'already_dd') data = data.filter(r => r.dd_due_date && r.dd_due_date < today);
      else if (summaryFilterType === 'dd_today') data = data.filter(r => r.dd_due_date === today);
      else if (summaryFilterType === 'dd_7') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(6));
      else if (summaryFilterType === 'dd_15') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(14));
      else if (summaryFilterType === 'dd_30') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(29));

      portalBaseData = data;
      portalFilteredData = [...data];
      portalSearchValue = "";
      document.getElementById('portalSearch').value = "";

      document.getElementById('portalTitle').innerText = getCCCName(officeCode);
      document.getElementById('portalSubTitle').innerText = `${data.length} consumers found for ${summaryFilterType.replace('_', ' ').toUpperCase()}`;

      renderPortalTable();
      document.getElementById('consumerPortal').classList.remove('hidden');
      lucide.createIcons();
    }

    function renderPortalTable() {
      const tbody = document.getElementById('portalDataBody');
      tbody.innerHTML = "";
      const today = todayStr();

      // Apply Filter
      let data = portalBaseData.filter(row => {
        if (!portalSearchValue) return true;
        const s = portalSearchValue.toLowerCase();
        return String(row.CON_ID).toLowerCase().includes(s) ||
          String(row.NAME).toLowerCase().includes(s) ||
          String(row.REG_MOB_NO).toLowerCase().includes(s);
      });

      // Apply Sort
      const col = portalSortColumn;
      const dir = portalSortDirection === 'asc' ? 1 : -1;
      data.sort((a, b) => {
        let va = a[col] || "";
        let vb = b[col] || "";
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
        return va < vb ? -1 * dir : (va > vb ? 1 * dir : 0);
      });

      portalFilteredData = data;

      data.forEach((row, idx) => {
        const ddDueDateStyle = (row.dd_due_date && row.dd_due_date < today) ? 'style="color:#ef4444; font-weight:bold;"' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row.CON_ID}</td>
          <td>${row.NAME}</td>
          <td>${row.REG_MOB_NO || "-"}</td>
          <td ${ddDueDateStyle}>${formatDate(row.dd_due_date)}</td>
          <td>${formatAmount(row.OUTSTANDING)}</td>
          <td>
            <button class="minimal-btn" onclick="showRowModal(${JSON.stringify(row).replace(/"/g, '&quot;')})">Details</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function onPortalSearch() {
      portalSearchValue = document.getElementById('portalSearch').value.trim();
      renderPortalTable();
    }

    function setPortalSort(col) {
      if (portalSortColumn === col) {
        portalSortDirection = portalSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        portalSortColumn = col;
        portalSortDirection = 'asc';
      }
      renderPortalTable();
    }

    function downloadCSVFromPortal() {
      if (portalFilteredData.length === 0) return;

      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "CON_ID,NAME,MOBILE,DUE_DATE,OSD\r\n";

      portalFilteredData.forEach(row => {
        csvContent += `${row.CON_ID},"${row.NAME}",${row.REG_MOB_NO},${row.dd_due_date},${row.OUTSTANDING}\r\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `portal_export_${portalSortColumn}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    // --- Improved Summary Modal Logic ---
    let summaryTab = 'region';
    let summaryFilterType = 'all';
    let summarySortColumn = 'name'; // 'name', 'count', 'osd'
    let summarySortDirection = 'asc';

    async function showSummaryModal(filterType = 'all') {
      summaryFilterType = filterType;
      const modal = document.getElementById('summaryModal');
      const title = document.getElementById('summaryModalTitle');

      const categoryNames = {
        'all': 'All Consumers',
        'zero_osd': 'Zero OSD DD',
        'already_dd': 'Already DD',
        'dd_today': 'DD Today',
        'dd_7': 'DD in 7 Days',
        'dd_15': 'DD in 15 Days',
        'dd_30': 'DD in 30 Days'
      };

      title.innerText = `Unit-wise Summary: ${categoryNames[filterType] || 'All'}`;
      modal.classList.remove('hidden');

      // Select the first tab (Region)
      const firstTab = document.querySelector('.summary-tab-btn');
      switchSummaryTab('region', firstTab);

      // Hide hint
      const hint = document.getElementById('summaryHint');
      if (hint) hint.classList.remove('visible');
    }

    function switchSummaryTab(tab, btn) {
      summaryTab = tab;
      summarySortColumn = 'name';
      summarySortDirection = 'asc';
      document.querySelectorAll('.summary-tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderSummaryTable();
    }

    function setSummarySort(col) {
      if (summarySortColumn === col) {
        summarySortDirection = summarySortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        summarySortColumn = col;
        summarySortDirection = 'asc';
      }
      renderSummaryTable();
    }

    function renderSummaryTable() {
      const head = document.getElementById('summaryTableHead');
      const body = document.getElementById('summaryTableBody');
      const foot = document.getElementById('summaryTableFoot');
      const today = todayStr();

      // Filter base data for summary rows
      let data = allFilteredRowsForSummary;
      if (summaryFilterType === 'zero_osd') data = data.filter(r => r.OUTSTANDING === 0);
      else if (summaryFilterType === 'already_dd') data = data.filter(r => r.dd_due_date && r.dd_due_date < today);
      else if (summaryFilterType === 'dd_today') data = data.filter(r => r.dd_due_date === today);
      else if (summaryFilterType === 'dd_7') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(6));
      else if (summaryFilterType === 'dd_15') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(14));
      else if (summaryFilterType === 'dd_30') data = data.filter(r => r.dd_due_date >= today && r.dd_due_date <= dateOffsetStr(29));

      const summary = {};
      const summaryRows = [];
      const officeKey = summaryTab === 'region' ? 'ZONE_CODE' : (summaryTab === 'division' ? 'DIV_CODE' : 'CCC_CODE');

      data.forEach(row => {
        const key = row[officeKey];
        if (!key) return;
        if (!summary[key]) summary[key] = { count: 0, osd: 0 };
        summary[key].count++;
        summary[key].osd += parseFloat(row.OUTSTANDING) || 0;
      });

      Object.keys(summary).forEach(key => {
        summaryRows.push({
          key: key,
          name: getCCCName(key),
          count: summary[key].count,
          osd: summary[key].osd
        });
      });

      // Apply Sorting
      const dir = summarySortDirection === 'asc' ? 1 : -1;
      summaryRows.sort((a, b) => {
        let va = a[summarySortColumn];
        let vb = b[summarySortColumn];
        if (typeof va === 'string') {
          va = va.toLowerCase();
          vb = vb.toLowerCase();
        }
        return va < vb ? -1 * dir : (va > vb ? 1 * dir : 0);
      });

      const getSortIcon = (col) => {
        if (summarySortColumn !== col) return "";
        return summarySortDirection === 'asc' ? ' \u2191' : ' \u2193';
      };

      head.innerHTML = `
        <tr>
          <th>#</th>
          <th onclick="setSummarySort('name')" style="cursor:pointer">Unit Name${getSortIcon('name')}</th>
          <th onclick="setSummarySort('count')" style="cursor:pointer">Count${getSortIcon('count')}</th>
          <th onclick="setSummarySort('osd')" style="cursor:pointer">Total OSD${getSortIcon('osd')}</th>
        </tr>
      `;
      body.innerHTML = "";

      let totC = 0, totO = 0;
      summaryRows.forEach((item, idx) => {
        totC += item.count;
        totO += item.osd;
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-800 transition-colors cursor-pointer";
        tr.innerHTML = `<td>${idx + 1}</td><td>${item.name}</td><td>${item.count}</td><td>${formatAmount(item.osd)}</td>`;
        tr.onclick = () => openPortal(item.key);
        body.appendChild(tr);
      });

      foot.innerHTML = `<tr><td colspan="2">Total</td><td>${totC}</td><td>${formatAmount(totO)}</td></tr>`;
    }

    function drillDownFromSummary(officeCode) {
      hideModal('summaryModal');

      const regionEl = document.getElementById('regionFilter');
      const divisionEl = document.getElementById('divisionFilter');
      const cccEl = document.getElementById('cccFilter');

      const code = String(officeCode);
      if (cccHierarchy[code]) {
        regionEl.value = code;
        onRegionChange();
      } else {
        for (const rKey in cccHierarchy) {
          if (cccHierarchy[rKey].divisions[code]) {
            regionEl.value = rKey;
            onRegionChange();
            divisionEl.value = code;
            onDivisionChange();
            break;
          }
          for (const dKey in cccHierarchy[rKey].divisions) {
            if (cccHierarchy[rKey].divisions[dKey].cccs[code]) {
              regionEl.value = rKey;
              onRegionChange();
              divisionEl.value = dKey;
              onDivisionChange();
              cccEl.value = code;
              onCCCChange();
              break;
            }
          }
        }
      }

      resetAllDDButtons();
      if (summaryFilterType === 'already_dd') alreadyDDActive = true;
      else if (summaryFilterType === 'dd_today') ddTodayActive = true;
      else if (summaryFilterType === 'dd_7') dd7Active = true;
      else if (summaryFilterType === 'dd_15') dd15Active = true;
      else if (summaryFilterType === 'dd_30') dd30Active = true;
      else if (summaryFilterType === 'zero_osd') {
        // No direct toggle for zero osd yet, maybe just update the page title/search?
        // We'll leave it in the summary for now.
      }

      showMainContent();
      fetchPage(1);
      lucide.createIcons();
    }

    // --- Date Helpers ---
    function todayStr() { return new Date().toISOString().slice(0, 10); }
    function dateOffsetStr(days) {
      const d = new Date();
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    // Initial load
    initialLoad();
    showSummaryHint();
  </script>

</body>

</html>