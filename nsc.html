<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pending NSC: Malda Zone</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Google Fonts - Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- noUiSlider CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">


  <style>
/* Compact Android Material Design CSS */

:root {
  /* Professional Color Palette */
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --primary-light: #3b82f6;
  --secondary: #64748b;
  --accent: #06b6d4;
  
  /* Neutral Grays */
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --gray-900: #0f172a;
  
  /* Semantic Colors */
  --surface: #ffffff;
  --background: var(--gray-200);
  --error: #ef4444;
  --success: #10b981;
  --warning: #f59e0b;
  --info: var(--accent);
  
  /* Text Colors */
  --text-primary: var(--gray-900);
  --text-secondary: var(--gray-600);
  --text-tertiary: var(--gray-500);
  --text-on-primary: #ffffff;
  
  /* Professional elevation shadows */
  --elevation-1: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --elevation-2: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --elevation-3: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --elevation-4: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Spacing scale */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* Typography scale */
  --text-xs: 0.75rem;
  --text-sm: 0.875rem;
  --text-base: 1rem;
  --text-lg: 1.125rem;
  --text-xl: 1.25rem;
}

* {
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background-color: var(--background);
  color: var(--text-primary);
  margin: 0;
  padding: var(--spacing-sm);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Container System */
.container-fluid {
  padding: 0 var(--spacing-sm);
  max-width: 100%;
}

@media (min-width: 1024px) {
  .container-fluid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);
  }
}

/* Compact Header */
.dashboard-header {
  background: var(--primary);
  color: var(--text-on-primary);
  padding: var(--spacing-sm) var(--spacing-md);
  margin: -var(--spacing-sm) -var(--spacing-sm) var(--spacing-md);
  box-shadow: var(--elevation-2);
  position: sticky;
  top: 0;
  z-index: 2000;
  min-height: 48px;
  display: flex;
  align-items: center;
}

.dashboard-header h2 {
  margin: 0;
  font-size: var(--text-lg);
  font-weight: 500;
  letter-spacing: 0.15px;
}

@media (min-width: 768px) {
  .dashboard-header {
    border-radius: var(--spacing-sm);
    margin: 0 0 var(--spacing-lg);
    padding: var(--spacing-md) var(--spacing-md);
    min-height: 56px;
  }
}

@media (max-width: 767px) {
  .dashboard-header {
    margin-left: calc(-50vw + 50%);
    margin-right: calc(-50vw + 50%);
    width: 100vw;
    border-radius: 0;
    padding: var(--spacing-sm) var(--spacing-md);
    min-height: 44px;
  }
}

/* Compact Grid */
.col-lg-2-4 {
  flex: 0 0 auto;
  width: 20%;
}

@media (max-width: 768px) {
  .col-lg-2-4 {
    width: 50%;
    padding: 0 var(--spacing-xs);
  }
}

/* Material Cards */
.card {
  background: var(--surface);
  border-radius: var(--spacing-sm);
  border: none;
  box-shadow: var(--elevation-1);
  border: 2px solid transparent; /* Add transparent border for smooth transition */
  margin-bottom: var(--spacing-md);
  overflow: hidden;
  transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
}

.kpi-card-active {
  transform: translateY(-4px);
  box-shadow: var(--elevation-4);
  border-color: var(--primary-dark) !important;
}

.card:hover {
  box-shadow: var(--elevation-2);
}

.kpi-card-active::after {
  content: '';
  position: absolute;
  bottom: -16px; /* Position it just below the card */
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-top: 16px solid; /* The color will be inherited */
  z-index: 1;
  transition: opacity 0.2s ease, bottom 0.2s ease;
  opacity: 0;
}

.kpi-card-active.connector-visible::after {
  opacity: 1;
  bottom: -15px; /* Final position */
}

/* Connector colors matching KPI cards */
.kpi-card-1.kpi-card-active::after { border-top-color: var(--primary-dark); }
.kpi-card-2.kpi-card-active::after { border-top-color: #15803d; } /* Darker success */
.kpi-card-3.kpi-card-active::after { border-top-color: #d97706; } /* Darker warning */
.kpi-card-4.kpi-card-active::after { border-top-color: #0891b2; } /* Darker accent */
.kpi-card-5.kpi-card-active::after { border-top-color: var(--gray-800); }
.kpi-card-6.kpi-card-active::after { border-top-color: #d00000; }

/* Hide connector on mobile where the table is inline */
@media (max-width: 768px) {
  .kpi-card-active::after {
    display: none;
  }
}

.kpi-details-container {
  background-color: var(--surface);
  border-radius: 0 0 var(--spacing-sm) var(--spacing-sm);
  margin-top: -1rem; /* Pulls it up to the KPI cards */
  padding-top: 1rem; /* Restores space inside */
  box-shadow: var(--elevation-2);
  margin-bottom: var(--spacing-md);
  position: relative; /* Needed for z-index to work */
  border-top: 4px solid transparent; /* Placeholder for the colored border */
  transition: border-color 0.3s ease;
}

.card-body {
  padding: var(--spacing-md);
}

/* Compact KPI Cards */
.kpi-card-1 { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }
.kpi-card-2 { background: linear-gradient(135deg, var(--success), #34d399); }
.kpi-card-3 { background: linear-gradient(135deg, var(--warning), #fbbf24); }
.kpi-card-4 { background: linear-gradient(135deg, var(--accent), #22d3ee); }
.kpi-card-5 { background: linear-gradient(135deg, var(--gray-700), var(--gray-600)); }

.kpi-card-1, .kpi-card-2, .kpi-card-3, .kpi-card-4, .kpi-card-5 {
  color: var(--text-on-primary);
  position: relative;
  min-height: 50px;
}

.kpi-card-count {
  font-size: var(--text-xl);
  font-weight: 700;
  margin: 0 0 var(--spacing-xs);
  line-height: 1.2;
}

.kpi-card-label {
  font-size: var(--text-xs);
  font-weight: 600;
  margin: 0;
  opacity: 0.9;
  line-height: 1.3;
}

.kpi-card-icon {
  position: absolute;
  top: var(--spacing-sm);
  right: var(--spacing-sm);
  font-size: var(--text-lg);
  opacity: 0.4;
}

/* Compact Filters */
.filter-card {
  background: var(--surface);
  border-radius: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  box-shadow: var(--elevation-1);
}

.filter-title {
  font-size: var(--text-sm);
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
  color: var(--text-primary);
}

/* Android-style Form Controls */
.form-select {
  border: 1px solid var(--gray-300);
  border-radius: var(--spacing-xs);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: var(--text-sm);
  line-height: 1.5;
  background: var(--surface);
  color: var(--text-primary);
  min-height: 40px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23475569'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right var(--spacing-sm) center;
  background-size: 20px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-select:hover {
  border-color: var(--gray-400);
}

/* Compact Navigation */
.nav-pills {
  background: var(--surface);
  border-radius: var(--spacing-sm);
  padding: var(--spacing-xs);
  box-shadow: var(--elevation-1);
  margin-bottom: var(--spacing-md);
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-xs);
}

.nav-pills .nav-link {
  border-radius: var(--spacing-xs);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: var(--text-sm);
  font-weight: 500;
  color: var(--text-secondary);
  border: none;
  background: transparent;
  transition: all 0.2s ease;
  min-height: 36px;
  display: flex;
  align-items: center;
}

.nav-pills .nav-link.active {
  background: var(--primary);
  color: var(--text-on-primary);
  box-shadow: var(--elevation-1);
}

.nav-pills .nav-link:hover:not(.active) {
  background: var(--gray-100);
  color: var(--text-primary);
}

/* Compact Charts */
.chart-container {
  background: var(--surface);
  border-radius: var(--spacing-sm);
  padding: var(--spacing-md);
  box-shadow: var(--elevation-1);
  height: 400px;
  overflow: hidden;
}

@media (max-width: 768px) {
  .chart-container {
    height: 300px;
    padding: var(--spacing-sm);
  }
}

/* Compact Tables */
.detail-table {
  background: var(--surface);
  border-radius: var(--spacing-sm);
  overflow: hidden;
  box-shadow: var(--elevation-1);
}

.detail-table .table {
  margin: 0;
  font-size: var(--text-sm);
}

.detail-table thead {
  background: var(--gray-100);
}

.detail-table th {
  font-weight: 600;
  font-size: var(--text-xs);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: var(--spacing-sm);
  border: none;
  color: var(--text-secondary);
}

.detail-table td {
  padding: var(--spacing-sm);
  border-color: var(--gray-200);
  vertical-align: middle;
  color: var(--text-primary);
}

/* Section Titles */
.section-title {
  font-size: var(--text-base);
  font-weight: 600;
  margin-bottom: var(--spacing-md);
  color: var(--text-primary);
  position: relative;
  padding-left: var(--spacing-sm);
}

.section-title::before {
  content: '';
  position: absolute;
  left: 0;
  top: 2px;
  height: calc(100% - 4px);
  width: 3px;
  background: var(--primary);
  border-radius: 2px;
}

/* Mobile Optimizations */
@media (max-width: 768px) {
  body {
    padding: var(--spacing-xs);
  }
  
  .dashboard-header h2 {
    font-size: var(--text-base);
  }
  
  .kpi-card-count {
    font-size: var(--text-lg);
  }
  
  .kpi-card-label {
    font-size: 0.7rem;
  }
  
  .card-body {
    padding: var(--spacing-sm);
  }
  
  .filter-card {
    padding: var(--spacing-xs) var(--spacing-sm);
  }
  
  .nav-pills .nav-link {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--text-xs);
    min-height: 32px;
  }
  
  .section-title {
    font-size: var(--text-sm);
    margin-bottom: var(--spacing-sm);
  }
  
  /* Two-column filter layout for mobile */
  .filters-row > [class*="col-"] {
    width: 50%;
    padding: 0 var(--spacing-xs);
  }

  /* Compact slider on mobile */
  #delaySlider {
    height: 16px;
    margin: var(--spacing-xs) 0;
  }
  
  #delaySlider .noUi-handle {
    width: 14px;
    height: 14px;
    right: -7px;
    top: -5.5px;
  }
  
  .card.p-3.mb-3 {
    padding: var(--spacing-xs) var(--spacing-sm) !important;
  }
  
  .card.p-3.mb-3 label {
    font-size: var(--text-xs) !important;
  }
  
  #delayMinLabel,
  #delayMaxLabel {
    font-size: 0.65rem !important;
    color: var(--text-tertiary) !important;
  }
}

/* Sub-rows and expandable content */
.sub-row table {
  background: var(--gray-50);
  border-left: 3px solid var(--primary);
  margin: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--spacing-xs);
  font-size: var(--text-sm);
  overflow: hidden;
}

.sub-row td, .sub-row th {
  padding: var(--spacing-xs) var(--spacing-sm);
}

.sub-row table thead th {
  background: var(--gray-200);
  font-weight: 500;
  color: var(--text-secondary);
}

/* Loading states */
@keyframes shimmer {
  0% { background-position: -200px 0; }
  100% { background-position: calc(200px + 100%) 0; }
}

.loading {
  background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-300) 50%, var(--gray-200) 75%);
  background-size: 200px 100%;
  animation: shimmer 1.5s infinite;
  border-radius: var(--spacing-xs);
  height: 16px;
  margin: var(--spacing-xs) 0;
}

/* Modal dialogs */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: var(--spacing-md);
}



.modal-close {
  position: absolute;
  right: var(--spacing-sm);
  top: var(--spacing-sm);
  cursor: pointer;
  color: var(--text-tertiary);
  font-size: var(--text-lg);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s ease;
}

.modal-close:hover {
  background: var(--gray-100);
  color: var(--text-secondary);
}

/* Compact Slider Styling */
#delaySlider {
  margin: var(--spacing-sm) 0;
  height: 20px;
}

#delaySlider .noUi-target {
  background: var(--gray-200);
  border-radius: 2px;
  border: none;
  height: 3px;
  box-shadow: none;
}

#delaySlider .noUi-connect {
  background: var(--primary);
}

#delaySlider .noUi-handle {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--surface);
  border: 2px solid var(--primary);
  box-shadow: var(--elevation-1);
  cursor: grab;
  right: -8px;
  top: -6.5px;
}

#delaySlider .noUi-handle:active {
  cursor: grabbing;
  transform: scale(1.05);
  border-color: var(--primary-dark);
}

#delaySlider .noUi-handle:before,
#delaySlider .noUi-handle:after {
  display: none;
}

#delayMinLabel,
#delayMaxLabel {
  font-size: 0.7rem;
  color: var(--text-tertiary);
  font-weight: 400;
  margin-top: var(--spacing-xs);
}

/* Compact slider container */
.card.p-3.mb-3 {
  padding: var(--spacing-sm) !important;
  margin-bottom: var(--spacing-sm) !important;
}

.card.p-3.mb-3 label {
  font-size: var(--text-sm) !important;
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
  color: var(--text-primary);
}

.small span {
  font-size: 0.7rem !important;
  color: var(--text-tertiary);
}

/* Utility classes */
.text-primary { color: var(--primary) !important; }
.text-secondary { color: var(--secondary) !important; }
.bg-primary { background-color: var(--primary) !important; }
.bg-secondary { background-color: var(--secondary) !important; }

/* Animation utilities */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .card:hover {
    box-shadow: var(--elevation-1);
  }
  
  .nav-pills .nav-link:hover {
    background: transparent;
  }
  
  .nav-pills .nav-link:active {
    background: rgba(25, 118, 210, 0.1);
  }
}
.collapse:not(.show) {
  display: none !important;
}

.collapse.show {
  display: block !important;
  height: auto !important;
  overflow: visible !important;
}
.tab-pane .chart-container {
  height: auto !important;
  overflow: visible !important;
}
@media (max-width: 768px) {
  /* Reduce vertical spacing between cards */
  .card {
    margin-bottom: 0.2rem !important;
  }

  /* Center align text and contents inside KPI cards */
  .kpi-card-1 .card-body,
  .kpi-card-2 .card-body,
  .kpi-card-3 .card-body,
  .kpi-card-4 .card-body,
  .kpi-card-5 .card-body {
    text-align: center;
    align-items: center;
    justify-content: center;
  }

  .kpi-card-count,
  .kpi-card-label {
    text-align: center;
    margin-left: auto;
    margin-right: auto;
  }

  .kpi-card-icon {
    top: 6px;
    right: 6px;
    font-size: 1.2rem;
  }
}

.nav-pills .nav-link.active {
  background-color: var(--primary) !important;
  color: var(--text-on-primary) !important;
}

.nav-pills .nav-link.active i {
  color: var(--text-on-primary) !important;
}
/* Full page loading overlay */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s ease;
}
.modal-backdrop {
    z-index: 1040 !important; /* Bootstrap's default is often 1040, but you might need higher */
  }

/* Modern 3-dot loading animation */
.loading-dots {
  display: flex;
  gap: 10px;
}

.loading-dots .dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  animation: dot-bounce 1.4s infinite ease-in-out both;
}

.loading-dots .dot:nth-child(1) {
  background-color: var(--primary); /* Blue */
  animation-delay: -0.32s;
}

.loading-dots .dot:nth-child(2) {
  background-color: var(--success); /* Green */
  animation-delay: -0.16s;
}

.loading-dots .dot:nth-child(3) {
  background-color: var(--warning); /* Yellow */
}

@keyframes dot-bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1.0); }
}
  .modal {
    z-index: 1050 !important; /* Bootstrap's default is often 1050, ensure it's higher than backdrop */
  }

.modal-content {
  border-radius: var(--spacing-md) !important;
  border: none;
  box-shadow: var(--elevation-4);
  overflow: hidden;
  }

#urgentModal .modal-dialog {
  max-width: 900px;
}

#urgentModal .modal-header {
  background: linear-gradient(135deg, var(--error), #ff7b7b);
  color: white;
  padding: var(--spacing-md);
  border-bottom: none;
}

#urgentModal .modal-title {
  font-size: var(--text-lg);
  font-weight: 600;
}

#urgentModal .modal-body {
  padding: 0;
  max-height: 70vh;
  overflow-y: auto;
}

#urgentModal .modal-footer {
  background-color: var(--gray-50);
  border-top: 1px solid var(--gray-200);
  padding: var(--spacing-sm) var(--spacing-md);
}

#urgentModal .btn-close {
  filter: brightness(0) invert(1);
  opacity: 0.8;
}

#urgentModal .btn-danger {
  background-color: #d00000 !important; /* Make the action button red */
}
.urgent-scroll-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 767.98px) {
  #urgentModal .modal-content {
    padding: 0 !important;
    max-height: 100vh;
    overflow-y: auto;
    border-radius: 0 !important;
    background: #fff;
    color: #000;
    font-size: var(--text-sm);
  }

  #urgentModal .modal-title {
    font-size: var(--text-sm) !important;
    font-weight: 600;
  }

  #urgentModal .modal-body {
    padding: 0 !important;
    font-size: var(--text-xs) !important;
    max-height: 90vh;
    overflow-y: auto;
  }

  #urgentModal .btn {
    font-size: var(--text-xs) !important;
    padding: 0.3rem 0.6rem !important;
  }

} /* This closes the outer media query */

/* This was a nested, invalid media query. Moving it outside. */
@media (max-width: 767.98px) {
  #urgentModal .modal-dialog {
    max-width: 96vw !important;
    margin: 1rem auto !important;
  }

  #urgentModal .modal-content {
    padding: 0 !important;
    max-height: 100vh;
    overflow-y: auto;
    border-radius: 0 !important;
    background: #fff;
    color: #000;
    font-size: var(--text-sm);
  }

  #urgentModal .modal-title {
    font-size: var(--text-sm) !important;
    font-weight: 600;
  }

  #urgentModal .modal-body {
    padding: 0 !important;
    font-size: var(--text-xs) !important;
    max-height: 90vh;
    overflow-y: auto;
  }

  #urgentModal .btn {
    font-size: var(--text-xs) !important;
    padding: 0.3rem 0.6rem !important;
  }

  .urgent-download-btn {
    font-size: 0.65rem !important;
    padding: 0.25rem 0.5rem !important;
  }

  .urgent-scroll-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
  }
}

.urgent-delay-table {
  table-layout: auto !important;
  width: auto !important;
  white-space: nowrap !important;
}

.urgent-delay-table th,
.urgent-delay-table td {
  white-space: nowrap;
}

.modal-backdrop {
  z-index: 1040 !important;
}

.modal {
  z-index: 1050 !important;
}

/* Rotate chevron for collapsible sections */
[data-bs-toggle="collapse"] > .fa-chevron-down {
  transition: transform 0.2s ease-in-out;
}

[data-bs-toggle="collapse"][aria-expanded="false"] > .fa-chevron-down {
  transform: rotate(-90deg);
}

/* Table Row Hover Effect */
.table tbody tr:hover {
  background-color: var(--gray-200) !important;
  cursor: default;
}


  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="loading-dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
</div>

  <div class="container-fluid">

    <!-- Dashboard Header -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex flex-wrap align-items-baseline gap-2">
        <h2 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i> Pending NSC</h2>
        <div id="reportDateSpan" style="font-size: 0.75rem; color: #ffffff;">Updated on: <span id="reportDate">Loading...</span></div>
      </div>
      <span id="maxDateSpan" style="font-size: 0.75rem; color: #ffe600;"></span>
    </div>

    <!-- Performance Ticker/Banner -->
    <div id="performanceTicker" class="performance-ticker-container mb-3" style="display: none;">
      <div class="ticker-wrap">
        <div id="tickerItems" class="ticker-move">
          <!-- Items will be injected by JS -->
        </div>
      </div>
    </div>

    <style>
      .performance-ticker-container {
        height: 32px;
        overflow: hidden;
        background-color: transparent;
        box-shadow: none;
        padding: 0;
      }
      .ticker-wrap {
        height: 100%;
        position: relative;
      }
      .ticker-move {
        /* This will now be a container for a single, fading item */
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      .ticker-item {
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
        animation: fade-in-out 5s ease-in-out;
      }
      .good-performer { color: var(--success); }
      .bad-performer { color: var(--error); }
      
      @keyframes fade-in-out {
        0%, 100% { opacity: 0; }
        10%, 90% { opacity: 1; }
      }
    </style>

    <!-- Consumer Class Filter -->
    <div class="d-flex flex-wrap flex-row gap-2 align-items-center mb-3" id="classFilterOptions" style="font-size: 0.8rem;">
      <label class="form-check mb-0 me-3">
        <input class="form-check-input" type="radio" name="classFilter" value="all" checked>
        <span class="form-check-label">All Classes <span class="text-muted" id="allClassesCountPercent"></span></span>
      </label>
      <label class="form-check mb-0 me-3">
        <input class="form-check-input" type="radio" name="classFilter" value="non-agri">
        <span class="form-check-label">Excluding Agri <span class="text-muted" id="nonAgriCountPercent"></span></span>
      </label>
      <label class="form-check mb-0">
        <input class="form-check-input" type="radio" name="classFilter" value="agri-only">
        <span class="form-check-label">Only Agri <span class="text-muted" id="agriOnlyCountPercent"></span></span>
      </label>
    </div>

      <!-- Delay Range Slider (Dual Handle) -->
<div class="card p-3 mb-3" style="background: #fff9db; border-left: 5px solid #f9c74f; border-radius: 12px;">
  <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#delaySliderCollapse" aria-expanded="false" aria-controls="delaySliderCollapse" style="cursor: pointer;">
    <label class="mb-0" style="font-weight: 600; font-size: 0.9rem;">Select delay range for connection</label>
    <i class="fas fa-chevron-down"></i>
  </div>
  <div class="collapse" id="delaySliderCollapse">
    <div id="delaySlider" style="margin-top: 1rem;"></div>
    <div id="delaySliderCount" style="margin-top: -0.2rem; text-align: center; z-index:100;font-size: 0.75rem; font-style: italic; color: #d00000;"></div>
    <div class="d-flex justify-content-between mt-2 small">
      <span id="delayMinLabel">0 days</span>
      <span id="delayMaxLabel">100 days</span>
    </div>
  </div>
</div>

    <!-- Filters Row -->
<div class="row g-2" style="margin-bottom: 0.6rem;">
  <div class="col-6 col-md-4">
    <select id="regionSelect" class="form-select">
      <option value="">Select Region</option>
    </select>
  </div>
  <div class="col-6 col-md-4">
    <select id="divnSelect" class="form-select">
      <option value="">Select Division</option>
    </select>
  </div>
  <div class="col-6 col-md-4">
    <select id="suppSelect" class="form-select">
      <option value="">Select CCC</option>
    </select>
  </div>
  <div class="col-6 col-md-4">
    <select id="poleFilter" class="form-select">
      <option value="">Pole/Non-Pole</option>
      <option value="Pole">Pole</option>
      <option value="Non-Pole">Non-Pole</option>
    </select>
  </div>
  <div class="col-6 col-md-4">
    <select id="delayRangeFilter" class="form-select">
      <option value="">Select Delay Range</option>
    </select>
  </div>
  <div class="col-6 col-md-4">
    <select id="delayRange2Filter" class="form-select">
      <option value="">Select Delay Range-2</option>
    </select>
  </div>
</div>



  
    <!-- KPI Cards Row -->
<!-- KPI Cards Row -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-6 g-3">

  <!-- Total Pending Card -->
  <div class="col">
    <div class="card kpi-card-1" id="totalPendingCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-clock kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="totalPending">0</h2>
        <p class="kpi-card-label">Total Pending</p>
      </div>
      <div class="collapse" id="totalPendingCollapse">
        <div class="card detail-table" id="totalPendingTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Non Pole Cases Card -->
  <div class="col">
    <div class="card kpi-card-2" id="nonPoleCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-home kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="nonPole">0</h2>
        <p class="kpi-card-label">Non Pole Cases</p>
      </div>
      <div class="collapse" id="nonPoleCollapse">
        <div class="card detail-table" id="nonPoleTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Pole Cases Card -->
  <div class="col">
    <div class="card kpi-card-3" id="poleCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-bolt kpi-card-icon"></i>
        <h2 class="kpi-card-count" style="font-size: 1.5rem;">
          <span id="pole">0</span>
          <span class="text-light" id="poleSum" style="font-size: 0.85rem; font-weight: 400; opacity: 0.9;">(0)</span>
        </h2>
        <p class="kpi-card-label" style="font-size: 0.0.75rem;">Pole Cases / Reqd. Pole</p>
        
      </div>
      <div class="collapse" id="poleCollapse">
        <div class="card detail-table" id="poleTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Industrial Pending Card -->
  <div class="col">
    <div class="card kpi-card-4" id="industrialPendingCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-industry kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="industrialPending">0</h2>
        <p class="kpi-card-label">Industrial Pending</p>
      </div>
      <div class="collapse" id="industrialPendingCollapse">
        <div class="card detail-table" id="industrialPendingTableContainer"></div>
      </div>
    </div>
  </div>

  <!-- Commercial 3-Ph Card -->
  <div class="col">
    <div class="card kpi-card-5" id="commercial3phCard" style="cursor:pointer;">
      <div class="card-body position-relative">
        <i class="fas fa-plug kpi-card-icon"></i>
        <h2 class="kpi-card-count" id="commercial3ph">0</h2>
        <p class="kpi-card-label">Commercial 3-Ph</p>
      </div>
      <div class="collapse" id="commercial3phCollapse">
        <div class="card detail-table" id="commercial3phTableContainer"></div>
      </div>
    </div>
  </div>
<!-- Initially Withheld Card -->
<div class="col">
  <div class="card kpi-card-4" id="initiallyWithheldCard" style="cursor:pointer; background: linear-gradient(to right, #d00000, #ff4d4d); color: white;">
    <div class="card-body position-relative">
      <i class="fas fa-ban kpi-card-icon" style="display: block;"></i>
      
      <h2 class="kpi-card-count" id="initiallyWithheldCount" style="display: inline;">0</h2>
      <p class="text-light" id="initiallyWithheldPercent" style="font-size: 0.9rem; font-weight: 400; opacity: 0.9; margin-top: -10px; display: inline;">
        (0%)
      </p>      
      <p class="kpi-card-label">Initially Withheld</p>
    </div>
    <div class="collapse" id="initiallyWithheldCollapse">
      <div class="card detail-table" id="initiallyWithheldTableContainer"></div>
    </div>
  </div>
</div>

</div>

      

      
<!-- Shared collapse for desktop view -->
<div class="collapse" id="detailCollapse">
    <div class="kpi-details-container" id="detailTableContainer"></div>
  </div>
  
    <!-- Detailed Analysis Section -->
    <h2 class="section-title mb-4">Detailed Analysis</h2>
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="delay-tab" data-bs-toggle="pill" data-bs-target="#delay" type="button" role="tab">
          <i class="fas fa-hourglass-half me-2"></i>Delay Range
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="delay2-tab" data-bs-toggle="pill" data-bs-target="#delay2" type="button" role="tab">
          <i class="fas fa-hourglass-end me-2"></i>Delay Range-2
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pole-tab" data-bs-toggle="pill" data-bs-target="#pole-data" type="button" role="tab">
          <i class="fas fa-bolt me-2"></i>Pole/Non-Pole
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="duare-tab" data-bs-toggle="pill" data-bs-target="#duare" type="button" role="tab">
          <i class="fas fa-home me-2"></i>Duare Sarkar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="wo-tab" data-bs-toggle="pill" data-bs-target="#wo" type="button" role="tab">
          <i class="fas fa-file-contract me-2"></i>WO Status
        </button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="classwise-tab" data-bs-toggle="pill" data-bs-target="#classwise" type="button" role="tab">
          <i class="fas fa-layer-group me-2"></i>Class Wise
        </button>
      </li>

      <li class="nav-item" role="presentation">
  <button class="nav-link" id="phase-tab" data-bs-toggle="pill" data-bs-target="#phase" type="button" role="tab">
    <i class="fas fa-sitemap me-2"></i>Applied Phase
  </button>
</li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="agency-tab" data-bs-toggle="pill" data-bs-target="#agency" type="button" role="tab">
          <i class="fas fa-briefcase me-2"></i>Agency Wise
        </button>
      </li>
      
    </ul>
    
    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="delay" role="tabpanel">
        <div class="chart-container">
          <canvas id="delayChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="delay2" role="tabpanel">
        <div class="chart-container">
          <!-- Content will be generated by JS -->
        </div>
      </div>
      <div class="tab-pane fade" id="pole-data" role="tabpanel">
        <div class="chart-container">
          <canvas id="poleChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="duare" role="tabpanel">
        <div class="chart-container">
          <canvas id="duareChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="wo" role="tabpanel">
        <div class="chart-container">
          <canvas id="woChart"></canvas>
        </div>
      </div>
      <div class="tab-pane fade" id="classwise" role="tabpanel">
        <div class="chart-container">
          <canvas id="classwiseChart"></canvas> <!-- placeholder -->
        </div>
      </div>
      <div class="tab-pane fade" id="phase" role="tabpanel">
  <div class="chart-container">
    <div id="phaseChartContainer"></div>
  </div>
</div>

      <div class="tab-pane fade" id="agency" role="tabpanel">
        <div class="chart-container">
          <canvas id="agencyChart"></canvas> <!-- Placeholder, replaced by table -->
        </div>
      </div>
      
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    let delaySCMin = 0;
let delaySCMax = 100;

    // Data URL
    const dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRsUU2viBvYhSgR0RFwmZ1H8LkYCats9roQVCKvQeoU7dzg6ryR6IWZex9FT9tksp_DEM23ZgQ28Iyo/pub?output=csv";
    let rawData = [], filteredData = [];
    let charts = {};

    // Helper function to safely parse CSV data
    function parseCsvRow(row, headers) {
      const obj = {};
      row.forEach((val, idx) => {
        if (idx < headers.length) {
          obj[headers[idx]] = val;
        }
      });
      return obj;
    }

    // Fetch and process data
    async function fetchData() {
      try {
        showLoading(true);
        const res = await fetch(dataUrl);
        const text = await res.text();
        const parsed = Papa.parse(text.trim(), {
          header: true,
          skipEmptyLines: true
        });
        rawData = parsed.data;
        filteredData = [...rawData];
        // Get min/max DelayInSC values from data
const allSCValues = rawData.map(d => parseFloat(d.DelayInSC)).filter(v => !isNaN(v));
const minSC = allSCValues.length ? Math.min(...allSCValues) : 0;
const maxSC = allSCValues.length ? Math.max(...allSCValues) : 100;

delaySCMin = Math.floor(minSC);
delaySCMax = Math.ceil(maxSC);

// Initialize noUiSlider
const slider = document.getElementById('delaySlider');
if (slider.noUiSlider) slider.noUiSlider.destroy();  // In case of reload

noUiSlider.create(slider, {
  start: [delaySCMin, delaySCMax],
  connect: true,
  range: {
    min: delaySCMin,
    max: delaySCMax
  },
tooltips: [false, false],

  step: 1,
  behaviour: 'drag-tap'
});

slider.noUiSlider.on('update', function (values, handle) {
  delaySCMin = parseFloat(values[0]);
  delaySCMax = parseFloat(values[1]);

  document.getElementById('delayMinLabel').textContent = formatReadableDuration(delaySCMin);
  document.getElementById('delayMaxLabel').textContent = formatReadableDuration(delaySCMax);

  const matchingCount = rawData.filter(d => {
    const v = parseFloat(d.DelayInSC);
    return !isNaN(v) && v >= delaySCMin && v <= delaySCMax;
  }).length;

  document.getElementById('delaySliderCount').textContent = `${matchingCount} pending in the range`;
});



slider.noUiSlider.on('change', applyFilters); // Trigger filtering only on release

        // Get report update date from TODAY field in second row (index 1)
        if (rawData && rawData.length > 1 && rawData[1].TODAY) {
          document.getElementById('reportDate').textContent = rawData[1].TODAY;
        } else {
          document.getElementById('reportDate').textContent = "N/A";
        }
        
        populateFilters();
        updateRadioCounts(rawData); // Initial population of radio counts
        updateDashboard();
        drawTables(); // instead of drawCharts();
        showUrgentModal(rawData); 

            // ✅ Add this block here
    document.querySelectorAll('input[name="classFilter"]').forEach(radio => {
      radio.addEventListener('change', applyFilters);
    });
        showLoading(false);
      } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('totalPending').innerText = "Error";
        document.getElementById('reportDate').textContent = "Error loading data";
        alert("Failed to load data. Please check your internet connection and try again.");
        showLoading(false);
      }
    }






function showUrgentModal(data) {
  const sorted = data
    .filter(d => !isNaN(parseFloat(d.DelayInSC)))
    .sort((a, b) => parseFloat(b.DelayInSC) - parseFloat(a.DelayInSC))
    .slice(0, 10);

  if (sorted.length === 0) return;

  const container = document.getElementById("urgentModalBody");
  const isMobile = window.innerWidth < 768;

  const tableHtml = `
    <div class="urgent-scroll-wrapper">
      <table class="table table-striped table-hover mb-0 text-nowrap urgent-delay-table">
        <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 1;">
          <tr>
            ${
              isMobile
                ? `<th>#</th><th>Appl. No.</th><th>Class</th><th>Delay</th><th>CCC</th>`
                : `<th>#</th><th>Appl. No.</th><th>Class</th><th>Name</th><th>CCC</th><th>Delay</th>`
            }
          </tr>
        </thead>
        <tbody>
          ${sorted
            .map(
              (d, i) => `
                <tr>
                  <td class="text-center">${i + 1}</td>
                  <td>${d.APPL_NO || '-'}</td>
                  ${
                    isMobile
                      ? `
                    <td class="text-center">${(d.CONN_CLASS || '-').toUpperCase()}</td>
                    <td class="text-end">${formatDuration(d.DelayInSC)}</td>
                    <td>${d.SUPP_OFF || '-'}</td>
                  `
                      : `
                    <td>${(d.CONN_CLASS || '-').toUpperCase()}</td>
                    <td>${d.NAME || '-'}</td>
                    <td>${d.SUPP_OFF || '-'}</td>
                    <td class="text-end">${formatDuration(d.DelayInSC)}</td>
                  `
                  }
                </tr>
              `
            )
            .join('')}
        </tbody>
      </table>
    </div>
  `;

  container.innerHTML = tableHtml;

  const urgentModal = new bootstrap.Modal(document.getElementById("urgentModal"));
  urgentModal.show();
}









function parseDate(dateStr) {
  if (!dateStr || !dateStr.includes('/')) return new Date(0);
  const [dd, mm, yyyy] = dateStr.split('/');
  return new Date(`${yyyy}-${mm}-${dd}`);
}

function formatDuration(days) {
  const total = parseFloat(days) || 0;
  const yrs = Math.floor(total / 365);
  const remDays = total % 365;
  const months = Math.floor(remDays / 30);

  let durationString;
  if (yrs > 0) {
    durationString = `${yrs}Y ${months}M`;
  } else {
    durationString = `${months}M`;
  }

  // If delay is more than 2 months (approx 60 days), make it red and bold
  if (total > 60) {
    return `<span style="color: #d00000; font-weight: 600;">${durationString}</span>`;
  }
  return durationString;
}





    // Show/hide loading indicators
    function showLoading(isLoading) {
      const elements = ['totalPending', 'nonPole', 'pole', 'industrialPending', 'commercial3ph', 'initiallyWithheldCount'];

      elements.forEach(id => {
      const el = document.getElementById(id);
      if (isLoading) {
      el.innerHTML = '<div class="loading"></div>';
    }
  });
}


    // Populate filter dropdowns with unique values
    function populateFilters() {
  const region = document.getElementById('regionSelect').value;
  const divn = document.getElementById('divnSelect').value;

  // Unique helper
  const unique = (arr, key) => {
    return [...new Set(arr.map(x => x[key]).filter(Boolean).map(v => v.trim()))].sort();
  };

  // First populate Region normally from rawData
  const regions = unique(rawData, 'REGION');
  const regionSelect = document.getElementById('regionSelect');
  const previousRegion = regionSelect.value;
  regionSelect.innerHTML = `<option value="">Select Region</option>`;
  regions.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    if (r === previousRegion) opt.selected = true;
    regionSelect.appendChild(opt);
  });

  // Populate Division based on selected Region
  let divns = rawData;
  if (region) {
    divns = rawData.filter(d => d.REGION === region);
  }
  const divisions = unique(divns, 'DIVN_NAME');
  const divnSelect = document.getElementById('divnSelect');
  const previousDivn = divnSelect.value;
  divnSelect.innerHTML = `<option value="">Select Division</option>`;
  divisions.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    if (d === previousDivn) opt.selected = true;
    divnSelect.appendChild(opt);
  });

  // Populate Office based on selected Division
  let supps = rawData;
  if (divn) {
    supps = rawData.filter(d => d.DIVN_NAME === divn);
  } else if (region) {
    supps = rawData.filter(d => d.REGION === region);
  }
  const offices = unique(supps, 'SUPP_OFF');
  const suppSelect = document.getElementById('suppSelect');
  const previousSupp = suppSelect.value;
  suppSelect.innerHTML = `<option value="">Select CCC</option>`;
  offices.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    if (s === previousSupp) opt.selected = true;
    suppSelect.appendChild(opt);
  });

  // Populate Delay Range
// Sort Delay Ranges based on DelaySerial
const delayRangeMap = {};
rawData.forEach(d => {
  const range = d.DelayRange;
  const serial = parseInt(d.DelaySerial);
  if (range && !delayRangeMap[range]) {
    delayRangeMap[range] = serial;
  }
});
// Delay Range-2 Buckets
const delayRange2Options = [
  "Within 3 days",
  "More than 3 days",
  "More than 7 days",
  "More than 15 days",
  "More than 1 month",
  "More than 2 month",
  "More than 6 month",
  "More than 1 year"
];

const delay2Select = document.getElementById('delayRange2Filter');
const previousDelay2 = delay2Select.value;
delay2Select.innerHTML = `<option value="">Select Delay Range-2</option>`;
delayRange2Options.forEach(r => {
  const opt = document.createElement('option');
  opt.value = r;
  opt.textContent = r;
  if (r === previousDelay2) opt.selected = true;
  delay2Select.appendChild(opt);
});

const delayRangesSorted = Object.entries(delayRangeMap)
.sort((a, b) => b[1] - a[1])  // reverse order
  .map(entry => entry[0]);

const delaySelect = document.getElementById('delayRangeFilter');
const previousDelay = delaySelect.value;
delaySelect.innerHTML = `<option value="">Select Delay Range</option>`;
delayRangesSorted.forEach(r => {
  const opt = document.createElement('option');
  opt.value = r;
  opt.textContent = r;
  if (r === previousDelay) opt.selected = true;
  delaySelect.appendChild(opt);
});


}

function applyFilters() {
  const region = document.getElementById('regionSelect').value;
  const divn = document.getElementById('divnSelect').value;
  const supp = document.getElementById('suppSelect').value;
  const poleType = document.getElementById('poleFilter').value;
  const delayRange = document.getElementById('delayRangeFilter').value;
  const delayRange2 = document.getElementById('delayRange2Filter').value;




  // 1. Filter the raw data based on selected filters
  const classFilter = document.querySelector('input[name="classFilter"]:checked')?.value || "all";

  // First, filter by everything EXCEPT the class filter to get the base for counts
  const baseFilteredData = rawData.filter(d =>
  (region === "" || d.REGION === region) &&
  (divn === "" || d.DIVN_NAME === divn) &&
  (supp === "" || d.SUPP_OFF === supp) &&
  (poleType === "" || 
    (poleType === "Pole" && d.NO_OF_POLES && d.NO_OF_POLES.trim() !== "" && d.NO_OF_POLES !== "0") ||
    (poleType === "Non-Pole" && (!d.NO_OF_POLES || d.NO_OF_POLES.trim() === "" || d.NO_OF_POLES === "0"))) &&
  (delayRange === "" || d.DelayRange === delayRange) &&
  (delayRange2 === "" || isInDelayRange2(d, delayRange2)) &&
  (!d.DelayInSC || (parseFloat(d.DelayInSC) >= delaySCMin && parseFloat(d.DelayInSC) <= delaySCMax))
);

  // Now, calculate and update the radio button counts based on this base data
  updateRadioCounts(baseFilteredData);

  // Finally, apply the class filter to get the final filteredData for the dashboard
  filteredData = baseFilteredData.filter(d =>
  (
    classFilter === "all" ||
    (classFilter === "non-agri" && (d.CONN_CLASS || "").trim().toUpperCase() !== "A") ||
    (classFilter === "agri-only" && (d.CONN_CLASS || "").trim().toUpperCase() === "A")
  )
);

  function isInDelayRange2(d, selectedRange) {
  const serial = parseInt(d.DelaySerial);
  if (isNaN(serial)) return false;

  const ranges = {
    "Within 3 days": [1],
    "More than 3 days": [2,3,4,5,6,7,8],
    "More than 7 days": [3,4,5,6,7,8],
    "More than 15 days": [4,5,6,7,8],
    "More than 1 month": [5,6,7,8],
    "More than 2 month": [6,7,8],
    "More than 6 month": [7,8],
    "More than 1 year": [8]
  };

  return ranges[selectedRange]?.includes(serial);
}

  // 2. Repopulate dropdown filters (keep earlier selections if possible)
  populateFilters(); 

  // 3. Collapse all expanded sub-rows (KPI and tabbed tables)
  document.querySelectorAll('.sub-row').forEach(row => {
    row.style.display = "none";
  });
  document.querySelectorAll('.expandable-row i').forEach(icon => {
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-right');
  });

  // 4. Update KPI Cards (counts and averages)
  updateDashboard();

  // 5. Redraw all tables (includes tabbed tables and card tables)
  drawTables();

  // 6. Refresh any open KPI detail table to reflect new filters
  refreshOpenKpiTable();
}
function refreshOpenKpiTable() {
  const isMobile = window.innerWidth <= 768;
  const activeCard = document.querySelector('.kpi-card-active');

  if (activeCard) {
    // Re-trigger the click event on the active card.
    // This is the simplest way to re-use the existing showTable logic
    // to refresh the content of the open table.
    // We simulate a "close" then "open" to force a refresh.
    if (!isMobile) {
      const tableContainer = document.getElementById('detailTableContainer');
      tableContainer.dataset.activeCard = ''; // Invalidate the active card
    }
    activeCard.click();
  }
}

function updateRadioCounts(data) {
  const totalCount = data.length;
  const agriCount = data.filter(d => (d.CONN_CLASS || "").trim().toUpperCase() === "A").length;
  const nonAgriCount = totalCount - agriCount;
  const agriPercent = totalCount > 0 ? ((agriCount / totalCount) * 100).toFixed(1) : 0;
  const nonAgriPercent = totalCount > 0 ? ((nonAgriCount / totalCount) * 100).toFixed(1) : 0;

  const allSpan = document.getElementById('allClassesCountPercent');
  const agriSpan = document.getElementById('agriOnlyCountPercent');
  const nonAgriSpan = document.getElementById('nonAgriCountPercent');
  if (allSpan) allSpan.textContent = `(${totalCount})`;
  if (agriSpan) agriSpan.textContent = `(${agriCount}, ${agriPercent}%)`;
  if (nonAgriSpan) nonAgriSpan.textContent = `(${nonAgriCount}, ${nonAgriPercent}%)`;
}




    // Add option to select element
    function addOption(id, value) {
      const sel = document.getElementById(id);
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      sel.appendChild(opt);
    }

    // Update dashboard with filtered data
    function updateDashboard() {
      // Debug logging for CONN_CLASS values
      console.log("CONN_CLASS values sample:", 
        filteredData.slice(0, 10).map(d => ({
          original: d.CONN_CLASS,
          normalized: (d.CONN_CLASS || "").trim().toUpperCase()
        }))
      );
      
      // Total Pending count
      document.getElementById('totalPending').textContent = filteredData.length;

      // Non Pole Case count (where NO_OF_POLES is blank or null or 0)
      const nonPoleCases = filteredData.filter(d => {
        const poles = d.NO_OF_POLES || "";  
        return poles.trim() === "" || poles === "0";
      }).length;

      // Pole Case count (where NO_OF_POLES has value greater than 0)
      const poleCases = filteredData.filter(d => {
        const poles = d.NO_OF_POLES || "";
        return poles.trim() !== "" && poles !== "0";
      }).length;

      var temp = 0;
      var temp2 = 0;
      var temp3 = [];
      // Industrial Pending count (where CONN_CLASS is exactly "I")
      const industrialPending = filteredData.filter(d => {
        const connClass = (d.CONN_CLASS || "").trim().toUpperCase();
        //console.log(connClass, d.CONN_CLASS, connClass === "I");
        if (connClass === "I") {
          temp++;
          console.log(d);
          temp3.push(d.APPL_NO);
        }else{
            temp2++;
        }
        return connClass === "I";
      }).length;


      // Update the counts
      document.getElementById('nonPole').textContent = nonPoleCases;
      document.getElementById('pole').textContent = poleCases;
      const totalPoles = filteredData
  .filter(d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() !== "" && poles !== "0";
  })
  .reduce((sum, d) => sum + (parseInt(d.NO_OF_POLES) || 0), 0);

document.getElementById('poleSum').textContent = `(${totalPoles})`;


      document.getElementById('industrialPending').textContent = industrialPending;

      // Calculate averages for delays


// Commercial 3-Ph: CONN_CLASS = "A" and APPLIED_PHASE = "III"
const commercial3ph = filteredData.filter(d => {
  const conn = (d.CONN_CLASS || "").trim().toUpperCase();
  const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
  return conn === "C" && phase === "III";
}).length;

document.getElementById('commercial3ph').textContent = commercial3ph;

// Initially Withheld: SCN_WITHELD_DATE not blank/zero
const initiallyWithheld = filteredData.filter(d => {
  const date = d.SCN_WITHELD_DATE || "";
  return date.trim() !== "" && date.trim() !== "0";
}).length;

document.getElementById('initiallyWithheldCount').textContent = initiallyWithheld;
const percentOfTotal = filteredData.length ? ((initiallyWithheld / filteredData.length) * 100).toFixed(1) : 0;
document.getElementById('initiallyWithheldPercent').textContent = `(${percentOfTotal}% of Total)`;

      // Update the performance ticker
      updatePerformanceTicker();
    }

    function findOldestCase(data, classCode) {
      let oldestCase = null;
      let maxDelay = -1;

      const filtered = data.filter(d => {
        const connClass = (d.CONN_CLASS || "").trim().toUpperCase();
        return connClass === classCode;
      });

      if (filtered.length === 0) {
        return null;
      }

      for (const item of filtered) {
        const delay = parseFloat(item.DelayInSC);
        if (!isNaN(delay) && delay > maxDelay) {
          maxDelay = delay;
          oldestCase = item;
        }
      }

      if (oldestCase) {
        return {
          name: oldestCase.NAME || 'N/A',
          ccc: oldestCase.SUPP_OFF || 'N/A',
          delay: Math.round(maxDelay)
        };
      }
      
      return null;
    }


    let tickerItemsList = [];
    let currentTickerIndex = 0;
    let tickerInterval;
    function updatePerformanceTicker() {
      const tickerContainer = document.getElementById('performanceTicker');
      const tickerItems = document.getElementById('tickerItems');
      
      const cccCounts = {};
      filteredData.forEach(d => {
        const ccc = d.SUPP_OFF;
        if (ccc && ccc.trim() !== '') {
          cccCounts[ccc] = (cccCounts[ccc] || 0) + 1;
        }
      });

      const sortedCccs = Object.entries(cccCounts).sort((a, b) => a[1] - b[1]);

      if (sortedCccs.length === 0) {
        tickerContainer.style.display = 'none';
        return;
      }

      const bestPerformers = sortedCccs.slice(0, 3);
      const worstPerformers = sortedCccs.slice(-3).reverse();

      const worstLabels = ['Highest', '2nd Highest', '3rd Highest'];
      const bestLabels = ['Lowest', '2nd Lowest', '3rd Lowest'];

      let allItems = [];

      // --- New: Add oldest cases by class ---
      const classesToHighlight = {
        'DOM': 'D',
        'COM': 'C',
        'IND': 'I',
        'AGRI': 'A'
      };

      for (const [label, code] of Object.entries(classesToHighlight)) {
        const oldest = findOldestCase(filteredData, code);
        if (oldest) {
          allItems.push(`<div class="ticker-item bad-performer"><i class="fas fa-exclamation-triangle me-2"></i>Oldest ${label}: ${oldest.delay}d - ${oldest.name} (${oldest.ccc})</div>`);
        }
      }


      // --- Existing: Highest and Lowest pending CCCs ---
      if (sortedCccs.length >= 4) {
        worstPerformers.forEach(([name, count], index) => {
          const label = worstLabels[index] || `${index + 1}th`;
          allItems.push(`<div class="ticker-item bad-performer"><i class="fas fa-times-circle me-2"></i>${label} Pending: ${name} (${count})</div>`);
        });

        bestPerformers.forEach(([name, count], index) => {
          const label = bestLabels[index] || `${index + 1}th`;
          allItems.push(`<div class="ticker-item good-performer"><i class="fas fa-check-circle me-2"></i>${label} Pending: ${name} (${count})</div>`);
        });
      }

      if (allItems.length === 0) {
        tickerContainer.style.display = 'none';
        return;
      }

      tickerItemsList = allItems;
      currentTickerIndex = 0;
      
      // Clear any existing interval
      if (tickerInterval) clearInterval(tickerInterval);

      // Function to display the next item
      const showNextTickerItem = () => {
        tickerItems.innerHTML = tickerItemsList[currentTickerIndex];
        currentTickerIndex = (currentTickerIndex + 1) % tickerItemsList.length;
      };

      showNextTickerItem(); // Show the first item immediately
      tickerInterval = setInterval(showNextTickerItem, 5000); // Cycle every 5 seconds

      tickerContainer.style.display = 'block';
    }

    // Show detailed table for selected filter
    function showTable(cardId, groupBy, filterFn, title) {
  const isMobile = window.innerWidth <= 768;

  // Define KPI colors
  const kpiColors = {
    'kpi-card-1': 'var(--primary-dark)',
    'kpi-card-2': '#15803d', // Darker success
    'kpi-card-3': '#d97706', // Darker warning
    'kpi-card-4': '#0891b2', // Darker accent
    'kpi-card-5': 'var(--gray-800)',
    'initiallyWithheldCard': '#d00000' // Custom red for this card
  };

  // Find the color for the current card
  const cardElement = document.getElementById(cardId);
  const cardColorClass = Array.from(cardElement.classList).find(c => kpiColors[c] || c === 'initiallyWithheldCard');
  const activeColor = kpiColors[cardColorClass || cardId] || 'transparent';

  // Remove 'active' class from all KPI cards first
  document.querySelectorAll('[id$="Card"]').forEach(card => {
    // Check if it's a KPI card before removing the class
    if (card.classList.contains('kpi-card-1') || card.classList.contains('kpi-card-2') || card.classList.contains('kpi-card-3') || card.classList.contains('kpi-card-4') || card.classList.contains('kpi-card-5')) {
        card.classList.remove('kpi-card-active');
    }
    // Also remove the connector visibility class
    if (card.classList.contains('connector-visible')) {
      card.classList.remove('connector-visible');
    }
  });

  if (isMobile) {
    const collapseId = cardId.replace('Card', 'Collapse');
    const tableContainerId = cardId.replace('Card', 'TableContainer');
    const collapseElement = document.getElementById(collapseId);
    const tableContainer = document.getElementById(tableContainerId);
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);

    const isCurrentlyOpen = collapseElement.classList.contains('show');
    const activeCardElement = document.querySelector('.kpi-card-active');

    // If another card is open, close it first
    if (activeCardElement && activeCardElement.id !== cardId) {
      const otherCollapseId = activeCardElement.id.replace('Card', 'Collapse');
      const otherCollapseEl = document.getElementById(otherCollapseId);
      if (otherCollapseEl) {
        bootstrap.Collapse.getInstance(otherCollapseEl)?.hide();
      }
      activeCardElement.classList.remove('kpi-card-active');
    }

    // Toggle the current card
    if (!isCurrentlyOpen) {
      document.getElementById(cardId).classList.add('kpi-card-active');
    }
    fillTable(tableContainer, groupBy, filterFn, title);
    bsCollapse.toggle();

  } else {
    // Desktop behavior: shared table at bottom
    const collapseElement = document.getElementById('detailCollapse');
    const tableContainer = document.getElementById('detailTableContainer');
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);

    const isCurrentlyOpen = collapseElement.classList.contains('show');
    const isSameCard = tableContainer.dataset.activeCard === cardId;

    if (isCurrentlyOpen && isSameCard) {
      // If it's open and we click the same card, collapse it.
      const cardToDeactivate = document.getElementById(cardId);

      // Listen for when the collapse is fully hidden
      collapseElement.addEventListener('hidden.bs.collapse', function handler() {
        if (cardToDeactivate) {
          cardToDeactivate.classList.remove('kpi-card-active');
        }
        // Clean up the listener
        collapseElement.removeEventListener('hidden.bs.collapse', handler);
      });

      bsCollapse.hide();
      document.documentElement.style.setProperty('--kpi-active-color', 'transparent');
      document.getElementById(cardId).classList.remove('connector-visible');
    } else {
      // Otherwise, fill the table with the new data and show it.
      // This will either open the collapse or update the content if already open.
      document.getElementById(cardId).classList.add('connector-visible');
      
      // Set the active color variable for the border
      const detailsContainer = document.querySelector('.kpi-details-container');
      detailsContainer.style.borderTopColor = activeColor;

      fillTable(tableContainer, groupBy, filterFn, title);
      tableContainer.dataset.activeCard = cardId; // Mark which card is active
      document.getElementById(cardId).classList.add('kpi-card-active');
      bsCollapse.show();
    }
  }
}



function fillTable(tableContainer, groupBy, filterFn, title) {
  const grouped = {};
  const filteredRecords = filteredData.filter(filterFn);

  if (filteredRecords.length === 0) {
    tableContainer.innerHTML = `
      <div class="card-body text-center p-5">
        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
        <h4>Great Job, No Pending!!</h4>
      </div>`;
    return;
  }

  // Special handling for CCC to include Division Name
  if (groupBy === 'SUPP_OFF') {
    filteredRecords.forEach(d => {
      const key = d.SUPP_OFF || 'Unknown';
      if (!grouped[key]) {
        grouped[key] = {
          count: 0,
          divn: d.DIVN_NAME || 'Unknown Division',
          poleSum: 0
        };
      }
      grouped[key].count++;
      grouped[key].poleSum += parseInt(d.NO_OF_POLES) || 0;
    });
  } else {
    filteredRecords.forEach(d => {
      const key = d[groupBy] || 'Unknown';
      if (!grouped[key]) {
        grouped[key] = { count: 0, poleSum: 0 };
      }
      grouped[key].count++;
      grouped[key].poleSum += parseInt(d.NO_OF_POLES) || 0;
    });
  }

  const sortedKeys = Object.keys(grouped).sort((a, b) => (grouped[b].count || 0) - (grouped[a].count || 0));

  let html = `
    <div class="card-header bg-white py-3">
  <h5 class="mb-0 d-flex justify-content-between align-items-center">
  <span><i class="fas fa-table me-2"></i>${title}</span>
  <i class="fas fa-copy text-primary" title="Copy Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</h5>

    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>${groupBy.replace('_', ' ')}</th>
            <th class="text-end">Count</th>
            <th class="text-end">Pole Count</th>
            <th class="text-end">%</th>
          </tr>
        </thead>
        <tbody>
  `;

  const total = filteredRecords.length;
  for (const key of sortedKeys) {
    const count = grouped[key].count;
    const poleSum = grouped[key].poleSum;
    const percentage = ((count / total) * 100).toFixed(1);
    const rowId = `row-${groupBy}-${btoa(key).replace(/=/g, '')}`;

    let displayKey = key;
    if (groupBy === 'SUPP_OFF' && grouped[key].divn) {
      displayKey = `${key} (${grouped[key].divn})`;
    }

    html += `
      <tr class="expandable-row" data-group="${key}" data-rowid="${rowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${displayKey}</td>
        <td class="text-end">${count}</td>
        <td class="text-end">${poleSum}</td>
        <td class="text-end">${percentage}%</td>
      </tr>
      <tr id="${rowId}" class="sub-row" style="display:none; background:#f8f9fa;">
        <td colspan="4">
          <div id="${rowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += "</tbody></table></div>";
  tableContainer.innerHTML = html;

  // Add event listeners for toggle
  const rows = tableContainer.querySelectorAll(".expandable-row");
  rows.forEach(row => {
row.addEventListener("click", function(e) {
    e.stopPropagation(); // 🚨 Important to prevent outer collapse
    const groupKey = this.dataset.group;
    const rowId = this.dataset.rowid;
    const subRow = document.getElementById(rowId);
    const icon = this.querySelector('i');

    if (subRow.style.display === "none") {
      // If the main grouping is by Division, the next level is the CCC breakdown.
      // We use generateSubRowsForTabs as it handles the next level of expansion (CCC -> consumer).
      if (groupBy === 'DIVN_NAME') {
        generateSubRowsForTabs(groupKey, document.getElementById(`${rowId}-subdata`), groupBy, filterFn);
      } else { // Otherwise (e.g., grouped by SUPP_OFF), the next level is the consumer list
        generateConsumerRows(groupKey, document.getElementById(`${rowId}-subdata`), groupBy, filterFn);
}


  subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } 
    
    else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
});

  });
}

function generateSubRows(groupKey, container, groupBy, filterFn) {
  const children = filteredData.filter(d => 
    filterFn(d) && (d[groupBy] === groupKey)
  );

  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    if (!groupedByCCC[ccc]) groupedByCCC[ccc] = { count: 0, poleSum: 0 };
    groupedByCCC[ccc].count++;
    groupedByCCC[ccc].poleSum += parseInt(d.NO_OF_POLES) || 0;
  });

  const total = children.length;
  
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>CCC-wise Breakdown</strong>
  <i class="fas fa-copy text-primary" title="Copy This Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

  <thead class="table-light">
    <tr>
      <th>CCC Name</th>
      <th class="text-end">Count</th>
      <th class="text-end">Pole Count</th>
      <th class="text-end">%</th>
    </tr>
  </thead>
  <tbody>
`;


const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1].count - a[1].count);
for (const [ccc, data] of sortedCCC) {
  const percentage = ((data.count / total) * 100).toFixed(1);
  html += `
    <tr>
      <td>${ccc}</td>
      <td class="text-end">${data.count}</td>
      <td class="text-end">${data.poleSum}</td>
      <td class="text-end">${percentage}%</td>
    </tr>
  `;
}


  html += `</tbody></table>`;

  container.innerHTML = html;
}
function formatDate(dateStr) {
  if (!dateStr || typeof dateStr !== 'string') return '-';
  const parts = dateStr.split(/[-/]/);
  if (parts.length !== 3) return dateStr;
  const [d, m, y] = parts;
  return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${y}`;
}
function generateConsumerRows(groupKey, container, groupBy, filterFn) {
  // Reusable date parser for sorting
  const parseSortDate = (dateStr) => {
    if (!dateStr || typeof dateStr !== 'string' || !dateStr.trim()) return new Date(0); // Treat empty/invalid as very old
    const parts = dateStr.trim().split(/[-/]/);
    if (parts.length !== 3) return new Date(0);
    const [d, m, y] = parts;
    const fullYear = y.length === 2 ? `20${y}` : y;
    return new Date(fullYear, m - 1, d);
  };
  const consumers = filteredData.filter(d => 
    filterFn(d) && (d[groupBy] === groupKey)
  );
// ✅ Sort by COLL_DATE (earliest first)
consumers.sort((a, b) => {
  const parseDate = str => {
    if (!str || str.trim() === '') return new Date(0);
    const [d, m, y] = str.trim().split(/[-/]/);
    return new Date(`20${y.length === 2 ? y : y.slice(-2)}`, m - 1, d);
  };
  return parseSortDate(a.COLL_DATE) - parseSortDate(b.COLL_DATE);
});

  if (consumers.length === 0) {
    container.innerHTML = `<div class="text-center text-muted p-2">No consumer data found.</div>`;
    return;
  }
// Sort consumers by COLL_DATE (earliest first)
consumers.sort((a, b) => {
  const parseDate = str => {
    if (!str || str.trim() === '') return new Date(0);
    const [d, m, y] = str.trim().split(/[-/]/);
    return new Date(`20${y.length === 2 ? y : y.slice(-2)}`, m - 1, d);
  };
  return parseDate(a.COLL_DATE) - parseDate(b.COLL_DATE);
});

let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Consumer List</strong>
  <i class="fas fa-copy text-primary" title="Copy Consumers" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm table-bordered mb-0">

      <thead class="table-light">
        <tr>
          <th>APPL NO</th>
          <th>NAME</th>
          <th>POLES</th>
          <th>LOAD (W)</th>
          <th>PHONE NO</th>
          <th>COLL DATE</th>
          <th>AGENCY NAME</th>
          <th class="text-end">DELAY</th>
        </tr>
      </thead>
      <tbody>
  `;



  consumers.forEach(d => {
    html += `
  <tr>
    <td>${d.APPL_NO || '-'}</td>
    <td>${d.NAME || '-'}</td>
    <td>${d.NO_OF_POLES || '0'}</td>
    <td>${d.LOAD_WATTS || '-'}</td>
    <td>${d.PHONE_NO || '-'}</td>
    <td>${formatDate(d.COLL_DATE)}</td>
    <td>${d.AGENCY_NAME && d.AGENCY_NAME.trim() !== "" ? d.AGENCY_NAME : '<span style="color:red;">WO not issued</span>'}</td>
    <td class="text-end">${formatDuration(d.DelayInSC)}</td>
  </tr>
`;

  });

  html += `</tbody></table>`;

  container.innerHTML = html;
}

// 1. First, modify the generateSubRowsForTabs function to add expandable rows for CCCs
function generateSubRowsForTabs(groupKey, container, groupByKey, filterFn = null) {
  if (groupByKey === 'DelayRange2') {
  const delaySerialGroups = {
    "Within 3 days": [1],
    "More than 3 days": [2,3,4,5,6,7,8],
    "More than 7 days": [3,4,5,6,7,8],
    "More than 15 days": [4,5,6,7,8],
    "More than 1 month": [5,6,7,8],
    "More than 2 month": [6,7,8],
    "More than 6 month": [7,8],
    "More than 1 year": [8]
  };

  const allowedSerials = delaySerialGroups[groupKey] || [];
  const children = filteredData.filter(d => allowedSerials.includes(parseInt(d.DelaySerial)));

  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    if (!groupedByCCC[ccc]) {
      groupedByCCC[ccc] = {
        count: 0,
        applications: [],
        poleSum: 0
      };
    }
    groupedByCCC[ccc].count++;
    groupedByCCC[ccc].applications.push(d);
    groupedByCCC[ccc].poleSum += parseInt(d.NO_OF_POLES) || 0;
  });

  const total = children.length;
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Application Details</strong>
  <i class="fas fa-copy text-primary" title="Copy Applications" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

      <thead>
        <tr>
          <th>CCC Name</th> 
          <th class="text-end">Count</th>
          <th class="text-end">Pole Count</th>
          <th class="text-end">%</th>
        </tr>
      </thead>
      <tbody>
  `;


  const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1].count - a[1].count);

  for (const [ccc, data] of sortedCCC) {
    const count = data.count;
    const percent = total ? ((count / total) * 100).toFixed(1) : 0;
    const cccRowId = `ccc-${groupByKey}-${btoa(ccc).replace(/=/g, '')}`;

    html += `
      <tr class="expandable-ccc-row" data-ccc="${ccc}" data-rowid="${cccRowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${ccc}</td>
        <td class="text-end">${data.count}</td>
        <td class="text-end">${data.poleSum}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${cccRowId}" class="ccc-sub-row" style="display:none; background:#e9ecef;">
        <td colspan="4">
          <div id="${cccRowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;

  // ➕ Expand to Consumer-level
  container.querySelectorAll('.expandable-ccc-row').forEach(row => {
    row.addEventListener('click', function(e) {
      e.stopPropagation();
      const ccc = this.dataset.ccc;
      const rowId = this.dataset.rowid;
      const subRow = document.getElementById(rowId);
      const icon = this.querySelector('i');

      if (subRow.style.display === "none") {
        const apps = groupedByCCC[ccc].applications;
        generateApplicationsTable(apps, document.getElementById(`${rowId}-subdata`), false);
        subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      }
    });
  });

  return;
}

  let children = [];

  if (groupByKey === 'PoleType') {
    // Special handling for Pole/Non-Pole case
    // Use the passed filterFn if available (for KPI cards)
    if (filterFn) {
      children = filteredData.filter(filterFn);
    }
    else if (groupKey === 'Pole Cases') {
      children = filteredData.filter(d => (d.NO_OF_POLES || "").trim() !== "" && (d.NO_OF_POLES !== "0"));
    } else if (groupKey === 'Non-Pole Cases') {
      children = filteredData.filter(d => (d.NO_OF_POLES || "").trim() === "" || (d.NO_OF_POLES === "0"));
    }
  } else {
    // Normal case
    children = filteredData.filter(d => (d[groupByKey] || 'Not Specified') === groupKey);
  }

  // For KPI card drill-downs (DIVN_NAME -> CCC), we need to further filter the children
  if (groupByKey === 'DIVN_NAME') {
    children = children.filter(d => d.DIVN_NAME === groupKey);
  }


  const groupedByCCC = {};
  children.forEach(d => {
    const ccc = d['SUPP_OFF'] || 'Unknown CCC';
    if (!groupedByCCC[ccc]) {
      groupedByCCC[ccc] = {
        count: 0,
        applications: [],
        poleSum: 0
      };
    }
    groupedByCCC[ccc].count++;
    groupedByCCC[ccc].applications.push(d);
    groupedByCCC[ccc].poleSum += parseInt(d.NO_OF_POLES) || 0;
  });

  const total = children.length;
  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>CCC-wise Details</strong>
  <i class="fas fa-copy text-primary" title="Copy This Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">

      <thead>
        <tr>
          <th>CCC Name</th>
          <th class="text-end">Count</th>
          <th class="text-end">Pole Count</th>
          <th class="text-end">%</th>
        </tr>
      </thead>
      <tbody>
  `;

  const sortedCCC = Object.entries(groupedByCCC).sort((a, b) => b[1].count - a[1].count);
  for (const [ccc, data] of sortedCCC) {
    const count = data.count;
    const percent = total ? ((count / total) * 100).toFixed(1) : 0;
    const cccRowId = `ccc-${groupByKey}-${btoa(ccc).replace(/=/g, '')}`;
    
    html += `
      <tr class="expandable-ccc-row" data-ccc="${ccc}" data-rowid="${cccRowId}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${ccc}</td>
        <td class="text-end">${data.count}</td>
        <td class="text-end">${data.poleSum}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${cccRowId}" class="ccc-sub-row" style="display:none; background:#e9ecef;">
        <td colspan="4">
          <div id="${cccRowId}-subdata"></div>
        </td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;
  
  // Add event listeners for CCC rows
  container.querySelectorAll('.expandable-ccc-row').forEach(row => {
    row.addEventListener('click', function(e) {
      e.stopPropagation();
      const ccc = this.dataset.ccc;
      const rowId = this.dataset.rowid;
      const subRow = document.getElementById(rowId);
      const icon = this.querySelector('i');
      
      if (subRow.style.display === "none") {
        // Get the applications for this CCC
        const apps = groupedByCCC[ccc].applications;
        const isFromAgencyTab = (groupByKey === 'AGENCY_NAME'); // This is likely always false here but keep for safety
generateApplicationsTable(apps, document.getElementById(`${rowId}-subdata`), isFromAgencyTab);
        subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      }
    });
  });
}

// 2. Add new function to generate applications table
function generateApplicationsTable(applications, container, hideAgencyColumn = false) {
  if (applications.length === 0) {
    container.innerHTML = '<div class="text-center p-3 text-muted">No applications found</div>';
    return;
  }

  // Reusable date parser for sorting
  const parseSortDate = (dateStr) => {
    if (!dateStr || typeof dateStr !== 'string' || !dateStr.trim()) return new Date(0); // Treat empty/invalid as very old
    const parts = dateStr.trim().split(/[-/]/);
    if (parts.length !== 3) return new Date(0);
    const [d, m, y] = parts;
    const fullYear = y.length === 2 ? `20${y}` : y;
    return new Date(fullYear, m - 1, d);
  };
  // Sort applications by COLL_DATE (earliest to latest)
  applications.sort((a, b) => parseSortDate(a.COLL_DATE) - parseSortDate(b.COLL_DATE));
  // Check if AGENCY_NAME exists in this context
  const showAgency = applications[0].AGENCY_NAME !== undefined && !hideAgencyColumn;

  let html = `
<div class="d-flex justify-content-between align-items-center mb-1">
  <strong>Application List</strong>
  <i class="fas fa-copy text-primary" title="Copy Applications" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
</div>
<table class="table table-sm mb-0">
  <thead>
    <tr>
      <th>APPL NO</th>
      <th>CLASS</th>
      <th>NAME</th>
      <th>LOAD (W)</th>
      <th>POLES</th>
      <th>PHONE NO</th>
      <th>COLL DATE</th>
      ${showAgency ? '<th>AGENCY NAME</th>' : ''}
      <th class="text-end">DELAY</th>
    </tr>
  </thead>
  <tbody>
`;

  applications.forEach(app => {
    const agency = (app.AGENCY_NAME || '').trim();
    const agencyCell = agency ? agency : '<span style="color:red;">WO not issued</span>';
    const connClass = (app.CONN_CLASS || '-').toUpperCase();

    html += `
      <tr>
        <td>${app.APPL_NO || '-'}</td>
        <td>${connClass}</td>
        <td>${app.NAME || '-'}</td>
        <td>${app.LOAD_WATTS || '-'}</td>
        <td>${app.NO_OF_POLES || '0'}</td>
        <td>${app.PHONE_NO || '-'}</td>
        <td>${formatDate(app.COLL_DATE)}</td>
        ${showAgency ? `<td>${agencyCell}</td>` : ''}
        <td class="text-end">${formatDuration(app.DelayInSC)}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}




document.getElementById('totalPendingCard').onclick = () => 
  showTable('totalPendingCard', 'DIVN_NAME', d => true, 'Pending NSC (Division Wise)');

document.getElementById('nonPoleCard').onclick = () => 
  showTable('nonPoleCard', 'DIVN_NAME', d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() === "" || poles === "0";
  }, 'Non-Pole Case (Division Wise)');

document.getElementById('poleCard').onclick = () => 
  showTable('poleCard', 'DIVN_NAME', d => {
    const poles = d.NO_OF_POLES || "";
    return poles.trim() !== "" && poles !== "0";
  }, 'Pole Case (Division Wise)');

document.getElementById('industrialPendingCard').onclick = () => 
  showTable('industrialPendingCard', 'SUPP_OFF', d => {
    const connClass = (d.CONN_CLASS || "").trim().toUpperCase();
    return connClass === "I";
  }, 'Industrial Pending (CCC Wise)');

document.getElementById('commercial3phCard').onclick = () =>
  showTable('commercial3phCard', 'SUPP_OFF', d => {
    const conn = (d.CONN_CLASS || "").trim().toUpperCase();
    const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
return conn === "C" && phase === "III";
  }, 'Commercial 3-Ph (CCC Wise)');

  document.getElementById('initiallyWithheldCard').onclick = () =>
  showTable('initiallyWithheldCard', 'SUPP_OFF', d => {
    const date = d.SCN_WITHELD_DATE || "";
    return date.trim() !== "" && date.trim() !== "0";
  }, 'Initially Withheld (CCC Wise)');


    // Filter change event handler
    document.getElementById('regionSelect').onchange = applyFilters;
document.getElementById('divnSelect').onchange = applyFilters;
document.getElementById('suppSelect').onchange = applyFilters;
document.getElementById('poleFilter').onchange = applyFilters;
document.getElementById('delayRangeFilter').onchange = applyFilters;
document.getElementById('delayRange2Filter').onchange = applyFilters;





    // Draw charts for data visualization
    function drawTables() {
  const chartColors = {}; // still unused, keeping for future
  
  const groupData = (key, defaultValue = 'Not Specified') => {
    const map = {};
    filteredData.forEach(d => {
      let value = d[key];
      if (!value || value.trim() === '') {
        value = defaultValue;
      }
      map[value] = (map[value] || 0) + 1;
    });
    return map;
  };
  const generateTable = (dataObj, header1, header2, groupByKey) => {
  const total = Object.values(dataObj).reduce((sum, val) => sum + val, 0);

  let html = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>${header1} Summary</strong>
      <i class="fas fa-copy text-primary" title="Copy Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>${header1}</th>
            <th class="text-end">${header2}</th>
            <th class="text-end">%</th>
          </tr>
        </thead>
        <tbody>
  `;



  let index = 0;
  for (const [key, value] of Object.entries(dataObj)) {
    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
    const rowId = `tabrow-${groupByKey}-${btoa(key).replace(/=/g, '')}`;


    html += `
      <tr class="expandable-row" data-group="${key}" data-rowid="${rowId}" data-groupby="${groupByKey}" style="cursor:pointer;">
        <td><i class="fas fa-chevron-right me-2"></i>${key}</td>
        <td class="text-end">${value}</td>
        <td class="text-end">${percent}%</td>
      </tr>
      <tr id="${rowId}" class="sub-row" style="display:none; background:#fff3cd;">
        <td colspan="3">
          <div id="${rowId}-subdata"></div>
        </td>
      </tr>
    `;
    index++;
  }

  html += `</tbody></table></div>`;
  return html;
};

  const delayMap = {};
  filteredData.forEach(d => {
    const range = d.DelayRange || 'No Delay Data';
    const serial = parseInt(d.DelaySerial) || 0;
    if (!delayMap[range]) {
      delayMap[range] = { count: 0, serial: serial };
    }
    delayMap[range].count++;
  });
  const sortedDelay = Object.entries(delayMap)
    .sort((a, b) => b[1].serial - a[1].serial);

  const poleData = {
    'Pole Cases': filteredData.filter(d => (d.NO_OF_POLES || "").trim() !== "" && (d.NO_OF_POLES !== "0")).length,
    'Non-Pole Cases': filteredData.filter(d => (d.NO_OF_POLES || "").trim() === "" || (d.NO_OF_POLES === "0")).length
  };

  const duareData = Object.fromEntries(
  Object.entries(groupData('IS_DUARE_SARKAR', 'Not Specified')).sort((a, b) => b[1] - a[1])
);

  const woData = Object.fromEntries(
  Object.entries(groupData('WO_ISSUED', 'Not Issued')).sort((a, b) => b[1] - a[1])
);
const classData = Object.fromEntries(
  Object.entries(groupData('CONN_CLASS', 'Not Specified')).sort((a, b) => b[1] - a[1])
);

const agencyData = Object.fromEntries(
  Object.entries(groupData('AGENCY_NAME', 'WO not issued')).sort((a, b) => b[1] - a[1])
);
const delayRange2Buckets = {
  "Within 3 days": 0,
  "More than 3 days": 0,
  "More than 7 days": 0,
  "More than 15 days": 0,
  "More than 1 month": 0,
  "More than 2 month": 0,
  "More than 6 month": 0,
  "More than 1 year": 0,
};

filteredData.forEach(d => {
  const serial = parseInt(d.DelaySerial);
  if (serial === 1) delayRange2Buckets["Within 3 days"]++;
  if ([2,3,4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 3 days"]++;
  if ([3,4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 7 days"]++;
  if ([4,5,6,7,8].includes(serial)) delayRange2Buckets["More than 15 days"]++;
  if ([5,6,7,8].includes(serial)) delayRange2Buckets["More than 1 month"]++;
  if ([6,7,8].includes(serial)) delayRange2Buckets["More than 2 month"]++;
  if ([7,8].includes(serial)) delayRange2Buckets["More than 6 month"]++;
  if (serial === 8) delayRange2Buckets["More than 1 year"]++;
});
document.getElementById('delay2').querySelector('.chart-container').innerHTML = generateTable(
  delayRange2Buckets,
  'Range',
  'Count',
  'DelayRange2'
);

  // --- Generate tables with correct groupByKey ---
  document.getElementById('delay').querySelector('.chart-container').innerHTML = generateTable(
    Object.fromEntries(sortedDelay.map(([k, v]) => [k, v.count])), 
    'Range', 
    'Count',
    'DelayRange' // 👈 important
  );

  document.getElementById('pole-data').querySelector('.chart-container').innerHTML = generateTable(
    poleData,
    'Type',
    'Count',
    'PoleType' // 👈 dummy (since not actual column)
  );

  document.getElementById('duare').querySelector('.chart-container').innerHTML = generateTable(
    duareData,
    'DS?',
    'Count',
    'IS_DUARE_SARKAR'
  );

  document.getElementById('wo').querySelector('.chart-container').innerHTML = generateTable(
    woData,
    'Issued?',
    'Count',
    'WO_ISSUED'
  );

  document.getElementById('classwise').querySelector('.chart-container').innerHTML = generateTable(
    classData,
    'Class',
    'Count',
    'CONN_CLASS'
  );

   // ➕ INSERT THIS FOR Applied Phase Tab
  const phaseGroups = {};
  filteredData.forEach(d => {
    const phase = (d.APPLIED_PHASE || "Not Specified").trim();
    if (!phaseGroups[phase]) {
      phaseGroups[phase] = [];
    }
    phaseGroups[phase].push(d);
  });

  let html = `
    <div class="card-header bg-white py-3">
      <h5 class="mb-0 d-flex justify-content-between align-items-center">
        <span><i class="fas fa-table me-2"></i>Applied Phase</span>
        <i class="fas fa-copy text-primary" title="Copy Table" style="cursor:pointer;" onclick="copyTableToWhatsApp(this)"></i>
      </h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Phase</th>
            <th class="text-end">Count</th>
            <th class="text-end">%</th>
          </tr>
        </thead>
        <tbody>
  `;

  const total = filteredData.length;
  Object.entries(phaseGroups)
    .sort((a, b) => b[1].length - a[1].length)
    .forEach(([phase, entries]) => {
      const percent = ((entries.length / total) * 100).toFixed(1);
      const rowId = `row-APPLIED_PHASE-${btoa(phase).replace(/=/g, '')}`;
      html += `
<tr class="expandable-row" data-group="${phase}" data-rowid="${rowId}" data-groupby="APPLIED_PHASE" style="cursor:pointer;">
          <td><i class="fas fa-chevron-right me-2"></i>${phase}</td>
          <td class="text-end">${entries.length}</td>
          <td class="text-end">${percent}%</td>
        </tr>
        <tr id="${rowId}" class="sub-row" style="display:none;">
        <td colspan="4"><div id="${rowId}-subdata"></div></td>
        </tr>
      `;
    });

  html += "</tbody></table></div>";
  document.getElementById("phaseChartContainer").innerHTML = html;

  // ➕ Now bind event listeners
  document.querySelectorAll('#phaseChartContainer .expandable-row').forEach(row => {
    row.addEventListener("click", function (e) {
      e.stopPropagation();
      const groupKey = this.dataset.group;
      const rowId = this.dataset.rowid;
      const subRow = document.getElementById(rowId);
      const icon = this.querySelector('i');

      if (subRow.style.display === "none") {
        generateSubRows(groupKey, document.getElementById(`${rowId}-subdata`), 'APPLIED_PHASE', d => true);
        subRow.style.display = "";
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
      } else {
        subRow.style.display = "none";
        document.getElementById(`${rowId}-subdata`).innerHTML = "";
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
      }
    });
  });
  document.getElementById('agency').querySelector('.chart-container').innerHTML = generateTable(
  agencyData,
  'Agency',
  'Count',
  'AGENCY_NAME'
);

  // --- Attach expandable click listeners after building tables ---
  document.querySelectorAll('.expandable-row').forEach(oldRow => {
  const newRow = oldRow.cloneNode(true);  // deep clone
  oldRow.replaceWith(newRow);  // replace old with new

  newRow.addEventListener('click', function(e) {
    e.stopPropagation();
    const groupKey = this.dataset.group;
    const rowId = this.dataset.rowid;
    const groupByKey = this.dataset.groupby;

    const subRow = document.getElementById(rowId);
    const icon = this.querySelector('i');

    if (subRow.style.display === "none") {
      generateSubRowsForTabs(groupKey, document.getElementById(`${rowId}-subdata`), groupByKey, null); // Pass null for filterFn in tab view
      subRow.style.display = "";
      icon.classList.remove('fa-chevron-right');
      icon.classList.add('fa-chevron-down');
    } else {
      subRow.style.display = "none";
      document.getElementById(`${rowId}-subdata`).innerHTML = "";
      icon.classList.remove('fa-chevron-down');
      icon.classList.add('fa-chevron-right');
    }
  });
});

}

    document.addEventListener('DOMContentLoaded', () => {
  ['totalPendingCollapse', 'nonPoleCollapse', 'poleCollapse', 'industrialPendingCollapse', 'detailCollapse'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.remove('show');
    }
  });
});
document.addEventListener('DOMContentLoaded', () => {
  ['totalPendingCollapse', 'nonPoleCollapse', 'poleCollapse', 'industrialPendingCollapse', 'detailCollapse'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.remove('show');
    }
  });

  // 🔽 Add this block BELOW
  document.querySelectorAll('.collapse').forEach(collapse => {
    collapse.addEventListener('shown.bs.collapse', (e) => {
      const id = e.target.id;
      const map = {
        totalPendingCollapse: {
          cardId: 'totalPendingCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => true,
          title: 'Pending NSC (Division Wise)'
        },
        
        nonPoleCollapse: {
          cardId: 'nonPoleCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => (d.NO_OF_POLES || "").trim() === "" || d.NO_OF_POLES === "0",
          title: 'Non-Pole Case (Division Wise)'
        },
        poleCollapse: {
          cardId: 'poleCard',
          groupBy: 'DIVN_NAME',
          filterFn: d => (d.NO_OF_POLES || "").trim() !== "" && d.NO_OF_POLES !== "0",
          title: 'Pole Case (Division Wise)'
        },
        industrialPendingCollapse: {
          cardId: 'industrialPendingCard',
          groupBy: 'SUPP_OFF',
          filterFn: d => (d.CONN_CLASS || "").trim().toUpperCase() === "I",
          title: 'Industrial Pending (CCC Wise)'
        },
        commercial3phCollapse: {
          cardId: 'commercial3phCard',
          groupBy: 'SUPP_OFF',
          filterFn: d => {
            const conn = (d.CONN_CLASS || "").trim().toUpperCase();
            const phase = (d.APPLIED_PHASE || "").trim().toUpperCase();
            return conn === "C" && phase === "III";
          },
          title: 'Commercial 3-Ph (CCC Wise)'
        },
        initiallyWithheldCollapse: {
  cardId: 'initiallyWithheldCard',
  groupBy: 'SUPP_OFF',
  filterFn: d => (d.SCN_WITHELD_DATE || "").trim() !== "" && d.SCN_WITHELD_DATE.trim() !== "0",
  title: 'Initially Withheld (CCC Wise)'
}

        
      };

      const cfg = map[id];
      if (cfg) {
        const tableContainerId = cfg.cardId.replace('Card', 'TableContainer');
        // This was causing a double-render on mobile. The initial fillTable in showTable is sufficient.
        // const container = document.getElementById(tableContainerId);
        // fillTable(container, cfg.groupBy, cfg.filterFn, cfg.title);
      }
    });
  });
});

    // Initialize the dashboard
    fetchData();

    function copyTableToWhatsApp(iconElement) {
  setTimeout(() => {
    const wrapper = iconElement.closest('.d-flex');
    if (!wrapper) return alert("No header found near icon.");

    let table = null;

    // 1️⃣ Try sub-row context first (expanded sub-table)
    const parentRow = iconElement.closest('.sub-row, .ccc-sub-row');
    if (parentRow) {
      table = parentRow.querySelector('table');
    }

    // 2️⃣ If not inside sub-row, fallback to closest .card or .tab-pane
    if (!table) {
      const container = iconElement.closest('.card, .tab-pane, .table-responsive');
      table = container?.querySelector('table');
    }

    if (!table) return alert("No table found to copy.");

    const currentTableTitle = wrapper.querySelector('strong')?.innerText?.trim() || 'Details';

    // Build context (card or tab mode)
    let contextParts = [];
    let mode = 'card';

    const tabPane = iconElement.closest('.tab-pane');
    if (tabPane) {
      mode = 'tab';
      const tabId = tabPane.id;
      const tabBtn = document.querySelector(`.nav-link[data-bs-target="#${tabId}"]`);
      const tabName = tabBtn?.innerText.trim() || 'Tab';
      contextParts.push(tabName);
    }

    let current = wrapper.parentElement;
    let foundCardName = '', foundSubtableHeader = '';

    while (current && current !== document.body) {
      if (mode === 'card') {
        const cardTitle = current.querySelector('.card-header h5, .card-title strong, h5.card-title');
        if (cardTitle) {
          const cardText = cardTitle.innerText.trim();
          if (!foundCardName) foundCardName = cardText;
          else if (!foundSubtableHeader && cardText !== foundCardName) foundSubtableHeader = cardText;
        }
      }

      const possibleRow = current.closest('tr')?.previousElementSibling;
      if (possibleRow && possibleRow.matches('tr.expandable-row, tr.expandable-ccc-row')) {
        const td = possibleRow.querySelector('td');
        if (td) {
          const rowText = td.innerText.trim().replace(/^[►▼]\s*/, '');
          if (rowText && !contextParts.includes(rowText)) {
            contextParts.push(rowText);
          }
        }
      }

      current = current.parentElement;
    }

    if (mode === 'card') {
      const fullParts = [foundCardName, foundSubtableHeader, ...contextParts.reverse(), currentTableTitle];
      contextParts = fullParts.filter(Boolean);
    } else if (mode === 'tab') {
      contextParts.push(currentTableTitle);
    }

    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    const headerLine = headers.join(' | ');
    const rowLines = rows.map(row =>
      Array.from(row.querySelectorAll('td')).map(td => td.innerText.trim()).join(' | ')
    );

    const topLine = '*Pending NSC:*';
    const finalText = `${topLine}\n📋 ${contextParts.join(': ')}\n${headerLine}\n${rowLines.join('\n')}`;
    showModalWithOutput(finalText);
  }, 50); // delay allows any async table render to complete
}


function shortHeader(header) {
  const map = {
    'Division Name': 'Division',
    'CCC Name': 'CCC',
    'Count': 'Cnt',
    '%': '%',
    'APPL NO': 'App',
    'NAME': 'Name',
    'PHONE NO': 'Ph',
    'COLL DATE': 'Date',
    'AGENCY NAME': 'Agency',
    'Issued?': 'WO',
    'DS?': 'DS',
    'Range': 'Delay'
  };
  return map[header.trim().toUpperCase()] || header.trim();
}

function showModalWithOutput(text) {
  document.getElementById("modalOutput").value = text;
  document.getElementById("copyModal").style.display = "flex";
}

function hideModal() {
  document.getElementById("copyModal").style.display = "none";
}

function copyFromModal() {
  const textarea = document.getElementById("modalOutput");
  textarea.select();
  document.execCommand("copy");
  alert("Copied!");
}

function formatReadableDuration(value) {
  const days = Math.floor(value);
  if (days < 30) {
    return `${days} day${days !== 1 ? 's' : ''}`;
  } else if (days < 365) {
    const months = Math.floor(days / 30);
    const remDays = days % 30;
    return `${months} month${months !== 1 ? 's' : ''}${remDays ? ` ${remDays} day${remDays !== 1 ? 's' : ''}` : ''}`;
  } else {
    const years = Math.floor(days / 365);
    const remDays = days % 365;
    const months = Math.floor(remDays / 30);
    const rem = remDays % 30;
    return `${years} yr${years > 1 ? 's' : ''}${months ? ` ${months} mo${months > 1 ? 's' : ''}` : ''}${rem ? ` ${rem} day${rem > 1 ? 's' : ''}` : ''}`;
  }
}
function showLoading(isLoading) {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.style.display = isLoading ? 'flex' : 'none';
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const okBtn = document.getElementById("urgentOkBtn");
  okBtn.addEventListener("click", () => {
    const modalInstance = bootstrap.Modal.getInstance(document.getElementById("urgentModal"));
    if (modalInstance) modalInstance.hide();
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const okBtn = document.getElementById("urgentOkBtn");
  
  // Get the modal instance
  const urgentModalElement = document.getElementById("urgentModal");
  const urgentModal = new bootstrap.Modal(urgentModalElement); // Initialize Bootstrap Modal instance

  okBtn?.addEventListener("click", function() {
    // This line is the correction: hide the modal
    urgentModal.hide(); 
  });

  // You can also add this for the close button if data-bs-dismiss="modal" isn't sufficient
  const closeBtn = urgentModalElement.querySelector('.btn-close');
  closeBtn?.addEventListener("click", function() {
    urgentModal.hide();
  });
});

  </script>

<!-- Manual Copy Modal -->
<div class="modal" id="copyModal" style="display:none;">
  <div class="modal-content">
    <span class="modal-close" onclick="hideModal()"><i class="fas fa-times"></i></span>
    <h3>Copy Output</h3>
    <textarea id="modalOutput" readonly style="width:100%; height:200px; margin-top:10px; font-size:0.9rem; padding:10px;"></textarea>
    <button onclick="copyFromModal()" style="margin-top:10px;" class="btn btn-primary">Copy</button>
  </div>
</div>

<!-- noUiSlider JS -->
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

<div class="modal fade" id="urgentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Top 10 Most Delayed Cases</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="urgentModalBody">
        <!-- Table will be injected here by JS -->
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-secondary urgent-download-btn" onclick="downloadUrgentModalAsImage()" title="Download as Image">
          <i class="fas fa-camera me-2"></i>Download
        </button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Take Urgent Action!</button>
      </div>
    </div>
  </div>
</div>





<script>
document.addEventListener("DOMContentLoaded", function () {
  const okBtn = document.getElementById("urgentOkBtn");
  
  // Get the modal instance
  const urgentModalElement = document.getElementById("urgentModal");
  const urgentModal = new bootstrap.Modal(urgentModalElement); // Initialize Bootstrap Modal instance

  okBtn?.addEventListener("click", function() {
    // This line is the correction: hide the modal
    urgentModal.hide(); 
  });

  // You can also add this for the close button if data-bs-dismiss="modal" isn't sufficient
  const closeBtn = urgentModalElement.querySelector('.btn-close');
  closeBtn?.addEventListener("click", function() {
    urgentModal.hide();
  });
});


function downloadUrgentModalAsImage() {
  const modalContent = document.querySelector('#urgentModal .modal-content');
  const downloadBtn = modalContent.querySelector('.urgent-download-btn');

  if (downloadBtn) downloadBtn.style.display = 'none';

  html2canvas(modalContent, { scale: 2 }).then(canvas => {
    const link = document.createElement('a');
    link.download = 'Urgent-Delayed-Applications.png';
    link.href = canvas.toDataURL();
    link.click();
    if (downloadBtn) downloadBtn.style.display = '';
  }).catch(err => {
    console.error("Error capturing modal:", err);
    alert("Failed to capture modal.");
    if (downloadBtn) downloadBtn.style.display = '';
  });
}


</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</body>
</html>
