<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Priority SI works</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>:root{--primary-color:#4a55a8;--secondary-color:#6c757d;--background-light:#f8f9fa;--card-bg:#ffffff;--card-shadow:0 4px 12px rgba(0, 0, 0, 0.05);--border-radius-xl:16px;--sidebar-width:400px;--completed-row-bg:#e6f7e9}body{font-family:Inter,sans-serif;background:var(--background-light);font-size:14px;margin:0;padding:0}.app-container{display:flex;height:100vh;overflow:hidden}.main-content-wrapper{flex-grow:1;display:flex;flex-direction:column;height:100%;overflow-y:auto;transition:margin-left .3s ease}.sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100%;background:var(--card-bg);box-shadow:2px 0 10px rgba(0,0,0,.05);z-index:1050;transform:translateX(-100%);transition:transform .3s ease;overflow-y:auto}.sidebar.active{transform:translateX(0)}.main-content-container{padding:1.5rem;width:100%;max-width:100%}@media (min-width:992px){.sidebar{position:relative;transform:translateX(0)}.main-content-wrapper{margin-left:0}.sidebar-toggle-btn{display:none}}@media (max-width:991.98px){.main-content-wrapper{margin-left:0}}.glass-card{background:var(--card-bg);border-radius:var(--border-radius-xl);box-shadow:var(--card-shadow);border:1px solid rgba(0,0,0,.05)}.table-compact{font-size:13px}.table-compact th{padding:6px 8px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;background:#f1f3f5}.table-compact td{padding:6px 8px;vertical-align:middle;line-height:1.5;word-wrap:break-word;overflow-wrap:break-word}.completed-row{background-color:var(--completed-row-bg)!important}.row-hover{transition:all .2s ease;cursor:pointer}.row-hover:hover{background:#f1f3f5}.btn-action{padding:6px 12px;font-size:13px;border-radius:8px}.badge-priority{font-size:11px;padding:4px 10px;border-radius:16px;font-weight:600}.status-badge{font-size:13px;padding:0;font-weight:400;background-color:transparent;color:#495057;display:inline-block}.tooltip-custom{position:absolute;z-index:1070;background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;max-width:250px;pointer-events:none;opacity:0;transition:opacity .2s}.tooltip-custom.show{opacity:1}.filter-chip{font-size:13px;padding:8px 16px;border-radius:20px;border:1px solid #dee2e6;background:#fff;transition:all .2s ease;font-weight:500;display:flex;align-items:center;gap:8px}.filter-chip.active{background:var(--primary-color);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(74,85,168,.3)}.stats-card{background:#fff;border-radius:var(--border-radius-xl);padding:16px;box-shadow:var(--card-shadow);text-align:center;transition:all .2s ease}.stats-card:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.08)}.stats-number{font-size:24px;font-weight:700;color:var(--primary-color)}.stats-label{font-size:12px;color:var(--secondary-color);text-transform:uppercase;letter-spacing:.5px;margin-top:4px}.main-header{background-color:var(--card-bg);border-bottom:1px solid #e9ecef}#editModal .form-label{background-color:#f8f9fa;padding:2px 6px;border-radius:4px;display:inline-block}#editModal .form-label{font-weight:600;font-size:.85rem;color:#6c757d;margin-bottom:4px}#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,.8);display:none;justify-content:center;align-items:center;z-index:2000;transition:opacity .3s ease-in-out;opacity:0}#loadingOverlay.show{display:flex;opacity:1}.spinner{width:50px;height:50px;border:5px solid rgba(0,0,0,.1);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.count-badge{background-color:#dc3545;color:#fff;border-radius:50%;font-size:11px;font-weight:700;padding:2px 6px;min-width:24px;text-align:center}.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:var(--background-light)}.login-card{width:100%;max-width:400px;padding:2rem}.stats-card{padding:8px 12px;border-radius:10px;box-shadow:var(--card-shadow);min-width:90px}.stats-number{font-size:18px}.stats-label{font-size:10px}#statusCountsContainer{background:var(--card-bg);border-radius:var(--border-radius-xl);box-shadow:var(--card-shadow);padding:8px}#statusCountsContainer h6{font-size:13px;margin-bottom:8px}#statusCountsList .list-group-item{padding:4px 8px;font-size:16px}#statusCountsList .list-group-item{padding:6px 10px;font-size:16px;font-weight:600}#statusCountsList .badge{font-size:14px;padding:4px 10px}.sidebar{width:var(--sidebar-width);min-width:var(--sidebar-width);max-width:var(--sidebar-width);flex-shrink:0}#statusCountsList .list-group-item{display:flex;justify-content:space-between;align-items:center;min-width:100%;font-size:16px;font-weight:600}#statusCountsContainer h6{background-color:var(--primary-color);color:#fff;padding:6px 10px;border-radius:8px;font-size:14px;font-weight:700}#statusCountsContainer h6,.sidebar h5{display:block;width:100%;background-color:var(--primary-color);color:#fff;padding:6px 10px;border-radius:8px;font-size:14px;font-weight:700;margin-bottom:8px}</style></head><body><div id="loginContainer" class="login-container"><div class="glass-card login-card text-center"><h2 class="fw-bold mb-3" style="color:var(--primary-color)">Priority SI Works</h2><p class="text-muted mb-4">Enter your PIN to access the dashboard.</p><form id="loginForm"><div class="form-floating mb-3"><input type="password" class="form-control" id="pinInput" placeholder="PIN" required> <label for="pinInput">PIN</label></div><button type="submit" class="btn btn-primary w-100 rounded-pill mt-2">Log In</button></form><p id="loginError" class="text-danger mt-3" style="display:none"></p></div></div><div id="appContainer" class="app-container" style="display:none"><div id="sidebar" class="sidebar p-4"><div class="d-flex justify-content-between align-items-center mb-4"><h5 class="fw-bold mb-0">Scheme Heads</h5><button id="closeSidebar" class="btn btn-sm" aria-label="Close sidebar"><i class="bi bi-x-lg"></i></button></div><div id="schemeHeadFiltersContainer"></div><hr><div id="statusCountsContainer" class="mt-3"><h6 class="fw-bold">Status Counts</h6><ul class="list-group list-group-flush small" id="statusCountsList"></ul></div></div><div class="main-content-wrapper"><nav class="navbar navbar-expand-lg main-header shadow-sm sticky-top"><div class="container-fluid"><div class="d-flex align-items-center"><button id="toggleSidebar" class="btn btn-sm d-lg-none me-2" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation"><i class="bi bi-list fs-4"></i></button> <span class="navbar-brand mb-0 h1 fw-bold fs-4">Priority SI Work</span></div><div class="d-flex align-items-center gap-3"><div class="position-relative"><input type="text" id="searchInput" class="form-control form-control-sm rounded-pill ps-4 pe-2" placeholder="Search records..." style="width:250px"> <i class="bi bi-search position-absolute" style="left:12px;top:50%;transform:translateY(-50%);color:#6b7280"></i></div><button id="btnAdd" class="btn btn-primary btn-sm rounded-pill d-flex align-items-center gap-2 px-3"><i class="bi bi-plus-circle"></i> Add New Scheme</button> <button id="btnLogout" class="btn btn-outline-danger btn-sm rounded-pill"><i class="bi bi-box-arrow-right"></i> Logout</button></div></div></nav><div class="main-content-container"><div class="glass-card p-3 mb-4"><div class="d-flex flex-wrap align-items-center gap-2"><div id="divisionTabs" class="d-flex flex-wrap gap-2"></div><div class="d-flex flex-wrap gap-2 ms-auto"><div class="stats-card p-2 text-center"><div class="stats-number" id="totalCount">0</div><div class="stats-label">Total</div></div></div></div></div><div class="d-flex justify-content-end mb-3"><button id="btnDownloadCsv" class="btn btn-outline-secondary btn-sm rounded-pill d-flex align-items-center gap-2 px-3"><i class="bi bi-download"></i> Download CSV</button></div><div class="glass-card overflow-hidden"><div class="table-responsive"><table class="table table-hover table-compact mb-0"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table></div><div class="d-flex justify-content-between align-items-center p-3 border-top bg-light"><small class="text-muted">Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="showingTotal">0</span> results</small><nav id="paginationControls"></nav></div></div></div></div></div><div id="customTooltip" class="tooltip-custom"></div><div id="loadingOverlay"><div class="spinner"></div></div><div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modalTitle">Add New Scheme</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto"><form id="recordForm"><div class="row g-3" id="formFields"></div><input type="hidden" id="recordId"></form></div><div class="modal-footer"><button id="btnDelete" class="btn btn-danger me-auto rounded-pill" style="display:none"><i class="bi bi-trash"></i> Delete</button> <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button> <button id="btnSave" class="btn btn-primary rounded-pill"><i class="bi bi-check-circle"></i> Save</button></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script type="module">import{createClient}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";const SUPABASE_URL="https://unsmtschmcvftfqwabaq.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuc210c2NobWN2ZnRmcXdhYmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NzA1MTYsImV4cCI6MjA2OTE0NjUxNn0.X3_q0FyEjam4ct03sjiqINz0_Hfu0AlWgRcymA3us9o",TABLE_NAME="prioritySI",USER_ACCESS_TABLE="user_access",TABLE_COLUMNS=["id","Division","Scheme Head","Name of Scheme","TAA No.","Detail Work Status","Status","Target Date"],ALL_COLUMNS=["id","Region","Division","Scheme Head","Related SS","Name of Scheme","Existing Parameter (Capacity/RL/Size)","Proposed Parameter (Capacity/RL/Size)","Loading (%) / Peak Load (A)","Major Material Requirement","TAA No.","TAA Date","Priority","eOffice ref.","Presently with","Detail Work Status","Target Date","Status"],COMPACT_HEADERS={id:"ID",Division:"Division","Scheme Head":"Scheme Head","Name of Scheme":"Scheme Name","TAA No.":"TAA No.","Detail Work Status":"Work Status",Status:"Overall Status","Target Date":"Target"},relatedSSMap={Malda:["Englishbazar","Mothabari","Kaliachak","Sujapur","Baishnabnagar","Gopalganj","Rabindra Bhaban","KPS Malda","Mankchak","Milki"],Gazole:["Nalagola","Deotala","Narayanpur","Mobaeakpur","Habibpur","Balia","Bamongola","Gazole","Ranipur OD","Chandipur","Mangalbari"],Chanchal:["Shibnagar","Ratua","Pukuria","Chanchal","Bhaluka","Ashapur","Chatrak","Harishchandrapur"],Raiganj:["Raiganj","Kasba","Durgapur","Itahar","Bangar","Tungidighi","Bikore","Laxmania","Hemtabad","Malon","Kaliyaganj","Dalimgaon","Belua","Kunor","Spinning Mill","Mahespur"],Islampur:["Sonapur","Bholagach","Chopra","Srikrishnapur","Islampur","Panjipara","Lodhan","Kahata","Kanki","Choprajhar","Sujali","Tajpur"],Buniadpur:["Buniadpur","Harirampur","Kushmandi","Thangapara","Pransagar","Maligaon"],Balurghat:["Baro-Raghunathpur","Amrail","Trimohini","Patiram","Mahipur","Rampur","Salas"]},regionDivisionMap={"Dakshin Dinajpur":["Balurghat","Buniadpur"],"Uttar Dinajpur":["Islampur","Raiganj"],Malda:["Malda","Gazole","Chanchal"]};function getAllowedRegions(){if(currentUser?.can_view_all)return Object.keys(regionDivisionMap);const e=currentUser?.divisions||[],t=new Set;for(const[n,a]of Object.entries(regionDivisionMap))a.some(t=>e.includes(t))&&t.add(n);return Array.from(t)}const client=createClient(SUPABASE_URL,SUPABASE_KEY),tableHead=document.getElementById("tableHead"),tableBody=document.getElementById("tableBody"),formFields=document.getElementById("formFields"),btnAdd=document.getElementById("btnAdd"),btnSave=document.getElementById("btnSave"),btnDelete=document.getElementById("btnDelete"),btnDownloadCsv=document.getElementById("btnDownloadCsv"),recordId=document.getElementById("recordId"),searchInput=document.getElementById("searchInput"),divisionTabsContainer=document.getElementById("divisionTabs"),paginationControls=document.getElementById("paginationControls"),schemeHeadFiltersContainer=document.getElementById("schemeHeadFiltersContainer"),totalCount=document.getElementById("totalCount"),filteredCount=document.getElementById("filteredCount"),showingStart=document.getElementById("showingStart"),showingEnd=document.getElementById("showingEnd"),showingTotal=document.getElementById("showingTotal"),customTooltip=document.getElementById("customTooltip"),loadingOverlay=document.getElementById("loadingOverlay"),loginContainer=document.getElementById("loginContainer"),loginForm=document.getElementById("loginForm"),pinInput=document.getElementById("pinInput"),loginError=document.getElementById("loginError"),appContainer=document.getElementById("appContainer"),btnLogout=document.getElementById("btnLogout"),sidebar=document.getElementById("sidebar"),toggleSidebarBtn=document.getElementById("toggleSidebar"),closeSidebarBtn=document.getElementById("closeSidebar"),mainContentWrapper=document.querySelector(".main-content-wrapper");let allRecords=[],divisions=[],schemeHeads=[],selectedSchemeHeads=new Set,selectedStatuses=new Set,currentDivision="All",currentPage=1;const recordsPerPage=15;let editModal,currentUser=null;function escapeId(e){return e.replace(/[^a-z0-9]/gi,"_")}function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}function getPriorityBadge(e){const t=String(e).toLowerCase();return t.includes("high")||"1"===t?"priority-high":t.includes("medium")||"2"===t?"priority-medium":t.includes("low")||"3"===t?"priority-low":"badge bg-secondary"}function showLoading(){loadingOverlay.classList.add("show")}function hideLoading(){loadingOverlay.classList.remove("show")}function showMessage(e,t="info"){if(!document.getElementById("messageModal")){const e='\n          <div class="modal fade" id="messageModal" tabindex="-1">\n            <div class="modal-dialog modal-dialog-centered">\n              <div class="modal-content">\n                <div class="modal-header">\n                  <h5 class="modal-title" id="messageModalTitle">Message</h5>\n                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body" id="messageModalBody"></div>\n                <div class="modal-footer">\n                  <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Close</button>\n                </div>\n              </div>\n            </div>\n          </div>\n        ';document.body.insertAdjacentHTML("beforeend",e)}const n=document.getElementById("messageModalTitle"),a=document.getElementById("messageModalBody");n.textContent="error"===t?"Error":"Info",a.textContent=e;new bootstrap.Modal(document.getElementById("messageModal")).show()}function showTooltip(e,t){if(!t)return;customTooltip.textContent=t,customTooltip.classList.add("show");const n=e.getBoundingClientRect(),a=customTooltip.getBoundingClientRect();let i=n.left+n.width/2-a.width/2,o=n.top-a.height-8;i<8&&(i=8),i+a.width>window.innerWidth-8&&(i=window.innerWidth-a.width-8),o<8&&(o=n.bottom+8),customTooltip.style.left=i+"px",customTooltip.style.top=o+"px"}function hideTooltip(){customTooltip.classList.remove("show")}async function handleLogin(e){showLoading(),loginError.style.display="none";try{const{data:t,error:n}=await client.from("user_access").select("*").eq("pin",e).single();if(n||!t)return loginError.textContent="Invalid PIN. Please try again.",loginError.style.display="block",void hideLoading();currentUser=t,localStorage.setItem("userPin",e),initializeApp()}catch(e){console.error("Login error:",e),loginError.textContent="An unexpected error occurred during login.",loginError.style.display="block",hideLoading()}}async function handleLogout(){currentUser=null,localStorage.removeItem("userPin"),location.reload()}function getUniqueValues(e){const t=new Set;return(allRecords||[]).forEach(n=>{const a=n[e];null!=a&&""!==String(a).trim()&&t.add(String(a).trim())}),Array.from(t).sort()}function buildForm(){formFields.innerHTML="";for(const e of ALL_COLUMNS){if("id"===e)continue;const t=document.createElement("div");t.className="col-md-6 col-lg-4";const n=["Region","Division","Scheme Head","Name of Scheme"].includes(e)?"required":"";if(["Region","Division","Scheme Head"].includes(e)){const a=getUniqueValues(e);if("Region"===e&&!currentUser.can_view_all){const i=getAllowedRegions();let o='<option value="">Select</option>';a.forEach(e=>{i.includes(e)&&(o+=`<option value="${e}">${e}</option>`)}),t.innerHTML=`\n          <label class="form-label fw-semibold">${e} ${n?'<span class="text-danger">*</span>':""}</label>\n          <select class="form-select form-select-sm" id="field_${escapeId(e)}" ${n}>\n            ${o}\n          </select>\n        `,formFields.appendChild(t);continue}let i='<option value="">Select</option>';a.forEach(t=>{("Division"!==e||currentUser.can_view_all||currentUser.divisions.includes(t))&&(i+=`<option value="${t}">${t}</option>`)}),t.innerHTML=`\n        <label class="form-label fw-semibold">${e} ${n?'<span class="text-danger">*</span>':""}</label>\n        <select class="form-select form-select-sm" id="field_${escapeId(e)}" ${n}>\n          ${i}\n        </select>\n      `}else"Priority"===e?t.innerHTML=`\n        <label class="form-label fw-semibold">${e}</label>\n        <select class="form-select form-select-sm" id="field_${escapeId(e)}">\n          <option value="">Select</option>\n          <option value="Phase-I">Phase-I</option>\n          <option value="Phase-II">Phase-II</option>\n        </select>\n      `:"Status"===e?t.innerHTML=`\n    <label class="form-label fw-semibold">${e}</label>\n    <select class="form-select form-select-sm" id="field_${escapeId(e)}">\n      <option value="">Select</option>\n      <option value="Proposal not initiated">Proposal not initiated</option>\n      <option value="Approval pending">Approval pending</option>\n      <option value="TAA issued, work yet to start">TAA issued, work yet to start</option>\n      <option value="Work in progress">Work in progress</option>\n      <option value="Completed">Completed</option>\n    </select>\n  `:e.includes("Date")?t.innerHTML=`\n        <label class="form-label fw-semibold">${e} ${n?'<span class="text-danger">*</span>':""}</label>\n        <input type="date" class="form-control form-control-sm" id="field_${escapeId(e)}" ${n}>\n      `:"Detail Work Status"===e?(t.className="col-12",t.innerHTML=`\n        <label class="form-label fw-semibold">${e} ${n?'<span class="text-danger">*</span>':""}</label>\n        <textarea class="form-control form-control-sm" id="field_${escapeId(e)}" rows="3" style="resize: vertical;" ${n}></textarea>\n      `):t.innerHTML=`\n        <label class="form-label fw-semibold">${e} ${n?'<span class="text-danger">*</span>':""}</label>\n        <input type="text" class="form-control form-control-sm" id="field_${escapeId(e)}" placeholder="${e}" ${n}>\n      `;formFields.appendChild(t)}}function buildHead(){tableHead.innerHTML="";const e=document.createElement("tr"),t={id:"6%",Division:"8%","Name of Scheme":"auto","TAA No.":"10%","Detail Work Status":"auto",Status:"12%","Target Date":"8%",Actions:"5%"};for(const n of TABLE_COLUMNS){const a=document.createElement("th");a.textContent=COMPACT_HEADERS[n]||n,t[n]&&(a.style.width=t[n]),e.appendChild(a)}const n=document.createElement("th");n.textContent="Actions",n.style.width=t.Actions,e.appendChild(n),tableHead.appendChild(e)}function renderTable(e){tableBody.innerHTML="",e&&0!==e.length?e.forEach(e=>{const t=document.createElement("tr");t.className="row-hover "+("Completed"===e.Status?"completed-row":""),t.dataset.id=e.id,t.addEventListener("mouseenter",t=>showTooltip(t.target,e["Detail Work Status"])),t.addEventListener("mouseleave",hideTooltip);for(const n of TABLE_COLUMNS){const a=document.createElement("td");"Status"===n?a.innerHTML=`<span class="status-badge">${e[n]||""}</span>`:"Priority"===n?a.innerHTML=`<span class="badge ${getPriorityBadge(e[n])}">${e[n]||""}</span>`:a.textContent=e[n]||"",t.appendChild(a)}const n=document.createElement("td"),a=document.createElement("button");a.className="btn btn-sm btn-action btn-outline-secondary me-2",a.innerHTML='<i class="bi bi-pencil-square"></i>',a.addEventListener("click",()=>{editRecord(e.id)}),currentUser.can_edit||(a.disabled=!0),n.appendChild(a),t.appendChild(n),tableBody.appendChild(t)}):tableBody.innerHTML=`<tr><td colspan="${TABLE_COLUMNS.length+1}" class="text-center text-muted py-5">No records found.</td></tr>`}function buildDivisionTabs(){let e,t=getUniqueValues("Division");e=currentUser.can_view_all?t:t.filter(e=>currentUser.divisions.includes(e)),divisionTabsContainer.innerHTML="";const n={};if(allRecords.forEach(e=>{(currentUser.can_view_all||getAllowedRegions().includes(e.Region)&&currentUser.divisions.includes(e.Division))&&(n[e.Division]=(n[e.Division]||0)+1)}),currentUser.can_view_all){const e=createDivisionTab("All",Object.values(n).reduce((e,t)=>e+t,0));divisionTabsContainer.appendChild(e)}e.forEach(e=>{const t=createDivisionTab(e,n[e]||0);divisionTabsContainer.appendChild(t)});const a=currentUser.can_view_all?"All":e[0];if(a){currentDivision=a;const e=document.querySelector(`#divisionTabs .filter-chip[data-division="${a}"]`);e&&e.classList.add("active")}}function createDivisionTab(e,t=0){const n=document.createElement("button");return n.className="filter-chip",n.dataset.division=e,n.innerHTML=`<span>${e} (${t})</span>`,e===currentDivision&&n.classList.add("active"),n.addEventListener("click",()=>{currentDivision=e,currentPage=1,filterAndRenderTable(),document.querySelectorAll("#divisionTabs .filter-chip").forEach(e=>e.classList.remove("active")),n.classList.add("active")}),n}function buildSchemeHeadFilters(){const e=getUniqueValues("Scheme Head");schemeHeadFiltersContainer.innerHTML="",selectedSchemeHeads.clear();const t="filter-all-schemeheads",n=document.createElement("div");n.className="form-check mb-2",n.innerHTML=`\n    <input class="form-check-input" type="checkbox" value="__all__" id="${t}">\n    <label class="form-check-label fw-semibold" for="${t}">\n      Select / Deselect all\n    </label>\n  `,schemeHeadFiltersContainer.appendChild(n);const a={};function i(){const e=schemeHeadFiltersContainer.querySelectorAll(".schemehead-checkbox").length,n=schemeHeadFiltersContainer.querySelectorAll(".schemehead-checkbox:checked").length,a=document.getElementById(t);a&&(a.checked=n===e&&e>0,a.indeterminate=n>0&&n<e)}allRecords.forEach(e=>{if(currentUser.can_view_all||getAllowedRegions().includes(e.Region)&&currentUser.divisions.includes(e.Division)){const t=e["Scheme Head"];t&&(a[t]=(a[t]||0)+1)}}),e.forEach(e=>{const t=`filter-${escapeId(e)}`,n=document.createElement("div");n.className="form-check mb-2",n.innerHTML=`\n      <input class="form-check-input schemehead-checkbox" type="checkbox" value="${e}" id="${t}" checked>\n      <label class="form-check-label d-flex justify-content-between align-items-center" for="${t}">\n        <span>${e}</span>\n        <span class="count-badge">${a[e]||0}</span>\n      </label>\n    `,schemeHeadFiltersContainer.appendChild(n),selectedSchemeHeads.add(e)});document.getElementById(t).addEventListener("change",e=>{const t=e.target.checked;schemeHeadFiltersContainer.querySelectorAll(".schemehead-checkbox").forEach(e=>{e.checked=t,t?selectedSchemeHeads.add(e.value):selectedSchemeHeads.delete(e.value)}),i(),currentPage=1,filterAndRenderTable()}),schemeHeadFiltersContainer.addEventListener("change",e=>{e.target&&e.target.classList.contains("schemehead-checkbox")&&(e.target.checked?selectedSchemeHeads.add(e.target.value):selectedSchemeHeads.delete(e.target.value),i(),currentPage=1,filterAndRenderTable())}),i()}function setupPagination(e){const t=Math.ceil(e/15);if(paginationControls.innerHTML="",t<=1)return showingStart.textContent=e>0?1:0,showingEnd.textContent=e,void(showingTotal.textContent=allRecords.length);let n=Math.max(1,currentPage-2),a=Math.min(t,currentPage+2);a-n<4&&(currentPage<=3&&(a=Math.min(t,5)),currentPage>t-3&&(n=Math.max(1,t-4)));const i=document.createElement("li");i.className="page-item "+(1===currentPage?"disabled":""),i.innerHTML='<a class="page-link" href="#">Previous</a>',i.addEventListener("click",()=>{currentPage>1&&(currentPage--,filterAndRenderTable())});const o=document.createElement("li");o.className="page-item "+(currentPage===t?"disabled":""),o.innerHTML='<a class="page-link" href="#">Next</a>',o.addEventListener("click",()=>{currentPage<t&&(currentPage++,filterAndRenderTable())});const s=document.createElement("ul");if(s.className="pagination pagination-sm mb-0",s.appendChild(i),n>1&&(s.appendChild(createPageLink(1)),n>2)){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',s.appendChild(e)}for(let e=n;e<=a;e++)s.appendChild(createPageLink(e));if(a<t){if(a<t-1){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',s.appendChild(e)}s.appendChild(createPageLink(t))}s.appendChild(o),paginationControls.appendChild(s)}function createPageLink(e){const t=document.createElement("li");return t.className="page-item "+(e===currentPage?"active":""),t.innerHTML=`<a class="page-link" href="#">${e}</a>`,t.addEventListener("click",()=>{e!==currentPage&&(currentPage=e,filterAndRenderTable())}),t}function filterAndRenderTable(){let e=allRecords;if(!currentUser.can_view_all){const t=getAllowedRegions();e=e.filter(e=>t.includes(e.Region)&&currentUser.divisions.includes(e.Division))}e.filter(e=>"Proposal not initiated"===e.Status).length,e.filter(e=>"Work in progress"===e.Status).length,e.filter(e=>"TAA issued, work yet to start"===e.Status).length,e.filter(e=>"Completed"===e.Status).length;totalCount.textContent=e.length,"All"!==currentDivision&&(e=e.filter(e=>e.Division===currentDivision)),selectedSchemeHeads.size>0&&selectedSchemeHeads.size<schemeHeads.length&&(e=e.filter(e=>selectedSchemeHeads.has(e["Scheme Head"]))),selectedStatuses.size>0&&(e=e.filter(e=>selectedStatuses.has(e.Status)));const t=searchInput.value.toLowerCase().trim();t&&(e=e.filter(e=>TABLE_COLUMNS.some(n=>String(e[n]).toLowerCase().includes(t))));let n=[...e],a="";["Proposal not initiated","Approval pending","TAA issued, work yet to start","Work in progress","Completed"].forEach(e=>{const t=n.filter(t=>t.Status===e).length,i=selectedStatuses.has(e)?"active":"";a+=`\n  <button type="button" \n    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${i}" \n    data-status="${e}">\n    ${e}\n    <span class="badge bg-secondary rounded-pill">${t}</span>\n  </button>\n`}),document.getElementById("statusCountsList").innerHTML=a,selectedStatuses.size>0&&(e=e.filter(e=>selectedStatuses.has(e.Status))),document.querySelectorAll("#statusCountsList button").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.status;selectedStatuses.has(t)?(selectedStatuses.delete(t),e.classList.remove("active")):(selectedStatuses.add(t),e.classList.add("active")),currentPage=1,filterAndRenderTable()})});const i=15*(currentPage-1),o=Math.min(i+15,e.length);showingStart.textContent=e.length>0?i+1:0,showingEnd.textContent=o,showingTotal.textContent=e.length;renderTable(e.slice(i,o)),setupPagination(e.length)}function newRecord(){document.getElementById("modalTitle").textContent="Add New Scheme",document.getElementById("recordForm").reset(),recordId.value="",btnDelete.style.display="none",editModal.show()}async function editRecord(e){showLoading(),document.getElementById("modalTitle").textContent="Edit Scheme",btnDelete.style.display="block";const{data:t,error:n}=await client.from(TABLE_NAME).select("*").eq("id",e).single();if(hideLoading(),n)showMessage(`Error fetching record: ${n.message}`,"error");else{recordId.value=t.id;for(const e of ALL_COLUMNS)if("id"!==e){const n=document.getElementById(`field_${escapeId(e)}`);n&&(n.value=t[e]||"")}editModal.show()}}async function saveRecord(e){e.preventDefault(),showLoading();const t=!recordId.value,n={};for(const e of ALL_COLUMNS)if("id"!==e){const t=document.getElementById(`field_${escapeId(e)}`);t&&(n[e]=t.value||null)}if(n.Division&&!currentUser.can_view_all&&!currentUser.divisions.includes(n.Division))return hideLoading(),void showMessage("You are not authorized to add/edit records for this division.","error");let a;if(t)a=await client.from(TABLE_NAME).insert(n).select(),!a.error&&a.data.length>0&&allRecords.push(a.data[0]);else if(a=await client.from(TABLE_NAME).update(n).eq("id",recordId.value).select(),!a.error&&a.data.length>0){const e=allRecords.findIndex(e=>e.id==recordId.value);e>-1&&(allRecords[e]=a.data[0])}a.error?(hideLoading(),showMessage(`Error saving record: ${a.error.message}`,"error")):(editModal.hide(),hideLoading(),filterAndRenderTable())}async function deleteRecord(){showLoading();const e=recordId.value,t=allRecords.find(t=>t.id==e);if(t&&!currentUser.can_view_all&&!currentUser.divisions.includes(t.Division))return hideLoading(),void showMessage("You do not have permission to delete this record.","error");const{error:n}=await client.from(TABLE_NAME).delete().eq("id",e);n?(hideLoading(),showMessage(`Error deleting record: ${n.message}`,"error")):(await fetchData(),editModal.hide(),hideLoading())}function downloadCsv(e){if(0===e.length)return void showMessage("No records to download.","info");const t=Object.keys(e[0]),n="data:text/csv;charset=utf-8,"+t.map(e=>`"${e}"`).join(",")+"\n"+e.map(e=>t.map(t=>`"${(e[t]||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n"),a=encodeURI(n),i=document.createElement("a");i.setAttribute("href",a),i.setAttribute("download","prioritySI_data.csv"),document.body.appendChild(i),i.click(),document.body.removeChild(i)}async function fetchData(){showLoading();const{data:e,error:t}=await client.from(TABLE_NAME).select("*");t?(showMessage(`Error fetching data: ${t.message}`,"error"),allRecords=[]):(allRecords=e||[],divisions=getUniqueValues("Division"),schemeHeads=getUniqueValues("Scheme Head")),buildForm(),buildDivisionTabs(),buildSchemeHeadFilters(),filterAndRenderTable(),hideLoading()}loginForm.addEventListener("submit",async e=>{e.preventDefault(),await handleLogin(pinInput.value)}),btnLogout.addEventListener("click",handleLogout),btnAdd.addEventListener("click",newRecord),btnSave.addEventListener("click",saveRecord),btnDelete.addEventListener("click",deleteRecord),btnDownloadCsv.addEventListener("click",()=>{let e=allRecords;currentUser.can_view_all||(e=e.filter(e=>currentUser.divisions.includes(e.Division))),"All"!==currentDivision&&(e=e.filter(e=>e.Division===currentDivision)),selectedSchemeHeads.size>0&&selectedSchemeHeads.size<schemeHeads.length&&(e=e.filter(e=>selectedSchemeHeads.has(e["Scheme Head"]))),selectedStatuses.size>0&&(e=e.filter(e=>selectedStatuses.has(e.Status)));const t=searchInput.value.toLowerCase().trim();t&&(e=e.filter(e=>TABLE_COLUMNS.some(n=>String(e[n]).toLowerCase().includes(t)))),downloadCsv(e)}),window.addEventListener("scroll",hideTooltip),toggleSidebarBtn.addEventListener("click",()=>{sidebar.classList.toggle("active")}),closeSidebarBtn.addEventListener("click",()=>{sidebar.classList.remove("active")}),window.addEventListener("click",e=>{sidebar.contains(e.target)||toggleSidebarBtn.contains(e.target)||sidebar.classList.contains("active")&&sidebar.classList.remove("active")});const debouncedSearch=debounce(()=>{currentPage=1,filterAndRenderTable()},300);async function initializeApp(){loginContainer.style.display="none",appContainer.style.display="flex",currentUser.can_edit?(btnAdd.style.display="flex",btnSave.disabled=!1,document.querySelector("#editModal .modal-body").style.pointerEvents="auto"):(btnAdd.style.display="none",btnSave.disabled=!0,btnDelete.style.display="none",document.getElementById("modalTitle").textContent="View Scheme",document.querySelector("#editModal .modal-body").style.pointerEvents="none"),editModal=new bootstrap.Modal(document.getElementById("editModal")),buildHead(),await fetchData()}searchInput.addEventListener("input",debouncedSearch),document.addEventListener("DOMContentLoaded",async()=>{showLoading();const e=localStorage.getItem("userPin");if(e){const{data:t,error:n}=await client.from("user_access").select("*").eq("pin",e).single();t&&!n?(currentUser=t,initializeApp()):(localStorage.removeItem("userPin"),loginContainer.style.display="flex",appContainer.style.display="none",hideLoading())}else loginContainer.style.display="flex",appContainer.style.display="none",hideLoading()})</script></body></html>
