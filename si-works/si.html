<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheet Data Viewer</title>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for compact table and responsive layout */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* Corrected background color: #f3f4f6 */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top, not center vertically */
            min-height: 100vh;
            padding-top: 2rem; /* Add some top padding */
        }
        .container {
            width: 100%;
            max-width: 90%; /* Max width for larger screens */
            margin: 0 auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Ensure shadow is not cut off */
        }
        .table-container {
            overflow-x: auto; /* Enable horizontal scrolling on small screens for the table */
            margin-top: 1.5rem;
            border-radius: 0.5rem; /* Rounded corners for table container */
            border: 1px solid #e5e7eb; /* Subtle border */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* Ensure table is readable on small screens, enabling scroll */
        }
        th, td {
            padding: 10px 16px; /* Slightly more padding */
            border: 1px solid #e5e7eb;
            text-align: left;
            font-size: 0.95em; /* Slightly larger font */
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            white-space: nowrap; /* Prevent headers from wrapping */
        }
        tr:nth-child(even) {
            background-color: #f9fafb; /* Zeebra striping */
        }
        tr:hover {
            background-color: #f3f4f6; /* Hover effect */
        }
        td {
            color: #4b5563;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .modal-input-group {
            margin-bottom: 1rem;
        }
        .modal-input-group label {
            display: block;
            font-size: 0.9em;
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .modal-input-group input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1em;
            color: #374151;
            box-sizing: border-box; /* Include padding in width */
        }
        .modal-input-group input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            font-size: 1em;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message Box styles (for alerts) */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .message-box-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .message-box-overlay.visible .message-box-content {
            transform: translateY(0);
        }
        .message-box-text {
            font-size: 1.1em;
            margin-bottom: 1.5rem;
            color: #374151;
        }
        .message-box-button {
            background-color: #2563eb;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .message-box-button:hover {
            background-color: #1d4ed8;
        }

        /* Confirmation Box styles (for confirm dialogs) */
        .confirm-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .confirm-box-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .confirm-box-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .confirm-box-overlay.visible .confirm-box-content {
            transform: translateY(0);
        }
        .confirm-box-text {
            font-size: 1.1em;
            margin-bottom: 1.5rem;
            color: #374151;
        }
        .confirm-box-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .confirm-box-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .confirm-box-button.confirm {
            background-color: #dc2626; /* Red for delete confirmation */
            color: white;
        }
        .confirm-box-button.confirm:hover {
            background-color: #b91c1c;
        }
        .confirm-box-button.cancel {
            background-color: #e5e7eb;
            color: #374151;
        }
        .confirm-box-button.cancel:hover {
            background-color: #d1d5db;
        }

    </style>
</head>
<body class="antialiased">
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Google Sheet Data Viewer</h1>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <button id="addNewButton" class="btn btn-primary w-full sm:w-auto mb-3 sm:mb-0">Add New Entry</button>
            <div class="flex gap-4">
                <button id="refreshButton" class="btn btn-secondary w-full sm:w-auto">Refresh Data</button>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <!-- Headers will be populated by JavaScript -->
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
            <p id="noDataMessage" class="text-center text-gray-500 py-8 hidden">No data available.</p>
        </div>
    </div>

    <!-- Modal for Add/Update Data -->
    <div id="dataModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modalTitle" class="modal-title">Add New Entry</h2>
            <form id="dataForm">
                <div class="modal-input-group">
                    <label for="schemeInput">Scheme:</label>
                    <input type="text" id="schemeInput" name="Scheme" required class="w-full">
                </div>
                <div class="modal-input-group">
                    <label for="nameInput">Name:</label>
                    <input type="text" id="nameInput" name="Name" class="w-full">
                </div>
                <div class="modal-input-group">
                    <label for="descriptionInput">Description:</label>
                    <input type="text" id="descriptionInput" name="Description" class="w-full">
                </div>
                <!-- Add more input fields dynamically based on headers -->
                <div id="dynamicInputs"></div>
                <div class="modal-actions">
                    <button type="button" id="cancelButton" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="saveButton" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Box Modal (for alerts) -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <p id="messageBoxText" class="message-box-text"></p>
            <button id="messageBoxButton" class="message-box-button">OK</button>
        </div>
    </div>

    <!-- Confirmation Box Modal (for confirm dialogs) -->
    <div id="confirmBoxOverlay" class="confirm-box-overlay">
        <div class="confirm-box-content">
            <p id="confirmBoxText" class="confirm-box-text"></p>
            <div class="confirm-box-actions">
                <button id="confirmBoxCancelButton" class="confirm-box-button cancel">Cancel</button>
                <button id="confirmBoxConfirmButton" class="confirm-box-button confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // IMPORTANT: Replace with the published URL of your Google Apps Script web app.
            // Go to your Apps Script project, then Deploy -> New deployment.
            // Choose "Web app" as the type.
            // For "Execute as:", choose "Me".
            // For "Who has access:", choose "Anyone" (or "Anyone, even anonymous").
            // Copy the URL provided after deployment and paste it here.
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvgRshxMEx9rz5ZyeKOSNX2IX-XMkBN7_gomzGT2yUoWUcl4rpLOoG-kby3mWtO6xaWA/exec';
            const UNIQUE_IDENTIFIER_COLUMN = 'Scheme'; // Must match the one in Apps Script

            const dataTable = document.getElementById('dataTable');
            const tableHead = dataTable.querySelector('thead');
            const tableBody = dataTable.querySelector('tbody');
            const noDataMessage = document.getElementById('noDataMessage');

            const addNewButton = document.getElementById('addNewButton');
            const refreshButton = document.getElementById('refreshButton');
            const dataModal = document.getElementById('dataModal');
            const modalTitle = document.getElementById('modalTitle');
            const dataForm = document.getElementById('dataForm');
            const saveButton = document.getElementById('saveButton');
            const cancelButton = document.getElementById('cancelButton');
            const dynamicInputsDiv = document.getElementById('dynamicInputs');

            const loadingOverlay = document.getElementById('loadingOverlay');

            // Message Box elements
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxButton = document.getElementById('messageBoxButton');

            // Confirmation Box elements
            const confirmBoxOverlay = document.getElementById('confirmBoxOverlay');
            const confirmBoxText = document.getElementById('confirmBoxText');
            const confirmBoxConfirmButton = document.getElementById('confirmBoxConfirmButton');
            const confirmBoxCancelButton = document.getElementById('confirmBoxCancelButton');
            let confirmCallback = null; // To store the callback for the confirm action

            let currentHeaders = [];
            let currentMode = 'add'; // 'add' or 'update'
            let editingScheme = null; // Stores the scheme of the row being edited

            /**
             * Shows the loading spinner.
             */
            function showLoading() {
                loadingOverlay.classList.add('visible');
            }

            /**
             * Hides the loading spinner.
             */
            function hideLoading() {
                loadingOverlay.classList.remove('visible');
            }

            /**
             * Displays a custom message box instead of alert.
             * @param {string} message The message to display.
             */
            function showMessageBox(message) {
                messageBoxText.textContent = message;
                messageBoxOverlay.classList.add('visible');
            }

            /**
             * Hides the custom message box.
             */
            function hideMessageBox() {
                messageBoxOverlay.classList.remove('visible');
            }

            /**
             * Displays a custom confirmation box.
             * @param {string} message The confirmation message.
             * @param {function(boolean): void} callback Function to call with true/false based on user choice.
             */
            function showConfirmBox(message, callback) {
                confirmBoxText.textContent = message;
                confirmCallback = callback; // Store the callback
                confirmBoxOverlay.classList.add('visible');
            }

            /**
             * Hides the custom confirmation box.
             */
            function hideConfirmBox() {
                confirmBoxOverlay.classList.remove('visible');
                confirmCallback = null; // Clear the callback
            }

            /**
             * Fetches data from the Google Sheet via Apps Script and renders the table.
             */
            async function fetchDataAndRenderTable() {
                showLoading();
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action: 'read' })
                    });

                    // Check if the response is successful (status code 200-299)
                    if (!response.ok) {
                        // If response is not OK, try to read error message from server if any
                        const errorText = await response.text(); // Read as text in case it's not JSON
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText || 'Unknown error.'}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        const data = result.data;
                        renderTable(data);
                    } else {
                        showMessageBox(`Error fetching data: ${result.message}`);
                        console.error("Server error:", result.message);
                        renderTable([]); // Clear table on error
                    }
                } catch (error) {
                    console.error("Error communicating with Apps Script:", error);
                    showMessageBox(`An error occurred while fetching data. Please ensure the SCRIPT_URL is correct and your Apps Script is deployed with 'Anyone' access. Details: ${error.message}`);
                    renderTable([]); // Clear table on error
                } finally {
                    hideLoading();
                }
            }

            /**
             * Renders the HTML table with data from the Google Sheet.
             * @param {Array<Object>} data The array of data objects to display.
             */
            function renderTable(data) {
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                noDataMessage.classList.add('hidden');

                if (data.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    return;
                }

                // Get headers from the first data object
                currentHeaders = Object.keys(data[0]);

                // Create table headers
                const headerRow = document.createElement('tr');
                currentHeaders.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                // Add header for actions column
                const actionsTh = document.createElement('th');
                actionsTh.textContent = 'Actions';
                headerRow.appendChild(actionsTh);
                tableHead.appendChild(headerRow);

                // Populate table body
                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    currentHeaders.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = rowData[header];
                        tr.appendChild(td);
                    });

                    // Add action buttons
                    const actionsTd = document.createElement('td');
                    actionsTd.classList.add('flex', 'gap-2', 'items-center');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('btn', 'btn-primary', 'py-1', 'px-2', 'text-sm');
                    editButton.onclick = () => openEditModal(rowData);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('btn', 'btn-danger', 'py-1', 'px-2', 'text-sm');
                    deleteButton.onclick = () => {
                        showConfirmBox(`Are you sure you want to delete the entry with Scheme: ${rowData[UNIQUE_IDENTIFIER_COLUMN]}?`, (confirmed) => {
                            if (confirmed) {
                                handleDelete(rowData[UNIQUE_IDENTIFIER_COLUMN]);
                            }
                        });
                    };

                    actionsTd.appendChild(editButton);
                    actionsTd.appendChild(deleteButton);
                    tr.appendChild(actionsTd);

                    tableBody.appendChild(tr);
                });
            }

            /**
             * Opens the modal for adding a new entry.
             */
            function openAddModal() {
                currentMode = 'add';
                modalTitle.textContent = 'Add New Entry';
                dataForm.reset();
                dynamicInputsDiv.innerHTML = ''; // Clear dynamic inputs

                // Ensure the UNIQUE_IDENTIFIER_COLUMN input is present for 'add' mode
                let schemeInput = document.getElementById('schemeInput');
                if (!schemeInput) {
                    const schemeInputGroup = document.createElement('div');
                    schemeInputGroup.classList.add('modal-input-group');
                    schemeInputGroup.innerHTML = `
                        <label for="schemeInput">Scheme:</label>
                        <input type="text" id="schemeInput" name="Scheme" required class="w-full">
                    `;
                    dataForm.prepend(schemeInputGroup); // Add to the top
                    schemeInput = document.getElementById('schemeInput'); // Get the newly created input
                }
                schemeInput.readOnly = false; // Ensure it's editable for new entry

                // Re-create inputs for other headers (if they exist in currentHeaders)
                currentHeaders.forEach(header => {
                    if (header !== UNIQUE_IDENTIFIER_COLUMN) {
                        addDynamicInputField(header, '');
                    }
                });

                dataModal.classList.remove('hidden');
                setTimeout(() => dataModal.classList.add('visible'), 10); // Trigger animation
            }

            /**
             * Opens the modal for editing an existing entry.
             * @param {Object} rowData The data of the row to be edited.
             */
            function openEditModal(rowData) {
                currentMode = 'update';
                modalTitle.textContent = 'Edit Entry';
                dataForm.reset();
                dynamicInputsDiv.innerHTML = ''; // Clear previous dynamic inputs
                editingScheme = rowData[UNIQUE_IDENTIFIER_COLUMN];

                // Populate form fields with existing data
                // Ensure UNIQUE_IDENTIFIER_COLUMN is read-only for updates
                let schemeInput = document.getElementById('schemeInput');
                if (!schemeInput) { // Create if it doesn't exist (e.g., if it was dynamically removed for add)
                     const schemeInputGroup = document.createElement('div');
                    schemeInputGroup.classList.add('modal-input-group');
                    schemeInputGroup.innerHTML = `
                        <label for="schemeInput">Scheme:</label>
                        <input type="text" id="schemeInput" name="Scheme" required class="w-full">
                    `;
                    dataForm.prepend(schemeInputGroup);
                    schemeInput = document.getElementById('schemeInput');
                }
                schemeInput.value = rowData[UNIQUE_IDENTIFIER_COLUMN];
                schemeInput.readOnly = true; // Make Scheme read-only when updating

                currentHeaders.forEach(header => {
                    // Only add dynamic inputs for headers that aren't the UNIQUE_IDENTIFIER_COLUMN
                    // and also aren't already hardcoded in the HTML (like Name, Description)
                    if (header !== UNIQUE_IDENTIFIER_COLUMN && !document.getElementById(`${header.toLowerCase()}Input`)) {
                        addDynamicInputField(header, rowData[header] || '');
                    } else if (document.getElementById(`${header.toLowerCase()}Input`)) {
                        // If it's a hardcoded input, just set its value
                        document.getElementById(`${header.toLowerCase()}Input`).value = rowData[header] || '';
                    }
                });

                dataModal.classList.remove('hidden');
                setTimeout(() => dataModal.classList.add('visible'), 10); // Trigger animation
            }

            /**
             * Adds a dynamic input field to the modal form.
             * @param {string} labelText The label for the input field.
             * @param {string} value The initial value of the input field.
             */
            function addDynamicInputField(labelText, value) {
                const inputId = `${labelText.toLowerCase()}Input`;
                const inputGroup = document.createElement('div');
                inputGroup.classList.add('modal-input-group');
                inputGroup.innerHTML = `
                    <label for="${inputId}">${labelText}:</label>
                    <input type="text" id="${inputId}" name="${labelText}" value="${value}" class="w-full">
                `;
                dynamicInputsDiv.appendChild(inputGroup);
            }

            /**
             * Handles saving new or updated data to the Google Sheet.
             * This function constructs the JSON payload correctly.
             * @param {Event} event The form submission event.
             */
            async function handleSave(event) {
                event.preventDefault(); // Prevent default form submission

                showLoading();

                const formData = new FormData(dataForm);
                const payloadData = {};
                for (let [key, value] of formData.entries()) {
                    payloadData[key] = value;
                }

                let action = '';
                if (currentMode === 'add') {
                    action = 'add';
                } else if (currentMode === 'update') {
                    action = 'update';
                }

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // IMPORTANT: JSON.stringify is crucial here to send data as a JSON string
                        body: JSON.stringify({ action: action, data: payloadData })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText || 'Unknown error.'}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        showMessageBox(result.message);
                        closeModal();
                        // Re-render table to show the latest data from the sheet
                        await fetchDataAndRenderTable();
                    } else {
                        showMessageBox(`Error: ${result.message}`);
                        console.error("Server error:", result.message);
                    }
                } catch (error) {
                    console.error("Error communicating with Apps Script:", error);
                    showMessageBox(`An error occurred while trying to save data. Please ensure the SCRIPT_URL is correct and your Apps Script is deployed with 'Anyone' access. Details: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }

            /**
             * Handles deleting a row from the Google Sheet.
             * @param {string} scheme The unique identifier (Scheme) of the row to delete.
             */
            async function handleDelete(scheme) {
                showLoading();
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action: 'delete', data: { [UNIQUE_IDENTIFIER_COLUMN]: scheme } })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorText || 'Unknown error.'}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        showMessageBox(result.message);
                        await fetchDataAndRenderTable(); // Refresh table after deletion
                    } else {
                        showMessageBox(`Error: ${result.message}`);
                        console.error("Server error:", result.message);
                    }
                } catch (error) {
                    console.error("Error communicating with Apps Script:", error);
                    showMessageBox(`An error occurred while trying to delete data. Please ensure the SCRIPT_URL is correct and your Apps Script is deployed with 'Anyone' access. Details: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }

            /**
             * Closes the modal.
             */
            function closeModal() {
                dataModal.classList.remove('visible');
                dataModal.classList.add('hidden'); // Fully hide after transition
                dataForm.reset(); // Reset form when closing
                // Make Scheme input editable again after closing if it was readOnly
                const schemeInput = document.getElementById('schemeInput');
                if (schemeInput) {
                    schemeInput.readOnly = false;
                }
            }

            // Event Listeners
            addNewButton.addEventListener('click', openAddModal);
            refreshButton.addEventListener('click', fetchDataAndRenderTable);
            dataForm.addEventListener('submit', handleSave); // Listen to form submission for save
            cancelButton.addEventListener('click', closeModal);
            messageBoxButton.addEventListener('click', hideMessageBox);

            // Event listeners for Confirmation Box
            confirmBoxConfirmButton.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(true);
                }
                hideConfirmBox();
            });
            confirmBoxCancelButton.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(false);
                }
                hideConfirmBox();
            });

            // Allow closing modal by clicking outside it
            dataModal.addEventListener('click', (e) => {
                if (e.target === dataModal) {
                    closeModal();
                }
            });
            // Allow closing message box by clicking outside it
            messageBoxOverlay.addEventListener('click', (e) => {
                if (e.target === messageBoxOverlay) {
                    hideMessageBox();
                }
            });
            // Allow closing confirm box by clicking outside it
            confirmBoxOverlay.addEventListener('click', (e) => {
                if (e.target === confirmBoxOverlay) {
                    hideConfirmBox();
                }
            });

            // Initial data load when the page loads
            fetchDataAndRenderTable();
        });
    </script>
</body>
</html>
