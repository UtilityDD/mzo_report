<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheme Data Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300,400,500,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet">
    <style>
        /* Base Styles for a larger desktop view */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3F51B5; /* Muted Blue */
            --primary-dark: #303F9F; /* Darker Muted Blue */
            --accent-color: #757575; /* Grey */
            --background-light: #F0F0F0; /* Light grey base */
            --background-paper: #FFFFFF; /* White elements */
            --text-dark: #333333; /* Dark grey text */
            --text-medium: #666666; /* Medium grey text */
            --border-light: #CCCCCC; /* Light grey for borders */
            --shadow-light: rgba(0, 0, 0, 0.02); /* Very subtle shadow */
            --shadow-medium: rgba(0, 0, 0, 0.05); /* Slightly less subtle shadow */
            --red-color: #D32F2F; /* For pending numbers */
            --green-color: #388E3C; /* For completed numbers */
        }

        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background-color: var(--background-light);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6; /* Increased line height for better readability */
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }

        .header {
            background-color: var(--background-paper);
            padding: 1rem 0; /* Increased padding */
            box-shadow: 0 2px 5px var(--shadow-light); /* Slightly increased shadow */
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1400px; /* Increased max-width for desktop */
            margin: 0 auto;
            padding: 0 1.0rem; /* Increased padding */
        }

        h1 {
            text-align: center;
            color: var(--primary-dark);
            font-size: 2rem; /* Increased font size */
            font-weight: 700;
            margin-bottom: 1rem; /* Increased margin */
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0;
        }

        h1 .material-icons {
            font-size: 2.2rem; /* Increased font size */
            margin-right: 0.6rem; /* Increased margin */
            color: var(--primary-color);
        }

        /* Tab Styles */
        .tab-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.6rem; /* Increased gap */
            margin-bottom: 1rem; /* Increased margin */
            padding: 0.8rem; /* Increased padding */
            background-color: #E0E0E0;
            border-radius: 6px; /* Slightly more rounded */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }

        .tab {
            padding: 0.6rem 1.0rem; /* Increased padding */
            border-radius: 6px; /* Slightly more rounded */
            background-color: var(--background-paper);
            color: var(--text-medium);
            font-size: 1rem; /* Increased font size */
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-align: center;
            border: 1px solid var(--border-light);
            font-weight: 500;
            box-shadow: none;
        }

        .tab:hover {
            background-color: #EAEAEA;
            color: var(--text-dark);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Filter Group for Region/Division */
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem; /* Increased gap */
            margin-bottom: 1rem; /* Increased margin */
            padding: 0.8rem; /* Increased padding */
            background-color: #E0E0E0;
            border-radius: 6px; /* Slightly more rounded */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.6rem; /* Increased gap */
        }

        .filter-item label {
            font-size: 1rem; /* Increased font size */
            color: var(--text-medium);
            font-weight: 500;
        }

        .filter-item select {
            padding: 0.5rem 0.8rem; /* Increased padding */
            border-radius: 6px; /* Slightly more rounded */
            border: 1px solid var(--border-light);
            background-color: var(--background-paper);
            font-size: 1rem; /* Increased font size */
            color: var(--text-dark);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666666%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.2-3.2-8.3-3.2-11.6%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.3%2C0%2C11.6l12.6%2C12.6c3.2%2C3.2%2C8.3%2C3.2%2C11.6%2C0l112-112l112%2C112c3.2%2C3.2%2C8.3%2C3.2%2C11.6%2C0l12.6-12.6C290.2%2C205.6%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.8em auto;
            padding-right: 2rem; /* Increased padding */
            box-shadow: none;
            transition: border-color 0.2s ease;
            min-width: 150px; /* Increased min-width */
        }

        .filter-item select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Increased min-width */
            gap: 1rem; /* Increased gap */
            margin: 1rem 0; /* Increased margin */
        }

        .summary-card {
            background-color: var(--background-paper);
            padding: 1rem; /* Increased padding */
            border-radius: 8px; /* More rounded */
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow-light); /* Increased shadow */
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            border: 1px solid var(--border-light);
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .summary-card .number {
            font-size: 2.5rem; /* Increased font size */
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1;
        }

        .summary-card .label {
            font-size: 0.9rem; /* Increased font size */
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px; /* Slightly increased letter spacing */
            font-weight: 500;
        }
        
        /* Specific colors for numbers */
        .summary-card .number.text-red {
            color: var(--red-color);
        }

        .summary-card .number.text-green {
            color: var(--green-color);
        }

        /* Main Content */
        .main-content {
            background-color: var(--background-paper);
            margin: 1.5rem auto; /* Increased margin */
            border-radius: 8px;
            padding: 0.5rem; /* Increased padding */
            max-width: 1400px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); /* Increased shadow */
            border: 1px solid var(--border-light);
        }

        .loading .material-icons {
            margin-bottom: 0.8rem; /* Increased margin */
            font-size: 3rem; /* Increased font size */
            color: var(--primary-color);
        }

        .error {
            text-align: center;
            padding: 0.5rem; /* Increased padding */
            color: #D32F2F;
            background-color: #FFEBEE;
            border-radius: 8px;
            margin: 1.5rem 0; /* Increased margin */
            border: 1px solid #EF9A9A;
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Tabular Summaries */
        .summary-table-section {
            background-color: var(--background-paper);
            padding: 1.5rem; /* Increased padding */
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-light); /* Increased shadow */
            margin-top: 1.5rem; /* Increased margin */
            border: 1px solid var(--border-light);
        }

        .summary-table-section h3 {
            color: var(--primary-dark);
            font-size: 1.5rem; /* Increased font size */
            margin-bottom: 0.5rem; /* Increased margin */
            padding-bottom: 0.6rem; /* Increased padding */
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            margin-top: 1rem; /* Increased margin */
            font-size: 0.9rem; /* Increased font size */
            border-radius: 0;
            overflow: hidden;
            border: 1px solid #999;
        }

        .summary-table th, .summary-table td {
            border: 1px solid #CCC;
            padding: 0.5rem 0.5rem; /* Increased padding */
            text-align: left;
            word-break: normal;
            overflow-wrap: break-word;
        }

        .summary-table thead tr:first-child th:first-child {
            border-top-left-radius: 0;
        }

        .summary-table thead tr:first-child th:last-child {
            border-top-right-radius: 0;
        }

        .summary-table tbody tr:last-child td {
            border-bottom: 1px solid #CCC;
        }

        .summary-table th {
            background-color: #E0E0E0;
            font-weight: bold;
            color: var(--text-dark);
            text-transform: none;
            font-size: 0.95rem; /* Increased font size */
            letter-spacing: 0;
            text-align: center;
        }

        .summary-table tbody tr {
            cursor: pointer;
            transition: background-color 0.1s ease;
        }

        .summary-table tbody tr:nth-child(even) {
            background-color: #F9F9F9;
        }

        .summary-table tbody tr:hover {
            background-color: #EFEFEF;
        }
        
        .summary-table tbody tr td:first-child {
            color: var(--primary-dark);
            font-weight: normal;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            backdrop-filter: blur(3px); /* Slightly more blur */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--background-paper);
            padding: 0.5rem; /* Increased padding */
            border-radius: 8px;
            width: 90%;
            max-width: 700px; /* Increased max-width */
            max-height: 90vh; /* Increased max-height */
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); /* Increased shadow */
            transform: translateY(0);
            transition: none;
            border: 1px solid #999;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .close-button {
            position: absolute;
            top: 0.8rem; /* Adjusted position */
            right: 1rem; /* Adjusted position */
            font-size: 1.8rem; /* Increased font size */
            cursor: pointer;
            color: var(--text-medium);
            transition: color 0.1s ease;
        }

        .close-button:hover {
            color: var(--text-dark);
        }

        .modal h2 {
            color: var(--primary-dark);
            margin-bottom: 1rem; /* Increased margin */
            padding-bottom: 0.6rem; /* Increased padding */
            border-bottom: 1px solid var(--border-light);
            font-size: 1.8rem; /* Increased font size */
            font-weight: 700;
        }

        .modal-details {
            display: grid;
            gap: 0.3rem; /* Increased gap */
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1.2fr 2fr; /* Adjusted ratio */
            gap: 0.6rem; /* Increased gap */
            padding: 0.5rem 0.8rem; /* Increased padding */
            background-color: #FDFDFD;
            border-radius: 0;
            align-items: flex-start;
            border-bottom: 1px solid #E0E0E0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: bold;
            color: var(--text-medium);
            font-size: 0.9rem; /* Increased font size */
        }

        .detail-value {
            color: var(--text-dark);
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
            font-size: 0.9rem; /* Increased font size */
        }

        h1 .update-link {
            display: inline-flex;
            align-items: center;
            margin-left: 1rem; /* Increased margin */
            font-size: 0.8rem; /* Increased font size */
            font-weight: 600;
            color: white;
            background-color:  #D32F2F !important;
            padding: 0.3rem 0.6rem; /* Increased padding */
            border-radius: 6px; /* Slightly more rounded */
            text-decoration: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none;
        }

        h1 .update-link:hover {
            background-color: var(--primary-dark);
            box-shadow: none;
        }

        h1 .update-link .update-icon {
            font-size: 1rem; /* Increased font size */
            margin-right: 0.2rem; /* Increased margin */
            color: #ffe609 !important;
        }

        /* Responsive Design (adjust for desktop-first approach) */
        @media (max-width: 1024px) {
            .container {
                padding: 0 1rem;
            }
            h1 {
                font-size: 1.8rem;
            }
            h1 .material-icons {
                font-size: 2rem;
            }
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.8rem;
            }
            .summary-card .number {
                font-size: 2rem;
            }
            .summary-card .label {
                font-size: 0.85rem;
            }
            .main-content {
                padding: 1.5rem;
            }
            .summary-table th, .summary-table td {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
            .modal-content {
                max-width: 600px;
                padding: 0.5rem;
            }
            .modal h2 {
                font-size: 1.0rem;
            }
            .detail-label, .detail-value {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 14px; /* Smaller base font for tablets */
            }
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); /* Further reduced min-width */
                gap: 0.6rem; /* Reduced gap */
            }

            .summary-card {
                padding: 0.8rem; /* Reduced padding */
            }

            .summary-card .number {
                font-size: 1.6rem;
            }

            .summary-card .label {
                font-size: 0.75rem;
            }

            .modal-content {
                width: 98%;
                margin: 0.5% auto; /* Reduced margin */
                padding: 0.5rem; /* Reduced padding */
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.3rem; /* Reduced gap */
                padding: 0.3rem; /* Reduced padding */
            }
            
            .summary-table th, .summary-table td {
                padding: 0.4rem 0.5rem; /* Reduced padding */
                font-size: 0.75rem;
            }

            .tab-group {
                padding: 0.5rem; /* Reduced padding */
                gap: 0.3rem; /* Reduced gap */
            }

            .tab {
                padding: 0.4rem 0.8rem; /* Reduced padding */
                font-size: 0.8rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h1 .material-icons {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 0.5rem; /* Reduced padding */
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem; /* Reduced gap */
            }

            .filter-item select {
                width: 100%;
                min-width: unset;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 13px; /* Even smaller base font for mobile */
            }
            .container {
                padding: 0 0.8rem; /* Reduced padding */
            }

            h1 {
                font-size: 1.2rem;
            }

            h1 .material-icons {
                font-size: 1.5rem;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .summary-card .number {
                font-size: 1.4rem;
            }

            .summary-card .label {
                font-size: 0.7rem;
            }

            .modal-content {
                padding: 0.8rem; /* Reduced padding */
            }

            .summary-table th, .summary-table td {
                padding: 0.3rem 0.4rem; /* Further reduced padding */
                font-size: 0.65rem;
            }
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85); /* Slightly more opaque */
            backdrop-filter: blur(5px); /* More blur */
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            text-align: center;
            background: white;
            padding: 2rem 2.5rem; /* Increased padding */
            border-radius: 12px; /* More rounded */
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); /* Increased shadow */
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1.2rem; /* Increased font size */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .loader-content .material-icons.spinning {
            font-size: 3rem; /* Increased font size */
            margin-bottom: 0.8rem; /* Increased margin */
            animation: spin 1.2s linear infinite;
            color: var(--primary-color);
        }

        /* Styles for pending schemes table */
        .pending-table-section {
            background-color: var(--background-paper);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-light);
            padding: 1.5rem; /* Increased padding */
            margin-top: 1.5rem; /* Increased margin */
            border: 1px solid var(--border-light);
        }

        .pending-table-section h3 {
            color: var(--primary-dark);
            font-size: 1.5rem; /* Increased font size */
            margin-bottom: 1rem; /* Increased margin */
            padding-bottom: 0.6rem; /* Increased padding */
            border-bottom: 1px solid var(--border-light);
            font-weight: 700;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Add cursor pointer to the whole header */
        }

        /* Styles for freezing modal table headers */
        .modal .summary-table {
            table-layout: fixed; /* Added to ensure consistent column widths */
            width: 100%; /* Ensure it takes full width when fixed */
            height: auto;
            max-height: calc(90vh - 180px); /* Adjusted max-height for modals */
            overflow-y: auto; /* Keep scrolling for the whole table */
            border: none;
        }

        .modal .summary-table thead {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: #E0E0E0;
            border-bottom: 1px solid #999;
        }

        .modal .summary-table th {
            padding: 0.8rem 1rem; /* Increased padding */
            border: 1px solid #CCC;
            white-space: nowrap;
            overflow: hidden; /* Hide overflow content */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        .modal .summary-table tbody tr td {
            border: 1px solid #CCC;
            overflow: hidden; /* Hide overflow content */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        /* Ensure column widths are consistent - adjusted for 4 columns */
        .modal .summary-table th:nth-child(1),
        .modal .summary-table td:nth-child(1) {
            width: 40%; /* Name of Scheme */
        }
        .modal .summary-table th:nth-child(2),
        .modal .summary-table td:nth-child(2) {
            width: 20%; /* Division */
        }
        .modal .summary-table th:nth-child(3),
        .modal .summary-table td:nth-child(3) {
            width: 20%; /* TAA No. */
        }
        .modal .summary-table th:nth-child(4),
        .modal .summary-table td:nth-child(4) {
            width: 20%; /* Work Status */
        }

        /* Collapsible content styles */
        .toggle-icon {
            cursor: pointer;
            margin-left: 0.6rem; /* Increased margin */
            transition: transform 0.3s ease;
            font-size: 1.3rem; /* Increased font size */
            vertical-align: middle;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 500px; /* Max height when expanded, adjust as needed */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }
        /* Style for the new checkbox filter */
        .filter-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            background-color: var(--background-paper);
            border: 1px solid var(--border-light);
            font-size: 1rem;
            color: var(--text-medium);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-checkbox-item:hover {
            background-color: #EAEAEA;
            color: var(--text-dark);
        }

        .filter-checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
            cursor: pointer;
            width: 1.1em; /* Slightly larger checkbox */
            height: 1.1em; /* Slightly larger checkbox */
            accent-color: var(--primary-color); /* Style the checkbox itself */
        }

        .filter-checkbox-item label {
            cursor: pointer;
            font-size: 1rem; /* Match tab font size */
            color: var(--text-medium); /* Match tab text color */
        }

        /* Style when checkbox is checked */
        .filter-checkbox-item.checked {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        .filter-checkbox-item.checked label {
            color: white;
        }

    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <h1>
            <i class="material-icons">dashboard</i>
            Priority System Improvement Works
            <a class="update-link" href="https://docs.google.com/spreadsheets/d/1jnUUwjShjd64fLGoQ46B_dWbyJOt8qwSIoxLU4U6kps/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
                <i class="material-icons update-icon">edit_note</i>
            </a>
        </h1>
    </div>
</div>

<div class="container">
    <div class="tab-group" id="phaseTabs">
        <span class="tab" data-filter-value="all">All Phases</span>
        <span class="tab active" data-filter-value="Phase-I">Phase-I</span>
        <span class="tab" data-filter-value="Phase-II">Phase-II</span>
        
        <div class="filter-checkbox-item" id="rdssHvdsFilterContainer">
            <input type="checkbox" id="rdssHvdsCheckbox">
            <label for="rdssHvdsCheckbox">RDSS/HVDS</label>
        </div>
    </div>

    <div class="filter-group">
        <div class="filter-item">
            <label for="regionFilter">Region:</label>
            <select id="regionFilter">
                <option value="all">All Regions</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="divisionFilter">Division:</label>
            <select id="divisionFilter">
                <option value="all">All Divisions</option>
            </select>
        </div>
    </div>

    <div class="summary-cards">
        <div class="summary-card" data-card-type="total">
            <span class="number" id="totalSchemes">0</span>
            <span class="label">Total Schemes</span>
        </div>
        <div class="summary-card" data-card-type="completed">
            <span class="number" id="completedSchemes">0</span>
            <span class="label">Completed Schemes</span>
        </div>
        <div class="summary-card" data-card-type="taaIssued">
            <span class="number" id="taaIssued">0</span>
            <span class="label">TAA Issued</span>
        </div>
        <div class="summary-card" data-card-type="taaPending">
            <span class="number" id="taaPending">0</span>
            <span class="label">TAA Pending</span>
        </div>
        <div class="summary-card" data-card-type="completedButTAAPending">
            <span class="number" id="completedButTAAPending">0</span>
            <span class="label">Completed but TAA Pending</span>
        </div>
    </div>

    <div id="pendingSchemesTableSection" class="summary-table-section">
        <h3 id="pendingSchemesHeader">
            Pending with (Offices)
            <span id="togglePendingSchemes" class="toggle-icon material-icons collapsed">expand_more</span>
        </h3>
        <div id="pendingSchemesContent" class="collapsible-content collapsed">
            <table class="summary-table" id="pendingSchemesTable">
                <thead>
                    <tr>
                        <th>Office</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody id="pendingSchemesTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="main-content">
<div id="loadingOverlay">
    <div class="loader-content">
        <i class="material-icons spinning">cached</i>
        <p id="loadingText">Please wait...</p>
    </div>
</div>


    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="schemeHeadSummarySection" class="summary-table-section">
        <h3>Scheme Head-wise</h3>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Scheme Head</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                </tr>
            </thead>
            <tbody id="schemeHeadSummaryTableBody"></tbody>
        </table>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalSchemeName">Scheme Details</h2>
        <div class="modal-details" id="modalDetailsContent"></div>
    </div>
</div>

<div id="regionBreakupModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="regionBreakupModalTitle">Region-wise Break-up</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Region</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                    <th>TAA Pending</th>
                </tr>
            </thead>
            <tbody id="regionBreakupTableBody"></tbody>
        </table>
    </div>
</div>

<div id="divisionBreakupModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="divisionBreakupModalTitle">Division-wise Break-up</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Division</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                    <th>TAA Pending</th>
                </tr>
            </thead>
            <tbody id="divisionBreakupTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Global variables
    let allSchemeData = [];
    // CSV URL for the data - Changed to a more direct export format
    const csvUrl = 'https://docs.google.com/spreadsheets/d/1jnUUwjShjd64fLGoQ46B_dWbyJOt8qwSIoxLU4U6kps/export?format=tsv&gid=1269181093';

    // Current active filters
    let currentPhaseFilter = 'Phase-I';
    let currentRegionFilter = 'all'; // New filter state
    let currentDivisionFilter = 'all'; // New filter state
    let currentRdssHvdsFilter = false; // New filter state for RDSS/HVDS

    // Global variable to store the actual header name for 'Target Date'
    let actualTargetDateColumnName = 'Target Date'; // Default fallback, will be updated during parsing

    // DOM elements
    const elements = {
        phaseTabs: document.getElementById('phaseTabs'),
        regionFilter: document.getElementById('regionFilter'), // New filter element
        divisionFilter: document.getElementById('divisionFilter'), // New filter element
        rdssHvdsCheckbox: document.getElementById('rdssHvdsCheckbox'), // New checkbox element
        rdssHvdsFilterContainer: document.getElementById('rdssHvdsFilterContainer'), // Container for styling
        totalSchemes: document.getElementById('totalSchemes'),
        completedSchemes: document.getElementById('completedSchemes'),
        taaIssued: document.getElementById('taaIssued'),
        taaPending: document.getElementById('taaPending'), // New element for TAA Pending card
        completedButTAAPending: document.getElementById('completedButTAAPending'), // New element for Completed but TAA Pending card
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingText: document.getElementById('loadingText'),
        errorMessage: document.getElementById('errorMessage'),
        schemeHeadSummaryTableBody: document.getElementById('schemeHeadSummaryTableBody'),
        pendingSchemesTableBody: document.getElementById('pendingSchemesTableBody'), // New element for pending schemes table
        pendingSchemesHeader: document.getElementById('pendingSchemesHeader'), // Added for the entire header click
        togglePendingSchemes: document.getElementById('togglePendingSchemes'), // Toggle icon for pending schemes
        pendingSchemesContent: document.getElementById('pendingSchemesContent'), // Collapsible content for pending schemes
        detailModal: document.getElementById('detailModal'),
        modalSchemeName: document.getElementById('modalSchemeName'),
        modalDetailsContent: document.getElementById('modalDetailsContent'),
        regionBreakupModal: document.getElementById('regionBreakupModal'),
        regionBreakupModalTitle: document.getElementById('regionBreakupModalTitle'), 
        regionBreakupTableBody: document.getElementById('regionBreakupTableBody'),
        divisionBreakupModal: document.getElementById('divisionBreakupModal'),
        divisionBreakupModalTitle: document.getElementById('divisionBreakupModalTitle'),
        divisionBreakupTableBody: document.getElementById('divisionBreakupTableBody'),
        summaryCardsContainer: document.querySelector('.summary-cards') 
    };

    // Parse TSV data with proper handling of quoted fields and commas
    function parseTSV(tsvText) {
        const lines = tsvText.trim().split('\n');
        const rawHeaders = lines[0].split('\t');
        // Trim headers to remove any leading/trailing whitespace
        const headers = rawHeaders.map(h => h.trim());
        console.log('Parsed Headers (trimmed):', headers); // Log the trimmed headers

        // Identify the correct 'Target Date' header and store it globally
        const foundTargetDateHeader = headers.find(h => h.toLowerCase().includes('target date'));
        if (foundTargetDateHeader) {
            actualTargetDateColumnName = foundTargetDateHeader;
            console.log(`Identified 'Target Date' column as: "${actualTargetDateColumnName}"`);
        } else {
            console.warn("Warning: 'Target Date' column not found or has an unexpected name. Using fallback 'Target Date'. Please check your spreadsheet headers for exact match.");
            actualTargetDateColumnName = 'Target Date'; // Fallback to the hardcoded name if not found
        }

        return lines.slice(1).map(line => {
            const values = line.split('\t');
            const row = {};
            headers.forEach((header, index) => {
                row[header] = sanitizeTSVValue(values[index] || '');
            });
            return row;
        })
        .filter(row => {
            const name = row['Name of Scheme'];
            return name && name.trim() !== '';
        });
    }

    // Sanitize TSV values by removing carriage returns and trimming whitespace
    function sanitizeTSVValue(value) {
        return value.replace(/\r/g, '').trim();
    }

    // Dynamic loading messages
    const loadingMessages = [
        "Loading data... Initializing",
        "Loading data... Fetching records",
        "Loading data... Processing entries",
        "Loading data... Analyzing regions",
        "Loading data... Preparing dashboard",
        "Loading data... Almost there!",
        "Loading data... Buniadpur",
        "Loading data... Gazole",
        "Loading data... Habibpur",
        "Loading data... Kaliachak-I",
        "Loading data... Kaliachak-II",
        "Loading data... Manikchak",
        "Loading data... Old Malda",
        "Loading data... Ratua-I",
        "Loading data... Ratua-II"
    ];
    let messageIndex = 0;
    let loadingInterval;
    let loadingStartTime; 
    const minimumLoadingDisplayTime = 2000; 

    function startLoadingAnimation() {
        elements.loadingOverlay.style.display = 'flex';
        messageIndex = 0;
        elements.loadingText.textContent = loadingMessages[messageIndex];
        loadingStartTime = Date.now(); 

        loadingInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            elements.loadingText.textContent = loadingMessages[messageIndex];
        }, 1500); 
    }

    async function stopLoadingAnimation() {
        clearInterval(loadingInterval);
        const elapsedTime = Date.now() - loadingStartTime;
        if (elapsedTime < minimumLoadingDisplayTime) {
            await new Promise(resolve => setTimeout(resolve, minimumLoadingDisplayTime - elapsedTime));
        }
        elements.loadingOverlay.style.display = 'none';
    }

    // Helper function to determine if a scheme is completed based on 'Target Date'
    function isSchemeCompleted(scheme) {
        // Use the dynamically identified column name
        const targetDate = scheme[actualTargetDateColumnName];
        // Ensure targetDate is a string before calling toLowerCase() and includes()
        const isCompleted = targetDate && typeof targetDate === 'string' && targetDate.toLowerCase().includes('completed');
        console.log(`Debug - Scheme: "${scheme['Name of Scheme']}", Target Date raw (from key "${actualTargetDateColumnName}"): "${targetDate}", Is Completed: ${isCompleted}`);
        return isCompleted;
    }

    // Fetch and load data from the TSV URL
    async function loadData() {
        try {
            startLoadingAnimation(); 
            elements.errorMessage.style.display = 'none';
            
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const csvText = await response.text();
            allSchemeData = parseTSV(csvText);
            
            await stopLoadingAnimation(); 
            
            if (allSchemeData.length === 0) {
                throw new Error('No data found in the CSV file');
            }
            
            console.log('Data loaded successfully:', allSchemeData.length, 'records');
            console.log('Sample record (first one):', allSchemeData[0]);
            
            // Log a sample of Scheme Name and the dynamically accessed Target Date for verification
            console.log('\n--- Sample Scheme Completion Status (first 10 records) ---');
            allSchemeData.slice(0, 10).forEach((d, i) => {
                console.log(`Record ${i+1}: Name: "${d['Name of Scheme']}", Target Date: "${d[actualTargetDateColumnName]}", Is Completed (via helper): ${isSchemeCompleted(d)}`);
            });
            console.log('----------------------------------------------------------\n');

            initializeDashboard();
            
        } catch (error) {
            console.error('Error loading data:', error);
            await stopLoadingAnimation(); 
            elements.errorMessage.textContent = `Failed to load data: ${error.message}`;
            elements.errorMessage.style.display = 'block';
        }
    }

    // Get filtered data based on all current filters (Phase, Region, Division, RDSS/HVDS)
    function getFilteredData() {
        let filtered = [...allSchemeData];
        
        if (currentPhaseFilter !== 'all') {
            filtered = filtered.filter(d => d.Priority === currentPhaseFilter);
        }

        if (currentRegionFilter !== 'all') {
            filtered = filtered.filter(d => d.Region === currentRegionFilter);
        }

        if (currentDivisionFilter !== 'all') {
            filtered = filtered.filter(d => d.Division === currentDivisionFilter);
        }

        if (currentRdssHvdsFilter) {
            filtered = filtered.filter(d => 
                d['TAA No.'] && 
                (d['TAA No.'].toLowerCase().includes('rdss') || 
                 d['TAA No.'].toLowerCase().includes('hvds'))
            );
        }
        
        return filtered;
    }

    // Populate Region filter dropdown
    function populateRegionFilter() {
        const dataForRegions = allSchemeData.filter(d => 
            (currentPhaseFilter === 'all' || d.Priority === currentPhaseFilter) &&
            (!currentRdssHvdsFilter || (d['TAA No.'] && (d['TAA No.'].toLowerCase().includes('rdss') || d['TAA No.'].toLowerCase().includes('hvds'))))
        );
        const regions = [...new Set(dataForRegions.map(d => d.Region).filter(Boolean))].sort();
        
        elements.regionFilter.innerHTML = '<option value="all">All Regions</option>';
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            elements.regionFilter.appendChild(option);
        });
        elements.regionFilter.value = currentRegionFilter; // Set selected value
        populateDivisionFilter(currentRegionFilter); // Update divisions based on current region
    }

    // Populate Division filter dropdown based on selected region
    function populateDivisionFilter(selectedRegion) {
        const dataForDivisions = allSchemeData.filter(d => 
            (currentPhaseFilter === 'all' || d.Priority === currentPhaseFilter) &&
            (selectedRegion === 'all' || d.Region === selectedRegion) &&
            (!currentRdssHvdsFilter || (d['TAA No.'] && (d['TAA No.'].toLowerCase().includes('rdss') || d['TAA No.'].toLowerCase().includes('hvds'))))
        );
        const divisions = [...new Set(dataForDivisions.map(d => d.Division).filter(Boolean))].sort();
        
        elements.divisionFilter.innerHTML = '<option value="all">All Divisions</option>';
        divisions.forEach(division => {
            const option = document.createElement('option');
            option.value = division;
            option.textContent = division;
            elements.divisionFilter.appendChild(option);
        });
        elements.divisionFilter.value = currentDivisionFilter; // Set selected value
    }

    // Update summary scorecards and pending schemes table
    function updateSummary(data) {
        const completedCount = data.filter(isSchemeCompleted).length;
        const taaIssuedCount = data.filter(d => 
            d['TAA No.'] && d['TAA No.'].trim() !== '' && !d['TAA No.'].toLowerCase().includes('not issued')
        ).length;
        const taaPendingCount = data.filter(d => 
            !d['TAA No.'] || d['TAA No.'].trim() === '' || d['TAA No.'].toLowerCase().includes('not issued')
        ).length;

        const completedButTAAPendingCount = data.filter(d => 
            isSchemeCompleted(d) && (!d['TAA No.'] || d['TAA No.'].trim() === '' || d['TAA No.'].toLowerCase().includes('not issued'))
        ).length;


        elements.totalSchemes.textContent = data.length;
        // Apply colors
        elements.completedSchemes.textContent = completedCount;
        elements.completedSchemes.classList.toggle('text-green', completedCount > 0);
        elements.completedSchemes.classList.toggle('text-dark', completedCount === 0); // Keep default if 0

        elements.taaIssued.textContent = taaIssuedCount;
        elements.taaIssued.classList.toggle('text-green', taaIssuedCount > 0);
        elements.taaIssued.classList.toggle('text-dark', taaIssuedCount === 0);

        elements.taaPending.textContent = taaPendingCount;
        elements.taaPending.classList.toggle('text-red', taaPendingCount > 0);
        elements.taaPending.classList.toggle('text-dark', taaPendingCount === 0);

        elements.completedButTAAPending.textContent = completedButTAAPendingCount;
        elements.completedButTAAPending.classList.toggle('text-red', completedButTAAPendingCount > 0);
        elements.completedButTAAPending.classList.toggle('text-dark', completedButTAAPendingCount === 0);

        // Populate Pending Schemes Table
        const pendingCategories = {
            'Division': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('division')).length,
            'Region': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('region')).length,
            'Zone': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('zone')).length,
            'CE-Office': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('ce(dist.)-north')).length,
            'P&E': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('p&e')).length,
            'DHQ': data.filter(d => d['Presently with'] && d['Presently with'].toLowerCase().includes('ed-dist')).length
        };

        let pendingTableHtml = '';
        for (const category in pendingCategories) {
            if (pendingCategories.hasOwnProperty(category)) {
                // Ensure the data-card-type attribute matches the exact keys expected by the switch statement.
                // The category.replace(/[^a-zA-Z0-9]/g, '') effectively creates a 'cleaned' version of the category name.
                const cleanCategoryName = category.replace(/[^a-zA-Z0-9]/g, '');
                pendingTableHtml += `
                    <tr data-card-type="pending${cleanCategoryName}">
                        <td>${category}</td>
                        <td>${pendingCategories[category]}</td>
                    </tr>
                `;
            }
            }
        elements.pendingSchemesTableBody.innerHTML = pendingTableHtml;
    }

    // Render the Scheme Head-wise summary table
    function renderSchemeHeadSummaryTable(data) {
        const schemeHeadSummary = data.reduce((acc, scheme) => {
            const schemeHead = scheme['Scheme Head'] || 'N/A';
            if (!acc[schemeHead]) {
                acc[schemeHead] = { total: 0, completed: 0 };
            }
            acc[schemeHead].total++;
            // Updated logic for completed schemes based on "Target Date" using helper function
            if (isSchemeCompleted(scheme)) {
                acc[schemeHead].completed++;
            }
            return acc;
        }, {});

        let tableHtml = '';
        Object.keys(schemeHeadSummary).sort().forEach(head => {
            const summary = schemeHeadSummary[head];
            tableHtml += `
                <tr data-scheme-head="${head}">
                    <td>${head}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                </tr>
            `;
        });
        elements.schemeHeadSummaryTableBody.innerHTML = tableHtml;

        elements.schemeHeadSummaryTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const schemeHead = row.dataset.schemeHead;
                showRegionBreakupModal(schemeHead);
            });
        });
    }

    // Show the Region-wise break-up modal
    function showRegionBreakupModal(schemeHead) {
        const dataForSchemeHead = getFilteredData().filter(d => d['Scheme Head'] === schemeHead);

        const regionSummary = dataForSchemeHead.reduce((acc, scheme) => {
            const region = scheme.Region || 'N/A';
            if (!acc[region]) {
                acc[region] = { total: 0, completed: 0, taaPending: 0 };
            }
            acc[region].total++;
            // Updated logic for completed schemes based on "Target Date" using helper function
            if (isSchemeCompleted(scheme)) {
                acc[region].completed++;
            }
            if (!scheme['TAA No.'] || scheme['TAA No.'].trim() === '' || scheme['TAA No.'].toLowerCase().includes('not issued')) {
                acc[region].taaPending++;
            }
            return acc;
        }, {});

        elements.regionBreakupModalTitle.textContent = `Region-wise Break-up for "${schemeHead}"`;
        let tableHtml = '';
        Object.keys(regionSummary).sort().forEach(region => {
            const summary = regionSummary[region];
            tableHtml += `
                <tr data-scheme-head="${schemeHead}" data-region="${region}">
                    <td>${region}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                    <td>${summary.taaPending}</td>
                </tr>
            `;
        });
        elements.regionBreakupTableBody.innerHTML = tableHtml;

        elements.regionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const clickedSchemeHead = row.dataset.schemeHead;
                const region = row.dataset.region;
                showDivisionBreakupModal(clickedSchemeHead, region);
            });
        });

        elements.regionBreakupModal.classList.add('show');
    }

    // Show the Division-wise break-up modal
    function showDivisionBreakupModal(schemeHead, region) {
        const dataForRegion = getFilteredData().filter(d => 
            d['Scheme Head'] === schemeHead && d.Region === region
        );

        const divisionSummary = dataForRegion.reduce((acc, scheme) => {
            const division = scheme.Division || 'N/A';
            if (!acc[division]) {
                acc[division] = { total: 0, completed: 0, taaPending: 0 };
            }
            acc[division].total++;
            // Updated logic for completed schemes based on "Target Date" using helper function
            if (isSchemeCompleted(scheme)) {
                acc[division].completed++;
            }
            if (!scheme['TAA No.'] || scheme['TAA No.'].trim() === '' || scheme['TAA No.'].toLowerCase().includes('not issued')) {
                acc[division].taaPending++;
            }
            return acc;
        }, {});

        elements.divisionBreakupModalTitle.textContent = `Division-wise Break-up for "${schemeHead}" in "${region}"`;
        let tableHtml = '';
        Object.keys(divisionSummary).sort().forEach(division => {
            const summary = divisionSummary[division];
            tableHtml += `
                <tr data-scheme-head="${schemeHead}" data-region="${region}" data-division="${division}">
                    <td>${division}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                    <td>${summary.taaPending}</td>
                </tr>
            `;
        });
        elements.divisionBreakupTableBody.innerHTML = tableHtml;

        elements.divisionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const clickedSchemeHead = row.dataset.schemeHead;
                const clickedRegion = row.dataset.region;
                const clickedDivision = row.dataset.division;
                
                const schemesInDivision = allSchemeData.filter(s => 
                    s['Scheme Head'] === clickedSchemeHead && 
                    s.Region === clickedRegion && 
                    s.Division === clickedDivision
                );
                
                if (schemesInDivision.length === 1) {
                    showSchemeDetails(schemesInDivision[0]);
                } else {
                    showSchemeListInModal(schemesInDivision, `Schemes in ${clickedDivision} (${clickedSchemeHead}, ${clickedRegion})`);
                }
            });
        });

        elements.divisionBreakupModal.classList.add('show');
    }

    // Function to show a list of schemes in a modal (reusing the structure of regionBreakupModal for simplicity)
    function showSchemeListInModal(schemes, title) {
        elements.regionBreakupModalTitle.textContent = title;
        
        // Update table headers for the new columns
        let columnsToShow = ['Name of Scheme', 'Division', 'TAA No.'];
        if (title.includes('Completed Schemes')) { // Check if it's the completed schemes modal
            columnsToShow.push(actualTargetDateColumnName); // Use the dynamically identified Target Date column
        } else {
            columnsToShow.push('Work Status'); // Otherwise, use Work Status
        }

        elements.regionBreakupModal.querySelector('thead tr').innerHTML = columnsToShow.map(col => `<th>${col}</th>`).join('');

        let listHtml = '';
        if (schemes.length === 0) {
            listHtml = `<tr><td colspan="${columnsToShow.length}" style="text-align: center; color: var(--text-medium); padding: 1rem;">No schemes found.</td></tr>`;
        } else {
            listHtml = schemes.map(scheme => {
                // Safely get and trim TAA No., then check for "Not issued"
                const taaNoRaw = scheme['TAA No.'];
                const taaNoValue = typeof taaNoRaw === 'string' ? taaNoRaw.trim() : '';
                const isNotIssued = taaNoValue.toLowerCase().includes('not issued');
                const taaNoDisplay = (taaNoValue !== '' && !isNotIssued) ? 
                                     taaNoValue : 
                                     `<span style="color: var(--red-color);">Not issued</span>`;
                
                // Determine which column to display based on the modal title and dynamically identified column name
                const dynamicColumnValue = title.includes('Completed Schemes') ? 
                                               (scheme[actualTargetDateColumnName] || '-') : 
                                               (scheme['Work Status'] || '-');

                return `
                    <tr data-scheme-name="${scheme['Name of Scheme']}">
                        <td>${scheme['Name of Scheme'] || '-'}</td>
                        <td>${scheme['Division'] || '-'}</td>
                        <td>${taaNoDisplay}</td>
                        <td>${dynamicColumnValue}</td>
                    </tr>
                `;
            }).join('');
        }
        elements.regionBreakupTableBody.innerHTML = listHtml;

        elements.regionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const schemeName = row.dataset.schemeName;
                const scheme = allSchemeData.find(s => s['Name of Scheme'] === schemeName);
                if (scheme) {
                    showSchemeDetails(scheme);
                }
            });
        });

        elements.regionBreakupModal.classList.add('show');
        elements.divisionBreakupModal.classList.remove('show');
    }


    // Show individual scheme details in the detail modal
    function showSchemeDetails(scheme) {
        elements.modalSchemeName.textContent = scheme['Name of Scheme'] || 'Scheme Details';
        
        const detailsHtml = Object.entries(scheme).map(([key, value]) => {
            const displayValue = value && typeof value === 'string' && value.trim() !== '' ? value : '----'; // Ensure value is string before trim
            return `
                <div class="detail-row">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${displayValue}</div>
                </div>
            `;
        }).join('');
        
        elements.modalDetailsContent.innerHTML = detailsHtml;
        elements.detailModal.classList.add('show');
        elements.regionBreakupModal.classList.remove('show');
        elements.divisionBreakupModal.classList.remove('show');
    }

    // Update dashboard with filtered data
    function updateDashboard() {
        const filteredData = getFilteredData();
        updateSummary(filteredData);
        renderSchemeHeadSummaryTable(filteredData);
        populateRegionFilter();
    }

    // Initialize dashboard: set up event listeners and initial data display
    function initializeDashboard() {
        elements.phaseTabs.addEventListener('click', (event) => {
            if (event.target.classList.contains('tab')) {
                Array.from(elements.phaseTabs.children).forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                currentPhaseFilter = event.target.dataset.filterValue;
                currentRegionFilter = 'all'; // Reset region filter
                currentDivisionFilter = 'all'; // Reset division filter
                elements.regionFilter.value = 'all'; // Reset dropdown
                elements.divisionFilter.value = 'all'; // Reset dropdown
                updateDashboard(); 
            }
        });

        // Event listener for the new RDSS/HVDS checkbox
        elements.rdssHvdsCheckbox.addEventListener('change', (event) => {
            currentRdssHvdsFilter = event.target.checked;
            if (currentRdssHvdsFilter) {
                elements.rdssHvdsFilterContainer.classList.add('checked');
            } else {
                elements.rdssHvdsFilterContainer.classList.remove('checked');
            }
            currentRegionFilter = 'all'; // Reset region filter
            currentDivisionFilter = 'all'; // Reset division filter
            elements.regionFilter.value = 'all'; // Reset dropdown
            elements.divisionFilter.value = 'all'; // Reset dropdown
            updateDashboard();
        });

        elements.regionFilter.addEventListener('change', (event) => {
            currentRegionFilter = event.target.value;
            currentDivisionFilter = 'all';
            populateDivisionFilter(currentRegionFilter);
            updateDashboard();
        });

        elements.divisionFilter.addEventListener('change', (event) => {
            currentDivisionFilter = event.target.value;
            updateDashboard();
        });

        // Event listener for summary cards (non-pending)
        elements.summaryCardsContainer.querySelectorAll('.summary-card').forEach(card => {
            card.addEventListener('click', (event) => {
                const cardType = event.currentTarget.dataset.cardType;
                let filteredSchemes = getFilteredData();
                let modalTitle = '';

                switch (cardType) {
                    case 'total':
                        modalTitle = 'All Schemes';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'completed':
                        // Updated filter logic for completed schemes based on "Target Date"
                        filteredSchemes = filteredSchemes.filter(isSchemeCompleted);
                        modalTitle = 'Completed Schemes';
                        showSchemeListInModal(filteredSchemes, modalTitle); // This will now show "Target Date" column
                        break;

                    case 'taaIssued':
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['TAA No.'] && typeof d['TAA No.'] === 'string' && d['TAA No.'].trim() !== '' && !d['TAA No.'].toLowerCase().includes('not issued')
                        );
                        modalTitle = 'TAA Issued Schemes';
                        showCustomTableModal(filteredSchemes, modalTitle, ['Name of Scheme', 'Division', 'TAA No.', 'Work Status']); 
                        break;

                    case 'taaPending':
                        filteredSchemes = filteredSchemes.filter(d => 
                            !d['TAA No.'] || d['TAA No.'].trim() === '' || d['TAA No.'].toLowerCase().includes('not issued')
                        );
                        modalTitle = 'TAA Pending Schemes';
                        showCustomTableModal(filteredSchemes, modalTitle, ['Name of Scheme', 'Division', 'TAA No.', 'Work Status']);
                        break;

                    case 'completedButTAAPending':
                        filteredSchemes = filteredSchemes.filter(d => 
                            isSchemeCompleted(d) && (!d['TAA No.'] || d['TAA No.'].trim() === '' || d['TAA No.'].toLowerCase().includes('not issued'))
                        );
                        modalTitle = 'Completed but TAA Pending Schemes';
                        showCustomTableModal(filteredSchemes, modalTitle, ['Name of Scheme', 'Division', 'TAA No.', 'Work Status']);
                        break;
                }
            });
        });

        // Event listener for pending schemes table rows
        elements.pendingSchemesTableBody.addEventListener('click', (event) => {
            const targetRow = event.target.closest('tr');
            if (targetRow) {
                const cardType = targetRow.dataset.cardType;
                let filteredSchemes = getFilteredData();
                let modalTitle = '';

                switch (cardType) {
                    case 'pendingDivision':
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('division')
                        );
                        modalTitle = 'Schemes Pending at Division';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'pendingRegion':
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('region')
                        );
                        modalTitle = 'Schemes Pending at Region';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'pendingZone':
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('zone')
                        );
                        modalTitle = 'Schemes Pending at Zone';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'pendingCEOffice': // Corrected case
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('ce(dist.)-north')
                        );
                        modalTitle = 'Schemes Pending at CE-Office';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'pendingPE': // Corrected case
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('p&e')
                        );
                        modalTitle = 'Schemes Pending at P&E';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;

                    case 'pendingDHQ': // Corrected case
                        filteredSchemes = filteredSchemes.filter(d => 
                            d['Presently with'] && d['Presently with'].toLowerCase().includes('ed-dist')
                        );
                        modalTitle = 'Schemes Pending at DHQ';
                        showSchemeListInModal(filteredSchemes, modalTitle);
                        break;
                }
            }
        });


        // Toggle functionality for Pending Schemes table - now on the entire h3 header
        elements.pendingSchemesHeader.addEventListener('click', () => {
            elements.pendingSchemesContent.classList.toggle('collapsed');
            elements.togglePendingSchemes.classList.toggle('collapsed');
            // Change icon based on state
            if (elements.pendingSchemesContent.classList.contains('collapsed')) {
                elements.togglePendingSchemes.textContent = 'expand_more';
            } else {
                elements.togglePendingSchemes.textContent = 'expand_less';
            }
        });

        updateDashboard();
    }

    document.querySelectorAll('.modal .close-button').forEach(button => {
        button.addEventListener('click', (event) => {
            event.target.closest('.modal').classList.remove('show');
            // Reset header for regionBreakupModal based on its original purpose
            if (event.target.closest('.modal').id === 'regionBreakupModal') {
                elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
                    <th>Region</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                    <th>TAA Pending</th>
                `;
            }
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target === elements.detailModal) {
            elements.detailModal.classList.remove('show');
        }
        if (event.target === elements.regionBreakupModal) {
            elements.regionBreakupModal.classList.remove('show');
            // Reset header for regionBreakupModal based on its original purpose
            elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
                <th>Region</th>
                <th>Total Schemes</th>
                <th>Completed</th>
                <th>TAA Pending</th>
            `;
        }
        if (event.target === elements.divisionBreakupModal) {
            elements.divisionBreakupModal.classList.remove('show');
        }
    });

    const styleSheet = document.createElement('style');
    styleSheet.type = 'text/css';
    styleSheet.innerText = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(styleSheet);

    window.onload = loadData;

    // Modified showCustomTableModal to handle TAA No. styling and new columns
    function showCustomTableModal(data, title, columns) {
        elements.regionBreakupModalTitle.textContent = title;

        // Set table headers
        elements.regionBreakupModal.querySelector('thead tr').innerHTML = columns.map(col => `<th>${col}</th>`).join('');

        // Generate rows
        let listHtml = '';
        if (data.length === 0) {
            listHtml = `<tr><td colspan="${columns.length}" style="text-align: center; color: var(--text-medium); padding: 1rem;">No data found.</td></tr>`;
        } else {
            listHtml = data.map((row, index) => {
                const rowHtml = columns.map(col => {
                    let displayValue = row[col] || '-';
                    if (col === 'TAA No.') {
                        const taaNoRaw = row[col];
                        const taaNoValue = typeof taaNoRaw === 'string' ? taaNoRaw.trim() : '';
                        const isNotIssued = taaNoValue.toLowerCase().includes('not issued');
                        // Apply red color to "Not issued" TAA numbers
                        displayValue = (taaNoValue !== '' && !isNotIssued) ? 
                                       taaNoValue : 
                                       `<span style="color: var(--red-color);">Not issued</span>`;
                    }
                    return `<td>${displayValue}</td>`;
                }).join('');
                return `<tr data-scheme-name="${row['Name of Scheme'] || ''}">${rowHtml}</tr>`;
            }).join('');
        }

        elements.regionBreakupTableBody.innerHTML = listHtml;

        // Add click event to each row to open scheme detail
        elements.regionBreakupTableBody.querySelectorAll('tr[data-scheme-name]').forEach(row => {
            row.addEventListener('click', () => {
                const schemeName = row.dataset.schemeName;
                const scheme = allSchemeData.find(s => s['Name of Scheme'] === schemeName);
                if (scheme) {
                    showSchemeDetails(scheme);
                }
            });
        });

        elements.regionBreakupModal.classList.add('show');
        elements.divisionBreakupModal.classList.remove('show');
        elements.detailModal.classList.remove('show');
    }
</script>
</body>
</html>
