<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheme Data Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300,400,500,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet">
    <style>
        /* Modern Minimal with Mountain Vibe */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4CAF50; /* Base Green */
            --primary-dark: #2E7D32; /* Darker Green (Forest) */
            --accent-color: #607D8B; /* Blue Grey (Stone/Sky) */
            --background-light: #F8F9FA; /* Off-white for base (Snow/Clouds) */
            --background-paper: #FFFFFF; /* Pure white elements */
            --text-dark: #212121; /* Dark charcoal */
            --text-medium: #616161; /* Medium grey */
            --border-light: #E0E0E0; /* Light grey for borders */
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Montserrat', 'Open Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background-color: var(--background-light);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background-color: var(--background-paper);
            padding: 0.8rem 0;
            box-shadow: 0 2px 10px var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        h1 {
            text-align: center;
            color: var(--primary-dark);
            font-size: 1.8rem; /* Made header font smaller */
            font-weight: 700;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: -0.03em;
        }

        h1 .material-icons {
            font-size: 2rem; /* Made header icon smaller */
            margin-right: 0.6rem;
            color: var(--primary-color);
        }

        /* Tab Styles - Clean and subtle */
        .tab-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background-color: rgba(76, 175, 80, 0.05);
            border-radius: 10px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.02);
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background-color: var(--background-paper);
            color: var(--text-medium);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
            text-align: center;
            border: 1px solid #E6EEF0;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .tab:hover {
            background-color: #F0F2F5;
            color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.07);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Filter Group for Region/Division */
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.8rem; /* Space between filters */
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background-color: rgba(96, 125, 139, 0.05); /* Light tint of accent color */
            border-radius: 10px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.02);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-item label {
            font-size: 0.85rem;
            color: var(--text-medium);
            font-weight: 500;
        }

        .filter-item select {
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background-color: var(--background-paper);
            font-size: 0.85rem;
            color: var(--text-dark);
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23616161%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.2-3.2-8.3-3.2-11.6%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.3%2C0%2C11.6l12.6%2C12.6c3.2%2C3.2%2C8.3%2C3.2%2C11.6%2C0l112-112l112%2C112c3.2%2C3.2%2C8.3%2C3.2%2C11.6%2C0l12.6-12.6C290.2%2C205.6%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.6rem top 50%;
            background-size: 0.65em auto;
            padding-right: 2rem; /* Make space for custom arrow */
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            min-width: 120px; /* Ensure a minimum width */
        }

        .filter-item select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        /* Summary Cards - Elevated and simple */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Adjusted min-width for more cards */
            gap: 0.8rem;
            margin: 0.8rem 0;
        }

        .summary-card {
            background-color: var(--background-paper);
            padding: 0.8rem; /* Made card padding smaller */
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px var(--shadow-light);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.1rem;
            cursor: pointer;
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-medium);
        }

        .summary-card .number {
            font-size: 1.6rem; /* Made card number font smaller */
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1;
        }

        .summary-card .label {
            font-size: 0.75rem; /* Made card label font smaller */
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.75px;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            background-color: var(--background-paper);
            margin: 1.2rem auto;
            border-radius: 10px;
            padding: 1.5rem;
            max-width: 1200px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .loading .material-icons {
            margin-bottom: 0.6rem;
            font-size: 2.2rem;
            color: var(--primary-color);
        }

        .error {
            text-align: center;
            padding: 1.5rem;
            color: #D32F2F;
            background-color: #FFEBEE;
            border-radius: 10px;
            margin: 1.2rem 0;
            border: 1px solid #EF9A9A;
            font-weight: 500;
        }

        /* Tabular Summaries */
        .summary-table-section {
            background-color: var(--background-paper);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--shadow-light);
            margin-top: 1.2rem;
        }

        .summary-table-section h3 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .summary-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0.8rem;
            font-size: 0.85rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .summary-table th, .summary-table td {
            border-bottom: 1px solid #EDEDED;
            padding: 0.7rem 0.8rem;
            text-align: left;
            word-break: normal; /* Do not break words unless absolutely necessary */
            overflow-wrap: break-word; /* Allow long words to break if they overflow */
        }

        .summary-table thead tr:first-child th:first-child {
            border-top-left-radius: 8px;
        }

        .summary-table thead tr:first-child th:last-child {
            border-top-right-radius: 8px;
        }

        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }

        .summary-table th {
            background-color: #F3F6F7;
            font-weight: 600;
            color: var(--text-medium);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.7px;
        }

        .summary-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .summary-table tbody tr:nth-child(even) {
            background-color: #FAFBFC;
        }

        .summary-table tbody tr:hover {
            background-color: #E6F7E6;
        }
        
        .summary-table tbody tr td:first-child {
            color: var(--primary-dark);
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--background-paper);
            padding: 1.5rem;
            border-radius: 10px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-medium);
            transition: color 0.2s ease;
        }

        .close-button:hover {
            color: var(--text-dark);
        }

        .modal h2 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .modal-details {
            display: grid;
            gap: 0.4rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1.3fr 2fr;
            gap: 0.6rem;
            padding: 0.5rem 0.6rem;
            background-color: #FDFDFD;
            border-radius: 6px;
            align-items: flex-start;
            border-bottom: 1px dashed #F5F5F5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-medium);
            font-size: 0.8rem;
        }

        .detail-value {
            color: var(--text-dark);
            white-space: normal; /* Allow normal wrapping */
            word-break: normal; /* Do not break words unless absolutely necessary */
            overflow-wrap: break-word; /* Allow long words to break if they overflow */
            font-size: 0.8rem;
        }

        h1 .update-link {
            display: inline-flex;
            align-items: center;
            margin-left: 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            background-color:  #D32F2F !important;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            text-decoration: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        h1 .update-link:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        h1 .update-link .update-icon {
            font-size: 1rem;
            margin-right: 0.3rem;
            color: #ffe609 !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
                gap: 0.6rem;
            }

            .summary-card {
                padding: 0.7rem;
            }

            .summary-card .number {
                font-size: 1.5rem;
            }

            .summary-card .label {
                font-size: 0.7rem;
            }

            .modal-content {
                width: 98%;
                margin: 2% auto;
                padding: 1rem;
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.4rem;
                padding: 0.4rem;
            }
            
            .summary-table th, .summary-table td {
                padding: 0.4rem 0.5rem;
                font-size: 0.75rem;
            }

            .tab-group {
                padding: 0.4rem;
                gap: 0.3rem;
            }

            .tab {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h1 .material-icons {
                font-size: 1.7rem;
            }

            .main-content {
                padding: 1rem;
            }

            .filter-group {
                flex-direction: column; /* Stack filters vertically on mobile */
                align-items: stretch;
                gap: 0.6rem;
            }

            .filter-item select {
                width: 100%; /* Full width on mobile */
                min-width: unset;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.6rem;
            }

            h1 {
                font-size: 1.3rem;
            }

            h1 .material-icons {
                font-size: 1.5rem;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .summary-card .number {
                font-size: 1.4rem;
            }

            .summary-card .label {
                font-size: 0.65rem;
            }

            .modal-content {
                padding: 0.8rem;
            }

            .summary-table th, .summary-table td {
                padding: 0.3rem 0.4rem;
                font-size: 0.65rem;
            }
        }
        #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loader-content {
    text-align: center;
    background: white;
    padding: 2rem 3rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    font-family: 'Montserrat', sans-serif;
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.loader-content .material-icons.spinning {
    font-size: 2.4rem;
    margin-bottom: 0.6rem;
    animation: spin 1.2s linear infinite;
    color: var(--primary-color);
}

    </style>
</head>
<body>
<!-- HEADER -->
<div class="header">
    <div class="container">
        <h1>
            <i class="material-icons">dashboard</i>
            Priority System Improvement Works
            <a class="update-link" href="https://docs.google.com/spreadsheets/d/1jnUUwjShjd64fLGoQ46B_dWbyJOt8qwSIoxLU4U6kps/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
                <i class="material-icons update-icon">edit_note</i>
            </a>
        </h1>
    </div>
</div>

<div class="container">
    <!-- Phase Tabs -->
    <div class="tab-group" id="phaseTabs">
        <span class="tab" data-filter-value="all">All Phases</span>
        <span class="tab active" data-filter-value="Phase-I">Phase-I</span>
        <span class="tab" data-filter-value="Phase-II">Phase-II</span>
    </div>

    <!-- Region and Division Filters -->
    <div class="filter-group">
        <div class="filter-item">
            <label for="regionFilter">Region:</label>
            <select id="regionFilter">
                <option value="all">All Regions</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="divisionFilter">Division:</label>
            <select id="divisionFilter">
                <option value="all">All Divisions</option>
            </select>
        </div>
    </div>

    <!-- Score Cards -->
    <div class="summary-cards">
        <div class="summary-card" data-card-type="total">
            <span class="number" id="totalSchemes">0</span>
            <span class="label">Total Schemes</span>
        </div>
        <div class="summary-card" data-card-type="completed">
            <span class="number" id="completedSchemes">0</span>
            <span class="label">Completed Schemes</span>
        </div>
        <div class="summary-card" data-card-type="taaIssued">
            <span class="number" id="taaIssued">0</span>
            <span class="label">TAA Issued</span>
        </div>
        <div class="summary-card" data-card-type="pendingDivision">
            <span class="number" id="pendingDivision">0</span>
            <span class="label">Pending at Division</span>
        </div>
        <div class="summary-card" data-card-type="pendingRegion">
            <span class="number" id="pendingRegion">0</span>
            <span class="label">Pending at Region</span>
        </div>
        <div class="summary-card" data-card-type="pendingZone">
            <span class="number" id="pendingZone">0</span>
            <span class="label">Pending at Zone</span>
        </div>
        <div class="summary-card" data-card-type="pendingCeOffice">
            <span class="number" id="pendingCeOffice">0</span>
            <span class="label">Pending at CE-Office</span>
        </div>
        <div class="summary-card" data-card-type="pendingPe">
            <span class="number" id="pendingPe">0</span>
            <span class="label">Pending at P&E</span>
        </div>
        <div class="summary-card" data-card-type="pendingDhq">
            <span class="number" id="pendingDhq">0</span>
            <span class="label">Pending at DHQ</span>
        </div>
    </div>
</div>

<div class="main-content">
<div id="loadingOverlay">
    <div class="loader-content">
        <i class="material-icons spinning">cached</i>
        <p>Please wait...</p>
    </div>
</div>


    <div id="errorMessage" class="error" style="display: none;"></div>

    <!-- Scheme Head-wise Summary Table -->
    <div id="schemeHeadSummarySection" class="summary-table-section">
        <h3>Scheme Head-wise Schemes</h3>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Scheme Head</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                </tr>
            </thead>
            <tbody id="schemeHeadSummaryTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modals -->
<!-- Detail Modal (for individual scheme details) -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalSchemeName">Scheme Details</h2>
        <div class="modal-details" id="modalDetailsContent"></div>
    </div>
</div>

<!-- Region Break-up Modal -->
<div id="regionBreakupModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="regionBreakupModalTitle">Region-wise Break-up</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Region</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                    <th>TAA Pending</th>
                </tr>
            </thead>
            <tbody id="regionBreakupTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Division Break-up Modal -->
<div id="divisionBreakupModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="divisionBreakupModalTitle">Division-wise Break-up</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Division</th>
                    <th>Total Schemes</th>
                    <th>Completed</th>
                    <th>TAA Pending</th>
                </tr>
            </thead>
            <tbody id="divisionBreakupTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Global variables
    let allSchemeData = [];
    // CSV URL for the data - Changed to a more direct export format
    const csvUrl = 'https://docs.google.com/spreadsheets/d/1jnUUwjShjd64fLGoQ46B_dWbyJOt8qwSIoxLU4U6kps/export?format=tsv&gid=1269181093';

    // Current active filters
    let currentPhaseFilter = 'Phase-I';
    let currentRegionFilter = 'all'; // New filter state
    let currentDivisionFilter = 'all'; // New filter state

    // DOM elements
    const elements = {
        phaseTabs: document.getElementById('phaseTabs'),
        regionFilter: document.getElementById('regionFilter'), // New filter element
        divisionFilter: document.getElementById('divisionFilter'), // New filter element
        totalSchemes: document.getElementById('totalSchemes'),
        completedSchemes: document.getElementById('completedSchemes'),
        taaIssued: document.getElementById('taaIssued'),
        pendingDivision: document.getElementById('pendingDivision'),
        pendingRegion: document.getElementById('pendingRegion'),
        pendingZone: document.getElementById('pendingZone'),
        pendingCeOffice: document.getElementById('pendingCeOffice'),
        pendingPe: document.getElementById('pendingPe'),
        pendingDhq: document.getElementById('pendingDhq'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        errorMessage: document.getElementById('errorMessage'),
        schemeHeadSummaryTableBody: document.getElementById('schemeHeadSummaryTableBody'),
        detailModal: document.getElementById('detailModal'),
        modalSchemeName: document.getElementById('modalSchemeName'),
        modalDetailsContent: document.getElementById('modalDetailsContent'),
        regionBreakupModal: document.getElementById('regionBreakupModal'),
        regionBreakupModalTitle: document.getElementById('regionBreakupModalTitle'),
        regionBreakupTableBody: document.getElementById('regionBreakupTableBody'),
        divisionBreakupModal: document.getElementById('divisionBreakupModal'),
        divisionBreakupModalTitle: document.getElementById('divisionBreakupModalTitle'),
        divisionBreakupTableBody: document.getElementById('divisionBreakupTableBody'),
        summaryCardsContainer: document.querySelector('.summary-cards')
    };

    // Parse TSV data with proper handling of quoted fields and commas
    function parseTSV(tsvText) {
        const lines = tsvText.trim().split('\n'); // Corrected typo: ttsvText to tsvText
        const headers = lines[0].split('\t');

        return lines.slice(1).map(line => {
            const values = line.split('\t');
            const row = {};
            headers.forEach((header, index) => {
                row[header] = sanitizeTSVValue(values[index] || '');
            });
            return row;
        })
        .filter(row => {
            const name = row['Name of Scheme'];
            return name && name.trim() !== '';
        });
    }

    // Sanitize TSV values by removing carriage returns and trimming whitespace
    function sanitizeTSVValue(value) {
        return value.replace(/\r/g, '').trim();
    }

    // Fetch and load data from the TSV URL
    async function loadData() {
        try {
document.getElementById('loadingOverlay').style.display = 'flex';
            elements.errorMessage.style.display = 'none';
            
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const csvText = await response.text();
            allSchemeData = parseTSV(csvText);
            
document.getElementById('loadingOverlay').style.display = 'none';
            
            if (allSchemeData.length === 0) {
                throw new Error('No data found in the CSV file');
            }
            
            console.log('Data loaded successfully:', allSchemeData.length, 'records');
            console.log('Sample record:', allSchemeData[0]);
            
            initializeDashboard();
            
        } catch (error) {
            console.error('Error loading data:', error);
            elements.loadingIndicator.style.display = 'none';
            elements.errorMessage.textContent = `Failed to load data: ${error.message}`;
            elements.errorMessage.style.display = 'block';
        }
    }

    // Get filtered data based on all current filters (Phase, Region, Division)
    function getFilteredData() {
        let filtered = [...allSchemeData];
        
        if (currentPhaseFilter !== 'all') {
            filtered = filtered.filter(d => d.Priority === currentPhaseFilter);
        }

        if (currentRegionFilter !== 'all') {
            filtered = filtered.filter(d => d.Region === currentRegionFilter);
        }

        if (currentDivisionFilter !== 'all') {
            filtered = filtered.filter(d => d.Division === currentDivisionFilter);
        }
        
        return filtered;
    }

    // Populate Region filter dropdown
    function populateRegionFilter() {
        const dataForRegions = allSchemeData.filter(d => 
            currentPhaseFilter === 'all' || d.Priority === currentPhaseFilter
        );
        const regions = [...new Set(dataForRegions.map(d => d.Region).filter(Boolean))].sort();
        
        elements.regionFilter.innerHTML = '<option value="all">All Regions</option>';
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            elements.regionFilter.appendChild(option);
        });
        elements.regionFilter.value = currentRegionFilter; // Set selected value
        populateDivisionFilter(currentRegionFilter); // Update divisions based on current region
    }

    // Populate Division filter dropdown based on selected region
    function populateDivisionFilter(selectedRegion) {
        const dataForDivisions = allSchemeData.filter(d => 
            (currentPhaseFilter === 'all' || d.Priority === currentPhaseFilter) &&
            (selectedRegion === 'all' || d.Region === selectedRegion)
        );
        const divisions = [...new Set(dataForDivisions.map(d => d.Division).filter(Boolean))].sort();
        
        elements.divisionFilter.innerHTML = '<option value="all">All Divisions</option>';
        divisions.forEach(division => {
            const option = document.createElement('option');
            option.value = division;
            option.textContent = division;
            elements.divisionFilter.appendChild(option);
        });
        elements.divisionFilter.value = currentDivisionFilter; // Set selected value
    }

    // Update summary scorecards
    function updateSummary(data) {
        elements.totalSchemes.textContent = data.length;
        elements.completedSchemes.textContent = data.filter(d => 
            d['Work Status'] && d['Work Status'].toLowerCase().includes('completed')
        ).length;
        elements.taaIssued.textContent = data.filter(d => 
            d['TAA No.'] && d['TAA No.'].trim() !== ''
        ).length;

        elements.pendingDivision.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('division')
        ).length;
        elements.pendingRegion.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('region')
        ).length;
        elements.pendingZone.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('zone')
        ).length;
        elements.pendingCeOffice.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('ce(dist.)-north')
        ).length;
        elements.pendingPe.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('p&e')
        ).length;
        elements.pendingDhq.textContent = data.filter(d => 
            d['Presently with'] && d['Presently with'].toLowerCase().includes('ed-dist')
        ).length;
    }

    // Render the Scheme Head-wise summary table
    function renderSchemeHeadSummaryTable(data) {
        const schemeHeadSummary = data.reduce((acc, scheme) => {
            const schemeHead = scheme['Scheme Head'] || 'N/A';
            if (!acc[schemeHead]) {
                acc[schemeHead] = { total: 0, completed: 0 };
            }
            acc[schemeHead].total++;
            if (scheme['Work Status'] && scheme['Work Status'].toLowerCase().includes('completed')) {
                acc[schemeHead].completed++;
            }
            return acc;
        }, {});

        let tableHtml = '';
        Object.keys(schemeHeadSummary).sort().forEach(head => {
            const summary = schemeHeadSummary[head];
            tableHtml += `
                <tr data-scheme-head="${head}">
                    <td>${head}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                </tr>
            `;
        });
        elements.schemeHeadSummaryTableBody.innerHTML = tableHtml;

        elements.schemeHeadSummaryTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const schemeHead = row.dataset.schemeHead;
                showRegionBreakupModal(schemeHead);
            });
        });
    }

    // Show the Region-wise break-up modal
    function showRegionBreakupModal(schemeHead) {
        const dataForSchemeHead = getFilteredData().filter(d => d['Scheme Head'] === schemeHead);

        const regionSummary = dataForSchemeHead.reduce((acc, scheme) => {
            const region = scheme.Region || 'N/A';
            if (!acc[region]) {
                acc[region] = { total: 0, completed: 0, taaPending: 0 };
            }
            acc[region].total++;
            if (scheme['Work Status'] && scheme['Work Status'].toLowerCase().includes('completed')) {
                acc[region].completed++;
            }
            if (!scheme['TAA No.'] || scheme['TAA No.'].trim() === '') {
                acc[region].taaPending++;
            }
            return acc;
        }, {});

        elements.regionBreakupModalTitle.textContent = `Region-wise Break-up for "${schemeHead}"`;
        let tableHtml = '';
        Object.keys(regionSummary).sort().forEach(region => {
            const summary = regionSummary[region];
            tableHtml += `
                <tr data-scheme-head="${schemeHead}" data-region="${region}">
                    <td>${region}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                    <td>${summary.taaPending}</td>
                </tr>
            `;
        });
        elements.regionBreakupTableBody.innerHTML = tableHtml;

        elements.regionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const clickedSchemeHead = row.dataset.schemeHead;
                const region = row.dataset.region;
                showDivisionBreakupModal(clickedSchemeHead, region);
            });
        });

        elements.regionBreakupModal.classList.add('show');
    }

    // Show the Division-wise break-up modal
    function showDivisionBreakupModal(schemeHead, region) {
        const dataForRegion = getFilteredData().filter(d => 
            d['Scheme Head'] === schemeHead && d.Region === region
        );

        const divisionSummary = dataForRegion.reduce((acc, scheme) => {
            const division = scheme.Division || 'N/A';
            if (!acc[division]) {
                acc[division] = { total: 0, completed: 0, taaPending: 0 };
            }
            acc[division].total++;
            if (scheme['Work Status'] && scheme['Work Status'].toLowerCase().includes('completed')) {
                acc[division].completed++;
            }
            if (!scheme['TAA No.'] || scheme['TAA No.'].trim() === '') {
                acc[division].taaPending++;
            }
            return acc;
        }, {});

        elements.divisionBreakupModalTitle.textContent = `Division-wise Break-up for "${schemeHead}" in "${region}"`;
        let tableHtml = '';
        Object.keys(divisionSummary).sort().forEach(division => {
            const summary = divisionSummary[division];
            tableHtml += `
                <tr data-scheme-head="${schemeHead}" data-region="${region}" data-division="${division}">
                    <td>${division}</td>
                    <td>${summary.total}</td>
                    <td>${summary.completed}</td>
                    <td>${summary.taaPending}</td>
                </tr>
            `;
        });
        elements.divisionBreakupTableBody.innerHTML = tableHtml;

        elements.divisionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const clickedSchemeHead = row.dataset.schemeHead;
                const clickedRegion = row.dataset.region;
                const clickedDivision = row.dataset.division;
                
                const schemesInDivision = allSchemeData.filter(s => 
                    s['Scheme Head'] === clickedSchemeHead && 
                    s.Region === clickedRegion && 
                    s.Division === clickedDivision
                );
                
                if (schemesInDivision.length === 1) {
                    showSchemeDetails(schemesInDivision[0]);
                } else {
                    showSchemeListInModal(schemesInDivision, `Schemes in ${clickedDivision} (${clickedSchemeHead}, ${clickedRegion})`);
                }
            });
        });

        elements.divisionBreakupModal.classList.add('show');
    }

    // Function to show a list of schemes in a modal (reusing the structure of regionBreakupModal for simplicity)
    function showSchemeListInModal(schemes, title) {
        elements.regionBreakupModalTitle.textContent = title;
        let listHtml = '';
        if (schemes.length === 0) {
            // Updated colspan from 4 to 3
            listHtml = `<tr><td colspan="3" style="text-align: center; color: var(--text-medium); padding: 1rem;">No schemes found.</td></tr>`;
        } else {
            schemes.forEach(scheme => {
                // Removed taaPendingStatus calculation and usage
                listHtml += `
                    <tr data-scheme-name="${scheme['Name of Scheme']}">
                        <td>${scheme['Name of Scheme'] || '-'}</td>
                        <td>${scheme['eOffice ref.'] || '-'}</td>
                        <td>${scheme['Presently with'] || '-'}</td>
                    </tr>
                `;
            });
        }
        // Updated the table header for the scheme list modal - Removed TAA Pending header
        elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
            <th>Scheme Name</th>
            <th>eOffice ref.</th>
            <th>Presently with</th>
        `;
        elements.regionBreakupTableBody.innerHTML = listHtml;

        elements.regionBreakupTableBody.querySelectorAll('tr').forEach(row => {
            row.addEventListener('click', () => {
                const schemeName = row.dataset.schemeName;
                const scheme = allSchemeData.find(s => s['Name of Scheme'] === schemeName);
                if (scheme) {
                    showSchemeDetails(scheme);
                }
            });
        });

        elements.regionBreakupModal.classList.add('show');
        elements.divisionBreakupModal.classList.remove('show');
    }


    // Show individual scheme details in the detail modal
    function showSchemeDetails(scheme) {
        elements.modalSchemeName.textContent = scheme['Name of Scheme'] || 'Scheme Details';
        
        const detailsHtml = Object.entries(scheme).map(([key, value]) => {
            const displayValue = value && value.trim() ? value : '----';
            return `
                <div class="detail-row">
                    <div class="detail-label">${key}</div>
                    <div class="detail-value">${displayValue}</div>
                </div>
            `;
        }).join('');
        
        elements.modalDetailsContent.innerHTML = detailsHtml;
        elements.detailModal.classList.add('show');
        elements.regionBreakupModal.classList.remove('show');
        elements.divisionBreakupModal.classList.remove('show');
    }

    // Update dashboard with filtered data
    function updateDashboard() {
        const filteredData = getFilteredData();
        updateSummary(filteredData);
        renderSchemeHeadSummaryTable(filteredData);
        populateRegionFilter();
    }

    // Initialize dashboard: set up event listeners and initial data display
    function initializeDashboard() {
        elements.phaseTabs.addEventListener('click', (event) => {
            if (event.target.classList.contains('tab')) {
                Array.from(elements.phaseTabs.children).forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
                currentPhaseFilter = event.target.dataset.filterValue;
                currentRegionFilter = 'all';
                currentDivisionFilter = 'all';
                updateDashboard(); 
            }
        });

        elements.regionFilter.addEventListener('change', (event) => {
            currentRegionFilter = event.target.value;
            currentDivisionFilter = 'all';
            populateDivisionFilter(currentRegionFilter);
            updateDashboard();
        });

        elements.divisionFilter.addEventListener('change', (event) => {
            currentDivisionFilter = event.target.value;
            updateDashboard();
        });

elements.summaryCardsContainer.querySelectorAll('.summary-card').forEach(card => {
    card.addEventListener('click', (event) => {
        const cardType = event.currentTarget.dataset.cardType;
        let filteredSchemes = getFilteredData();
        let modalTitle = '';

        switch (cardType) {
            case 'total':
                modalTitle = 'All Schemes';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'completed':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Work Status'] && d['Work Status'].toLowerCase().includes('completed')
                );
                modalTitle = 'Completed Schemes';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

case 'taaIssued':
    filteredSchemes = filteredSchemes.filter(d => 
        d['TAA No.'] && d['TAA No.'].trim() !== ''
    );
    modalTitle = 'TAA Issued Schemes';
    showCustomTableModal(filteredSchemes, modalTitle, ['Name of Scheme', 'TAA No.', 'Work Status']);
    break;


            case 'pendingDivision':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('division')
                );
                modalTitle = 'Schemes Pending at Division';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'pendingRegion':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('region')
                );
                modalTitle = 'Schemes Pending at Region';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'pendingZone':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('zone')
                );
                modalTitle = 'Schemes Pending at Zone';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'pendingCeOffice':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('ce(dist.)-north')
                );
                modalTitle = 'Schemes Pending at CE-Office';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'pendingPe':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('p&e')
                );
                modalTitle = 'Schemes Pending at P&E';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            case 'pendingDhq':
                filteredSchemes = filteredSchemes.filter(d => 
                    d['Presently with'] && d['Presently with'].toLowerCase().includes('ed-dist')
                );
                modalTitle = 'Schemes Pending at DHQ';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;

            default:
                modalTitle = 'Schemes List';
                showSchemeListInModal(filteredSchemes, modalTitle);
                break;
        }
    });
});


        updateDashboard();
    }

    document.querySelectorAll('.modal .close-button').forEach(button => {
        button.addEventListener('click', (event) => {
            event.target.closest('.modal').classList.remove('show');
if (event.target.closest('.modal').id === 'regionBreakupModal') {
    const modalTitle = elements.regionBreakupModalTitle.textContent || '';
    if (modalTitle.startsWith('Schemes in')) {
        // Restore 3-column header
        elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
            <th>Scheme Name</th>
            <th>eOffice ref.</th>
            <th>Presently with</th>
        `;
    } else {
        // Restore region-wise summary header
        elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
            <th>Region</th>
            <th>Total Schemes</th>
            <th>Completed</th>
            <th>TAA Pending</th>
        `;
    }
}

        });
    });

    window.addEventListener('click', (event) => {
        if (event.target === elements.detailModal) {
            elements.detailModal.classList.remove('show');
        }
        if (event.target === elements.regionBreakupModal) {
            elements.regionBreakupModal.classList.remove('show');
            elements.regionBreakupModal.querySelector('thead tr').innerHTML = `
                <th>Region</th>
                <th>Total Schemes</th>
                <th>Completed</th>
                <th>TAA Pending</th>
            `;
        }
        if (event.target === elements.divisionBreakupModal) {
            elements.divisionBreakupModal.classList.remove('show');
        }
    });

    const styleSheet = document.createElement('style');
    styleSheet.type = 'text/css';
    styleSheet.innerText = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(styleSheet);

    window.onload = loadData;
function showCustomTableModal(data, title, columns) {
    elements.regionBreakupModalTitle.textContent = title;

    // Set table headers
    elements.regionBreakupModal.querySelector('thead tr').innerHTML = columns.map(col => `<th>${col}</th>`).join('');

    // Generate rows
    let listHtml = '';
    if (data.length === 0) {
        listHtml = `<tr><td colspan="${columns.length}" style="text-align: center; color: var(--text-medium); padding: 1rem;">No data found.</td></tr>`;
    } else {
        listHtml = data.map((row, index) => {
            const rowHtml = columns.map(col => `<td>${row[col] || '-'}</td>`).join('');
            return `<tr data-scheme-name="${row['Name of Scheme'] || ''}">${rowHtml}</tr>`;
        }).join('');
    }

    elements.regionBreakupTableBody.innerHTML = listHtml;

    // Add click event to each row to open scheme detail
    elements.regionBreakupTableBody.querySelectorAll('tr[data-scheme-name]').forEach(row => {
        row.addEventListener('click', () => {
            const schemeName = row.dataset.schemeName;
            const scheme = allSchemeData.find(s => s['Name of Scheme'] === schemeName);
            if (scheme) {
                showSchemeDetails(scheme);
            }
        });
    });

    elements.regionBreakupModal.classList.add('show');
    elements.divisionBreakupModal.classList.remove('show');
    elements.detailModal.classList.remove('show');
}


</script>
</body>
</html>
