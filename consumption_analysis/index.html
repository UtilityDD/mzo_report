<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Low Consumption Analysis</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add a placeholder favicon to prevent 404 error -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        /* Spinner Styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Chart.js for visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="script.js" defer></script>
</head>
<body>

    <div class="container">
        <h1>Consumer Consumption Analysis</h1>
        <p>This tool identifies consumers with remarkably low consumption based on the provided data.</p>

        <div class="controls">
            <label for="statusFilter">Filter by Connection Status:</label>
            <select id="statusFilter">
                <option value="LIVE" selected>LIVE</option>
                <option value="DEEMED DISCONNECTED">DEEMED DISCONNECTED</option>
                <option value="TEMPORARY DISCONNECTED">TEMPORARY DISCONNECTED</option>
            </select>
            <label for="sdMultiplier" style="margin-left: 15px;">Threshold:</label>
            <select id="sdMultiplier">
                <option value="0.5">Mean - 0.5σ (Lenient)</option>
                <option value="0.75">Mean - 0.75σ</option>
                <option value="1" selected>Mean - 1σ (Standard)</option>
                <option value="1.25">Mean - 1.25σ (Strict)</option>
                <option value="1.5">Mean - 1.5σ (Very Strict)</option>
            </select>

            <br><br>
            <label for="csvFileInput">Or upload your own CSV data:</label>
            <input type="file" id="csvFileInput" accept=".csv">
            <button id="analyzeBtn">Analyze Data</button>
            <div class="default-data-note">
                <strong>Note:</strong> By default (without uploading a file), the analysis is based on sample data from Ahio CCC's Agri Consumers.
            </div>
        </div>

        <div class="data-format-instructions">
            <h3 class="collapsible-header">Data Format Instructions for CSV Upload: <span class="collapsible-icon">+</span></h3>
            <div class="collapsible-content">
                <p>Your CSV file should contain the following columns:</p>
                <ul>
                    <li><code>ZCA</code>: Unique identifier for the consumer.</li>
                    <li><code>NAME</code>: Name of the consumer.</li>
                    <li><code>CONN_STAT</code>: Connection status (e.g., "LIVE", "DEEMED DISCONNECTED", "TEMPORARY DISCONNECTED").</li>
                    <li>Monthly consumption columns: These should be named in the format <code>UNIT_BILLED_MMYY</code> (e.g., <code>UNIT_BILLED_DEC24</code>, <code>UNIT_BILLED_JAN25</code>, etc.). The tool currently expects 12 such columns as defined in the script.</li>
                </ul>
                <p><strong>Important:</strong></p>
                <ul>
                    <li>Ensure column headers are exactly as specified.</li>
                    <li>Consumption values should be numeric. Non-numeric values or <code>(null)</code> will be treated as zero or ignored.</li>
                </ul>
            </div>
        </div>

        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <span id="loading-text">Loading and processing data...</span>
            <button id="resetBtn" class="button hidden" style="margin-top: 15px; background-color: #e74c3c; border-color: #c0392b;">Reset</button>
        </div>

        <div id="results" class="hidden">
            <h2>Analysis Summary</h2>
            <table id="summaryTable">
                <!-- Summary data will be injected here -->
            </table>

            <h2>Calculation Formula</h2>
            <div id="formulaBox" class="formula-box">
                <!-- Formula will be displayed here -->
            </div>

            <h2>Distribution Chart</h2>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>

            <div class="table-header-container">
                <h2 id="lowConsumersHeader">Low Consumption Consumers</h2>
                <button id="downloadBtn" class="button hidden">Download Table as CSV</button>
            </div>
            <p id="lowConsumersDescription">Consumers whose total consumption is more than 1 standard deviation below the mean.</p>
            <table id="lowConsumersTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">S.No <span class="sort-indicator">⇅</span></th>
                        <th onclick="sortTable(1)">ZCA <span class="sort-indicator">⇅</span></th>
                        <th onclick="sortTable(2)">Name <span class="sort-indicator">⇅</span></th>
                        <th onclick="sortTable(3)">Months with Data <span class="sort-indicator">⇅</span></th>
                        <th onclick="sortTable(4)">Total Consumption (12 Months) <span class="sort-indicator">⇅</span></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Low consumer rows will be injected here -->
                </tbody>
            </table>
            <div id="paginationContainer" class="pagination-container hidden">
                <button id="prevPageBtn" class="button">&laquo; Previous</button>
                <span id="pageInfo"></span>
                <button id="nextPageBtn" class="button">Next &raquo;</button>
            </div>
        </div>
    </div>

</body>
</html>
